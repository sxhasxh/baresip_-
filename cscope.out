cscope 15 $HOME/songxh/github_sxh/baresip -q 0000011220 0002201031
	@baresip/include/baresip.h

7 #iâdeà
BARESIP_H__


8 
	#BARESIP_H__


	)

10 #ifdeà
__ılu¥lus


16 
	#BARESIP_VERSION
 "0.5.7"

	)

19 #iâdeà
NET_MAX_NS


20 
	#NET_MAX_NS
 (4)

	)

25 
§
;

26 
sdp_medŸ
;

27 
sdp_£ssiÚ
;

28 
s_msg
;

29 
¡»am
;

30 
ua
;

31 
vidäame
;

32 
vid»ù
;

33 
vidsz
;

41 
	eªsw”mode
 {

42 
ANSWERMODE_MANUAL
 = 0,

43 
ANSWERMODE_EARLY
,

44 
ANSWERMODE_AUTO


47 
accouÁ
;

49 
accouÁ_®loc
(
accouÁ
 **
acı
, cÚ¡ *
saddr
);

50 
accouÁ_debug
(
»_´štf
 *
pf
, cÚ¡ 
accouÁ
 *
acc
);

51 
accouÁ_£t_auth_·ss
(
accouÁ
 *
acc
, cÚ¡ *
·ss
);

52 
accouÁ_£t_di¥Ïy_Çme
(
accouÁ
 *
acc
, cÚ¡ *
dÇme
);

53 
accouÁ_auth
(cÚ¡ 
accouÁ
 *
acc
, **
u£ºame
, **
·sswÜd
,

54 cÚ¡ *
»®m
);

55 
li¡
 *
accouÁ_aucodeş
(cÚ¡ 
accouÁ
 *
acc
);

56 
li¡
 *
accouÁ_vidcodeş
(cÚ¡ 
accouÁ
 *
acc
);

57 
s_addr
 *
accouÁ_Ïddr
(cÚ¡ 
accouÁ
 *
acc
);

58 
ušt32_t
 
accouÁ_»gšt
(cÚ¡ 
accouÁ
 *
acc
);

59 
ušt32_t
 
accouÁ_pubšt
(cÚ¡ 
accouÁ
 *
acc
);

60 
ušt32_t
 
accouÁ_±ime
(cÚ¡ 
accouÁ
 *
acc
);

61 
ªsw”mode
 
accouÁ_ªsw”mode
(cÚ¡ 
accouÁ
 *
acc
);

62 cÚ¡ *
accouÁ_aÜ
(cÚ¡ 
accouÁ
 *
acc
);

63 cÚ¡ *
accouÁ_auth_u£r
(cÚ¡ 
accouÁ
 *
acc
);

64 cÚ¡ *
accouÁ_auth_·ss
(cÚ¡ 
accouÁ
 *
acc
);

65 cÚ¡ *
accouÁ_outbound
(cÚ¡ 
accouÁ
 *
acc
, 
ix
);

66 cÚ¡ *
accouÁ_¡un_u£r
(cÚ¡ 
accouÁ
 *
acc
);

67 cÚ¡ *
accouÁ_¡un_·ss
(cÚ¡ 
accouÁ
 *
acc
);

68 cÚ¡ *
accouÁ_¡un_ho¡
(cÚ¡ 
accouÁ
 *
acc
);

76 
	#AULEVEL_MIN
 (-96.0)

	)

77 
	#AULEVEL_MAX
 (0.0)

	)

80 
auËv–_ÿlc_dbov
(cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
);

87 
	eÿÎ_ev’t
 {

88 
CALL_EVENT_INCOMING
,

89 
CALL_EVENT_RINGING
,

90 
CALL_EVENT_PROGRESS
,

91 
CALL_EVENT_ESTABLISHED
,

92 
CALL_EVENT_CLOSED
,

93 
CALL_EVENT_TRANSFER
,

94 
CALL_EVENT_TRANSFER_FAILED
,

97 
ÿÎ
;

99 (
ÿÎ_ev’t_h
)(
	tÿÎ
 *ÿÎ, 
	tÿÎ_ev’t
 
	tev
,

100 cÚ¡ *
	t¡r
, *
	t¬g
);

101 (
ÿÎ_dtmf_h
)(
	tÿÎ
 *ÿÎ, 
	tkey
, *
	t¬g
);

103 
ÿÎ_modify
(
ÿÎ
 *call);

104 
ÿÎ_hŞd
(
ÿÎ
 *ÿÎ, 
boŞ
 
hŞd
);

105 
ÿÎ_£nd_dig™
(
ÿÎ
 *ÿÎ, 
key
);

106 
boŞ
 
ÿÎ_has_audio
(cÚ¡ 
ÿÎ
 *call);

107 
boŞ
 
ÿÎ_has_video
(cÚ¡ 
ÿÎ
 *call);

108 
ÿÎ_Œªsãr
(
ÿÎ
 *ÿÎ, cÚ¡ *
uri
);

109 
ÿÎ_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call);

110 
ÿÎ_debug
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call);

111 
ÿÎ_£t_hªdËrs
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t_h
 *
eh
,

112 
ÿÎ_dtmf_h
 *
dtmfh
, *
¬g
);

113 
ušt16_t
 
ÿÎ_scode
(cÚ¡ 
ÿÎ
 *call);

114 
ušt32_t
 
ÿÎ_du¿tiÚ
(cÚ¡ 
ÿÎ
 *call);

115 
ušt32_t
 
ÿÎ_£tup_du¿tiÚ
(cÚ¡ 
ÿÎ
 *call);

116 cÚ¡ *
ÿÎ_³”uri
(cÚ¡ 
ÿÎ
 *call);

117 cÚ¡ *
ÿÎ_³”Çme
(cÚ¡ 
ÿÎ
 *call);

118 cÚ¡ *
ÿÎ_loÿluri
(cÚ¡ 
ÿÎ
 *call);

119 
audio
 *
ÿÎ_audio
(cÚ¡ 
ÿÎ
 *call);

120 
video
 *
ÿÎ_video
(cÚ¡ 
ÿÎ
 *call);

121 
li¡
 *
ÿÎ_¡»aml
(cÚ¡ 
ÿÎ
 *call);

122 
ua
 *
ÿÎ_g‘_ua
(cÚ¡ 
ÿÎ
 *call);

123 
boŞ
 
ÿÎ_is_ÚhŞd
(cÚ¡ 
ÿÎ
 *call);

124 
boŞ
 
ÿÎ_is_outgošg
(cÚ¡ 
ÿÎ
 *call);

125 
ÿÎ_’abË_¹p_timeout
(
ÿÎ
 *ÿÎ, 
ušt32_t
 
timeout_ms
);

126 
ušt32_t
 
ÿÎ_lš’um
(cÚ¡ 
ÿÎ
 *call);

127 
ÿÎ
 *
ÿÎ_fšd_lš’um
(cÚ¡ 
li¡
 *
ÿÎs
, 
ušt32_t
 
lš’um
);

128 
ÿÎ_£t_cu¼’t
(
li¡
 *
ÿÎs
, 
ÿÎ
 *call);

137 (
cÚæše_h
)(cÚ¡ 
	t¶
 *
	taddr
, *
	t¬g
);

139 
cÚf_cÚfigu»
();

140 
cÚf_moduËs
();

141 
cÚf_·th_£t
(cÚ¡ *
·th
);

142 
cÚf_·th_g‘
(*
·th
, 
size_t
 
sz
);

143 
cÚf_·r£
(cÚ¡ *
f’ame
, 
cÚæše_h
 *
ch
, *
¬g
);

144 
cÚf_g‘_vidsz
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

145 
vidsz
 *
sz
);

146 
cÚf_g‘_§
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
§
 *sa);

147 
boŞ
 
cÚf_f“xi¡
(cÚ¡ *
·th
);

148 
cÚf_şo£
();

149 
cÚf
 *
cÚf_cur
();

157 
	s¿nge
 {

158 
ušt32_t
 
mš
;

159 
ušt32_t
 
max
;

162 
šlše
 
boŞ
 
š_¿nge
(cÚ¡ 
¿nge
 *
ºg
, 
ušt32_t
 
v®
)

164  
ºg
 ? (
v®
 >ğºg->
mš
 && v® <ğºg->
max
è: 
çl£
;

168 
	eaudio_mode
 {

169 
AUDIO_MODE_POLL
 = 0,

170 
AUDIO_MODE_THREAD
,

175 
	scÚfig_s
 {

176 
ušt32_t
 
Œªs_bsize
;

177 
uuid
[64];

178 
loÿl
[64];

179 
û¹
[256];

183 
	scÚfig_ÿÎ
 {

184 
ušt32_t
 
loÿl_timeout
;

185 
ušt32_t
 
max_ÿÎs
;

189 
	scÚfig_audio
 {

190 
audio_·th
[256];

191 
¤c_mod
[16];

192 
¤c_dev
[128];

193 
¶ay_mod
[16];

194 
¶ay_dev
[128];

195 
®”t_mod
[16];

196 
®”t_dev
[128];

197 
¿nge
 
¤©e
;

198 
¿nge
 
chªÃls
;

199 
ušt32_t
 
¤©e_¶ay
;

200 
ušt32_t
 
¤©e_¤c
;

201 
ušt32_t
 
chªÃls_¶ay
;

202 
ušt32_t
 
chªÃls_¤c
;

203 
boŞ
 
¤c_fœ¡
;

204 
audio_mode
 
txmode
;

205 
boŞ
 
Ëv–
;

206 
¤c_fmt
;

207 
¶ay_fmt
;

210 #ifdeà
USE_VIDEO


212 
	scÚfig_video
 {

213 
¤c_mod
[16];

214 
¤c_dev
[128];

215 
di¥_mod
[16];

216 
di¥_dev
[128];

217 
width
, 
height
;

218 
ušt32_t
 
b™¿‹
;

219 
ušt32_t
 
ås
;

220 
boŞ
 
fuÎsü“n
;

225 
	scÚfig_avt
 {

226 
ušt8_t
 
¹p_tos
;

227 
¿nge
 
¹p_pÜts
;

228 
¿nge
 
¹p_bw
;

229 
boŞ
 
¹ı_’abË
;

230 
boŞ
 
¹ı_mux
;

231 
¿nge
 
jbuf_d–
;

232 
boŞ
 
¹p_¡©s
;

233 
ušt32_t
 
¹p_timeout
;

237 
	scÚfig_Ãt
 {

238 
iâame
[16];

240 
addr
[64];

241 } 
nsv
[
NET_MAX_NS
];

242 
size_t
 
nsc
;

245 #ifdeà
USE_VIDEO


247 
	scÚfig_bfı
 {

248 
´Ùo
[16];

253 
	scÚfig_sdp
 {

254 
boŞ
 
ebuac
;

259 
	scÚfig
 {

261 
cÚfig_s
 
s
;

263 
cÚfig_ÿÎ
 
ÿÎ
;

265 
cÚfig_audio
 
audio
;

267 #ifdeà
USE_VIDEO


268 
cÚfig_video
 
video
;

270 
cÚfig_avt
 
avt
;

272 
cÚfig_Ãt
 
Ãt
;

274 #ifdeà
USE_VIDEO


275 
cÚfig_bfı
 
bfı
;

278 
cÚfig_sdp
 
sdp
;

281 
cÚfig_·r£_cÚf
(
cÚfig
 *
cfg
, cÚ¡ 
cÚf
 *conf);

282 
cÚfig_´št
(
»_´štf
 *
pf
, cÚ¡ 
cÚfig
 *
cfg
);

283 
cÚfig_wr™e_‹m¶©e
(cÚ¡ *
fe
, cÚ¡ 
cÚfig
 *
cfg
);

284 
cÚfig
 *
cÚf_cÚfig
();

291 
	e´e£nû_¡©us
 {

292 
PRESENCE_UNKNOWN
,

293 
PRESENCE_OPEN
,

294 
PRESENCE_CLOSED
,

295 
PRESENCE_BUSY


299 
cÚù
;

300 (
cÚù_upd©e_h
)(
	tcÚù
 *
	tc
, 
	tboŞ
 
	t»moved
, *
	t¬g
);

302 
	scÚùs
 {

303 
li¡
 
ş
;

304 
hash
 *
cht
;

306 
cÚù_upd©e_h
 *
hªdËr
;

307 * 
hªdËr_¬g
;

311 
cÚù_š™
(
cÚùs
 *contacts);

312 
cÚù_şo£
(
cÚùs
 *contacts);

313 
cÚù_add
(
cÚùs
 *contacts,

314 
cÚù
 **
cÚùp
, cÚ¡ 
¶
 *
addr
);

315 
cÚù_»move
(
cÚùs
 *cÚùs, 
cÚù
 *
c
);

316 
cÚù_£t_upd©e_hªdËr
(
cÚùs
 *
cÚcs
,

317 
cÚù_upd©e_h
 *
upd©eh
, *
¬g
);

318 
cÚùs_´št
(
»_´štf
 *
pf
, cÚ¡ 
cÚùs
 *contacts);

319 
´e£nû_¡©us
 
cÚù_´e£nû
(cÚ¡ 
cÚù
 *
c
);

320 
cÚù_£t_´e£nû
(
cÚù
 *
c
, 
´e£nû_¡©us
 
¡©us
);

321 
boŞ
 
cÚù_block_acûss
(cÚ¡ 
cÚùs
 *cÚùs, cÚ¡ *
uri
);

322 
cÚù
 *
cÚù_fšd
(cÚ¡ 
cÚùs
 *contacts,

323 cÚ¡ *
uri
);

324 
s_addr
 *
cÚù_addr
(cÚ¡ 
cÚù
 *
c
);

325 
li¡
 *
cÚù_li¡
(cÚ¡ 
cÚùs
 *contacts);

326 cÚ¡ *
cÚù_¡r
(cÚ¡ 
cÚù
 *
c
);

327 cÚ¡ *
cÚù_´e£nû_¡r
(
´e£nû_¡©us
 
¡©us
);

335 
	smedŸ_ùx
 {

336 cÚ¡ *
id
;

344 (
mes§ge_»cv_h
)(cÚ¡ 
	t¶
 *
	t³”
, cÚ¡ ¶ *
	tùy³
,

345 
	tmbuf
 *
	tbody
, *
	t¬g
);

347 
mes§ge
;

348 
mes§ge_l¢r
;

350 
mes§ge_š™
(
mes§ge
 **
mes§g•
);

351 
mes§ge_li¡’
(
mes§ge_l¢r
 **
l¢½
, 
mes§ge
 *message,

352 
mes§ge_»cv_h
 *
h
, *
¬g
);

353 
mes§ge_£nd
(
ua
 *ua, cÚ¡ *
³”
, cÚ¡ *
msg
,

354 
s_»¥_h
 *
»¥h
, *
¬g
);

361 
au¤c
;

362 
au¤c_¡
;

365 
	sau¤c_´m
 {

366 
ušt32_t
 
¤©e
;

367 
ušt8_t
 
ch
;

368 
ušt32_t
 
±ime
;

369 
fmt
;

372 (
au¤c_»ad_h
)(cÚ¡ *
	t§mpv
, 
	tsize_t
 
	t§mpc
, *
	t¬g
);

373 (
au¤c_”rÜ_h
)(
	t”r
, cÚ¡ *
	t¡r
, *
	t¬g
);

375 (
au¤c_®loc_h
)(
	tau¤c_¡
 **
	t¡p
, cÚ¡ 
	tau¤c
 *ausrc,

376 
	tmedŸ_ùx
 **
	tùx
,

377 
	tau¤c_´m
 *
	t´m
, cÚ¡ *
	tdeviû
,

378 
	tau¤c_»ad_h
 *
	trh
, 
	tau¤c_”rÜ_h
 *
	t”rh
, *
	t¬g
);

380 
au¤c_»gi¡”
(
au¤c
 **
a¥
, 
li¡
 *
au¤ş
, cÚ¡ *
Çme
,

381 
au¤c_®loc_h
 *
®loch
);

382 cÚ¡ 
au¤c
 *
au¤c_fšd
(cÚ¡ 
li¡
 *
au¤ş
, cÚ¡ *
Çme
);

383 
au¤c_®loc
(
au¤c_¡
 **
¡p
, 
li¡
 *
au¤ş
,

384 
medŸ_ùx
 **
ùx
,

385 cÚ¡ *
Çme
,

386 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

387 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

394 
au¶ay
;

395 
au¶ay_¡
;

398 
	sau¶ay_´m
 {

399 
ušt32_t
 
¤©e
;

400 
ušt8_t
 
ch
;

401 
ušt32_t
 
±ime
;

402 
fmt
;

405 (
au¶ay_wr™e_h
)(*
	t§mpv
, 
	tsize_t
 
	t§mpc
, *
	t¬g
);

407 (
au¶ay_®loc_h
)(
	tau¶ay_¡
 **
	t¡p
, cÚ¡ 
	tau¶ay
 *
	t­
,

408 
	tau¶ay_´m
 *
	t´m
, cÚ¡ *
	tdeviû
,

409 
	tau¶ay_wr™e_h
 *
	twh
, *
	t¬g
);

411 
au¶ay_»gi¡”
(
au¶ay
 **
µ
, 
li¡
 *
au¶ayl
,

412 cÚ¡ *
Çme
, 
au¶ay_®loc_h
 *
®loch
);

413 cÚ¡ 
au¶ay
 *
au¶ay_fšd
(cÚ¡ 
li¡
 *
au¶ayl
, cÚ¡ *
Çme
);

414 
au¶ay_®loc
(
au¶ay_¡
 **
¡p
, 
li¡
 *
au¶ayl
,

415 cÚ¡ *
Çme
,

416 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

417 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

424 
auft
;

427 
	sauft_’c_¡
 {

428 cÚ¡ 
auft
 *
af
;

429 
Ë
†e;

432 
	sauft_dec_¡
 {

433 cÚ¡ 
auft
 *
af
;

434 
Ë
†e;

438 
	sauft_´m
 {

439 
ušt32_t
 
¤©e
;

440 
ušt8_t
 
ch
;

441 
ušt32_t
 
±ime
;

444 (
auft_’cupd_h
)(
	tauft_’c_¡
 **
	t¡p
, **
	tùx
,

445 cÚ¡ 
	tauft
 *
	taf
, 
	tauft_´m
 *
	t´m
);

446 (
auft_’code_h
)(
	tauft_’c_¡
 *
	t¡
,

447 
	tšt16_t
 *
	t§mpv
, 
	tsize_t
 *
	t§mpc
);

449 (
auft_decupd_h
)(
	tauft_dec_¡
 **
	t¡p
, **
	tùx
,

450 cÚ¡ 
	tauft
 *
	taf
, 
	tauft_´m
 *
	t´m
);

451 (
auft_decode_h
)(
	tauft_dec_¡
 *
	t¡
,

452 
	tšt16_t
 *
	t§mpv
, 
	tsize_t
 *
	t§mpc
);

454 
	sauft
 {

455 
Ë
†e;

456 cÚ¡ *
Çme
;

457 
auft_’cupd_h
 *
’cupdh
;

458 
auft_’code_h
 *
’ch
;

459 
auft_decupd_h
 *
decupdh
;

460 
auft_decode_h
 *
dech
;

463 
auft_»gi¡”
(
li¡
 *
auf
, 
auft
 *
af
);

464 
auft_uÄegi¡”
(
auft
 *
af
);

471 
	elog_Ëv–
 {

472 
LEVEL_DEBUG
 = 0,

473 
LEVEL_INFO
,

474 
LEVEL_WARN
,

475 
LEVEL_ERROR
,

478 (
log_h
)(
	tušt32_t
 
	tËv–
, cÚ¡ *
	tmsg
);

480 
	slog
 {

481 
Ë
†e;

482 
log_h
 *
h
;

485 
log_»gi¡”_hªdËr
(
log
 *
logh
);

486 
log_uÄegi¡”_hªdËr
(
log
 *
logh
);

487 
log_’abË_debug
(
boŞ
 
’abË
);

488 
log_’abË_šfo
(
boŞ
 
’abË
);

489 
log_’abË_¡d”r
(
boŞ
 
’abË
);

490 
vlog
(
log_Ëv–
 
Ëv–
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

491 
loglv
(
log_Ëv–
 
Ëv–
, cÚ¡ *
fmt
, ...);

492 
debug
(cÚ¡ *
fmt
, ...);

493 
šfo
(cÚ¡ *
fmt
, ...);

494 
w¬nšg
(cÚ¡ *
fmt
, ...);

495 
”rÜ_msg
(cÚ¡ *
fmt
, ...);

502 
m’c
;

503 
m’c_£ss
;

504 
m’c_medŸ
;

507 (
m’c_”rÜ_h
)(
	t”r
, *
	t¬g
);

509 (
m’c_£ss_h
)(
	tm’c_£ss
 **
	t£s¥
, 
	tsdp_£ssiÚ
 *
	tsdp
,

510 
	tboŞ
 
	tofã»r
, 
	tm’c_”rÜ_h
 *
	t”rÜh
, *
	t¬g
);

512 (
m’c_medŸ_h
)(
	tm’c_medŸ
 **
	tmp
, 
	tm’c_£ss
 *
	t£ss
,

513 
	t¹p_sock
 *
	t¹p
, 
	t´Ùo
,

514 *
	t¹psock
, *
	t¹ısock
,

515 
	tsdp_medŸ
 *
	tsdpm
);

517 
	sm’c
 {

518 
Ë
†e;

519 cÚ¡ *
id
;

520 cÚ¡ *
sdp_´Ùo
;

521 
m’c_£ss_h
 *
£ssh
;

522 
m’c_medŸ_h
 *
medŸh
;

525 
m’c_»gi¡”
(
li¡
 *
m’ş
, 
m’c
 *menc);

526 
m’c_uÄegi¡”
(
m’c
 *menc);

527 cÚ¡ 
m’c
 *
m’c_fšd
(cÚ¡ 
li¡
 *
m’ş
, cÚ¡ *
id
);

534 
ÃtwÜk
;

536 (
Ãt_chªge_h
)(*
	t¬g
);

538 
Ãt_®loc
(
ÃtwÜk
 **
Ã
, cÚ¡ 
cÚfig_Ãt
 *
cfg
, 
af
);

539 
Ãt_u£_Çme£rv”
(
ÃtwÜk
 *
Ãt
, cÚ¡ 
§
 *
ns
);

540 
Ãt_chªge
(
ÃtwÜk
 *
Ãt
, 
ušt32_t
 
š‹rv®
,

541 
Ãt_chªge_h
 *
ch
, *
¬g
);

542 
Ãt_fÜû_chªge
(
ÃtwÜk
 *
Ãt
);

543 
boŞ
 
Ãt_check
(
ÃtwÜk
 *
Ãt
);

544 
Ãt_af
(cÚ¡ 
ÃtwÜk
 *
Ãt
);

545 
Ãt_debug
(
»_´štf
 *
pf
, cÚ¡ 
ÃtwÜk
 *
Ãt
);

546 cÚ¡ 
§
 *
Ãt_Ïddr_af
(cÚ¡ 
ÃtwÜk
 *
Ãt
, 
af
);

547 cÚ¡ *
Ãt_domaš
(cÚ¡ 
ÃtwÜk
 *
Ãt
);

548 
dnsc
 *
Ãt_dnsc
(cÚ¡ 
ÃtwÜk
 *
Ãt
);

555 
¶ay
;

556 
¶ay”
;

558 
¶ay_fe
(
¶ay
 **
¶ayp
, 
¶ay”
 *player,

559 cÚ¡ *
f’ame
, 
»³©
);

560 
¶ay_tÚe
(
¶ay
 **
¶ayp
, 
¶ay”
 *player,

561 
mbuf
 *
tÚe
,

562 
ušt32_t
 
¤©e
, 
ušt8_t
 
ch
, 
»³©
);

563 
¶ay_š™
(
¶ay”
 **
¶ay”p
);

564 
¶ay_£t_·th
(
¶ay”
 *¶ay”, cÚ¡ *
·th
);

571 
ua
;

574 
	eua_ev’t
 {

575 
UA_EVENT_REGISTERING
 = 0,

576 
UA_EVENT_REGISTER_OK
,

577 
UA_EVENT_REGISTER_FAIL
,

578 
UA_EVENT_UNREGISTERING
,

579 
UA_EVENT_SHUTDOWN
,

580 
UA_EVENT_EXIT
,

582 
UA_EVENT_CALL_INCOMING
,

583 
UA_EVENT_CALL_RINGING
,

584 
UA_EVENT_CALL_PROGRESS
,

585 
UA_EVENT_CALL_ESTABLISHED
,

586 
UA_EVENT_CALL_CLOSED
,

587 
UA_EVENT_CALL_TRANSFER_FAILED
,

588 
UA_EVENT_CALL_DTMF_START
,

589 
UA_EVENT_CALL_DTMF_END
,

590 
UA_EVENT_CALL_RTCP
,

592 
UA_EVENT_MAX
,

596 
	evidmode
 {

597 
VIDMODE_OFF
 = 0,

598 
VIDMODE_ON
,

602 (
ua_ev’t_h
)(
	tua
 *ua, 
	tua_ev’t
 
	tev
,

603 
	tÿÎ
 *ÿÎ, cÚ¡ *
	t´m
, *
	t¬g
);

604 (
İtiÚs_»¥_h
)(
	t”r
, cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

606 (
ua_ex™_h
)(*
	t¬g
);

609 
ua_®loc
(
ua
 **
u­
, cÚ¡ *
aÜ
);

610 
ua_cÚÃù
(
ua
 *ua, 
ÿÎ
 **
ÿÎp
,

611 cÚ¡ *
äom_uri
, cÚ¡ *
uri
,

612 cÚ¡ *
·¿ms
, 
vidmode
 
vmode
);

613 
ua_hªgup
(
ua
 *ua, 
ÿÎ
 *call,

614 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
);

615 
ua_ªsw”
(
ua
 *ua, 
ÿÎ
 *call);

616 
ua_´og»ss
(
ua
 *ua, 
ÿÎ
 *call);

617 
ua_hŞd_ªsw”
(
ua
 *ua, 
ÿÎ
 *call);

618 
ua_İtiÚs_£nd
(
ua
 *ua, cÚ¡ *
uri
,

619 
İtiÚs_»¥_h
 *
»¥h
, *
¬g
);

620 
ua_debug
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua);

621 
ua_´št_ÿÎs
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua);

622 
ua_´št_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua);

623 
ua_´št_suµÜ‹d
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua);

624 
ua_»gi¡”
(
ua
 *ua);

625 
ua_uÄegi¡”
(
ua
 *ua);

626 
boŞ
 
ua_i¤egi¡”ed
(cÚ¡ 
ua
 *ua);

627 
ua_pub_gruu_£t
(
ua
 *ua, cÚ¡ 
¶
 *
pv®
);

628 cÚ¡ *
ua_aÜ
(cÚ¡ 
ua
 *ua);

629 cÚ¡ *
ua_cu£r
(cÚ¡ 
ua
 *ua);

630 cÚ¡ *
ua_loÿl_cu£r
(cÚ¡ 
ua
 *ua);

631 
accouÁ
 *
ua_accouÁ
(cÚ¡ 
ua
 *ua);

632 cÚ¡ *
ua_outbound
(cÚ¡ 
ua
 *ua);

633 
ÿÎ
 *
ua_ÿÎ
(cÚ¡ 
ua
 *ua);

634 
ÿÎ
 *
ua_´ev_ÿÎ
(cÚ¡ 
ua
 *ua);

635 
li¡
 *
ua_ÿÎs
(cÚ¡ 
ua
 *ua);

636 
´e£nû_¡©us
 
ua_´e£nû_¡©us
(cÚ¡ 
ua
 *ua);

637 
ua_´e£nû_¡©us_£t
(
ua
 *ua, cÚ¡ 
´e£nû_¡©us
 
¡©us
);

638 
ua_£t_medŸ_af
(
ua
 *ua, 
af_medŸ
);

642 
ua_š™
(cÚ¡ *
soáw¬e
, 
boŞ
 
udp
, boŞ 
tı
, boŞ 
s
,

643 
boŞ
 
´eãr_v6
);

644 
ua_şo£
();

645 
ua_¡İ_®l
(
boŞ
 
fÜûd
);

646 
uag_£t_ex™_hªdËr
(
ua_ex™_h
 *
ex™h
, *
¬g
);

647 
uag_»£t_Œª¥
(
boŞ
 
»g
, boŞ 
»šv™e
);

648 
uag_ev’t_»gi¡”
(
ua_ev’t_h
 *
eh
, *
¬g
);

649 
uag_ev’t_uÄegi¡”
(
ua_ev’t_h
 *
eh
);

650 
uag_£t_sub_hªdËr
(
s_msg_h
 *
subh
);

651 
ua_´št_s_¡©us
(
»_´štf
 *
pf
, *
unu£d
);

652 
uag_£t_exŒa_·¿ms
(cÚ¡ *
•rm
);

653 
ua
 *
uag_fšd
(cÚ¡ 
¶
 *
cu£r
);

654 
ua
 *
uag_fšd_aÜ
(cÚ¡ *
aÜ
);

655 
ua
 *
uag_fšd_·¿m
(cÚ¡ *
Çme
, cÚ¡ *
v®
);

656 
s
 *
uag_s
();

657 cÚ¡ *
uag_ev’t_¡r
(
ua_ev’t
 
ev
);

658 
li¡
 *
uag_li¡
();

659 
uag_cu¼’t_£t
(
ua
 *ua);

660 
ua
 *
uag_cu¼’t
();

661 
s£ss_sock
 *
uag_s£ss_sock
();

662 
sev’t_sock
 *
uag_sev’t_sock
();

669 
	sui_sub
 {

670 
li¡
 
u
;

671 
cmd_ùx
 *
uiùx
;

674 (
ui_ouut_h
)(cÚ¡ *
	t¡r
);

677 
	sui
 {

678 
Ë
†e;

679 cÚ¡ *
Çme
;

680 
ui_ouut_h
 *
ouuth
;

683 
ui_»gi¡”
(
ui_sub
 *
uis
, 
ui
 *ui);

684 
ui_uÄegi¡”
(
ui
 *ui);

686 
ui_»£t
(
ui_sub
 *
uis
);

687 
ui_šput_key
(
ui_sub
 *
uis
, 
key
, 
»_´štf
 *
pf
);

688 
ui_šput_¡r
(cÚ¡ *
¡r
);

689 
ui_šput_¶
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

690 
ui_ouut
(
ui_sub
 *
uis
, cÚ¡ *
fmt
, ...);

691 
boŞ
 
ui_i£d™šg
(cÚ¡ 
ui_sub
 *
uis
);

692 
ui_·sswÜd_´om±
(**
·sswÜdp
);

700 
	#KEYCODE_NONE
 (0x00)

	)

701 
	#KEYCODE_REL
 (0x04è

	)

702 
	#KEYCODE_ESC
 (0x1b)

	)

707 
CMD_PRM
 = (1<<0),

708 
CMD_PROG
 = (1<<1),

710 
CMD_IPRM
 = 
CMD_PRM
 | 
CMD_PROG
,

714 
	scmd_¬g
 {

715 
key
;

716 *
´m
;

717 
boŞ
 
com¶‘e
;

718 *
d©a
;

722 
	scmd
 {

723 cÚ¡ *
Çme
;

724 
key
;

725 
æags
;

726 cÚ¡ *
desc
;

727 
»_´štf_h
 *
h
;

730 
cmd_ùx
;

731 
commªds
;

734 
cmd_š™
(
commªds
 **
commªd¥
);

735 
cmd_»gi¡”
(
commªds
 *commands,

736 cÚ¡ 
cmd
 *
cmdv
, 
size_t
 
cmdc
);

737 
cmd_uÄegi¡”
(
commªds
 *commªds, cÚ¡ 
cmd
 *
cmdv
);

738 
cmd_´oûss
(
commªds
 *commªds, 
cmd_ùx
 **
ùxp
, 
key
,

739 
»_´štf
 *
pf
, *
d©a
);

740 
cmd_´oûss_lÚg
(
commªds
 *commªds, cÚ¡ *
¡r
, 
size_t
 
Ën
,

741 
»_´štf
 *
pf_»¥
, *
d©a
);

742 
cmd_´št
(
»_´štf
 *
pf
, cÚ¡ 
commªds
 *commands);

743 cÚ¡ 
cmd
 *
cmd_fšd_lÚg
(cÚ¡ 
commªds
 *commands,

744 cÚ¡ *
Çme
);

745 
cmds
 *
cmds_fšd
(cÚ¡ 
commªds
 *commands,

746 cÚ¡ 
cmd
 *
cmdv
);

753 
vid¤c
;

754 
vid¤c_¡
;

757 
	svid¤c_´m
 {

758 
Ü›Á
;

759 
ås
;

762 (
vid¤c_äame_h
)(
	tvidäame
 *
	täame
, *
	t¬g
);

763 (
vid¤c_”rÜ_h
)(
	t”r
, *
	t¬g
);

765 (
vid¤c_®loc_h
)(
	tvid¤c_¡
 **
	tv¥
, cÚ¡ 
	tvid¤c
 *
	tvs
,

766 
	tmedŸ_ùx
 **
	tùx
, 
	tvid¤c_´m
 *
	t´m
,

767 cÚ¡ 
	tvidsz
 *
	tsize
,

768 cÚ¡ *
	tfmt
, cÚ¡ *
	tdev
,

769 
	tvid¤c_äame_h
 *
	täameh
,

770 
	tvid¤c_”rÜ_h
 *
	t”rÜh
, *
	t¬g
);

772 (
vid¤c_upd©e_h
)(
	tvid¤c_¡
 *
	t¡
, 
	tvid¤c_´m
 *
	t´m
,

773 cÚ¡ *
	tdev
);

775 
vid¤c_»gi¡”
(
vid¤c
 **
vp
, 
li¡
 *
vid¤ş
, cÚ¡ *
Çme
,

776 
vid¤c_®loc_h
 *
®loch
, 
vid¤c_upd©e_h
 *
upd©eh
);

777 cÚ¡ 
vid¤c
 *
vid¤c_fšd
(cÚ¡ 
li¡
 *
vid¤ş
, cÚ¡ *
Çme
);

778 
vid¤c_®loc
(
vid¤c_¡
 **
¡p
, 
li¡
 *
vid¤ş
,

779 cÚ¡ *
Çme
,

780 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

781 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
, cÚ¡ *
dev
,

782 
vid¤c_äame_h
 *
äameh
, 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
);

789 
vidi¥
;

790 
vidi¥_¡
;

793 
	svidi¥_´m
 {

794 *
v›w
;

795 
boŞ
 
fuÎsü“n
;

798 (
vidi¥_»size_h
)(cÚ¡ 
	tvidsz
 *
	tsize
, *
	t¬g
);

800 (
vidi¥_®loc_h
)(
	tvidi¥_¡
 **
	tvp
,

801 cÚ¡ 
	tvidi¥
 *
	tvd
, 
	tvidi¥_´m
 *
	t´m
,

802 cÚ¡ *
	tdev
,

803 
	tvidi¥_»size_h
 *
	t»sizeh
, *
	t¬g
);

804 (
vidi¥_upd©e_h
)(
	tvidi¥_¡
 *
	t¡
, 
	tboŞ
 
	tfuÎsü“n
,

805 
	tÜ›Á
, cÚ¡ 
	tvid»ù
 *
	twšdow
);

806 (
vidi¥_di¥_h
)(
	tvidi¥_¡
 *
	t¡
, cÚ¡ *
	tt™Ë
,

807 cÚ¡ 
	tvidäame
 *
	täame
);

808 (
vidi¥_hide_h
)(
	tvidi¥_¡
 *
	t¡
);

810 
vidi¥_»gi¡”
(
vidi¥
 **
vp
, 
li¡
 *
vidi¥l
, cÚ¡ *
Çme
,

811 
vidi¥_®loc_h
 *
®loch
, 
vidi¥_upd©e_h
 *
upd©eh
,

812 
vidi¥_di¥_h
 *
di¥h
, 
vidi¥_hide_h
 *
hideh
);

813 
vidi¥_®loc
(
vidi¥_¡
 **
¡p
, 
li¡
 *
vidi¥l
,

814 cÚ¡ *
Çme
,

815 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

816 
vidi¥_»size_h
 *
»sizeh
, *
¬g
);

817 
vidi¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

818 cÚ¡ 
vidäame
 *
äame
);

819 cÚ¡ 
vidi¥
 *
vidi¥_fšd
(cÚ¡ 
li¡
 *
vidi¥l
, cÚ¡ *
Çme
);

827 
	sau’c_·¿m
 {

828 
ušt32_t
 
±ime
;

831 
au’c_¡©e
;

832 
audec_¡©e
;

833 
aucodec
;

835 (
au’c_upd©e_h
)(
	tau’c_¡©e
 **
	t«¥
,

836 cÚ¡ 
	taucodec
 *
	tac
,

837 
	tau’c_·¿m
 *
	t´m
, cÚ¡ *
	tfm
);

838 (
au’c_’code_h
)(
	tau’c_¡©e
 *
	t«s
, 
	tušt8_t
 *
	tbuf
,

839 
	tsize_t
 *
	tËn
, cÚ¡ 
	tšt16_t
 *
	t§mpv
, size_ˆ
	t§mpc
);

841 (
audec_upd©e_h
)(
	taudec_¡©e
 **
	tad¥
,

842 cÚ¡ 
	taucodec
 *
	tac
, cÚ¡ *
	tfm
);

843 (
audec_decode_h
)(
	taudec_¡©e
 *
	tads
, 
	tšt16_t
 *
	t§mpv
,

844 
	tsize_t
 *
	t§mpc
, cÚ¡ 
	tušt8_t
 *
	tbuf
, size_ˆ
	tËn
);

845 (
audec_¶c_h
)(
	taudec_¡©e
 *
	tads
,

846 
	tšt16_t
 *
	t§mpv
, 
	tsize_t
 *
	t§mpc
);

848 
	saucodec
 {

849 
Ë
†e;

850 cÚ¡ *
±
;

851 cÚ¡ *
Çme
;

852 
ušt32_t
 
¤©e
;

853 
ušt32_t
 
ü©e
;

854 
ušt8_t
 
ch
;

855 cÚ¡ *
fm
;

856 
au’c_upd©e_h
 *
’cupdh
;

857 
au’c_’code_h
 *
’ch
;

858 
audec_upd©e_h
 *
decupdh
;

859 
audec_decode_h
 *
dech
;

860 
audec_¶c_h
 *
¶ch
;

861 
sdp_fm_’c_h
 *
fm_’ch
;

862 
sdp_fm_cmp_h
 *
fm_cmph
;

865 
aucodec_»gi¡”
(
li¡
 *
aucodeş
, 
aucodec
 *
ac
);

866 
aucodec_uÄegi¡”
(
aucodec
 *
ac
);

867 cÚ¡ 
aucodec
 *
aucodec_fšd
(cÚ¡ 
li¡
 *
aucodeş
,

868 cÚ¡ *
Çme
, 
ušt32_t
 
¤©e
,

869 
ušt8_t
 
ch
);

877 
	svid’c_·¿m
 {

878 
b™¿‹
;

879 
pktsize
;

880 
ås
;

881 
ušt32_t
 
max_fs
;

884 
vid’c_¡©e
;

885 
viddec_¡©e
;

886 
vidcodec
;

888 (
vid’c_·ck‘_h
)(
	tboŞ
 
	tm¬k”
, 
	tušt32_t
 
	t¹p_ts
,

889 cÚ¡ 
	tušt8_t
 *
	thdr
, 
	tsize_t
 
	thdr_Ën
,

890 cÚ¡ 
	tušt8_t
 *
	t¶d
, 
	tsize_t
 
	t¶d_Ën
,

891 *
	t¬g
);

893 (
vid’c_upd©e_h
)(
	tvid’c_¡©e
 **
	tve¥
,

894 cÚ¡ 
	tvidcodec
 *
	tvc
,

895 
	tvid’c_·¿m
 *
	t´m
, cÚ¡ *
	tfm
,

896 
	tvid’c_·ck‘_h
 *
	tpkth
, *
	t¬g
);

897 (
vid’c_’code_h
)(
	tvid’c_¡©e
 *
	tves
, 
	tboŞ
 
	tupd©e
,

898 cÚ¡ 
	tvidäame
 *
	täame
);

900 (
viddec_upd©e_h
)(
	tviddec_¡©e
 **
	tvd¥
,

901 cÚ¡ 
	tvidcodec
 *
	tvc
, cÚ¡ *
	tfm
);

902 (
viddec_decode_h
)(
	tviddec_¡©e
 *
	tvds
, 
	tvidäame
 *
	täame
,

903 
	tboŞ
 *
	tšŒa
, boŞ 
	tm¬k”
, 
	tušt16_t
 
	t£q
,

904 
	tmbuf
 *
	tmb
);

906 
	svidcodec
 {

907 
Ë
†e;

908 cÚ¡ *
±
;

909 cÚ¡ *
Çme
;

910 cÚ¡ *
v¬ŸÁ
;

911 cÚ¡ *
fm
;

912 
vid’c_upd©e_h
 *
’cupdh
;

913 
vid’c_’code_h
 *
’ch
;

914 
viddec_upd©e_h
 *
decupdh
;

915 
viddec_decode_h
 *
dech
;

916 
sdp_fm_’c_h
 *
fm_’ch
;

917 
sdp_fm_cmp_h
 *
fm_cmph
;

920 
vidcodec_»gi¡”
(
li¡
 *
vidcodeş
, 
vidcodec
 *
vc
);

921 
vidcodec_uÄegi¡”
(
vidcodec
 *
vc
);

922 cÚ¡ 
vidcodec
 *
vidcodec_fšd
(cÚ¡ 
li¡
 *
vidcodeş
,

923 cÚ¡ *
Çme
, cÚ¡ *
v¬ŸÁ
);

924 cÚ¡ 
vidcodec
 *
vidcodec_fšd_’cod”
(cÚ¡ 
li¡
 *
vidcodeş
,

925 cÚ¡ *
Çme
);

926 cÚ¡ 
vidcodec
 *
vidcodec_fšd_decod”
(cÚ¡ 
li¡
 *
vidcodeş
,

927 cÚ¡ *
Çme
);

934 
vidft
;

937 
	svidft_’c_¡
 {

938 cÚ¡ 
vidft
 *
vf
;

939 
Ë
†e;

942 
	svidft_dec_¡
 {

943 cÚ¡ 
vidft
 *
vf
;

944 
Ë
†e;

947 (
vidft_’cupd_h
)(
	tvidft_’c_¡
 **
	t¡p
, **
	tùx
,

948 cÚ¡ 
	tvidft
 *
	tvf
);

949 (
vidft_’code_h
)(
	tvidft_’c_¡
 *
	t¡
,

950 
	tvidäame
 *
	täame
);

952 (
vidft_decupd_h
)(
	tvidft_dec_¡
 **
	t¡p
, **
	tùx
,

953 cÚ¡ 
	tvidft
 *
	tvf
);

954 (
vidft_decode_h
)(
	tvidft_dec_¡
 *
	t¡
,

955 
	tvidäame
 *
	täame
);

957 
	svidft
 {

958 
Ë
†e;

959 cÚ¡ *
Çme
;

960 
vidft_’cupd_h
 *
’cupdh
;

961 
vidft_’code_h
 *
’ch
;

962 
vidft_decupd_h
 *
decupdh
;

963 
vidft_decode_h
 *
dech
;

966 
vidft_»gi¡”
(
li¡
 *
vidf
, 
vidft
 *
vf
);

967 
vidft_uÄegi¡”
(
vidft
 *
vf
);

968 
vidft_’c_­³nd
(
li¡
 *
f
, **
ùx
,

969 cÚ¡ 
vidft
 *
vf
);

970 
vidft_dec_­³nd
(
li¡
 *
f
, **
ùx
,

971 cÚ¡ 
vidft
 *
vf
);

978 
audio
;

980 
audio_mu‹
(
audio
 *
a
, 
boŞ
 
mu‹d
);

981 
boŞ
 
audio_ismu‹d
(cÚ¡ 
audio
 *
a
);

982 
audio_£t_deviûÇme
(
audio
 *
a
, cÚ¡ *
¤c
, cÚ¡ *
¶ay
);

983 
audio_£t_sourû
(
audio
 *
au
, cÚ¡ *
mod
, cÚ¡ *
deviû
);

984 
audio_£t_¶ay”
(
audio
 *
au
, cÚ¡ *
mod
, cÚ¡ *
deviû
);

985 
audio_’cod”_cyşe
(
audio
 *audio);

986 
audio_Ëv–_g‘
(cÚ¡ 
audio
 *
au
, *
Ëv–
);

987 
audio_debug
(
»_´štf
 *
pf
, cÚ¡ 
audio
 *
a
);

988 
¡»am
 *
audio_¡rm
(cÚ¡ 
audio
 *
a
);

995 
video
;

997 
video_mu‹
(
video
 *
v
, 
boŞ
 
mu‹d
);

998 *
video_v›w
(cÚ¡ 
video
 *
v
);

999 
video_£t_fuÎsü“n
(
video
 *
v
, 
boŞ
 
fs
);

1000 
video_£t_Ü›Á
(
video
 *
v
, 
Ü›Á
);

1001 
video_vid¤c_£t_deviû
(
video
 *
v
, cÚ¡ *
dev
);

1002 
video_£t_sourû
(
video
 *
v
, cÚ¡ *
Çme
, cÚ¡ *
dev
);

1003 
video_£t_deviûÇme
(
video
 *
v
, cÚ¡ *
¤c
, cÚ¡ *
di¥
);

1004 
video_’cod”_cyşe
(
video
 *video);

1005 
video_debug
(
»_´štf
 *
pf
, cÚ¡ 
video
 *
v
);

1006 
ušt32_t
 
video_ÿlc_¹p_time¡amp
(
št64_t
 
±s
, 
ås
);

1007 
video_ÿlc_£cÚds
(
ušt32_t
 
¹p_ts
);

1008 
¡»am
 *
video_¡rm
(cÚ¡ 
video
 *
v
);

1015 cÚ¡ 
¹ı_¡©s
 *
¡»am_¹ı_¡©s
(cÚ¡ 
¡»am
 *
¡rm
);

1022 
mÇt
;

1023 
mÇt_£ss
;

1024 
mÇt_medŸ
;

1026 (
mÇt_e¡ab_h
)(
	t”r
, 
	tušt16_t
 
	tscode
, cÚ¡ *
	t»asÚ
,

1027 *
	t¬g
);

1029 (
mÇt_£ss_h
)(
	tmÇt_£ss
 **
	t£s¥
, 
	tdnsc
 *dnsc,

1030 
	taf
, cÚ¡ *
	t¤v
, 
	tušt16_t
 
	tpÜt
,

1031 cÚ¡ *
	tu£r
, cÚ¡ *
	t·ss
,

1032 
	tsdp_£ssiÚ
 *
	tsdp
, 
	tboŞ
 
	tofã»r
,

1033 
	tmÇt_e¡ab_h
 *
	te¡abh
, *
	t¬g
);

1035 (
mÇt_medŸ_h
)(
	tmÇt_medŸ
 **
	tmp
, 
	tmÇt_£ss
 *
	t£ss
,

1036 
	t´Ùo
, *
	tsock1
, *
	tsock2
,

1037 
	tsdp_medŸ
 *
	tsdpm
);

1039 (
mÇt_upd©e_h
)(
	tmÇt_£ss
 *
	t£ss
);

1041 
mÇt_»gi¡”
(
mÇt
 **
mÇ
, 
li¡
 *
mÇ
,

1042 cÚ¡ *
id
, cÚ¡ *
áag
,

1043 
mÇt_£ss_h
 *
£ssh
, 
mÇt_medŸ_h
 *
medŸh
,

1044 
mÇt_upd©e_h
 *
upd©eh
);

1050 
»®time_’abË
(
boŞ
 
’abË
, 
ås
);

1057 
boŞ
 
sdp_medŸ_has_medŸ
(cÚ¡ 
sdp_medŸ
 *
m
);

1058 
sdp_medŸ_fšd_unu£d_±
(cÚ¡ 
sdp_medŸ
 *
m
);

1059 
sdp_fšg”´št_decode
(cÚ¡ *
©Œ
, 
¶
 *
hash
,

1060 
ušt8_t
 *
md
, 
size_t
 *
sz
);

1061 
ušt32_t
 
sdp_medŸ_¿‰r_u32
(cÚ¡ 
sdp_medŸ
 *
sdpm
, cÚ¡ *
Çme
);

1062 cÚ¡ *
sdp_¿‰r
(cÚ¡ 
sdp_£ssiÚ
 *
s
, cÚ¡ 
sdp_medŸ
 *
m
,

1063 cÚ¡ *
Çme
);

1070 
s_»q_£nd
(
ua
 *ua, cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

1071 
s_»¥_h
 *
»¥h
, *
¬g
, cÚ¡ *
fmt
, ...);

1080 
H264_NAL_UNKNOWN
 = 0,

1082 
H264_NAL_SLICE
 = 1,

1083 
H264_NAL_DPA
 = 2,

1084 
H264_NAL_DPB
 = 3,

1085 
H264_NAL_DPC
 = 4,

1086 
H264_NAL_IDR_SLICE
 = 5,

1087 
H264_NAL_SEI
 = 6,

1088 
H264_NAL_SPS
 = 7,

1089 
H264_NAL_PPS
 = 8,

1090 
H264_NAL_AUD
 = 9,

1091 
H264_NAL_END_SEQUENCE
 = 10,

1092 
H264_NAL_END_STREAM
 = 11,

1093 
H264_NAL_FILLER_DATA
 = 12,

1094 
H264_NAL_SPS_EXT
 = 13,

1095 
H264_NAL_AUX_SLICE
 = 19,

1097 
H264_NAL_STAP_A
 = 24,

1098 
H264_NAL_STAP_B
 = 25,

1099 
H264_NAL_MTAP16
 = 26,

1100 
H264_NAL_MTAP24
 = 27,

1101 
H264_NAL_FU_A
 = 28,

1102 
H264_NAL_FU_B
 = 29,

1116 
	sh264_hdr
 {

1117 
f
:1;

1118 
Äi
:2;

1119 
ty³
:5;

1122 
h264_hdr_’code
(cÚ¡ 
h264_hdr
 *
hdr
, 
mbuf
 *
mb
);

1123 
h264_hdr_decode
(
h264_hdr
 *
hdr
, 
mbuf
 *
mb
);

1126 
	sh264_fu
 {

1127 
s
:1;

1128 
e
:1;

1129 
r
:1;

1130 
ty³
:5;

1133 
h264_fu_hdr_’code
(cÚ¡ 
h264_fu
 *
fu
, 
mbuf
 *
mb
);

1134 
h264_fu_hdr_decode
(
h264_fu
 *
fu
, 
mbuf
 *
mb
);

1136 cÚ¡ 
ušt8_t
 *
h264_fšd_¡¬tcode
(cÚ¡ ušt8_ˆ*
p
, cÚ¡ ušt8_ˆ*
’d
);

1138 
h264_·ck‘ize
(
ušt32_t
 
¹p_ts
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

1139 
size_t
 
pktsize
, 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

1140 
h264_Çl_£nd
(
boŞ
 
fœ¡
, boŞ 
Ï¡
,

1141 
boŞ
 
m¬k”
, 
ušt32_t
 
ihdr
, ušt32_ˆ
¹p_ts
,

1142 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
size
, size_ˆ
maxsz
,

1143 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

1144 
šlše
 
boŞ
 
h264_is_keyäame
(
ty³
)

1146  
ty³
 =ğ
H264_NAL_SPS
;

1154 #ifdeà
STATIC


1155 
	#DECL_EXPORTS
(
Çme
è
expÜts_
 ##
	)
name

1157 
	#DECL_EXPORTS
(
Çme
è
expÜts


	)

1161 
moduË_´–ßd
(cÚ¡ *
moduË
);

1162 
moduË_lßd
(cÚ¡ *
Çme
);

1163 
moduË_uÆßd
(cÚ¡ *
Çme
);

1170 
mos_ÿlcuÏ‹
(*
r_çùÜ
, 
¹t
,

1171 
j™‹r
, 
ušt32_t
 
num_·ck‘s_lo¡
);

1178 
ev’t_’code_diù
(
odiù
 *
od
, 
ua
 *ua, 
ua_ev’t
 
ev
,

1179 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
);

1186 
b¬es_š™
(
cÚfig
 *
cfg
, 
boŞ
 
´eãr_v6
);

1187 
b¬es_şo£
();

1188 
ÃtwÜk
 *
b¬es_ÃtwÜk
();

1189 
cÚùs
 *
b¬es_cÚùs
();

1190 
commªds
 *
b¬es_commªds
();

1191 
¶ay”
 *
b¬es_¶ay”
();

1192 
mes§ge
 *
b¬es_mes§ge
();

1193 
li¡
 *
b¬es_mÇ
();

1194 
li¡
 *
b¬es_m’ş
();

1195 
li¡
 *
b¬es_aucodeş
();

1196 
li¡
 *
b¬es_au¤ş
();

1197 
li¡
 *
b¬es_au¶ayl
();

1198 
li¡
 *
b¬es_auf
();

1199 
li¡
 *
b¬es_vidcodeş
();

1200 
li¡
 *
b¬es_vid¤ş
();

1201 
li¡
 *
b¬es_vidi¥l
();

1202 
li¡
 *
b¬es_vidf
();

1203 
ui_sub
 *
b¬es_uis
();

1206 #ifdeà
__ılu¥lus


	@baresip/mk/win32/static.c

2 
	~<»_ty³s.h
>

3 
	~<»_mod.h
>

5 cÚ¡ 
mod_expÜt
 
expÜts_cÚs
;

6 cÚ¡ 
mod_expÜt
 
expÜts_wšcÚs
;

7 cÚ¡ 
mod_expÜt
 
expÜts_g711
;

8 cÚ¡ 
mod_expÜt
 
expÜts_wšwave
;

9 cÚ¡ 
mod_expÜt
 
expÜts_dshow
;

10 cÚ¡ 
mod_expÜt
 
expÜts_accouÁ
;

11 cÚ¡ 
mod_expÜt
 
expÜts_cÚù
;

12 cÚ¡ 
mod_expÜt
 
expÜts_m’u
;

13 cÚ¡ 
mod_expÜt
 
expÜts_auloİ
;

14 cÚ¡ 
mod_expÜt
 
expÜts_vidloİ
;

15 cÚ¡ 
mod_expÜt
 
expÜts_uuid
;

16 cÚ¡ 
mod_expÜt
 
expÜts_¡un
;

17 cÚ¡ 
mod_expÜt
 
expÜts_tuº
;

18 cÚ¡ 
mod_expÜt
 
expÜts_iû
;

19 cÚ¡ 
mod_expÜt
 
expÜts_vum‘”
;

22 cÚ¡ 
mod_expÜt
 *
	gmod_bË
[] = {

23 &
expÜts_wšcÚs
,

24 &
expÜts_g711
,

25 &
expÜts_wšwave
,

26 &
expÜts_dshow
,

27 &
expÜts_accouÁ
,

28 &
expÜts_cÚù
,

29 &
expÜts_m’u
,

30 &
expÜts_auloİ
,

31 &
expÜts_vidloİ
,

32 &
expÜts_uuid
,

33 &
expÜts_¡un
,

34 &
expÜts_tuº
,

35 &
expÜts_iû
,

36 &
expÜts_vum‘”
,

37 
NULL


	@baresip/modules/account/account.c

6 
	~<».h
>

7 
	~<b¬es.h
>

30 
	$accouÁ_wr™e_‹m¶©e
(cÚ¡ *
fe
)

32 
FILE
 *
f
 = 
NULL
;

33 cÚ¡ *
logš
, *
·ss
, *
domaš
;

34 
r
, 
”r
 = 0;

36 
	`šfo
("accouÁ: c»©šg‡ccouÁ ‹m¶©%s\n", 
fe
);

38 
f
 = 
	`fİ’
(
fe
, "w");

39 ià(!
f
)

40  
”ºo
;

42 
logš
 = 
·ss
 = 
	`sys_u£ºame
();

43 ià(!
logš
) {

44 
logš
 = "user";

45 
·ss
 = "pass";

48 
domaš
 = 
	`Ãt_domaš
(
	`b¬es_ÃtwÜk
());

49 ià(!
domaš
)

50 
domaš
 = "domain";

52 
r
 = 
	`»_årštf
(
f
,

91 "#<s:%s:%s@%s>\n", 
logš
, 
·ss
, 
domaš
);

92 ià(
r
 < 0)

93 
”r
 = 
ENOMEM
;

95 ià(
f
)

96 ()
	`fşo£
(
f
);

98  
”r
;

99 
	}
}

109 
	$lše_hªdËr
(cÚ¡ 
¶
 *
addr
, *
¬g
)

111 
buf
[512];

112 
ua
 *ua;

113 
accouÁ
 *
acc
;

114 
”r
;

115 ()
¬g
;

117 ()
	`¶_¡rıy
(
addr
, 
buf
, (buf));

119 
”r
 = 
	`ua_®loc
(&
ua
, 
buf
);

120 ià(
”r
)

121  
”r
;

123 
acc
 = 
	`ua_accouÁ
(
ua
);

124 ià(!
acc
) {

125 
	`w¬nšg
("account:‚o‡ccount forhis ua\n");

126  
ENOENT
;

130 ià(!
	`¡r_is£t
(
	`accouÁ_auth_·ss
(
acc
))) {

131 *
·ss
 = 
NULL
;

133 ()
	`»_´štf
("Pleaseƒnter…assword for %s: ",

134 
	`accouÁ_aÜ
(
acc
));

136 
”r
 = 
	`ui_·sswÜd_´om±
(&
·ss
);

137 ià(
”r
)

138 
out
;

140 
”r
 = 
	`accouÁ_£t_auth_·ss
(
acc
, 
·ss
);

142 
	`mem_d”ef
(
·ss
);

145 
out
:

146  
”r
;

147 
	}
}

155 
	$accouÁ_»ad_fe
()

157 
·th
[256] = "", 
fe
[256] = "";

158 
ušt32_t
 
n
;

159 
”r
;

161 
”r
 = 
	`cÚf_·th_g‘
(
·th
, (path));

162 ià(
”r
) {

163 
	`w¬nšg
("accouÁ: cÚf_·th_g‘ (%m)\n", 
”r
);

164  
”r
;

167 ià(
	`»_¢´štf
(
fe
, (fe), "%s/accouÁs", 
·th
) < 0)

168  
ENOMEM
;

170 ià(!
	`cÚf_f“xi¡
(
fe
)) {

172 ()
	`fs_mkdœ
(
·th
, 0700);

174 
”r
 = 
	`accouÁ_wr™e_‹m¶©e
(
fe
);

175 ià(
”r
)

176  
”r
;

179 
”r
 = 
	`cÚf_·r£
(
fe
, 
lše_hªdËr
, 
NULL
);

180 ià(
”r
)

181  
”r
;

183 
n
 = 
	`li¡_couÁ
(
	`uag_li¡
());

184 
	`šfo
("PİuÏ‹d %u‡ccouÁ%s\n", 
n
, 1==n ? "" : "s");

186 ià(
	`li¡_i£m±y
(
	`uag_li¡
())) {

187 
	`šfo
("account: No SIP‡ccounts found\n"

193 
	}
}

196 
	$moduË_š™
()

198  
	`accouÁ_»ad_fe
();

199 
	}
}

202 
	$moduË_şo£
()

205 
	}
}

208 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
accouÁ
) = {

211 
moduË_š™
,

212 
moduË_şo£


	@baresip/modules/alsa/alsa.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_POSIX_SOURCE
 1

	)

8 
	~<sys/ty³s.h
>

9 
	~<sys/time.h
>

10 
	~<¡dlib.h
>

11 
	~<uni¡d.h
>

12 
	~<®§/asoundlib.h
>

13 
	~<».h
>

14 
	~<»m.h
>

15 
	~<b¬es.h
>

16 
	~"®§.h
"

31 
	g®§_dev
[64] = "default";

33 
au¤c
 *
	gau¤c
;

34 
au¶ay
 *
	gau¶ay
;

37 
	$®§_»£t
(
¢d_pcm_t
 *
pcm
, 
ušt32_t
 
¤©e
, ušt32_ˆ
ch
,

38 
ušt32_t
 
num_äames
,

39 
¢d_pcm_fÜm©_t
 
pcmfmt
)

41 
¢d_pcm_hw_·¿ms_t
 *
hw_·¿ms
 = 
NULL
;

42 
¢d_pcm_uäames_t
 
³riod
 = 
num_äames
, 
bufsize
 =‚um_frames * 4;

43 
”r
;

45 
	`debug
("alsa:„eset: srate=%u, ch=%u,‚um_frames=%u,…cmfmt=%s\n",

46 
¤©e
, 
ch
, 
num_äames
, 
	`¢d_pcm_fÜm©_Çme
(
pcmfmt
));

48 
”r
 = 
	`¢d_pcm_hw_·¿ms_m®loc
(&
hw_·¿ms
);

49 ià(
”r
 < 0) {

50 
	`w¬nšg
("alsa: cannot‡llocate hw…arams (%s)\n",

51 
	`¢d_¡»¼Ü
(
”r
));

52 
out
;

55 
”r
 = 
	`¢d_pcm_hw_·¿ms_ªy
(
pcm
, 
hw_·¿ms
);

56 ià(
”r
 < 0) {

57 
	`w¬nšg
("alsa: cannot initialize hw…arams (%s)\n",

58 
	`¢d_¡»¼Ü
(
”r
));

59 
out
;

62 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_acûss
(
pcm
, 
hw_·¿ms
,

63 
SND_PCM_ACCESS_RW_INTERLEAVED
);

64 ià(
”r
 < 0) {

65 
	`w¬nšg
("alsa: cannot set‡ccessype (%s)\n",

66 
	`¢d_¡»¼Ü
(
”r
));

67 
out
;

70 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_fÜm©
(
pcm
, 
hw_·¿ms
, 
pcmfmt
);

71 ià(
”r
 < 0) {

72 
	`w¬nšg
("alsa: cannot set sample format %d (%s)\n",

73 
pcmfmt
, 
	`¢d_¡»¼Ü
(
”r
));

74 
out
;

77 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_¿‹
(
pcm
, 
hw_·¿ms
, 
¤©e
, 0);

78 ià(
”r
 < 0) {

79 
	`w¬nšg
("alsa: cannot set sample„ateo %u Hz (%s)\n",

80 
¤©e
, 
	`¢d_¡»¼Ü
(
”r
));

81 
out
;

84 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_chªÃls
(
pcm
, 
hw_·¿ms
, 
ch
);

85 ià(
”r
 < 0) {

86 
	`w¬nšg
("alsa: cannot set channel counto %d (%s)\n",

87 
ch
, 
	`¢d_¡»¼Ü
(
”r
));

88 
out
;

91 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_³riod_size_Ã¬
(
pcm
, 
hw_·¿ms
,

92 &
³riod
, 0);

93 ià(
”r
 < 0) {

94 
	`w¬nšg
("alsa: cannot set…eriod sizeo %d (%s)\n",

95 
³riod
, 
	`¢d_¡»¼Ü
(
”r
));

98 
”r
 = 
	`¢d_pcm_hw_·¿ms_£t_bufãr_size_Ã¬
(
pcm
, 
hw_·¿ms
, &
bufsize
);

99 ià(
”r
 < 0) {

100 
	`w¬nšg
("alsa: cannot set buffer sizeo %d (%s)\n",

101 
bufsize
, 
	`¢d_¡»¼Ü
(
”r
));

104 
”r
 = 
	`¢d_pcm_hw_·¿ms
(
pcm
, 
hw_·¿ms
);

105 ià(
”r
 < 0) {

106 
	`w¬nšg
("alsa: cannot set…arameters (%s)\n",

107 
	`¢d_¡»¼Ü
(
”r
));

108 
out
;

111 
”r
 = 
	`¢d_pcm_´•¬e
(
pcm
);

112 ià(
”r
 < 0) {

113 
	`w¬nšg
("alsa: cannot…repare‡udio interface for use (%s)\n",

114 
	`¢d_¡»¼Ü
(
”r
));

115 
out
;

118 
”r
 = 0;

120 
out
:

121 
	`¢d_pcm_hw_·¿ms_ä“
(
hw_·¿ms
);

123 ià(
”r
) {

124 
	`w¬nšg
("®§: in™ faed:ƒ¼=%d\n", 
”r
);

127  
”r
;

128 
	}
}

131 
¢d_pcm_fÜm©_t
 
	$aufmt_to_®§fÜm©
(
aufmt
 
fmt
)

133 
fmt
) {

135 
AUFMT_S16LE
:  
SND_PCM_FORMAT_S16
;

136 
AUFMT_FLOAT
:  
SND_PCM_FORMAT_FLOAT
;

137 
AUFMT_S24_3LE
:  
SND_PCM_FORMAT_S24_3LE
;

138 :  
SND_PCM_FORMAT_UNKNOWN
;

140 
	}
}

143 
	$®§_š™
()

145 
¶
 
v®
;

146 
”r
;

149 ià(0 =ğ
	`cÚf_g‘
(
	`cÚf_cur
(), "®§_§m¶e_fÜm©", &
v®
)) {

151 
	`w¬nšg
("alsa:‡lsa_sample_format is deprecated"

154 ()
v®
;

157 
”r
 = 
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

158 "®§", 
®§_¤c_®loc
);

159 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

160 "®§", 
®§_¶ay_®loc
);

162  
”r
;

163 
	}
}

166 
	$®§_şo£
()

168 
au¤c
 = 
	`mem_d”ef
(ausrc);

169 
au¶ay
 = 
	`mem_d”ef
(auplay);

173 
	`¢d_cÚfig_upd©e_ä“_glob®
();

176 
	}
}

179 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
®§
) = {

182 
®§_š™
,

183 
®§_şo£


	@baresip/modules/alsa/alsa.h

8 
®§_dev
[64];

11 
®§_»£t
(
¢d_pcm_t
 *
pcm
, 
ušt32_t
 
¤©e
, ušt32_ˆ
ch
,

12 
ušt32_t
 
num_äames
, 
¢d_pcm_fÜm©_t
 
pcmfmt
);

13 
¢d_pcm_fÜm©_t
 
aufmt_to_®§fÜm©
(
aufmt
 
fmt
);

14 
®§_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

15 
medŸ_ùx
 **
ùx
,

16 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

17 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

18 
®§_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

19 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

20 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

	@baresip/modules/alsa/alsa_play.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_POSIX_SOURCE
 1

	)

8 
	~<sys/ty³s.h
>

9 
	~<sys/time.h
>

10 
	~<¡dlib.h
>

11 
	~<uni¡d.h
>

12 
	~<®§/asoundlib.h
>

13 
	~<±h»ad.h
>

14 
	~<».h
>

15 
	~<»m.h
>

16 
	~<b¬es.h
>

17 
	~"®§.h
"

20 
	sau¶ay_¡
 {

21 cÚ¡ 
au¶ay
 *
	m­
;

22 
±h»ad_t
 
	mth»ad
;

23 
boŞ
 
	mrun
;

24 
¢d_pcm_t
 *
	mwr™e
;

25 *
	m§mpv
;

26 
size_t
 
	m§mpc
;

27 
au¶ay_wr™e_h
 *
	mwh
;

28 *
	m¬g
;

29 
au¶ay_´m
 
	m´m
;

30 *
	mdeviû
;

34 
	$au¶ay_de¡ruùÜ
(*
¬g
)

36 
au¶ay_¡
 *
¡
 = 
¬g
;

39 ià(
¡
->
run
) {

40 
	`debug
("®§: stİpšg…Ïybackh»ad (%s)\n", 
¡
->
deviû
);

41 
¡
->
run
 = 
çl£
;

42 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

45 ià(
¡
->
wr™e
)

46 
	`¢d_pcm_şo£
(
¡
->
wr™e
);

48 
	`mem_d”ef
(
¡
->
§mpv
);

49 
	`mem_d”ef
(
¡
->
deviû
);

50 
	}
}

53 *
	$wr™e_th»ad
(*
¬g
)

55 
au¶ay_¡
 *
¡
 = 
¬g
;

56 
n
;

57 
num_äames
;

59 
num_äames
 = 
¡
->
´m
.
¤©e
 * st->´m.
±ime
 / 1000;

61 
¡
->
run
) {

62 cÚ¡ 
§m¶es
 = 
num_äames
;

63 *
§mpv
;

65 
¡
->
	`wh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

67 
§mpv
 = 
¡
->sampv;

69 
n
 = 
	`¢d_pcm_wr™ei
(
¡
->
wr™e
, 
§mpv
, 
§m¶es
);

71 ià(-
EPIPE
 =ğ
n
) {

72 
	`¢d_pcm_´•¬e
(
¡
->
wr™e
);

74 
n
 = 
	`¢d_pcm_wr™ei
(
¡
->
wr™e
, 
§mpv
, 
§m¶es
);

75 ià(
n
 !ğ
§m¶es
) {

76 
	`w¬nšg
("alsa: writeƒrror: %s\n",

77 
	`¢d_¡»¼Ü
(
n
));

80 ià(
n
 < 0) {

81 
	`w¬nšg
("®§: wr™”rÜ: %s\n", 
	`¢d_¡»¼Ü
(
n
));

83 ià(
n
 !ğ
§m¶es
) {

84 
	`w¬nšg
("alsa: write: wrote %d of %d samples\n",

85 
n
, 
§m¶es
);

89  
NULL
;

90 
	}
}

93 
	$®§_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

94 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

95 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

97 
au¶ay_¡
 *
¡
;

98 
¢d_pcm_fÜm©_t
 
pcmfmt
;

99 
num_äames
;

100 
”r
;

102 ià(!
¡p
 || !
­
 || !
´m
 || !
wh
)

103  
EINVAL
;

105 ià(!
	`¡r_is£t
(
deviû
))

106 
deviû
 = 
®§_dev
;

108 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

109 ià(!
¡
)

110  
ENOMEM
;

112 
”r
 = 
	`¡r_dup
(&
¡
->
deviû
, device);

113 ià(
”r
)

114 
out
;

116 
¡
->
´m
 = *prm;

117 
¡
->
­
 =‡p;

118 
¡
->
wh
 = wh;

119 
¡
->
¬g
 =‡rg;

121 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

122 
num_äames
 = 
¡
->
´m
.
¤©e
 * st->´m.
±ime
 / 1000;

124 
¡
->
§mpv
 = 
	`mem_®loc
(
	`aufmt_§m¶e_size
(
´m
->
fmt
è* st->
§mpc
, 
NULL
);

125 ià(!
¡
->
§mpv
) {

126 
”r
 = 
ENOMEM
;

127 
out
;

130 
”r
 = 
	`¢d_pcm_İ’
(&
¡
->
wr™e
, st->
deviû
, 
SND_PCM_STREAM_PLAYBACK
, 0);

131 ià(
”r
 < 0) {

132 
	`w¬nšg
("alsa: could‚ot open‡uplay device '%s' (%s)\n",

133 
¡
->
deviû
, 
	`¢d_¡»¼Ü
(
”r
));

134 
out
;

137 
pcmfmt
 = 
	`aufmt_to_®§fÜm©
(
´m
->
fmt
);

138 ià(
pcmfmt
 =ğ
SND_PCM_FORMAT_UNKNOWN
) {

139 
	`w¬nšg
("alsa: unknown sample format '%s'\n",

140 
	`aufmt_Çme
(
´m
->
fmt
));

141 
”r
 = 
EINVAL
;

142 
out
;

145 
”r
 = 
	`®§_»£t
(
¡
->
wr™e
, st->
´m
.
¤©e
, st->´m.
ch
, 
num_äames
,

146 
pcmfmt
);

147 ià(
”r
) {

148 
	`w¬nšg
("alsa: could‚ot„eset…layer '%s' (%s)\n",

149 
¡
->
deviû
, 
	`¢d_¡»¼Ü
(
”r
));

150 
out
;

153 
¡
->
run
 = 
Œue
;

154 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
wr™e_th»ad
, st);

155 ià(
”r
) {

156 
¡
->
run
 = 
çl£
;

157 
out
;

160 
	`debug
("®§:…Ïyback s¹ed (%s)\n", 
¡
->
deviû
);

162 
out
:

163 ià(
”r
)

164 
	`mem_d”ef
(
¡
);

166 *
¡p
 = 
¡
;

168  
”r
;

169 
	}
}

	@baresip/modules/alsa/alsa_src.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_POSIX_SOURCE
 1

	)

8 
	~<sys/ty³s.h
>

9 
	~<sys/time.h
>

10 
	~<¡dlib.h
>

11 
	~<uni¡d.h
>

12 
	~<®§/asoundlib.h
>

13 
	~<±h»ad.h
>

14 
	~<».h
>

15 
	~<»m.h
>

16 
	~<b¬es.h
>

17 
	~"®§.h
"

20 
	sau¤c_¡
 {

21 cÚ¡ 
au¤c
 *
	mas
;

22 
±h»ad_t
 
	mth»ad
;

23 
boŞ
 
	mrun
;

24 
¢d_pcm_t
 *
	m»ad
;

25 *
	m§mpv
;

26 
size_t
 
	m§mpc
;

27 
au¤c_»ad_h
 *
	mrh
;

28 *
	m¬g
;

29 
au¤c_´m
 
	m´m
;

30 *
	mdeviû
;

34 
	$au¤c_de¡ruùÜ
(*
¬g
)

36 
au¤c_¡
 *
¡
 = 
¬g
;

39 ià(
¡
->
run
) {

40 
	`debug
("®§: stİpšg„ecÜdšgh»ad (%s)\n", 
¡
->
deviû
);

41 
¡
->
run
 = 
çl£
;

42 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

45 ià(
¡
->
»ad
)

46 
	`¢d_pcm_şo£
(
¡
->
»ad
);

48 
	`mem_d”ef
(
¡
->
§mpv
);

49 
	`mem_d”ef
(
¡
->
deviû
);

50 
	}
}

53 *
	$»ad_th»ad
(*
¬g
)

55 
au¤c_¡
 *
¡
 = 
¬g
;

56 
num_äames
;

57 
”r
;

59 
num_äames
 = 
¡
->
´m
.
¤©e
 * st->´m.
±ime
 / 1000;

62 
”r
 = 
	`¢d_pcm_¡¬t
(
¡
->
»ad
);

63 ià(
”r
) {

64 
	`w¬nšg
("alsa: could‚ot start‡usrc device '%s' (%s)\n",

65 
¡
->
deviû
, 
	`¢d_¡»¼Ü
(
”r
));

66 
out
;

69 
¡
->
run
) {

70 
size_t
 
§mpc
;

71 *
§mpv
;

73 
§mpv
 = 
¡
->sampv;

75 
”r
 = 
	`¢d_pcm_»adi
(
¡
->
»ad
, 
§mpv
, 
num_äames
);

76 ià(
”r
 =ğ-
EPIPE
) {

77 
	`¢d_pcm_´•¬e
(
¡
->
»ad
);

80 ià(
”r
 <= 0) {

84 
§mpc
 = 
”r
 * 
¡
->
´m
.
ch
;

86 
¡
->
	`rh
(¡->
§mpv
, 
§mpc
, st->
¬g
);

89 
out
:

90  
NULL
;

91 
	}
}

94 
	$®§_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

95 
medŸ_ùx
 **
ùx
,

96 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

97 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

99 
au¤c_¡
 *
¡
;

100 
¢d_pcm_fÜm©_t
 
pcmfmt
;

101 
num_äames
;

102 
”r
;

103 ()
ùx
;

104 ()
”rh
;

106 ià(!
¡p
 || !
as
 || !
´m
 || !
rh
)

107  
EINVAL
;

109 ià(!
	`¡r_is£t
(
deviû
))

110 
deviû
 = 
®§_dev
;

112 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

113 ià(!
¡
)

114  
ENOMEM
;

116 
”r
 = 
	`¡r_dup
(&
¡
->
deviû
, device);

117 ià(
”r
)

118 
out
;

120 
¡
->
´m
 = *prm;

121 
¡
->
as
 =‡s;

122 
¡
->
rh
 =„h;

123 
¡
->
¬g
 =‡rg;

125 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

126 
num_äames
 = 
¡
->
´m
.
¤©e
 * st->´m.
±ime
 / 1000;

128 
¡
->
§mpv
 = 
	`mem_®loc
(
	`aufmt_§m¶e_size
(
´m
->
fmt
è* st->
§mpc
, 
NULL
);

129 ià(!
¡
->
§mpv
) {

130 
”r
 = 
ENOMEM
;

131 
out
;

134 
”r
 = 
	`¢d_pcm_İ’
(&
¡
->
»ad
, st->
deviû
, 
SND_PCM_STREAM_CAPTURE
, 0);

135 ià(
”r
 < 0) {

136 
	`w¬nšg
("alsa: could‚ot open‡usrc device '%s' (%s)\n",

137 
¡
->
deviû
, 
	`¢d_¡»¼Ü
(
”r
));

138 
out
;

141 
pcmfmt
 = 
	`aufmt_to_®§fÜm©
(
´m
->
fmt
);

142 ià(
pcmfmt
 =ğ
SND_PCM_FORMAT_UNKNOWN
) {

143 
	`w¬nšg
("alsa: unknown sample format '%s'\n",

144 
	`aufmt_Çme
(
´m
->
fmt
));

145 
”r
 = 
EINVAL
;

146 
out
;

149 
”r
 = 
	`®§_»£t
(
¡
->
»ad
, st->
´m
.
¤©e
, st->´m.
ch
, 
num_äames
,

150 
pcmfmt
);

151 ià(
”r
) {

152 
	`w¬nšg
("alsa: could‚ot„eset source '%s' (%s)\n",

153 
¡
->
deviû
, 
	`¢d_¡»¼Ü
(
”r
));

154 
out
;

157 
¡
->
run
 = 
Œue
;

158 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

159 ià(
”r
) {

160 
¡
->
run
 = 
çl£
;

161 
out
;

164 
	`debug
("alsa:„ecording started (%s) format=%s\n",

165 
¡
->
deviû
, 
	`aufmt_Çme
(
´m
->
fmt
));

167 
out
:

168 ià(
”r
)

169 
	`mem_d”ef
(
¡
);

171 *
¡p
 = 
¡
;

173  
”r
;

174 
	}
}

	@baresip/modules/amr/amr.c

6 
	~<¡dlib.h
>

7 #ifdeà
AMR_NB


8 
	~<š‹rf_’c.h
>

9 
	~<š‹rf_dec.h
>

11 #ifdeà
AMR_WB


12 #ifdeà
_TYPEDEF_H


13 
	#ty³def_h


	)

15 
	~<’c_if.h
>

16 
	~<dec_if.h
>

18 
	~<».h
>

19 
	~<b¬es.h
>

20 
	~"amr.h
"

23 #ifdeà
VO_AMRWBENC_ENC_IF_H


24 
	#IF2E_IF_’code
 
E_IF_’code


	)

25 
	#IF2D_IF_decode
 
D_IF_decode


	)

46 #iâdeà
L_FRAME16k


47 
	#L_FRAME16k
 320

	)

50 #iâdeà
NB_SERIAL_MAX


51 
	#NB_SERIAL_MAX
 61

	)

55 
	mFRAMESIZE_NB
 = 160

59 
	sau’c_¡©e
 {

60 cÚ¡ 
aucodec
 *
	mac
;

61 *
	m’c
;

64 
	saudec_¡©e
 {

65 cÚ¡ 
aucodec
 *
	mac
;

66 *
	mdec
;

70 
	$’code_de¡ruùÜ
(*
¬g
)

72 
au’c_¡©e
 *
¡
 = 
¬g
;

74 
¡
->
ac
->
¤©e
) {

76 #ifdeà
AMR_NB


78 
	`Encod”_IÁ”çû_ex™
(
¡
->
’c
);

82 #ifdeà
AMR_WB


84 
	`E_IF_ex™
(
¡
->
’c
);

88 
	}
}

91 
	$decode_de¡ruùÜ
(*
¬g
)

93 
audec_¡©e
 *
¡
 = 
¬g
;

95 
¡
->
ac
->
¤©e
) {

97 #ifdeà
AMR_NB


99 
	`Decod”_IÁ”çû_ex™
(
¡
->
dec
);

103 #ifdeà
AMR_WB


105 
	`D_IF_ex™
(
¡
->
dec
);

109 
	}
}

112 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

113 cÚ¡ 
aucodec
 *
ac
,

114 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

116 
au’c_¡©e
 *
¡
;

117 
”r
 = 0;

118 ()
´m
;

119 ()
fm
;

121 ià(!
«¥
 || !
ac
)

122  
EINVAL
;

124 ià(*
«¥
)

127 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

128 ià(!
¡
)

129  
ENOMEM
;

131 
¡
->
ac
 =‡c;

133 
ac
->
¤©e
) {

135 #ifdeà
AMR_NB


137 
¡
->
’c
 = 
	`Encod”_IÁ”çû_š™
(0);

141 #ifdeà
AMR_WB


143 
¡
->
’c
 = 
	`E_IF_š™
();

148 ià(!
¡
->
’c
)

149 
”r
 = 
ENOMEM
;

151 ià(
”r
)

152 
	`mem_d”ef
(
¡
);

154 *
«¥
 = 
¡
;

156  
”r
;

157 
	}
}

160 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

161 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

163 
audec_¡©e
 *
¡
;

164 
”r
 = 0;

165 ()
fm
;

167 ià(!
ad¥
 || !
ac
)

168  
EINVAL
;

170 ià(*
ad¥
)

173 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

174 ià(!
¡
)

175  
ENOMEM
;

177 
¡
->
ac
 =‡c;

179 
ac
->
¤©e
) {

181 #ifdeà
AMR_NB


183 
¡
->
dec
 = 
	`Decod”_IÁ”çû_š™
();

187 #ifdeà
AMR_WB


189 
¡
->
dec
 = 
	`D_IF_š™
();

194 ià(!
¡
->
dec
)

195 
”r
 = 
ENOMEM
;

197 ià(
”r
)

198 
	`mem_d”ef
(
¡
);

200 *
ad¥
 = 
¡
;

202  
”r
;

203 
	}
}

206 #ifdeà
AMR_WB


207 
	$’code_wb
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

208 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

210 
n
;

212 ià(
§mpc
 !ğ
L_FRAME16k
)

213  
EINVAL
;

215 ià(*
Ën
 < 
NB_SERIAL_MAX
)

216  
ENOMEM
;

219 
buf
[0] = 15 << 4;

221 
n
 = 
	`IF2E_IF_’code
(
¡
->
’c
, 8, 
§mpv
, &
buf
[1], 0);

222 ià(
n
 <= 0)

223  
EPROTO
;

225 *
Ën
 = (1 + 
n
);

228 
	}
}

231 
	$decode_wb
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

232 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

234 ià(*
§mpc
 < 
L_FRAME16k
)

235  
ENOMEM
;

236 ià(
Ën
 > 
NB_SERIAL_MAX
)

237  
EINVAL
;

239 
	`IF2D_IF_decode
(
¡
->
dec
, &
buf
[1], 
§mpv
, 0);

241 *
§mpc
 = 
L_FRAME16k
;

244 
	}
}

248 #ifdeà
AMR_NB


249 
	$’code_nb
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
,

250 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

252 
r
;

254 ià(!
¡
 || !
buf
 || !
Ën
 || !
§mpv
 || 
§mpc
 !ğ
FRAMESIZE_NB
)

255  
EINVAL
;

256 ià(*
Ën
 < 
NB_SERIAL_MAX
)

257  
ENOMEM
;

260 
buf
[0] = 15 << 4;

262 
r
 = 
	`Encod”_IÁ”çû_Encode
(
¡
->
’c
, 
MR122
, 
§mpv
, &
buf
[1], 0);

263 ià(
r
 <= 0)

264  
EPROTO
;

266 *
Ën
 = (1 + 
r
);

269 
	}
}

272 
	$decode_nb
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

273 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

275 ià(!
¡
 || !
§mpv
 || !
§mpc
 || !
buf
)

276  
EINVAL
;

278 ià(
Ën
 > 
NB_SERIAL_MAX
)

279  
EPROTO
;

281 ià(*
§mpc
 < 
L_FRAME16k
)

282  
ENOMEM
;

284 
	`Decod”_IÁ”çû_Decode
(
¡
->
dec
, &
buf
[1], 
§mpv
, 0);

286 *
§mpc
 = 
FRAMESIZE_NB
;

289 
	}
}

293 #ifdeà
AMR_WB


294 
aucodec
 
	gamr_wb
 = {

295 
LE_INIT
, 
NULL
, "AMR-WB", 16000, 16000, 1, NULL,

296 
’code_upd©e
, 
’code_wb
,

297 
decode_upd©e
, 
decode_wb
,

298 
NULL
, 
amr_fm_’c
, 
amr_fm_cmp


301 #ifdeà
AMR_NB


302 
aucodec
 
	gamr_nb
 = {

303 
LE_INIT
, 
NULL
, "AMR", 8000, 8000, 1, NULL,

304 
’code_upd©e
, 
’code_nb
,

305 
decode_upd©e
, 
decode_nb
,

306 
NULL
, 
amr_fm_’c
, 
amr_fm_cmp


311 
	$moduË_š™
()

313 
”r
 = 0;

315 #ifdeà
AMR_WB


316 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
amr_wb
);

318 #ifdeà
AMR_NB


319 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
amr_nb
);

322  
”r
;

323 
	}
}

326 
	$moduË_şo£
()

328 #ifdeà
AMR_WB


329 
	`aucodec_uÄegi¡”
(&
amr_wb
);

331 #ifdeà
AMR_NB


332 
	`aucodec_uÄegi¡”
(&
amr_nb
);

336 
	}
}

339 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
amr
) = {

342 
moduË_š™
,

343 
moduË_şo£


	@baresip/modules/amr/amr.h

8 
amr_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

9 
boŞ
 
ofãr
, *
¬g
);

10 
boŞ
 
amr_fm_cmp
(cÚ¡ *
lfm
, cÚ¡ *
rfm
, *
¬g
);

	@baresip/modules/amr/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"amr.h
"

12 
boŞ
 
	$amr_où‘_®ign
(cÚ¡ *
fm
)

14 
¶
…l, 
ß
;

16 ià(!
fm
)

17  
çl£
;

19 
	`¶_£t_¡r
(&
¶
, 
fm
);

21 ià(
	`fmt_·¿m_g‘
(&
¶
, "où‘-®ign", &
ß
))

22  0 =ğ
	`¶_¡rcmp
(&
ß
, "1");

24  
çl£
;

25 
	}
}

28 
	$amr_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

29 
boŞ
 
ofãr
, *
¬g
)

31 cÚ¡ 
aucodec
 *
ac
 = 
¬g
;

32 ()
ofãr
;

34 ià(!
mb
 || !
fmt
 || !
ac
)

37  
	`mbuf_´štf
(
mb
, "a=fmtp:%s octet-align=1\r\n",

38 
fmt
->
id
);

39 
	}
}

42 
boŞ
 
	$amr_fm_cmp
(cÚ¡ *
lfm
, cÚ¡ *
rfm
, *
¬g
)

44 cÚ¡ 
aucodec
 *
ac
 = 
¬g
;

45 ()
lfm
;

47 ià(!
ac
)

48  
çl£
;

50 ià(!
	`amr_où‘_®ign
(
rfm
)) {

51 
	`šfo
("amr: octet-align mode is„equired\n");

52  
çl£
;

55  
Œue
;

56 
	}
}

	@baresip/modules/aubridge/aubridge.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"aubridge.h
"

29 
au¤c
 *
	gau¤c
;

30 
au¶ay
 *
	gau¶ay
;

32 
hash
 *
	ght_deviû
;

35 
	$moduË_š™
()

37 
”r
;

39 
”r
 = 
	`hash_®loc
(&
ht_deviû
, 32);

40 ià(
”r
)

41  
”r
;

43 
”r
 = 
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "aubridge", 
¤c_®loc
);

44 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

45 "aubridge", 
¶ay_®loc
);

47  
”r
;

48 
	}
}

51 
	$moduË_şo£
()

53 
au¤c
 = 
	`mem_d”ef
(ausrc);

54 
au¶ay
 = 
	`mem_d”ef
(auplay);

56 
ht_deviû
 = 
	`mem_d”ef
(ht_device);

59 
	}
}

62 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
aubridge
) = {

65 
moduË_š™
,

66 
moduË_şo£
,

	@baresip/modules/aubridge/aubridge.h

8 
	gdeviû
;

10 
	sau¤c_¡
 {

11 cÚ¡ 
au¤c
 *
	mas
;

12 
deviû
 *
	mdev
;

13 
au¤c_´m
 
	m´m
;

14 
au¤c_»ad_h
 *
	mrh
;

15 *
	m¬g
;

18 
	sau¶ay_¡
 {

19 cÚ¡ 
au¶ay
 *
	m­
;

20 
deviû
 *
	mdev
;

21 
au¶ay_´m
 
	m´m
;

22 
au¶ay_wr™e_h
 *
	mwh
;

23 *
	m¬g
;

27 
hash
 *
ht_deviû
;

30 
¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

31 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

32 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

33 
¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

34 
medŸ_ùx
 **
ùx
,

35 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

36 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

39 
deviû_cÚÃù
(
deviû
 **
devp
, const *device,

40 
au¶ay_¡
 *
au¶ay
, 
au¤c_¡
 *
au¤c
);

41 
deviû_¡İ
(
deviû
 *
dev
);

	@baresip/modules/aubridge/device.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<±h»ad.h
>

10 
	~"aubridge.h
"

14 ’um {
	mPTIME
 = 20};

17 
	sdeviû
 {

18 
Ë
 
	mË
;

19 cÚ¡ 
au¤c_¡
 *
	mau¤c
;

20 cÚ¡ 
au¶ay_¡
 *
	mau¶ay
;

21 
	mÇme
[64];

22 
±h»ad_t
 
	mth»ad
;

23 vŞ©
boŞ
 
	mrun
;

27 
	$de¡ruùÜ
(*
¬g
)

29 
deviû
 *
dev
 = 
¬g
;

31 
	`deviû_¡İ
(
dev
);

33 
	`li¡_uÆšk
(&
dev
->
Ë
);

34 
	}
}

37 
boŞ
 
	$li¡_­¶y_hªdËr
(
Ë
 *Ë, *
¬g
)

39 
deviû
 *
¡
 = 
Ë
->
d©a
;

41  0 =ğ
	`¡r_cmp
(
¡
->
Çme
, 
¬g
);

42 
	}
}

45 
deviû
 *
	$fšd_deviû
(cÚ¡ *
deviû
)

47  
	`li¡_Ëd©a
(
	`hash_lookup
(
ht_deviû
, 
	`hash_jß©_¡r
(
deviû
),

48 
li¡_­¶y_hªdËr
, (*)
deviû
));

49 
	}
}

52 *
	$deviû_th»ad
(*
¬g
)

54 
ušt64_t
 
now
, 
ts
 = 
	`tmr_jiff›s
();

55 
deviû
 *
dev
 = 
¬g
;

56 
au»§mp
 
rs
;

57 
št16_t
 *
§mpv_š
, *
§mpv_out
;

58 
size_t
 
§mpc_š
;

59 
size_t
 
§mpc_out
;

60 
”r
;

62 
§mpc_š
 = 
dev
->
au¶ay
->
´m
.
¤©e
 * dev->au¶ay->´m.
ch
 * 
PTIME
/1000;

63 
§mpc_out
 = 
dev
->
au¤c
->
´m
.
¤©e
 * dev->au¤c->´m.
ch
 * 
PTIME
/1000;

65 
	`au»§mp_š™
(&
rs
);

67 
§mpv_š
 = 
	`mem_®loc
(2 * 
§mpc_š
, 
NULL
);

68 
§mpv_out
 = 
	`mem_®loc
(2 * 
§mpc_out
, 
NULL
);

69 ià(!
§mpv_š
 || !
§mpv_out
)

70 
out
;

72 
”r
 = 
	`au»§mp_£tup
(&
rs
,

73 
dev
->
au¶ay
->
´m
.
¤©e
, dev->au¶ay->´m.
ch
,

74 
dev
->
au¤c
->
´m
.
¤©e
, dev->au¤c->´m.
ch
);

75 ià(
”r
)

76 
out
;

78 
dev
->
run
) {

80 ()
	`sys_m¦“p
(4);

82 ià(!
dev
->
run
)

85 
now
 = 
	`tmr_jiff›s
();

87 ià(
ts
 > 
now
)

90 ià(
dev
->
au¶ay
 && dev->au¶ay->
wh
) {

91 
dev
->
au¶ay
->
	`wh
(
§mpv_š
, 
§mpc_š
, dev->au¶ay->
¬g
);

94 ià(
rs
.
»§m¶e
) {

95 
”r
 = 
	`au»§mp
(&
rs
,

96 
§mpv_out
, &
§mpc_out
,

97 
§mpv_š
, 
§mpc_š
);

98 ià(
”r
) {

99 
	`w¬nšg
("aubridge:‡uresampƒrror"

101 
§mpc_out
, 
§mpc_š
, 
”r
);

104 ià(
dev
->
au¤c
 && dev->au¤c->
rh
) {

105 
dev
->
au¤c
->
	`rh
(
§mpv_out
, 
§mpc_out
,

106 
dev
->
au¤c
->
¬g
);

110 ià(
dev
->
au¤c
 && dev->au¤c->
rh
) {

111 
dev
->
au¤c
->
	`rh
(
§mpv_š
, 
§mpc_š
,

112 
dev
->
au¤c
->
¬g
);

116 
ts
 +ğ
PTIME
;

119 
out
:

120 
	`mem_d”ef
(
§mpv_š
);

121 
	`mem_d”ef
(
§mpv_out
);

123  
NULL
;

124 
	}
}

127 
	$deviû_cÚÃù
(
deviû
 **
devp
, const *device,

128 
au¶ay_¡
 *
au¶ay
, 
au¤c_¡
 *
au¤c
)

130 
deviû
 *
dev
;

131 
”r
 = 0;

133 ià(!
devp
)

134  
EINVAL
;

135 ià(!
	`¡r_is£t
(
deviû
))

136  
ENODEV
;

138 
dev
 = 
	`fšd_deviû
(
deviû
);

139 ià(
dev
) {

140 *
devp
 = 
	`mem_»f
(
dev
);

143 
dev
 = 
	`mem_z®loc
((*dev), 
de¡ruùÜ
);

144 ià(!
dev
)

145  
ENOMEM
;

147 
	`¡r_nıy
(
dev
->
Çme
, 
deviû
, (dev->name));

149 
	`hash_­³nd
(
ht_deviû
, 
	`hash_jß©_¡r
(
deviû
), &
dev
->
Ë
, dev);

151 *
devp
 = 
dev
;

153 
	`šfo
("aubridge: c»©ed deviû '%s'\n", 
deviû
);

156 ià(
au¶ay
)

157 
dev
->
au¶ay
 =‡uplay;

158 ià(
au¤c
)

159 
dev
->
au¤c
 =‡usrc;

162 ià(
dev
->
au¤c
 && dev->
au¶ay
 && !dev->
run
) {

164 
dev
->
run
 = 
Œue
;

165 
”r
 = 
	`±h»ad_ü—‹
(&
dev
->
th»ad
, 
NULL
, 
deviû_th»ad
, dev);

166 ià(
”r
) {

167 
dev
->
run
 = 
çl£
;

171  
”r
;

172 
	}
}

175 
	$deviû_¡İ
(
deviû
 *
dev
)

177 ià(!
dev
)

180 
dev
->
au¶ay
 = 
NULL
;

181 
dev
->
au¤c
 = 
NULL
;

183 ià(
dev
->
run
) {

184 
dev
->
run
 = 
çl£
;

185 
	`±h»ad_još
(
dev
->
th»ad
, 
NULL
);

187 
	}
}

	@baresip/modules/aubridge/play.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"aubridge.h
"

12 
	$au¶ay_de¡ruùÜ
(*
¬g
)

14 
au¶ay_¡
 *
¡
 = 
¬g
;

16 
	`deviû_¡İ
(
¡
->
dev
);

18 
	`mem_d”ef
(
¡
->
dev
);

19 
	}
}

22 
	$¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

23 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

24 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

26 
au¶ay_¡
 *
¡
;

27 
”r
;

29 ià(!
¡p
 || !
­
 || !
´m
)

30  
EINVAL
;

32 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

33 
	`w¬nšg
("aubridge:…layback: unsupported sample format (%s)\n",

34 
	`aufmt_Çme
(
´m
->
fmt
));

35  
ENOTSUP
;

38 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

39 ià(!
¡
)

40  
ENOMEM
;

42 
¡
->
­
 =‡p;

43 
¡
->
´m
 = *prm;

44 
¡
->
wh
 = wh;

45 
¡
->
¬g
 =‡rg;

47 
”r
 = 
	`deviû_cÚÃù
(&
¡
->
dev
, 
deviû
, st, 
NULL
);

48 ià(
”r
)

49 
out
;

51 
out
:

52 ià(
”r
)

53 
	`mem_d”ef
(
¡
);

55 *
¡p
 = 
¡
;

57  
”r
;

58 
	}
}

	@baresip/modules/aubridge/src.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"aubridge.h
"

12 
	$au¤c_de¡ruùÜ
(*
¬g
)

14 
au¤c_¡
 *
¡
 = 
¬g
;

16 
	`deviû_¡İ
(
¡
->
dev
);

18 
	`mem_d”ef
(
¡
->
dev
);

19 
	}
}

22 
	$¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

23 
medŸ_ùx
 **
ùx
,

24 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

25 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

27 
au¤c_¡
 *
¡
;

28 
”r
 = 0;

29 ()
ùx
;

30 ()
”rh
;

32 ià(!
¡p
 || !
as
 || !
´m
)

33  
EINVAL
;

35 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

36 
	`w¬nšg
("aubridge: source: unsupported sample format (%s)\n",

37 
	`aufmt_Çme
(
´m
->
fmt
));

38  
ENOTSUP
;

41 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

42 ià(!
¡
)

43  
ENOMEM
;

45 
¡
->
as
 =‡s;

46 
¡
->
´m
 = *prm;

47 
¡
->
rh
 =„h;

48 
¡
->
¬g
 =‡rg;

50 
”r
 = 
	`deviû_cÚÃù
(&
¡
->
dev
, 
deviû
, 
NULL
, st);

51 ià(
”r
)

52 
out
;

54 
out
:

55 ià(
”r
)

56 
	`mem_d”ef
(
¡
);

58 *
¡p
 = 
¡
;

60  
”r
;

61 
	}
}

	@baresip/modules/audiounit/audiounit.c

6 
	~<AudioUn™/AudioUn™.h
>

7 
	~<AudioToŞbox/AudioToŞbox.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"audioun™.h
"

20 
AudioCompÚ’t
 
	gouut_comp
 = 
NULL
;

22 
au¶ay
 *
	gau¶ay
;

23 
au¤c
 *
	gau¤c
;

26 #ià
TARGET_OS_IPHONE


27 
	$š‹¼u±iÚLi¡’”
(*
d©a
, 
UIÁ32
 
šIÁ”ru±iÚS‹
)

29 ()
d©a
;

31 ià(
šIÁ”ru±iÚS‹
 =ğ
kAudioSessiÚBegšIÁ”ru±iÚ
) {

32 
	`šfo
("audiounit: interrupt Begin\n");

33 
	`audio£ss_š‹¼u±
(
Œue
);

35 ià(
šIÁ”ru±iÚS‹
 =ğ
kAudioSessiÚEndIÁ”ru±iÚ
) {

36 
	`šfo
("audiounit: interrupt End\n");

37 
	`audio£ss_š‹¼u±
(
çl£
);

39 
	}
}

43 
	$moduË_š™
()

45 
AudioCompÚ’tDesütiÚ
 
desc
;

46 
”r
;

48 #ià
TARGET_OS_IPHONE


49 
OSStus
 
»t
;

51 
»t
 = 
	`AudioSessiÚIn™Ÿlize
(
NULL
, NULL, 
š‹¼u±iÚLi¡’”
, 0);

52 ià(
»t
 &&„‘ !ğ
kAudioSessiÚAÌ—dyIn™Ÿlized
) {

53 
	`w¬nšg
("audioun™: AudioSessiÚIn™Ÿlize: %d\n", 
»t
);

54  
ENODEV
;

58 
desc
.
compÚ’tTy³
 = 
kAudioUn™Ty³_Ouut
;

59 #ià
TARGET_OS_IPHONE


60 
desc
.
compÚ’tSubTy³
 = 
kAudioUn™SubTy³_VoiûProûssšgIO
;

62 
desc
.
compÚ’tSubTy³
 = 
kAudioUn™SubTy³_HALOuut
;

64 
desc
.
compÚ’tMªuçùu»r
 = 
kAudioUn™Mªuçùu»r_AµË
;

65 
desc
.
compÚ’tFÏgs
 = 0;

66 
desc
.
compÚ’tFÏgsMask
 = 0;

68 
ouut_comp
 = 
	`AudioCompÚ’tFšdNext
(
NULL
, &
desc
);

69 ià(!
ouut_comp
) {

70 
	`w¬nšg
("audiounit: Voice Processing I/O‚ot found\n");

71  
ENOENT
;

74 
”r
 = 
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

75 "audioun™", 
audioun™_¶ay”_®loc
);

76 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

77 "audioun™", 
audioun™_»cÜd”_®loc
);

80 
	}
}

83 
	$moduË_şo£
()

85 
au¤c
 = 
	`mem_d”ef
(ausrc);

86 
au¶ay
 = 
	`mem_d”ef
(auplay);

89 
	}
}

92 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
audioun™
) = {

95 
moduË_š™
,

96 
moduË_şo£
,

	@baresip/modules/audiounit/audiounit.h

8 
AudioCompÚ’t
 
	gouut_comp
;

11 
	gaudio£ss
;

12 
	gaudio£ss_¡
;

14 (
	taudio£ss_št_h
)(
	tboŞ
 
	t¡¬t
, *
	t¬g
);

16 
	`audio£ss_®loc
(
audio£ss_¡
 **
¡p
,

17 
audio£ss_št_h
 *
šth
, *
¬g
);

18 
	`audio£ss_š‹¼u±
(
boŞ
 
š‹¼u±ed
);

21 
	`audioun™_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

22 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

23 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

24 
	`audioun™_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

25 
medŸ_ùx
 **
ùx
,

26 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

27 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

	@baresip/modules/audiounit/player.c

6 
	~<AudioUn™/AudioUn™.h
>

7 
	~<AudioToŞbox/AudioToŞbox.h
>

8 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

12 
	~"audioun™.h
"

15 
	sau¶ay_¡
 {

16 cÚ¡ 
au¶ay
 *
	m­
;

17 
audio£ss_¡
 *
	m£ss
;

18 
AudioUn™
 
	mau
;

19 
±h»ad_mu‹x_t
 
	mmu‹x
;

20 
au¶ay_wr™e_h
 *
	mwh
;

21 *
	m¬g
;

22 
ušt32_t
 
	m§mpsz
;

26 
	$au¶ay_de¡ruùÜ
(*
¬g
)

28 
au¶ay_¡
 *
¡
 = 
¬g
;

30 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

31 
¡
->
wh
 = 
NULL
;

32 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

34 
	`AudioOuutUn™Stİ
(
¡
->
au
);

35 
	`AudioUn™Unš™Ÿlize
(
¡
->
au
);

36 
	`AudioCompÚ’tIn¡ªûDi¥o£
(
¡
->
au
);

38 
	`mem_d”ef
(
¡
->
£ss
);

40 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
mu‹x
);

41 
	}
}

44 
OSStus
 
	$ouut_ÿÎback
(*
šRefCÚ
,

45 
AudioUn™R’d”AùiÚFÏgs
 *
ioAùiÚFÏgs
,

46 cÚ¡ 
AudioTimeSmp
 *
šTimeSmp
,

47 
UIÁ32
 
šBusNumb”
,

48 
UIÁ32
 
šNumb”F¿mes
,

49 
AudioBufãrLi¡
 *
ioD©a
)

51 
au¶ay_¡
 *
¡
 = 
šRefCÚ
;

52 
au¶ay_wr™e_h
 *
wh
;

53 *
¬g
;

54 
ušt32_t
 
i
;

56 ()
ioAùiÚFÏgs
;

57 ()
šTimeSmp
;

58 ()
šBusNumb”
;

59 ()
šNumb”F¿mes
;

61 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

62 
wh
 = 
¡
->wh;

63 
¬g
 = 
¡
->arg;

64 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

66 ià(!
wh
)

69 
i
 = 0; i < 
ioD©a
->
mNumb”Bufãrs
; ++i) {

71 
AudioBufãr
 *
ab
 = &
ioD©a
->
mBufãrs
[
i
];

73 
	`wh
(
ab
->
mD©a
,‡b->
mD©aBy‹Size
/
¡
->
§mpsz
, 
¬g
);

77 
	}
}

80 
	$š‹¼u±_hªdËr
(
boŞ
 
š‹¼u±ed
, *
¬g
)

82 
au¶ay_¡
 *
¡
 = 
¬g
;

84 ià(
š‹¼u±ed
)

85 
	`AudioOuutUn™Stİ
(
¡
->
au
);

87 
	`AudioOuutUn™S¹
(
¡
->
au
);

88 
	}
}

91 
ušt32_t
 
	$aufmt_to_fÜm©æags
(
aufmt
 
fmt
)

93 
fmt
) {

95 
AUFMT_S16LE
:  
kLš—rPCMFÜm©FÏgIsSigÃdIÁeg”
;

96 
AUFMT_FLOAT
:  
kLš—rPCMFÜm©FÏgIsFlßt
;

99 
	}
}

102 
	$audioun™_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

103 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

104 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

106 
AudioSŒ—mBasicDesütiÚ
 
fmt
;

107 
AudioUn™EËm’t
 
ouutBus
 = 0;

108 
AUR’d”C®lbackSŒuù
 
cb
;

109 
au¶ay_¡
 *
¡
;

110 
UIÁ32
 
’abË
 = 1;

111 
OSStus
 
»t
 = 0;

112 
Flßt64
 
hw_¤©e
 = 0.0;

113 
UIÁ32
 
hw_size
 = (
hw_¤©e
);

114 
”r
;

116 ()
deviû
;

118 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

119 ià(!
¡
)

120  
ENOMEM
;

122 
¡
->
­
 =‡p;

123 
¡
->
wh
 = wh;

124 
¡
->
¬g
 =‡rg;

126 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

127 ià(
”r
)

128 
out
;

130 
”r
 = 
	`audio£ss_®loc
(&
¡
->
£ss
, 
š‹¼u±_hªdËr
, st);

131 ià(
”r
)

132 
out
;

134 
»t
 = 
	`AudioCompÚ’tIn¡ªûNew
(
ouut_comp
, &
¡
->
au
);

135 ià(
»t
)

136 
out
;

138 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
, 
kAudioOuutUn™Prİ”ty_EÇbËIO
,

139 
kAudioUn™Scİe_Ouut
, 
ouutBus
,

140 &
’abË
, (enable));

141 ià(
»t
) {

142 
	`w¬nšg
("audioun™: EÇbËIO faed (%d)\n", 
»t
);

143 
out
;

146 
¡
->
§mpsz
 = (
ušt32_t
)
	`aufmt_§m¶e_size
(
´m
->
fmt
);

148 
fmt
.
mSam¶eR©e
 = 
´m
->
¤©e
;

149 
fmt
.
mFÜm©ID
 = 
kAudioFÜm©Lš—rPCM
;

150 #ià
TARGET_OS_IPHONE


151 
fmt
.
mFÜm©FÏgs
 = 
	`aufmt_to_fÜm©æags
(
´m
->fmt)

152 | 
kAudioFÜm©FÏgsN©iveEndŸn


153 | 
kAudioFÜm©FÏgIsPacked
;

155 
fmt
.
mFÜm©FÏgs
 = 
	`aufmt_to_fÜm©æags
(
´m
->fmt)

156 | 
kAudioFÜm©FÏgIsPacked
;

158 
fmt
.
mB™sP”ChªÃl
 = 8 * 
¡
->
§mpsz
;

159 
fmt
.
mChªÃlsP”F¿me
 = 
´m
->
ch
;

160 
fmt
.
mBy‹sP”F¿me
 = 
¡
->
§mpsz
 * 
´m
->
ch
;

161 
fmt
.
mF¿mesP”Pack‘
 = 1;

162 
fmt
.
mBy‹sP”Pack‘
 = 
¡
->
§mpsz
 * 
´m
->
ch
;

164 
»t
 = 
	`AudioUn™In™Ÿlize
(
¡
->
au
);

165 ià(
»t
)

166 
out
;

168 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
, 
kAudioUn™Prİ”ty_SŒ—mFÜm©
,

169 
kAudioUn™Scİe_IÅut
, 
ouutBus
,

170 &
fmt
, (fmt));

171 ià(
»t
)

172 
out
;

174 
cb
.
šputProc
 = 
ouut_ÿÎback
;

175 
cb
.
šputProcRefCÚ
 = 
¡
;

176 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
,

177 
kAudioUn™Prİ”ty_S‘R’d”C®lback
,

178 
kAudioUn™Scİe_IÅut
, 
ouutBus
,

179 &
cb
, (cb));

180 ià(
»t
)

181 
out
;

183 
»t
 = 
	`AudioOuutUn™S¹
(
¡
->
au
);

184 ià(
»t
)

185 
out
;

187 
»t
 = 
	`AudioUn™G‘Prİ”ty
(
¡
->
au
,

188 
kAudioUn™Prİ”ty_Sam¶eR©e
,

189 
kAudioUn™Scİe_Ouut
,

191 &
hw_¤©e
,

192 &
hw_size
);

193 ià(
»t
)

194 
out
;

196 
	`debug
("audiounit:…layer hardware sample„ate is‚ow‡t %f Hz\n",

197 
hw_¤©e
);

199 
out
:

200 ià(
»t
) {

201 
	`w¬nšg
("audioun™:…Ïy” faed: %d (%c%c%c%c)\n", 
»t
,

202 
»t
>>24,„et>>16,„et>>8,„et);

203 
”r
 = 
ENODEV
;

206 ià(
”r
)

207 
	`mem_d”ef
(
¡
);

209 *
¡p
 = 
¡
;

211  
”r
;

212 
	}
}

	@baresip/modules/audiounit/recorder.c

6 
	~<AudioUn™/AudioUn™.h
>

7 
	~<AudioToŞbox/AudioToŞbox.h
>

8 
	~<T¬g‘CÚd™iÚ®s.h
>

9 
	~<±h»ad.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

13 
	~"audioun™.h
"

16 
	sau¤c_¡
 {

17 cÚ¡ 
au¤c
 *
	mas
;

18 
audio£ss_¡
 *
	m£ss
;

19 
AudioUn™
 
	mau
;

20 
±h»ad_mu‹x_t
 
	mmu‹x
;

21 
	mch
;

22 
au¤c_»ad_h
 *
	mrh
;

23 *
	m¬g
;

24 
ušt32_t
 
	m§mpsz
;

28 
	$au¤c_de¡ruùÜ
(*
¬g
)

30 
au¤c_¡
 *
¡
 = 
¬g
;

32 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

33 
¡
->
rh
 = 
NULL
;

34 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

36 
	`AudioOuutUn™Stİ
(
¡
->
au
);

37 
	`AudioUn™Unš™Ÿlize
(
¡
->
au
);

38 
	`AudioCompÚ’tIn¡ªûDi¥o£
(
¡
->
au
);

40 
	`mem_d”ef
(
¡
->
£ss
);

42 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
mu‹x
);

43 
	}
}

46 
OSStus
 
	$šput_ÿÎback
(*
šRefCÚ
,

47 
AudioUn™R’d”AùiÚFÏgs
 *
ioAùiÚFÏgs
,

48 cÚ¡ 
AudioTimeSmp
 *
šTimeSmp
,

49 
UIÁ32
 
šBusNumb”
,

50 
UIÁ32
 
šNumb”F¿mes
,

51 
AudioBufãrLi¡
 *
ioD©a
)

53 
au¤c_¡
 *
¡
 = 
šRefCÚ
;

54 
AudioBufãrLi¡
 
abl
;

55 
OSStus
 
»t
;

56 
au¤c_»ad_h
 *
rh
;

57 *
¬g
;

59 ()
ioD©a
;

61 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

62 
rh
 = 
¡
->rh;

63 
¬g
 = 
¡
->arg;

64 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

66 ià(!
rh
)

69 
abl
.
mNumb”Bufãrs
 = 1;

70 
abl
.
mBufãrs
[0].
mNumb”ChªÃls
 = 
¡
->
ch
;

71 
abl
.
mBufãrs
[0].
mD©a
 = 
NULL
;

72 
abl
.
mBufãrs
[0].
mD©aBy‹Size
 = 
šNumb”F¿mes
 * 
¡
->
§mpsz
;

74 
»t
 = 
	`AudioUn™R’d”
(
¡
->
au
,

75 
ioAùiÚFÏgs
,

76 
šTimeSmp
,

77 
šBusNumb”
,

78 
šNumb”F¿mes
,

79 &
abl
);

80 ià(
»t
) {

81 
	`debug
("audioun™:„ecÜd: AudioUn™R’d”ƒ¼Ü (%d)\n", 
»t
);

82  
»t
;

85 
	`rh
(
abl
.
mBufãrs
[0].
mD©a
,

86 
abl
.
mBufãrs
[0].
mD©aBy‹Size
/
¡
->
§mpsz
, 
¬g
);

89 
	}
}

92 
	$š‹¼u±_hªdËr
(
boŞ
 
š‹¼u±ed
, *
¬g
)

94 
au¤c_¡
 *
¡
 = 
¬g
;

96 ià(
š‹¼u±ed
)

97 
	`AudioOuutUn™Stİ
(
¡
->
au
);

99 
	`AudioOuutUn™S¹
(
¡
->
au
);

100 
	}
}

103 
ušt32_t
 
	$aufmt_to_fÜm©æags
(
aufmt
 
fmt
)

105 
fmt
) {

107 
AUFMT_S16LE
:  
kLš—rPCMFÜm©FÏgIsSigÃdIÁeg”
;

108 
AUFMT_FLOAT
:  
kLš—rPCMFÜm©FÏgIsFlßt
;

111 
	}
}

114 
	$audioun™_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

115 
medŸ_ùx
 **
ùx
,

116 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

117 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

119 
AudioSŒ—mBasicDesütiÚ
 
fmt
;

120 
AudioUn™EËm’t
 
šputBus
 = 1;

121 
AUR’d”C®lbackSŒuù
 
cb
;

122 
au¤c_¡
 *
¡
;

123 
UIÁ32
 
’abË
 = 1;

124 #ià! 
TARGET_OS_IPHONE


125 
UIÁ32
 
ausize
 = (
AudioDeviûID
);

126 
AudioDeviûID
 
šputDeviû
;

127 
AudioObjeùPrİ”tyAdd»ss
 
auAdd»ss
 = {

128 
kAudioH¬dw¬ePrİ”tyDeçuÉIÅutDeviû
,

129 
kAudioObjeùPrİ”tyScİeGlob®
,

130 
kAudioObjeùPrİ”tyEËm’tMa¡”
 };

132 
Flßt64
 
hw_¤©e
 = 0.0;

133 
UIÁ32
 
hw_size
 = (
hw_¤©e
);

134 
OSStus
 
»t
 = 0;

135 
”r
;

137 ()
ùx
;

138 ()
deviû
;

139 ()
”rh
;

141 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

142 ià(!
¡
)

143  
ENOMEM
;

145 
¡
->
as
 =‡s;

146 
¡
->
rh
 =„h;

147 
¡
->
¬g
 =‡rg;

148 
¡
->
ch
 = 
´m
->ch;

150 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

151 ià(
”r
)

152 
out
;

154 
”r
 = 
	`audio£ss_®loc
(&
¡
->
£ss
, 
š‹¼u±_hªdËr
, st);

155 ià(
”r
)

156 
out
;

158 
»t
 = 
	`AudioCompÚ’tIn¡ªûNew
(
ouut_comp
, &
¡
->
au
);

159 ià(
»t
)

160 
out
;

162 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
, 
kAudioOuutUn™Prİ”ty_EÇbËIO
,

163 
kAudioUn™Scİe_IÅut
, 
šputBus
,

164 &
’abË
, (enable));

165 ià(
»t
)

166 
out
;

168 #ià! 
TARGET_OS_IPHONE


169 
’abË
 = 0;

170 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
, 
kAudioOuutUn™Prİ”ty_EÇbËIO
,

171 
kAudioUn™Scİe_Ouut
, 0,

172 &
’abË
, (enable));

173 ià(
»t
)

174 
out
;

176 
»t
 = 
	`AudioObjeùG‘Prİ”tyD©a
(
kAudioObjeùSy¡emObjeù
,

177 &
auAdd»ss
,

179 
NULL
,

180 &
ausize
,

181 &
šputDeviû
);

182 ià(
»t
)

183 
out
;

185 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
,

186 
kAudioOuutUn™Prİ”ty_Cu¼’tDeviû
,

187 
kAudioUn™Scİe_Glob®
,

189 &
šputDeviû
,

190 (
šputDeviû
));

191 ià(
»t
)

192 
out
;

195 
¡
->
§mpsz
 = (
ušt32_t
)
	`aufmt_§m¶e_size
(
´m
->
fmt
);

197 
fmt
.
mSam¶eR©e
 = 
´m
->
¤©e
;

198 
fmt
.
mFÜm©ID
 = 
kAudioFÜm©Lš—rPCM
;

199 #ià
TARGET_OS_IPHONE


200 
fmt
.
mFÜm©FÏgs
 = 
	`aufmt_to_fÜm©æags
(
´m
->fmt)

201 | 
kAudioFÜm©FÏgsN©iveEndŸn


202 | 
kAudioFÜm©FÏgIsPacked
;

204 
fmt
.
mFÜm©FÏgs
 = 
	`aufmt_to_fÜm©æags
(
´m
->fmt)

205 | 
kLš—rPCMFÜm©FÏgIsPacked
;

207 
fmt
.
mB™sP”ChªÃl
 = 8 * 
¡
->
§mpsz
;

208 
fmt
.
mChªÃlsP”F¿me
 = 
´m
->
ch
;

209 
fmt
.
mBy‹sP”F¿me
 = 
¡
->
§mpsz
 * 
´m
->
ch
;

210 
fmt
.
mF¿mesP”Pack‘
 = 1;

211 
fmt
.
mBy‹sP”Pack‘
 = 
¡
->
§mpsz
 * 
´m
->
ch
;

212 
fmt
.
mRe£rved
 = 0;

214 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
, 
kAudioUn™Prİ”ty_SŒ—mFÜm©
,

215 
kAudioUn™Scİe_Ouut
, 
šputBus
,

216 &
fmt
, (fmt));

217 ià(
»t
)

218 
out
;

221 
»t
 = 
	`AudioUn™In™Ÿlize
(
¡
->
au
);

222 ià(
»t
)

223 
out
;

225 
cb
.
šputProc
 = 
šput_ÿÎback
;

226 
cb
.
šputProcRefCÚ
 = 
¡
;

227 
»t
 = 
	`AudioUn™S‘Prİ”ty
(
¡
->
au
,

228 
kAudioOuutUn™Prİ”ty_S‘IÅutC®lback
,

229 
kAudioUn™Scİe_Glob®
, 
šputBus
,

230 &
cb
, (cb));

231 ià(
»t
)

232 
out
;

234 
»t
 = 
	`AudioOuutUn™S¹
(
¡
->
au
);

235 ià(
»t
)

236 
out
;

238 
»t
 = 
	`AudioUn™G‘Prİ”ty
(
¡
->
au
,

239 
kAudioUn™Prİ”ty_Sam¶eR©e
,

240 
kAudioUn™Scİe_IÅut
,

242 &
hw_¤©e
,

243 &
hw_size
);

244 ià(
»t
)

245 
out
;

247 
	`debug
("audiounit:„ecord hardware sample„ate is‚ow‡t %f Hz\n",

248 
hw_¤©e
);

250 
out
:

251 ià(
»t
) {

252 
	`w¬nšg
("audioun™:„ecÜd faed: %d (%c%c%c%c)\n", 
»t
,

253 
»t
>>24,„et>>16,„et>>8,„et);

254 
”r
 = 
ENODEV
;

257 ià(
”r
)

258 
	`mem_d”ef
(
¡
);

260 *
¡p
 = 
¡
;

262  
”r
;

263 
	}
}

	@baresip/modules/audiounit/sess.c

6 
	~<AudioUn™/AudioUn™.h
>

7 
	~<AudioToŞbox/AudioToŞbox.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"audioun™.h
"

13 
	saudio£ss
 {

14 
li¡
 
	m£s¦
;

18 
	saudio£ss_¡
 {

19 
audio£ss
 *
	mas
;

20 
Ë
 
	mË
;

21 
audio£ss_št_h
 *
	mšth
;

22 *
	m¬g
;

26 
audio£ss
 *
	ggas
;

29 #ià
TARGET_OS_IPHONE


30 
	$´İLi¡’”
(*
šCl›ÁD©a
, 
AudioSessiÚPrİ”tyID
 
šID
,

31 
UIÁ32
 
šD©aSize
, cÚ¡ *
šD©a
)

33 
audio£ss
 *
£ss
 = 
šCl›ÁD©a
;

34 
CFDiùiÚ¬yRef
 
d»f
 = 
šD©a
;

35 
CFNumb”Ref
 
Äef
;

36 
SIÁ32
 
»asÚ
 = 0;

38 ()
šD©aSize
;

39 ()
£ss
;

41 ià(
kAudioSessiÚPrİ”ty_AudioRou‹Chªge
 !ğ
šID
)

44 
Äef
 = 
	`CFDiùiÚ¬yG‘V®ue
(

45 
d»f
,

46 
	`CFSTR
(
kAudioSessiÚ_AudioRou‹ChªgeKey_R—sÚ
)

49 
	`CFNumb”G‘V®ue
(
Äef
, 
kCFNumb”SIÁ32Ty³
, &
»asÚ
);

51 
	`šfo
("audioun™: AudioRou‹Chªg-„—sÚ %d\n", 
»asÚ
);

52 
	}
}

56 
	$£ss_de¡ruùÜ
(*
¬g
)

58 
audio£ss_¡
 *
¡
 = 
¬g
;

60 
	`li¡_uÆšk
(&
¡
->
Ë
);

61 
	`mem_d”ef
(
¡
->
as
);

62 
	}
}

65 
	$de¡ruùÜ
(*
¬g
)

67 
audio£ss
 *
as
 = 
¬g
;

68 #ià
TARGET_OS_IPHONE


69 
AudioSessiÚPrİ”tyID
 
id
 = 
kAudioSessiÚPrİ”ty_AudioRou‹Chªge
;

71 
	`AudioSessiÚRemovePrİ”tyLi¡’”W™hU£rD©a
(
id
, 
´İLi¡’”
, 
as
);

72 
	`AudioSessiÚS‘Aùive
(
çl£
);

75 
	`li¡_æush
(&
as
->
£s¦
);

77 
gas
 = 
NULL
;

78 
	}
}

81 
	$audio£ss_®loc
(
audio£ss_¡
 **
¡p
,

82 
audio£ss_št_h
 *
šth
, *
¬g
)

84 
audio£ss_¡
 *
¡
 = 
NULL
;

85 
audio£ss
 *
as
 = 
NULL
;

86 
”r
 = 0;

87 
boŞ
 
ü—‹d
 = 
çl£
;

88 #ià
TARGET_OS_IPHONE


89 
AudioSessiÚPrİ”tyID
 
id
 = 
kAudioSessiÚPrİ”ty_AudioRou‹Chªge
;

90 
UIÁ32
 
ÿ‹gÜy
;

91 
OSStus
 
»t
;

94 ià(!
¡p
)

95  
EINVAL
;

97 #ià
TARGET_OS_IPHONE


99 
ÿ‹gÜy
 = 
kAudioSessiÚC©egÜy_PÏyAndRecÜd
;

100 
»t
 = 
	`AudioSessiÚS‘Prİ”ty
(
kAudioSessiÚPrİ”ty_AudioC©egÜy
,

101 (
ÿ‹gÜy
), &category);

102 ià(
»t
) {

103 
	`w¬nšg
("audioun™: AudiØC©egÜy: %d\n", 
»t
);

104  
EINVAL
;

108 ià(
gas
)

109 
make£ss
;

111 
as
 = 
	`mem_z®loc
((*as), 
de¡ruùÜ
);

112 ià(!
as
)

113  
ENOMEM
;

115 #ià
TARGET_OS_IPHONE


116 
»t
 = 
	`AudioSessiÚS‘Aùive
(
Œue
);

117 ià(
»t
) {

118 
	`w¬nšg
("audioun™: AudioSessiÚS‘Aùive: %d\n", 
»t
);

119 
”r
 = 
ENOSYS
;

120 
out
;

123 
»t
 = 
	`AudioSessiÚAddPrİ”tyLi¡’”
(
id
, 
´İLi¡’”
, 
as
);

124 ià(
»t
) {

125 
	`w¬nšg
("audiounit: AudioSessionAddPropertyListener: %d\n",

126 
»t
);

127 
”r
 = 
EINVAL
;

128 
out
;

132 
gas
 = 
as
;

133 
ü—‹d
 = 
Œue
;

135 
make£ss
:

136 
¡
 = 
	`mem_z®loc
((*¡), 
£ss_de¡ruùÜ
);

137 ià(!
¡
) {

138 
”r
 = 
ENOMEM
;

139 
out
;

141 
¡
->
šth
 = inth;

142 
¡
->
¬g
 =‡rg;

143 
¡
->
as
 = 
ü—‹d
 ? 
gas
 : 
	`mem_»f
(gas);

145 
	`li¡_­³nd
(&
gas
->
£s¦
, &
¡
->
Ë
, st);

147 
out
:

148 ià(
”r
) {

149 
	`mem_d”ef
(
as
);

150 
	`mem_d”ef
(
¡
);

153 *
¡p
 = 
¡
;

156  
”r
;

157 
	}
}

160 
	$audio£ss_š‹¼u±
(
boŞ
 
¡¬t
)

162 
Ë
 *le;

164 ià(!
gas
)

167 
Ë
 = 
gas
->
£s¦
.
h—d
;†e;†ğË->
Ãxt
) {

169 
audio£ss_¡
 *
¡
 = 
Ë
->
d©a
;

171 ià(
¡
->
šth
)

172 
¡
->
	`šth
(
¡¬t
, st->
¬g
);

174 
	}
}

	@baresip/modules/aufile/aufile.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

21 
	sau¤c_¡
 {

22 cÚ¡ 
au¤c
 *
	mas
;

23 
tmr
 
	mtmr
;

24 
aufe
 *
	maufe
;

25 
aubuf
 *
	maubuf
;

26 
ušt32_t
 
	m±ime
;

27 
size_t
 
	m§mpc
;

28 
boŞ
 
	mrun
;

29 
±h»ad_t
 
	mth»ad
;

30 
au¤c_»ad_h
 *
	mrh
;

31 
au¤c_”rÜ_h
 *
	m”rh
;

32 *
	m¬g
;

36 
au¤c
 *
	gau¤c
;

39 
	$de¡ruùÜ
(*
¬g
)

41 
au¤c_¡
 *
¡
 = 
¬g
;

43 ià(
¡
->
run
) {

44 
¡
->
run
 = 
çl£
;

45 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

48 
	`tmr_ÿnûl
(&
¡
->
tmr
);

50 
	`mem_d”ef
(
¡
->
aufe
);

51 
	`mem_d”ef
(
¡
->
aubuf
);

52 
	}
}

55 *
	$¶ay_th»ad
(*
¬g
)

57 
ušt64_t
 
now
, 
ts
 = 
	`tmr_jiff›s
();

58 
au¤c_¡
 *
¡
 = 
¬g
;

59 
št16_t
 *
§mpv
;

61 
§mpv
 = 
	`mem_®loc
(
¡
->
§mpc
 * 2, 
NULL
);

62 ià(!
§mpv
)

63  
NULL
;

65 
¡
->
run
) {

67 
	`sys_m¦“p
(4);

69 
now
 = 
	`tmr_jiff›s
();

71 ià(
ts
 > 
now
)

74 
	`aubuf_»ad_§mp
(
¡
->
aubuf
, 
§mpv
, st->
§mpc
);

76 
¡
->
	`rh
(
§mpv
, st->
§mpc
, st->
¬g
);

78 
ts
 +ğ
¡
->
±ime
;

81 
	`mem_d”ef
(
§mpv
);

83 
	`šfo
("aufile:…layerhreadƒxited\n");

85  
NULL
;

86 
	}
}

89 
	$timeout
(*
¬g
)

91 
au¤c_¡
 *
¡
 = 
¬g
;

93 
	`tmr_¡¬t
(&
¡
->
tmr
, 1000, 
timeout
, st);

96 ià(
	`aubuf_cur_size
(
¡
->
aubuf
è< (2 * st->
§mpc
)) {

98 
	`šfo
("aufile:ƒnd of file\n");

101 ià(
¡
->
”rh
)

102 
¡
->
	`”rh
(0, "’d oàfe", st->
¬g
);

104 
	}
}

107 
	$»ad_fe
(
au¤c_¡
 *
¡
)

109 
mbuf
 *
mb
;

110 
”r
;

113 
ušt16_t
 *
§mpv
;

114 
size_t
 
i
;

116 
mb
 = 
	`mbuf_®loc
(4096);

117 ià(!
mb
)

118  
ENOMEM
;

120 
mb
->
’d
 = mb->
size
;

122 
”r
 = 
	`aufe_»ad
(
¡
->
aufe
, 
mb
->
buf
, &mb->
’d
);

123 ià(
”r
)

126 ià(
mb
->
’d
 == 0) {

127 
	`šfo
("aufile:ƒnd of file\n");

132 
§mpv
 = (*)
mb
->
buf
;

133 
i
=0; i<
mb
->
’d
/2; i++) {

134 
§mpv
[
i
] = 
	`sys_Éohs
(sampv[i]);

137 
	`aubuf_­³nd
(
¡
->
aubuf
, 
mb
);

139 
mb
 = 
	`mem_d”ef
(mb);

142 
	`šfo
("aufe:†ßded %zu by‹s\n", 
	`aubuf_cur_size
(
¡
->
aubuf
));

144 
	`mem_d”ef
(
mb
);

145  
”r
;

146 
	}
}

149 
	$®loc_hªdËr
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

150 
medŸ_ùx
 **
ùx
,

151 
au¤c_´m
 *
´m
, cÚ¡ *
dev
,

152 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

154 
au¤c_¡
 *
¡
;

155 
aufe_´m
 
årm
;

156 
”r
;

157 ()
ùx
;

159 ià(!
¡p
 || !
as
 || !
´m
 || !
rh
)

160  
EINVAL
;

162 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

163 
	`w¬nšg
("aufile: unsupported sample format (%s)\n",

164 
	`aufmt_Çme
(
´m
->
fmt
));

165  
ENOTSUP
;

168 
	`šfo
("aufe:†ßdšg iÅuˆf'%s'\n", 
dev
);

170 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

171 ià(!
¡
)

172  
ENOMEM
;

174 
¡
->
as
 =‡s;

175 
¡
->
rh
 =„h;

176 
¡
->
”rh
 =ƒrrh;

177 
¡
->
¬g
 =‡rg;

179 
”r
 = 
	`aufe_İ’
(&
¡
->
aufe
, &
årm
, 
dev
, 
AUFILE_READ
);

180 ià(
”r
) {

181 
	`w¬nšg
("aufe: faedØİ’ f'%s' (%m)\n", 
dev
, 
”r
);

182 
out
;

185 
	`šfo
("aufile: %s: %u Hz, %d channels\n",

186 
dev
, 
årm
.
¤©e
, f´m.
chªÃls
);

188 ià(
årm
.
¤©e
 !ğ
´m
->srate) {

189 
	`w¬nšg
("aufile: input file (%s) must have sample-rate"

190 " %u Hz\n", 
dev
, 
´m
->
¤©e
);

191 
”r
 = 
ENODEV
;

192 
out
;

194 ià(
årm
.
chªÃls
 !ğ
´m
->
ch
) {

195 
	`w¬nšg
("aufile: input file (%s) must have channels = %d\n",

196 
dev
, 
´m
->
ch
);

197 
”r
 = 
ENODEV
;

198 
out
;

200 ià(
årm
.
fmt
 !ğ
AUFMT_S16LE
) {

201 
	`w¬nšg
("aufile: input file must have format S16LE\n");

202 
”r
 = 
ENODEV
;

203 
out
;

206 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

208 
¡
->
±ime
 = 
´m
->ptime;

210 
	`šfo
("aufile:‡udio…time=%u sampc=%zu‡ubuf=[%u:%u]\n",

211 
¡
->
±ime
, st->
§mpc
,

212 
´m
->
¤©e
 *…rm->
ch
 * 2,

213 
´m
->
¤©e
 *…rm->
ch
 * 40);

216 
”r
 = 
	`aubuf_®loc
(&
¡
->
aubuf
,

217 
´m
->
¤©e
 *…rm->
ch
 * 2,

219 ià(
”r
)

220 
out
;

222 
”r
 = 
	`»ad_fe
(
¡
);

223 ià(
”r
)

224 
out
;

226 
	`tmr_¡¬t
(&
¡
->
tmr
, 1000, 
timeout
, st);

228 
¡
->
run
 = 
Œue
;

229 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
¶ay_th»ad
, st);

230 ià(
”r
) {

231 
¡
->
run
 = 
çl£
;

232 
out
;

235 
out
:

236 ià(
”r
)

237 
	`mem_d”ef
(
¡
);

239 *
¡p
 = 
¡
;

241  
”r
;

242 
	}
}

245 
	$moduË_š™
()

247  
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

248 "aufe", 
®loc_hªdËr
);

249 
	}
}

252 
	$moduË_şo£
()

254 
au¤c
 = 
	`mem_d”ef
(ausrc);

257 
	}
}

260 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
aufe
) = {

263 
moduË_š™
,

264 
moduË_şo£


	@baresip/modules/auloop/auloop.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

30 
	#PTIME
 20

	)

34 
	saudio_loİ
 {

35 
ušt32_t
 
	mšdex
;

36 
aubuf
 *
	mab
;

37 
au¤c_¡
 *
	mau¤c
;

38 
au¶ay_¡
 *
	mau¶ay
;

39 cÚ¡ 
aucodec
 *
	mac
;

40 
au’c_¡©e
 *
	m’c
;

41 
audec_¡©e
 *
	mdec
;

42 
št16_t
 *
	m§mpv
;

43 
size_t
 
	m§mpc
;

44 
tmr
 
	mtmr
;

45 
ušt32_t
 
	m¤©e
;

46 
ušt32_t
 
	mch
;

47 
aufmt
 
	mfmt
;

49 
ušt32_t
 
	mn_»ad
;

50 
ušt32_t
 
	mn_wr™e
;

54 
ušt32_t
 
	m¤©e
;

55 
ušt32_t
 
	mch
;

56 } 
	gcÚfigv
[] = {

69 
audio_loİ
 *
	gg®
 = 
NULL
;

70 
	gaucodec
[64];

73 
	$auloİ_de¡ruùÜ
(*
¬g
)

75 
audio_loİ
 *
®
 = 
¬g
;

77 
	`tmr_ÿnûl
(&
®
->
tmr
);

78 
	`mem_d”ef
(
®
->
au¤c
);

79 
	`mem_d”ef
(
®
->
au¶ay
);

80 
	`mem_d”ef
(
®
->
§mpv
);

81 
	`mem_d”ef
(
®
->
ab
);

82 
	`mem_d”ef
(
®
->
’c
);

83 
	`mem_d”ef
(
®
->
dec
);

84 
	}
}

87 
	$´št_¡©s
(
audio_loİ
 *
®
)

89 
rw_¿tio
 = 0.0;

91 ià(
®
->
n_wr™e
)

92 
rw_¿tio
 = 1.0 * 
®
->
n_»ad
 /‡l->
n_wr™e
;

94 ()
	`»_årštf
(
¡dout
, "\r%uHz %dch %s "

96 
®
->
¤©e
,‡l->
ch
, 
	`aufmt_Çme
×l->
fmt
),

97 
®
->
n_»ad
,‡l->
n_wr™e
, 
rw_¿tio
);

99 ià(
	`¡r_is£t
(
aucodec
))

100 ()
	`»_årštf
(
¡dout
, " codec='%s'", 
aucodec
);

102 
	`fæush
(
¡dout
);

103 
	}
}

106 
	$tmr_hªdËr
(*
¬g
)

108 
audio_loİ
 *
®
 = 
¬g
;

110 
	`tmr_¡¬t
(&
®
->
tmr
, 100, 
tmr_hªdËr
,‡l);

111 
	`´št_¡©s
(
®
);

112 
	}
}

115 
	$codec_»ad
(
audio_loİ
 *
®
, 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

117 
ušt8_t
 
x
[2560];

118 
size_t
 
xËn
 = (
x
);

119 
”r
;

121 
	`aubuf_»ad_§mp
(
®
->
ab
,‡l->
§mpv
,‡l->
§mpc
);

123 
”r
 = 
®
->
ac
->
	`’ch
×l->
’c
, 
x
, &
xËn
,‡l->
§mpv
,‡l->
§mpc
);

124 ià(
”r
)

125 
out
;

127 ià(
®
->
ac
->
dech
) {

128 
”r
 = 
®
->
ac
->
	`dech
×l->
dec
, 
§mpv
, &
§mpc
, 
x
, 
xËn
);

129 ià(
”r
)

130 
out
;

133 
	`šfo
("auloop:‚o decode handler\n");

136 
out
:

138  
”r
;

139 
	}
}

142 
	$»ad_hªdËr
(cÚ¡ *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

144 
audio_loİ
 *
®
 = 
¬g
;

145 
size_t
 
num_by‹s
 = 
§mpc
 * 
	`aufmt_§m¶e_size
(
®
->
fmt
);

146 
”r
;

148 ++
®
->
n_»ad
;

150 
”r
 = 
	`aubuf_wr™e
(
®
->
ab
, 
§mpv
, 
num_by‹s
);

151 ià(
”r
) {

152 
	`w¬nšg
("auloİ:‡ubuf_wr™e: %m\n", 
”r
);

154 
	}
}

157 
	$wr™e_hªdËr
(*
§mpv
, 
size_t
 
§mpc
, *
¬g
)

159 
audio_loİ
 *
®
 = 
¬g
;

160 
size_t
 
num_by‹s
 = 
§mpc
 * 
	`aufmt_§m¶e_size
(
®
->
fmt
);

161 
”r
;

163 ++
®
->
n_wr™e
;

166 ià(
®
->
ac
) {

167 
”r
 = 
	`codec_»ad
(
®
, 
§mpv
, 
§mpc
);

168 ià(
”r
) {

169 
	`w¬nšg
("auloop: codec_readƒrror "

170 "Ú %zu sam¶e (%m)\n", 
§mpc
, 
”r
);

174 
	`aubuf_»ad
(
®
->
ab
, 
§mpv
, 
num_by‹s
);

176 
	}
}

179 
	$”rÜ_hªdËr
(
”r
, cÚ¡ *
¡r
, *
¬g
)

181 ()
¬g
;

182 
	`w¬nšg
("auloİ:‡u¤ø”rÜ: %m (%s)\n", 
”r
, 
¡r
);

183 
g®
 = 
	`mem_d”ef
(gal);

184 
	}
}

187 
	$¡¬t_codec
(
audio_loİ
 *
®
, cÚ¡ *
Çme
)

189 
au’c_·¿m
 
´m
 = {
PTIME
};

190 
”r
;

192 
®
->
ac
 = 
	`aucodec_fšd
(
	`b¬es_aucodeş
(), 
Çme
,

193 
cÚfigv
[
®
->
šdex
].
¤©e
,

194 
cÚfigv
[
®
->
šdex
].
ch
);

195 ià(!
®
->
ac
) {

196 
	`w¬nšg
("auloİ: could‚Ù fšd codec: %s\n", 
Çme
);

200 ià(
®
->
ac
->
’cupdh
) {

201 
”r
 = 
®
->
ac
->
	`’cupdh
(&®->
’c
,‡l->ac, &
´m
, 
NULL
);

202 ià(
”r
) {

203 
	`w¬nšg
("auloİ:ƒncod” upd©çed: %m\n", 
”r
);

207 ià(
®
->
ac
->
decupdh
) {

208 
”r
 = 
®
->
ac
->
	`decupdh
(&®->
dec
,‡l->ac, 
NULL
);

209 ià(
”r
) {

210 
	`w¬nšg
("auloİ: decod” upd©çed: %m\n", 
”r
);

213 
	}
}

216 
	$auloİ_»£t
(
audio_loİ
 *
®
)

218 
au¶ay_´m
‡uplay_prm;

219 
au¤c_´m
‡usrc_prm;

220 cÚ¡ 
cÚfig
 *
cfg
 = 
	`cÚf_cÚfig
();

221 
”r
;

223 ià(!
cfg
)

224  
ENOENT
;

226 ià(
cfg
->
audio
.
¤c_fmt
 !ğcfg->audio.
¶ay_fmt
) {

227 
	`w¬nšg
("auloop:‡usrc_format‡nd‡uplay_format"

229  
EINVAL
;

232 
®
->
fmt
 = 
cfg
->
audio
.
¤c_fmt
;

235 ià(
	`¡r_is£t
(
aucodec
)) {

236 ià(
cfg
->
audio
.
¤c_fmt
 !ğ
AUFMT_S16LE
) {

237 
	`w¬nšg
("auloop: only s16 supported with codec\n");

238  
EINVAL
;

241 
	`¡¬t_codec
(
®
, 
aucodec
);

245 
®
->
au¶ay
 = 
	`mem_d”ef
(al->auplay);

246 
®
->
au¤c
 = 
	`mem_d”ef
(al->ausrc);

248 
®
->
§mpv
 = 
	`mem_d”ef
(al->sampv);

249 
®
->
ab
 = 
	`mem_d”ef
(al->ab);

251 
®
->
¤©e
 = 
cÚfigv
[®->
šdex
].srate;

252 
®
->
ch
 = 
cÚfigv
[®->
šdex
].ch;

254 ià(
	`¡r_is£t
(
aucodec
)) {

255 
®
->
§mpc
 =‡l->
¤©e
 *‡l->
ch
 * 
PTIME
 / 1000;

256 
®
->
§mpv
 = 
	`mem_®loc
×l->
§mpc
 * 2, 
NULL
);

257 ià(!
®
->
§mpv
)

258  
ENOMEM
;

261 
	`šfo
("Audio-loİ: %uHz, %dch\n", 
®
->
¤©e
,‡l->
ch
);

263 
”r
 = 
	`aubuf_®loc
(&
®
->
ab
, 320, 0);

264 ià(
”r
)

265  
”r
;

267 
au¶ay_´m
.
¤©e
 = 
®
->srate;

268 
au¶ay_´m
.
ch
 = 
®
->ch;

269 
au¶ay_´m
.
±ime
 = 
PTIME
;

270 
au¶ay_´m
.
fmt
 = 
®
->fmt;

271 
”r
 = 
	`au¶ay_®loc
(&
®
->
au¶ay
, 
	`b¬es_au¶ayl
(),

272 
cfg
->
audio
.
¶ay_mod
, &
au¶ay_´m
,

273 
cfg
->
audio
.
¶ay_dev
, 
wr™e_hªdËr
, 
®
);

274 ià(
”r
) {

275 
	`w¬nšg
("auloop:‡uplay %s,%s failed: %m\n",

276 
cfg
->
audio
.
¶ay_mod
, cfg->audio.
¶ay_dev
,

277 
”r
);

278  
”r
;

281 
au¤c_´m
.
¤©e
 = 
®
->srate;

282 
au¤c_´m
.
ch
 = 
®
->ch;

283 
au¤c_´m
.
±ime
 = 
PTIME
;

284 
au¤c_´m
.
fmt
 = 
®
->fmt;

285 
”r
 = 
	`au¤c_®loc
(&
®
->
au¤c
, 
	`b¬es_au¤ş
(),

286 
NULL
, 
cfg
->
audio
.
¤c_mod
,

287 &
au¤c_´m
, 
cfg
->
audio
.
¤c_dev
,

288 
»ad_hªdËr
, 
”rÜ_hªdËr
, 
®
);

289 ià(
”r
) {

290 
	`w¬nšg
("auloİ:‡u¤ø%s,% çed: %m\n", 
cfg
->
audio
.
¤c_mod
,

291 
cfg
->
audio
.
¤c_dev
, 
”r
);

292  
”r
;

295  
”r
;

296 
	}
}

299 
	$audio_loİ_®loc
(
audio_loİ
 **
®p
)

301 
audio_loİ
 *
®
;

302 
”r
;

304 
®
 = 
	`mem_z®loc
((*®), 
auloİ_de¡ruùÜ
);

305 ià(!
®
)

306  
ENOMEM
;

308 
	`tmr_¡¬t
(&
®
->
tmr
, 100, 
tmr_hªdËr
,‡l);

310 
”r
 = 
	`auloİ_»£t
(
®
);

311 ià(
”r
)

312 
out
;

314 
out
:

315 ià(
”r
)

316 
	`mem_d”ef
(
®
);

318 *
®p
 = 
®
;

320  
”r
;

321 
	}
}

324 
	$audio_loİ_cyşe
(
audio_loİ
 *
®
)

326 
”r
;

328 ++
®
->
šdex
;

330 ià(
®
->
šdex
 >ğ
	`ARRAY_SIZE
(
cÚfigv
)) {

331 
g®
 = 
	`mem_d”ef
(gal);

332 
	`šfo
("\nAudio-loop stopped\n");

336 
”r
 = 
	`auloİ_»£t
(
®
);

337 ià(
”r
)

338  
”r
;

340 
	`šfo
("\nAudio-loİ s¹ed: %uHz, %dch\n", 
®
->
¤©e
,‡l->
ch
);

343 
	}
}

349 
	$auloİ_¡¬t
(
»_´štf
 *
pf
, *
¬g
)

351 
”r
;

353 ()
pf
;

354 ()
¬g
;

356 ià(
g®
) {

357 
”r
 = 
	`audio_loİ_cyşe
(
g®
);

358 ià(
”r
) {

359 
	`w¬nšg
("auloİ:†oİ cyşe: %m\n", 
”r
);

363 
”r
 = 
	`audio_loİ_®loc
(&
g®
);

364 ià(
”r
) {

365 
	`w¬nšg
("auloİ:‡Îoøçed %m\n", 
”r
);

369  
”r
;

370 
	}
}

373 
	$auloİ_¡İ
(
»_´štf
 *
pf
, *
¬g
)

375 ()
¬g
;

377 ià(
g®
) {

378 ()
	`»_h´štf
(
pf
, "audio-loop stopped\n");

379 
g®
 = 
	`mem_d”ef
(gal);

383 
	}
}

386 cÚ¡ 
cmd
 
	gcmdv
[] = {

387 {"auloİ", 0, 0, "S¹‡udio-loİ", 
auloİ_¡¬t
 },

388 {"auloİ_¡İ", 0, 0, "Stİ‡udio-loİ", 
auloİ_¡İ
 },

392 
	$moduË_š™
()

394 
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "auloİ_codec", 
aucodec
, (aucodec));

396  
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

397 
	}
}

400 
	$moduË_şo£
()

402 
	`auloİ_¡İ
(
NULL
, NULL);

403 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

405 
	}
}

408 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
auloİ
) = {

411 
moduË_š™
,

412 
moduË_şo£
,

	@baresip/modules/av1/av1.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"av1.h
"

21 
vidcodec
 
	gav1
 = {

22 .
Çme
 = "AV1",

23 .
	g’cupdh
 = 
av1_’code_upd©e
,

24 .
	g’ch
 = 
av1_’code
,

25 .
	gdecupdh
 = 
av1_decode_upd©e
,

26 .
	gdech
 = 
av1_decode
,

30 
	$moduË_š™
()

32 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
av1
);

35 
	}
}

38 
	$moduË_şo£
()

40 
	`vidcodec_uÄegi¡”
(&
av1
);

43 
	}
}

46 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
av1
) = {

49 
moduË_š™
,

50 
moduË_şo£


	@baresip/modules/av1/av1.h

9 
av1_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

10 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

11 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

12 
av1_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

13 cÚ¡ 
vidäame
 *
äame
);

17 
av1_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

18 cÚ¡ *
fm
);

19 
av1_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

20 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
);

	@baresip/modules/av1/decode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<aom/aom.h
>

12 
	~<aom/aom_decod”.h
>

13 
	~<aom/aomdx.h
>

14 
	~"av1.h
"

18 
	mDECODE_MAXSZ
 = 524288,

23 
	shdr
 {

24 
	mx
:1;

25 
	mnÜef
:1;

26 
	m¡¬t
:1;

27 
	m·¹id
:4;

29 
	mi
:1;

30 
	ml
:1;

31 
	mt
:1;

32 
	mk
:1;

33 
ušt16_t
 
	mpicid
;

34 
ušt8_t
 
	m0picidx
;

35 
	mtid
:2;

36 
	my
:1;

37 
	mkeyidx
:5;

40 
	sviddec_¡©e
 {

41 
aom_codec_ùx_t
 
	mùx
;

42 
mbuf
 *
	mmb
;

43 
boŞ
 
	mùxup
;

44 
boŞ
 
	m¡¬‹d
;

45 
ušt16_t
 
	m£q
;

49 
	$de¡ruùÜ
(*
¬g
)

51 
viddec_¡©e
 *
vds
 = 
¬g
;

53 ià(
vds
->
ùxup
)

54 
	`aom_codec_de¡roy
(&
vds
->
ùx
);

56 
	`mem_d”ef
(
vds
->
mb
);

57 
	}
}

60 
	$av1_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

61 cÚ¡ *
fm
)

63 
viddec_¡©e
 *
vds
;

64 
aom_codec_”r_t
 
»s
;

65 
”r
 = 0;

66 ()
vc
;

67 ()
fm
;

69 ià(!
vd¥
)

70  
EINVAL
;

72 
vds
 = *
vd¥
;

74 ià(
vds
)

77 
vds
 = 
	`mem_z®loc
((*vds), 
de¡ruùÜ
);

78 ià(!
vds
)

79  
ENOMEM
;

81 
vds
->
mb
 = 
	`mbuf_®loc
(1024);

82 ià(!
vds
->
mb
) {

83 
”r
 = 
ENOMEM
;

84 
out
;

87 
»s
 = 
	`aom_codec_dec_š™
(&
vds
->
ùx
, &
aom_codec_av1_dx_®go
, 
NULL
, 0);

88 ià(
»s
) {

89 
”r
 = 
ENOMEM
;

90 
out
;

93 
vds
->
ùxup
 = 
Œue
;

95 
out
:

96 ià(
”r
)

97 
	`mem_d”ef
(
vds
);

99 *
vd¥
 = 
vds
;

101  
”r
;

102 
	}
}

105 
šlše
 
	$hdr_decode
(
hdr
 *hdr, 
mbuf
 *
mb
)

107 
ušt8_t
 
v
;

109 
	`mem£t
(
hdr
, 0, (*hdr));

111 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

112  
EBADMSG
;

114 
v
 = 
	`mbuf_»ad_u8
(
mb
);

116 
hdr
->
x
 = 
v
>>7 & 0x1;

117 
hdr
->
nÜef
 = 
v
>>5 & 0x1;

118 
hdr
->
¡¬t
 = 
v
>>4 & 0x1;

119 
hdr
->
·¹id
 = 
v
 & 0x07;

121 ià(
hdr
->
x
) {

123 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

124  
EBADMSG
;

126 
v
 = 
	`mbuf_»ad_u8
(
mb
);

128 
hdr
->
i
 = 
v
>>7 & 0x1;

129 
hdr
->
l
 = 
v
>>6 & 0x1;

130 
hdr
->
t
 = 
v
>>5 & 0x1;

131 
hdr
->
k
 = 
v
>>4 & 0x1;

134 ià(
hdr
->
i
) {

136 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

137  
EBADMSG
;

139 
v
 = 
	`mbuf_»ad_u8
(
mb
);

141 ià(
v
>>7 & 0x1) {

143 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

144  
EBADMSG
;

146 
hdr
->
picid
 = (
v
 & 0x7f)<<8;

147 
hdr
->
picid
 +ğ
	`mbuf_»ad_u8
(
mb
);

150 
hdr
->
picid
 = 
v
 & 0x7f;

154 ià(
hdr
->
l
) {

156 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

157  
EBADMSG
;

159 
hdr
->
0picidx
 = 
	`mbuf_»ad_u8
(
mb
);

162 ià(
hdr
->
t
 || hdr->
k
) {

164 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

165  
EBADMSG
;

167 
v
 = 
	`mbuf_»ad_u8
(
mb
);

169 
hdr
->
tid
 = 
v
>>6 & 0x3;

170 
hdr
->
y
 = 
v
>>5 & 0x1;

171 
hdr
->
keyidx
 = 
v
 & 0x1f;

175 
	}
}

179 
šlše
 
boŞ
 
	$is_keyäame
(
mbuf
 *
mb
)

181 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

182  
çl£
;

184 ià(
mb
->
buf
[mb->
pos
] & 0x01)

185  
çl£
;

187  
Œue
;

188 
	}
}

191 
šlše
 
št16_t
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

193  (
št16_t
)(
y
 - 
x
);

194 
	}
}

197 
	$av1_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

198 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

200 
aom_codec_™”_t
 
™”
 = 
NULL
;

201 
aom_codec_”r_t
 
»s
;

202 
aom_image_t
 *
img
;

203 
hdr
 hdr;

204 
”r
, 
i
;

206 ià(!
vds
 || !
äame
 || !
šŒa
 || !
mb
)

207  
EINVAL
;

209 *
šŒa
 = 
çl£
;

211 
”r
 = 
	`hdr_decode
(&
hdr
, 
mb
);

212 ià(
”r
)

213  
”r
;

216 
	`debug
("av1: header: x=%u‚oref=%u start=%u…artid=%u "

219 
hdr
.
x
, hdr.
nÜef
, hdr.
¡¬t
, hdr.
·¹id
,

220 
hdr
.
i
, hdr.
l
, hdr.
t
, hdr.
k
,

221 
hdr
.
picid
, hdr.
0picidx
, hdr.
tid
, hdr.
y
, hdr.
keyidx
);

224 ià(
hdr
.
¡¬t
 && hdr.
·¹id
 == 0) {

226 ià(
	`is_keyäame
(
mb
))

227 *
šŒa
 = 
Œue
;

229 
	`mbuf_»wšd
(
vds
->
mb
);

230 
vds
->
¡¬‹d
 = 
Œue
;

233 ià(!
vds
->
¡¬‹d
)

236 ià(
	`£q_diff
(
vds
->
£q
, seq) != 1) {

237 
	`mbuf_»wšd
(
vds
->
mb
);

238 
vds
->
¡¬‹d
 = 
çl£
;

243 
vds
->
£q
 = seq;

245 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
	`mbuf_buf
(mb), 
	`mbuf_g‘_Ëá
(mb));

246 ià(
”r
)

247 
out
;

249 ià(!
m¬k”
) {

251 ià(
vds
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

252 
	`w¬nšg
("av1: decode buffer sizeƒxceeded\n");

253 
”r
 = 
ENOMEM
;

254 
out
;

260 
»s
 = 
	`aom_codec_decode
(&
vds
->
ùx
, vds->
mb
->
buf
,

261 ()
vds
->
mb
->
’d
, 
NULL
, 1);

262 ià(
»s
) {

263 
	`debug
("av1: decod”rÜ: %s\n", 
	`aom_codec_”r_to_¡ršg
(
»s
));

264 
”r
 = 
EPROTO
;

265 
out
;

268 
img
 = 
	`aom_codec_g‘_äame
(&
vds
->
ùx
, &
™”
);

269 ià(!
img
) {

270 
	`debug
("av1:‚o…icture\n");

271 
out
;

274 ià(
img
->
fmt
 !ğ
AOM_IMG_FMT_I420
) {

275 
	`w¬nšg
("av1: bad…ix– fÜm© (%i)\n", 
img
->
fmt
);

276 
out
;

279 
i
=0; i<4; i++) {

280 
äame
->
d©a
[
i
] = 
img
->
¶ªes
[i];

281 
äame
->
lšesize
[
i
] = 
img
->
¡ride
[i];

284 
äame
->
size
.
w
 = 
img
->
d_w
;

285 
äame
->
size
.
h
 = 
img
->
d_h
;

286 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

288 
out
:

289 
	`mbuf_»wšd
(
vds
->
mb
);

290 
vds
->
¡¬‹d
 = 
çl£
;

292  
”r
;

293 
	}
}

	@baresip/modules/av1/encode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<aom/aom.h
>

12 
	~<aom/aom_’cod”.h
>

13 
	~<aom/aomcx.h
>

14 
	~"av1.h
"

18 
	mHDR_SIZE
 = 4,

22 
	svid’c_¡©e
 {

23 
aom_codec_ùx_t
 
	mùx
;

24 
vidsz
 
	msize
;

25 
aom_codec_±s_t
 
	m±s
;

26 
	mås
;

27 
	mb™¿‹
;

28 
	mpktsize
;

29 
boŞ
 
	mùxup
;

30 
ušt16_t
 
	mpicid
;

31 
vid’c_·ck‘_h
 *
	mpkth
;

32 *
	m¬g
;

36 
	$de¡ruùÜ
(*
¬g
)

38 
vid’c_¡©e
 *
ves
 = 
¬g
;

40 ià(
ves
->
ùxup
)

41 
	`aom_codec_de¡roy
(&
ves
->
ùx
);

42 
	}
}

45 
	$av1_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

46 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

47 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

49 
vid’c_¡©e
 *
ves
;

51 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < (
HDR_SIZE
 + 1))

52  
EINVAL
;

54 
ves
 = *
ve¥
;

56 ià(!
ves
) {

58 
ves
 = 
	`mem_z®loc
((*ves), 
de¡ruùÜ
);

59 ià(!
ves
)

60  
ENOMEM
;

62 
ves
->
picid
 = 
	`¿nd_u16
();

64 *
ve¥
 = 
ves
;

67 ià(
ves
->
ùxup
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

68 
ves
->
ås
 !ğ
´m
->fps)) {

70 
	`aom_codec_de¡roy
(&
ves
->
ùx
);

71 
ves
->
ùxup
 = 
çl£
;

75 
ves
->
b™¿‹
 = 
´m
->bitrate;

76 
ves
->
pktsize
 = 
´m
->pktsize;

77 
ves
->
ås
 = 
´m
->fps;

78 
ves
->
pkth
 =…kth;

79 
ves
->
¬g
 =‡rg;

82 
	}
}

85 
	$İ’_’cod”
(
vid’c_¡©e
 *
ves
, cÚ¡ 
vidsz
 *
size
)

87 
aom_codec_’c_cfg_t
 
cfg
;

88 
aom_codec_”r_t
 
»s
;

90 
»s
 = 
	`aom_codec_’c_cÚfig_deçuÉ
(&
aom_codec_av1_cx_®go
, &
cfg
, 0);

91 ià(
»s
)

92  
EPROTO
;

94 
cfg
.
g_w
 = 
size
->
w
;

95 
cfg
.
g_h
 = 
size
->
h
;

96 
cfg
.
g_timeba£
.
num
 = 1;

97 
cfg
.
g_timeba£
.
d’
 = 
ves
->
ås
;

98 
cfg
.
g_”rÜ_»s›Á
 = 
AOM_ERROR_RESILIENT_DEFAULT
;

99 
cfg
.
g_·ss
 = 
AOM_RC_ONE_PASS
;

100 
cfg
.
g_Ïg_š_äames
 = 0;

101 
cfg
.
rc_’d_u§ge
 = 
AOM_VBR
;

102 
cfg
.
rc_rg‘_b™¿‹
 = 
ves
->
b™¿‹
;

103 
cfg
.
kf_mode
 = 
AOM_KF_AUTO
;

105 ià(
ves
->
ùxup
) {

106 
	`debug
("av1:„e-openingƒncoder\n");

107 
	`aom_codec_de¡roy
(&
ves
->
ùx
);

108 
ves
->
ùxup
 = 
çl£
;

111 
»s
 = 
	`aom_codec_’c_š™
(&
ves
->
ùx
, &
aom_codec_av1_cx_®go
, &
cfg
,

113 ià(
»s
) {

114 
	`w¬nšg
("av1:ƒnøš™: %s\n", 
	`aom_codec_”r_to_¡ršg
(
»s
));

115  
EPROTO
;

118 
ves
->
ùxup
 = 
Œue
;

120 
»s
 = 
	`aom_codec_cÚŒŞ
(&
ves
->
ùx
, 
AOME_SET_CPUUSED
, 8);

121 ià(
»s
) {

122 
	`w¬nšg
("av1: codec ctrl C: %s\n",

123 
	`aom_codec_”r_to_¡ršg
(
»s
));

127 
	}
}

130 
šlše
 
	$hdr_’code
(
ušt8_t
 
hdr
[
HDR_SIZE
], 
boŞ
 
nÜef
, boŞ 
¡¬t
,

131 
ušt8_t
 
·¹id
, 
ušt16_t
 
picid
)

133 
hdr
[0] = 1<<7 | 
nÜef
<<5 | 
¡¬t
<<4 | (
·¹id
 & 0x7);

134 
hdr
[1] = 1<<7;

135 
hdr
[2] = 1<<7 | (
picid
>>8 & 0x7f);

136 
hdr
[3] = 
picid
 & 0xff;

137 
	}
}

140 
šlše
 
	$·ck‘ize
(
boŞ
 
m¬k”
, 
ušt32_t
 
¹p_ts
,

141 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

142 
size_t
 
maxËn
, 
boŞ
 
nÜef
, 
ušt8_t
 
·¹id
,

143 
ušt16_t
 
picid
, 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

145 
ušt8_t
 
hdr
[
HDR_SIZE
];

146 
boŞ
 
¡¬t
 = 
Œue
;

147 
”r
 = 0;

149 
maxËn
 -ğ(
hdr
);

151 
Ën
 > 
maxËn
) {

153 
	`hdr_’code
(
hdr
, 
nÜef
, 
¡¬t
, 
·¹id
, 
picid
);

155 
”r
 |ğ
	`pkth
(
çl£
, 
¹p_ts
, 
hdr
, (hdr), 
buf
, 
maxËn
, 
¬g
);

157 
buf
 +ğ
maxËn
;

158 
Ën
 -ğ
maxËn
;

159 
¡¬t
 = 
çl£
;

162 
	`hdr_’code
(
hdr
, 
nÜef
, 
¡¬t
, 
·¹id
, 
picid
);

164 
”r
 |ğ
	`pkth
(
m¬k”
, 
¹p_ts
, 
hdr
, (hdr), 
buf
, 
Ën
, 
¬g
);

166  
”r
;

167 
	}
}

170 
	$av1_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

171 cÚ¡ 
vidäame
 *
äame
)

173 
aom_’c_äame_æags_t
 
æags
 = 0;

174 
aom_codec_™”_t
 
™”
 = 
NULL
;

175 
aom_codec_”r_t
 
»s
;

176 
aom_image_t
 *
img
;

177 
aom_img_fmt_t
 
img_fmt
;

178 
”r
 = 0, 
i
;

180 ià(!
ves
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

181  
EINVAL
;

183 ià(!
ves
->
ùxup
 || !
	`vidsz_cmp
(&ves->
size
, &
äame
->size)) {

185 
”r
 = 
	`İ’_’cod”
(
ves
, &
äame
->
size
);

186 ià(
”r
)

187  
”r
;

189 
ves
->
size
 = 
äame
->size;

192 ià(
upd©e
) {

194 
æags
 |ğ
AOM_EFLAG_FORCE_KF
;

197 
img_fmt
 = 
AOM_IMG_FMT_I420
;

199 
img
 = 
	`aom_img_w¿p
(
NULL
, 
img_fmt
, 
äame
->
size
.
w
, f¿me->size.
h
,

200 16, 
NULL
);

201 ià(!
img
) {

202 
	`w¬nšg
("vp9:ƒncoder: could‚ot‡llocate image\n");

203 
”r
 = 
ENOMEM
;

204 
out
;

207 
i
=0; i<4; i++) {

208 
img
->
¡ride
[
i
] = 
äame
->
lšesize
[i];

209 
img
->
¶ªes
[
i
] = 
äame
->
d©a
[i];

212 
»s
 = 
	`aom_codec_’code
(&
ves
->
ùx
, 
img
, ves->
±s
++, 1,

213 
æags
, 
AOM_DL_REALTIME
);

214 ià(
»s
) {

215 
	`w¬nšg
("av1:ƒnø”rÜ: %s\n", 
	`aom_codec_”r_to_¡ršg
(
»s
));

216  
ENOMEM
;

219 ++
ves
->
picid
;

222 
boŞ
 
keyäame
 = 
çl£
, 
m¬k”
 = 
Œue
;

223 cÚ¡ 
aom_codec_cx_pkt_t
 *
pkt
;

224 
ušt8_t
 
·¹id
 = 0;

225 
ušt32_t
 
ts
;

227 
pkt
 = 
	`aom_codec_g‘_cx_d©a
(&
ves
->
ùx
, &
™”
);

228 ià(!
pkt
)

231 ià(
pkt
->
kšd
 !ğ
AOM_CODEC_CX_FRAME_PKT
)

234 ià(
pkt
->
d©a
.
äame
.
æags
 & 
AOM_FRAME_IS_KEY
)

235 
keyäame
 = 
Œue
;

237 ià(
pkt
->
d©a
.
äame
.
æags
 & 
AOM_FRAME_IS_FRAGMENT
)

238 
m¬k”
 = 
çl£
;

240 ià(
pkt
->
d©a
.
äame
.
·¹™iÚ_id
 >= 0)

241 
·¹id
 = 
pkt
->
d©a
.
äame
.
·¹™iÚ_id
;

243 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pkt
->
d©a
.
äame
.
±s
, 
ves
->
ås
);

245 
”r
 = 
	`·ck‘ize
(
m¬k”
, 
ts
,

246 
pkt
->
d©a
.
äame
.
buf
,

247 
pkt
->
d©a
.
äame
.
sz
,

248 
ves
->
pktsize
, !
keyäame
, 
·¹id
, ves->
picid
,

249 
ves
->
pkth
, ves->
¬g
);

250 ià(
”r
)

251  
”r
;

254 
out
:

255 ià(
img
)

256 
	`aom_img_ä“
(
img
);

258  
”r
;

259 
	}
}

	@baresip/modules/avahi/avahi.c

20 
	~<».h
>

21 
	~<b¬es.h
>

22 
	~<¡dlib.h
>

23 
	~<¡dio.h
>

24 
	~<¡ršg.h
>

26 
	~<avahi-commÚ/sim¶e-w©ch.h
>

27 
	~<avahi-ş›Á/lookup.h
>

28 
	~<avahi-ş›Á/publish.h
>

29 
	~<avahi-commÚ/”rÜ.h
>

32 
	~<Ãt/if.h
>

35 
	#__USE_XOPEN2K


	)

36 
	~<uni¡d.h
>

37 
	~<Ãtdb.h
>

40 
	savahi_¡
 {

41 
AvahiSim¶ePŞl
* 
	mpŞl
;

42 
AvahiCl›Á
* 
	mş›Á
;

43 
AvahiEÁryGroup
* 
	mgroup
;

44 
AvahiS”viûBrow£r
* 
	mbrow£r
;

45 
ua
* 
	mloÿl_ua
;

46 
tmr
 
	mpŞl_tim”
;

49 
avahi_¡
* 
	gavahi
 = 
NULL
;

52 
	$group_ÿÎback
(
AvahiEÁryGroup
* 
group
,

53 
AvahiEÁryGroupS‹
 
¡©e
, * 
u£rd©a
)

55 ()
group
;

56 ()
u£rd©a
;

58 
¡©e
) {

60 
AVAHI_ENTRY_GROUP_ESTABLISHED
:

61 
	`šfo
 ("avahi: Service Registration completed\n");

63 
AVAHI_ENTRY_GROUP_FAILURE
:

64 
AVAHI_ENTRY_GROUP_COLLISION
:

65 
	`w¬nšg
("avahi: Service Registration failed\n");

68 
AVAHI_ENTRY_GROUP_UNCOMMITED
:

69 
AVAHI_ENTRY_GROUP_REGISTERING
:

73 
	}
}

76 
	$ü—‹_£rviûs
(
AvahiCl›Á
 *
ş›Á
)

78 
”r
;

79 
buf
[128] = "";

80 
ho¡Çme
[128] = "";

82 
if_idx
 = 
AVAHI_IF_UNSPEC
;

83 
af
 = 
AVAHI_PROTO_INET
;

85 
§
 
Ïddr
;

88 
	`¡ºıy
(
ho¡Çme
, 
	`avahi_ş›Á_g‘_ho¡_Çme_fqdn
(
ş›Á
),

89  (
ho¡Çme
));

90 
	`»_¢´štf
(
buf
, (buf), "<sip:%s@%s>;regint=0",

91 
	`sys_u£ºame
(),

92 
ho¡Çme
);

94 
	`šfo
("avahi: C»©šg†oÿÈUA %s\n", 
buf
);

95 
”r
 = 
	`ua_®loc
(&
avahi
->
loÿl_ua
, 
buf
);

97 ià(
”r
) {

98 
	`w¬nšg
("avahi: Could‚Ù c»©UA %s: %m\n", 
buf
, 
”r
);

102 
	`»_¢´štf
(
buf
, (buf), "sip:%s@%s",

103 
	`sys_u£ºame
(),

104 
ho¡Çme
);

106 
	`debug
("avahi: AÂouncšg URI: %s\n", 
buf
);

109 ià(
	`¡r_is£t
(
	`cÚf_cÚfig
()->
Ãt
.
iâame
)) {

110 
if_idx
 = 
	`if_Çm‘ošdex
(
	`cÚf_cÚfig
()->
Ãt
.
iâame
);

113 ià(
	`Ãt_af
(
	`b¬es_ÃtwÜk
()è=ğ
AF_INET6
) {

114 
af
 = 
AVAHI_PROTO_INET6
;

117 
”r
 |ğ
	`s_Œª¥_Ïddr
(
	`uag_s
(), &
Ïddr
, 
SIP_TRANSP_UDP
, 0);

118 ià(
”r
) {

119 
	`w¬nšg
("avahi: Can‚ot find†ocal SIP‡ddress\n");

123 
avahi
->
group
 = 
	`avahi_’Œy_group_Ãw
(
ş›Á
, 
group_ÿÎback
, 
NULL
);

124 
”r
 = 
	`avahi_’Œy_group_add_£rviû
(
avahi
->
group
,

125 
if_idx
, 
af
, 0,

126 
buf
, "_sipuri._udp",

127 
NULL
, NULL,

128 
	`Áohs
(
Ïddr
.
u
.
š
.
sš_pÜt
), 
NULL
);

129 
”r
 |ğ
	`avahi_’Œy_group_comm™
(
avahi
->
group
);

131 ià(
”r
) {

132 
	`w¬nšg
("avahi: Error in„egistering service");

134 
	}
}

137 
	$ş›Á_ÿÎback
(
AvahiCl›Á
 *
c
, 
AvahiCl›ÁS‹
 
¡©e
,

138 
AVAHI_GCC_UNUSED
 * 
u£rd©a
)

140 ()
c
;

142 
¡©e
) {

144 
AVAHI_CLIENT_S_RUNNING
:

145 
	`šfo
("avahi: Avah˜D«mÚ„uÂšg\n", 
¡©e
);

148 
	`w¬nšg
("avahi: unknowÀş›Á_ÿÎback: %d\n", 
¡©e
);

151 
	}
}

154 
	$add_cÚù
(cÚ¡ * 
uri
,

155 cÚ¡ 
AvahiAdd»ss
 *
add»ss
, 
ušt16_t
 
pÜt
)

157 
”r
;

158 
¶
 
addr
;

159 
buf
[128];

160 
cÚù
 *
c
;

161 
§
 sa;

162 
s_addr
 
saddr
;

165 
	`¶_£t_¡r
(&
addr
, 
uri
);

166 ià(
	`s_addr_decode
(&
saddr
, &
addr
)) {

167 
	`w¬nšg
("avahi: could‚Ù decodsur˜%s\n", 
uri
);

171 ià(
add»ss
->
´Ùo
 =ğ
AVAHI_PROTO_INET6
) {;

172 
	`§_£t_š6
(&
§
, 
add»ss
->
d©a
.
v6
.add»ss, 
pÜt
);

175 
	`§_£t_š
(&
§
, 
	`htÚl
(
add»ss
->
d©a
.
v4
.add»ss), 
pÜt
);

178 
	`»_¢´štf
(
buf
, (buf),

180 &
saddr
.
uri
.
u£r
, &saddr.uri.
ho¡
,

181 &
saddr
.
uri
.
u£r
, &
§
);

182 
	`¶_£t_¡r
(&
addr
, 
buf
);

184 
”r
 = 
	`cÚù_add
(
	`b¬es_cÚùs
(), &
c
, &
addr
);

185 ià(
”r
) {

186 
	`w¬nšg
("Could‚Ù‡dd cÚù %s: %m\n", 
buf
, 
”r
);

188 
	}
}

191 
	$»move_cÚù_by_dÇme
(cÚ¡ * 
dÇme
)

193 cÚ¡ 
li¡
 *
l¡
;

194 
Ë
 *le;

197 ià(0 !ğ
	`»_»gex
(
dÇme
, 
	`¡r_Ën
(dname), "^sip:")) {

198 
dÇme
 += 4;

201 
l¡
 = 
	`cÚù_li¡
(
	`b¬es_cÚùs
());

203 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

204 
cÚù
 *
c
 = 
Ë
->
d©a
;

205 cÚ¡ 
s_addr
* 
addr
 = 
	`cÚù_addr
(
c
);

207 ià(
	`¶_¡rcmp
(&
addr
->
dÇme
, dname) == 0) {

208 
	`cÚù_»move
(
	`b¬es_cÚùs
(), 
c
);

213 
	`w¬nšg
("avahi: Could‚Ù„emovcÚù %s\n", 
dÇme
);

214 
	}
}

217 
	$»sŞve_ÿÎback
(

218 
AvahiS”viûResŞv”
 *
r
,

219 
AvahiIfIndex
 
š‹rçû
,

220 
AvahiPrÙocŞ
 
´ÙocŞ
,

221 
AvahiResŞv”Ev’t
 
ev’t
,

222 cÚ¡ *
Çme
,

223 cÚ¡ *
ty³
,

224 cÚ¡ *
domaš
,

225 cÚ¡ *
ho¡Çme
,

226 cÚ¡ 
AvahiAdd»ss
 *
add»ss
,

227 
ušt16_t
 
pÜt
,

228 
AvahiSŒšgLi¡
 *
txt
,

229 
AvahiLookupResuÉFÏgs
 
æags
,

230 *
u£rd©a
)

232 ()
r
;

233 ()
š‹rçû
;

234 ()
txt
;

235 ()
u£rd©a
;

237 
	`šfo
("avahi:„esŞv% % % %s\n", 
Çme
, 
ty³
, 
domaš
, 
ho¡Çme
);

239 ià(
ev’t
 =ğ
AVAHI_RESOLVER_FOUND
) {

240 ià(
´ÙocŞ
 !ğ
add»ss
->
´Ùo
) {

241 
	`w¬nšg
("avahi: Resolved‡ddressype‡mbiguous\n");

245 ià(!(
æags
 & 
AVAHI_LOOKUP_RESULT_OUR_OWN
)) {

246 
	`add_cÚù
(
Çme
, 
add»ss
, 
pÜt
);

250 
	`w¬nšg
("avahi: ResŞv” E¼Ü oÀ%s: %s\n", 
Çme
,

251 
	`avahi_¡»¼Ü
(
	`avahi_ş›Á_”ºo
(
avahi
->
ş›Á
)));

254 
	`avahi_£rviû_»sŞv”_ä“
(
r
);

255 
	}
}

258 
	$brow£_ÿÎback
(

259 
AvahiS”viûBrow£r
 *
b
,

260 
AvahiIfIndex
 
š‹rçû
,

261 
AvahiPrÙocŞ
 
´ÙocŞ
,

262 
AvahiBrow£rEv’t
 
ev’t
,

263 cÚ¡ *
Çme
,

264 cÚ¡ *
ty³
,

265 cÚ¡ *
domaš
,

266 
AVAHI_GCC_UNUSED
 
AvahiLookupResuÉFÏgs
 
æags
,

267 * 
u£rd©a
)

269 
´Ùo
 = 
AVAHI_PROTO_INET
;

270 ()
b
;

271 ()
u£rd©a
;

273 
ev’t
) {

274 
AVAHI_BROWSER_NEW
:

275 
	`debug
("avahi: browse_callback if=%d…roto=%d %s\n",

276 
š‹rçû
, 
´ÙocŞ
, 
Çme
);

277 ià(
	`Ãt_af
(
	`b¬es_ÃtwÜk
()è=ğ
AF_INET6
) {

278 
´Ùo
 = 
AVAHI_PROTO_INET6
;

281 ià(!(
	`avahi_£rviû_»sŞv”_Ãw
(
avahi
->
ş›Á
,

282 
š‹rçû
, 
´ÙocŞ
,

283 
Çme
, 
ty³
, 
domaš
,

284 
´Ùo
, 0, 
»sŞve_ÿÎback
,

285 
avahi
->
ş›Á
))) {

286 
	`w¬nšg
("avahi: E¼Ü„esŞvšg %s\n", 
Çme
);

290 
AVAHI_BROWSER_REMOVE
:

291 
	`»move_cÚù_by_dÇme
(
Çme
);

293 
AVAHI_BROWSER_ALL_FOR_NOW
:

294 
AVAHI_BROWSER_CACHE_EXHAUSTED
:

295 
	`debug
("avahi: (Browser) %s\n",

296 
ev’t
 =ğ
AVAHI_BROWSER_CACHE_EXHAUSTED
 ?

300 
	`w¬nšg
("avahi: brow£_ÿÎback %d %s\n", 
ev’t
, 
Çme
);

303 
	}
}

306 
	$avahi_upd©e
(* 
¬g
)

308 ()
¬g
;

310 
	`avahi_sim¶e_pŞl_™”©e
(
avahi
->
pŞl
, 0);

311 
	`tmr_¡¬t
(&
avahi
->
pŞl_tim”
, 250, 
avahi_upd©e
, 0);

312 
	}
}

315 
	$de¡ruùÜ
(* 
¬g
)

317 
avahi_¡
* 
a
 = 
¬g
;

319 
	`tmr_ÿnûl
(&
a
->
pŞl_tim”
);

321 
	`mem_d”ef
(
a
->
loÿl_ua
);

325 ià(
a
->
brow£r
) {

326 
	`avahi_£rviû_brow£r_ä“
(
avahi
->
brow£r
);

329 ià(
a
->
group
) {

330 
	`avahi_’Œy_group_ä“
(
avahi
->
group
);

333 ià(
a
->
ş›Á
) {

334 
	`avahi_ş›Á_ä“
(
avahi
->
ş›Á
);

336 
	}
}

339 
	$moduË_š™
()

341 
”r
;

342 
avahi
 = 
	`mem_z®loc
((
avahi_¡
), 
de¡ruùÜ
);

343 ià(!
avahi
) {

344  
ENOMEM
;

347 
avahi
->
pŞl
 = 
	`avahi_sim¶e_pŞl_Ãw
();

348 
avahi
->
ş›Á
 = 
	`avahi_ş›Á_Ãw
(

349 
	`avahi_sim¶e_pŞl_g‘
(
avahi
->
pŞl
),

350 0, 
ş›Á_ÿÎback
, 
NULL
, &
”r
);

353 ià(!
avahi
->
ş›Á
) {

354 
	`w¬nšg
("FaedØü—‹ cl›Á: %s\n", 
	`avahi_¡»¼Ü
(
”r
));

355  
”r
;

358 
avahi
->
brow£r
 = 
	`avahi_£rviû_brow£r_Ãw
×vahi->
ş›Á
,

359 
AVAHI_IF_UNSPEC
, 
AVAHI_PROTO_UNSPEC
, "_suri._udp", 
NULL
,

360 0, 
brow£_ÿÎback
, 0);

362 
	`tmr_š™
(&
avahi
->
pŞl_tim”
);

363 
	`avahi_upd©e
(0);

366 ià(!
avahi
->
group
) {

367 
	`ü—‹_£rviûs
(
avahi
->
ş›Á
);

371 
	}
}

374 
	$moduË_şo£
()

376 
	`debug
("avahi: module_close\n");

378 
avahi
 = 
	`mem_d”ef
(avahi);

381 
	}
}

384 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
avahi
) = {

387 
moduË_š™
,

388 
moduË_şo£


	@baresip/modules/avcodec/avcodec.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<libavcodec/avcodec.h
>

10 #ifdeà
USE_X264


11 
	~<x264.h
>

13 
	~"h26x.h
"

14 
	~"avcodec.h
"

50 cÚ¡ 
ušt8_t
 
	gh264_Ëv–_idc
 = 0x1f;

51 
AVCodec
 *
	gavcodec_h264’c
;

52 
AVCodec
 *
	gavcodec_h264dec
;

55 
	$avcodec_»sŞve_codecid
(cÚ¡ *
s
)

57 ià(0 =ğ
	`¡r_ÿ£cmp
(
s
, "H263"))

58  
AV_CODEC_ID_H263
;

59 ià(0 =ğ
	`¡r_ÿ£cmp
(
s
, "H264"))

60  
AV_CODEC_ID_H264
;

61 ià(0 =ğ
	`¡r_ÿ£cmp
(
s
, "MP4V-ES"))

62  
AV_CODEC_ID_MPEG4
;

64  
AV_CODEC_ID_NONE
;

65 
	}
}

68 
ušt32_t
 
	$·ck‘iz©iÚ_mode
(cÚ¡ *
fm
)

70 
¶
…l, 
mode
;

72 ià(!
fm
)

75 
	`¶_£t_¡r
(&
¶
, 
fm
);

77 ià(
	`fmt_·¿m_g‘
(&
¶
, "·ck‘iz©iÚ-mode", &
mode
))

78  
	`¶_u32
(&
mode
);

81 
	}
}

84 
	$h264_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

85 
boŞ
 
ofãr
, *
¬g
)

87 
vidcodec
 *
vc
 = 
¬g
;

88 cÚ¡ 
ušt8_t
 
´ofe_idc
 = 0x42;

89 cÚ¡ 
ušt8_t
 
´ofe_iİ
 = 0x80;

90 ()
ofãr
;

92 ià(!
mb
 || !
fmt
 || !
vc
)

95  
	`mbuf_´štf
(
mb
, "a=fmtp:%s"

99 
fmt
->
id
, 
´ofe_idc
, 
´ofe_iİ
, 
h264_Ëv–_idc
);

100 
	}
}

103 
boŞ
 
	$h264_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
)

105 ()
d©a
;

107  
	`·ck‘iz©iÚ_mode
(
fm1
è=ğ·ck‘iz©iÚ_mode(
fm2
);

108 
	}
}

111 
	$h263_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

112 
boŞ
 
ofãr
, *
¬g
)

114 ()
ofãr
;

115 ()
¬g
;

117 ià(!
mb
 || !
fmt
)

120  
	`mbuf_´štf
(
mb
, "a=fm:% CIF=1;CIF4=1\r\n", 
fmt
->
id
);

121 
	}
}

124 
	$mpg4_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

125 
boŞ
 
ofãr
, *
¬g
)

127 ()
ofãr
;

128 ()
¬g
;

130 ià(!
mb
 || !
fmt
)

133  
	`mbuf_´štf
(
mb
, "a=fm:% ´ofe-Ëv–-id=3\r\n", 
fmt
->
id
);

134 
	}
}

137 
vidcodec
 
	gh264
 = {

138 
LE_INIT
,

139 
NULL
,

142 
NULL
,

143 
’code_upd©e
,

144 #ifdeà
USE_X264


145 
’code_x264
,

147 
’code
,

149 
decode_upd©e
,

150 
decode_h264
,

151 
h264_fm_’c
,

152 
h264_fm_cmp
,

155 
vidcodec
 
	gh263
 = {

156 
LE_INIT
,

159 
NULL
,

160 
NULL
,

161 
’code_upd©e
,

162 
’code
,

163 
decode_upd©e
,

164 
decode_h263
,

165 
h263_fm_’c
,

166 
NULL
,

169 
vidcodec
 
	gmpg4
 = {

170 
LE_INIT
,

171 
NULL
,

173 
NULL
,

174 
NULL
,

175 
’code_upd©e
,

176 
’code
,

177 
decode_upd©e
,

178 
decode_m³g4
,

179 
mpg4_fm_’c
,

180 
NULL
,

184 
	$moduË_š™
()

186 
li¡
 *
vidcodeş
 = 
	`b¬es_vidcodeş
();

187 
h264’c
[64];

188 
h264dec
[64];

190 #ifdeà
USE_X264


191 
	`debug
("avcodec: x264 bud %d\n", 
X264_BUILD
);

193 
	`debug
("avcodec: using†ibavcodec H.264ƒncoder\n");

196 #ià
LIBAVCODEC_VERSION_INT
 < ((53<<16)+(10<<8)+0)

197 
	`avcodec_š™
();

200 
	`avcodec_»gi¡”_®l
();

202 ià(0 =ğ
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "avcodec_h264dec",

203 
h264dec
, (h264dec))) {

205 
	`šfo
("avcodec: usšg h264 decod” by‚am(%s)\n", 
h264dec
);

207 
avcodec_h264dec
 = 
	`avcodec_fšd_decod”_by_Çme
(
h264dec
);

208 ià(!
avcodec_h264dec
) {

209 
	`w¬nšg
("avcodec: h264 decoder‚ot found (%s)\n",

210 
h264dec
);

211  
ENOENT
;

213 
	`vidcodec_»gi¡”
(
vidcodeş
, &
h264
);

216 ià(
	`avcodec_fšd_decod”
(
AV_CODEC_ID_H264
))

217 
	`vidcodec_»gi¡”
(
vidcodeş
, &
h264
);

220 ià(
	`avcodec_fšd_decod”
(
AV_CODEC_ID_H263
))

221 
	`vidcodec_»gi¡”
(
vidcodeş
, &
h263
);

223 ià(
	`avcodec_fšd_decod”
(
AV_CODEC_ID_MPEG4
))

224 
	`vidcodec_»gi¡”
(
vidcodeş
, &
mpg4
);

226 ià(0 =ğ
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "avcodec_h264enc",

227 
h264’c
, (h264enc))) {

229 
	`šfo
("avcodec: usšg h264ƒncod” by‚am(%s)\n", 
h264’c
);

231 
avcodec_h264’c
 = 
	`avcodec_fšd_’cod”_by_Çme
(
h264’c
);

232 ià(!
avcodec_h264’c
) {

233 
	`w¬nšg
("avcodec: h264ƒncoder‚ot found (%s)\n",

234 
h264’c
);

235  
ENOENT
;

240 
	}
}

243 
	$moduË_şo£
()

245 
	`vidcodec_uÄegi¡”
(&
mpg4
);

246 
	`vidcodec_uÄegi¡”
(&
h263
);

247 
	`vidcodec_uÄegi¡”
(&
h264
);

250 
	}
}

253 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
avcodec
) = {

256 
moduË_š™
,

257 
moduË_şo£


	@baresip/modules/avcodec/avcodec.h

8 #ià
LIBAVCODEC_VERSION_INT
 < ((54<<16)+(25<<8)+0)

9 
	#AVCodecID
 
CodecID


	)

11 
	#AV_CODEC_ID_NONE
 
CODEC_ID_NONE


	)

12 
	#AV_CODEC_ID_H263
 
CODEC_ID_H263


	)

13 
	#AV_CODEC_ID_H264
 
CODEC_ID_H264


	)

14 
	#AV_CODEC_ID_MPEG4
 
CODEC_ID_MPEG4


	)

19 cÚ¡ 
ušt8_t
 
h264_Ëv–_idc
;

20 
AVCodec
 *
avcodec_h264’c
;

21 
AVCodec
 *
avcodec_h264dec
;

28 
	gvid’c_¡©e
;

30 
’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

31 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

32 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

33 
’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
, cÚ¡ 
vidäame
 *
äame
);

34 #ifdeà
USE_X264


35 
’code_x264
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

36 cÚ¡ 
vidäame
 *
äame
);

44 
	gviddec_¡©e
;

46 
decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

47 cÚ¡ *
fm
);

48 
decode_h263
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

49 
boŞ
 *
šŒa
, boŞ 
eof
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
);

50 
decode_h264
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

51 
boŞ
 *
šŒa
, boŞ 
eof
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
);

52 
decode_m³g4
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

53 
boŞ
 *
šŒa
, boŞ 
eof
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
);

56 
decode_sdµ¬am_h264
(
vid’c_¡©e
 *
¡
, cÚ¡ 
¶
 *
Çme
,

57 cÚ¡ 
¶
 *
v®
);

60 
avcodec_»sŞve_codecid
(cÚ¡ *
s
);

	@baresip/modules/avcodec/decode.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<libavcodec/avcodec.h
>

10 
	~<libavut/avut.h
>

11 
	~<libavut/mem.h
>

12 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(5<<8)+0)

13 
	~<libavut/pixdesc.h
>

15 
	~"h26x.h
"

16 
	~"avcodec.h
"

19 #ià
LIBAVUTIL_VERSION_MAJOR
 < 52

20 
	#AV_PIX_FMT_YUV420P
 
PIX_FMT_YUV420P


	)

21 
	#AV_PIX_FMT_YUVJ420P
 
PIX_FMT_YUVJ420P


	)

22 
	#AV_PIX_FMT_NV12
 
PIX_FMT_NV12


	)

27 
	mDECODE_MAXSZ
 = 524288,

31 
	sviddec_¡©e
 {

32 
AVCodec
 *
	mcodec
;

33 
AVCodecCÚ‹xt
 *
	mùx
;

34 
AVF¿me
 *
	mpiù
;

35 
mbuf
 *
	mmb
;

36 
boŞ
 
	mgÙ_keyäame
;

37 
size_t
 
	mäag_¡¬t
;

38 
boŞ
 
	mäag
;

39 
ušt16_t
 
	mäag_£q
;

42 
	mn_key
;

43 
	mn_lo¡
;

44 } 
	m¡©s
;

48 
šlše
 
št16_t
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

50  (
št16_t
)(
y
 - 
x
);

51 
	}
}

54 
šlše
 
	$äagm’t_»wšd
(
viddec_¡©e
 *
vds
)

56 
vds
->
mb
->
pos
 = vds->
äag_¡¬t
;

57 
vds
->
mb
->
’d
 = vds->
äag_¡¬t
;

58 
	}
}

61 
	$de¡ruùÜ
(*
¬g
)

63 
viddec_¡©e
 *
¡
 = 
¬g
;

65 
	`debug
("avcodec: decoder stats"

67 
¡
->
¡©s
.
n_key
, st->¡©s.
n_lo¡
);

69 
	`mem_d”ef
(
¡
->
mb
);

71 ià(
¡
->
ùx
) {

72 ià(
¡
->
ùx
->
codec
)

73 
	`avcodec_şo£
(
¡
->
ùx
);

74 
	`av_ä“
(
¡
->
ùx
);

77 ià(
¡
->
più
)

78 
	`av_ä“
(
¡
->
più
);

79 
	}
}

82 
	$š™_decod”
(
viddec_¡©e
 *
¡
, cÚ¡ *
Çme
)

84 
AVCodecID
 
codec_id
;

86 
codec_id
 = 
	`avcodec_»sŞve_codecid
(
Çme
);

87 ià(
codec_id
 =ğ
AV_CODEC_ID_NONE
)

88  
EINVAL
;

93 ià(
codec_id
 =ğ
AV_CODEC_ID_H264
 && 
avcodec_h264dec
) {

94 
¡
->
codec
 = 
avcodec_h264dec
;

95 
	`šfo
("avcodec: h264 decoder‡ctivated\n");

98 
¡
->
codec
 = 
	`avcodec_fšd_decod”
(
codec_id
);

99 ià(!
¡
->
codec
)

100  
ENOENT
;

103 #ià
LIBAVCODEC_VERSION_INT
 >= ((52<<16)+(92<<8)+0)

104 
¡
->
ùx
 = 
	`avcodec_®loc_cÚ‹xt3
(¡->
codec
);

106 
¡
->
ùx
 = 
	`avcodec_®loc_cÚ‹xt
();

109 #ià
LIBAVUTIL_VERSION_INT
 >= ((52<<16)+(20<<8)+100)

110 
¡
->
più
 = 
	`av_äame_®loc
();

112 
¡
->
più
 = 
	`avcodec_®loc_äame
();

115 ià(!
¡
->
ùx
 || !¡->
più
)

116  
ENOMEM
;

118 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(8<<8)+0)

119 ià(
	`avcodec_İ’2
(
¡
->
ùx
, st->
codec
, 
NULL
) < 0)

120  
ENOENT
;

122 ià(
	`avcodec_İ’
(
¡
->
ùx
, st->
codec
) < 0)

123  
ENOENT
;

127 
	}
}

130 
	$decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

131 cÚ¡ *
fm
)

133 
viddec_¡©e
 *
¡
;

134 
”r
 = 0;

136 ià(!
vd¥
 || !
vc
)

137  
EINVAL
;

139 ià(*
vd¥
)

142 ()
fm
;

144 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

145 ià(!
¡
)

146  
ENOMEM
;

148 
¡
->
mb
 = 
	`mbuf_®loc
(1024);

149 ià(!
¡
->
mb
) {

150 
”r
 = 
ENOMEM
;

151 
out
;

154 
”r
 = 
	`š™_decod”
(
¡
, 
vc
->
Çme
);

155 ià(
”r
) {

156 
	`w¬nšg
("avcodec: %s: could‚Ù in™ decod”\n", 
vc
->
Çme
);

157 
out
;

160 
	`debug
("avcodec: videØdecod” % (%s)\n", 
vc
->
Çme
, 
fm
);

162 
out
:

163 ià(
”r
)

164 
	`mem_d”ef
(
¡
);

166 *
vd¥
 = 
¡
;

168  
”r
;

169 
	}
}

172 
	$ffdecode
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
)

174 
i
, 
gÙ_piùu»
, 
»t
;

175 
”r
 = 0;

177 
¡
->
mb
->
pos
 = 0;

179 ià(!
¡
->
gÙ_keyäame
) {

180 
	`debug
("avcodec: waiting for key frame ..\n");

184 #ià
LIBAVCODEC_VERSION_INT
 >= ((57<<16)+(37<<8)+100)

187 
AVPack‘
 
avpkt
;

189 
	`av_š™_·ck‘
(&
avpkt
);

190 
avpkt
.
d©a
 = 
¡
->
mb
->
buf
;

191 
avpkt
.
size
 = ()
¡
->
mb
->
’d
;

193 
»t
 = 
	`avcodec_£nd_·ck‘
(
¡
->
ùx
, &
avpkt
);

194 ià(
»t
 < 0) {

195 
	`w¬nšg
("avcodec_£nd_·ck‘ƒ¼Ü„‘=%d\n", 
»t
);

196 
”r
 = 
EBADMSG
;

197 
out
;

200 
»t
 = 
	`avcodec_»ûive_äame
(
¡
->
ùx
, st->
più
);

201 ià(
»t
 =ğ
	`AVERROR
(
EAGAIN
)) {

202 
out
;

204 ià(
»t
 < 0) {

205 
	`w¬nšg
("avcodec_»ûive_äam”rÜ„‘=%d\n", 
»t
);

206 
”r
 = 
EBADMSG
;

207 
out
;

210 
gÙ_piùu»
 = 
Œue
;

214 #–ià
LIBAVCODEC_VERSION_INT
 <= ((52<<16)+(23<<8)+0)

215 
»t
 = 
	`avcodec_decode_video
(
¡
->
ùx
, st->
più
, &
gÙ_piùu»
,

216 
¡
->
mb
->
buf
,

217 ()
¡
->
mb
->
’d
);

220 
AVPack‘
 
avpkt
;

222 
	`av_š™_·ck‘
(&
avpkt
);

223 
avpkt
.
d©a
 = 
¡
->
mb
->
buf
;

224 
avpkt
.
size
 = ()
¡
->
mb
->
’d
;

226 
»t
 = 
	`avcodec_decode_video2
(
¡
->
ùx
, st->
più
,

227 &
gÙ_piùu»
, &
avpkt
);

231 ià(
»t
 < 0) {

232 
”r
 = 
EBADMSG
;

233 
out
;

236 ià(
gÙ_piùu»
) {

238 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(5<<8)+0)

239 
¡
->
più
->
fÜm©
) {

241 
AV_PIX_FMT_YUV420P
:

242 
AV_PIX_FMT_YUVJ420P
:

243 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

246 
AV_PIX_FMT_NV12
:

247 
äame
->
fmt
 = 
VID_FMT_NV12
;

251 
	`w¬nšg
("avcodec: decode: bad…ixel format"

253 
¡
->
più
->
fÜm©
,

254 
	`av_g‘_pix_fmt_Çme
(
¡
->
più
->
fÜm©
));

255 
out
;

258 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

261 
i
=0; i<4; i++) {

262 
äame
->
d©a
[
i
] = 
¡
->
più
->data[i];

263 
äame
->
lšesize
[
i
] = 
¡
->
più
->linesize[i];

265 
äame
->
size
.
w
 = 
¡
->
ùx
->
width
;

266 
äame
->
size
.
h
 = 
¡
->
ùx
->
height
;

269 
out
:

270  
”r
;

271 
	}
}

274 
	$decode_h264
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

275 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
)

277 
h264_hdr
 h264_hdr;

278 cÚ¡ 
ušt8_t
 
Çl_£q
[3] = {0, 0, 1};

279 
”r
;

281 *
šŒa
 = 
çl£
;

283 
”r
 = 
	`h264_hdr_decode
(&
h264_hdr
, 
¤c
);

284 ià(
”r
)

285  
”r
;

288 
	`»_´štf
("avcodec: decode: %s %sype=%2d \n",

289 
m¬k”
 ? "[M]" : " ",

290 
	`h264_is_keyäame
(
h264_hdr
.
ty³
) ? "<KEY>" : " ",

291 
h264_hdr
.
ty³
);

294 ià(
h264_hdr
.
f
) {

295 
	`šfo
("avcodec: H264 forbidden bit set!\n");

296  
EBADMSG
;

299 ià(
¡
->
äag
 && 
h264_hdr
.
ty³
 !ğ
H264_NAL_FU_A
) {

300 
	`debug
("avcodec:†ost fragments; discarding…revious NAL\n");

301 
	`äagm’t_»wšd
(
¡
);

302 
¡
->
äag
 = 
çl£
;

303 ++
¡
->
¡©s
.
n_lo¡
;

307 ià(1 <ğ
h264_hdr
.
ty³
 && h264_hdr.type <= 23) {

309 ià(
	`h264_is_keyäame
(
h264_hdr
.
ty³
))

310 *
šŒa
 = 
Œue
;

312 --
¤c
->
pos
;

315 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
Çl_£q
, 3);

317 
”r
 |ğ
	`mbuf_wr™e_mem
(
¡
->
mb
, 
	`mbuf_buf
(
¤c
),

318 
	`mbuf_g‘_Ëá
(
¤c
));

319 ià(
”r
)

320 
out
;

322 ià(
H264_NAL_FU_A
 =ğ
h264_hdr
.
ty³
) {

323 
h264_fu
 
fu
;

325 
”r
 = 
	`h264_fu_hdr_decode
(&
fu
, 
¤c
);

326 ià(
”r
)

327  
”r
;

328 
h264_hdr
.
ty³
 = 
fu
.type;

330 ià(
fu
.
s
) {

331 ià(
¡
->
äag
) {

332 
	`debug
("avcodec:†ost fragments;"

334 
	`äagm’t_»wšd
(
¡
);

335 ++
¡
->
¡©s
.
n_lo¡
;

338 
¡
->
äag_¡¬t
 = st->
mb
->
pos
;

339 
¡
->
äag
 = 
Œue
;

341 ià(
	`h264_is_keyäame
(
fu
.
ty³
))

342 *
šŒa
 = 
Œue
;

345 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
Çl_£q
, 3);

348 
”r
 = 
	`h264_hdr_’code
(&
h264_hdr
, 
¡
->
mb
);

351 ià(!
¡
->
äag
) {

352 
	`debug
("avcodec: ignoring fragment\n");

353 ++
¡
->
¡©s
.
n_lo¡
;

357 ià(
	`£q_diff
(
¡
->
äag_£q
, 
£q
) != 1) {

358 
	`debug
("avcodec:†ost fragments detected\n");

359 
	`äagm’t_»wšd
(
¡
);

360 
¡
->
äag
 = 
çl£
;

361 ++
¡
->
¡©s
.
n_lo¡
;

366 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
	`mbuf_buf
(
¤c
),

367 
	`mbuf_g‘_Ëá
(
¤c
));

368 ià(
”r
)

369 
out
;

371 ià(
fu
.
e
)

372 
¡
->
äag
 = 
çl£
;

374 
¡
->
äag_£q
 = 
£q
;

377 
	`w¬nšg
("avcodec: unknowÀNALy³ %u\n", 
h264_hdr
.
ty³
);

378  
EBADMSG
;

381 ià(*
šŒa
) {

382 
¡
->
gÙ_keyäame
 = 
Œue
;

383 ++
¡
->
¡©s
.
n_key
;

386 ià(!
m¬k”
) {

388 ià(
¡
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

389 
	`w¬nšg
("avcodec: decode buffer sizeƒxceeded\n");

390 
”r
 = 
ENOMEM
;

391 
out
;

397 ià(
¡
->
äag
) {

398 
”r
 = 
EPROTO
;

399 
out
;

402 
”r
 = 
	`ffdecode
(
¡
, 
äame
);

403 ià(
”r
)

404 
out
;

406 
out
:

407 
	`mbuf_»wšd
(
¡
->
mb
);

408 
¡
->
äag
 = 
çl£
;

410  
”r
;

411 
	}
}

414 
	$decode_m³g4
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

415 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
)

417 
”r
;

419 ià(!
¤c
)

422 ()
£q
;

424 *
šŒa
 = 
çl£
;

427 
¡
->
gÙ_keyäame
 = 
Œue
;

429 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
	`mbuf_buf
(
¤c
),

430 
	`mbuf_g‘_Ëá
(
¤c
));

431 ià(
”r
)

432 
out
;

434 ià(!
m¬k”
) {

436 ià(
¡
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

437 
	`w¬nšg
("avcodec: decode buffer sizeƒxceeded\n");

438 
”r
 = 
ENOMEM
;

439 
out
;

445 
”r
 = 
	`ffdecode
(
¡
, 
äame
);

446 ià(
”r
)

447 
out
;

449 
out
:

450 
	`mbuf_»wšd
(
¡
->
mb
);

452  
”r
;

453 
	}
}

456 
	$decode_h263
(
viddec_¡©e
 *
¡
, 
vidäame
 *
äame
,

457 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
¤c
)

459 
h263_hdr
 
hdr
;

460 
”r
;

462 ià(!
¡
 || !
äame
 || !
šŒa
)

463  
EINVAL
;

465 *
šŒa
 = 
çl£
;

467 ià(!
¤c
)

470 ()
£q
;

472 
”r
 = 
	`h263_hdr_decode
(&
hdr
, 
¤c
);

473 ià(
”r
)

474  
”r
;

477 
	`debug
(".....[%s seq=%5u ] MODE %s -"

480 
m¬k”
 ? "M" : " ", 
£q
,

481 
	`h263_hdr_mode
(&
hdr
è=ğ
H263_MODE_A
 ? "A" : "B",

482 
hdr
.
sb™
, hdr.
eb™
, hdr.
i
 ? "Inter" : "Intra",

483 
	`mbuf_g‘_Ëá
(
¤c
), 
¡
->
mb
->
’d
);

486 ià(!
hdr
.
i
) {

487 
¡
->
gÙ_keyäame
 = 
Œue
;

488 ià(
¡
->
mb
->
pos
 == 0) {

489 *
šŒa
 = 
Œue
;

494 ià(
¡
->
mb
->
pos
 == 0) {

495 
ušt8_t
 *
p
 = 
	`mbuf_buf
(
¤c
);

497 ià(
p
[0] != 0x00 ||…[1] != 0x00) {

498 
	`w¬nšg
("invalid PSC detected (%02x %02x)\n",

499 
p
[0],…[1]);

500  
EPROTO
;

521 ià(
hdr
.
sb™
 > 0) {

522 cÚ¡ 
ušt8_t
 
mask
 = (1 << (8 - 
hdr
.
sb™
)) - 1;

523 cÚ¡ 
ušt8_t
 
sby‹
 = 
	`mbuf_»ad_u8
(
¤c
è& 
mask
;

525 
¡
->
mb
->
buf
[¡->mb->
’d
 - 1] |ğ
sby‹
;

528 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
	`mbuf_buf
(
¤c
),

529 
	`mbuf_g‘_Ëá
(
¤c
));

530 ià(
”r
)

531 
out
;

533 ià(!
m¬k”
) {

535 ià(
¡
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

536 
	`w¬nšg
("avcodec: decode buffer sizeƒxceeded\n");

537 
”r
 = 
ENOMEM
;

538 
out
;

544 ià(!
hdr
.
i
) {

545 ++
¡
->
¡©s
.
n_key
;

548 
”r
 = 
	`ffdecode
(
¡
, 
äame
);

549 ià(
”r
)

550 
out
;

552 
out
:

553 
	`mbuf_»wšd
(
¡
->
mb
);

555  
”r
;

556 
	}
}

	@baresip/modules/avcodec/encode.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<libavcodec/avcodec.h
>

10 
	~<libavut/mem.h
>

11 #ià
LIBAVUTIL_VERSION_INT
 >= ((50<<16)+(29<<8)+0)

12 
	~<libavut/İt.h
>

14 
	~<libavcodec/İt.h
>

16 #ifdeà
USE_X264


17 
	~<x264.h
>

19 
	~"h26x.h
"

20 
	~"avcodec.h
"

23 #ià
LIBAVUTIL_VERSION_MAJOR
 < 52

24 
	#AV_PIX_FMT_YUV420P
 
PIX_FMT_YUV420P


	)

25 
	#AV_PIX_FMT_NV12
 
PIX_FMT_NV12


	)

30 
	mDEFAULT_GOP_SIZE
 = 10,

34 
	spicsz
 {

35 
h263_fmt
 
	mfmt
;

36 
ušt8_t
 
	mmpi
;

40 
	svid’c_¡©e
 {

41 
AVCodec
 *
	mcodec
;

42 
AVCodecCÚ‹xt
 *
	mùx
;

43 
AVF¿me
 *
	mpiù
;

44 
mbuf
 *
	mmb
;

45 
size_t
 
	msz_max
;

46 
št64_t
 
	m±s
;

47 
mbuf
 *
	mmb_äag
;

48 
vid’c_·¿m
 
	m’ırm
;

49 
vidsz
 
	m’csize
;

50 
AVCodecID
 
	mcodec_id
;

51 
vid’c_·ck‘_h
 *
	mpkth
;

52 *
	m¬g
;

56 
picsz
 
	mpicszv
[8];

57 
ušt32_t
 
	mpicszn
;

58 } 
	mh263
;

61 
ušt32_t
 
	m·ck‘iz©iÚ_mode
;

62 
ušt32_t
 
	m´ofe_idc
;

63 
ušt32_t
 
	m´ofe_iİ
;

64 
ušt32_t
 
	mËv–_idc
;

65 
ušt32_t
 
	mmax_fs
;

66 
ušt32_t
 
	mmax_smbps
;

67 } 
	mh264
;

68 } 
	mu
;

70 #ifdeà
USE_X264


71 
x264_t
 *
	mx264
;

76 
	$de¡ruùÜ
(*
¬g
)

78 
vid’c_¡©e
 *
¡
 = 
¬g
;

80 
	`mem_d”ef
(
¡
->
mb
);

81 
	`mem_d”ef
(
¡
->
mb_äag
);

83 #ifdeà
USE_X264


84 ià(
¡
->
x264
)

85 
	`x264_’cod”_şo£
(
¡
->
x264
);

88 ià(
¡
->
ùx
) {

89 ià(
¡
->
ùx
->
codec
)

90 
	`avcodec_şo£
(
¡
->
ùx
);

91 #ià
LIBAVUTIL_VERSION_INT
 >= ((51<<16)+(8<<8)+0)

92 
	`av_İt_ä“
(
¡
->
ùx
);

94 
	`av_ä“
(
¡
->
ùx
);

97 ià(
¡
->
più
)

98 
	`av_ä“
(
¡
->
più
);

99 
	}
}

102 
h263_fmt
 
	$h263_fmt
(cÚ¡ 
¶
 *
Çme
)

104 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "sqcif")è 
H263_FMT_SQCIF
;

105 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "qcif")è 
H263_FMT_QCIF
;

106 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "cif")è 
H263_FMT_CIF
;

107 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "cif4")è 
H263_FMT_4CIF
;

108 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "cif16")è 
H263_FMT_16CIF
;

109  
H263_FMT_OTHER
;

110 
	}
}

113 
	$decode_sdµ¬am_h263
(
vid’c_¡©e
 *
¡
, cÚ¡ 
¶
 *
Çme
,

114 cÚ¡ 
¶
 *
v®
)

116 
h263_fmt
 
fmt
 = 
	`h263_fmt
(
Çme
);

117 cÚ¡ 
mpi
 = 
	`¶_u32
(
v®
);

119 ià(
fmt
 =ğ
H263_FMT_OTHER
) {

120 
	`šfo
("h263: unknowÀ·¿m '%r'\n", 
Çme
);

123 ià(
mpi
 < 1 || mpi > 32) {

124 
	`šfo
("h263: %r: MPI ouˆoà¿ng%d\n", 
Çme
, 
mpi
);

128 ià(
¡
->
u
.
h263
.
picszn
 >ğ
	`ARRAY_SIZE
(¡->u.h263.
picszv
)) {

129 
	`šfo
("h263:…icszv ov”æow: %r\n", 
Çme
);

133 
¡
->
u
.
h263
.
picszv
[¡->u.h263.
picszn
].
fmt
 = fmt;

134 
¡
->
u
.
h263
.
picszv
[¡->u.h263.
picszn
].
mpi
 = mpi;

136 ++
¡
->
u
.
h263
.
picszn
;

139 
	}
}

142 
	$š™_’cod”
(
vid’c_¡©e
 *
¡
)

147 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_H264
 && 
avcodec_h264’c
) {

149 #ifdeà
USE_X264


150 
	`w¬nšg
("avcodec: h264enc specified, but using†ibx264\n");

151  
EINVAL
;

153 
¡
->
codec
 = 
avcodec_h264’c
;

155 
	`šfo
("avcodec: h264ƒncoder‡ctivated\n");

161 
¡
->
codec
 = 
	`avcodec_fšd_’cod”
(¡->
codec_id
);

162 ià(!
¡
->
codec
)

163  
ENOENT
;

166 
	}
}

169 
	$İ’_’cod”
(
vid’c_¡©e
 *
¡
,

170 cÚ¡ 
vid’c_·¿m
 *
´m
,

171 cÚ¡ 
vidsz
 *
size
,

172 
pix_fmt
)

174 
”r
 = 0;

176 ià(
¡
->
ùx
) {

177 ià(
¡
->
ùx
->
codec
)

178 
	`avcodec_şo£
(
¡
->
ùx
);

179 #ià
LIBAVUTIL_VERSION_INT
 >= ((51<<16)+(8<<8)+0)

180 
	`av_İt_ä“
(
¡
->
ùx
);

182 
	`av_ä“
(
¡
->
ùx
);

185 ià(
¡
->
più
)

186 
	`av_ä“
(
¡
->
più
);

188 #ià
LIBAVCODEC_VERSION_INT
 >= ((52<<16)+(92<<8)+0)

189 
¡
->
ùx
 = 
	`avcodec_®loc_cÚ‹xt3
(¡->
codec
);

191 
¡
->
ùx
 = 
	`avcodec_®loc_cÚ‹xt
();

194 #ià
LIBAVUTIL_VERSION_INT
 >= ((52<<16)+(20<<8)+100)

195 
¡
->
più
 = 
	`av_äame_®loc
();

197 
¡
->
più
 = 
	`avcodec_®loc_äame
();

200 ià(!
¡
->
ùx
 || !¡->
più
) {

201 
”r
 = 
ENOMEM
;

202 
out
;

205 
	`av_İt_£t_deçuÉs
(
¡
->
ùx
);

207 
¡
->
ùx
->
b™_¿‹
 = 
´m
->
b™¿‹
;

208 
¡
->
ùx
->
width
 = 
size
->
w
;

209 
¡
->
ùx
->
height
 = 
size
->
h
;

210 
¡
->
ùx
->
gİ_size
 = 
DEFAULT_GOP_SIZE
;

211 
¡
->
ùx
->
pix_fmt
 =…ix_fmt;

212 
¡
->
ùx
->
time_ba£
.
num
 = 1;

213 
¡
->
ùx
->
time_ba£
.
d’
 = 
´m
->
ås
;

216 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_H264
) {

217 
¡
->
ùx
->
me_¿nge
 = 16;

218 
¡
->
ùx
->
qmš
 = 10;

219 
¡
->
ùx
->
qmax
 = 51;

220 
¡
->
ùx
->
max_qdiff
 = 4;

222 #iâdeà
USE_X264


223 ià(
¡
->
codec
 =ğ
	`avcodec_fšd_’cod”_by_Çme
("nvenc_h264") ||

224 
¡
->
codec
 =ğ
	`avcodec_fšd_’cod”_by_Çme
("h264_nvenc")) {

226 #ià
LIBAVUTIL_VERSION_INT
 >= ((51<<16)+(21<<8)+0)

227 
”r
 = 
	`av_İt_£t
(
¡
->
ùx
->
´iv_d©a
,

230 ià(
”r
 < 0) {

231 
	`debug
("avcodec: h264‚venc setting…reset "

232 "\"Îhp\" faed;ƒ¼Ü: %u\n", 
”r
);

235 
	`debug
("avcodec: h264‚venc…reset "

238 
”r
 = 
	`av_İt_£t_št
(
¡
->
ùx
->
´iv_d©a
,

241 ià(
”r
 < 0) {

242 
	`debug
("avcodec: h264‚venc option "

243 "\"2·ss\" faed;ƒ¼Ü: %u\n", 
”r
);

246 
	`debug
("avcodec: h264‚venc option "

254 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(8<<8)+0)

255 ià(
	`avcodec_İ’2
(
¡
->
ùx
, st->
codec
, 
NULL
) < 0) {

256 
”r
 = 
ENOENT
;

257 
out
;

260 ià(
	`avcodec_İ’
(
¡
->
ùx
, st->
codec
) < 0) {

261 
”r
 = 
ENOENT
;

262 
out
;

266 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(5<<8)+0)

267 
¡
->
più
->
fÜm©
 = 
pix_fmt
;

268 
¡
->
più
->
width
 = 
size
->
w
;

269 
¡
->
più
->
height
 = 
size
->
h
;

272 
out
:

273 ià(
”r
) {

274 ià(
¡
->
ùx
) {

275 ià(
¡
->
ùx
->
codec
)

276 
	`avcodec_şo£
(
¡
->
ùx
);

277 #ià
LIBAVUTIL_VERSION_INT
 >= ((51<<16)+(8<<8)+0)

278 
	`av_İt_ä“
(
¡
->
ùx
);

280 
	`av_ä“
(
¡
->
ùx
);

281 
¡
->
ùx
 = 
NULL
;

284 ià(
¡
->
più
) {

285 
	`av_ä“
(
¡
->
più
);

286 
¡
->
più
 = 
NULL
;

290 
¡
->
’csize
 = *
size
;

292  
”r
;

293 
	}
}

296 
	$decode_sdµ¬am_h264
(
vid’c_¡©e
 *
¡
, cÚ¡ 
¶
 *
Çme
,

297 cÚ¡ 
¶
 *
v®
)

299 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "packetization-mode")) {

300 
¡
->
u
.
h264
.
·ck‘iz©iÚ_mode
 = 
	`¶_u32
(
v®
);

302 ià(
¡
->
u
.
h264
.
·ck‘iz©iÚ_mode
 != 0) {

303 
	`w¬nšg
("avcodec: illegal…acketization-mode %u\n",

304 
¡
->
u
.
h264
.
·ck‘iz©iÚ_mode
);

305  
EPROTO
;

308 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "profile-level-id")) {

309 
¶
 
´of
 = *
v®
;

310 ià(
´of
.
l
 != 6) {

311 
	`w¬nšg
("avcodec: invalid…rofile-level-id (%r)\n",

312 
v®
);

313  
EPROTO
;

316 
´of
.
l
 = 2;

317 
¡
->
u
.
h264
.
´ofe_idc
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

318 
¡
->
u
.
h264
.
´ofe_iİ
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

319 
¡
->
u
.
h264
.
Ëv–_idc
 = 
	`¶_x32
(&
´of
);

321 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-fs")) {

322 
¡
->
u
.
h264
.
max_fs
 = 
	`¶_u32
(
v®
);

324 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-smbps")) {

325 
¡
->
u
.
h264
.
max_smbps
 = 
	`¶_u32
(
v®
);

329 
	}
}

332 
	$·¿m_hªdËr
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

333 *
¬g
)

335 
vid’c_¡©e
 *
¡
 = 
¬g
;

337 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_H263
)

338 ()
	`decode_sdµ¬am_h263
(
¡
, 
Çme
, 
v®
);

339 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_H264
)

340 ()
	`decode_sdµ¬am_h264
(
¡
, 
Çme
, 
v®
);

341 
	}
}

344 
	$g’”®_·ck‘ize
(
ušt32_t
 
¹p_ts
, 
mbuf
 *
mb
, 
size_t
 
pktsize
,

345 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

347 
”r
 = 0;

350 !
”r
) {

351 
size_t
 
sz
, 
Ëá
 = 
	`mbuf_g‘_Ëá
(
mb
);

352 
boŞ
 
Ï¡
 = (
Ëá
 < 
pktsize
);

353 ià(!
Ëá
)

356 
sz
 = 
Ï¡
 ? 
Ëá
 : 
pktsize
;

358 
”r
 = 
	`pkth
(
Ï¡
, 
¹p_ts
, 
NULL
, 0, 
	`mbuf_buf
(
mb
), 
sz
,

359 
¬g
);

361 
	`mbuf_advªû
(
mb
, 
sz
);

364  
”r
;

365 
	}
}

368 
	$h263_·ck‘ize
(
vid’c_¡©e
 *
¡
,

369 
ušt32_t
 
¹p_ts
, 
mbuf
 *
mb
,

370 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

372 
h263_¡rm
 h263_strm;

373 
h263_hdr
 h263_hdr;

374 
size_t
 
pos
;

375 
”r
;

378 
”r
 = 
	`h263_¡rm_decode
(&
h263_¡rm
, 
mb
);

379 ià(
”r
)

380  
”r
;

382 
	`h263_hdr_cİy_¡rm
(&
h263_hdr
, &
h263_¡rm
);

384 
¡
->
mb_äag
->
pos
 = st->mb_äag->
’d
 = 0;

385 
”r
 = 
	`h263_hdr_’code
(&
h263_hdr
, 
¡
->
mb_äag
);

386 
pos
 = 
¡
->
mb_äag
->pos;

389 !
”r
) {

390 
size_t
 
sz
, 
Ëá
 = 
	`mbuf_g‘_Ëá
(
mb
);

391 
boŞ
 
Ï¡
 = (
Ëá
 < 
¡
->
’ırm
.
pktsize
);

392 ià(!
Ëá
)

395 
sz
 = 
Ï¡
 ? 
Ëá
 : 
¡
->
’ırm
.
pktsize
;

397 
¡
->
mb_äag
->
pos
 = st->mb_äag->
’d
 =…os;

398 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb_äag
, 
	`mbuf_buf
(
mb
), 
sz
);

399 ià(
”r
)

402 
¡
->
mb_äag
->
pos
 = 0;

404 
”r
 = 
	`pkth
(
Ï¡
, 
¹p_ts
, 
NULL
, 0, 
	`mbuf_buf
(
¡
->
mb_äag
),

405 
	`mbuf_g‘_Ëá
(
¡
->
mb_äag
), 
¬g
);

407 
	`mbuf_advªû
(
mb
, 
sz
);

410  
”r
;

411 
	}
}

414 #ifdeà
USE_X264


415 
	$İ’_’cod”_x264
(
vid’c_¡©e
 *
¡
, 
vid’c_·¿m
 *
´m
,

416 cÚ¡ 
vidsz
 *
size
, 
c¥
)

418 
x264_·¿m_t
 
x´m
;

420 ià(
	`x264_·¿m_deçuÉ_´e£t
(&
x´m
, "ultrafast", "zerolatency"))

421  
ENOSYS
;

423 
	`x264_·¿m_­¶y_´ofe
(&
x´m
, "baseline");

425 
x´m
.
i_Ëv–_idc
 = 
h264_Ëv–_idc
;

426 
x´m
.
i_width
 = 
size
->
w
;

427 
x´m
.
i_height
 = 
size
->
h
;

428 
x´m
.
i_c¥
 = 
c¥
;

429 
x´m
.
i_ås_num
 = 
´m
->
ås
;

430 
x´m
.
i_ås_d’
 = 1;

431 
x´m
.
rc
.
i_b™¿‹
 = 
´m
->
b™¿‹
 / 1000;

432 
x´m
.
rc
.
i_rc_m‘hod
 = 
X264_RC_ABR
;

433 
x´m
.
i_log_Ëv–
 = 
X264_LOG_WARNING
;

436 
x´m
.
i_äame_»ã»nû
 = 1;

437 
x´m
.
i_sûÃcut_th»shŞd
 = 0;

438 
x´m
.
b_deblockšg_f‹r
 = 0;

439 
x´m
.
b_ÿbac
 = 0;

440 
x´m
.
i_bäame
 = 0;

441 
x´m
.
ª®y£
.
šŒa
 = 0;

442 
x´m
.
ª®y£
.
š‹r
 = 0;

443 
x´m
.
ª®y£
.
b_ŒªsfÜm_8x8
 = 0;

444 
x´m
.
ª®y£
.
i_me_m‘hod
 = 
X264_ME_DIA
;

445 
x´m
.
ª®y£
.
i_sub³l_»fše
 = 0;

446 #ià
X264_BUILD
 >= 59

447 
x´m
.
rc
.
i_aq_mode
 = 0;

449 
x´m
.
ª®y£
.
b_mixed_»ã»nûs
 = 0;

450 
x´m
.
ª®y£
.
i_Œ–lis
 = 0;

451 #ià
X264_BUILD
 >= 63

452 
x´m
.
i_bäame_ad­tive
 = 
X264_B_ADAPT_NONE
;

454 #ià
X264_BUILD
 >= 70

455 
x´m
.
rc
.
b_mb_Œ“
 = 0;

459 #ià
X264_BUILD
 >= 80

460 
x´m
.
rc
.
i_lookah—d
 = 0;

461 
x´m
.
i_sync_lookah—d
 = 0;

462 
x´m
.
i_bäame
 = 0;

466 
x´m
.
b_»³©_h—d”s
 = 1;

468 #ià
X264_BUILD
 >= 82

470 
x´m
.
b_šŒa_»äesh
 = 1;

473 ià(
¡
->
x264
)

474 
	`x264_’cod”_şo£
(
¡
->
x264
);

476 
¡
->
x264
 = 
	`x264_’cod”_İ’
(&
x´m
);

477 ià(!
¡
->
x264
) {

478 
	`w¬nšg
("avcodec: x264_encoder_open() failed\n");

479  
ENOENT
;

482 
¡
->
’csize
 = *
size
;

485 
	}
}

489 
	$’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

490 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

491 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

493 
vid’c_¡©e
 *
¡
;

494 
”r
 = 0;

496 ià(!
ve¥
 || !
vc
 || !
´m
 || !
pkth
)

497  
EINVAL
;

499 ià(*
ve¥
)

502 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

503 ià(!
¡
)

504  
ENOMEM
;

506 
¡
->
’ırm
 = *
´m
;

507 
¡
->
pkth
 =…kth;

508 
¡
->
¬g
 =‡rg;

510 
¡
->
codec_id
 = 
	`avcodec_»sŞve_codecid
(
vc
->
Çme
);

511 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_NONE
) {

512 
”r
 = 
EINVAL
;

513 
out
;

516 
¡
->
mb
 = 
	`mbuf_®loc
(
FF_MIN_BUFFER_SIZE
 * 20);

517 
¡
->
mb_äag
 = 
	`mbuf_®loc
(1024);

518 ià(!
¡
->
mb
 || !¡->
mb_äag
) {

519 
”r
 = 
ENOMEM
;

520 
out
;

523 
¡
->
sz_max
 = st->
mb
->
size
;

525 ià(
¡
->
codec_id
 =ğ
AV_CODEC_ID_H264
) {

526 #iâdeà
USE_X264


527 
”r
 = 
	`š™_’cod”
(
¡
);

531 
”r
 = 
	`š™_’cod”
(
¡
);

532 ià(
”r
) {

533 
	`w¬nšg
("avcodec: %s: could‚Ù in™ƒncod”\n", 
vc
->
Çme
);

534 
out
;

537 ià(
	`¡r_is£t
(
fm
)) {

538 
¶
 
sdp_fm
;

540 
	`¶_£t_¡r
(&
sdp_fm
, 
fm
);

542 
	`fmt_·¿m_­¶y
(&
sdp_fm
, 
·¿m_hªdËr
, 
¡
);

545 
	`debug
("avcodec: videoƒncoder %s: %d fps, %d bit/s,…ktsize=%u\n",

546 
vc
->
Çme
, 
´m
->
ås
,…rm->
b™¿‹
,…rm->
pktsize
);

548 
out
:

549 ià(
”r
)

550 
	`mem_d”ef
(
¡
);

552 *
ve¥
 = 
¡
;

554  
”r
;

555 
	}
}

558 #ifdeà
USE_X264


559 
	$’code_x264
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

560 cÚ¡ 
vidäame
 *
äame
)

562 
x264_piùu»_t
 
pic_š
, 
pic_out
;

563 
x264_Çl_t
 *
Çl
;

564 
i_Çl
;

565 
i
, 
”r
, 
»t
;

566 
c¥
, 
¶n
;

567 
ušt32_t
 
ts
;

569 ià(!
¡
 || !
äame
)

570  
EINVAL
;

572 
äame
->
fmt
) {

574 
VID_FMT_YUV420P
:

575 
c¥
 = 
X264_CSP_I420
;

576 
¶n
 = 3;

579 
VID_FMT_NV12
:

580 
c¥
 = 
X264_CSP_NV12
;

581 
¶n
 = 2;

585 
	`w¬nšg
("avcodec:…ixel format‚ot supported (%s)\n",

586 
	`vidfmt_Çme
(
äame
->
fmt
));

587  
ENOTSUP
;

590 ià(!
¡
->
x264
 || !
	`vidsz_cmp
(&¡->
’csize
, &
äame
->
size
)) {

592 
”r
 = 
	`İ’_’cod”_x264
(
¡
, &¡->
’ırm
, &
äame
->
size
, 
c¥
);

593 ià(
”r
)

594  
”r
;

597 ià(
upd©e
) {

598 #ià
X264_BUILD
 >= 95

599 
	`x264_’cod”_šŒa_»äesh
(
¡
->
x264
);

601 
	`debug
("avcodec: x264…icture update\n");

604 
	`x264_piùu»_š™
(&
pic_š
);

606 
pic_š
.
i_ty³
 = 
upd©e
 ? 
X264_TYPE_IDR
 : 
X264_TYPE_AUTO
;

607 
pic_š
.
i_qµlus1
 = 0;

608 
pic_š
.
i_±s
 = ++
¡
->
±s
;

610 
pic_š
.
img
.
i_c¥
 = 
c¥
;

611 
pic_š
.
img
.
i_¶ªe
 = 
¶n
;

612 
i
=0; i<
¶n
; i++) {

613 
pic_š
.
img
.
i_¡ride
[
i
] = 
äame
->
lšesize
[i];

614 
pic_š
.
img
.
¶ªe
[
i
] = 
äame
->
d©a
[i];

617 
»t
 = 
	`x264_’cod”_’code
(
¡
->
x264
, &
Çl
, &
i_Çl
, &
pic_š
, &
pic_out
);

618 ià(
»t
 < 0) {

619 
	`w¬nšg
("avcodec: x264 [error]: x264_encoder_encode failed\n");

621 ià(
i_Çl
 == 0)

624 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pic_out
.
i_±s
, 
¡
->
’ırm
.
ås
);

626 
”r
 = 0;

627 
i
=0; i<
i_Çl
 && !
”r
; i++) {

628 cÚ¡ 
ušt8_t
 
hdr
 = 
Çl
[
i
].
i_»f_idc
<<5 |‚®[i].
i_ty³
<<0;

629 
off£t
 = 0;

631 #ià
X264_BUILD
 >= 76

632 cÚ¡ 
ušt8_t
 *
p
 = 
Çl
[
i
].
p_·ylßd
;

635 ià(
Çl
[
i
].
i_·ylßd
 > 4 && 
p
[0] == 0x00 &&…[1] == 0x00) {

636 ià(
p
[2] == 0x00 &&…[3] == 0x01)

637 
off£t
 = 4 + 1;

638 ià(
p
[2] == 0x01)

639 
off£t
 = 3 + 1;

644 ià(
Çl
[
i
].
i_ty³
 =ğ
H264_NAL_SEI
)

647 
”r
 = 
	`h264_Çl_£nd
(
Œue
,rue, (
i
+1)==
i_Çl
, 
hdr
, 
ts
,

648 
Çl
[
i
].
p_·ylßd
 + 
off£t
,

649 
Çl
[
i
].
i_·ylßd
 - 
off£t
,

650 
¡
->
’ırm
.
pktsize
,

651 
¡
->
pkth
, st->
¬g
);

654  
”r
;

655 
	}
}

659 
	$’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
, cÚ¡ 
vidäame
 *
äame
)

661 
i
, 
”r
, 
»t
;

662 
pix_fmt
;

663 
ušt32_t
 
ts
;

665 ià(!
¡
 || !
äame
)

666  
EINVAL
;

668 
äame
->
fmt
) {

670 
VID_FMT_YUV420P
:

671 
pix_fmt
 = 
AV_PIX_FMT_YUV420P
;

674 
VID_FMT_NV12
:

675 
pix_fmt
 = 
AV_PIX_FMT_NV12
;

679 
	`w¬nšg
("avcodec:…ixel format‚ot supported (%s)\n",

680 
	`vidfmt_Çme
(
äame
->
fmt
));

681  
ENOTSUP
;

684 ià(!
¡
->
ùx
 || !
	`vidsz_cmp
(&¡->
’csize
, &
äame
->
size
)) {

686 
”r
 = 
	`İ’_’cod”
(
¡
, &¡->
’ırm
, &
äame
->
size
, 
pix_fmt
);

687 ià(
”r
) {

688 
	`w¬nšg
("avcodec: o³n_’cod”: %m\n", 
”r
);

689  
”r
;

693 
i
=0; i<4; i++) {

694 
¡
->
più
->
d©a
[
i
] = 
äame
->data[i];

695 
¡
->
più
->
lšesize
[
i
] = 
äame
->linesize[i];

697 
¡
->
più
->
±s
 = st->pts++;

698 ià(
upd©e
) {

699 
	`debug
("avcodec:ƒncoder…icture update\n");

700 
¡
->
più
->
key_äame
 = 1;

701 #ifdeà
FF_I_TYPE


702 
¡
->
più
->
più_ty³
 = 
FF_I_TYPE
;

704 
¡
->
più
->
più_ty³
 = 
AV_PICTURE_TYPE_I
;

708 
¡
->
più
->
key_äame
 = 0;

709 
¡
->
più
->
più_ty³
 = 0;

712 
	`mbuf_»wšd
(
¡
->
mb
);

714 #ià
LIBAVCODEC_VERSION_INT
 >= ((57<<16)+(37<<8)+100)

716 
AVPack‘
 *
pkt
;

718 
»t
 = 
	`avcodec_£nd_äame
(
¡
->
ùx
, st->
più
);

719 ià(
»t
 < 0)

720  
EBADMSG
;

722 
pkt
 = 
	`av_·ck‘_®loc
();

723 ià(!
pkt
)

724  
ENOMEM
;

726 
»t
 = 
	`avcodec_»ûive_·ck‘
(
¡
->
ùx
, 
pkt
);

727 ià(
»t
 < 0) {

728 
	`av_·ck‘_ä“
(&
pkt
);

732 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pkt
->
dts
, 
¡
->
’ırm
.
ås
);

734 
”r
 = 
	`mbuf_wr™e_mem
(
¡
->
mb
, 
pkt
->
d©a
,…kt->
size
);

735 
¡
->
mb
->
pos
 = 0;

737 
	`av_·ck‘_ä“
(&
pkt
);

739 ià(
”r
)

740  
”r
;

742 #–ià
LIBAVCODEC_VERSION_INT
 >= ((54<<16)+(1<<8)+0)

744 
AVPack‘
 
avpkt
;

745 
gÙ_·ck‘
;

747 
	`av_š™_·ck‘
(&
avpkt
);

749 
avpkt
.
d©a
 = 
¡
->
mb
->
buf
;

750 
avpkt
.
size
 = ()
¡
->
mb
->size;

752 
»t
 = 
	`avcodec_’code_video2
(
¡
->
ùx
, &
avpkt
,

753 
¡
->
più
, &
gÙ_·ck‘
);

754 ià(
»t
 < 0)

755  
EBADMSG
;

756 ià(!
gÙ_·ck‘
)

759 
	`mbuf_£t_’d
(
¡
->
mb
, 
avpkt
.
size
);

761 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
avpkt
.
dts
, 
¡
->
’ırm
.
ås
);

765 
»t
 = 
	`avcodec_’code_video
(
¡
->
ùx
, st->
mb
->
buf
,

766 ()
¡
->
mb
->
size
, st->
più
);

767 ià(
»t
 < 0 )

768  
EBADMSG
;

771 ià(
»t
 > ()
¡
->
sz_max
) {

772 
	`debug
("avcodec: growƒncode buffer %u --> %d\n",

773 
¡
->
sz_max
, 
»t
);

774 
¡
->
sz_max
 = 
»t
;

777 
	`mbuf_£t_’d
(
¡
->
mb
, 
»t
);

779 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
¡
->
più
->
±s
, st->
’ırm
.
ås
);

782 
¡
->
codec_id
) {

784 
AV_CODEC_ID_H263
:

785 
”r
 = 
	`h263_·ck‘ize
(
¡
, 
ts
, st->
mb
, st->
pkth
, st->
¬g
);

788 
AV_CODEC_ID_H264
:

789 
”r
 = 
	`h264_·ck‘ize
(
ts
, 
¡
->
mb
->
buf
, st->mb->
’d
,

790 
¡
->
’ırm
.
pktsize
,

791 
¡
->
pkth
, st->
¬g
);

794 
AV_CODEC_ID_MPEG4
:

795 
”r
 = 
	`g’”®_·ck‘ize
(
ts
, 
¡
->
mb
, st->
’ırm
.
pktsize
,

796 
¡
->
pkth
, st->
¬g
);

800 
”r
 = 
EPROTO
;

804  
”r
;

805 
	}
}

	@baresip/modules/avcodec/h263.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<libavcodec/avcodec.h
>

10 #ifdeà
USE_X264


11 
	~<x264.h
>

13 
	~"h26x.h
"

14 
	~"avcodec.h
"

17 
	$h263_hdr_’code
(cÚ¡ 
h263_hdr
 *
hdr
, 
mbuf
 *
mb
)

19 
ušt32_t
 
v
;

21 
v
 = 
hdr
->
f
<<31 | hdr->
p
<<30 | hdr->
sb™
<<27 | hdr->
eb™
<<24;

22 
v
 |ğ
hdr
->
¤c
<<21 | hdr->
i
<<20 | hdr->
u
<<19 | hdr->
s
<<18 | hdr->
a
<<17;

23 
v
 |ğ
hdr
->
r
<<13 | hdr->
dbq
<<11 | hdr->
Œb
<<8 | hdr->
Œ
<<0;

25  
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
v
));

26 
	}
}

29 
h263_mode
 
	$h263_hdr_mode
(cÚ¡ 
h263_hdr
 *
hdr
)

31 ià(!
hdr
->
f
) {

32  
H263_MODE_A
;

35 ià(!
hdr
->
p
)

36  
H263_MODE_B
;

38  
H263_MODE_C
;

40 
	}
}

43 
	$h263_hdr_decode
(
h263_hdr
 *
hdr
, 
mbuf
 *
mb
)

45 
ušt32_t
 
v
;

47 ià(!
hdr
)

48  
EINVAL
;

49 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
H263_HDR_SIZE_MODEA
)

50  
EBADMSG
;

52 
v
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

55 
hdr
->
f
 = 
v
>>31 & 0x1;

56 
hdr
->
p
 = 
v
>>30 & 0x1;

57 
hdr
->
sb™
 = 
v
>>27 & 0x7;

58 
hdr
->
eb™
 = 
v
>>24 & 0x7;

59 
hdr
->
¤c
 = 
v
>>21 & 0x7;

61 
	`h263_hdr_mode
(
hdr
)) {

63 
H263_MODE_A
:

64 
hdr
->
i
 = 
v
>>20 & 0x1;

65 
hdr
->
u
 = 
v
>>19 & 0x1;

66 
hdr
->
s
 = 
v
>>18 & 0x1;

67 
hdr
->
a
 = 
v
>>17 & 0x1;

68 
hdr
->
r
 = 
v
>>13 & 0xf;

69 
hdr
->
dbq
 = 
v
>>11 & 0x3;

70 
hdr
->
Œb
 = 
v
>>8 & 0x7;

71 
hdr
->
Œ
 = 
v
>>0 & 0xff;

74 
H263_MODE_B
:

75 
hdr
->
quªt
 = 
v
>>16 & 0x1f;

76 
hdr
->
gobn
 = 
v
>>11 & 0x1f;

77 
hdr
->
mba
 = 
v
>>2 & 0x1ff;

79 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

80  
EBADMSG
;

82 
v
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

84 
hdr
->
i
 = 
v
>>31 & 0x1;

85 
hdr
->
u
 = 
v
>>30 & 0x1;

86 
hdr
->
s
 = 
v
>>29 & 0x1;

87 
hdr
->
a
 = 
v
>>28 & 0x1;

88 
hdr
->
hmv1
 = 
v
>>21 & 0x7f;

89 
hdr
->
vmv1
 = 
v
>>14 & 0x7f;

90 
hdr
->
hmv2
 = 
v
>>7 & 0x7f;

91 
hdr
->
vmv2
 = 
v
>>0 & 0x7f;

94 
H263_MODE_C
:

96 ià(
	`mbuf_g‘_Ëá
(
mb
) < 8)

97  
EBADMSG
;

99 
v
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

100 
hdr
->
i
 = 
v
>>31 & 0x1;

101 
hdr
->
u
 = 
v
>>30 & 0x1;

102 
hdr
->
s
 = 
v
>>29 & 0x1;

103 
hdr
->
a
 = 
v
>>28 & 0x1;

105 ()
	`mbuf_»ad_u32
(
mb
);

110 
	}
}

121 cÚ¡ 
ušt8_t
 *
	$h263_¡rm_fšd_psc
(cÚ¡ 
ušt8_t
 *
p
, 
ušt32_t
 
size
)

123 cÚ¡ 
ušt8_t
 *
’d
 = 
p
 + 
size
 - 1;

125 ; 
p
 < 
’d
;…++) {

126 ià(
p
[0] == 0x00 &&…[1] == 0x00)

127  
p
;

130  
NULL
;

131 
	}
}

134 
	$h263_¡rm_decode
(
h263_¡rm
 *
s
, 
mbuf
 *
mb
)

136 cÚ¡ 
ušt8_t
 *
p
;

138 ià(
	`mbuf_g‘_Ëá
(
mb
) < 6)

139  
EINVAL
;

141 
p
 = 
	`mbuf_buf
(
mb
);

143 
s
->
psc
[0] = 
p
[0];

144 
s
->
psc
[1] = 
p
[1];

146 
s
->
‹mp_»f
 = (
p
[2]<<6 & 0xc0) | (p[3]>>2 & 0x3f);

148 
s
->
¥l™_sü
 = 
p
[4]>>7 & 0x1;

149 
s
->
doc_ÿm”a
 = 
p
[4]>>6 & 0x1;

150 
s
->
pic_äz_»l
 = 
p
[4]>>5 & 0x1;

151 
s
->
¤c_fmt
 = 
p
[4]>>2 & 0x7;

152 
s
->
pic_ty³
 = 
p
[4]>>1 & 0x1;

153 
s
->
umv
 = 
p
[4]>>0 & 0x1;

155 
s
->
§c
 = 
p
[5]>>7 & 0x1;

156 
s
->
­m
 = 
p
[5]>>6 & 0x1;

157 
s
->
pb
 = 
p
[5]>>5 & 0x1;

158 
s
->
pquªt
 = 
p
[5]>>0 & 0x1f;

160 
s
->
ım
 = 
p
[6]>>7 & 0x1;

161 
s
->
³i
 = 
p
[6]>>6 & 0x1;

164 
	}
}

173 
	$h263_hdr_cİy_¡rm
(
h263_hdr
 *
hdr
, cÚ¡ 
h263_¡rm
 *
s
)

175 
hdr
->
f
 = 0;

176 
hdr
->
p
 = 0;

177 
hdr
->
sb™
 = 0;

178 
hdr
->
eb™
 = 0;

179 
hdr
->
¤c
 = 
s
->
¤c_fmt
;

180 
hdr
->
i
 = 
s
->
pic_ty³
;

181 
hdr
->
u
 = 
s
->
umv
;

182 
hdr
->
s
 = s->
§c
;

183 
hdr
->
a
 = 
s
->
­m
;

184 
hdr
->
r
 = 0;

185 
hdr
->
dbq
 = 0;

186 
hdr
->
Œb
 = 0;

187 
hdr
->
Œ
 = 
s
->
‹mp_»f
;

188 
	}
}

	@baresip/modules/avcodec/h26x.h

13 
	eh263_mode
 {

14 
	mH263_MODE_A
,

15 
	mH263_MODE_B
,

16 
	mH263_MODE_C


20 
	mH263_HDR_SIZE_MODEA
 = 4,

21 
	mH263_HDR_SIZE_MODEB
 = 8,

22 
	mH263_HDR_SIZE_MODEC
 = 12

26 
	eh263_fmt
 {

27 
	mH263_FMT_SQCIF
 = 1,

28 
	mH263_FMT_QCIF
 = 2,

29 
	mH263_FMT_CIF
 = 3,

30 
	mH263_FMT_4CIF
 = 4,

31 
	mH263_FMT_16CIF
 = 5,

32 
	mH263_FMT_OTHER
 = 7,

38 
	sh263_hdr
 {

41 
	mf
:1;

42 
	mp
:1;

43 
	msb™
:3;

44 
	meb™
:3;

45 
	m¤c
:3;

48 
	mi
:1;

49 
	mu
:1;

50 
	ms
:1;

51 
	ma
:1;

52 
	mr
:4;

53 
	mdbq
:2;

54 
	mŒb
:3;

55 
	mŒ
:8;

58 
	mquªt
:5;

59 
	mgobn
:5;

60 
	mmba
:9;

61 
	mhmv1
:7;

62 
	mvmv1
:7;

63 
	mhmv2
:7;

64 
	mvmv2
:7;

69 ’um {
	mI_FRAME
=0, 
	mP_FRAME
=1};

72 
	sh263_¡rm
 {

73 
ušt8_t
 
	mpsc
[2];

75 
ušt8_t
 
	m‹mp_»f
;

76 
	m¥l™_sü
:1;

77 
	mdoc_ÿm”a
:1;

78 
	mpic_äz_»l
:1;

79 
	m¤c_fmt
:3;

80 
	mpic_ty³
:1;

81 
	mumv
:1;

82 
	m§c
:1;

83 
	m­m
:1;

84 
	mpb
:1;

85 
	mpquªt
:5;

86 
	mım
:1;

87 
	m³i
:1;

91 
h263_hdr_’code
(cÚ¡ 
h263_hdr
 *
hdr
, 
mbuf
 *
mb
);

92 
h263_hdr_decode
(
h263_hdr
 *
hdr
, 
mbuf
 *
mb
);

93 
h263_mode
 
h263_hdr_mode
(cÚ¡ 
h263_hdr
 *
hdr
);

95 cÚ¡ 
ušt8_t
 *
h263_¡rm_fšd_psc
(cÚ¡ ušt8_ˆ*
p
, 
ušt32_t
 
size
);

96 
h263_¡rm_decode
(
h263_¡rm
 *
s
, 
mbuf
 *
mb
);

97 
h263_hdr_cİy_¡rm
(
h263_hdr
 *
hdr
, cÚ¡ 
h263_¡rm
 *
s
);

104 
h264_decode_¥rİ_·¿ms
(
AVCodecCÚ‹xt
 *
codec
, 
¶
 *pl);

	@baresip/modules/avformat/avformat.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 
	~<¡ršg.h
>

10 
	~<±h»ad.h
>

11 
	~<».h
>

12 
	~<»m.h
>

13 
	~<b¬es.h
>

14 
	#FF_API_OLD_METADATA
 0

	)

15 
	~<libavfÜm©/avfÜm©.h
>

16 
	~<libavdeviû/avdeviû.h
>

17 
	~<libavcodec/avcodec.h
>

18 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(5<<8)+0)

19 
	~<libavut/pixdesc.h
>

37 #ià
LIBAVCODEC_VERSION_MAJOR
>52 || 
LIBAVCODEC_VERSION_INT
>=((52<<16)+(64<<8))

38 
	#LIBAVCODEC_HAVE_AVMEDIA_TYPES
 1

	)

40 #iâdeà
LIBAVCODEC_HAVE_AVMEDIA_TYPES


41 
	#AVMEDIA_TYPE_VIDEO
 
CODEC_TYPE_VIDEO


	)

45 #ià
LIBAVCODEC_VERSION_INT
 < ((54<<16)+(25<<8)+0)

46 
	#AVCodecID
 
CodecID


	)

47 
	#AV_CODEC_ID_NONE
 
CODEC_ID_NONE


	)

51 #ià
LIBAVUTIL_VERSION_MAJOR
 < 52

52 
	#AV_PIX_FMT_YUV420P
 
PIX_FMT_YUV420P


	)

53 
	#AV_PIX_FMT_YUVJ420P
 
PIX_FMT_YUVJ420P


	)

57 
	svid¤c_¡
 {

58 cÚ¡ 
vid¤c
 *
	mvs
;

59 
±h»ad_t
 
	mth»ad
;

60 
boŞ
 
	mrun
;

61 
AVFÜm©CÚ‹xt
 *
	mic
;

62 
AVCodec
 *
	mcodec
;

63 
AVCodecCÚ‹xt
 *
	mùx
;

64 
AVR©iÚ®
 
	mtime_ba£
;

65 
vidsz
 
	msz
;

66 
vid¤c_äame_h
 *
	mäameh
;

67 *
	m¬g
;

68 
	msšdex
;

69 
	mås
;

73 
vid¤c
 *
	gmod_avf
;

76 
	$de¡ruùÜ
(*
¬g
)

78 
vid¤c_¡
 *
¡
 = 
¬g
;

80 ià(
¡
->
run
) {

81 
¡
->
run
 = 
çl£
;

82 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

85 ià(
¡
->
ùx
 && st->ùx->
codec
)

86 
	`avcodec_şo£
(
¡
->
ùx
);

88 ià(
¡
->
ic
) {

89 #ià
LIBAVFORMAT_VERSION_INT
 >= ((53<<16) + (21<<8) + 0)

90 
	`avfÜm©_şo£_šput
(&
¡
->
ic
);

92 
	`av_şo£_šput_fe
(
¡
->
ic
);

95 
	}
}

98 
	$hªdË_·ck‘
(
vid¤c_¡
 *
¡
, 
AVPack‘
 *
pkt
)

100 
AVF¿me
 *
äame
 = 
NULL
;

101 
vidäame
 
vf
;

102 
vidsz
 
sz
;

103 
i
;

105 ià(
¡
->
codec
) {

106 
gÙ_più
, 
»t
;

108 #ià
LIBAVUTIL_VERSION_INT
 >= ((52<<16)+(20<<8)+100)

109 
äame
 = 
	`av_äame_®loc
();

111 
äame
 = 
	`avcodec_®loc_äame
();

114 #ià
LIBAVCODEC_VERSION_INT
 >= ((57<<16)+(37<<8)+100)

116 
»t
 = 
	`avcodec_£nd_·ck‘
(
¡
->
ùx
, 
pkt
);

117 ià(
»t
 < 0)

118 
out
;

120 
»t
 = 
	`avcodec_»ûive_äame
(
¡
->
ùx
, 
äame
);

121 ià(
»t
 < 0)

122 
out
;

124 
gÙ_più
 = 
Œue
;

126 #–ià
LIBAVCODEC_VERSION_INT
 <= ((52<<16)+(23<<8)+0)

127 
»t
 = 
	`avcodec_decode_video
(
¡
->
ùx
, 
äame
, &
gÙ_più
,

128 
pkt
->
d©a
,…kt->
size
);

130 
»t
 = 
	`avcodec_decode_video2
(
¡
->
ùx
, 
äame
,

131 &
gÙ_più
, 
pkt
);

133 ià(
»t
 < 0 || !
gÙ_più
)

134 
out
;

136 
sz
.
w
 = 
¡
->
ùx
->
width
;

137 
sz
.
h
 = 
¡
->
ùx
->
height
;

140 ià(!
	`vidsz_cmp
(&
sz
, &
¡
->sz)) {

141 
	`šfo
("avformat: size changed: %d x %d ---> %d x %d\n",

142 
¡
->
sz
.
w
, st->sz.
h
, sz.w, sz.h);

143 
¡
->
sz
 = sz;

151 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(5<<8)+0)

152 
äame
->
fÜm©
) {

154 
AV_PIX_FMT_YUV420P
:

155 
AV_PIX_FMT_YUVJ420P
:

156 
vf
.
fmt
 = 
VID_FMT_YUV420P
;

160 
	`w¬nšg
("avformat: decode: bad…ixel format"

162 
äame
->
fÜm©
,

163 
	`av_g‘_pix_fmt_Çme
(
äame
->
fÜm©
));

164 
out
;

167 
vf
.
fmt
 = 
VID_FMT_YUV420P
;

170 
vf
.
size
 = 
sz
;

171 
i
=0; i<4; i++) {

172 
vf
.
d©a
[
i
] = 
äame
->data[i];

173 
vf
.
lšesize
[
i
] = 
äame
->linesize[i];

176 
¡
->
	`äameh
(&
vf
, st->
¬g
);

178 
out
:

179 ià(
äame
) {

180 #ià
LIBAVUTIL_VERSION_INT
 >= ((52<<16)+(20<<8)+100)

181 
	`av_äame_ä“
(&
äame
);

183 
	`av_ä“
(
äame
);

186 
	}
}

189 *
	$»ad_th»ad
(*
d©a
)

191 
vid¤c_¡
 *
¡
 = 
d©a
;

193 
ušt64_t
 
now
, 
ts
 = 
	`tmr_jiff›s
();

195 
¡
->
run
) {

196 
AVPack‘
 
pkt
;

197 
»t
;

199 
	`sys_m¦“p
(4);

200 
now
 = 
	`tmr_jiff›s
();

202 ià(
ts
 > 
now
)

205 
	`av_š™_·ck‘
(&
pkt
);

207 
»t
 = 
	`av_»ad_äame
(
¡
->
ic
, &
pkt
);

208 ià(
»t
 < 0) {

209 
	`debug
("avfÜm©:„ewšd sŒ—m (»t=%d)\n", 
»t
);

210 
	`sys_m¦“p
(1000);

211 
	`av_£ek_äame
(
¡
->
ic
, -1, 0, 0);

215 ià(
pkt
.
¡»am_šdex
 !ğ
¡
->
sšdex
)

216 
out
;

218 
	`hªdË_·ck‘
(
¡
, &
pkt
);

220 
ts
 +ğ(
ušt64_t
è1000 * 
pkt
.
du¿tiÚ
 * 
	`av_q2d
(
¡
->
time_ba£
);

222 
out
:

223 #ià
LIBAVCODEC_VERSION_INT
 >= ((57<<16)+(12<<8)+100)

224 
	`av_·ck‘_uÄef
(&
pkt
);

226 
	`av_ä“_·ck‘
(&
pkt
);

230  
NULL
;

231 
	}
}

234 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

235 
medŸ_ùx
 **
mùx
, 
vid¤c_´m
 *
´m
,

236 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

237 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

238 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

240 #ià
LIBAVFORMAT_VERSION_INT
 < ((52<<16) + (110<<8) + 0)

241 
AVFÜm©P¬am‘”s
 
´ms
;

243 
vid¤c_¡
 *
¡
;

244 
boŞ
 
found_¡»am
 = 
çl£
;

245 
ušt32_t
 
i
;

246 
»t
, 
”r
 = 0;

247 
šput_ås
 = 0;

249 ()
mùx
;

250 ()
”rÜh
;

252 ià(!
¡p
 || !
vs
 || !
´m
 || !
size
 || !
äameh
)

253  
EINVAL
;

255 
	`debug
("avfÜm©:‡Îoødev='%s'\n", 
dev
);

257 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

258 ià(!
¡
)

259  
ENOMEM
;

261 
¡
->
vs
 = vs;

262 
¡
->
sz
 = *
size
;

263 
¡
->
äameh
 = frameh;

264 
¡
->
¬g
 =‡rg;

265 
¡
->
ås
 = 
´m
->fps;

272 #ià
LIBAVFORMAT_VERSION_INT
 >= ((52<<16) + (110<<8) + 0)

273 ()
fmt
;

274 
»t
 = 
	`avfÜm©_İ’_šput
(&
¡
->
ic
, 
dev
, 
NULL
, NULL);

275 ià(
»t
 < 0) {

276 
	`w¬nšg
("avformat:‡vformat_open_input(%s) failed (ret=%d)\n",

277 
dev
, 
»t
);

278 
”r
 = 
ENOENT
;

279 
out
;

284 
	`mem£t
(&
´ms
, 0, (prms));

286 
´ms
.
time_ba£
 = (
AVR©iÚ®
){1, 
´m
->
ås
};

287 
´ms
.
chªÃls
 = 1;

288 
´ms
.
width
 = 
size
->
w
;

289 
´ms
.
height
 = 
size
->
h
;

290 
´ms
.
pix_fmt
 = 
AV_PIX_FMT_YUV420P
;

291 
´ms
.
chªÃl
 = 0;

293 
»t
 = 
	`av_İ’_šput_fe
(&
¡
->
ic
, 
dev
, 
	`av_fšd_šput_fÜm©
(
fmt
),

294 0, &
´ms
);

295 ià(
»t
 < 0) {

296 
	`w¬nšg
("avformat:‡v_open_input_file(%s) failed (ret=%d)\n",

297 
dev
, 
»t
);

298 
”r
 = 
ENOENT
;

299 
out
;

304 #ià
LIBAVFORMAT_VERSION_INT
 >= ((53<<16) + (4<<8) + 0)

305 
»t
 = 
	`avfÜm©_fšd_¡»am_šfo
(
¡
->
ic
, 
NULL
);

307 
»t
 = 
	`av_fšd_¡»am_šfo
(
¡
->
ic
);

310 ià(
»t
 < 0) {

311 
	`w¬nšg
("avfÜm©: %s:‚Ø¡»am info\n", 
dev
);

312 
”r
 = 
ENOENT
;

313 
out
;

317 
	`av_dump_fÜm©
(
¡
->
ic
, 0, 
dev
, 0);

320 
i
=0; i<
¡
->
ic
->
nb_¡»ams
; i++) {

321 cÚ¡ 
AVSŒ—m
 *
¡rm
 = 
¡
->
ic
->
¡»ams
[
i
];

322 
AVCodecCÚ‹xt
 *
ùx
;

323 
dås
;

325 #ià
LIBAVFORMAT_VERSION_INT
 >= ((57<<16) + (33<<8) + 100)

327 
ùx
 = 
	`avcodec_®loc_cÚ‹xt3
(
NULL
);

328 ià(!
ùx
) {

329 
”r
 = 
ENOMEM
;

330 
out
;

333 
»t
 = 
	`avcodec_·¿m‘”s_to_cÚ‹xt
(
ùx
, 
¡rm
->
codeı¬
);

334 ià(
»t
 < 0) {

335 
	`w¬nšg
("avformat:‡vcodec_parameters_to_context\n");

336 
”r
 = 
EPROTO
;

337 
out
;

341 
ùx
 = 
¡rm
->
codec
;

344 ià(
ùx
->
codec_ty³
 !ğ
AVMEDIA_TYPE_VIDEO
)

347 
	`debug
("avformat: stream %u: %u x %u "

349 
i
, 
ùx
->
width
, ctx->
height
,

350 
¡rm
->
time_ba£
.
num
, sŒm->time_ba£.
d’
);

352 
¡
->
sz
.
w
 = 
ùx
->
width
;

353 
¡
->
sz
.
h
 = 
ùx
->
height
;

354 
¡
->
ùx
 = ctx;

355 
¡
->
sšdex
 = 
¡rm
->
šdex
;

356 
¡
->
time_ba£
 = 
¡rm
->time_base;

358 
dås
 = 
	`av_q2d
(
¡rm
->
avg_äame_¿‹
);

359 
šput_ås
 = ()
dås
;

360 ià(
¡
->
ås
 !ğ
šput_ås
) {

361 
	`šfo
("avformat: updating %i fps from configo‚ative "

362 "špuˆm©”ŸÈå %i\n", 
¡
->
ås
, 
šput_ås
);

363 
¡
->
ås
 = 
šput_ås
;

364 #ià
LIBAVFORMAT_VERSION_INT
 < ((52<<16) + (110<<8) + 0)

365 
´ms
.
time_ba£
 = (
AVR©iÚ®
){1, 
¡
->
ås
};

369 ià(
ùx
->
codec_id
 !ğ
AV_CODEC_ID_NONE
) {

371 
¡
->
codec
 = 
	`avcodec_fšd_decod”
(
ùx
->
codec_id
);

372 ià(!
¡
->
codec
) {

373 
”r
 = 
ENOENT
;

374 
out
;

377 #ià
LIBAVCODEC_VERSION_INT
 >= ((53<<16)+(8<<8)+0)

378 
»t
 = 
	`avcodec_İ’2
(
ùx
, 
¡
->
codec
, 
NULL
);

380 
»t
 = 
	`avcodec_İ’
(
ùx
, 
¡
->
codec
);

382 ià(
»t
 < 0) {

383 
”r
 = 
ENOENT
;

384 
out
;

388 
found_¡»am
 = 
Œue
;

392 ià(!
found_¡»am
) {

393 
”r
 = 
ENOENT
;

394 
out
;

397 
¡
->
run
 = 
Œue
;

398 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

399 ià(
”r
) {

400 
¡
->
run
 = 
çl£
;

401 
out
;

404 
out
:

405 ià(
”r
)

406 
	`mem_d”ef
(
¡
);

408 *
¡p
 = 
¡
;

410  
”r
;

411 
	}
}

414 
	$moduË_š™
()

417 
	`avcodec_»gi¡”_®l
();

418 
	`avdeviû_»gi¡”_®l
();

420 #ià
LIBAVFORMAT_VERSION_INT
 >= ((53<<16) + (13<<8) + 0)

421 
	`avfÜm©_ÃtwÜk_š™
();

424 
	`av_»gi¡”_®l
();

426  
	`vid¤c_»gi¡”
(&
mod_avf
, 
	`b¬es_vid¤ş
(),

427 "avfÜm©", 
®loc
, 
NULL
);

428 
	}
}

431 
	$moduË_şo£
()

433 
mod_avf
 = 
	`mem_d”ef
(mod_avf);

435 #ià
LIBAVFORMAT_VERSION_INT
 >= ((53<<16) + (13<<8) + 0)

436 
	`avfÜm©_ÃtwÜk_deš™
();

440 
	}
}

443 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
avfÜm©
) = {

446 
moduË_š™
,

447 
moduË_şo£


	@baresip/modules/b2bua/b2bua.c

6 
	~<».h
>

7 
	~<b¬es.h
>

22 
	s£ssiÚ
 {

23 
Ë
 
	mË
;

24 
ÿÎ
 *
	mÿÎ_š
, *
	mÿÎ_out
;

28 
li¡
 
	g£ssiÚl
;

29 
ua
 *
	gua_š
, *
	gua_out
;

32 
ÿÎ
 *
	$Ùh”_ÿÎ
(
£ssiÚ
 *
£ss
, cÚ¡ 
ÿÎ
 *call)

34 ià(
£ss
->
ÿÎ_š
 =ğ
ÿÎ
è sess->
ÿÎ_out
;

35 ià(
£ss
->
ÿÎ_out
 =ğ
ÿÎ
è sess->
ÿÎ_š
;

37  
NULL
;

38 
	}
}

41 
	$de¡ruùÜ
(*
¬g
)

43 
£ssiÚ
 *
£ss
 = 
¬g
;

45 
	`debug
("b2bua: session destroyed (in=%p, out=%p)\n",

46 
£ss
->
ÿÎ_š
, sess->
ÿÎ_out
);

48 
	`li¡_uÆšk
(&
£ss
->
Ë
);

49 
	`mem_d”ef
(
£ss
->
ÿÎ_out
);

50 
	`mem_d”ef
(
£ss
->
ÿÎ_š
);

51 
	}
}

54 
	$ÿÎ_ev’t_hªdËr
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t
 
ev
,

55 cÚ¡ *
¡r
, *
¬g
)

57 
£ssiÚ
 *
£ss
 = 
¬g
;

58 
ÿÎ
 *
ÿÎ2
 = 
	`Ùh”_ÿÎ
(
£ss
, call);

60 
ev
) {

62 
CALL_EVENT_ESTABLISHED
:

63 
	`debug
("b2bua: CALL_ESTABLISHED:…eer_uri=%s\n",

64 
	`ÿÎ_³”uri
(
ÿÎ
));

65 
	`ua_ªsw”
(
	`ÿÎ_g‘_ua
(
ÿÎ2
), call2);

68 
CALL_EVENT_CLOSED
:

69 
	`debug
("b2bua: CALL_CLOSED: %s\n", 
¡r
);

71 
	`mem_»f
(
ÿÎ2
);

73 
	`ua_hªgup
(
	`ÿÎ_g‘_ua
(
ÿÎ2
), c®l2, 
	`ÿÎ_scode
(
ÿÎ
), "");

74 
	`mem_d”ef
(
£ss
);

80 
	}
}

83 
	$ÿÎ_dtmf_hªdËr
(
ÿÎ
 *ÿÎ, 
key
, *
¬g
)

85 
£ssiÚ
 *
£ss
 = 
¬g
;

87 
	`debug
("b2bua:„–ayšg DTMFƒv’t: key = '%c'\n", 
key
 ? key : '.');

89 
	`ÿÎ_£nd_dig™
(
	`Ùh”_ÿÎ
(
£ss
, 
ÿÎ
), 
key
);

90 
	}
}

93 
	$Ãw_£ssiÚ
(
ÿÎ
 *call)

95 
£ssiÚ
 *
£ss
;

96 
a
[64], 
b
[64];

97 
”r
;

99 
£ss
 = 
	`mem_z®loc
((*£ss), 
de¡ruùÜ
);

100 ià(!
£ss
)

101  
ENOMEM
;

103 
£ss
->
ÿÎ_š
 = 
ÿÎ
;

104 
”r
 = 
	`ua_cÚÃù
(
ua_out
, &
£ss
->
ÿÎ_out
, 
	`ÿÎ_³”uri
(
ÿÎ
),

105 
	`ÿÎ_loÿluri
(
ÿÎ
), 
NULL
,

106 
	`ÿÎ_has_video
(
ÿÎ
è? 
VIDMODE_ON
 : 
VIDMODE_OFF
);

107 ià(
”r
) {

108 
	`w¬nšg
("b2bua: ua_cÚÃù faed (%m)\n", 
”r
);

109 
out
;

112 
	`»_¢´štf
(
a
, ×), "A-%x", 
£ss
);

113 
	`»_¢´štf
(
b
, (b), "B-%x", 
£ss
);

116 
	`audio_£t_deviûÇme
(
	`ÿÎ_audio
(
£ss
->
ÿÎ_š
), 
a
, 
b
);

117 
	`audio_£t_deviûÇme
(
	`ÿÎ_audio
(
£ss
->
ÿÎ_out
), 
b
, 
a
);

118 
	`video_£t_deviûÇme
(
	`ÿÎ_video
(
£ss
->
ÿÎ_š
), 
a
, 
b
);

119 
	`video_£t_deviûÇme
(
	`ÿÎ_video
(
£ss
->
ÿÎ_out
), 
b
, 
a
);

121 
	`ÿÎ_£t_hªdËrs
(
£ss
->
ÿÎ_š
, 
ÿÎ_ev’t_hªdËr
,

122 
ÿÎ_dtmf_hªdËr
, 
£ss
);

123 
	`ÿÎ_£t_hªdËrs
(
£ss
->
ÿÎ_out
, 
ÿÎ_ev’t_hªdËr
,

124 
ÿÎ_dtmf_hªdËr
, 
£ss
);

126 
	`li¡_­³nd
(&
£ssiÚl
, &
£ss
->
Ë
, sess);

128 
out
:

129 ià(
”r
)

130 
	`mem_d”ef
(
£ss
);

132  
”r
;

133 
	}
}

136 
	$ua_ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

137 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

139 
”r
;

140 ()
´m
;

141 ()
¬g
;

143 
ev
) {

145 
UA_EVENT_CALL_INCOMING
:

146 
	`debug
("b2bua: CALL_INCOMING:…eer=%s -->†ocal=%s\n",

147 
	`ÿÎ_³”uri
(
ÿÎ
), 
	`ÿÎ_loÿluri
(call));

149 
”r
 = 
	`Ãw_£ssiÚ
(
ÿÎ
);

150 ià(
”r
) {

151 
	`ua_hªgup
(
ua
, 
ÿÎ
, 500, "Server Error");

158 
	}
}

161 
	$b2bua_¡©us
(
»_´štf
 *
pf
, *
¬g
)

163 
Ë
 *le;

164 
”r
 = 0;

165 ()
¬g
;

167 
”r
 |ğ
	`»_h´štf
(
pf
, "B2BUA status:\n");

168 
”r
 |ğ
	`»_h´štf
(
pf
, " inbound: %s\n", 
	`ua_aÜ
(
ua_š
));

169 
”r
 |ğ
	`»_h´štf
(
pf
, " outbound: %s\n", 
	`ua_aÜ
(
ua_out
));

171 
”r
 |ğ
	`»_h´štf
(
pf
, "sessions:\n");

173 
Ë
 = 
£ssiÚl
.
h—d
;†e;†ğË->
Ãxt
) {

175 
£ssiÚ
 *
£ss
 = 
Ë
->
d©a
;

177 
”r
 |ğ
	`»_h´štf
(
pf
, "%-42s ---> %42s\n",

178 
	`ÿÎ_³”uri
(
£ss
->
ÿÎ_š
),

179 
	`ÿÎ_³”uri
(
£ss
->
ÿÎ_out
));

181 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
ÿÎ_¡©us
, 
£ss
->
ÿÎ_š
);

182 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
ÿÎ_¡©us
, 
£ss
->
ÿÎ_out
);

185  
”r
;

186 
	}
}

189 cÚ¡ 
cmd
 
	gcmdv
[] = {

190 {"b2bua", 0, 0, "b2bu¨¡©us", 
b2bua_¡©us
 },

194 
	$moduË_š™
()

196 
”r
;

198 
ua_š
 = 
	`uag_fšd_·¿m
("b2bua", "inbound");

199 
ua_out
 = 
	`uag_fšd_·¿m
("b2bua", "outbound");

201 ià(!
ua_š
) {

202 
	`w¬nšg
("b2bua: inbound UA‚ot found\n");

203  
ENOENT
;

205 ià(!
ua_out
) {

206 
	`w¬nšg
("b2bua: outbound UA‚ot found\n");

207  
ENOENT
;

210 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

211 ià(
”r
)

212  
”r
;

214 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, 0);

215 ià(
”r
)

216  
”r
;

218 
	`debug
("b2bua: module†oaded\n");

221 
	}
}

224 
	$moduË_şo£
()

226 
	`debug
("b2bua: module closing..\n");

228 ià(!
	`li¡_i£m±y
(&
£ssiÚl
)) {

230 
	`šfo
("b2bua: flushšg %u sessiÚs\n", 
	`li¡_couÁ
(&
£ssiÚl
));

231 
	`li¡_æush
(&
£ssiÚl
);

234 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

235 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

238 
	}
}

241 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
b2bua
) = {

244 
moduË_š™
,

245 
moduË_şo£


	@baresip/modules/bv32/bv32.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<bv32/bv32.h
>

9 
	~<bv32/b™·ck.h
>

21 
	mNSAMP
 = 80,

22 
	mCODED_OCTETS
 = 20

26 
	sau’c_¡©e
 {

27 
BV32_Encod”_S‹
 
	mcs
;

28 
BV32_B™_SŒ—m
 
	mbsc
;

31 
	saudec_¡©e
 {

32 
BV32_Decod”_S‹
 
	mds
;

33 
BV32_B™_SŒ—m
 
	mbsd
;

37 
	$’code_de¡ruùÜ
(*
¬g
)

39 
au’c_¡©e
 *
¡
 = 
¬g
;

41 
	`Re£t_BV32_Cod”
(&
¡
->
cs
);

42 
	}
}

45 
	$decode_de¡ruùÜ
(*
¬g
)

47 
audec_¡©e
 *
¡
 = 
¬g
;

49 
	`Re£t_BV32_Decod”
(&
¡
->
ds
);

50 
	}
}

53 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

54 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

56 
au’c_¡©e
 *
¡
;

57 ()
´m
;

58 ()
fm
;

60 ià(!
«¥
 || !
ac
)

61  
EINVAL
;

63 ià(*
«¥
)

66 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

67 ià(!
¡
)

68  
ENOMEM
;

70 
	`Re£t_BV32_Cod”
(&
¡
->
cs
);

72 *
«¥
 = 
¡
;

75 
	}
}

78 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

79 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

81 
audec_¡©e
 *
¡
;

82 ()
fm
;

84 ià(!
ad¥
 || !
ac
)

85  
EINVAL
;

87 ià(*
ad¥
)

90 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

91 ià(!
¡
)

92  
ENOMEM
;

94 
	`Re£t_BV32_Decod”
(&
¡
->
ds
);

96 *
ad¥
 = 
¡
;

99 
	}
}

102 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

103 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

105 
size_t
 
i
, 
näame
;

107 
näame
 = 
§mpc
 / 
NSAMP
;

109 ià(*
Ën
 < 
näame
 * 
CODED_OCTETS
)

110  
ENOMEM
;

112 
i
=0; i<
näame
; i++) {

113 
	`BV32_Encode
(&
¡
->
bsc
, &¡->
cs
, (*)&
§mpv
[
i
*
NSAMP
]);

114 
	`BV32_B™Pack
((*)&
buf
[
i
*
CODED_OCTETS
], &
¡
->
bsc
);

117 *
Ën
 = 
CODED_OCTETS
 * 
näame
;

120 
	}
}

123 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

124 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

126 
size_t
 
i
, 
näame
;

128 
näame
 = 
Ën
 / 
CODED_OCTETS
;

130 ià(*
§mpc
 < 
NSAMP
*
näame
)

131  
ENOMEM
;

133 
i
=0; i<
näame
; i++) {

134 
	`BV32_B™UnPack
((*)&
buf
[
i
*
CODED_OCTETS
], &
¡
->
bsd
);

135 
	`BV32_Decode
(&
¡
->
bsd
, &¡->
ds
, (*)&
§mpv
[
i
*
NSAMP
]);

138 *
§mpc
 = 
NSAMP
 * 
näame
;

141 
	}
}

144 
	$¶c
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

146 
	`BV32_PLC
(&
¡
->
ds
, 
§mpv
);

147 *
§mpc
 = 
NSAMP
;

150 
	}
}

153 
aucodec
 
	gbv32
 = {

154 
LE_INIT
, 0, "BV32", 16000, 16000, 1, 
NULL
,

155 
’code_upd©e
, 
’code
,

156 
decode_upd©e
, 
decode
, 
¶c
,

157 
NULL
, NULL

161 
	$moduË_š™
()

163 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
bv32
);

165 
	}
}

168 
	$moduË_şo£
()

170 
	`aucodec_uÄegi¡”
(&
bv32
);

172 
	}
}

175 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
bv32
) = {

178 
moduË_š™
,

179 
moduË_şo£


	@baresip/modules/cairo/cairo.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 
	~<±h»ad.h
>

10 
	~<m©h.h
>

11 
	~<».h
>

12 
	~<»m.h
>

13 
	~<b¬es.h
>

14 
	~<ÿœo/ÿœo.h
>

17 #ià!
defšed
 (
M_PI
)

18 
	#M_PI
 3.14159265358979323846264338327

	)

35 
	mFONT_SIZE
 = 18

38 
	svid¤c_¡
 {

39 cÚ¡ 
vid¤c
 *
	mvs
;

41 
vid¤c_´m
 
	m´m
;

42 
vidsz
 
	msize
;

43 
ÿœo_surçû_t
 *
	msurçû
;

44 
ÿœo_t
 *
	mü
;

45 
ÿœo_surçû_t
 *
	msurçû_logo
;

46 
ÿœo_t
 *
	mü_logo
;

47 
	mlogo_width
;

48 
	mlogo_height
;

49 
	m¡•
;

50 
boŞ
 
	mrun
;

51 
±h»ad_t
 
	mth»ad
;

52 
vid¤c_äame_h
 *
	mäameh
;

53 *
	m¬g
;

57 
vid¤c
 *
	gvid¤c
;

60 
	$de¡ruùÜ
(*
¬g
)

62 
vid¤c_¡
 *
¡
 = 
¬g
;

64 ià(
¡
->
run
) {

65 
¡
->
run
 = 
çl£
;

66 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

69 ià(
¡
->
ü
)

70 
	`ÿœo_de¡roy
(
¡
->
ü
);

71 ià(
¡
->
surçû
)

72 
	`ÿœo_surçû_de¡roy
(
¡
->
surçû
);

74 ià(
¡
->
ü_logo
)

75 
	`ÿœo_de¡roy
(
¡
->
ü_logo
);

76 ià(
¡
->
surçû_logo
)

77 
	`ÿœo_surçû_de¡roy
(
¡
->
surçû_logo
);

78 
	}
}

81 
	$d¿w_background
(
ÿœo_t
 *
ü
, 
cŞÜ_¡•
,

82 
width
, 
height
)

84 
ÿœo_·‰”n_t
 *
·t
;

85 
g»y
, 
r
, 
g
, 
b
;

87 
g»y
 = 0.1 + 
	`çbs
(
	`sš
(3 * 
cŞÜ_¡•
));

88 
r
 = 
g»y
;

89 
g
 = 
g»y
;

90 
b
 = 
g»y
;

92 
·t
 = 
	`ÿœo_·‰”n_ü—‹_lš—r
 (0.0, 0.0, 0.0, 
height
);

93 
	`ÿœo_·‰”n_add_cŞÜ_¡İ_rgba
 (
·t
, 1, 
r
, 
g
, 
b
, 1);

94 
	`ÿœo_·‰”n_add_cŞÜ_¡İ_rgba
 (
·t
, 0, 0, 0, 0, 1);

95 
	`ÿœo_»ùªgË
 (
ü
, 0, 0, 
width
, 
height
);

96 
	`ÿœo_£t_sourû
 (
ü
, 
·t
);

97 
	`ÿœo_fl
 (
ü
);

98 
	`ÿœo_·‰”n_de¡roy
 (
·t
);

99 
	}
}

102 
	$d¿w_‹xt
(
vid¤c_¡
 *
¡
, 
x
, 
y
,

103 cÚ¡ *
fmt
, ...)

105 
buf
[4096] = "";

106 
va_li¡
 
­
;

108 
	`va_¡¬t
(
­
, 
fmt
);

109 ()
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

110 
	`va_’d
(
­
);

112 
	`ÿœo_£t_sourû_rgb
(
¡
->
ü
, 1.0, 1.0, 1.0);

114 
	`ÿœo_£t_fÚt_size
(
¡
->
ü
, 
FONT_SIZE
);

115 
	`ÿœo_move_to
(
¡
->
ü
, 
x
, 
y
);

116 
	`ÿœo_show_‹xt
(
¡
->
ü
, 
buf
);

117 
	}
}

120 
	$d¿w_logo
(
vid¤c_¡
 *
¡
)

122 
x
, 
y
;

124 
x
 = (
¡
->
size
.
w
 - st->
logo_width
è* (
	`sš
(10 * st->
¡•
) + 1)/2;

125 
y
 = (
¡
->
size
.
h
 - st->
logo_height
)* (1 - 
	`çbs
(
	`sš
(30 * st->
¡•
)));

127 
	`ÿœo_£t_sourû_surçû
(
¡
->
ü
, st->
surçû_logo
, 
x
, 
y
);

128 
	`ÿœo_·št
(
¡
->
ü
);

129 
	}
}

132 
	$´oûss
(
vid¤c_¡
 *
¡
)

134 
vidäame
 
f
;

135 
xoffs
 = 2, 
yoffs
 = 24;

137 
	`d¿w_background
(
¡
->
ü
, st->
¡•
, st->
size
.
w
, st->size.
h
);

139 
	`d¿w_‹xt
(
¡
, 
xoffs
, 
yoffs
 + 
FONT_SIZE
, "%H", 
fmt_gmtime
, 
NULL
);

141 
	`d¿w_‹xt
(
¡
, 
xoffs
, 
yoffs
 + 
FONT_SIZE
*2, "%u x %u @ %d fps",

142 
¡
->
size
.
w
, st->size.
h
, st->
´m
.
ås
);

144 
	`d¿w_logo
(
¡
);

146 
¡
->
¡•
 +ğ0.02 / st->
´m
.
ås
;

148 
	`vidäame_š™_buf
(&
f
, 
VID_FMT_RGB32
, &
¡
->
size
,

149 
	`ÿœo_image_surçû_g‘_d©a
(
¡
->
surçû
));

151 
¡
->
	`äameh
(&
f
, st->
¬g
);

152 
	}
}

155 *
	$»ad_th»ad
(*
¬g
)

157 
vid¤c_¡
 *
¡
 = 
¬g
;

158 
ušt64_t
 
ts
 = 0;

160 
¡
->
run
) {

162 
ušt64_t
 
now
;

164 
	`sys_m¦“p
(2);

166 
now
 = 
	`tmr_jiff›s
();

167 ià(!
ts
)

168 
ts
 = 
now
;

170 ià(
ts
 > 
now
)

173 
	`´oûss
(
¡
);

175 
ts
 +ğ1000/
¡
->
´m
.
ås
;

178  
NULL
;

179 
	}
}

182 
	$lßd_logo
(
vid¤c_¡
 *
¡
, cÚ¡ *
f’ame
)

184 
ÿœo_surçû_t
 *
logo
;

185 
lw
;

186 
sÿË
;

187 
”r
 = 0;

189 
logo
 = 
	`ÿœo_image_surçû_ü—‹_äom_²g
(
f’ame
);

190 ià(!
logo
) {

191 
	`w¬nšg
("cairo: failedo†oad PNG†ogo\n");

192 
”r
 = 
ENOENT
;

193 
out
;

196 ià(!
	`ÿœo_image_surçû_g‘_width
(
logo
) ||

197 !
	`ÿœo_image_surçû_g‘_height
(
logo
)) {

198 
	`w¬nšg
("ÿœo: inv®id†ogØ(%s)\n", 
f’ame
);

199 
”r
 = 
ENOENT
;

200 
out
;

203 
¡
->
logo_width
 = st->
size
.
w
 / 2;

204 
lw
 = 
	`ÿœo_image_surçû_g‘_width
(
logo
);

205 
sÿË
 = ()
¡
->
logo_width
 / ()
lw
;

207 
¡
->
logo_height
 = 
	`ÿœo_image_surçû_g‘_height
(
logo
è* 
sÿË
;

211 
¡
->
surçû_logo
 = 
	`ÿœo_image_surçû_ü—‹
(
CAIRO_FORMAT_ARGB32
,

212 
¡
->
logo_width
,

213 
¡
->
logo_height
);

214 ià(!
¡
->
surçû_logo
) {

215 
”r
 = 
ENOMEM
;

216 
out
;

219 
¡
->
ü_logo
 = 
	`ÿœo_ü—‹
(¡->
surçû_logo
);

220 ià(!
¡
->
ü_logo
) {

221 
”r
 = 
ENOMEM
;

222 
out
;

225 
	`ÿœo_sÿË
(
¡
->
ü_logo
, 
sÿË
, scale);

227 
	`ÿœo_£t_sourû_surçû
(
¡
->
ü_logo
, 
logo
, 0, 0);

228 
	`ÿœo_·št
(
¡
->
ü_logo
);

230 
	`šfo
("cairo: scaling†ogo '%s' from %d x %do %f x %f\n",

231 
f’ame
,

232 
	`ÿœo_image_surçû_g‘_width
(
logo
),

233 
	`ÿœo_image_surçû_g‘_height
(
logo
),

234 
¡
->
logo_width
,

235 
¡
->
logo_height
);

237 
out
:

238 ià(
logo
)

239 
	`ÿœo_surçû_de¡roy
(
logo
);

240  
”r
;

241 
	}
}

244 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

245 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

246 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

247 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

248 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

250 
cÚfig
 *
cfg
;

251 
vid¤c_¡
 *
¡
;

252 
logo
[256];

253 
”r
 = 0;

255 ()
ùx
;

256 ()
fmt
;

257 ()
dev
;

258 ()
”rÜh
;

260 ià(!
¡p
 || !
´m
 || !
size
 || !
äameh
)

261  
EINVAL
;

263 
cfg
 = 
	`cÚf_cÚfig
();

264 ià(!
cfg
)

265  
EINVAL
;

267 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

268 ià(!
¡
)

269  
ENOMEM
;

271 
¡
->
vs
 = vs;

272 
¡
->
äameh
 = frameh;

273 
¡
->
¬g
 =‡rg;

274 
¡
->
´m
 = *prm;

275 
¡
->
size
 = *size;

277 
¡
->
surçû
 = 
	`ÿœo_image_surçû_ü—‹
(
CAIRO_FORMAT_ARGB32
,

278 
size
->
w
, size->
h
);

279 ià(!
¡
->
surçû
) {

280 
”r
 = 
ENOMEM
;

281 
out
;

284 
¡
->
ü
 = 
	`ÿœo_ü—‹
(¡->
surçû
);

285 ià(!
¡
->
ü
) {

286 
”r
 = 
ENOMEM
;

287 
out
;

290 
	`ÿœo_£Ëù_fÚt_çû
(
¡
->
ü
, "Sans",

291 
CAIRO_FONT_SLANT_NORMAL
,

292 
CAIRO_FONT_WEIGHT_BOLD
);

294 
	`šfo
("cairo: surface with format %d (%d x %d) stride=%d\n",

295 
	`ÿœo_image_surçû_g‘_fÜm©
(
¡
->
surçû
),

296 
	`ÿœo_image_surçû_g‘_width
(
¡
->
surçû
),

297 
	`ÿœo_image_surçû_g‘_height
(
¡
->
surçû
),

298 
	`ÿœo_image_surçû_g‘_¡ride
(
¡
->
surçû
));

300 
¡
->
¡•
 = 
	`¿nd_u16
() / 1000.0;

302 
	`»_¢´štf
(
logo
, Öogo), "%s/logo.²g", 
cfg
->
audio
.
audio_·th
);

304 
”r
 = 
	`lßd_logo
(
¡
, 
logo
);

305 ià(
”r
) {

306 
out
;

309 
¡
->
run
 = 
Œue
;

310 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

311 ià(
”r
) {

312 
¡
->
run
 = 
çl£
;

313 
out
;

316 
out
:

317 ià(
”r
)

318 
	`mem_d”ef
(
¡
);

320 *
¡p
 = 
¡
;

322  
”r
;

323 
	}
}

326 
	$moduË_š™
()

328  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

329 "ÿœo", 
®loc
, 
NULL
);

330 
	}
}

333 
	$moduË_şo£
()

335 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

337 
	}
}

340 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
ÿœo
) = {

343 
moduË_š™
,

344 
moduË_şo£


	@baresip/modules/codec2/codec2.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<codec2/codec2.h
>

22 
	mCODEC2_MODE
 = 
CODEC2_MODE_2400


26 
	sau’c_¡©e
 {

27 
CODEC2
 *
	mc2
;

30 
	saudec_¡©e
 {

31 
CODEC2
 *
	mc2
;

35 
	$’code_de¡ruùÜ
(*
d©a
)

37 
au’c_¡©e
 *
¡
 = 
d©a
;

39 ià(
¡
->
c2
)

40 
	`codec2_de¡roy
(
¡
->
c2
);

41 
	}
}

44 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

45 cÚ¡ 
aucodec
 *
ac
,

46 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

48 
au’c_¡©e
 *
¡
;

49 
”r
 = 0;

50 ()
´m
;

51 ()
fm
;

53 ià(!
«¥
 || !
ac
)

54  
EINVAL
;

56 ià(*
«¥
)

59 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

60 ià(!
¡
)

61  
ENOMEM
;

63 
¡
->
c2
 = 
	`codec2_ü—‹
(
CODEC2_MODE
);

64 ià(!
¡
->
c2
) {

65 
”r
 = 
ENOMEM
;

66 
out
;

69 
	`šfo
("codec2: %d samples…er frame, %d bits…er frame\n",

70 
	`codec2_§m¶es_³r_äame
(
¡
->
c2
),

71 
	`codec2_b™s_³r_äame
(
¡
->
c2
));

73 
out
:

74 ià(
”r
)

75 
	`mem_d”ef
(
¡
);

77 *
«¥
 = 
¡
;

79  
”r
;

80 
	}
}

83 
	$decode_de¡ruùÜ
(*
d©a
)

85 
audec_¡©e
 *
¡
 = 
d©a
;

87 ià(
¡
->
c2
)

88 
	`codec2_de¡roy
(
¡
->
c2
);

89 
	}
}

92 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

93 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

95 
audec_¡©e
 *
¡
;

96 
”r
 = 0;

97 ()
fm
;

99 ià(!
ad¥
 || !
ac
)

100  
EINVAL
;

102 ià(*
ad¥
)

105 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

106 ià(!
¡
)

107  
ENOMEM
;

109 
¡
->
c2
 = 
	`codec2_ü—‹
(
CODEC2_MODE
);

110 ià(!
¡
->
c2
) {

111 
”r
 = 
ENOMEM
;

112 
out
;

115 
out
:

116 ià(
”r
)

117 
	`mem_d”ef
(
¡
);

119 *
ad¥
 = 
¡
;

121  
”r
;

122 
	}
}

125 
	$’code
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
,

126 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

128 ià(!
buf
 || !
Ën
 || !
§mpv
)

129  
EINVAL
;

131 ià(*
Ën
 < (
size_t
)
	`codec2_b™s_³r_äame
(
«s
->
c2
)/8)

132  
ENOMEM
;

133 ià(
§mpc
 !ğ(
size_t
)
	`codec2_§m¶es_³r_äame
(
«s
->
c2
))

134  
EPROTO
;

136 
	`codec2_’code
(
«s
->
c2
, 
buf
, (*)
§mpv
);

138 *
Ën
 = 
	`codec2_b™s_³r_äame
(
«s
->
c2
)/8;

141 
	}
}

144 
	$decode
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
,

145 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

147 ià(!
§mpv
 || !
§mpc
 || !
buf
)

148  
EINVAL
;

150 ià(*
§mpc
 < (
size_t
)
	`codec2_§m¶es_³r_äame
(
ads
->
c2
))

151  
ENOMEM
;

152 ià(
Ën
 < (
size_t
)
	`codec2_b™s_³r_äame
(
ads
->
c2
)/8)

153  
EPROTO
;

155 
	`codec2_decode
(
ads
->
c2
, 
§mpv
, 
buf
);

157 *
§mpc
 = 
	`codec2_§m¶es_³r_äame
(
ads
->
c2
);

160 
	}
}

163 
aucodec
 
	gcodec2
 = {

164 
LE_INIT
,

165 
NULL
,

170 
NULL
,

171 
’code_upd©e
,

172 
’code
,

173 
decode_upd©e
,

174 
decode
,

175 
NULL
,

176 
NULL
,

177 
NULL


181 
	$moduË_š™
()

183 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
codec2
);

186 
	}
}

189 
	$moduË_şo£
()

191 
	`aucodec_uÄegi¡”
(&
codec2
);

194 
	}
}

197 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
codec2
) = {

200 
moduË_š™
,

201 
moduË_şo£
,

	@baresip/modules/cons/cons.c

6 
	~<».h
>

7 
	~<b¬es.h
>

34 ’um {
	mCONS_PORT
 = 5555};

36 
	sui_¡
 {

37 
udp_sock
 *
	mus
;

38 
tı_sock
 *
	mts
;

39 
tı_cÚn
 *
	mtc
;

40 
§
 
	mudp_³”
;

44 
ui_¡
 *
	gcÚs
 = 
NULL
;

47 
	$´št_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

49  
	`mbuf_wr™e_mem
(
¬g
, (
ušt8_t
 *)
p
, 
size
);

50 
	}
}

53 
	$udp_»cv
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

55 
ui_¡
 *
¡
 = 
¬g
;

56 
mbuf
 *
mbr
 = 
	`mbuf_®loc
(64);

57 
»_´štf
 
pf
;

59 
¡
->
udp_³”
 = *
¤c
;

61 
pf
.
vph
 = 
´št_hªdËr
;

62 
pf
.
¬g
 = 
mbr
;

64 
	`mbuf_g‘_Ëá
(
mb
)) {

65 
ch
 = 
	`mbuf_»ad_u8
(
mb
);

67 ià(
ch
 == '\r')

68 
ch
 = '\n';

70 
	`ui_šput_key
(
	`b¬es_uis
(), 
ch
, &
pf
);

73 ià(
mbr
->
’d
 > 0) {

74 
mbr
->
pos
 = 0;

75 ()
	`udp_£nd
(
¡
->
us
, 
¤c
, 
mbr
);

78 
	`mem_d”ef
(
mbr
);

79 
	}
}

82 
	$cÚs_de¡ruùÜ
(*
¬g
)

84 
ui_¡
 *
¡
 = 
¬g
;

86 
	`mem_d”ef
(
¡
->
us
);

87 
	`mem_d”ef
(
¡
->
tc
);

88 
	`mem_d”ef
(
¡
->
ts
);

89 
	}
}

92 
	$tı_wr™e_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

94 
mbuf
 
mb
;

96 
mb
.
buf
 = (
ušt8_t
 *)
p
;

97 
mb
.
pos
 = 0;

98 
mb
.
’d
 = mb.
size
 = size;

100  
	`tı_£nd
(
¬g
, &
mb
);

101 
	}
}

104 
	$tı_»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

106 
ui_¡
 *
¡
 = 
¬g
;

107 
»_´štf
 
pf
;

109 
pf
.
vph
 = 
tı_wr™e_hªdËr
;

110 
pf
.
¬g
 = 
¡
->
tc
;

112 
	`mbuf_g‘_Ëá
(
mb
) > 0) {

114 
ch
 = 
	`mbuf_»ad_u8
(
mb
);

116 ià(
ch
 == '\r')

117 
ch
 = '\n';

119 
	`ui_šput_key
(
	`b¬es_uis
(), 
ch
, &
pf
);

121 
	}
}

124 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

126 
ui_¡
 *
¡
 = 
¬g
;

128 ()
”r
;

130 
¡
->
tc
 = 
	`mem_d”ef
(st->tc);

131 
	}
}

134 
	$tı_cÚn_hªdËr
(cÚ¡ 
§
 *
³”
, *
¬g
)

136 
ui_¡
 *
¡
 = 
¬g
;

138 ()
³”
;

141 
¡
->
tc
 = 
	`mem_d”ef
(st->tc);

142 ()
	`tı_acû±
(&
¡
->
tc
, st->
ts
, 
NULL
, 
tı_»cv_hªdËr
,

143 
tı_şo£_hªdËr
, 
¡
);

144 
	}
}

147 
	$cÚs_®loc
(
ui_¡
 **
¡p
, cÚ¡ 
§
 *
Ïddr
)

149 
ui_¡
 *
¡
;

150 
”r
;

152 ià(!
¡p
)

153  
EINVAL
;

155 
¡
 = 
	`mem_z®loc
((*¡), 
cÚs_de¡ruùÜ
);

156 ià(!
¡
)

157  
ENOMEM
;

159 
”r
 = 
	`udp_li¡’
(&
¡
->
us
, 
Ïddr
, 
udp_»cv
, st);

160 ià(
”r
) {

161 
	`w¬nšg
("cons: failedo†isten on UDP %J (%m)\n",

162 
Ïddr
, 
”r
);

163 
out
;

166 
”r
 = 
	`tı_li¡’
(&
¡
->
ts
, 
Ïddr
, 
tı_cÚn_hªdËr
, st);

167 ià(
”r
) {

168 
	`w¬nšg
("cons: failedo†isten on TCP %J (%m)\n",

169 
Ïddr
, 
”r
);

170 
out
;

173 
	`debug
("cÚs: UI cÚsŞli¡’šg oÀ%J\n", 
Ïddr
);

175 
out
:

176 ià(
”r
)

177 
	`mem_d”ef
(
¡
);

179 *
¡p
 = 
¡
;

181  
”r
;

182 
	}
}

185 
	$ouut_hªdËr
(cÚ¡ *
¡r
)

187 
mbuf
 *
mb
;

188 
”r
 = 0;

190 ià(!
¡r
)

191  
EINVAL
;

193 
mb
 = 
	`mbuf_®loc
(256);

194 ià(!
mb
)

195  
ENOMEM
;

197 
	`mbuf_wr™e_¡r
(
mb
, 
¡r
);

199 ià(
	`§_is£t
(&
cÚs
->
udp_³”
, 
SA_ALL
)) {

200 
mb
->
pos
 = 0;

201 
”r
 |ğ
	`udp_£nd
(
cÚs
->
us
, &cÚs->
udp_³”
, 
mb
);

204 ià(
cÚs
->
tc
) {

205 
mb
->
pos
 = 0;

206 
”r
 |ğ
	`tı_£nd
(
cÚs
->
tc
, 
mb
);

209 
	`mem_d”ef
(
mb
);

211  
”r
;

212 
	}
}

218 
	$log_hªdËr
(
ušt32_t
 
Ëv–
, cÚ¡ *
msg
)

220 ()
Ëv–
;

222 
	`ouut_hªdËr
(
msg
);

223 
	}
}

226 
ui
 
	gui_cÚs
 = {

227 
LE_INIT
,

229 
ouut_hªdËr


233 
log
 
	glg
 = {

234 .
h
 = 
log_hªdËr
,

238 
	$cÚs_š™
()

240 
§
 
Ïddr
;

241 
”r
;

243 ià(
	`cÚf_g‘_§
(
	`cÚf_cur
(), "cÚs_li¡’", &
Ïddr
)) {

244 
	`§_£t_¡r
(&
Ïddr
, "0.0.0.0", 
CONS_PORT
);

247 
”r
 = 
	`cÚs_®loc
(&
cÚs
, &
Ïddr
);

248 ià(
”r
)

249  
”r
;

251 
	`ui_»gi¡”
(
	`b¬es_uis
(), &
ui_cÚs
);

253 
	`log_»gi¡”_hªdËr
(&
lg
);

256 
	}
}

259 
	$cÚs_şo£
()

261 
	`log_uÄegi¡”_hªdËr
(&
lg
);

263 
	`ui_uÄegi¡”
(&
ui_cÚs
);

264 
cÚs
 = 
	`mem_d”ef
(cons);

266 
	}
}

269 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
cÚs
) = {

272 
cÚs_š™
,

273 
cÚs_şo£


	@baresip/modules/contact/contact.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

21 cÚ¡ *
	gch©_³”
;

22 
	gcmd_desc
[128] = "Send MESSAGEo…eer";

25 
	$cÚæše_hªdËr
(cÚ¡ 
¶
 *
addr
, *
¬g
)

27 
cÚùs
 *cÚù ğ
¬g
;

28  
	`cÚù_add
(
cÚùs
, 
NULL
, 
addr
);

29 
	}
}

32 
	$cmd_cÚù
(
»_´štf
 *
pf
, *
¬g
)

34 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

35 
cÚùs
 *cÚù ğ
	`b¬es_cÚùs
();

36 
cÚù
 *
út
 = 
NULL
;

37 
¶
 
dÇme
, 
u£r
,…l;

38 
Ë
 *le;

39 
”r
 = 0;

41 
	`¶_£t_¡r
(&
¶
, 
ÿrg
->
´m
);

43 
dÇme
.
l
 = 
u£r
.Èğ
¶
.l;

45 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

47 
Ë
 = 
	`li¡_h—d
(
	`cÚù_li¡
(
cÚùs
));†e;†ğË->
Ãxt
) {

49 
cÚù
 *
c
 = 
Ë
->
d©a
;

51 
dÇme
.
p
 = 
	`cÚù_addr
(
c
)->dname.p;

52 
u£r
.
p
 = 
	`cÚù_addr
(
c
)->
uri
.user.p;

57 ià(
dÇme
.
p
) {

59 ià(0 =ğ
	`¶_ÿ£cmp
(&
dÇme
, &
¶
)) {

60 
”r
 |ğ
	`»_h´štf
(
pf
, "%s\n", 
	`cÚù_¡r
(
c
));

61 
út
 = 
c
;

64 ià(
u£r
.
p
) {

66 ià(0 =ğ
	`¶_ÿ£cmp
(&
u£r
, &
¶
)) {

67 
”r
 |ğ
	`»_h´štf
(
pf
, "%s\n", 
	`cÚù_¡r
(
c
));

68 
út
 = 
c
;

73 ià(!
út
)

74 
”r
 |ğ
	`»_h´štf
(
pf
, "(no matches)\n");

76 ià(
ÿrg
->
com¶‘e
 && 
út
) {

78 
ÿrg
->
key
) {

81 
”r
 = 
	`ua_cÚÃù
(
	`uag_cu¼’t
(), 
NULL
, NULL,

82 
	`cÚù_¡r
(
út
), 
NULL
, 
VIDMODE_ON
);

83 ià(
”r
) {

84 
	`w¬nšg
("contact: ua_connect failed: %m\n",

85 
”r
);

90 
ch©_³”
 = 
	`cÚù_¡r
(
út
);

91 ()
	`»_h´štf
(
pf
, "Selected chat…eer: %s\n",

92 
ch©_³”
);

93 
	`»_¢´štf
(
cmd_desc
, (cmd_desc),

94 "S’d MESSAGEØ%s", 
ch©_³”
);

102  
”r
;

103 
	}
}

106 
	$´št_cÚùs
(
»_´štf
 *
pf
, *
unu£d
)

108 ()
unu£d
;

109  
	`cÚùs_´št
(
pf
, 
	`b¬es_cÚùs
());

110 
	}
}

113 
	$£nd_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

115 ()
¬g
;

117 ià(
”r
) {

118 ()
	`»_årštf
(
¡d”r
, " \x1b[31m%m\x1b[;m\n", 
”r
);

122 ià(
msg
->
scode
 >= 300) {

123 ()
	`»_årštf
(
¡d”r
, " \x1b[31m%u %r\x1b[;m\n",

124 
msg
->
scode
, &msg->
»asÚ
);

126 
	}
}

129 
	$cmd_mes§ge
(
»_´štf
 *
pf
, *
¬g
)

131 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

132 
”r
;

134 ià(!
	`¡r_is£t
(
ch©_³”
)) {

135  
	`»_h´štf
(
pf
, "contact: chat…eer is‚ot set\n");

138 
”r
 = 
	`mes§ge_£nd
(
	`uag_cu¼’t
(), 
ch©_³”
, 
ÿrg
->
´m
,

139 
£nd_»¥_hªdËr
, 
NULL
);

140 ià(
”r
) {

141 ()
	`»_h´štf
(
pf
, "contact: message_send() failed (%m)\n",

142 
”r
);

145  
”r
;

146 
	}
}

149 cÚ¡ 
cmd
 
	gcmdv
[] = {

150 {"dŸlcÚù", '|', 
CMD_IPRM
, "DŸÈäom cÚùs", 
cmd_cÚù
 },

151 {"ch©³”", '=', 
CMD_IPRM
, "S–eù ch©…“r", 
cmd_cÚù
 },

152 {"cÚùs", 'C', 0, "Li¡ cÚùs", 
´št_cÚùs
 },

153 {"mes§ge", '-', 
CMD_PRM
, 
cmd_desc
, 
cmd_mes§ge
 },

157 
	$wr™e_‹m¶©e
(cÚ¡ *
fe
)

159 cÚ¡ *
u£r
, *
domaš
;

160 
FILE
 *
f
 = 
NULL
;

162 
	`šfo
("cÚù: c»©šg cÚù ‹m¶©%s\n", 
fe
);

164 
f
 = 
	`fİ’
(
fe
, "w");

165 ià(!
f
)

166  
”ºo
;

168 
u£r
 = 
	`sys_u£ºame
();

169 ià(!
u£r
)

170 
u£r
 = "user";

171 
domaš
 = 
	`Ãt_domaš
(
	`b¬es_ÃtwÜk
());

172 ià(!
domaš
)

173 
domaš
 = "domain";

175 ()
	`»_årštf
(
f
,

195 
u£r
, u£r, 
domaš
);

197 ià(
f
)

198 ()
	`fşo£
(
f
);

201 
	}
}

204 
	$moduË_š™
()

206 
cÚùs
 *cÚù ğ
	`b¬es_cÚùs
();

207 
·th
[256] = "", 
fe
[256] = "";

208 
”r
;

210 
”r
 = 
	`cÚf_·th_g‘
(
·th
, (path));

211 ià(
”r
)

212  
”r
;

214 ià(
	`»_¢´štf
(
fe
, (fe), "%s/cÚùs", 
·th
) < 0)

215  
ENOMEM
;

217 ià(!
	`cÚf_f“xi¡
(
fe
)) {

219 ()
	`fs_mkdœ
(
·th
, 0700);

221 
”r
 = 
	`wr™e_‹m¶©e
(
fe
);

222 ià(
”r
)

223  
”r
;

226 
”r
 = 
	`cÚf_·r£
(
fe
, 
cÚæše_hªdËr
, 
cÚùs
);

227 ià(
”r
)

228  
”r
;

230 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

231 ià(
”r
)

232  
”r
;

234 
	`šfo
("Populated %u contacts\n",

235 
	`li¡_couÁ
(
	`cÚù_li¡
(
cÚùs
)));

237  
”r
;

238 
	}
}

241 
	$moduË_şo£
()

243 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

244 
	`li¡_æush
(
	`cÚù_li¡
(
	`b¬es_cÚùs
()));

247 
	}
}

250 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
cÚù
) = {

253 
moduË_š™
,

254 
moduË_şo£


	@baresip/modules/coreaudio/coreaudio.c

6 
	~<AudioToŞbox/AudioToŞbox.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"cÜ—udio.h
"

20 
au¶ay
 *
	gau¶ay
;

21 
au¤c
 *
	gau¤c
;

24 #ià
TARGET_OS_IPHONE
 && 
__IPHONE_OS_VERSION_MIN_REQUIRED
 >ğ
__IPHONE_2_0


25 
	$š‹¼u±iÚLi¡’”
(*
d©a
, 
UIÁ32
 
šIÁ”ru±iÚS‹
)

27 ()
d©a
;

31 ià(
šIÁ”ru±iÚS‹
 =ğ
kAudioSessiÚBegšIÁ”ru±iÚ
) {

32 
	`debug
("coreaudio:…layer interrupt: Begin\n");

34 ià(
šIÁ”ru±iÚS‹
 =ğ
kAudioSessiÚEndIÁ”ru±iÚ
) {

35 
	`debug
("coreaudio:…layer interrupt: End\n");

37 
	}
}

40 
	$audio_£ssiÚ_’abË
()

42 
OSStus
 
»s
;

43 
UIÁ32
 
ÿ‹gÜy
;

45 
»s
 = 
	`AudioSessiÚIn™Ÿlize
(
NULL
, NULL, 
š‹¼u±iÚLi¡’”
, 0);

46 ià(
»s
 &&„es != 1768843636)

47  
ENODEV
;

49 
ÿ‹gÜy
 = 
kAudioSessiÚC©egÜy_PÏyAndRecÜd
;

50 
»s
 = 
	`AudioSessiÚS‘Prİ”ty
(
kAudioSessiÚPrİ”ty_AudioC©egÜy
,

51 (
ÿ‹gÜy
), &category);

52 ià(
»s
) {

53 
	`w¬nšg
("cÜ—udio: AudiØC©egÜy: %d\n", 
»s
);

54  
ENODEV
;

57 
»s
 = 
	`AudioSessiÚS‘Aùive
(
Œue
);

58 ià(
»s
) {

59 
	`w¬nšg
("cÜ—udio: AudioSessiÚS‘Aùive: %d\n", 
»s
);

60  
ENODEV
;

64 
	}
}

67 
	$audio_£ssiÚ_di§bË
()

69 
	`AudioSessiÚS‘Aùive
(
çl£
);

70 
	}
}

72 
	$audio_£ssiÚ_’abË
()

75 
	}
}

78 
	$audio_£ssiÚ_di§bË
()

80 
	}
}

84 
	$moduË_š™
()

86 
”r
;

88 
”r
 = 
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

89 "cÜ—udio", 
cÜ—udio_¶ay”_®loc
);

90 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

91 "cÜ—udio", 
cÜ—udio_»cÜd”_®loc
);

93  
”r
;

94 
	}
}

97 
	$moduË_şo£
()

99 
au¶ay
 = 
	`mem_d”ef
(auplay);

100 
au¤c
 = 
	`mem_d”ef
(ausrc);

103 
	}
}

106 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
cÜ—udio
) = {

109 
moduË_š™
,

110 
moduË_şo£
,

	@baresip/modules/coreaudio/coreaudio.h

8 
audio_£ssiÚ_’abË
();

9 
audio_£ssiÚ_di§bË
();

12 
cÜ—udio_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

13 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

14 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

15 
cÜ—udio_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

16 
medŸ_ùx
 **
ùx
,

17 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

18 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

	@baresip/modules/coreaudio/player.c

6 
	~<AudioToŞbox/AudioQueue.h
>

7 
	~<±h»ad.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"cÜ—udio.h
"

15 #ià
TARGET_OS_IPHONE


16 
	#BUFC
 20

	)

18 
	#BUFC
 6

	)

22 
	sau¶ay_¡
 {

23 cÚ¡ 
au¶ay
 *
	m­
;

24 
AudioQueueRef
 
	mqueue
;

25 
AudioQueueBufãrRef
 
	mbuf
[
BUFC
];

26 
±h»ad_mu‹x_t
 
	mmu‹x
;

27 
au¶ay_wr™e_h
 *
	mwh
;

28 *
	m¬g
;

32 
	$au¶ay_de¡ruùÜ
(*
¬g
)

34 
au¶ay_¡
 *
¡
 = 
¬g
;

35 
ušt32_t
 
i
;

37 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

38 
¡
->
wh
 = 
NULL
;

39 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

41 
	`audio_£ssiÚ_di§bË
();

43 ià(
¡
->
queue
) {

44 
	`AudioQueuePau£
(
¡
->
queue
);

45 
	`AudioQueueStİ
(
¡
->
queue
, 
Œue
);

47 
i
=0; i<
	`ARRAY_SIZE
(
¡
->
buf
); i++)

48 ià(
¡
->
buf
[
i
])

49 
	`AudioQueueF»eBufãr
(
¡
->
queue
, st->
buf
[
i
]);

51 
	`AudioQueueDi¥o£
(
¡
->
queue
, 
Œue
);

54 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
mu‹x
);

55 
	}
}

58 
	$¶ay_hªdËr
(*
u£rD©a
, 
AudioQueueRef
 
outQ
,

59 
AudioQueueBufãrRef
 
outQB
)

61 
au¶ay_¡
 *
¡
 = 
u£rD©a
;

62 
au¶ay_wr™e_h
 *
wh
;

63 *
¬g
;

65 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

66 
wh
 = 
¡
->wh;

67 
¬g
 = 
¡
->arg;

68 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

70 ià(!
wh
)

73 
	`wh
(
outQB
->
mAudioD©a
, outQB->
mAudioD©aBy‹Size
/2, 
¬g
);

75 
	`AudioQueueEnqueueBufãr
(
outQ
, 
outQB
, 0, 
NULL
);

76 
	}
}

79 
	$cÜ—udio_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

80 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

81 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

83 
AudioSŒ—mBasicDesütiÚ
 
fmt
;

84 
au¶ay_¡
 *
¡
;

85 
ušt32_t
 
§mpc
, 
bytc
, 
i
;

86 
OSStus
 
¡©us
;

87 
”r
;

89 ()
deviû
;

91 ià(!
¡p
 || !
­
 || !
´m
 ||…rm->
fmt
 !ğ
AUFMT_S16LE
)

92  
EINVAL
;

94 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

95 ià(!
¡
)

96  
ENOMEM
;

98 
¡
->
­
 =‡p;

99 
¡
->
wh
 = wh;

100 
¡
->
¬g
 =‡rg;

102 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

103 ià(
”r
)

104 
out
;

106 
”r
 = 
	`audio_£ssiÚ_’abË
();

107 ià(
”r
)

108 
out
;

110 
fmt
.
mSam¶eR©e
 = (
Flßt64
)
´m
->
¤©e
;

111 
fmt
.
mFÜm©ID
 = 
kAudioFÜm©Lš—rPCM
;

112 
fmt
.
mFÜm©FÏgs
 = 
kLš—rPCMFÜm©FÏgIsSigÃdIÁeg”
 |

113 
kAudioFÜm©FÏgIsPacked
;

114 #ifdeà
__BIG_ENDIAN__


115 
fmt
.
mFÜm©FÏgs
 |ğ
kAudioFÜm©FÏgIsBigEndŸn
;

117 
fmt
.
mF¿mesP”Pack‘
 = 1;

118 
fmt
.
mBy‹sP”F¿me
 = 
´m
->
ch
 * 2;

119 
fmt
.
mBy‹sP”Pack‘
 = 
´m
->
ch
 * 2;

120 
fmt
.
mChªÃlsP”F¿me
 = 
´m
->
ch
;

121 
fmt
.
mB™sP”ChªÃl
 = 16;

123 
¡©us
 = 
	`AudioQueueNewOuut
(&
fmt
, 
¶ay_hªdËr
, 
¡
, 
NULL
,

124 
kCFRunLoİCommÚModes
, 0, &
¡
->
queue
);

125 ià(
¡©us
) {

126 
	`w¬nšg
("cÜ—udio: AudioQueueNewOuuˆ”rÜ: %i\n", 
¡©us
);

127 
”r
 = 
ENODEV
;

128 
out
;

131 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

132 
bytc
 = 
§mpc
 * 2;

134 
i
=0; i<
	`ARRAY_SIZE
(
¡
->
buf
); i++) {

136 
¡©us
 = 
	`AudioQueueAÎoÿ‹Bufãr
(
¡
->
queue
, 
bytc
,

137 &
¡
->
buf
[
i
]);

138 ià(
¡©us
) {

139 
”r
 = 
ENOMEM
;

140 
out
;

143 
¡
->
buf
[
i
]->
mAudioD©aBy‹Size
 = 
bytc
;

145 
	`mem£t
(
¡
->
buf
[
i
]->
mAudioD©a
, 0,

146 
¡
->
buf
[
i
]->
mAudioD©aBy‹Size
);

148 ()
	`AudioQueueEnqueueBufãr
(
¡
->
queue
, st->
buf
[
i
], 0, 
NULL
);

151 
¡©us
 = 
	`AudioQueueS¹
(
¡
->
queue
, 
NULL
);

152 ià(
¡©us
) {

153 
	`w¬nšg
("cÜ—udio: AudioQueueS¹ƒ¼Ü %i\n", 
¡©us
);

154 
”r
 = 
ENODEV
;

155 
out
;

158 
out
:

159 ià(
”r
)

160 
	`mem_d”ef
(
¡
);

162 *
¡p
 = 
¡
;

164  
”r
;

165 
	}
}

	@baresip/modules/coreaudio/recorder.c

6 
	~<AudioToŞbox/AudioQueue.h
>

7 
	~<uni¡d.h
>

8 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

12 
	~"cÜ—udio.h
"

15 
	#BUFC
 3

	)

18 
	sau¤c_¡
 {

19 cÚ¡ 
au¤c
 *
	mas
;

20 
AudioQueueRef
 
	mqueue
;

21 
AudioQueueBufãrRef
 
	mbuf
[
BUFC
];

22 
±h»ad_mu‹x_t
 
	mmu‹x
;

23 
au¤c_»ad_h
 *
	mrh
;

24 *
	m¬g
;

25 
	m±ime
;

29 
	$au¤c_de¡ruùÜ
(*
¬g
)

31 
au¤c_¡
 *
¡
 = 
¬g
;

32 
ušt32_t
 
i
;

34 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

35 
¡
->
rh
 = 
NULL
;

36 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

38 
	`audio_£ssiÚ_di§bË
();

40 ià(
¡
->
queue
) {

41 
	`AudioQueuePau£
(
¡
->
queue
);

42 
	`AudioQueueStİ
(
¡
->
queue
, 
Œue
);

44 
i
=0; i<
	`ARRAY_SIZE
(
¡
->
buf
); i++)

45 ià(
¡
->
buf
[
i
])

46 
	`AudioQueueF»eBufãr
(
¡
->
queue
, st->
buf
[
i
]);

48 
	`AudioQueueDi¥o£
(
¡
->
queue
, 
Œue
);

51 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
mu‹x
);

52 
	}
}

55 
	$»cÜd_hªdËr
(*
u£rD©a
, 
AudioQueueRef
 
šQ
,

56 
AudioQueueBufãrRef
 
šQB
,

57 cÚ¡ 
AudioTimeSmp
 *
šS¹Time
,

58 
UIÁ32
 
šNumPack‘s
,

59 cÚ¡ 
AudioSŒ—mPack‘DesütiÚ
 *
šPack‘Desc
)

61 
au¤c_¡
 *
¡
 = 
u£rD©a
;

62 
±ime
;

63 
au¤c_»ad_h
 *
rh
;

64 *
¬g
;

65 ()
šS¹Time
;

66 ()
šNumPack‘s
;

67 ()
šPack‘Desc
;

69 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

70 
±ime
 = 
¡
->ptime;

71 
rh
 = 
¡
->rh;

72 
¬g
 = 
¡
->arg;

73 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

75 ià(!
rh
)

78 
	`rh
(
šQB
->
mAudioD©a
, inQB->
mAudioD©aBy‹Size
/2, 
¬g
);

80 
	`AudioQueueEnqueueBufãr
(
šQ
, 
šQB
, 0, 
NULL
);

83 #ià!
TARGET_OS_IPHONE


84 
	#ENCODE_TIME
 1000

	)

85 
	`u¦“p
((
±ime
 * 1000è- 
ENCODE_TIME
);

87 
	}
}

90 
	$cÜ—udio_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

91 
medŸ_ùx
 **
ùx
,

92 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

93 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

95 
AudioSŒ—mBasicDesütiÚ
 
fmt
;

96 
au¤c_¡
 *
¡
;

97 
ušt32_t
 
§mpc
, 
bytc
, 
i
;

98 
OSStus
 
¡©us
;

99 
”r
;

101 ()
ùx
;

102 ()
deviû
;

103 ()
”rh
;

105 ià(!
¡p
 || !
as
 || !
´m
 ||…rm->
fmt
 !ğ
AUFMT_S16LE
)

106  
EINVAL
;

108 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

109 ià(!
¡
)

110  
ENOMEM
;

112 
¡
->
±ime
 = 
´m
->ptime;

113 
¡
->
as
 =‡s;

114 
¡
->
rh
 =„h;

115 
¡
->
¬g
 =‡rg;

117 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

118 
bytc
 = 
§mpc
 * 2;

120 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

121 ià(
”r
)

122 
out
;

124 
”r
 = 
	`audio_£ssiÚ_’abË
();

125 ià(
”r
)

126 
out
;

128 
fmt
.
mSam¶eR©e
 = (
Flßt64
)
´m
->
¤©e
;

129 
fmt
.
mFÜm©ID
 = 
kAudioFÜm©Lš—rPCM
;

130 
fmt
.
mFÜm©FÏgs
 = 
kLš—rPCMFÜm©FÏgIsSigÃdIÁeg”
 |

131 
kAudioFÜm©FÏgIsPacked
;

132 #ifdeà
__BIG_ENDIAN__


133 
fmt
.
mFÜm©FÏgs
 |ğ
kAudioFÜm©FÏgIsBigEndŸn
;

136 
fmt
.
mF¿mesP”Pack‘
 = 1;

137 
fmt
.
mBy‹sP”F¿me
 = 
´m
->
ch
 * 2;

138 
fmt
.
mBy‹sP”Pack‘
 = 
´m
->
ch
 * 2;

139 
fmt
.
mChªÃlsP”F¿me
 = 
´m
->
ch
;

140 
fmt
.
mB™sP”ChªÃl
 = 16;

142 
¡©us
 = 
	`AudioQueueNewIÅut
(&
fmt
, 
»cÜd_hªdËr
, 
¡
, 
NULL
,

143 
kCFRunLoİCommÚModes
, 0, &
¡
->
queue
);

144 ià(
¡©us
) {

145 
	`w¬nšg
("cÜ—udio: AudioQueueNewIÅuˆ”rÜ: %i\n", 
¡©us
);

146 
”r
 = 
ENODEV
;

147 
out
;

150 
i
=0; i<
	`ARRAY_SIZE
(
¡
->
buf
); i++) {

152 
¡©us
 = 
	`AudioQueueAÎoÿ‹Bufãr
(
¡
->
queue
, 
bytc
,

153 &
¡
->
buf
[
i
]);

154 ià(
¡©us
) {

155 
”r
 = 
ENOMEM
;

156 
out
;

159 
	`AudioQueueEnqueueBufãr
(
¡
->
queue
, st->
buf
[
i
], 0, 
NULL
);

162 
¡©us
 = 
	`AudioQueueS¹
(
¡
->
queue
, 
NULL
);

163 ià(
¡©us
) {

164 
	`w¬nšg
("cÜ—udio: AudioQueueS¹ƒ¼Ü %i\n", 
¡©us
);

165 
”r
 = 
ENODEV
;

166 
out
;

169 
out
:

170 ià(
”r
)

171 
	`mem_d”ef
(
¡
);

173 *
¡p
 = 
¡
;

175  
”r
;

176 
	}
}

	@baresip/modules/daala/daala.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<d¯Ï/codec.h
>

10 
	~"d¯Ï.h
"

31 
vidcodec
 
	gd¯Ï
 = {

32 .
Çme
 = "daala",

33 .
	g’cupdh
 = 
d¯Ï_’code_upd©e
,

34 .
	g’ch
 = 
d¯Ï_’code
,

35 .
	gdecupdh
 = 
d¯Ï_decode_upd©e
,

36 .
	gdech
 = 
d¯Ï_decode
,

40 
	$moduË_š™
()

42 
	`šfo
("d¯Ï: usšg v”siÚ '%s'\n", 
	`d¯Ï_v”siÚ_¡ršg
());

44 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
d¯Ï
);

47 
	}
}

50 
	$moduË_şo£
()

52 
	`vidcodec_uÄegi¡”
(&
d¯Ï
);

55 
	}
}

58 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
d¯Ï
) = {

61 
moduË_š™
,

62 
moduË_şo£
,

	@baresip/modules/daala/daala.h

9 
d¯Ï_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

10 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

11 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

12 
d¯Ï_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

13 cÚ¡ 
vidäame
 *
äame
);

17 
d¯Ï_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

18 cÚ¡ *
fm
);

19 
d¯Ï_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

20 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
);

	@baresip/modules/daala/decode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<d¯Ï/d¯Ïdec.h
>

12 
	~"d¯Ï.h
"

15 
	sviddec_¡©e
 {

16 
d¯Ï_dec_ùx
 *
	mdec
;

18 
boŞ
 
	mgÙ_h—d”s
;

20 
d¯Ï_šfo
 
	mdi
;

21 
d¯Ï_comm’t
 
	mdc
;

22 
d¯Ï_£tup_šfo
 *
	mds
;

25 
boŞ
 
	mv®id
;

26 
size_t
 
	mn_äame
;

27 
size_t
 
	mn_h—d”
;

28 
size_t
 
	mn_keyäame
;

29 
size_t
 
	mn_·ck‘
;

30 } 
	m¡©s
;

34 
	$dump_¡©s
(cÚ¡ 
viddec_¡©e
 *
vds
)

36 
	`»_´štf
("~~~~~ Daala Decoder stats ~~~~~\n");

37 
	`»_´štf
("num f¿mes: %zu\n", 
vds
->
¡©s
.
n_äame
);

38 
	`»_´štf
("num h—d”s: %zu\n", 
vds
->
¡©s
.
n_h—d”
);

39 
	`»_´štf
("key-äame ·ck‘s: %zu\n", 
vds
->
¡©s
.
n_keyäame
);

40 
	`»_´štf
("tÙ®…ack‘s: %zu\n", 
vds
->
¡©s
.
n_·ck‘
);

41 
	}
}

44 
	$de¡ruùÜ
(*
¬g
)

46 
viddec_¡©e
 *
vds
 = 
¬g
;

48 ià(
vds
->
¡©s
.
v®id
)

49 
	`dump_¡©s
(
vds
);

51 ià(
vds
->
dec
)

52 
	`d¯Ï_decode_ä“
(
vds
->
dec
);

54 ià(
vds
->
ds
)

55 
	`d¯Ï_£tup_ä“
(
vds
->
ds
);

56 
	`d¯Ï_comm’t_ş—r
(&
vds
->
dc
);

57 
	`d¯Ï_šfo_ş—r
(&
vds
->
di
);

58 
	}
}

61 
	$d¯Ï_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

62 cÚ¡ *
fm
)

64 
viddec_¡©e
 *
vds
;

65 
”r
 = 0;

66 ()
vc
;

67 ()
fm
;

69 ià(!
vd¥
)

70  
EINVAL
;

72 
vds
 = *
vd¥
;

74 ià(
vds
)

77 
vds
 = 
	`mem_z®loc
((*vds), 
de¡ruùÜ
);

78 ià(!
vds
)

79  
ENOMEM
;

81 
	`d¯Ï_šfo_š™
(&
vds
->
di
);

82 
	`d¯Ï_comm’t_š™
(&
vds
->
dc
);

84 ià(
”r
)

85 
	`mem_d”ef
(
vds
);

87 *
vd¥
 = 
vds
;

89  
”r
;

90 
	}
}

93 
	$d¯Ï_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

94 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

96 
d¯Ï_·ck‘
 
dp
;

97 
boŞ
 
ishdr
;

98 
i
, 
r
, 
”r
 = 0;

99 ()
£q
;

101 ià(!
vds
 || !
äame
 || !
mb
)

102  
EINVAL
;

104 *
šŒa
 = 
çl£
;

106 ++
vds
->
¡©s
.
n_·ck‘
;

107 ++
vds
->
¡©s
.
v®id
;

109 
	`mem£t
(&
dp
, 0, (dp));

111 
dp
.
·ck‘
 = 
	`mbuf_buf
(
mb
);

112 
dp
.
by‹s
 = 
	`mbuf_g‘_Ëá
(
mb
);

113 
dp
.
b_o_s
 = 
m¬k”
;

115 
ishdr
 = 
	`d¯Ï_·ck‘_ish—d”
(&
dp
);

117 ià(
ishdr
)

118 ++
vds
->
¡©s
.
n_h—d”
;

119 ià(
	`d¯Ï_·ck‘_iskeyäame
(&
dp
) > 0) {

120 ++
vds
->
¡©s
.
n_keyäame
;

121 *
šŒa
 = 
Œue
;

124 ià(
	`d¯Ï_·ck‘_ish—d”
(&
dp
)) {

126 
r
 = 
	`d¯Ï_decode_h—d”_š
(&
vds
->
di
, &vds->
dc
, &vds->
ds
,

127 &
dp
);

128 ià(
r
 < 0) {

129 
	`w¬nšg
("daala: decoder: decode_header_in failed"

131 
r
);

132  
EPROTO
;

134 ià(
r
 == 0) {

135 
vds
->
gÙ_h—d”s
 = 
Œue
;

136 
	`šfo
("daala:‡ll headers„eceived\n");

138 
vds
->
dec
 = 
	`d¯Ï_decode_ü—‹
(&vds->
di
, vds->
ds
);

139 ià(!
vds
->
dec
) {

140 
	`w¬nšg
("daala: decoder:‡lloc failed\n");

141  
ENOMEM
;

149 
d¯Ï_image
 
img
;

151 ià(!
vds
->
gÙ_h—d”s
) {

152 
	`w¬nšg
("daala: decode: still waiting for headers\n");

153  
EPROTO
;

156 
r
 = 
	`d¯Ï_decode_·ck‘_š
(
vds
->
dec
, &
dp
);

157 ià(
r
 < 0) {

158 
	`w¬nšg
("d¯Ï: decode:…ack‘_šƒ¼Ü (%d)\n", 
r
);

159  
EPROTO
;

162 
r
 = 
	`d¯Ï_decode_img_out
(
vds
->
dec
, &
img
);

163 ià(
r
 != 1) {

164 
	`w¬nšg
("d¯Ï: decode: img_ouˆ”rÜ (%d)\n", 
r
);

165  
EPROTO
;

168 
i
=0; i<3; i++) {

169 
äame
->
d©a
[
i
] = 
img
.
¶ªes
[i].data;

170 
äame
->
lšesize
[
i
] = 
img
.
¶ªes
[i].
y¡ride
;

173 
äame
->
size
.
w
 = 
img
.
width
;

174 
äame
->
size
.
h
 = 
img
.
height
;

175 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

177 ++
vds
->
¡©s
.
n_äame
;

180  
”r
;

181 
	}
}

	@baresip/modules/daala/encode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<d¯Ï/d¯Ï’c.h
>

12 
	~"d¯Ï.h
"

15 
	svid’c_¡©e
 {

16 
vidsz
 
	msize
;

17 
d¯Ï_’c_ùx
 *
	m’c
;

18 
št64_t
 
	m±s
;

19 
	mås
;

20 
	mb™¿‹
;

21 
	mpktsize
;

22 
vid’c_·ck‘_h
 *
	mpkth
;

23 *
	m¬g
;

26 
boŞ
 
	mv®id
;

27 
size_t
 
	mn_äame
;

28 
size_t
 
	mn_h—d”
;

29 
size_t
 
	mn_keyäame
;

30 
size_t
 
	mn_·ck‘
;

31 } 
	m¡©s
;

35 
	$dump_¡©s
(cÚ¡ 
vid’c_¡©e
 *
ves
)

37 
	`»_´štf
("~~~~~ Daala Encoder stats ~~~~~\n");

38 
	`»_´štf
("num f¿mes: %zu\n", 
ves
->
¡©s
.
n_äame
);

39 
	`»_´štf
("num h—d”s: %zu\n", 
ves
->
¡©s
.
n_h—d”
);

40 
	`»_´štf
("key-äame ·ck‘s: %zu\n", 
ves
->
¡©s
.
n_keyäame
);

41 
	`»_´štf
("tÙ®…ack‘s: %zu\n", 
ves
->
¡©s
.
n_·ck‘
);

42 
	}
}

45 
	$£nd_·ck‘
(
vid’c_¡©e
 *
ves
, 
boŞ
 
m¬k”
,

46 cÚ¡ 
ušt8_t
 *
¶d
, 
size_t
 
¶d_Ën
)

48 
d¯Ï_·ck‘
 
dp
;

49 
”r
;

51 
	`mem£t
(&
dp
, 0, (dp));

53 
dp
.
·ck‘
 = (
ušt8_t
 *)
¶d
;

54 
dp
.
by‹s
 = 
¶d_Ën
;

55 
dp
.
b_o_s
 = 
m¬k”
;

57 
”r
 = 
ves
->
	`pkth
(
m¬k”
, 
NULL
, 0, 
¶d
, 
¶d_Ën
, ves->
¬g
);

58 ià(
”r
)

59  
”r
;

61 ++
ves
->
¡©s
.
n_·ck‘
;

62 ++
ves
->
¡©s
.
v®id
;

64 ià(
	`d¯Ï_·ck‘_ish—d”
(&
dp
))

65 ++
ves
->
¡©s
.
n_h—d”
;

66 ià(
	`d¯Ï_·ck‘_iskeyäame
(&
dp
) > 0)

67 ++
ves
->
¡©s
.
n_keyäame
;

70 
	}
}

73 
	$de¡ruùÜ
(*
¬g
)

75 
vid’c_¡©e
 *
ves
 = 
¬g
;

77 ià(
ves
->
¡©s
.
v®id
)

78 
	`dump_¡©s
(
ves
);

80 ià(
ves
->
’c
)

81 
	`d¯Ï_’code_ä“
(
ves
->
’c
);

82 
	}
}

85 
	$d¯Ï_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

86 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

87 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

89 
vid’c_¡©e
 *
ves
;

90 ()
fm
;

92 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < 3 || !
pkth
)

93  
EINVAL
;

95 
ves
 = *
ve¥
;

97 ià(!
ves
) {

99 
ves
 = 
	`mem_z®loc
((*ves), 
de¡ruùÜ
);

100 ià(!
ves
)

101  
ENOMEM
;

103 *
ve¥
 = 
ves
;

106 ià(
ves
->
’c
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

107 
ves
->
pktsize
 !ğ
´m
->pktsize ||

108 
ves
->
ås
 !ğ
´m
->fps)) {

110 
	`šfo
("daala:ƒncoder:…arams changed\n");

112 
	`d¯Ï_’code_ä“
(
ves
->
’c
);

113 
ves
->
’c
 = 
NULL
;

117 
ves
->
b™¿‹
 = 
´m
->bitrate;

118 
ves
->
pktsize
 = 
´m
->pktsize;

119 
ves
->
ås
 = 
´m
->fps;

120 
ves
->
pkth
 =…kth;

121 
ves
->
¬g
 =‡rg;

124 
	}
}

127 
	$İ’_’cod”
(
vid’c_¡©e
 *
ves
, cÚ¡ 
vidsz
 *
size
)

129 
d¯Ï_šfo
 
di
;

130 
d¯Ï_comm’t
 
dc
;

131 
d¯Ï_·ck‘
 
dp
;

132 
”r
 = 0;

133 
com¶ex™y
 = 7;

134 
video_q
 = 30;

135 
b™¿‹
 = 
ves
->bitrate;

137 
	`šfo
("daala: openƒncoder (%d x %d, %d bps)\n",

138 
size
->
w
, size->
h
, 
b™¿‹
);

140 ià(
ves
->
’c
) {

141 
	`debug
("daala:„e-openingƒncoder\n");

142 
	`d¯Ï_’code_ä“
(
ves
->
’c
);

145 
	`d¯Ï_šfo_š™
(&
di
);

146 
	`d¯Ï_comm’t_š™
(&
dc
);

148 
di
.
pic_width
 = 
size
->
w
;

149 
di
.
pic_height
 = 
size
->
h
;

150 
di
.
timeba£_num”©Ü
 = 1;

151 
di
.
timeba£_d’omš©Ü
 = 
ves
->
ås
;

152 
di
.
äame_du¿tiÚ
 = 1;

153 
di
.
pix–_a¥eù_num”©Ü
 = -1;

154 
di
.
pix–_a¥eù_d’omš©Ü
 = -1;

155 
di
.
ÅÏÃs
 = 3;

156 
di
.
¶ªe_šfo
[0].
xdec
 = 0;

157 
di
.
¶ªe_šfo
[0].
ydec
 = 0;

158 
di
.
¶ªe_šfo
[1].
xdec
 = 1;

159 
di
.
¶ªe_šfo
[1].
ydec
 = 1;

160 
di
.
¶ªe_šfo
[2].
xdec
 = 1;

161 
di
.
¶ªe_šfo
[2].
ydec
 = 1;

163 
di
.
keyäame_¿‹
 = 100;

165 
	`šfo
("daala: openƒncoder with bitstream version %u.%u.%u\n",

166 
di
.
v”siÚ_majÜ
, di.
v”siÚ_mšÜ
, di.
v”siÚ_sub
);

168 
ves
->
’c
 = 
	`d¯Ï_’code_ü—‹
(&
di
);

169 ià(!
ves
->
’c
) {

170 
	`w¬nšg
("daala: failedo open DAALAƒncoder\n");

171  
ENOMEM
;

174 
	`d¯Ï_’code_ùl
(
ves
->
’c
, 
OD_SET_QUANT
,

175 &
video_q
, (video_q));

177 
	`d¯Ï_’code_ùl
(
ves
->
’c
, 
OD_SET_COMPLEXITY
,

178 &
com¶ex™y
, (complexity));

180 
	`d¯Ï_’code_ùl
(
ves
->
’c
, 
OD_SET_BITRATE
,

181 &
b™¿‹
, (bitrate));

184 
r
;

186 
r
 = 
	`d¯Ï_’code_æush_h—d”
(
ves
->
’c
, &
dc
, &
dp
);

187 ià(
r
 < 0) {

188 
	`w¬nšg
("d¯Ï: flush_h—d”„‘uºed %d\n", 
r
);

191 ià(
r
 == 0)

194 
	`debug
("daala: header: %lld bytes header=%d key=%d\n",

195 
dp
.
by‹s
,

196 
	`d¯Ï_·ck‘_ish—d”
(&
dp
),

197 
	`d¯Ï_·ck‘_iskeyäame
(&
dp
));

200 
	`»_´štf
("bos=%lld,ƒos=%lld, granule=%lld,…acketno=%lld\n",

201 
dp
.
b_o_s
,

202 
dp
.
e_o_s
,

203 
dp
.
g¿nuËpos
,

204 
dp
.
·ck‘no
);

207 
”r
 = 
	`£nd_·ck‘
(
ves
, 
dp
.
b_o_s
, dp.
·ck‘
, dp.
by‹s
);

208 ià(
”r
)

212 
	`d¯Ï_šfo_ş—r
(&
di
);

213 
	`d¯Ï_comm’t_ş—r
(&
dc
);

215  
”r
;

216 
	}
}

219 
	$d¯Ï_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

220 cÚ¡ 
vidäame
 *
äame
)

222 
r
, 
”r
 = 0;

223 
d¯Ï_image
 
img
;

224 
i
;

225 ()
upd©e
;

227 ià(!
ves
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

228  
EINVAL
;

230 ++
ves
->
¡©s
.
n_äame
;

232 ià(!
ves
->
’c
 || !
	`vidsz_cmp
(&ves->
size
, &
äame
->size)) {

234 
”r
 = 
	`İ’_’cod”
(
ves
, &
äame
->
size
);

235 ià(
”r
)

236  
”r
;

238 
ves
->
size
 = 
äame
->size;

241 
img
.
¶ªes
[0].
d©a
 = 
äame
->data[0];

242 
img
.
¶ªes
[0].
xdec
 = 0;

243 
img
.
¶ªes
[0].
ydec
 = 0;

244 
img
.
¶ªes
[0].
x¡ride
 = 1;

245 
img
.
¶ªes
[0].
y¡ride
 = 
äame
->
lšesize
[0];

247 
img
.
¶ªes
[1].
d©a
 = 
äame
->data[1];

248 
img
.
¶ªes
[1].
xdec
 = 1;

249 
img
.
¶ªes
[1].
ydec
 = 1;

250 
img
.
¶ªes
[1].
x¡ride
 = 1;

251 
img
.
¶ªes
[1].
y¡ride
 = 
äame
->
lšesize
[1];

253 
img
.
¶ªes
[2].
d©a
 = 
äame
->data[2];

254 
img
.
¶ªes
[2].
xdec
 = 1;

255 
img
.
¶ªes
[2].
ydec
 = 1;

256 
img
.
¶ªes
[2].
x¡ride
 = 1;

257 
img
.
¶ªes
[2].
y¡ride
 = 
äame
->
lšesize
[2];

259 
i
=0; i<3; i++)

260 
img
.
¶ªes
[
i
].
b™d•th
 = 8;

262 
img
.
ÅÏÃs
 = 3;

264 
img
.
width
 = 
äame
->
size
.
w
;

265 
img
.
height
 = 
äame
->
size
.
h
;

267 
r
 = 
	`d¯Ï_’code_img_š
(
ves
->
’c
, &
img
, 0);

268 ià(
r
 != 0) {

269 
	`w¬nšg
("daala:ƒncoder:ƒncode_img_in failed (ret = %d)\n",

270 
r
);

271  
EPROTO
;

275 
d¯Ï_·ck‘
 
dp
;

277 
r
 = 
	`d¯Ï_’code_·ck‘_out
(
ves
->
’c
, 0, &
dp
);

278 ià(
r
 < 0) {

279 
	`w¬nšg
("d¯Ï:ƒncod”:…ack‘_ouˆ»t=%d\n", 
r
);

282 ià(
r
 == 0) {

286 
”r
 = 
	`£nd_·ck‘
(
ves
, 
dp
.
b_o_s
, dp.
·ck‘
, dp.
by‹s
);

287 ià(
”r
)

292 
	}
}

	@baresip/modules/debug_cmd/debug_cmd.c

6 
	~<¡dlib.h
>

7 
	~<time.h
>

8 #ifdeà
USE_OPENSSL


9 
	~<İ’s¦/üy±o.h
>

11 
	~<».h
>

12 
	~<b¬es.h
>

22 
ušt64_t
 
	g¡¬t_ticks
;

23 
time_t
 
	g¡¬t_time
;

26 
	$cmd_Ãt_debug
(
»_´štf
 *
pf
, *
unu£d
)

28 ()
unu£d
;

29  
	`Ãt_debug
(
pf
, 
	`b¬es_ÃtwÜk
());

30 
	}
}

33 
	$´št_sy¡em_šfo
(
»_´štf
 *
pf
, *
¬g
)

35 
ušt32_t
 
u±ime
;

36 
”r
 = 0;

38 ()
¬g
;

40 
u±ime
 = (
ušt32_t
)(()(
	`tmr_jiff›s
(è- 
¡¬t_ticks
)/1000);

42 
”r
 |ğ
	`»_h´štf
(
pf
, "\n--- System info: ---\n");

44 
”r
 |ğ
	`»_h´štf
(
pf
, " Machše: %s/%s\n", 
	`sys_¬ch_g‘
(),

45 
	`sys_os_g‘
());

46 
”r
 |ğ
	`»_h´štf
(
pf
, " Version: %s (libre v%s)\n",

47 
BARESIP_VERSION
, 
	`sys_lib»_v”siÚ_g‘
());

48 
”r
 |ğ
	`»_h´štf
(
pf
, " Bud: %H\n", 
sys_bud_g‘
, 
NULL
);

49 
”r
 |ğ
	`»_h´štf
(
pf
, " K”Ãl: %H\n", 
sys_k”Ãl_g‘
, 
NULL
);

50 
”r
 |ğ
	`»_h´štf
(
pf
, " U±ime: %H\n", 
fmt_humª_time
, &
u±ime
);

51 
”r
 |ğ
	`»_h´štf
(
pf
, " S¹ed: %s", 
	`ùime
(&
¡¬t_time
));

53 #ifdeà
__VERSION__


54 
”r
 |ğ
	`»_h´štf
(
pf
, " Comp”: %s\n", 
__VERSION__
);

57 #ifdeà
USE_OPENSSL


58 
”r
 |ğ
	`»_h´štf
(
pf
, " OpenSSL: %s\n",

59 
	`SSL—y_v”siÚ
(
SSLEAY_VERSION
));

62  
”r
;

63 
	}
}

66 
	$cmd_cÚfig_´št
(
»_´štf
 *
pf
, *
unu£d
)

68 ()
unu£d
;

69  
	`cÚfig_´št
(
pf
, 
	`cÚf_cÚfig
());

70 
	}
}

73 
	$cmd_ua_debug
(
»_´štf
 *
pf
, *
unu£d
)

75 ()
unu£d
;

76  
	`ua_debug
(
pf
, 
	`uag_cu¼’t
());

77 
	}
}

80 
	$cmd_¶ay_fe
(
»_´štf
 *
pf
, *
¬g
)

82 
cmd_¬g
 *
ÿrg
 = 
¬g
;

83 cÚ¡ *
f’ame
 = 
ÿrg
->
´m
;

84 
”r
;

86 
”r
 = 
	`»_h´štf
(
pf
, "¶ayšg‡udiØf\"%s\" ..\n", 
f’ame
);

87 ià(
”r
)

88  
”r
;

90 
”r
 = 
	`¶ay_fe
(
NULL
, 
	`b¬es_¶ay”
(), 
f’ame
, 0);

91 ià(
”r
) {

92 
	`w¬nšg
("debug_cmd:…lay_file(%s) failed (%m)\n",

93 
f’ame
, 
”r
);

94  
”r
;

97  
”r
;

98 
	}
}

101 
	$»lßd_cÚfig
(
»_´štf
 *
pf
, *
¬g
)

103 
”r
;

104 ()
¬g
;

106 
”r
 = 
	`»_h´štf
(
pf
, "reloading config file ..\n");

107 ià(
”r
)

108  
”r
;

110 
”r
 = 
	`cÚf_cÚfigu»
();

111 ià(
”r
) {

112 ()
	`»_h´štf
(
pf
, "»lßd_cÚfig faed: %m\n", 
”r
);

113  
”r
;

116 ()
	`»_h´štf
(
pf
, "done\n");

119 
	}
}

122 cÚ¡ 
cmd
 
	gdebugcmdv
[] = {

123 {"maš", 0, 0, "Maš†oİ debug", 
»_debug
 },

124 {"cÚfig", 0, 0, "PršˆcÚfigu¿tiÚ", 
cmd_cÚfig_´št
 },

125 {"s¡©", 'i', 0, "SIP debug", 
ua_´št_s_¡©us
 },

126 {"moduËs", 0, 0, "ModuË debug", 
mod_debug
 },

127 {"Ãt¡©", 'n', 0, "N‘wÜk debug", 
cmd_Ãt_debug
 },

128 {"sysšfo", 's', 0, "Sy¡em info", 
´št_sy¡em_šfo
 },

129 {"tim”s", 0, 0, "Tim” debug", 
tmr_¡©us
 },

130 {"ua¡©", 'u', 0, "UA debug", 
cmd_ua_debug
 },

131 {"mem¡©", 'y', 0, "MemÜy stus", 
mem_¡©us
 },

132 {"¶ay", 0, 
CMD_PRM
, "PÏy‡udiØfe", 
cmd_¶ay_fe
 },

133 {"cÚf_»lßd",0, 0, "R–ßd cÚfig fe", 
»lßd_cÚfig
 },

137 
	$moduË_š™
()

139 
”r
;

141 
¡¬t_ticks
 = 
	`tmr_jiff›s
();

142 ()
	`time
(&
¡¬t_time
);

144 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(),

145 
debugcmdv
, 
	`ARRAY_SIZE
(debugcmdv));

147  
”r
;

148 
	}
}

151 
	$moduË_şo£
()

153 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
debugcmdv
);

156 
	}
}

159 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
debug_cmd
) = {

162 
moduË_š™
,

163 
moduË_şo£


	@baresip/modules/directfb/directfb.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~<dœeùfb.h
>

13 
	svidi¥_¡
 {

14 cÚ¡ 
vidi¥
 *
	mvd
;

15 
vidsz
 
	msize
;

16 
IDœeùFBWšdow
 *
	mwšdow
;

17 
IDœeùFBSurçû
 *
	msurçû
;

18 
IDœeùFBDi¥ÏyLay”
 *
	mÏy”
;

22 
IDœeùFB
 *
	gdfb
;

23 
vidi¥
 *
	gvid
;

26 
	$de¡ruùÜ
(*
¬g
)

28 
vidi¥_¡
 *
¡
 = 
¬g
;

30 ià(
¡
->
surçû
)

31 
¡
->
surçû
->
	`R–—£
(st->surface);

32 ià(
¡
->
wšdow
)

33 
¡
->
wšdow
->
	`R–—£
(st->window);

34 ià(
¡
->
Ïy”
)

35 
¡
->
Ïy”
->
	`R–—£
(st->layer);

36 
	}
}

39 
	$®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

40 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

41 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

43 
vidi¥_¡
 *
¡
;

44 
”r
 = 0;

47 (è
´m
;

48 (è
dev
;

49 (è
»sizeh
;

50 (è
¬g
;

52 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

53 ià(!
¡
)

54  
ENOMEM
;

56 
¡
->
vd
 = vd;

58 
dfb
->
	`G‘Di¥ÏyLay”
(dfb, 
DLID_PRIMARY
, &
¡
->
Ïy”
);

60 ià(
”r
)

61 
	`mem_d”ef
(
¡
);

63 *
¡p
 = 
¡
;

65  
”r
;

66 
	}
}

69 
	$di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

70 cÚ¡ 
vidäame
 *
äame
)

72 *
pix–s
;

73 
p™ch
, 
i
;

74 
h
;

75 
ušt8_t
 *
p
;

76 (è
t™Ë
;

78 ià(!
	`vidsz_cmp
(&
¡
->
size
, &
äame
->size)) {

79 ià(
¡
->
size
.
w
 && st->size.
h
) {

80 
	`šfo
("directfb:„eset: %u x %u ---> %u x %u\n",

81 
¡
->
size
.
w
, st->size.
h
,

82 
äame
->
size
.
w
, f¿me->size.
h
);

85 ià(
¡
->
surçû
) {

86 
¡
->
surçû
->
	`R–—£
(st->surface);

87 
¡
->
surçû
 = 
NULL
;

89 ià(
¡
->
wšdow
) {

90 
¡
->
wšdow
->
	`R–—£
(st->window);

91 
¡
->
wšdow
 = 
NULL
;

95 ià(!
¡
->
wšdow
) {

96 
DFBWšdowDesütiÚ
 
desc
;

98 
desc
.
æags
 = 
DWDESC_WIDTH
|
DWDESC_HEIGHT
|
DWDESC_PIXELFORMAT
;

99 
desc
.
width
 = 
äame
->
size
.
w
;

100 
desc
.
height
 = 
äame
->
size
.
h
;

101 
desc
.
pix–fÜm©
 = 
DSPF_I420
;

103 
¡
->
Ïy”
->
	`C»©eWšdow
(¡->Ïy”, &
desc
, &¡->
wšdow
);

105 
¡
->
size
 = 
äame
->size;

106 
¡
->
wšdow
->
	`S‘O·c™y
(st->window, 0xff);

107 
¡
->
wšdow
->
	`G‘Surçû
(¡->wšdow, &¡->
surçû
);

110 
¡
->
surçû
->
	`Lock
(¡->surçû, 
DSLF_WRITE
, &
pix–s
, &
p™ch
);

112 
p
 = 
pix–s
;

113 
i
=0; i<3; i++) {

115 cÚ¡ 
ušt8_t
 *
s
 = 
äame
->
d©a
[
i
];

116 cÚ¡ 
¡p
 = 
äame
->
lšesize
[0] / f¿me->lšesize[
i
];

117 cÚ¡ 
sz
 = 
äame
->
size
.
w
 / 
¡p
;

119 
h
 = 0; h < 
äame
->
size
.h; h +ğ
¡p
) {

121 
	`memıy
(
p
, 
s
, 
sz
);

123 
s
 +ğ
äame
->
lšesize
[
i
];

124 
p
 +ğ(
p™ch
 / 
¡p
);

128 
¡
->
surçû
->
	`UÆock
(st->surface);

131 
¡
->
surçû
->
	`Fl
(st->surface, 0, 0);

134 
	}
}

137 
	$hide
(
vidi¥_¡
 *
¡
)

139 ià(!
¡
 || !¡->
wšdow
)

142 
¡
->
wšdow
->
	`S‘O·c™y
(st->window, 0x00);

143 
	}
}

146 
	$moduË_š™
()

148 
”r
 = 0;

149 
DFBResuÉ
 
»t
;

151 
»t
 = 
	`DœeùFBIn™
(
NULL
, NULL);

152 ià(
»t
) {

153 
	`DœeùFBE¼Ü
("DœeùFBIn™(èçed", 
»t
);

154  (è
»t
;

157 
»t
 = 
	`DœeùFBC»©e
(&
dfb
);

158 ià(
»t
) {

159 
	`DœeùFBE¼Ü
("DœeùFBC»©e(èçed", 
»t
);

160  (è
»t
;

163 
”r
 = 
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(),

164 "dœeùfb", 
®loc
, 
NULL
, 
di¥Ïy
, 
hide
);

165 ià(
”r
)

166  
”r
;

169 
	}
}

172 
	$moduË_şo£
()

174 
vid
 = 
	`mem_d”ef
(vid);

176 ià(
dfb
) {

177 
dfb
->
	`R–—£
(dfb);

178 
dfb
 = 
NULL
;

182 
	}
}

185 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
dœeùfb
) = {

188 
moduË_š™
,

189 
moduË_şo£


	@baresip/modules/dshow/dshow.cpp

8 
	~<¡dio.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

12 
	~<commù¾.h
>

13 
	~<dshow.h
>

15 #´agm¨
comm’t
(
lib
, "strmiids.lib")

35 
IID
 
	gIID_ISam¶eG¿bb”
 = {

41 
IID
 
	gIID_ISam¶eG¿bb”CB
 = {

46 
	~"qed™.h
"

54 
şass
 
	gG¿bb”
;

56 
	svid¤c_¡
 {

57 cÚ¡ 
vid¤c
 *
	mvs
;

59 
IC­tu»G¿phBud”2
 *
	mÿ±u»
;

60 
IBa£F‹r
 *
	mg¿bb”_f‹r
;

61 
IBa£F‹r
 *
	mdev_f‹r
;

62 
ISam¶eG¿bb”
 *
	mg¿bb”
;

63 
IMÚik”
 *
	mdev_mÚik”
;

64 
IG¿phBud”
 *
	mg¿ph
;

65 
IMedŸCÚŒŞ
 *
	mmc
;

67 
G¿bb”
 *
	mg¿b
;

69 
vidsz
 
	msize
;

70 
vid¤c_äame_h
 *
	mäameh
;

71 *
	m¬g
;

75 şas 
	cG¿bb”
 : 
public
 
ISam¶eG¿bb”CB
 {

76 
public
:

77 
	$G¿bb”
(
vid¤c_¡
 *
¡
è: 
	$¤c
(
¡
) { }

79 
	$STDMETHOD
(
Qu”yIÁ”çû
)(
REFIID
 
IÁ”çûId’tif›r
,

80 
VOID
** 
µvObjeù
è
	$throw
()

82 ià(
IÁ”çûId’tif›r
 =ğ
	`__uuidof
(
ISam¶eG¿bb”CB
)) {

83 *
µvObjeù
 = (
ISam¶eG¿bb”CB
**è
this
;

84  
S_OK
;

86  
E_NOINTERFACE
;

87 
	}
}

89 
	$STDMETHOD_
(
ULONG
, 
AddRef
)(è
	$throw
()

92 
	}
}

94 
	$STDMETHOD_
(
ULONG
, 
R–—£
)(è
	$throw
()

97 
	}
}

99 
	$STDMETHOD
(
BufãrCB
è(
§m¶e_time
, 
BYTE
 *
buf
, 
buf_Ën
)

101 
vidäame
 vidframe;

104 
	`vidäame_š™_buf
(&
vidäame
, 
VID_FMT_RGB32
, &
¤c
->
size
, 
buf
);

106 ià(
¤c
->
äameh
)

107 
¤c
->
	`äameh
(&
vidäame
, src->
¬g
);

109  
S_OK
;

110 
	}
}

112 
	$STDMETHOD
(
Sam¶eCB
è(
§m¶e_time
, 
IMedŸSam¶e
 *
§mp
)

114  
S_OK
;

115 
	}
}

117 
	g´iv©e
:

118 
vid¤c_¡
 *
¤c
;

122 
vid¤c
 *
	gv¤c
;

125 
	$g‘_deviû
(
vid¤c_¡
 *
¡
, cÚ¡ *
Çme
)

127 
IC»©eDevEnum
 *
dev_’um
;

128 
IEnumMÚik”
 *
’um_mÚ
;

129 
IMÚik”
 *
mÚ
;

130 
ULONG
 
ãtched
;

131 
HRESULT
 
»s
;

132 
id
 = 0;

133 
boŞ
 
found
 = 
çl£
;

135 ià(!
¡
)

136  
EINVAL
;

138 
»s
 = 
	`CoC»©eIn¡ªû
(
CLSID_Sy¡emDeviûEnum
, 
NULL
,

139 
CLSCTX_INPROC_SERVER
,

140 
IID_IC»©eDevEnum
, (**)&
dev_’um
);

141 ià(
»s
 !ğ
NOERROR
)

142  
ENOENT
;

144 
»s
 = 
dev_’um
->
	`C»©eCÏssEnum”©Ü
(
CLSID_VideoIÅutDeviûC©egÜy
,

145 &
’um_mÚ
, 0);

146 ià(
»s
 !ğ
NOERROR
)

147  
ENOENT
;

149 
’um_mÚ
->
	`Re£t
();

150 
’um_mÚ
->
	`Next
(1, &
mÚ
, &
ãtched
è=ğ
S_OK
 && !
found
) {

152 
IPrİ”tyBag
 *
bag
;

153 
VARIANT
 
v¬
;

154 
dev_Çme
[256];

155 
Ën
 = 0;

157 
»s
 = 
mÚ
->
	`BšdToStÜage
(0, 0, 
IID_IPrİ”tyBag
,

158 (**)&
bag
);

159 ià(!
	`SUCCEEDED
(
»s
))

162 
v¬
.
vt
 = 
VT_BSTR
;

163 
»s
 = 
bag
->
	`R—d
(
L
"Fr›ndlyName", &
v¬
, 
NULL
);

164 ià(
NOERROR
 !ğ
»s
)

167 
Ën
 = 
	`WideCh¬ToMuÉiBy‹
(
CP_ACP
, 0, 
v¬
.
b¡rV®
, -1,

168 
dev_Çme
, (dev_name),

169 
NULL
, NULL);

171 ià(
Ën
 > 0) {

172 
found
 = !
	`¡r_is£t
(
Çme
) ||

173 !
	`¡r_ÿ£cmp
(
dev_Çme
, 
Çme
);

175 ià(
found
) {

176 
	`šfo
("dshow: got device '%s' id=%d\n",

177 
Çme
, 
id
);

178 
¡
->
dev_mÚik”
 = 
mÚ
;

182 
	`SysF»eSŒšg
(
v¬
.
b¡rV®
);

183 
bag
->
	`R–—£
();

184 ià(!
found
) {

185 
mÚ
->
	`R–—£
();

186 ++
id
;

190  
found
 ? 0 : 
ENOENT
;

191 
	}
}

194 
	$add_§m¶e_g¿bb”
(
vid¤c_¡
 *
¡
)

196 
AM_MEDIA_TYPE
 
mt
;

197 
HRESULT
 
hr
;

199 
hr
 = 
	`CoC»©eIn¡ªû
(
CLSID_Sam¶eG¿bb”
, 
NULL
, 
CLSCTX_INPROC_SERVER
,

200 
IID_IBa£F‹r
, (**è&
¡
->
g¿bb”_f‹r
);

201 ià(
	`FAILED
(
hr
))

202  
ENOMEM
;

204 
hr
 = 
¡
->
g¿ph
->
	`AddF‹r
(¡->
g¿bb”_f‹r
, 
L
"Sample Grabber");

205 ià(
	`FAILED
(
hr
))

206  
ENOMEM
;

208 
hr
 = 
¡
->
g¿bb”_f‹r
->
	`Qu”yIÁ”çû
(
IID_ISam¶eG¿bb”
,

209 (**)&
¡
->
g¿bb”
);

210 ià(
	`FAILED
(
hr
))

211  
ENODEV
;

213 
hr
 = 
¡
->
g¿bb”
->
	`S‘C®lback
(¡->
g¿b
, 1);

214 ià(
	`FAILED
(
hr
))

215  
ENOSYS
;

217 
	`mem£t
(&
mt
, 0, (mt));

218 
mt
.
majÜty³
 = 
MEDIATYPE_Video
;

219 
mt
.
subty³
 = 
MEDIASUBTYPE_RGB24
;

220 
hr
 = 
¡
->
g¿bb”
->
	`S‘MedŸTy³
(&
mt
);

221 ià(
	`FAILED
(
hr
))

222  
ENODEV
;

224 
¡
->
g¿bb”
->
	`S‘OÃShÙ
(
FALSE
);

225 
¡
->
g¿bb”
->
	`S‘BufãrSam¶es
(
FALSE
);

228 
	}
}

231 
AM_MEDIA_TYPE
 *
	$ä“_mt
(
AM_MEDIA_TYPE
 *
mt
)

233 ià(!
mt
)

234  
NULL
;

236 ià(
mt
->
cbFÜm©
) {

237 
	`CoTaskMemF»e
((
PVOID
)
mt
->
pbFÜm©
);

239 ià(
mt
->
pUnk
 !ğ
NULL
) {

240 
mt
->
pUnk
->
	`R–—£
();

241 
mt
->
pUnk
 = 
NULL
;

244 
	`CoTaskMemF»e
((
PVOID
)
mt
);

246  
NULL
;

247 
	}
}

250 
	$cÚfig_pš
(
vid¤c_¡
 *
¡
, 
IPš
 *
pš
)

252 
AM_MEDIA_TYPE
 *
mt
;

253 
AM_MEDIA_TYPE
 *
be¡_mt
 = 
NULL
;

254 
IEnumMedŸTy³s
 *
medŸ_’um
 = 
NULL
;

255 
IAMSŒ—mCÚfig
 *
¡»am_cÚf
 = 
NULL
;

256 
VIDEOINFOHEADER
 *
vih
;

257 
HRESULT
 
hr
;

258 
h
 = 
¡
->
size
.h;

259 
w
 = 
¡
->
size
.w;

260 
rh
, 
rw
;

261 
wh
, 
rwrh
;

262 
be¡_m©ch
 = 0;

263 
”r
 = 0;

265 ià(!
pš
 || !
¡
)

266  
EINVAL
;

268 
hr
 = 
pš
->
	`EnumMedŸTy³s
(&
medŸ_’um
);

269 ià(
	`FAILED
(
hr
))

270  
ENODATA
;

272 (
hr
 = 
medŸ_’um
->
	`Next
(1, &
mt
, 
NULL
)è=ğ
S_OK
) {

273 ià(
mt
->
fÜm©ty³
 !ğ
FORMAT_VideoInfo
)

276 
vih
 = (
VIDEOINFOHEADER
 *è
mt
->
pbFÜm©
;

277 
rw
 = 
vih
->
bmiH—d”
.
biWidth
;

278 
rh
 = 
vih
->
bmiH—d”
.
biHeight
;

280 
wh
 = 
w
 * 
h
;

281 
rwrh
 = 
rw
 * 
rh
;

282 ià(
wh
 =ğ
rwrh
) {

283 
be¡_mt
 = 
	`ä“_mt
(best_mt);

287 
diff
 = 
	`abs
(
rwrh
 - 
wh
);

289 ià(
be¡_m©ch
 !ğ0 && 
diff
 >= best_match)

290 
mt
 = 
	`ä“_mt
(mt);

292 
be¡_m©ch
 = 
diff
;

293 
	`ä“_mt
(
be¡_mt
);

294 
be¡_mt
 = 
mt
;

298 ià(
hr
 !ğ
S_OK
)

299 
mt
 = 
	`ä“_mt
(mt);

301 ià(
mt
 =ğ
NULL
 && 
be¡_mt
 == NULL) {

302 
”r
 = 
ENODATA
;

303 
out
;

305 ià(
mt
 =ğ
NULL
)

306 
mt
 = 
be¡_mt
;

308 
hr
 = 
pš
->
	`Qu”yIÁ”çû
(
IID_IAMSŒ—mCÚfig
,

309 (**è&
¡»am_cÚf
);

310 ià(
	`FAILED
(
hr
)) {

311 
”r
 = 
EINVAL
;

312 
out
;

315 
vih
 = (
VIDEOINFOHEADER
 *è
mt
->
pbFÜm©
;

316 
hr
 = 
¡»am_cÚf
->
	`S‘FÜm©
(
mt
);

317 
mt
 = 
	`ä“_mt
(mt);

318 ià(
	`FAILED
(
hr
)) {

319 
”r
 = 
ERANGE
;

320 
out
;

323 
hr
 = 
¡»am_cÚf
->
	`G‘FÜm©
(&
mt
);

324 ià(
	`FAILED
(
hr
)) {

325 
”r
 = 
EINVAL
;

326 
out
;

328 ià(
mt
->
fÜm©ty³
 !ğ
FORMAT_VideoInfo
) {

329 
”r
 = 
EINVAL
;

330 
out
;

333 
vih
 = (
VIDEOINFOHEADER
 *)
mt
->
pbFÜm©
;

334 
rw
 = 
vih
->
bmiH—d”
.
biWidth
;

335 
rh
 = 
vih
->
bmiH—d”
.
biHeight
;

337 ià(
w
 !ğ
rw
 || 
h
 !ğ
rh
) {

338 
	`w¬nšg
("dshow: config_pin:…icture size missmatch: "

340 
w
, 
h
, 
rw
, 
rh
);

342 
¡
->
size
.
w
 = 
rw
;

343 
¡
->
size
.
h
 = 
rh
;

345 
out
:

346 ià(
medŸ_’um
)

347 
medŸ_’um
->
	`R–—£
();

348 ià(
¡»am_cÚf
)

349 
¡»am_cÚf
->
	`R–—£
();

350 
	`ä“_mt
(
mt
);

352  
”r
;

353 
	}
}

356 
	$de¡ruùÜ
(*
¬g
)

358 
vid¤c_¡
 *
¡
 = (vid¤c_¡ *)
¬g
;

360 ià(
¡
->
mc
) {

361 
¡
->
mc
->
	`Stİ
();

362 
¡
->
mc
->
	`R–—£
();

365 ià(
¡
->
g¿bb”
) {

366 
¡
->
g¿bb”
->
	`S‘C®lback
(
NULL
, 1);

367 
¡
->
g¿bb”
->
	`R–—£
();

369 ià(
¡
->
g¿bb”_f‹r
)

370 
¡
->
g¿bb”_f‹r
->
	`R–—£
();

371 ià(
¡
->
dev_mÚik”
)

372 
¡
->
dev_mÚik”
->
	`R–—£
();

373 ià(
¡
->
dev_f‹r
)

374 
¡
->
dev_f‹r
->
	`R–—£
();

375 ià(
¡
->
ÿ±u»
) {

376 
¡
->
ÿ±u»
->
	`R’d”SŒ—m
(&
PIN_CATEGORY_CAPTURE
,

377 &
MEDIATYPE_Video
,

378 
NULL
, NULL, NULL);

379 
¡
->
ÿ±u»
->
	`R–—£
();

381 ià(
¡
->
g¿ph
)

382 
¡
->
g¿ph
->
	`R–—£
();

384 
d–‘e
 
¡
->
g¿b
;

385 
	}
}

388 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

389 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

390 cÚ¡ 
vidsz
 *
size
,

391 cÚ¡ *
fmt
, cÚ¡ *
dev
,

392 
vid¤c_äame_h
 *
äameh
,

393 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

395 
vid¤c_¡
 *
¡
;

396 
IEnumPšs
 *
pš_’um
 = 
NULL
;

397 
IPš
 *
pš
 = 
NULL
;

398 
HRESULT
 
hr
;

399 
”r
;

400 ()
ùx
;

401 ()
”rÜh
;

403 ià(!
¡p
 || !
vs
 || !
´m
 || !
size
)

404  
EINVAL
;

406 
¡
 = (
vid¤c_¡
 *è
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

407 ià(!
¡
)

408  
ENOMEM
;

410 
”r
 = 
	`g‘_deviû
(
¡
, 
dev
);

411 ià(
”r
)

412 
out
;

414 
¡
->
vs
 = vs;

416 
¡
->
size
 = *size;

417 
¡
->
äameh
 = frameh;

418 
¡
->
¬g
 =‡rg;

420 
¡
->
g¿b
 = 
Ãw
 
	`G¿bb”
(st);

421 ià(!
¡
->
g¿b
) {

422 
”r
 = 
ENOMEM
;

423 
out
;

426 
hr
 = 
	`CoC»©eIn¡ªû
(
CLSID_F‹rG¿ph
, 
NULL
, 
CLSCTX_INPROC
,

427 
IID_IG¿phBud”
, (**è&
¡
->
g¿ph
);

428 ià(
	`FAILED
(
hr
)) {

429 
	`w¬nšg
("dshow:‡Îoc: IID_IG¿phBud” faed: %ld\n", 
hr
);

430 
”r
 = 
ENODEV
;

431 
out
;

434 
hr
 = 
	`CoC»©eIn¡ªû
(
CLSID_C­tu»G¿phBud”2
 , 
NULL
,

435 
CLSCTX_INPROC
, 
IID_IC­tu»G¿phBud”2
,

436 (**è&
¡
->
ÿ±u»
);

437 ià(
	`FAILED
(
hr
)) {

438 
	`w¬nšg
("dshow:‡Îoc: IID_IC­tu»G¿phBud”2: %ld\n", 
hr
);

439 
”r
 = 
ENODEV
;

440 
out
;

443 
hr
 = 
¡
->
ÿ±u»
->
	`S‘F‹rg¿ph
(¡->
g¿ph
);

444 ià(
	`FAILED
(
hr
)) {

445 
	`w¬nšg
("dshow:‡Îoc: S‘F‹rg¿ph faed: %ld\n", 
hr
);

446 
”r
 = 
ENODEV
;

447 
out
;

450 
hr
 = 
¡
->
dev_mÚik”
->
	`BšdToObjeù
(
NULL
, NULL, 
IID_IBa£F‹r
,

451 (**è&
¡
->
dev_f‹r
);

452 ià(
	`FAILED
(
hr
)) {

453 
	`w¬nšg
("dshow:‡Îoc: bšdØba£ f‹¸çed: %ld\n", 
hr
);

454 
”r
 = 
ENODEV
;

455 
out
;

458 
hr
 = 
¡
->
g¿ph
->
	`AddF‹r
(¡->
dev_f‹r
, 
L
"Video Capture");

459 ià(
	`FAILED
(
hr
)) {

460 
	`w¬nšg
("dshow:‡Îoc: VideoC­tu» faed: %ld\n", 
hr
);

461 
”r
 = 
ENODEV
;

462 
out
;

465 
hr
 = 
¡
->
dev_f‹r
->
	`EnumPšs
(&
pš_’um
);

466 ià(
pš_’um
) {

467 
pš_’um
->
	`Re£t
();

468 
hr
 = 
pš_’um
->
	`Next
(1, &
pš
, 
NULL
);

471 
	`add_§m¶e_g¿bb”
(
¡
);

472 
”r
 = 
	`cÚfig_pš
(
¡
, 
pš
);

473 
pš
->
	`R–—£
();

474 ià(
”r
)

475 
out
;

477 
hr
 = 
¡
->
ÿ±u»
->
	`R’d”SŒ—m
(&
PIN_CATEGORY_CAPTURE
,

478 &
MEDIATYPE_Video
,

479 
¡
->
dev_f‹r
,

480 
NULL
, 
¡
->
g¿bb”_f‹r
);

481 ià(
	`FAILED
(
hr
)) {

482 
	`w¬nšg
("dshow:‡lloc: RenderStream failed\n");

483 
”r
 = 
ENODEV
;

484 
out
;

487 
hr
 = 
¡
->
g¿ph
->
	`Qu”yIÁ”çû
(
IID_IMedŸCÚŒŞ
,

488 (**è&
¡
->
mc
);

489 ià(
	`FAILED
(
hr
)) {

490 
	`w¬nšg
("dshow:‡lloc: IMediaControl failed\n");

491 
”r
 = 
ENODEV
;

492 
out
;

495 
hr
 = 
¡
->
mc
->
	`Run
();

496 ià(
	`FAILED
(
hr
)) {

497 
	`w¬nšg
("dshow:‡lloc: Run failed\n");

498 
”r
 = 
ENODEV
;

499 
out
;

502 
out
:

503 ià(
”r
)

504 
	`mem_d”ef
(
¡
);

506 *
¡p
 = 
¡
;

508  
”r
;

509 
	}
}

512 
	$moduË_š™
()

514 ià(
	`CoIn™Ÿlize
(
NULL
è!ğ
S_OK
)

515  
ENODATA
;

517  
	`vid¤c_»gi¡”
(&
v¤c
, 
	`b¬es_vid¤ş
(),

518 "dshow", 
®loc
, 
NULL
);

519 
	}
}

522 
	$moduË_şo£
()

524 
v¤c
 = (
vid¤c
 *è
	`mem_d”ef
(vsrc);

525 
	`CoUnš™Ÿlize
();

528 
	}
}

531 "C" cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
dshow
) = {

534 
moduË_š™
,

535 
moduË_şo£


	@baresip/modules/dtls_srtp/dtls.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"ds_¤.h
"

12 
	$ds_´št_sha1_fšg”´št
(
»_´štf
 *
pf
, cÚ¡ 
s
 *tls)

14 
ušt8_t
 
md
[20];

15 
i
;

16 
”r
 = 0;

18 ià(!
s
)

19  
EINVAL
;

21 
”r
 = 
	`s_fšg”´št
(
s
, 
TLS_FINGERPRINT_SHA1
, 
md
, (md));

22 ià(
”r
)

23  
”r
;

25 
i
=0; i<(
md
); i++) {

26 
”r
 |ğ
	`»_h´štf
(
pf
, "%s%02X", 
i
==0 ? "" : ":", 
md
[i]);

29  
”r
;

30 
	}
}

33 
	$ds_´št_sha256_fšg”´št
(
»_´štf
 *
pf
, cÚ¡ 
s
 *tls)

35 
ušt8_t
 
md
[32];

36 
i
;

37 
”r
 = 0;

39 ià(!
s
)

40  
EINVAL
;

42 
”r
 = 
	`s_fšg”´št
(
s
, 
TLS_FINGERPRINT_SHA256
, 
md
, (md));

43 ià(
”r
)

44  
”r
;

46 
i
=0; i<(
md
); i++) {

47 
”r
 |ğ
	`»_h´štf
(
pf
, "%s%02X", 
i
==0 ? "" : ":", 
md
[i]);

50  
”r
;

51 
	}
}

	@baresip/modules/dtls_srtp/dtls_srtp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<¡ršg.h
>

10 
	~"ds_¤.h
"

49 
	sm’c_£ss
 {

50 
sdp_£ssiÚ
 *
	msdp
;

51 
boŞ
 
	mofã»r
;

52 
m’c_”rÜ_h
 *
	m”rÜh
;

53 *
	m¬g
;

57 
	sds_¤
 {

58 
comp
 
	mcompv
[2];

59 cÚ¡ 
m’c_£ss
 *
	m£ss
;

60 
sdp_medŸ
 *
	msdpm
;

61 
tmr
 
	mtmr
;

62 
boŞ
 
	m¡¬‹d
;

63 
boŞ
 
	maùive
;

64 
boŞ
 
	mmux
;

67 
s
 *
	gs
;

68 cÚ¡ * 
	g¤_´ofes
 =

73 
	$£ss_de¡ruùÜ
(*
¬g
)

75 
m’c_£ss
 *
£ss
 = 
¬g
;

77 
	`mem_d”ef
(
£ss
->
sdp
);

78 
	}
}

81 
	$de¡ruùÜ
(*
¬g
)

83 
ds_¤
 *
¡
 = 
¬g
;

84 
size_t
 
i
;

86 
	`tmr_ÿnûl
(&
¡
->
tmr
);

88 
i
=0; i<2; i++) {

89 
comp
 *
c
 = &
¡
->
compv
[
i
];

91 
	`mem_d”ef
(
c
->
uh_¤
);

92 
	`mem_d”ef
(
c
->
s_cÚn
);

93 
	`mem_d”ef
(
c
->
ds_sock
);

94 
	`mem_d”ef
(
c
->
­p_sock
);

95 
	`mem_d”ef
(
c
->
tx
);

96 
	`mem_d”ef
(
c
->
rx
);

99 
	`mem_d”ef
(
¡
->
sdpm
);

100 
	}
}

103 
boŞ
 
	$v”ify_fšg”´št
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

104 cÚ¡ 
sdp_medŸ
 *
medŸ
,

105 
s_cÚn
 *
tc
)

107 
¶
 
hash
;

108 
ušt8_t
 
md_sdp
[32], 
md_ds
[32];

109 
size_t
 
sz_sdp
 = (
md_sdp
);

110 
size_t
 
sz_ds
;

111 
s_fšg”´št
 
ty³
;

112 
”r
;

114 ià(
	`sdp_fšg”´št_decode
(
	`sdp_medŸ_£ssiÚ_¿‰r
(
medŸ
, 
£ss
,

116 &
hash
, 
md_sdp
, &
sz_sdp
))

117  
çl£
;

119 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
hash
, "sha-1")) {

120 
ty³
 = 
TLS_FINGERPRINT_SHA1
;

121 
sz_ds
 = 20;

123 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
hash
, "sha-256")) {

124 
ty³
 = 
TLS_FINGERPRINT_SHA256
;

125 
sz_ds
 = 32;

128 
	`w¬nšg
("ds_¤: unknowÀfšg”´šˆ'%r'\n", &
hash
);

129  
çl£
;

132 
”r
 = 
	`s_³”_fšg”´št
(
tc
, 
ty³
, 
md_ds
, (md_dtls));

133 ià(
”r
) {

134 
	`w¬nšg
("dtls_srtp: could‚ot get DTLS fingerprint (%m)\n",

135 
”r
);

136  
çl£
;

139 ià(
sz_sdp
 !ğ
sz_ds
 || 0 !ğ
	`memcmp
(
md_sdp
, 
md_ds
, sz_sdp)) {

140 
	`w¬nšg
("ds_¤: %¸fšg”´šˆmism©ch\n", &
hash
);

141 
	`šfo
("SDP: %w\n", 
md_sdp
, 
sz_sdp
);

142 
	`šfo
("DTLS: %w\n", 
md_ds
, 
sz_ds
);

143  
çl£
;

146 
	`šfo
("ds_¤: v”if›d %¸fšg”´šˆOK\n", &
hash
);

148  
Œue
;

149 
	}
}

152 
	$£ssiÚ_®loc
(
m’c_£ss
 **
£s¥
,

153 
sdp_£ssiÚ
 *
sdp
, 
boŞ
 
ofã»r
,

154 
m’c_”rÜ_h
 *
”rÜh
, *
¬g
)

156 
m’c_£ss
 *
£ss
;

157 
”r
;

159 ià(!
£s¥
 || !
sdp
)

160  
EINVAL
;

162 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ss_de¡ruùÜ
);

163 ià(!
£ss
)

164  
ENOMEM
;

166 
£ss
->
sdp
 = 
	`mem_»f
(sdp);

167 
£ss
->
ofã»r
 = offerer;

168 
£ss
->
”rÜh
 =ƒrrorh;

169 
£ss
->
¬g
 =‡rg;

172 
”r
 = 
	`sdp_£ssiÚ_£t_Ï‰r
(
sdp
, 
Œue
, "setup",

173 
ofã»r
 ? "actpass" : "active");

174 ià(
”r
)

175 
out
;

178 
”r
 = 
	`sdp_£ssiÚ_£t_Ï‰r
(
sdp
, 
Œue
, "fingerprint", "SHA-256 %H",

179 
ds_´št_sha256_fšg”´št
, 
s
);

180 ià(
”r
)

181 
out
;

183 
out
:

184 ià(
”r
)

185 
	`mem_d”ef
(
£ss
);

187 *
£s¥
 = 
£ss
;

189  
”r
;

190 
	}
}

193 
	$ds_e¡ab_hªdËr
(*
¬g
)

195 
comp
 *com°ğ
¬g
;

196 cÚ¡ 
ds_¤
 *
ds
 = 
comp
->ds;

197 
¤_su™e
 
su™e
;

198 
ušt8_t
 
şi_key
[30], 
¤v_key
[30];

199 
”r
;

201 ià(!
	`v”ify_fšg”´št
(
ds
->
£ss
->
sdp
, ds->
sdpm
, 
comp
->
s_cÚn
)) {

202 
	`w¬nšg
("dtls_srtp: could‚ot verify„emote fingerprint\n");

203 ià(
ds
->
£ss
->
”rÜh
)

204 
ds
->
£ss
->
	`”rÜh
(
EPIPE
, ds->£ss->
¬g
);

208 
”r
 = 
	`s_¤_keyšfo
(
comp
->
s_cÚn
, &
su™e
,

209 
şi_key
, (cli_key),

210 
¤v_key
, (srv_key));

211 ià(
”r
) {

212 
	`w¬nšg
("ds_¤: could‚Ù g‘ SRTP keyšfØ(%m)\n", 
”r
);

216 
comp
->
ÃgÙŸ‹d
 = 
Œue
;

218 
	`šfo
("dtls_srtp: ---> DTLS-SRTP complete (%s/%s) Profile=%s\n",

219 
	`sdp_medŸ_Çme
(
ds
->
sdpm
),

220 
comp
->
is_¹p
 ? "RTP" : "RTCP", 
	`¤_su™e_Çme
(
su™e
));

222 
”r
 |ğ
	`¤_¡»am_add
(&
comp
->
tx
, 
su™e
,

223 
ds
->
aùive
 ? 
şi_key
 : 
¤v_key
, 30, 
Œue
);

224 
”r
 |ğ
	`¤_¡»am_add
(&
comp
->
rx
, 
su™e
,

225 
ds
->
aùive
 ? 
¤v_key
 : 
şi_key
, 30, 
çl£
);

227 
”r
 |ğ
	`¤_š¡®l
(
comp
);

228 ià(
”r
) {

229 
	`w¬nšg
("ds_¤: s¹p_š¡®l: %m\n", 
”r
);

233 
	}
}

236 
	$ds_şo£_hªdËr
(
”r
, *
¬g
)

238 
comp
 *com°ğ
¬g
;

240 
	`šfo
("ds_¤: ds-cÚÃùiÚ clo£d (%m)\n", 
”r
);

242 
comp
->
s_cÚn
 = 
	`mem_d”ef
(comp->tls_conn);

244 ià(!
comp
->
ÃgÙŸ‹d
) {

246 ià(
comp
->
ds
->
£ss
->
”rÜh
)

247 
comp
->
ds
->
£ss
->
	`”rÜh
(
”r
, comp->ds->£ss->
¬g
);

249 
	}
}

252 
	$ds_cÚn_hªdËr
(cÚ¡ 
§
 *
³”
, *
¬g
)

254 
comp
 *com°ğ
¬g
;

255 
”r
;

256 ()
³”
;

258 
	`šfo
("ds_¤: incomšg DTLS cÚÃù from %J\n", 
³”
);

260 
”r
 = 
	`ds_acû±
(&
comp
->
s_cÚn
, 
s
, comp->
ds_sock
,

261 
ds_e¡ab_hªdËr
, 
NULL
, 
ds_şo£_hªdËr
, 
comp
);

262 ià(
”r
) {

263 
	`w¬nšg
("ds_¤: ds_acû± faed (%m)\n", 
”r
);

266 
	}
}

269 
	$compÚ’t_¡¬t
(
comp
 *comp, 
sdp_medŸ
 *
sdpm
)

271 
§
 
¿ddr
;

272 
”r
 = 0;

274 ià(!
comp
->
­p_sock
 || comp->
ÃgÙŸ‹d
 || comp->
ds_sock
)

277 ià(
comp
->
is_¹p
)

278 
¿ddr
 = *
	`sdp_medŸ_¿ddr
(
sdpm
);

280 
	`sdp_medŸ_¿ddr_¹ı
(
sdpm
, &
¿ddr
);

282 
”r
 = 
	`ds_li¡’
(&
comp
->
ds_sock
, 
NULL
,

283 
comp
->
­p_sock
, 2, 
LAYER_DTLS
,

284 
ds_cÚn_hªdËr
, 
comp
);

285 ià(
”r
) {

286 
	`w¬nšg
("ds_¤: ds_li¡’ faed (%m)\n", 
”r
);

287  
”r
;

290 ià(
	`§_is£t
(&
¿ddr
, 
SA_ALL
)) {

292 ià(
comp
->
ds
->
aùive
 && !comp->
s_cÚn
) {

294 
”r
 = 
	`ds_cÚÃù
(&
comp
->
s_cÚn
, 
s
,

295 
comp
->
ds_sock
, &
¿ddr
,

296 
ds_e¡ab_hªdËr
, 
NULL
,

297 
ds_şo£_hªdËr
, 
comp
);

298 ià(
”r
) {

299 
	`w¬nšg
("dtls_srtp: dtls_connect()"

300 " faed (%m)\n", 
”r
);

301  
”r
;

306  
”r
;

307 
	}
}

310 
	$medŸ_¡¬t
(
ds_¤
 *
¡
, 
sdp_medŸ
 *
sdpm
)

312 
”r
 = 0;

314 ià(
¡
->
¡¬‹d
)

317 
	`šfo
("dtls_srtp: media=%s -- start DTLS %s\n",

318 
	`sdp_medŸ_Çme
(
sdpm
), 
¡
->
aùive
 ? "client" : "server");

320 ià(!
	`sdp_medŸ_has_medŸ
(
sdpm
))

323 
”r
 = 
	`compÚ’t_¡¬t
(&
¡
->
compv
[0], 
sdpm
);

325 ià(!
¡
->
mux
)

326 
”r
 |ğ
	`compÚ’t_¡¬t
(&
¡
->
compv
[1], 
sdpm
);

328 ià(
”r
)

329  
”r
;

331 
¡
->
¡¬‹d
 = 
Œue
;

334 
	}
}

337 
	$timeout
(*
¬g
)

339 
ds_¤
 *
¡
 = 
¬g
;

341 
	`medŸ_¡¬t
(
¡
, st->
sdpm
);

342 
	}
}

345 
	$medŸ_®loc
(
m’c_medŸ
 **
mp
, 
m’c_£ss
 *
£ss
,

346 
¹p_sock
 *
¹p
, 
´Ùo
,

347 *
¹psock
, *
¹ısock
,

348 
sdp_medŸ
 *
sdpm
)

350 
ds_¤
 *
¡
;

351 cÚ¡ *
£tup
, *
fšg”´št
;

352 
”r
 = 0;

353 
i
;

354 ()
¹p
;

356 ià(!
mp
 || !
£ss
 || 
´Ùo
 !ğ
IPPROTO_UDP
)

357  
EINVAL
;

359 
¡
 = (
ds_¤
 *)*
mp
;

360 ià(
¡
)

361 
£tup
;

363 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

364 ià(!
¡
)

365  
ENOMEM
;

367 
¡
->
£ss
 = sess;

368 
¡
->
sdpm
 = 
	`mem_»f
(sdpm);

369 
¡
->
compv
[0].
­p_sock
 = 
	`mem_»f
(
¹psock
);

370 
¡
->
compv
[1].
­p_sock
 = 
	`mem_»f
(
¹ısock
);

372 
i
=0; i<2; i++)

373 
¡
->
compv
[
i
].
ds
 = st;

375 
¡
->
compv
[0].
is_¹p
 = 
Œue
;

376 
¡
->
compv
[1].
is_¹p
 = 
çl£
;

378 
”r
 = 
	`sdp_medŸ_£t_®t_´Ùos
(
¡
->
sdpm
, 4,

383 ià(
”r
)

384 
out
;

386 
out
:

387 ià(
”r
) {

388 
	`mem_d”ef
(
¡
);

389  
”r
;

392 *
mp
 = (
m’c_medŸ
 *)
¡
;

394 
£tup
:

395 
¡
->
mux
 = (
¹psock
 =ğ
¹ısock
è|| (¹ısock =ğ
NULL
);

397 
£tup
 = 
	`sdp_medŸ_£ssiÚ_¿‰r
(
¡
->
sdpm
, st->
£ss
->
sdp
, "setup");

398 ià(
£tup
) {

399 
¡
->
aùive
 = !(0 =ğ
	`¡r_ÿ£cmp
(
£tup
, "active"));

402 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
timeout
, st);

406 
fšg”´št
 = 
	`sdp_medŸ_£ssiÚ_¿‰r
(
¡
->
sdpm
, st->
£ss
->
sdp
,

408 ià(
fšg”´št
) {

410 
¶
 
hash
;

412 
”r
 = 
	`sdp_fšg”´št_decode
(
fšg”´št
, &
hash
, 
NULL
, NULL);

413 ià(
”r
)

414  
”r
;

416 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
hash
, "SHA-1")) {

417 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
¡
->
sdpm
, 
Œue
,

419 
ds_´št_sha1_fšg”´št
,

420 
s
);

422 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
hash
, "SHA-256")) {

423 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
¡
->
sdpm
, 
Œue
,

425 
ds_´št_sha256_fšg”´št
,

426 
s
);

429 
	`šfo
("dtls_srtp: unsupported fingerprint hash `%r'\n",

430 &
hash
);

431  
EPROTO
;

435  
”r
;

436 
	}
}

439 
m’c
 
	gds_¤
 = {

440 
LE_INIT
, "ds_¤", "UDP/TLS/RTP/SAVP", 
£ssiÚ_®loc
, 
medŸ_®loc


443 
m’c
 
	gds_¤f
 = {

444 
LE_INIT
, "ds_¤f", "UDP/TLS/RTP/SAVPF", 
£ssiÚ_®loc
, 
medŸ_®loc


447 
m’c
 
	gds_¤2
 = {

449 
LE_INIT
, "¤-mªdf", "RTP/SAVPF", 
£ssiÚ_®loc
, 
medŸ_®loc


453 
	$moduË_š™
()

455 
li¡
 *
m’ş
 = 
	`b¬es_m’ş
();

456 
”r
;

458 
”r
 = 
	`s_®loc
(&
s
, 
TLS_METHOD_DTLSV1
, 
NULL
, NULL);

459 ià(
”r
) {

460 
	`w¬nšg
("dtls_srtp: failedo create DTLS context (%m)\n",

461 
”r
);

462  
”r
;

465 
”r
 = 
	`s_£t_£lfsigÃd
(
s
, "dtls@baresip");

466 ià(
”r
) {

467 
	`w¬nšg
("dtls_srtp: failedo self-sign certificate (%m)\n",

468 
”r
);

469  
”r
;

472 
	`s_£t_v”ify_ş›Á
(
s
);

474 
”r
 = 
	`s_£t_¤
(
s
, 
¤_´ofes
);

475 ià(
”r
) {

476 
	`w¬nšg
("dtls_srtp: failedoƒnable SRTP…rofile (%m)\n",

477 
”r
);

478  
”r
;

481 
	`m’c_»gi¡”
(
m’ş
, &
ds_¤f
);

482 
	`m’c_»gi¡”
(
m’ş
, &
ds_¤
);

483 
	`m’c_»gi¡”
(
m’ş
, &
ds_¤2
);

485 
	`debug
("DTLS-SRTP„—dy w™h…rofe %s\n", 
¤_´ofes
);

488 
	}
}

491 
	$moduË_şo£
()

493 
	`m’c_uÄegi¡”
(&
ds_¤
);

494 
	`m’c_uÄegi¡”
(&
ds_¤f
);

495 
	`m’c_uÄegi¡”
(&
ds_¤2
);

496 
s
 = 
	`mem_d”ef
(tls);

499 
	}
}

502 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
ds_¤
) = {

505 
moduË_š™
,

506 
moduË_şo£


	@baresip/modules/dtls_srtp/dtls_srtp.h

9 
	mLAYER_SRTP
 = 20,

10 
	mLAYER_DTLS
 = 20,

13 
	scomp
 {

14 cÚ¡ 
ds_¤
 *
	mds
;

15 
ds_sock
 *
	mds_sock
;

16 
s_cÚn
 *
	ms_cÚn
;

17 
¤_¡»am
 *
	mtx
;

18 
¤_¡»am
 *
	mrx
;

19 
udp_h–³r
 *
	muh_¤
;

20 *
	m­p_sock
;

21 
boŞ
 
	mÃgÙŸ‹d
;

22 
boŞ
 
	mis_¹p
;

26 
ds_´št_sha1_fšg”´št
(
»_´štf
 *
pf
, cÚ¡ 
s
 *tls);

27 
ds_´št_sha256_fšg”´št
(
»_´štf
 *
pf
, cÚ¡ 
s
 *tls);

31 
¤_¡»am_add
(
¤_¡»am
 **
¥
, 
¤_su™e
 
su™e
,

32 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_size
, 
boŞ
 
tx
);

33 
¤_š¡®l
(
comp
 *comp);

	@baresip/modules/dtls_srtp/srtp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"ds_¤.h
"

12 
	s¤_¡»am
 {

13 
¤
 *
	m¤
;

29 
šlše
 
boŞ
 
	$is_¹p_Ü_¹ı
(cÚ¡ 
mbuf
 *
mb
)

31 
ušt8_t
 
b
;

33 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

34  
çl£
;

36 
b
 = 
	`mbuf_buf
(
mb
)[0];

38  127 < 
b
 && b < 192;

39 
	}
}

42 
šlše
 
boŞ
 
	$is_¹ı_·ck‘
(cÚ¡ 
mbuf
 *
mb
)

44 
ušt8_t
 
±
;

46 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

47  
çl£
;

49 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

51  64 <ğ
±
 &&…t <= 95;

52 
	}
}

55 
	$de¡ruùÜ
(*
¬g
)

57 
¤_¡»am
 *
s
 = 
¬g
;

59 
	`mem_d”ef
(
s
->
¤
);

60 
	}
}

63 
boŞ
 
	$£nd_hªdËr
(*
”r
, 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

65 
comp
 *com°ğ
¬g
;

66 ()
d¡
;

68 ià(!
	`is_¹p_Ü_¹ı
(
mb
))

69  
çl£
;

71 ià(
	`is_¹ı_·ck‘
(
mb
)) {

72 *
”r
 = 
	`¤tı_’üy±
(
comp
->
tx
->
¤
, 
mb
);

73 ià(*
”r
) {

74 
	`w¬nšg
("¤: s¹ı_’üy± faed (%m)\n", *
”r
);

78 *
”r
 = 
	`¤_’üy±
(
comp
->
tx
->
¤
, 
mb
);

79 ià(*
”r
) {

80 
	`w¬nšg
("¤: s¹p_’üy± faed (%m)\n", *
”r
);

85  *
”r
 ? 
Œue
 : 
çl£
;

86 
	}
}

89 
boŞ
 
	$»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

91 
comp
 *com°ğ
¬g
;

92 
”r
;

93 ()
¤c
;

95 ià(!
	`is_¹p_Ü_¹ı
(
mb
))

96  
çl£
;

98 ià(
	`is_¹ı_·ck‘
(
mb
)) {

99 
”r
 = 
	`¤tı_deüy±
(
comp
->
rx
->
¤
, 
mb
);

102 
”r
 = 
	`¤_deüy±
(
comp
->
rx
->
¤
, 
mb
);

105 ià(
”r
) {

106 
	`w¬nšg
("srtp:„ecv: failedo decrypt %s-packet (%m)\n",

107 
	`is_¹ı_·ck‘
(
mb
è? "RTCP" : "RTP", 
”r
);

108  
Œue
;

111  
çl£
;

112 
	}
}

115 
	$¤_¡»am_add
(
¤_¡»am
 **
¥
, 
¤_su™e
 
su™e
,

116 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_size
, 
boŞ
 
tx
)

118 
¤_¡»am
 *
s
;

119 
”r
 = 0;

120 ()
tx
;

122 ià(!
¥
 || !
key
)

123  
EINVAL
;

125 
s
 = 
	`mem_z®loc
((*s), 
de¡ruùÜ
);

126 ià(!
s
)

127  
ENOMEM
;

129 
”r
 = 
	`¤_®loc
(&
s
->
¤
, 
su™e
, 
key
, 
key_size
, 0);

130 ià(
”r
) {

131 
	`w¬nšg
("¤: s¹p_®loc(èçed (%m)\n", 
”r
);

132 
out
;

135 
out
:

136 ià(
”r
)

137 
	`mem_d”ef
(
s
);

139 *
¥
 = 
s
;

141  
”r
;

142 
	}
}

145 
	$¤_š¡®l
(
comp
 *comp)

147  
	`udp_»gi¡”_h–³r
(&
comp
->
uh_¤
, comp->
­p_sock
,

148 
LAYER_SRTP
,

149 
£nd_hªdËr
, 
»cv_hªdËr
, 
comp
);

150 
	}
}

	@baresip/modules/dtmfio/dtmfio.c

60 
	~<uni¡d.h
>

61 
	~<¡dio.h
>

62 
	~<».h
>

63 
	~<b¬es.h
>

64 
	~<sys/ty³s.h
>

65 
	~<sys/¡©.h
>

68 
FILE
 *
	gfd
;

69 cÚ¡ *
	gDTMF_OUT
 = "/tmp/dtmf.out";

72 
	$dtmf_hªdËr
(
ÿÎ
 *ÿÎ, 
key
, *
¬g
)

74 ()
ÿÎ
;

75 ()
¬g
;

77 iàĞ
key
 != 0 ) {

78 
	`årštf
(
fd
, "%c", 
key
);

79 
	`fæush
(
fd
);

81 
	}
}

84 
	$ua_ev’t_hªdËr
(
ua
 *ua,

85 
ua_ev’t
 
ev
,

86 
ÿÎ
 *call,

87 cÚ¡ *
´m
,

88 *
¬g
 )

90 ()
ua
;

91 ()
´m
;

92 ()
¬g
;

94 iàĞ
ev
 =ğ
UA_EVENT_CALL_ESTABLISHED
 ) {

95 
	`årštf
(
fd
, "E");

96 
	`fæush
(
fd
);

97 
	`ÿÎ_£t_hªdËrs
Ğ
ÿÎ
, 
NULL
, 
dtmf_hªdËr
, NULL);

100 ià(
ev
 =ğ
UA_EVENT_CALL_CLOSED
 ) {

101 
	`årštf
(
fd
, "F");

102 
	`fæush
(
fd
);

104 
	}
}

107 
	$moduË_š™
()

109 iàĞ
	`mkfifo
Ğ
DTMF_OUT
, 
S_IWUSR
 | 
S_IRUSR
 ) ) {

110 
”r
 = 
”ºo
;

111 
	`w¬nšg
("Creation ofhe FIFOƒrrored."

112 " Thi mighˆÿu£ issues. (%m)\n", 
”r
);

113  
”r
;

116 
fd
 = 
	`fİ’
Ğ
DTMF_OUT
 , "w+" );

118 iàĞ
fd
 == 0 ){

119 
	`w¬nšg
("Opening ofhe FIFOƒrrored."

123 
	`uag_ev’t_»gi¡”
Ğ
ua_ev’t_hªdËr
, 
NULL
 );

126 
	}
}

129 
	$moduË_şo£
()

131 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

133 ià(
fd
) {

134 
	`fşo£
(
fd
);

135 
fd
 = 
NULL
;

138 
	`uÆšk
(
DTMF_OUT
);

141 
	}
}

144 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
dtmfio
) = {

147 
moduË_š™
,

148 
moduË_şo£


	@baresip/modules/echo/echo.c

4 
	~<».h
>

5 
	~<b¬es.h
>

16 
	s£ssiÚ
 {

17 
Ë
 
	mË
;

18 
ÿÎ
 *
	mÿÎ_š
;

22 
li¡
 
	g£ssiÚl
;

25 
	$de¡ruùÜ
(*
¬g
)

27 
£ssiÚ
 *
£ss
 = 
¬g
;

29 
	`debug
("echo: session destroyed (in=%p)\n",

30 
£ss
->
ÿÎ_š
);

32 
	`li¡_uÆšk
(&
£ss
->
Ë
);

33 
	`mem_d”ef
(
£ss
->
ÿÎ_š
);

34 
	}
}

37 
	$ÿÎ_ev’t_hªdËr
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t
 
ev
,

38 cÚ¡ *
¡r
, *
¬g
)

40 
£ssiÚ
 *
£ss
 = 
¬g
;

41 ()
ÿÎ
;

43 
ev
) {

45 
CALL_EVENT_CLOSED
:

46 
	`debug
("echo: CALL_CLOSED: %s\n", 
¡r
);

47 
	`mem_d”ef
(
£ss
);

53 
	}
}

56 
	$ÿÎ_dtmf_hªdËr
(
ÿÎ
 *ÿÎ, 
key
, *
¬g
)

58 ()
¬g
;

60 
	`debug
("echo:„–ayšg DTMFƒv’t: key = '%c'\n", 
key
 ? key : '.');

62 
	`ÿÎ_£nd_dig™
(
ÿÎ
, 
key
);

63 
	}
}

66 
	$Ãw_£ssiÚ
(
ÿÎ
 *call)

68 
£ssiÚ
 *
£ss
;

69 
a
[64];

70 
”r
 = 0;

72 
£ss
 = 
	`mem_z®loc
((*£ss), 
de¡ruùÜ
);

73 ià(!
£ss
)

74  
ENOMEM
;

76 
£ss
->
ÿÎ_š
 = 
ÿÎ
;

78 
	`»_¢´štf
(
a
, ×), "A-%x", 
£ss
);

80 
	`audio_£t_deviûÇme
(
	`ÿÎ_audio
(
£ss
->
ÿÎ_š
), 
a
,‡);

82 
	`ÿÎ_£t_hªdËrs
(
£ss
->
ÿÎ_š
, 
ÿÎ_ev’t_hªdËr
,

83 
ÿÎ_dtmf_hªdËr
, 
£ss
);

85 
	`li¡_­³nd
(&
£ssiÚl
, &
£ss
->
Ë
, sess);

86 
	`ua_ªsw”
(
	`uag_cu¼’t
(), 
NULL
);

88 ià(
”r
)

89 
	`mem_d”ef
(
£ss
);

91  
”r
;

92 
	}
}

95 
	$ua_ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

96 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

98 
”r
;

99 ()
´m
;

100 ()
¬g
;

102 
ev
) {

104 
UA_EVENT_CALL_INCOMING
:

105 
	`debug
("echo: CALL_INCOMING:…eer=%s -->†ocal=%s\n",

106 
	`ÿÎ_³”uri
(
ÿÎ
),

107 
	`ÿÎ_loÿluri
(
ÿÎ
));

109 
”r
 = 
	`Ãw_£ssiÚ
(
ÿÎ
);

110 ià(
”r
) {

111 
	`ua_hªgup
(
ua
, 
ÿÎ
, 500, "Server Error");

118 
	}
}

121 
	$moduË_š™
()

123 
”r
;

125 
	`li¡_š™
(&
£ssiÚl
);

127 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, 0);

128 ià(
”r
)

129  
”r
;

131 
	`debug
("echo: module†oaded\n");

134 
	}
}

137 
	$moduË_şo£
()

139 
	`debug
("echo: module closing..\n");

141 ià(!
	`li¡_i£m±y
(&
£ssiÚl
)) {

143 
	`šfo
("echo: flushšg %u sessiÚs\n", 
	`li¡_couÁ
(&
£ssiÚl
));

144 
	`li¡_æush
(&
£ssiÚl
);

147 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

150 
	}
}

153 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
echo
) = {

156 
moduË_š™
,

157 
moduË_şo£


	@baresip/modules/evdev/evdev.c

6 
	~<uni¡d.h
>

7 
	~<sys/ioùl.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sys/¡©.h
>

10 
	~<fú.h
>

11 
	~<lšux/šput.h
>

12 
	~<».h
>

13 
	~<b¬es.h
>

14 
	~"´št.h
"

30 
	sui_¡
 {

31 
	mfd
;

35 
ui_¡
 *
	gevdev
;

36 
	gevdev_deviû
[64] = "/dev/input/event0";

39 
	$evdev_şo£
(
ui_¡
 *
¡
)

41 ià(
¡
->
fd
 < 0)

44 
	`fd_şo£
(
¡
->
fd
);

45 ()
	`şo£
(
¡
->
fd
);

46 
¡
->
fd
 = -1;

47 
	}
}

50 
	$evdev_de¡ruùÜ
(*
¬g
)

52 
ui_¡
 *
¡
 = 
¬g
;

54 
	`evdev_şo£
(
¡
);

55 
	}
}

58 
	$code2ascii
(
ušt16_t
 
modif›r
, ušt16_ˆ
code
)

60 
code
) {

62 
KEY_0
:  '0';

63 
KEY_1
:  '1';

64 
KEY_2
:  '2';

65 
KEY_3
:  
KEY_LEFTSHIFT
==
modif›r
 ? '#' : '3';

66 
KEY_4
:  '4';

67 
KEY_5
:  '5';

68 
KEY_6
:  '6';

69 
KEY_7
:  '7';

70 
KEY_8
:  '8';

71 
KEY_9
:  '9';

72 
KEY_BACKSPACE
:  '\b';

73 
KEY_ENTER
:  '\n';

74 
KEY_ESC
:  0x1b;

75 
KEY_KPASTERISK
:  '*';

76 #ifdeà
KEY_NUMERIC_0


77 
KEY_NUMERIC_0
:  '0';

79 #ifdeà
KEY_NUMERIC_1


80 
KEY_NUMERIC_1
:  '1';

82 #ifdeà
KEY_NUMERIC_2


83 
KEY_NUMERIC_2
:  '2';

85 #ifdeà
KEY_NUMERIC_3


86 
KEY_NUMERIC_3
:  '3';

88 #ifdeà
KEY_NUMERIC_4


89 
KEY_NUMERIC_4
:  '4';

91 #ifdeà
KEY_NUMERIC_5


92 
KEY_NUMERIC_5
:  '5';

94 #ifdeà
KEY_NUMERIC_6


95 
KEY_NUMERIC_6
:  '6';

97 #ifdeà
KEY_NUMERIC_7


98 
KEY_NUMERIC_7
:  '7';

100 #ifdeà
KEY_NUMERIC_8


101 
KEY_NUMERIC_8
:  '8';

103 #ifdeà
KEY_NUMERIC_9


104 
KEY_NUMERIC_9
:  '9';

106 #ifdeà
KEY_NUMERIC_STAR


107 
KEY_NUMERIC_STAR
:  '*';

109 #ifdeà
KEY_NUMERIC_POUND


110 
KEY_NUMERIC_POUND
:  '#';

112 #ifdeà
KEY_KP0


113 
KEY_KP0
:  '0';

115 #ifdeà
KEY_KP1


116 
KEY_KP1
:  '1';

118 #ifdeà
KEY_KP2


119 
KEY_KP2
:  '2';

121 #ifdeà
KEY_KP3


122 
KEY_KP3
:  '3';

124 #ifdeà
KEY_KP4


125 
KEY_KP4
:  '4';

127 #ifdeà
KEY_KP5


128 
KEY_KP5
:  '5';

130 #ifdeà
KEY_KP6


131 
KEY_KP6
:  '6';

133 #ifdeà
KEY_KP7


134 
KEY_KP7
:  '7';

136 #ifdeà
KEY_KP8


137 
KEY_KP8
:  '8';

139 #ifdeà
KEY_KP9


140 
KEY_KP9
:  '9';

142 #ifdeà
KEY_KPDOT


143 
KEY_KPDOT
:  0x1b;

145 #ifdeà
KEY_KPENTER


146 
KEY_KPENTER
:  '\n';

150 
	}
}

153 
	$¡d”r_hªdËr
(cÚ¡ *
p
, 
size_t
 
sz
, *
¬g
)

155 ()
¬g
;

157 ià(
	`wr™e
(
STDERR_FILENO
, 
p
, 
sz
) < 0)

158  
”ºo
;

161 
	}
}

164 
	$»pÜtkey
(
ui_¡
 *
¡
, 
ascii
)

166 
»_´štf
 
pf_¡d”r
 = {
¡d”r_hªdËr
, 
NULL
};

167 ()
¡
;

169 
	`ui_šput_key
(
	`b¬es_uis
(), 
ascii
, &
pf_¡d”r
);

170 
	}
}

173 
	$evdev_fd_hªdËr
(
æags
, *
¬g
)

175 
ui_¡
 *
¡
 = 
¬g
;

176 
šput_ev’t
 
evv
[64];

177 
ušt16_t
 
modif›r
 = 0;

178 
size_t
 
n
;

179 
i
;

182 ià(
æags
 & 
FD_EXCEPT
) {

183 
	`w¬nšg
("evdev: fd handler: FD_EXCEPT - device unplugged?\n");

184 
	`evdev_şo£
(
¡
);

188 
n
 = 
	`»ad
(
¡
->
fd
, 
evv
, (evv));

190 ià(
n
 < (è(
šput_ev’t
)) {

191 
	`w¬nšg
("evdev:ƒv’t: shÜˆ»ad (%m)\n", 
”ºo
);

195 
i
 = 0; i < (è(
n
 / (
šput_ev’t
)); i++) {

196 cÚ¡ 
šput_ev’t
 *
ev
 = &
evv
[
i
];

198 ià(
EV_KEY
 !ğ
ev
->
ty³
)

201 ià(
KEY_LEFTSHIFT
 =ğ
ev
->
code
) {

202 
modif›r
 = 
KEY_LEFTSHIFT
;

206 ià(1 =ğ
ev
->
v®ue
) {

207 cÚ¡ 
ascii
 = 
	`code2ascii
(
modif›r
, 
ev
->
code
);

208 ià(-1 =ğ
ascii
) {

209 
	`w¬nšg
("evdev: unhandled key code %u\n",

210 
ev
->
code
);

213 
	`»pÜtkey
(
¡
, 
ascii
);

214 
modif›r
 = 0;

216 ià(0 =ğ
ev
->
v®ue
) {

217 
	`»pÜtkey
(
¡
, 
KEYCODE_REL
);

220 
	}
}

223 
	$evdev_®loc
(
ui_¡
 **
¡p
, cÚ¡ *
dev
)

225 
ui_¡
 *
¡
;

226 
”r
 = 0;

228 ià(!
¡p
)

229  
EINVAL
;

231 
¡
 = 
	`mem_z®loc
((*¡), 
evdev_de¡ruùÜ
);

232 ià(!
¡
)

233  
ENOMEM
;

235 
¡
->
fd
 = 
	`İ’
(
dev
, 
O_RDWR
);

236 ià(
¡
->
fd
 < 0) {

237 
”r
 = 
”ºo
;

238 
	`w¬nšg
("evdev: faedØİ’ deviû '%s' (%m)\n", 
dev
, 
”r
);

239 
out
;

245 ià(-1 =ğ
	`ioùl
(
¡
->
fd
, 
EVIOCGRAB
, (*)1)) {

246 
	`w¬nšg
("evdev: ioùÈEVIOCGRAB oÀ% (%m)\n", 
dev
, 
”ºo
);

250 
	`´št_Çme
(
¡
->
fd
);

251 
	`´št_ev’ts
(
¡
->
fd
);

252 
	`´št_keys
(
¡
->
fd
);

253 
	`´št_Ëds
(
¡
->
fd
);

255 
”r
 = 
	`fd_li¡’
(
¡
->
fd
, 
FD_READ
, 
evdev_fd_hªdËr
, st);

256 ià(
”r
)

257 
out
;

259 
out
:

260 ià(
”r
)

261 
	`mem_d”ef
(
¡
);

263 *
¡p
 = 
¡
;

265  
”r
;

266 
	}
}

269 
	$buzz
(cÚ¡ 
ui_¡
 *
¡
, 
v®ue
)

271 
šput_ev’t
 
ev
;

272 
ssize_t
 
n
;

274 
ev
.
ty³
 = 
EV_SND
;

275 
ev
.
code
 = 
SND_BELL
;

276 
ev
.
v®ue
 = value;

278 
n
 = 
	`wr™e
(
¡
->
fd
, &
ev
, (ev));

279 ià(
n
 < 0) {

280 
	`w¬nšg
("evdev: ouut: wr™fd=%d (%m)\n", 
¡
->
fd
, 
”ºo
);

283  
”ºo
;

284 
	}
}

287 
	$evdev_ouut
(cÚ¡ *
¡r
)

289 
ui_¡
 *
¡
 = 
evdev
;

290 
”r
 = 0;

292 ià(!
¡
 || !
¡r
)

293  
EINVAL
;

295 *
¡r
) {

296 *
¡r
++) {

299 
”r
 |ğ
	`buzz
(
¡
, 1);

303 
”r
 |ğ
	`buzz
(
¡
, 0);

308  
”r
;

309 
	}
}

312 
ui
 
	gui_evdev
 = {

313 .
Çme
 = "evdev",

314 .
	gouuth
 = 
evdev_ouut


318 
	$moduË_š™
()

320 
”r
;

322 
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "evdev_device",

323 
evdev_deviû
, (evdev_device));

325 
”r
 = 
	`evdev_®loc
(&
evdev
, 
evdev_deviû
);

326 ià(
”r
)

327  
”r
;

329 
	`ui_»gi¡”
(
	`b¬es_uis
(), &
ui_evdev
);

332 
	}
}

335 
	$moduË_şo£
()

337 
	`ui_uÄegi¡”
(&
ui_evdev
);

338 
evdev
 = 
	`mem_d”ef
(evdev);

340 
	}
}

343 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
evdev
) = {

346 
moduË_š™
,

347 
moduË_şo£


	@baresip/modules/evdev/print.c

6 
	~<¡ršg.h
>

7 
	~<uni¡d.h
>

8 
	~<sys/ioùl.h
>

9 
	~<sys/ty³s.h
>

10 
	~<sys/¡©.h
>

11 
	~<fú.h
>

12 
	~<lšux/šput.h
>

13 
	~<».h
>

14 
	~<b¬es.h
>

15 
	~"´št.h
"

18 
	#‹¡_b™
(
b™
, 
¬¿y
è×¼ay[b™/8] & (1<<(b™%8)))

	)

26 
	$´št_Çme
(
fd
)

28 
Çme
[256]= "Unknown";

30 ià(
	`ioùl
(
fd
, 
	`EVIOCGNAME
((
Çme
)),‚ame) < 0) {

31 
	`³¼Ü
("evdev ioctl");

34 
	`šfo
("evdev: deviû‚ame: %s\n", 
Çme
);

35 
	}
}

43 
	$´št_ev’ts
(
fd
)

45 
ušt8_t
 
evty³_b™mask
[
EV_MAX
/8 + 1];

46 
i
;

48 
	`mem£t
(
evty³_b™mask
, 0, (evtype_bitmask));

49 ià(
	`ioùl
(
fd
, 
	`EVIOCGBIT
(0, 
EV_MAX
), 
evty³_b™mask
) < 0) {

50 
	`w¬nšg
("evdev: ioùÈEVIOCGBIT (%m)\n", 
”ºo
);

54 
	`´štf
("Supportedƒventypes:\n");

56 
i
 = 0; i < 
EV_MAX
; i++) {

57 ià(!
	`‹¡_b™
(
i
, 
evty³_b™mask
))

60 
	`´štf
(" Ev’ˆty³ 0x%02x ", 
i
);

62 
i
) {

64 
EV_KEY
 :

65 
	`´štf
(" (Keys or Buttons)\n");

67 
EV_REL
 :

68 
	`´štf
(" (Relative Axes)\n");

70 
EV_ABS
 :

71 
	`´štf
(" (Absolute Axes)\n");

73 
EV_MSC
 :

74 
	`´štf
(" (Something miscellaneous)\n");

76 
EV_LED
 :

77 
	`´štf
(" (LEDs)\n");

79 
EV_SND
 :

80 
	`´štf
(" (Sounds)\n");

82 
EV_REP
 :

83 
	`´štf
(" (Repeat)\n");

85 
EV_FF
 :

86 
	`´štf
(" (Force Feedback)\n");

89 
	`´štf
(" (UnknowÀev’ˆty³: 0x%04x)\n", 
i
);

93 
	}
}

101 
	$´št_keys
(
fd
)

103 
ušt8_t
 
key_b™mask
[
KEY_MAX
/8 + 1];

104 
i
;

106 
	`mem£t
(
key_b™mask
, 0, (key_bitmask));

107 ià(
	`ioùl
(
fd
, 
	`EVIOCGBIT
(
EV_KEY
, (
key_b™mask
)),

108 
key_b™mask
) < 0) {

109 
	`³¼Ü
("evdev ioctl");

112 
	`´štf
("Supported Keys:\n");

114 
i
 = 0; i < 
KEY_MAX
; i++) {

115 ià(!
	`‹¡_b™
(
i
, 
key_b™mask
))

118 
	`´štf
(" Key 0x%02x ", 
i
);

120 
i
) {

122 
KEY_RESERVED
 : 
	`´štf
(" (Reserved)\n"); ;

123 
KEY_ESC
 : 
	`´štf
(" (Escape)\n"); ;

124 
KEY_1
 : 
	`´štf
(" (1)\n"); ;

125 
KEY_2
 : 
	`´štf
(" (2)\n"); ;

126 
KEY_3
 : 
	`´štf
(" (3)\n"); ;

127 
KEY_4
 : 
	`´štf
(" (4)\n"); ;

128 
KEY_5
 : 
	`´štf
(" (5)\n"); ;

129 
KEY_6
 : 
	`´štf
(" (6)\n"); ;

130 
KEY_7
 : 
	`´štf
(" (7)\n"); ;

131 
KEY_8
 : 
	`´štf
(" (8)\n"); ;

132 
KEY_9
 : 
	`´štf
(" ()\n"); ;

133 
KEY_0
 : 
	`´štf
(" ()\n"); ;

134 
KEY_MINUS
 : 
	`´štf
(" (-)\n"); ;

135 
KEY_EQUAL
 : 
	`´štf
(" (=)\n"); ;

136 
KEY_BACKSPACE
 : 
	`´štf
(" (Backspace)\n"); ;

137 
KEY_TAB
 : 
	`´štf
(" (Tab)\n"); ;

138 
KEY_Q
 : 
	`´štf
(" (Q)\n"); ;

139 
KEY_W
 : 
	`´štf
(" (W)\n"); ;

140 
KEY_E
 : 
	`´štf
(" (E)\n"); ;

141 
KEY_R
 : 
	`´štf
(" (R)\n"); ;

142 
KEY_T
 : 
	`´štf
(" (T)\n"); ;

143 
KEY_Y
 : 
	`´štf
(" (Y)\n"); ;

144 
KEY_U
 : 
	`´štf
(" (U)\n"); ;

145 
KEY_I
 : 
	`´štf
(" (I)\n"); ;

146 
KEY_O
 : 
	`´štf
(" (O)\n"); ;

147 
KEY_P
 : 
	`´štf
(" (P)\n"); ;

148 
KEY_LEFTBRACE
 : 
	`´štf
(" ([)\n"); ;

149 
KEY_RIGHTBRACE
 : 
	`´štf
(" (])\n"); ;

150 
KEY_ENTER
 : 
	`´štf
(" (Enter)\n"); ;

151 
KEY_LEFTCTRL
 : 
	`´štf
(" (LH Control)\n"); ;

152 
KEY_A
 : 
	`´štf
(" (A)\n"); ;

153 
KEY_S
 : 
	`´štf
(" (S)\n"); ;

154 
KEY_D
 : 
	`´štf
(" (D)\n"); ;

155 
KEY_F
 : 
	`´štf
(" (F)\n"); ;

156 
KEY_G
 : 
	`´štf
(" (G)\n"); ;

157 
KEY_H
 : 
	`´štf
(" (H)\n"); ;

158 
KEY_J
 : 
	`´štf
(" (J)\n"); ;

159 
KEY_K
 : 
	`´štf
(" (K)\n"); ;

160 
KEY_L
 : 
	`´štf
(" (L)\n"); ;

161 
KEY_SEMICOLON
 : 
	`´štf
(" (;)\n"); ;

162 
KEY_APOSTROPHE
 : 
	`´štf
(" (')\n"); ;

163 
KEY_GRAVE
 : 
	`´štf
(" (`)\n"); ;

164 
KEY_LEFTSHIFT
 : 
	`´štf
(" (LH Shift)\n"); ;

165 
KEY_BACKSLASH
 : 
	`´štf
(" (\\)\n"); ;

166 
KEY_Z
 : 
	`´štf
(" (Z)\n"); ;

167 
KEY_X
 : 
	`´štf
(" (X)\n"); ;

168 
KEY_C
 : 
	`´štf
(" (C)\n"); ;

169 
KEY_V
 : 
	`´štf
(" (V)\n"); ;

170 
KEY_B
 : 
	`´štf
(" (B)\n"); ;

171 
KEY_N
 : 
	`´štf
(" (N)\n"); ;

172 
KEY_M
 : 
	`´štf
(" (M)\n"); ;

173 
KEY_COMMA
 : 
	`´štf
(" (,)\n"); ;

174 
KEY_DOT
 : 
	`´štf
(" (.)\n"); ;

175 
KEY_SLASH
 : 
	`´štf
(" (/)\n"); ;

176 
KEY_RIGHTSHIFT
 : 
	`´štf
(" (RH Shift)\n"); ;

177 
KEY_KPASTERISK
 : 
	`´štf
(" (*)\n"); ;

178 
KEY_LEFTALT
 : 
	`´štf
(" (LH Alt)\n"); ;

179 
KEY_SPACE
 : 
	`´štf
(" (Space)\n"); ;

180 
KEY_CAPSLOCK
 : 
	`´štf
(" (CapsLock)\n"); ;

181 
KEY_F1
 : 
	`´štf
(" (F1)\n"); ;

182 
KEY_F2
 : 
	`´štf
(" (F2)\n"); ;

183 
KEY_F3
 : 
	`´štf
(" (F3)\n"); ;

184 
KEY_F4
 : 
	`´štf
(" (F4)\n"); ;

185 
KEY_F5
 : 
	`´štf
(" (F5)\n"); ;

186 
KEY_F6
 : 
	`´štf
(" (F6)\n"); ;

187 
KEY_F7
 : 
	`´štf
(" (F7)\n"); ;

188 
KEY_F8
 : 
	`´štf
(" (F8)\n"); ;

189 
KEY_F9
 : 
	`´štf
(" (F9)\n"); ;

190 
KEY_F10
 : 
	`´štf
(" (F10)\n"); ;

191 
KEY_NUMLOCK
 : 
	`´štf
(" (NumLock)\n"); ;

192 
KEY_SCROLLLOCK
 : 
	`´štf
(" (ScrollLock)\n"); ;

193 
KEY_KP7
 : 
	`´štf
(" (KeyPad 7)\n"); ;

194 
KEY_KP8
 : 
	`´štf
(" (KeyPad 8)\n"); ;

195 
KEY_KP9
 : 
	`´štf
(" (Keypad 9)\n"); ;

196 
KEY_KPMINUS
 : 
	`´štf
(" (KeyPad Minus)\n"); ;

197 
KEY_KP4
 : 
	`´štf
(" (KeyPad 4)\n"); ;

198 
KEY_KP5
 : 
	`´štf
(" (KeyPad 5)\n"); ;

199 
KEY_KP6
 : 
	`´štf
(" (KeyPad 6)\n"); ;

200 
KEY_KPPLUS
 : 
	`´štf
(" (KeyPad Plus)\n"); ;

201 
KEY_KP1
 : 
	`´štf
(" (KeyPad 1)\n"); ;

202 
KEY_KP2
 : 
	`´štf
(" (KeyPad 2)\n"); ;

203 
KEY_KP3
 : 
	`´štf
(" (KeyPad 3)\n"); ;

204 
KEY_KPDOT
 : 
	`´štf
(" (KeyPad decimal…oint)\n"); ;

206 
KEY_F13
 : 
	`´štf
(" (F13)\n"); ;

207 
KEY_102ND
 : 
	`´štf
(" (Beats me...)\n"); ;

208 
KEY_F11
 : 
	`´štf
(" (F11)\n"); ;

209 
KEY_F12
 : 
	`´štf
(" (F12)\n"); ;

210 
KEY_F14
 : 
	`´štf
(" (F14)\n"); ;

211 
KEY_F15
 : 
	`´štf
(" (F15)\n"); ;

212 
KEY_F16
 : 
	`´štf
(" (F16)\n"); ;

213 
KEY_F17
 : 
	`´štf
(" (F17)\n"); ;

214 
KEY_F18
 : 
	`´štf
(" (F18)\n"); ;

215 
KEY_F19
 : 
	`´štf
(" (F19)\n"); ;

216 
KEY_F20
 : 
	`´štf
(" (F20)\n"); ;

217 
KEY_KPENTER
 : 
	`´štf
(" (Keypad Enter)\n"); ;

218 
KEY_RIGHTCTRL
 : 
	`´štf
(" (RH Control)\n"); ;

219 
KEY_KPSLASH
 : 
	`´štf
(" (KeyPad Forward Slash)\n"); ;

220 
KEY_SYSRQ
 : 
	`´štf
(" (System Request)\n"); ;

221 
KEY_RIGHTALT
 : 
	`´štf
(" (RH Alternate)\n"); ;

222 
KEY_LINEFEED
 : 
	`´štf
(" (Line Feed)\n"); ;

223 
KEY_HOME
 : 
	`´štf
(" (Home)\n"); ;

224 
KEY_UP
 : 
	`´štf
(" (Up)\n"); ;

225 
KEY_PAGEUP
 : 
	`´štf
(" (Page Up)\n"); ;

226 
KEY_LEFT
 : 
	`´štf
(" (Left)\n"); ;

227 
KEY_RIGHT
 : 
	`´štf
(" (Right)\n"); ;

228 
KEY_END
 : 
	`´štf
(" (End)\n"); ;

229 
KEY_DOWN
 : 
	`´štf
(" (Down)\n"); ;

230 
KEY_PAGEDOWN
 : 
	`´štf
(" (Page Down)\n"); ;

231 
KEY_INSERT
 : 
	`´štf
(" (Insert)\n"); ;

232 
KEY_DELETE
 : 
	`´štf
(" (Delete)\n"); ;

233 
KEY_MACRO
 : 
	`´štf
(" (Macro)\n"); ;

234 
KEY_MUTE
 : 
	`´štf
(" (Mute)\n"); ;

235 
KEY_VOLUMEDOWN
 : 
	`´štf
(" (Volume Down)\n"); ;

236 
KEY_VOLUMEUP
 : 
	`´štf
(" (Volume Up)\n"); ;

237 
KEY_POWER
 : 
	`´štf
(" (Power)\n"); ;

238 
KEY_KPEQUAL
 : 
	`´štf
(" (KeyPad Equal)\n"); ;

239 
KEY_KPPLUSMINUS
 : 
	`´štf
(" (KeyPad +/-)\n"); ;

240 
KEY_PAUSE
 : 
	`´štf
(" (Pause)\n"); ;

241 
KEY_F21
 : 
	`´štf
(" (F21)\n"); ;

242 
KEY_F22
 : 
	`´štf
(" (F22)\n"); ;

243 
KEY_F23
 : 
	`´štf
(" (F23)\n"); ;

244 
KEY_F24
 : 
	`´štf
(" (F24)\n"); ;

245 
KEY_KPCOMMA
 : 
	`´štf
(" (KeyPad comma)\n"); ;

246 
KEY_LEFTMETA
 : 
	`´štf
(" (LH Meta)\n"); ;

247 
KEY_RIGHTMETA
 : 
	`´štf
(" (RH Meta)\n"); ;

248 
KEY_COMPOSE
 : 
	`´štf
(" (Compose)\n"); ;

249 
KEY_STOP
 : 
	`´štf
(" (Stop)\n"); ;

250 
KEY_AGAIN
 : 
	`´štf
(" (Again)\n"); ;

251 
KEY_PROPS
 : 
	`´štf
(" (Properties)\n"); ;

252 
KEY_UNDO
 : 
	`´štf
(" (Undo)\n"); ;

253 
KEY_FRONT
 : 
	`´štf
(" (Front)\n"); ;

254 
KEY_COPY
 : 
	`´štf
(" (Copy)\n"); ;

255 
KEY_OPEN
 : 
	`´štf
(" (Open)\n"); ;

256 
KEY_PASTE
 : 
	`´štf
(" (Paste)\n"); ;

257 
KEY_FIND
 : 
	`´štf
(" (Find)\n"); ;

258 
KEY_CUT
 : 
	`´štf
(" (Cut)\n"); ;

259 
KEY_HELP
 : 
	`´štf
(" (Help)\n"); ;

260 
KEY_MENU
 : 
	`´štf
(" (Menu)\n"); ;

261 
KEY_CALC
 : 
	`´štf
(" (Calculator)\n"); ;

262 
KEY_SETUP
 : 
	`´štf
(" (Setup)\n"); ;

263 
KEY_SLEEP
 : 
	`´štf
(" (Sleep)\n"); ;

264 
KEY_WAKEUP
 : 
	`´štf
(" (Wakeup)\n"); ;

265 
KEY_FILE
 : 
	`´štf
(" (File)\n"); ;

266 
KEY_SENDFILE
 : 
	`´štf
(" (Send File)\n"); ;

267 
KEY_DELETEFILE
 : 
	`´štf
(" (Delete File)\n"); ;

268 
KEY_XFER
 : 
	`´štf
(" (Transfer)\n"); ;

269 
KEY_PROG1
 : 
	`´štf
(" (Program 1)\n"); ;

270 
KEY_PROG2
 : 
	`´štf
(" (Program 2)\n"); ;

271 
KEY_WWW
 : 
	`´štf
(" (Web Browser)\n"); ;

272 
KEY_MSDOS
 : 
	`´štf
(" (DOS mode)\n"); ;

273 
KEY_COFFEE
 : 
	`´štf
(" (Coffee)\n"); ;

274 
KEY_DIRECTION
 : 
	`´štf
(" (Direction)\n"); ;

275 
KEY_CYCLEWINDOWS
 : 
	`´štf
(" (Window cycle)\n"); ;

276 
KEY_MAIL
 : 
	`´štf
(" (Mail)\n"); ;

277 
KEY_BOOKMARKS
 : 
	`´štf
(" (Book Marks)\n"); ;

278 
KEY_COMPUTER
 : 
	`´štf
(" (Computer)\n"); ;

279 
KEY_BACK
 : 
	`´štf
(" (Back)\n"); ;

280 
KEY_FORWARD
 : 
	`´štf
(" (Forward)\n"); ;

281 
KEY_CLOSECD
 : 
	`´štf
(" (Close CD)\n"); ;

282 
KEY_EJECTCD
 : 
	`´štf
(" (Eject CD)\n"); ;

283 
KEY_EJECTCLOSECD
 : 
	`´štf
(" (Eject / Close CD)\n"); ;

284 
KEY_NEXTSONG
 : 
	`´štf
(" (Next Song)\n"); ;

285 
KEY_PLAYPAUSE
 : 
	`´štf
(" (Play‡nd Pause)\n"); ;

286 
KEY_PREVIOUSSONG
 : 
	`´štf
(" (Previous Song)\n"); ;

287 
KEY_STOPCD
 : 
	`´štf
(" (Stop CD)\n"); ;

288 
KEY_RECORD
 : 
	`´štf
(" (Record)\n"); ;

289 
KEY_REWIND
 : 
	`´štf
(" (Rewind)\n"); ;

290 
KEY_PHONE
 : 
	`´štf
(" (Phone)\n"); ;

291 
KEY_ISO
 : 
	`´štf
(" (ISO)\n"); ;

292 
KEY_CONFIG
 : 
	`´štf
(" (Config)\n"); ;

293 
KEY_HOMEPAGE
 : 
	`´štf
(" (Home)\n"); ;

294 
KEY_REFRESH
 : 
	`´štf
(" (Refresh)\n"); ;

295 
KEY_EXIT
 : 
	`´štf
(" (Exit)\n"); ;

296 
KEY_MOVE
 : 
	`´štf
(" (Move)\n"); ;

297 
KEY_EDIT
 : 
	`´štf
(" (Edit)\n"); ;

298 
KEY_SCROLLUP
 : 
	`´štf
(" (Scroll Up)\n"); ;

299 
KEY_SCROLLDOWN
 : 
	`´štf
(" (Scroll Down)\n"); ;

300 
KEY_KPLEFTPAREN
 : 
	`´štf
(" (KeyPad LH…aren)\n"); ;

301 
KEY_KPRIGHTPAREN
 : 
	`´štf
(" (KeyPad RH…aren)\n"); ;

303 
KEY_INTL1
 : 
	`´štf
(" (Intl 1)\n"); ;

304 
KEY_INTL2
 : 
	`´štf
(" (Intl 2)\n"); ;

305 
KEY_INTL3
 : 
	`´štf
(" (Intl 3)\n"); ;

306 
KEY_INTL4
 : 
	`´štf
(" (Intl 4)\n"); ;

307 
KEY_INTL5
 : 
	`´štf
(" (Intl 5)\n"); ;

308 
KEY_INTL6
 : 
	`´štf
(" (Intl 6)\n"); ;

309 
KEY_INTL7
 : 
	`´štf
(" (Intl 7)\n"); ;

310 
KEY_INTL8
 : 
	`´štf
(" (Intl 8)\n"); ;

311 
KEY_INTL9
 : 
	`´štf
(" (Intl 9)\n"); ;

312 
KEY_LANG1
 : 
	`´štf
(" (Language 1)\n"); ;

313 
KEY_LANG2
 : 
	`´štf
(" (Language 2)\n"); ;

314 
KEY_LANG3
 : 
	`´štf
(" (Language 3)\n"); ;

315 
KEY_LANG4
 : 
	`´štf
(" (Language 4)\n"); ;

316 
KEY_LANG5
 : 
	`´štf
(" (Language 5)\n"); ;

317 
KEY_LANG6
 : 
	`´štf
(" (Language 6)\n"); ;

318 
KEY_LANG7
 : 
	`´štf
(" (Language 7)\n"); ;

319 
KEY_LANG8
 : 
	`´štf
(" (Language 8)\n"); ;

320 
KEY_LANG9
 : 
	`´štf
(" (Language 9)\n"); ;

322 
KEY_PLAYCD
 : 
	`´štf
(" (Play CD)\n"); ;

323 
KEY_PAUSECD
 : 
	`´štf
(" (Pause CD)\n"); ;

324 
KEY_PROG3
 : 
	`´štf
(" (Program 3)\n"); ;

325 
KEY_PROG4
 : 
	`´štf
(" (Program 4)\n"); ;

326 
KEY_SUSPEND
 : 
	`´štf
(" (Suspend)\n"); ;

327 
KEY_CLOSE
 : 
	`´štf
(" (Close)\n"); ;

328 
KEY_UNKNOWN
 : 
	`´štf
(" (Specifically unknown)\n"); ;

329 #ifdeà
KEY_BRIGHTNESSDOWN


330 
KEY_BRIGHTNESSDOWN
: 
	`´štf
(" (Brightness Down)\n");;

332 #ifdeà
KEY_BRIGHTNESSUP


333 
KEY_BRIGHTNESSUP
 : 
	`´štf
(" (Brightness Up)\n"); ;

335 
BTN_0
 : 
	`´štf
(" (Button 0)\n"); ;

336 
BTN_1
 : 
	`´štf
(" (Button 1)\n"); ;

337 
BTN_2
 : 
	`´štf
(" (Button 2)\n"); ;

338 
BTN_3
 : 
	`´štf
(" (Button 3)\n"); ;

339 
BTN_4
 : 
	`´štf
(" (Button 4)\n"); ;

340 
BTN_5
 : 
	`´štf
(" (Button 5)\n"); ;

341 
BTN_6
 : 
	`´štf
(" (Button 6)\n"); ;

342 
BTN_7
 : 
	`´štf
(" (Button 7)\n"); ;

343 
BTN_8
 : 
	`´štf
(" (Button 8)\n"); ;

344 
BTN_9
 : 
	`´štf
(" (Button 9)\n"); ;

345 
BTN_LEFT
 : 
	`´štf
(" (Left Button)\n"); ;

346 
BTN_RIGHT
 : 
	`´štf
(" (Right Button)\n"); ;

347 
BTN_MIDDLE
 : 
	`´štf
(" (Middle Button)\n"); ;

348 
BTN_SIDE
 : 
	`´štf
(" (Side Button)\n"); ;

349 
BTN_EXTRA
 : 
	`´štf
(" (Extra Button)\n"); ;

350 
BTN_FORWARD
 : 
	`´štf
(" (Forward Button)\n"); ;

351 
BTN_BACK
 : 
	`´štf
(" (Back Button)\n"); ;

352 
BTN_TRIGGER
 : 
	`´štf
(" (Trigger Button)\n"); ;

353 
BTN_THUMB
 : 
	`´štf
(" (Thumb Button)\n"); ;

354 
BTN_THUMB2
 : 
	`´štf
(" (Second Thumb Button)\n"); ;

355 
BTN_TOP
 : 
	`´štf
(" (Top Button)\n"); ;

356 
BTN_TOP2
 : 
	`´štf
(" (Second Top Button)\n"); ;

357 
BTN_PINKIE
 : 
	`´štf
(" (Pinkie Button)\n"); ;

358 
BTN_BASE
 : 
	`´štf
(" (Base Button)\n"); ;

359 
BTN_BASE2
 : 
	`´štf
(" (Second Base Button)\n"); ;

360 
BTN_BASE3
 : 
	`´štf
(" (Third Base Button)\n"); ;

361 
BTN_BASE4
 : 
	`´štf
(" (Fourth Base Button)\n"); ;

362 
BTN_BASE5
 : 
	`´štf
(" (Fifth Base Button)\n"); ;

363 
BTN_BASE6
 : 
	`´štf
(" (Sixth Base Button)\n"); ;

364 
BTN_DEAD
 : 
	`´štf
(" (Dead Button)\n"); ;

365 
BTN_A
 : 
	`´štf
(" (Button A)\n"); ;

366 
BTN_B
 : 
	`´štf
(" (Button B)\n"); ;

367 
BTN_C
 : 
	`´štf
(" (Button C)\n"); ;

368 
BTN_X
 : 
	`´štf
(" (Button X)\n"); ;

369 
BTN_Y
 : 
	`´štf
(" (Button Y)\n"); ;

370 
BTN_Z
 : 
	`´štf
(" (Button Z)\n"); ;

371 
BTN_TL
 : 
	`´štf
(" (Thumb Left Button)\n"); ;

372 
BTN_TR
 : 
	`´štf
(" (Thumb Right Button )\n"); ;

373 
BTN_TL2
 : 
	`´štf
(" (Second Thumb Left Button)\n"); ;

374 
BTN_TR2
 : 
	`´štf
(" (Second Thumb Right Button )\n");

376 
BTN_SELECT
 : 
	`´štf
(" (Select Button)\n"); ;

377 
BTN_MODE
 : 
	`´štf
(" (Mode Button)\n"); ;

378 
BTN_THUMBL
 : 
	`´štf
(" (Another Left Thumb Button )\n");

380 
BTN_THUMBR
 : 
	`´štf
(" (Another Right Thumb Button )\n");

382 
BTN_TOOL_PEN
 : 
	`´štf
(" (Digitiser Pen Tool)\n"); ;

383 
BTN_TOOL_RUBBER
 : 
	`´štf
(" (Digitiser Rubber Tool)\n");

385 
BTN_TOOL_BRUSH
 : 
	`´štf
(" (Digitiser Brush Tool)\n");

387 
BTN_TOOL_PENCIL
 : 
	`´štf
(" (Digitiser Pencil Tool)\n");

389 
BTN_TOOL_AIRBRUSH
:
	`´štf
(" (Digitiser Airbrush Tool)\n");

391 
BTN_TOOL_FINGER
 : 
	`´štf
(" (Digitiser Finger Tool)\n");

393 
BTN_TOOL_MOUSE
 : 
	`´štf
(" (Digitiser Mouse Tool)\n");

395 
BTN_TOOL_LENS
 : 
	`´štf
(" (Digitiser Lens Tool)\n"); ;

396 
BTN_TOUCH
 : 
	`´štf
(" (Digitiser Touch Button )\n"); ;

397 
BTN_STYLUS
 : 
	`´štf
(" (Digitiser Stylus Button )\n");

399 
BTN_STYLUS2
: 
	`´štf
(" (Second Digitiser Stylus Btn)\n");

401 #ifdeà
KEY_NUMERIC_0


402 
KEY_NUMERIC_0
: 
	`´štf
(" (Numeric 0)\n");

405 #ifdeà
KEY_NUMERIC_1


406 
KEY_NUMERIC_1
: 
	`´štf
(" (Numeric 1)\n");

409 #ifdeà
KEY_NUMERIC_2


410 
KEY_NUMERIC_2
: 
	`´štf
(" (Numeric 2)\n");

413 #ifdeà
KEY_NUMERIC_3


414 
KEY_NUMERIC_3
: 
	`´štf
(" (Numeric 3)\n");

417 #ifdeà
KEY_NUMERIC_4


418 
KEY_NUMERIC_4
: 
	`´štf
(" (Numeric 4)\n");

421 #ifdeà
KEY_NUMERIC_5


422 
KEY_NUMERIC_5
: 
	`´štf
(" (Numeric 5)\n");

425 #ifdeà
KEY_NUMERIC_6


426 
KEY_NUMERIC_6
: 
	`´štf
(" (Numeric 6)\n");

429 #ifdeà
KEY_NUMERIC_7


430 
KEY_NUMERIC_7
: 
	`´štf
(" (Numeric 7)\n");

433 #ifdeà
KEY_NUMERIC_8


434 
KEY_NUMERIC_8
: 
	`´štf
(" (Numeric 8)\n");

437 #ifdeà
KEY_NUMERIC_9


438 
KEY_NUMERIC_9
: 
	`´štf
(" (Numeric 9)\n");

441 #ifdeà
KEY_NUMERIC_STAR


442 
KEY_NUMERIC_STAR
: 
	`´štf
(" (Numeric *)\n");

445 #ifdeà
KEY_NUMERIC_POUND


446 
KEY_NUMERIC_POUND
: 
	`´štf
(" (Numeric #)\n");

450 
	`´štf
(" (Unknown key)\n");

453 
	}
}

461 
	$´št_Ëds
(
fd
)

463 
ušt8_t
 
Ëd_b™mask
[
LED_MAX
/8 + 1];

464 
i
;

466 
	`mem£t
(
Ëd_b™mask
, 0, (led_bitmask));

467 ià(
	`ioùl
(
fd
, 
	`EVIOCGBIT
(
EV_LED
, (
Ëd_b™mask
)),

468 
Ëd_b™mask
) < 0) {

469 
	`³¼Ü
("evdev ioctl");

472 
	`´štf
("Supported LEDs:\n");

474 
i
 = 0; i < 
LED_MAX
; i++) {

475 ià(!
	`‹¡_b™
(
i
, 
Ëd_b™mask
))

478 
	`´štf
(" LEDy³ 0x%02x ", 
i
);

480 
i
) {

482 
LED_NUML
 :

483 
	`´štf
(" (Num Lock)\n");

485 
LED_CAPSL
 :

486 
	`´štf
(" (Caps Lock)\n");

488 
LED_SCROLLL
 :

489 
	`´štf
(" (Scroll Lock)\n");

491 
LED_COMPOSE
 :

492 
	`´štf
(" (Compose)\n");

494 
LED_KANA
 :

495 
	`´štf
(" (Kana)\n");

497 
LED_SLEEP
 :

498 
	`´štf
(" (Sleep)\n");

500 
LED_SUSPEND
 :

501 
	`´štf
(" (Suspend)\n");

503 
LED_MUTE
 :

504 
	`´štf
(" (Mute)\n");

506 
LED_MISC
 :

507 
	`´štf
(" (Miscellaneous)\n");

510 
	`´štf
(" (UnknowÀLEDy³: 0x%04x)\n", 
i
);

513 
	}
}

	@baresip/modules/evdev/print.h

8 
´št_Çme
(
fd
);

9 
´št_ev’ts
(
fd
);

10 
´št_keys
(
fd
);

11 
´št_Ëds
(
fd
);

	@baresip/modules/fakevideo/fakevideo.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 
	~<±h»ad.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

31 
	svid¤c_¡
 {

32 cÚ¡ 
vid¤c
 *
	mvs
;

33 
vidäame
 *
	mäame
;

34 
±h»ad_t
 
	mth»ad
;

35 
boŞ
 
	mrun
;

36 
	mås
;

37 
vid¤c_äame_h
 *
	mäameh
;

38 *
	m¬g
;

41 
	svidi¥_¡
 {

42 cÚ¡ 
vidi¥
 *
	mvd
;

46 
vid¤c
 *
	gvid¤c
;

47 
vidi¥
 *
	gvidi¥
;

50 *
	$»ad_th»ad
(*
¬g
)

52 
vid¤c_¡
 *
¡
 = 
¬g
;

53 
ušt64_t
 
ts
 = 
	`tmr_jiff›s
();

55 
¡
->
run
) {

57 ià(
	`tmr_jiff›s
(è< 
ts
) {

58 
	`sys_m¦“p
(4);

62 
¡
->
	`äameh
(¡->
äame
, st->
¬g
);

64 
ts
 +ğ(1000/
¡
->
ås
);

67  
NULL
;

68 
	}
}

71 
	$¤c_de¡ruùÜ
(*
¬g
)

73 
vid¤c_¡
 *
¡
 = 
¬g
;

75 ià(
¡
->
run
) {

76 
¡
->
run
 = 
çl£
;

77 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

80 
	`mem_d”ef
(
¡
->
äame
);

81 
	}
}

84 
	$di¥_de¡ruùÜ
(*
¬g
)

86 
vidi¥_¡
 *
¡
 = 
¬g
;

87 ()
¡
;

88 
	}
}

91 
	$¤c_®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

92 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

93 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

94 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

95 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

97 
vid¤c_¡
 *
¡
;

98 
”r
;

100 ()
ùx
;

101 ()
fmt
;

102 ()
dev
;

103 ()
”rÜh
;

105 ià(!
¡p
 || !
´m
 || !
size
 || !
äameh
)

106  
EINVAL
;

108 
¡
 = 
	`mem_z®loc
((*¡), 
¤c_de¡ruùÜ
);

109 ià(!
¡
)

110  
ENOMEM
;

112 
¡
->
vs
 = vs;

113 
¡
->
ås
 = 
´m
->fps;

114 
¡
->
äameh
 = frameh;

115 
¡
->
¬g
 =‡rg;

117 
”r
 = 
	`vidäame_®loc
(&
¡
->
äame
, 
VID_FMT_YUV420P
, 
size
);

118 ià(
”r
)

119 
out
;

121 
¡
->
run
 = 
Œue
;

122 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

123 ià(
”r
) {

124 
¡
->
run
 = 
çl£
;

125 
out
;

128 
out
:

129 ià(
”r
)

130 
	`mem_d”ef
(
¡
);

132 *
¡p
 = 
¡
;

134  
”r
;

135 
	}
}

138 
	$di¥_®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

139 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

140 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

142 
vidi¥_¡
 *
¡
;

143 ()
´m
;

144 ()
dev
;

145 ()
»sizeh
;

146 ()
¬g
;

148 ià(!
¡p
 || !
vd
)

149  
EINVAL
;

151 
¡
 = 
	`mem_z®loc
((*¡), 
di¥_de¡ruùÜ
);

152 ià(!
¡
)

153  
ENOMEM
;

155 
¡
->
vd
 = vd;

157 *
¡p
 = 
¡
;

160 
	}
}

163 
	$di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

164 cÚ¡ 
vidäame
 *
äame
)

166 ()
¡
;

167 ()
t™Ë
;

168 ()
äame
;

171 
	}
}

174 
	$moduË_š™
()

176 
”r
 = 0;

177 
”r
 |ğ
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

178 "çkevideo", 
¤c_®loc
, 
NULL
);

179 
”r
 |ğ
	`vidi¥_»gi¡”
(&
vidi¥
, 
	`b¬es_vidi¥l
(),

180 "çkevideo", 
di¥_®loc
, 
NULL
,

181 
di¥Ïy
, 
NULL
);

182  
”r
;

183 
	}
}

186 
	$moduË_şo£
()

188 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

189 
vidi¥
 = 
	`mem_d”ef
(vidisp);

191 
	}
}

194 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
çkevideo
) = {

197 
moduË_š™
,

198 
moduË_şo£


	@baresip/modules/g711/g711.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

19 
	$pcmu_’code
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
,

20 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

22 ()
«s
;

24 ià(!
buf
 || !
Ën
 || !
§mpv
)

25  
EINVAL
;

27 ià(*
Ën
 < 
§mpc
)

28  
ENOMEM
;

30 *
Ën
 = 
§mpc
;

32 
§mpc
--)

33 *
buf
++ = 
	`g711_pcm2uÏw
(*
§mpv
++);

36 
	}
}

39 
	$pcmu_decode
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
,

40 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

42 ()
ads
;

44 ià(!
§mpv
 || !
§mpc
 || !
buf
)

45  
EINVAL
;

47 ià(*
§mpc
 < 
Ën
)

48  
ENOMEM
;

50 *
§mpc
 = 
Ën
;

52 
Ën
--)

53 *
§mpv
++ = 
	`g711_uÏw2pcm
(*
buf
++);

56 
	}
}

59 
	$pcma_’code
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
,

60 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

62 ()
«s
;

64 ià(!
buf
 || !
Ën
 || !
§mpv
)

65  
EINVAL
;

67 ià(*
Ën
 < 
§mpc
)

68  
ENOMEM
;

70 *
Ën
 = 
§mpc
;

72 
§mpc
--)

73 *
buf
++ = 
	`g711_pcm2®aw
(*
§mpv
++);

76 
	}
}

79 
	$pcma_decode
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
,

80 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

82 ()
ads
;

84 ià(!
§mpv
 || !
§mpc
 || !
buf
)

85  
EINVAL
;

87 ià(*
§mpc
 < 
Ën
)

88  
ENOMEM
;

90 *
§mpc
 = 
Ën
;

92 
Ën
--)

93 *
§mpv
++ = 
	`g711_®aw2pcm
(*
buf
++);

96 
	}
}

99 
aucodec
 
	gpcmu
 = {

100 
LE_INIT
, "0", "PCMU", 8000, 8000, 1, 
NULL
,

101 
NULL
, 
pcmu_’code
, NULL, 
pcmu_decode
, NULL, NULL, NULL

104 
aucodec
 
	gpcma
 = {

105 
LE_INIT
, "8", "PCMA", 8000, 8000, 1, 
NULL
,

106 
NULL
, 
pcma_’code
, NULL, 
pcma_decode
, NULL, NULL, NULL

110 
	$moduË_š™
()

112 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
pcmu
);

113 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
pcma
);

116 
	}
}

119 
	$moduË_şo£
()

121 
	`aucodec_uÄegi¡”
(&
pcma
);

122 
	`aucodec_uÄegi¡”
(&
pcmu
);

125 
	}
}

128 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g711
) = {

131 
moduË_š™
,

132 
moduË_şo£
,

	@baresip/modules/g722/g722.c

6 
	~<uni¡d.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<».h
>

10 
	~<b¬es.h
>

11 
	#SPANDSP_EXPOSE_INTERNAL_STRUCTURES
 1

	)

12 
	~<¥ªd¥.h
>

45 
	mG722_SAMPLE_RATE
 = 16000,

46 
	mG722_BITRATE_48k
 = 48000,

47 
	mG722_BITRATE_56k
 = 56000,

48 
	mG722_BITRATE_64k
 = 64000

52 
	sau’c_¡©e
 {

53 
g722_’code_¡©e_t
 
	m’c
;

56 
	saudec_¡©e
 {

57 
g722_decode_¡©e_t
 
	mdec
;

61 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

62 cÚ¡ 
aucodec
 *
ac
,

63 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

65 
au’c_¡©e
 *
¡
;

66 
”r
 = 0;

67 ()
´m
;

68 ()
fm
;

70 ià(!
«¥
 || !
ac
)

71  
EINVAL
;

73 ià(*
«¥
)

76 
¡
 = 
	`mem_®loc
((*¡), 
NULL
);

77 ià(!
¡
)

78  
ENOMEM
;

80 ià(!
	`g722_’code_š™
(&
¡
->
’c
, 
G722_BITRATE_64k
, 0)) {

81 
”r
 = 
EPROTO
;

82 
out
;

85 
out
:

86 ià(
”r
)

87 
	`mem_d”ef
(
¡
);

89 *
«¥
 = 
¡
;

91  
”r
;

92 
	}
}

95 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

96 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

98 
audec_¡©e
 *
¡
;

99 
”r
 = 0;

100 ()
fm
;

102 ià(!
ad¥
 || !
ac
)

103  
EINVAL
;

105 ià(*
ad¥
)

108 
¡
 = 
	`mem_®loc
((*¡), 
NULL
);

109 ià(!
¡
)

110  
ENOMEM
;

112 ià(!
	`g722_decode_š™
(&
¡
->
dec
, 
G722_BITRATE_64k
, 0)) {

113 
”r
 = 
EPROTO
;

114 
out
;

117 
out
:

118 ià(
”r
)

119 
	`mem_d”ef
(
¡
);

121 *
ad¥
 = 
¡
;

123  
”r
;

124 
	}
}

127 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

128 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

130 
n
;

132 
n
 = 
	`g722_’code
(&
¡
->
’c
, 
buf
, 
§mpv
, ()
§mpc
);

133 ià(
n
 <= 0) {

134  
EPROTO
;

136 ià(
n
 > ()*
Ën
) {

137  
EOVERFLOW
;

140 *
Ën
 = 
n
;

143 
	}
}

146 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

147 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

149 
n
;

151 ià(!
¡
 || !
§mpv
 || !
buf
)

152  
EINVAL
;

154 
n
 = 
	`g722_decode
(&
¡
->
dec
, 
§mpv
, 
buf
, ()
Ën
);

155 ià(
n
 < 0)

156  
EPROTO
;

158 *
§mpc
 = 
n
;

161 
	}
}

164 
aucodec
 
	gg722
 = {

165 
LE_INIT
, "9", "G722", 16000, 8000, 1, 
NULL
,

166 
’code_upd©e
, 
’code
,

167 
decode_upd©e
, 
decode
, 
NULL
,

168 
NULL
, NULL

172 
	$moduË_š™
()

174 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
g722
);

176 
	}
}

179 
	$moduË_şo£
()

181 
	`aucodec_uÄegi¡”
(&
g722
);

183 
	}
}

186 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g722
) = {

189 
moduË_š™
,

190 
moduË_şo£


	@baresip/modules/g7221/decode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

10 
	#G722_1_EXPOSE_INTERNAL_STRUCTURES


	)

12 
	~<g722_1.h
>

13 
	~"g7221.h
"

16 
	saudec_¡©e
 {

17 
g722_1_decode_¡©e_t
 
	mdec
;

21 
	$g7221_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

22 cÚ¡ *
fm
)

24 cÚ¡ 
g7221_aucodec
 *
g7221
 = (g7221_aucodeø*)
ac
;

25 
audec_¡©e
 *
ads
;

26 ()
fm
;

28 ià(!
ad¥
 || !
ac
)

29  
EINVAL
;

31 
ads
 = *
ad¥
;

33 ià(
ads
)

36 
ads
 = 
	`mem_®loc
((*ads), 
NULL
);

37 ià(!
ads
)

38  
ENOMEM
;

40 ià(!
	`g722_1_decode_š™
(&
ads
->
dec
, 
g7221
->
b™¿‹
, 
ac
->
¤©e
)) {

41 
	`mem_d”ef
(
ads
);

42  
EPROTO
;

45 *
ad¥
 = 
ads
;

48 
	}
}

51 
	$g7221_decode
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

52 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

54 
size_t
 
äamec
;

56 ià(!
ads
 || !
§mpv
 || !
§mpc
 || !
buf
)

57  
EINVAL
;

59 
äamec
 = 
Ën
 / 
ads
->
dec
.
by‹s_³r_äame
;

61 ià(
Ën
 !ğ
ads
->
dec
.
by‹s_³r_äame
 * 
äamec
)

62  
EPROTO
;

64 ià(*
§mpc
 < 
ads
->
dec
.
äame_size
 * 
äamec
)

65  
ENOMEM
;

67 *
§mpc
 = 
	`g722_1_decode
(&
ads
->
dec
, 
§mpv
, 
buf
, ()
Ën
);

70 
	}
}

	@baresip/modules/g7221/encode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

10 
	#G722_1_EXPOSE_INTERNAL_STRUCTURES


	)

12 
	~<g722_1.h
>

13 
	~"g7221.h
"

16 
	sau’c_¡©e
 {

17 
g722_1_’code_¡©e_t
 
	m’c
;

21 
	$g7221_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

22 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

24 cÚ¡ 
g7221_aucodec
 *
g7221
 = (g7221_aucodeø*)
ac
;

25 
au’c_¡©e
 *
«s
;

26 ()
´m
;

27 ()
fm
;

29 ià(!
«¥
 || !
ac
)

30  
EINVAL
;

32 
«s
 = *
«¥
;

34 ià(
«s
)

37 
«s
 = 
	`mem_®loc
((*«s), 
NULL
);

38 ià(!
«s
)

39  
ENOMEM
;

41 ià(!
	`g722_1_’code_š™
(&
«s
->
’c
, 
g7221
->
b™¿‹
, 
ac
->
¤©e
)) {

42 
	`mem_d”ef
(
«s
);

43  
EPROTO
;

46 *
«¥
 = 
«s
;

49 
	}
}

52 
	$g7221_’code
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

53 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

55 
size_t
 
äamec
;

57 ià(!
«s
 || !
buf
 || !
Ën
 || !
§mpv
)

58  
EINVAL
;

60 
äamec
 = 
§mpc
 / 
«s
->
’c
.
äame_size
;

62 ià(
§mpc
 !ğ
«s
->
’c
.
äame_size
 * 
äamec
)

63  
EPROTO
;

65 ià(*
Ën
 < 
«s
->
’c
.
by‹s_³r_äame
 * 
äamec
)

66  
ENOMEM
;

68 *
Ën
 = 
	`g722_1_’code
(&
«s
->
’c
, 
buf
, 
§mpv
, ()
§mpc
);

71 
	}
}

	@baresip/modules/g7221/g7221.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"g7221.h
"

12 
g7221_aucodec
 
	gg7221
 = {

13 .
ac
 = {

14 .
Çme
 = "G7221",

15 .
	g¤©e
 = 16000,

16 .
	gü©e
 = 16000,

17 .
	gch
 = 1,

18 .
	g’cupdh
 = 
g7221_’code_upd©e
,

19 .
	g’ch
 = 
g7221_’code
,

20 .
	gdecupdh
 = 
g7221_decode_upd©e
,

21 .
	gdech
 = 
g7221_decode
,

22 .
	gfm_’ch
 = 
g7221_fm_’c
,

23 .
	gfm_cmph
 = 
g7221_fm_cmp
,

25 .
	gb™¿‹
 = 32000,

29 
	$moduË_š™
()

31 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), (
aucodec
 *)&
g7221
);

34 
	}
}

37 
	$moduË_şo£
()

39 
	`aucodec_uÄegi¡”
((
aucodec
 *)&
g7221
);

42 
	}
}

45 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g7221
) = {

48 
moduË_š™
,

49 
moduË_şo£
,

	@baresip/modules/g7221/g7221.h

7 
	sg7221_aucodec
 {

8 
aucodec
 
	mac
;

9 
ušt32_t
 
	mb™¿‹
;

13 
g7221_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

14 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
);

15 
g7221_’code
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

16 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
);

20 
g7221_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

21 cÚ¡ *
fm
);

22 
g7221_decode
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

23 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
);

27 
g7221_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

28 
boŞ
 
ofãr
, *
¬g
);

29 
boŞ
 
g7221_fm_cmp
(cÚ¡ *
lfm
, cÚ¡ *
rfm
, *
¬g
);

	@baresip/modules/g7221/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"g7221.h
"

12 
ušt32_t
 
	$g7221_b™¿‹
(cÚ¡ *
fm
)

14 
¶
…l, 
b™¿‹
;

16 ià(!
fm
)

19 
	`¶_£t_¡r
(&
¶
, 
fm
);

21 ià(
	`fmt_·¿m_g‘
(&
¶
, "b™¿‹", &
b™¿‹
))

22  
	`¶_u32
(&
b™¿‹
);

25 
	}
}

28 
	$g7221_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

29 
boŞ
 
ofãr
, *
¬g
)

31 cÚ¡ 
g7221_aucodec
 *
g7221
 = 
¬g
;

32 ()
ofãr
;

34 ià(!
mb
 || !
fmt
 || !
g7221
)

37  
	`mbuf_´štf
(
mb
, "a=fmtp:%s bitrate=%u\r\n",

38 
fmt
->
id
, 
g7221
->
b™¿‹
);

39 
	}
}

42 
boŞ
 
	$g7221_fm_cmp
(cÚ¡ *
lfm
, cÚ¡ *
rfm
, *
¬g
)

44 cÚ¡ 
g7221_aucodec
 *
g7221
 = 
¬g
;

45 ()
lfm
;

47 ià(!
g7221
)

48  
çl£
;

50 ià(
g7221
->
b™¿‹
 !ğ
	`g7221_b™¿‹
(
rfm
))

51  
çl£
;

53  
Œue
;

54 
	}
}

	@baresip/modules/g726/g726.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	#SPANDSP_EXPOSE_INTERNAL_STRUCTURES
 1

	)

10 
	~<¥ªd¥.h
>

20 ’um { 
	mMAX_PACKET
 = 100 };

23 
	sg726_aucodec
 {

24 
aucodec
 
	mac
;

25 
	mb™¿‹
;

28 
	sau’c_¡©e
 {

29 
g726_¡©e_t
 
	m¡
;

32 
	saudec_¡©e
 {

33 
g726_¡©e_t
 
	m¡
;

37 
	$’code_de¡ruùÜ
(*
¬g
)

39 
au’c_¡©e
 *
¡
 = 
¬g
;

41 
	`g726_»Ëa£
(&
¡
->st);

42 
	}
}

45 
	$decode_de¡ruùÜ
(*
¬g
)

47 
audec_¡©e
 *
¡
 = 
¬g
;

49 
	`g726_»Ëa£
(&
¡
->st);

50 
	}
}

53 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

54 cÚ¡ 
aucodec
 *
ac
,

55 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

57 
g726_aucodec
 *
gac
 = (g726_aucodeø*)
ac
;

58 
au’c_¡©e
 *
¡
;

59 
”r
 = 0;

60 ()
´m
;

61 ()
fm
;

63 ià(!
«¥
 || !
ac
)

64  
EINVAL
;

65 ià(*
«¥
)

68 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

69 ià(!
¡
)

70  
ENOMEM
;

72 ià(!
	`g726_š™
(&
¡
->¡, 
gac
->
b™¿‹
, 
G726_ENCODING_LINEAR
,

73 
G726_PACKING_LEFT
)) {

74 
”r
 = 
ENOMEM
;

75 
out
;

78 
out
:

79 ià(
”r
)

80 
	`mem_d”ef
(
¡
);

82 *
«¥
 = 
¡
;

84  
”r
;

85 
	}
}

88 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

89 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

91 
g726_aucodec
 *
gac
 = (g726_aucodeø*)
ac
;

92 
audec_¡©e
 *
¡
;

93 
”r
 = 0;

94 ()
fm
;

96 ià(!
ad¥
 || !
ac
)

97  
EINVAL
;

98 ià(*
ad¥
)

101 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

102 ià(!
¡
)

103  
ENOMEM
;

105 ià(!
	`g726_š™
(&
¡
->¡, 
gac
->
b™¿‹
, 
G726_ENCODING_LINEAR
,

106 
G726_PACKING_LEFT
)) {

107 
”r
 = 
ENOMEM
;

108 
out
;

111 
out
:

112 ià(
”r
)

113 
	`mem_d”ef
(
¡
);

115 *
ad¥
 = 
¡
;

117  
”r
;

118 
	}
}

121 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
,

122 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

124 ià(!
buf
 || !
Ën
 || !
§mpv
)

125  
EINVAL
;

127 ià(*
Ën
 < 
MAX_PACKET
)

128  
ENOMEM
;

130 *
Ën
 = 
	`g726_’code
(&
¡
->¡, 
buf
, 
§mpv
, ()
§mpc
);

133 
	}
}

136 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

137 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

139 ià(!
§mpv
 || !
§mpc
 || !
buf
)

140  
EINVAL
;

142 *
§mpc
 = 
	`g726_decode
(&
¡
->¡, 
§mpv
, 
buf
, ()
Ën
);

145 
	}
}

148 
g726_aucodec
 
	gg726
[4] = {

151 
LE_INIT
, 0, "G726-40", 8000, 8000, 1, 
NULL
,

152 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 0, 0, 0

158 
LE_INIT
, 0, "G726-32", 8000, 8000, 1, 
NULL
,

159 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 0, 0, 0

165 
LE_INIT
, 0, "G726-24", 8000, 8000, 1, 
NULL
,

166 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 0, 0, 0

172 
LE_INIT
, 0, "G726-16", 8000, 8000, 1, 
NULL
,

173 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 0, 0, 0

180 
	$moduË_š™
()

182 
li¡
 *
aucodeş
 = 
	`b¬es_aucodeş
();

183 
size_t
 
i
;

185 
i
=0; i<
	`ARRAY_SIZE
(
g726
); i++)

186 
	`aucodec_»gi¡”
(
aucodeş
, (
aucodec
 *)&
g726
[
i
]);

189 
	}
}

192 
	$moduË_şo£
()

194 
size_t
 
i
;

196 
i
=0; i<
	`ARRAY_SIZE
(
g726
); i++)

197 
	`aucodec_uÄegi¡”
((
aucodec
 *)&
g726
[
i
]);

200 
	}
}

203 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g726
) = {

206 
moduË_š™
,

207 
moduË_şo£
,

	@baresip/modules/gsm/gsm.c

6 
	~<gsm.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

19 
	mFRAME_SIZE
 = 160

23 
	sau’c_¡©e
 {

24 
gsm
 
	m’c
;

27 
	saudec_¡©e
 {

28 
gsm
 
	mdec
;

32 
	$’code_de¡ruùÜ
(*
¬g
)

34 
au’c_¡©e
 *
¡
 = 
¬g
;

36 
	`gsm_de¡roy
(
¡
->
’c
);

37 
	}
}

40 
	$decode_de¡ruùÜ
(*
¬g
)

42 
audec_¡©e
 *
¡
 = 
¬g
;

44 
	`gsm_de¡roy
(
¡
->
dec
);

45 
	}
}

48 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

49 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

51 
au’c_¡©e
 *
¡
;

52 
”r
 = 0;

53 ()
ac
;

54 ()
´m
;

55 ()
fm
;

57 ià(!
«¥
)

58  
EINVAL
;

59 ià(*
«¥
)

62 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

63 ià(!
¡
)

64  
ENOMEM
;

66 
¡
->
’c
 = 
	`gsm_ü—‹
();

67 ià(!
¡
->
’c
) {

68 
”r
 = 
EPROTO
;

69 
out
;

72 
out
:

73 ià(
”r
)

74 
	`mem_d”ef
(
¡
);

76 *
«¥
 = 
¡
;

78  
”r
;

79 
	}
}

82 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

83 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

85 
audec_¡©e
 *
¡
;

86 
”r
 = 0;

87 ()
ac
;

88 ()
fm
;

90 ià(!
ad¥
)

91  
EINVAL
;

92 ià(*
ad¥
)

95 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

96 ià(!
¡
)

97  
ENOMEM
;

99 
¡
->
dec
 = 
	`gsm_ü—‹
();

100 ià(!
¡
->
dec
) {

101 
”r
 = 
EPROTO
;

102 
out
;

105 
out
:

106 ià(
”r
)

107 
	`mem_d”ef
(
¡
);

109 *
ad¥
 = 
¡
;

111  
”r
;

112 
	}
}

115 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

116 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

118 ià(
§mpc
 !ğ
FRAME_SIZE
)

119  
EPROTO
;

120 ià(*
Ën
 < (
gsm_äame
))

121  
ENOMEM
;

123 
	`gsm_’code
(
¡
->
’c
, (
gsm_sigÇl
 *)
§mpv
, 
buf
);

125 *
Ën
 = (
gsm_äame
);

128 
	}
}

131 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

132 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

134 
»t
;

136 ià(*
§mpc
 < 
FRAME_SIZE
)

137  
ENOMEM
;

138 ià(
Ën
 < (
gsm_äame
))

139  
EBADMSG
;

141 
»t
 = 
	`gsm_decode
(
¡
->
dec
, (
gsm_by‹
 *)
buf
, (
gsm_sigÇl
 *)
§mpv
);

142 ià(
»t
)

143  
EPROTO
;

145 *
§mpc
 = 160;

148 
	}
}

151 
aucodec
 
	gac_gsm
 = {

152 
LE_INIT
, "3", "GSM", 8000, 8000, 1, 
NULL
,

153 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
NULL
, NULL, NULL

157 
	$moduË_š™
()

159 
	`debug
("gsm: GSM v%u.%u.%u\n", 
GSM_MAJOR
, 
GSM_MINOR
, 
GSM_PATCHLEVEL
);

161 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
ac_gsm
);

163 
	}
}

166 
	$moduË_şo£
()

168 
	`aucodec_uÄegi¡”
(&
ac_gsm
);

170 
	}
}

173 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
gsm
) = {

176 
moduË_š™
,

177 
moduË_şo£


	@baresip/modules/gst/dump.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<g¡/g¡.h
>

9 
	~"g¡.h
"

12 
	$g¡_dump_´İs
(
G¡EËm’t
 *
g
)

14 
ušt64_t
 
u64
;

15 
gch¬
 *
¡rv®
;

16 
vŞume
;

17 
n
;

19 
	`debug
("Gst…roperties:\n");

21 
	`g_objeù_g‘
(
g
, "d–ay", &
u64
, 
NULL
);

22 
	`debug
(" d–ay: %lu‚s\n", 
u64
);

24 
	`g_objeù_g‘
(
g
, "uri", &
¡rv®
, 
NULL
);

25 
	`debug
(" uri: %s\n", 
¡rv®
);

26 
	`g_ä“
(
¡rv®
);

28 
	`g_objeù_g‘
(
g
, "suburi", &
¡rv®
, 
NULL
);

29 
	`debug
(" suburi: %s\n", 
¡rv®
);

30 
	`g_ä“
(
¡rv®
);

32 
	`g_objeù_g‘
(
g
, "queue-size", &
u64
, 
NULL
);

33 
	`debug
(" queue-size: %lu‚s\n", 
u64
);

35 
	`g_objeù_g‘
(
g
, "queue-th»shŞd", &
u64
, 
NULL
);

36 
	`debug
(" queue-th»shŞd: %lu‚s\n", 
u64
);

38 
	`g_objeù_g‘
(
g
, "n¡»ams", &
n
, 
NULL
);

39 
	`debug
("‚¡»ams: %d\n", 
n
);

41 
	`g_objeù_g‘
(
g
, "vŞume", &
vŞume
, 
NULL
);

42 
	`debug
(" VŞume: %f\n", 
vŞume
);

43 
	}
}

46 
	$g¡_dump_ÿps
(cÚ¡ 
G¡C­s
 *
ÿps
)

48 
G¡SŒuùu»
 *
s
;

49 
¿‹
, 
chªÃls
, 
width
;

51 ià(!
ÿps
)

54 ià(!
	`g¡_ÿps_g‘_size
(
ÿps
))

57 
s
 = 
	`g¡_ÿps_g‘_¡ruùu»
(
ÿps
, 0);

59 
	`g¡_¡ruùu»_g‘_št
(
s
, "¿‹", &
¿‹
);

60 
	`g¡_¡ruùu»_g‘_št
(
s
, "chªÃls", &
chªÃls
);

61 
	`g¡_¡ruùu»_g‘_št
(
s
, "width", &
width
);

63 
	`šfo
("gst: caps dump: %d Hz, %d channels, width=%d\n",

64 
¿‹
, 
chªÃls
, 
width
);

65 
	}
}

	@baresip/modules/gst/gst.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	#__USE_POSIX199309


	)

9 
	~<time.h
>

10 
	~<±h»ad.h
>

11 
	~<g¡/g¡.h
>

12 
	~<».h
>

13 
	~<»m.h
>

14 
	~<b¬es.h
>

15 
	~"g¡.h
"

46 
	sau¤c_¡
 {

47 cÚ¡ 
au¤c
 *
	mas
;

49 
±h»ad_t
 
	mtid
;

50 
boŞ
 
	mrun
;

51 
au¤c_»ad_h
 *
	mrh
;

52 
au¤c_”rÜ_h
 *
	m”rh
;

53 *
	m¬g
;

54 
au¤c_´m
 
	m´m
;

55 
aubuf
 *
	maubuf
;

56 
size_t
 
	mpsize
;

57 
size_t
 
	m§mpc
;

60 *
	muri
;

61 
G¡EËm’t
 *
	mp–še
, *
	mbš
, *
	msourû
, *
	mÿpsft
, *
	msšk
;

62 
GMašLoİ
 *
	mloİ
;

66 
_G¡FakeSšk
 
	tG¡FakeSšk
;

67 
	gg¡_uri
[256] = "http://relay1.slayradio.org:8000/";

68 
au¤c
 *
	gau¤c
;

71 *
	$th»ad
(*
¬g
)

73 
au¤c_¡
 *
¡
 = 
¬g
;

76 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

78 
¡
->
run
) {

79 
	`g_maš_loİ_run
(
¡
->
loİ
);

82  
NULL
;

83 
	}
}

86 
gboŞ—n
 
	$bus_w©ch_hªdËr
(
G¡Bus
 *
bus
, 
G¡Mes§ge
 *
msg
, 
gpoš‹r
 
d©a
)

88 
au¤c_¡
 *
¡
 = 
d©a
;

89 
GMašLoİ
 *
loİ
 = 
¡
->loop;

90 
G¡TagLi¡
 *
g_li¡
;

91 
gch¬
 *
t™Ë
;

92 
GE¼Ü
 *
”r
;

93 
gch¬
 *
d
;

95 ()
bus
;

97 
	`GST_MESSAGE_TYPE
(
msg
)) {

99 
GST_MESSAGE_EOS
:

103 ià(
¡
->
run
) {

104 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

105 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

108 
	`g_maš_loİ_qu™
(
loİ
);

112 
GST_MESSAGE_ERROR
:

113 
	`g¡_mes§ge_·r£_”rÜ
(
msg
, &
”r
, &
d
);

115 
	`w¬nšg
("g¡: E¼Ü: %d(%mèmes§ge=%s\n", 
”r
->
code
,

116 
”r
->
code
,ƒ¼->
mes§ge
);

117 
	`w¬nšg
("g¡: Debug: %s\n", 
d
);

119 
	`g_ä“
(
d
);

122 ià(
¡
->
”rh
)

123 
¡
->
	`”rh
(
”r
->
code
,ƒ¼->
mes§ge
, st->
¬g
);

125 
	`g_”rÜ_ä“
(
”r
);

127 
¡
->
run
 = 
çl£
;

128 
	`g_maš_loİ_qu™
(
loİ
);

131 
GST_MESSAGE_TAG
:

132 
	`g¡_mes§ge_·r£_g
(
msg
, &
g_li¡
);

134 ià(
	`g¡_g_li¡_g‘_¡ršg
(
g_li¡
, 
GST_TAG_TITLE
, &
t™Ë
)) {

135 
	`šfo
("g¡:™Ë: %s\n", 
t™Ë
);

136 
	`g_ä“
(
t™Ë
);

144  
TRUE
;

145 
	}
}

148 
	$fÜm©_check
(
au¤c_¡
 *
¡
, 
G¡SŒuùu»
 *
s
)

150 
¿‹
, 
chªÃls
, 
width
;

151 
gboŞ—n
 
sign
;

153 ià(!
¡
 || !
s
)

156 
	`g¡_¡ruùu»_g‘_št
(
s
, "¿‹", &
¿‹
);

157 
	`g¡_¡ruùu»_g‘_št
(
s
, "chªÃls", &
chªÃls
);

158 
	`g¡_¡ruùu»_g‘_št
(
s
, "width", &
width
);

159 
	`g¡_¡ruùu»_g‘_boŞ—n
(
s
, "sigÃd", &
sign
);

161 ià(()
¡
->
´m
.
¤©e
 !ğ
¿‹
) {

162 
	`w¬nšg
("g¡:ƒx³ùed %u Hz (gÙ %u Hz)\n", 
¡
->
´m
.
¤©e
,

163 
¿‹
);

165 ià(
¡
->
´m
.
ch
 !ğ
chªÃls
) {

166 
	`w¬nšg
("gst:ƒxpected %d channels (got %d)\n",

167 
¡
->
´m
.
ch
, 
chªÃls
);

169 ià(16 !ğ
width
) {

170 
	`w¬nšg
("g¡:ƒx³ùed 16-b™ width (gÙ %d)\n", 
width
);

172 ià(!
sign
) {

173 
	`w¬nšg
("gst:ƒxpected signed 16-bit format\n");

175 
	}
}

178 
	$¶ay_·ck‘
(
au¤c_¡
 *
¡
)

180 
št16_t
 
buf
[
¡
->
§mpc
];

183 ià(
	`aubuf_g‘_§mp
(
¡
->
aubuf
, st->
´m
.
±ime
, 
buf
, st->
§mpc
))

187 ià(
¡
->
rh
)

188 
¡
->
	`rh
(
buf
, st->
§mpc
, st->
¬g
);

189 
	}
}

193 
	$·ck‘_hªdËr
(
au¤c_¡
 *
¡
, 
G¡Bufãr
 *
bufãr
)

195 
”r
;

197 ià(!
¡
->
run
)

204 
”r
 = 
	`aubuf_wr™e
(
¡
->
aubuf
, 
	`GST_BUFFER_DATA
(
bufãr
),

205 
	`GST_BUFFER_SIZE
(
bufãr
));

206 ià(
”r
) {

207 
	`w¬nšg
("g¡:‡ubuf_wr™e: %m\n", 
”r
);

211 
¡
->
run
) {

212 cÚ¡ 
time¥ec
 
d–ay
 = {0, 
¡
->
´m
.
±ime
*1000000/2};

214 
	`¶ay_·ck‘
(
¡
);

216 ià(
	`aubuf_cur_size
(
¡
->
aubuf
è< st->
psize
)

219 ()
	`Çno¦“p
(&
d–ay
, 
NULL
);

221 
	}
}

224 
	$hªdoff_hªdËr
(
G¡FakeSšk
 *
çkesšk
, 
G¡Bufãr
 *
bufãr
,

225 
G¡Pad
 *
·d
, 
gpoš‹r
 
u£r_d©a
)

227 
au¤c_¡
 *
¡
 = 
u£r_d©a
;

229 ()
çkesšk
;

230 ()
·d
;

232 
	`fÜm©_check
(
¡
, 
	`g¡_ÿps_g‘_¡ruùu»
(
	`GST_BUFFER_CAPS
(
bufãr
), 0));

234 
	`·ck‘_hªdËr
(
¡
, 
bufãr
);

235 
	}
}

238 
	$£t_ÿps
(
au¤c_¡
 *
¡
)

240 
G¡C­s
 *
ÿps
;

243 
ÿps
 = 
	`g¡_ÿps_Ãw_sim¶e
("audio/x-raw-int",

244 "¿‹", 
G_TYPE_INT
, 
¡
->
´m
.
¤©e
,

245 "chªÃls", 
G_TYPE_INT
, 
¡
->
´m
.
ch
,

246 "width", 
G_TYPE_INT
, 16,

247 "sigÃd", 
G_TYPE_BOOLEAN
,
Œue
,

248 
NULL
);

250 
	`g¡_dump_ÿps
(
ÿps
);

252 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
ÿpsft
), "ÿps", 
ÿps
, 
NULL
);

253 
	}
}

277 
	$g¡_£tup
(
au¤c_¡
 *
¡
)

279 
G¡Bus
 *
bus
;

280 
G¡Pad
 *
·d
;

282 
¡
->
loİ
 = 
	`g_maš_loİ_Ãw
(
NULL
, 
FALSE
);

284 
¡
->
p–še
 = 
	`g¡_p–še_Ãw
("pipeline");

285 ià(!
¡
->
p–še
) {

286 
	`w¬nšg
("gst: failedo create…ipelineƒlement\n");

287  
ENOMEM
;

292 
¡
->
sourû
 = 
	`g¡_–em’t_çùÜy_make
("playbin", "source");

293 ià(!
¡
->
sourû
) {

294 
	`w¬nšg
("gst: failedo create…laybin sourceƒlement\n");

295  
ENOMEM
;

300 
¡
->
bš
 = 
	`g¡_bš_Ãw
("mybin");

302 
¡
->
ÿpsft
 = 
	`g¡_–em’t_çùÜy_make
("ÿpsf‹r", 
NULL
);

303 ià(!
¡
->
ÿpsft
) {

304 
	`w¬nšg
("gst: failedo create capsfilterƒlement\n");

305  
ENOMEM
;

308 
	`£t_ÿps
(
¡
);

310 
¡
->
sšk
 = 
	`g¡_–em’t_çùÜy_make
("fakesink", "sink");

311 ià(!
¡
->
sšk
) {

312 
	`w¬nšg
("gst: failedo create sinkƒlement\n");

313  
ENOMEM
;

316 
	`g¡_bš_add_mªy
(
	`GST_BIN
(
¡
->
bš
), st->
ÿpsft
, st->
sšk
, 
NULL
);

317 
	`g¡_–em’t_lšk_mªy
(
¡
->
ÿpsft
, st->
sšk
, 
NULL
);

320 
·d
 = 
	`g¡_–em’t_g‘_·d
(
¡
->
ÿpsft
, "sink");

321 
	`g¡_–em’t_add_·d
(
¡
->
bš
, 
	`g¡_gho¡_·d_Ãw
("sšk", 
·d
));

322 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
·d
));

325 
	`g¡_bš_add_mªy
(
	`GST_BIN
(
¡
->
p–še
), st->
sourû
, 
NULL
);

328 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sšk
), "sigÇl-hªdoffs", 
TRUE
, 
NULL
);

329 
	`g_sigÇl_cÚÃù
(
¡
->
sšk
, "hªdoff", 
	`G_CALLBACK
(
hªdoff_hªdËr
), st);

330 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sourû
), "audio-sšk", st->
bš
, 
NULL
);

335 
bus
 = 
	`g¡_p–še_g‘_bus
(
	`GST_PIPELINE
(
¡
->
p–še
));

336 
	`g¡_bus_add_w©ch
(
bus
, 
bus_w©ch_hªdËr
, 
¡
);

337 
	`g¡_objeù_uÄef
(
bus
);

340 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sourû
), "uri", st->
uri
, 
NULL
);

343 
	}
}

346 
	$g¡_de¡ruùÜ
(*
¬g
)

348 
au¤c_¡
 *
¡
 = 
¬g
;

350 ià(
¡
->
run
) {

351 
¡
->
run
 = 
çl£
;

352 
	`g_maš_loİ_qu™
(
¡
->
loİ
);

353 
	`±h»ad_još
(
¡
->
tid
, 
NULL
);

356 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

357 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
p–še
));

359 
	`mem_d”ef
(
¡
->
uri
);

360 
	`mem_d”ef
(
¡
->
aubuf
);

361 
	}
}

364 
	$g¡_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

365 
medŸ_ùx
 **
ùx
,

366 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

367 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

369 
au¤c_¡
 *
¡
;

370 
”r
;

372 ()
ùx
;

374 ià(!
deviû
)

375 
deviû
 = 
g¡_uri
;

377 ià(!
´m
)

378  
EINVAL
;

379 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
)

380  
ENOTSUP
;

382 
¡
 = 
	`mem_z®loc
((*¡), 
g¡_de¡ruùÜ
);

383 ià(!
¡
)

384  
ENOMEM
;

386 
¡
->
as
 =‡s;

387 
¡
->
rh
 =„h;

388 
¡
->
”rh
 =ƒrrh;

389 
¡
->
¬g
 =‡rg;

391 
”r
 = 
	`¡r_dup
(&
¡
->
uri
, 
deviû
);

392 ià(
”r
)

393 
out
;

395 
¡
->
´m
 = *prm;

397 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

398 
¡
->
psize
 = 2 * st->
§mpc
;

400 
”r
 = 
	`aubuf_®loc
(&
¡
->
aubuf
, st->
psize
, 0);

401 ià(
”r
)

402 
out
;

404 
”r
 = 
	`g¡_£tup
(
¡
);

405 ià(
”r
)

406 
out
;

408 
¡
->
run
 = 
Œue
;

409 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
tid
, 
NULL
, 
th»ad
, st);

410 ià(
”r
) {

411 
¡
->
run
 = 
çl£
;

412 
out
;

415 
out
:

416 ià(
”r
)

417 
	`mem_d”ef
(
¡
);

419 *
¡p
 = 
¡
;

421  
”r
;

422 
	}
}

425 
	$mod_g¡_š™
()

427 
gch¬
 *
s
;

429 
	`g¡_š™
(0, 
NULL
);

431 
s
 = 
	`g¡_v”siÚ_¡ršg
();

433 
	`šfo
("g¡: in™: %s\n", 
s
);

435 
	`g_ä“
(
s
);

437  
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "g¡", 
g¡_®loc
);

438 
	}
}

441 
	$mod_g¡_şo£
()

443 
	`g¡_deš™
();

444 
au¤c
 = 
	`mem_d”ef
(ausrc);

446 
	}
}

449 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g¡
) = {

452 
mod_g¡_š™
,

453 
mod_g¡_şo£


	@baresip/modules/gst/gst.h

8 
g¡_dump_´İs
(
G¡EËm’t
 *
g
);

9 
g¡_dump_ÿps
(cÚ¡ 
G¡C­s
 *
ÿps
);

	@baresip/modules/gst1/gst.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<time.h
>

10 
	~<±h»ad.h
>

11 
	~<g¡/g¡.h
>

12 
	~<».h
>

13 
	~<»m.h
>

14 
	~<b¬es.h
>

45 
	sau¤c_¡
 {

46 cÚ¡ 
au¤c
 *
	mas
;

48 
±h»ad_t
 
	mtid
;

49 
boŞ
 
	mrun
;

50 
au¤c_»ad_h
 *
	mrh
;

51 
au¤c_”rÜ_h
 *
	m”rh
;

52 *
	m¬g
;

53 
au¤c_´m
 
	m´m
;

54 
aubuf
 *
	maubuf
;

55 
size_t
 
	mpsize
;

56 
size_t
 
	m§mpc
;

59 *
	muri
;

60 
G¡EËm’t
 *
	mp–še
, *
	mbš
, *
	msourû
, *
	mÿpsft
, *
	msšk
;

61 
GMašLoİ
 *
	mloİ
;

65 
_G¡FakeSšk
 
	tG¡FakeSšk
;

66 
	gg¡_uri
[256] = "http://relay1.slayradio.org:8000/";

67 
au¤c
 *
	gau¤c
;

70 *
	$th»ad
(*
¬g
)

72 
au¤c_¡
 *
¡
 = 
¬g
;

75 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

77 
¡
->
run
) {

78 
	`g_maš_loİ_run
(
¡
->
loİ
);

81  
NULL
;

82 
	}
}

85 
gboŞ—n
 
	$bus_w©ch_hªdËr
(
G¡Bus
 *
bus
, 
G¡Mes§ge
 *
msg
, 
gpoš‹r
 
d©a
)

87 
au¤c_¡
 *
¡
 = 
d©a
;

88 
GMašLoİ
 *
loİ
 = 
¡
->loop;

89 
G¡TagLi¡
 *
g_li¡
;

90 
gch¬
 *
t™Ë
;

91 
GE¼Ü
 *
”r
;

92 
gch¬
 *
d
;

94 ()
bus
;

96 
	`GST_MESSAGE_TYPE
(
msg
)) {

98 
GST_MESSAGE_EOS
:

102 ià(
¡
->
run
) {

103 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

104 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

107 
	`g_maš_loİ_qu™
(
loİ
);

111 
GST_MESSAGE_ERROR
:

112 
	`g¡_mes§ge_·r£_”rÜ
(
msg
, &
”r
, &
d
);

114 
	`w¬nšg
("g¡: E¼Ü: %d(%mèmes§ge=\"%s\"\n", 
”r
->
code
,

115 
”r
->
code
,ƒ¼->
mes§ge
);

116 
	`w¬nšg
("g¡: Debug: %s\n", 
d
);

118 
	`g_ä“
(
d
);

121 ià(
¡
->
”rh
)

122 
¡
->
	`”rh
(
”r
->
code
,ƒ¼->
mes§ge
, st->
¬g
);

124 
	`g_”rÜ_ä“
(
”r
);

126 
¡
->
run
 = 
çl£
;

127 
	`g_maš_loİ_qu™
(
loİ
);

130 
GST_MESSAGE_TAG
:

131 
	`g¡_mes§ge_·r£_g
(
msg
, &
g_li¡
);

133 ià(
	`g¡_g_li¡_g‘_¡ršg
(
g_li¡
, 
GST_TAG_TITLE
, &
t™Ë
)) {

134 
	`šfo
("g¡:™Ë: %s\n", 
t™Ë
);

135 
	`g_ä“
(
t™Ë
);

143  
TRUE
;

144 
	}
}

147 
	$fÜm©_check
(
au¤c_¡
 *
¡
, 
G¡SŒuùu»
 *
s
)

149 
¿‹
, 
chªÃls
, 
width
;

150 
gboŞ—n
 
sign
;

152 ià(!
¡
 || !
s
)

155 
	`g¡_¡ruùu»_g‘_št
(
s
, "¿‹", &
¿‹
);

156 
	`g¡_¡ruùu»_g‘_št
(
s
, "chªÃls", &
chªÃls
);

157 
	`g¡_¡ruùu»_g‘_št
(
s
, "width", &
width
);

158 
	`g¡_¡ruùu»_g‘_boŞ—n
(
s
, "sigÃd", &
sign
);

160 ià(()
¡
->
´m
.
¤©e
 !ğ
¿‹
) {

161 
	`w¬nšg
("g¡:ƒx³ùed %u Hz (gÙ %u Hz)\n", 
¡
->
´m
.
¤©e
,

162 
¿‹
);

164 ià(
¡
->
´m
.
ch
 !ğ
chªÃls
) {

165 
	`w¬nšg
("gst:ƒxpected %d channels (got %d)\n",

166 
¡
->
´m
.
ch
, 
chªÃls
);

168 ià(16 !ğ
width
) {

169 
	`w¬nšg
("g¡:ƒx³ùed 16-b™ width (gÙ %d)\n", 
width
);

171 ià(!
sign
) {

172 
	`w¬nšg
("gst:ƒxpected signed 16-bit format\n");

174 
	}
}

177 
	$¶ay_·ck‘
(
au¤c_¡
 *
¡
)

179 
št16_t
 
buf
[
¡
->
§mpc
];

182 ià(
	`aubuf_g‘_§mp
(
¡
->
aubuf
, st->
´m
.
±ime
, 
buf
, st->
§mpc
))

186 ià(
¡
->
rh
)

187 
¡
->
	`rh
(
buf
, st->
§mpc
, st->
¬g
);

188 
	}
}

192 
	$·ck‘_hªdËr
(
au¤c_¡
 *
¡
, 
G¡Bufãr
 *
bufãr
)

194 
G¡M­Info
 
šfo
;

195 
”r
;

197 ià(!
¡
->
run
)

204 ià(!
	`g¡_bufãr_m­
(
bufãr
, &
šfo
, 
GST_MAP_READ
)) {

205 
	`w¬nšg
("gst: gst_buffer_map failed\n");

209 
”r
 = 
	`aubuf_wr™e
(
¡
->
aubuf
, 
šfo
.
d©a
, info.
size
);

210 ià(
”r
) {

211 
	`w¬nšg
("g¡:‡ubuf_wr™e: %m\n", 
”r
);

214 
	`g¡_bufãr_unm­
(
bufãr
, &
šfo
);

217 
¡
->
run
) {

218 cÚ¡ 
time¥ec
 
d–ay
 = {0, 
¡
->
´m
.
±ime
*1000000/2};

220 
	`¶ay_·ck‘
(
¡
);

222 ià(
	`aubuf_cur_size
(
¡
->
aubuf
è< st->
psize
)

225 ()
	`Çno¦“p
(&
d–ay
, 
NULL
);

227 
	}
}

230 
	$hªdoff_hªdËr
(
G¡FakeSšk
 *
çkesšk
, 
G¡Bufãr
 *
bufãr
,

231 
G¡Pad
 *
·d
, 
gpoš‹r
 
u£r_d©a
)

233 
au¤c_¡
 *
¡
 = 
u£r_d©a
;

234 
G¡C­s
 *
ÿps
;

235 ()
çkesšk
;

237 
ÿps
 = 
	`g¡_·d_g‘_cu¼’t_ÿps
(
·d
);

239 
	`fÜm©_check
(
¡
, 
	`g¡_ÿps_g‘_¡ruùu»
(
ÿps
, 0));

241 
	`·ck‘_hªdËr
(
¡
, 
bufãr
);

242 
	}
}

245 
	$£t_ÿps
(
au¤c_¡
 *
¡
)

247 
G¡C­s
 *
ÿps
;

250 
ÿps
 = 
	`g¡_ÿps_Ãw_sim¶e
("audio/x-raw",

251 "¿‹", 
G_TYPE_INT
, 
¡
->
´m
.
¤©e
,

252 "chªÃls", 
G_TYPE_INT
, 
¡
->
´m
.
ch
,

253 "width", 
G_TYPE_INT
, 16,

254 "sigÃd", 
G_TYPE_BOOLEAN
,
Œue
,

255 
NULL
);

257 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
ÿpsft
), "ÿps", 
ÿps
, 
NULL
);

258 
	}
}

282 
	$g¡_£tup
(
au¤c_¡
 *
¡
)

284 
G¡Bus
 *
bus
;

285 
G¡Pad
 *
·d
;

287 
¡
->
loİ
 = 
	`g_maš_loİ_Ãw
(
NULL
, 
FALSE
);

289 
¡
->
p–še
 = 
	`g¡_p–še_Ãw
("pipeline");

290 ià(!
¡
->
p–še
) {

291 
	`w¬nšg
("gst: failedo create…ipelineƒlement\n");

292  
ENOMEM
;

297 
¡
->
sourû
 = 
	`g¡_–em’t_çùÜy_make
("playbin", "source");

298 ià(!
¡
->
sourû
) {

299 
	`w¬nšg
("gst: failedo create…laybin sourceƒlement\n");

300  
ENOMEM
;

305 
¡
->
bš
 = 
	`g¡_bš_Ãw
("mybin");

307 
¡
->
ÿpsft
 = 
	`g¡_–em’t_çùÜy_make
("ÿpsf‹r", 
NULL
);

308 ià(!
¡
->
ÿpsft
) {

309 
	`w¬nšg
("gst: failedo create capsfilterƒlement\n");

310  
ENOMEM
;

313 
	`£t_ÿps
(
¡
);

315 
¡
->
sšk
 = 
	`g¡_–em’t_çùÜy_make
("fakesink", "sink");

316 ià(!
¡
->
sšk
) {

317 
	`w¬nšg
("gst: failedo create sinkƒlement\n");

318  
ENOMEM
;

321 
	`g¡_bš_add_mªy
(
	`GST_BIN
(
¡
->
bš
), st->
ÿpsft
, st->
sšk
, 
NULL
);

322 
	`g¡_–em’t_lšk_mªy
(
¡
->
ÿpsft
, st->
sšk
, 
NULL
);

325 
·d
 = 
	`g¡_–em’t_g‘_¡©ic_·d
(
¡
->
ÿpsft
, "sink");

326 
	`g¡_–em’t_add_·d
(
¡
->
bš
, 
	`g¡_gho¡_·d_Ãw
("sšk", 
·d
));

327 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
·d
));

330 
	`g¡_bš_add_mªy
(
	`GST_BIN
(
¡
->
p–še
), st->
sourû
, 
NULL
);

333 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sšk
), "sigÇl-hªdoffs", 
TRUE
, 
NULL
);

334 
	`g_sigÇl_cÚÃù
(
¡
->
sšk
, "hªdoff", 
	`G_CALLBACK
(
hªdoff_hªdËr
), st);

336 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sourû
), "audio-sšk", st->
bš
, 
NULL
);

341 
bus
 = 
	`g¡_p–še_g‘_bus
(
	`GST_PIPELINE
(
¡
->
p–še
));

342 
	`g¡_bus_add_w©ch
(
bus
, 
bus_w©ch_hªdËr
, 
¡
);

343 
	`g¡_objeù_uÄef
(
bus
);

346 
	`g_objeù_£t
(
	`G_OBJECT
(
¡
->
sourû
), "uri", st->
uri
, 
NULL
);

349 
	}
}

352 
	$g¡_de¡ruùÜ
(*
¬g
)

354 
au¤c_¡
 *
¡
 = 
¬g
;

356 ià(
¡
->
run
) {

357 
¡
->
run
 = 
çl£
;

358 
	`g_maš_loİ_qu™
(
¡
->
loİ
);

359 
	`±h»ad_još
(
¡
->
tid
, 
NULL
);

362 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

363 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
p–še
));

365 
	`mem_d”ef
(
¡
->
uri
);

366 
	`mem_d”ef
(
¡
->
aubuf
);

367 
	}
}

370 
	$g¡_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

371 
medŸ_ùx
 **
ùx
,

372 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

373 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

375 
au¤c_¡
 *
¡
;

376 
”r
;

378 ()
ùx
;

380 ià(!
deviû
)

381 
deviû
 = 
g¡_uri
;

383 ià(!
´m
)

384  
EINVAL
;

386 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

387 
	`w¬nšg
("gst: unsupported sample format (%s)\n",

388 
	`aufmt_Çme
(
´m
->
fmt
));

389  
ENOTSUP
;

392 
¡
 = 
	`mem_z®loc
((*¡), 
g¡_de¡ruùÜ
);

393 ià(!
¡
)

394  
ENOMEM
;

396 
¡
->
as
 =‡s;

397 
¡
->
rh
 =„h;

398 
¡
->
”rh
 =ƒrrh;

399 
¡
->
¬g
 =‡rg;

401 
”r
 = 
	`¡r_dup
(&
¡
->
uri
, 
deviû
);

402 ià(
”r
)

403 
out
;

405 
¡
->
´m
 = *prm;

407 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

408 
¡
->
psize
 = 2 * st->
§mpc
;

410 
”r
 = 
	`aubuf_®loc
(&
¡
->
aubuf
, st->
psize
, 0);

411 ià(
”r
)

412 
out
;

414 
”r
 = 
	`g¡_£tup
(
¡
);

415 ià(
”r
)

416 
out
;

418 
¡
->
run
 = 
Œue
;

419 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
tid
, 
NULL
, 
th»ad
, st);

420 ià(
”r
) {

421 
¡
->
run
 = 
çl£
;

422 
out
;

425 
out
:

426 ià(
”r
)

427 
	`mem_d”ef
(
¡
);

429 *
¡p
 = 
¡
;

431  
”r
;

432 
	}
}

435 
	$mod_g¡_š™
()

437 
gch¬
 *
s
;

439 
	`g¡_š™
(0, 
NULL
);

441 
s
 = 
	`g¡_v”siÚ_¡ršg
();

443 
	`šfo
("g¡: in™: %s\n", 
s
);

445 
	`g_ä“
(
s
);

447  
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "g¡", 
g¡_®loc
);

448 
	}
}

451 
	$mod_g¡_şo£
()

453 
	`g¡_deš™
();

454 
au¤c
 = 
	`mem_d”ef
(ausrc);

456 
	}
}

459 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g¡1
) = {

462 
mod_g¡_š™
,

463 
mod_g¡_şo£


	@baresip/modules/gst_video/encode.c

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	#__USE_POSIX199309


	)

9 
	#_BSD_SOURCE
 1

	)

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<sys/time.h
>

13 
	~<uni¡d.h
>

14 
	~<±h»ad.h
>

15 
	~<».h
>

16 
	~<»m.h
>

17 
	~<b¬es.h
>

18 
	~<g¡/g¡.h
>

19 
	~<g¡/video/video.h
>

20 
	~<g¡/­p/g¡­p¤c.h
>

21 
	~"g¡_video.h
"

24 
	svid’c_¡©e
 {

26 
vidsz
 
	msize
;

27 
	mås
;

28 
	mb™¿‹
;

29 
	mpktsize
;

32 
ušt32_t
 
	m·ck‘iz©iÚ_mode
;

33 
ušt32_t
 
	m´ofe_idc
;

34 
ušt32_t
 
	m´ofe_iİ
;

35 
ušt32_t
 
	mËv–_idc
;

36 
ušt32_t
 
	mmax_fs
;

37 
ušt32_t
 
	mmax_smbps
;

38 } 
	mh264
;

40 
vid’c_·ck‘_h
 *
	mpkth
;

41 *
	mpkth_¬g
;

44 
G¡EËm’t
 *
	mp–še
, *
	msourû
, *
	msšk
;

45 
G¡Bus
 *
	mbus
;

46 
gulÚg
 
	mÃed_d©a_hªdËr
;

47 
gulÚg
 
	m’ough_d©a_hªdËr
;

48 
gulÚg
 
	mÃw_bufãr_hªdËr
;

49 
boŞ
 
	mg¡_š™ed
;

52 
	mrun
;

53 
±h»ad_t
 
	mtid
;

56 
±h»ad_mu‹x_t
 
	mmu‹x
;

57 
±h»ad_cÚd_t
 
	mwa™
;

58 
	mbwa™
;

62 
g¡_’cod”_şo£
(
vid’c_¡©e
 *
¡
);

65 
	$š‹º®_bus_w©ch_hªdËr
(
vid’c_¡©e
 *
¡
)

67 
GE¼Ü
 *
”r
;

68 
gch¬
 *
d
;

69 
G¡Mes§ge
 *
msg
 = 
	`g¡_bus_pİ
(
¡
->
bus
);

71 ià(!
msg
) {

73 
	`u¦“p
(300 * 1000);

77 
	`GST_MESSAGE_TYPE
(
msg
)) {

79 
GST_MESSAGE_EOS
:

84 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

85 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

88 
GST_MESSAGE_ERROR
:

89 
	`g¡_mes§ge_·r£_”rÜ
(
msg
, &
”r
, &
d
);

91 
	`w¬nšg
("g¡_video: E¼Ü: %d(%mèmes§ge=%s\n", 
”r
->
code
,

92 
”r
->
code
,ƒ¼->
mes§ge
);

93 
	`w¬nšg
("g¡_video: Debug: %s\n", 
d
);

95 
	`g_ä“
(
d
);

96 
	`g_”rÜ_ä“
(
”r
);

98 
¡
->
run
 = 
FALSE
;

105 
	`g¡_mes§ge_uÄef
(
msg
);

106 
	}
}

109 *
	$š‹º®_th»ad
(*
¬g
)

111 
vid’c_¡©e
 *
¡
 = 
¬g
;

114 
	`debug
("gst_video: Setting…ipelineo PLAYING\n");

116 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

118 
¡
->
run
) {

119 
	`š‹º®_bus_w©ch_hªdËr
(
¡
);

122 
	`debug
("gst_video: Pipelinehread was stopped.\n");

124  
NULL
;

125 
	}
}

128 
	$š‹º®_­p¤c_¡¬t_ãed
(
G¡EËm’t
 * 
p–še
, 
gušt
 
size
,

129 
vid’c_¡©e
 *
¡
)

131 ()
p–še
;

132 ()
size
;

134 ià(!
¡
)

137 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

138 
¡
->
bwa™
 = 
FALSE
;

139 
	`±h»ad_cÚd_sigÇl
(&
¡
->
wa™
);

140 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

141 
	}
}

144 
	$š‹º®_­p¤c_¡İ_ãed
(
G¡EËm’t
 * 
p–še
,

145 
vid’c_¡©e
 *
¡
)

147 ()
p–še
;

149 ià(!
¡
)

152 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

153 
¡
->
bwa™
 = 
TRUE
;

154 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

155 
	}
}

159 
	$š‹º®_­psšk_Ãw_bufãr
(
G¡EËm’t
 *
sšk
,

160 
vid’c_¡©e
 *
¡
)

162 
G¡Bufãr
 *
bufãr
;

164 ià(!
¡
)

168 
	`g_sigÇl_em™_by_Çme
(
sšk
, "puÎ-bufãr", &
bufãr
);

170 ià(
bufãr
) {

171 
G¡ClockTime
 
ts
;

172 
ušt32_t
 
¹p_ts
;

174 
gušt8
 *
d©a
 = 
	`GST_BUFFER_DATA
(
bufãr
);

175 
gušt
 
size
 = 
	`GST_BUFFER_SIZE
(
bufãr
);

177 
ts
 = 
	`GST_BUFFER_TIMESTAMP
(
bufãr
);

179 
¹p_ts
 = (
ušt32_t
)((90000ULL*
ts
) / 1000000000UL );

181 
	`h264_·ck‘ize
(
¹p_ts
, 
d©a
, 
size
, 
¡
->
pktsize
,

182 
¡
->
pkth
, st->
pkth_¬g
);

184 
	`g¡_bufãr_uÄef
(
bufãr
);

186 
	}
}

204 
	$g¡_’cod”_š™
(
vid’c_¡©e
 *
¡
, 
width
, 
height
,

205 
äam”©e
, 
b™¿‹
)

207 
GE¼Ü
* 
g”rÜ
 = 
NULL
;

208 
p–še
[1024];

209 
”r
 = 0;

211 
	`g¡_’cod”_şo£
(
¡
);

213 
	`¢´štf
(
p–še
, (pipeline),

219 
width
, 
height
, 
äam”©e
, 
b™¿‹
 / 1000 );

221 
	`debug
("gst_video: format: yu12 = yuv420p = i420\n");

224 
¡
->
p–še
 = 
	`g¡_·r£_Ïunch
Õ–še, &
g”rÜ
);

225 ià(
g”rÜ
) {

226 
	`w¬nšg
("gst_video:†aunchƒrror: %s: %s\n",

227 
g”rÜ
->
mes§ge
, 
p–še
);

228 
”r
 = 
g”rÜ
->
code
;

229 
	`g_”rÜ_ä“
(
g”rÜ
);

230 
out
;

233 
¡
->
sourû
 = 
	`g¡_bš_g‘_by_Çme
(
	`GST_BIN
(¡->
p–še
), "source");

234 
¡
->
sšk
 = 
	`g¡_bš_g‘_by_Çme
(
	`GST_BIN
(¡->
p–še
), "sink");

235 ià(!
¡
->
sourû
 || !¡->
sšk
) {

236 
	`w¬nšg
("gst_video: failedo get source or sink"

238 
”r
 = 
ENOMEM
;

239 
out
;

243 
¡
->
Ãed_d©a_hªdËr
 = 
	`g_sigÇl_cÚÃù
(¡->
sourû
, "need-data",

244 
	`G_CALLBACK
(
š‹º®_­p¤c_¡¬t_ãed
), 
¡
);

245 
¡
->
’ough_d©a_hªdËr
 = 
	`g_sigÇl_cÚÃù
(¡->
sourû
, "enough-data",

246 
	`G_CALLBACK
(
š‹º®_­p¤c_¡İ_ãed
), 
¡
);

249 
¡
->
Ãw_bufãr_hªdËr
 = 
	`g_sigÇl_cÚÃù
(¡->
sšk
, "new-buffer",

250 
	`G_CALLBACK
(
š‹º®_­psšk_Ãw_bufãr
), 
¡
);

255 
¡
->
bus
 = 
	`g¡_p–še_g‘_bus
(
	`GST_PIPELINE
(¡->
p–še
));

260 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

261 
	`±h»ad_cÚd_š™
(&
¡
->
wa™
, 
NULL
);

262 
¡
->
bwa™
 = 
FALSE
;

264 
”r
 = 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_PLAYING
);

265 ià(
GST_STATE_CHANGE_FAILURE
 =ğ
”r
) {

266 
	`g_w¬nšg
("set state„eturned GST_STATE_CHANGE_FAILUER\n");

270 
¡
->
run
 = 
Œue
;

271 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
tid
, 
NULL
, 
š‹º®_th»ad
, st);

272 ià(
”r
) {

273 
¡
->
run
 = 
çl£
;

274 
out
;

277 
¡
->
g¡_š™ed
 = 
Œue
;

279 
out
:

280  
”r
;

281 
	}
}

284 
	$g¡_video_push
(
vid’c_¡©e
 *
¡
, cÚ¡ 
ušt8_t
 *
¤c
,

285 
size_t
 
size
)

287 
G¡Bufãr
 *
bufãr
;

288 
»t
 = 0;

290 ià(!
¡
) {

291  
EINVAL
;

294 ià(!
size
) {

295 
	`w¬nšg
("gst_video:…ush:ƒos„eturned %d‡t %d\n",

296 
»t
, 
__LINE__
);

297 
	`g¡_­p_¤c_’d_of_¡»am
((
G¡AµSrc
 *)
¡
->
sourû
);

298  
»t
;

302 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

303 ià(
¡
->
bwa™
) {

304 
	#WAIT_TIME_SECONDS
 5

	)

305 
time¥ec
 
ts
;

306 
timev®
 

;

307 
	`g‘timeofday
(&

, 
NULL
);

308 
ts
.
tv_£c
 = 

.tv_sec;

309 
ts
.
tv_n£c
 = 

.
tv_u£c
 * 1000;

310 
ts
.
tv_£c
 +ğ
WAIT_TIME_SECONDS
;

312 
»t
 = 
	`±h»ad_cÚd_timedwa™
(&
¡
->
wa™
, &¡->
mu‹x
, &
ts
);

313 ià(
ETIMEDOUT
 =ğ
»t
) {

314 
	`w¬nšg
("gst_video: Raw frame is†ost"

316  
»t
;

319 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

322 
bufãr
 = 
	`g¡_bufãr_Ãw
();

323 
	`GST_BUFFER_MALLOCDATA
(
bufãr
èğ(
gušt8
 *)
¤c
;

324 
	`GST_BUFFER_SIZE
(
bufãr
èğ(
gušt
)
size
;

325 
	`GST_BUFFER_DATA
(
bufãr
èğ
	`GST_BUFFER_MALLOCDATA
(buffer);

327 
»t
 = 
	`g¡_­p_¤c_push_bufãr
((
G¡AµSrc
 *)
¡
->
sourû
, 
bufãr
);

329 ià(
»t
 !ğ
GST_FLOW_OK
) {

330 
	`w¬nšg
("gst_video:…ush buffer„eturned"

331 " %d fÜ %d by‹ \n", 
»t
, 
size
);

332  
»t
;

335  
»t
;

336 
	}
}

339 
	$g¡_’cod”_şo£
(
vid’c_¡©e
 *
¡
)

341 ià(!
¡
)

344 
¡
->
g¡_š™ed
 = 
çl£
;

348 ià(
¡
->
sourû
) {

349 
	`g_sigÇl_hªdËr_discÚÃù
(
¡
->
sourû
,

350 
¡
->
Ãed_d©a_hªdËr
);

351 
	`g_sigÇl_hªdËr_discÚÃù
(
¡
->
sourû
,

352 
¡
->
’ough_d©a_hªdËr
);

354 ià(
¡
->
sšk
) {

355 
	`g_sigÇl_hªdËr_discÚÃù
(
¡
->
sšk
, st->
Ãw_bufãr_hªdËr
);

359 ià(
¡
->
run
) {

360 
¡
->
run
 = 
çl£
;

361 
	`±h»ad_još
(
¡
->
tid
, 
NULL
);

364 ià(
¡
->
sourû
) {

365 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
sourû
));

366 
¡
->
sourû
 = 
NULL
;

368 ià(
¡
->
sšk
) {

369 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
sšk
));

370 
¡
->
sšk
 = 
NULL
;

372 ià(
¡
->
bus
) {

373 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
bus
));

374 
¡
->
bus
 = 
NULL
;

377 ià(
¡
->
p–še
) {

378 
	`g¡_–em’t_£t_¡©e
(
¡
->
p–še
, 
GST_STATE_NULL
);

379 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
p–še
));

380 
¡
->
p–še
 = 
NULL
;

382 
	}
}

385 
	$’code_de¡ruùÜ
(*
¬g
)

387 
vid’c_¡©e
 *
¡
 = 
¬g
;

389 
	`g¡_’cod”_şo£
(
¡
);

390 
	}
}

393 
	$decode_sdµ¬am_h264
(
vid’c_¡©e
 *
¡
, cÚ¡ 
¶
 *
Çme
,

394 cÚ¡ 
¶
 *
v®
)

396 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "packetization-mode")) {

397 
¡
->
h264
.
·ck‘iz©iÚ_mode
 = 
	`¶_u32
(
v®
);

399 ià(
¡
->
h264
.
·ck‘iz©iÚ_mode
 != 0) {

400 
	`w¬nšg
("gst_video: illegal…acketization-mode %u\n",

401 
¡
->
h264
.
·ck‘iz©iÚ_mode
);

402  
EPROTO
;

405 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "profile-level-id")) {

406 
¶
 
´of
 = *
v®
;

407 ià(
´of
.
l
 != 6) {

408 
	`w¬nšg
("gst_video: invalid…rofile-level-id (%r)\n",

409 
v®
);

410  
EPROTO
;

413 
´of
.
l
 = 2;

414 
¡
->
h264
.
´ofe_idc
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

415 
¡
->
h264
.
´ofe_iİ
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

416 
¡
->
h264
.
Ëv–_idc
 = 
	`¶_x32
(&
´of
);

418 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-fs")) {

419 
¡
->
h264
.
max_fs
 = 
	`¶_u32
(
v®
);

421 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-smbps")) {

422 
¡
->
h264
.
max_smbps
 = 
	`¶_u32
(
v®
);

426 
	}
}

429 
	$·¿m_hªdËr
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

430 *
¬g
)

432 
vid’c_¡©e
 *
¡
 = 
¬g
;

434 ()
	`decode_sdµ¬am_h264
(
¡
, 
Çme
, 
v®
);

435 
	}
}

438 
	$g¡_video_’code_upd©e
(
vid’c_¡©e
 **
ve¥
,

439 cÚ¡ 
vidcodec
 *
vc
,

440 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

441 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

443 
vid’c_¡©e
 *
ves
;

444 
”r
 = 0;

446 ià(!
ve¥
 || !
vc
 || !
´m
)

447  
EINVAL
;

449 
ves
 = *
ve¥
;

451 ià(!
ves
) {

453 
ves
 = 
	`mem_z®loc
((*ves), 
’code_de¡ruùÜ
);

454 ià(!
ves
)

455  
ENOMEM
;

457 *
ve¥
 = 
ves
;

460 ià(
ves
->
g¡_š™ed
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

461 
ves
->
pktsize
 !ğ
´m
->pktsize ||

462 
ves
->
ås
 !ğ
´m
->fps)) {

463 
	`g¡_’cod”_şo£
(
ves
);

467 ià(
	`¡r_is£t
(
fm
)) {

468 
¶
 
sdp_fm
;

470 
	`¶_£t_¡r
(&
sdp_fm
, 
fm
);

472 
	`fmt_·¿m_­¶y
(&
sdp_fm
, 
·¿m_hªdËr
, 
ves
);

475 
ves
->
b™¿‹
 = 
´m
->bitrate;

476 
ves
->
pktsize
 = 
´m
->pktsize;

477 
ves
->
ås
 = 
´m
->fps;

478 
ves
->
pkth
 =…kth;

479 
ves
->
pkth_¬g
 = 
¬g
;

481 
	`šfo
("gst_video: videoƒncoder %s: %d fps, %d bit/s,…ktsize=%u\n",

482 
vc
->
Çme
, 
´m
->
ås
,…rm->
b™¿‹
,…rm->
pktsize
);

484  
”r
;

485 
	}
}

488 
	$g¡_video_’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

489 cÚ¡ 
vidäame
 *
äame
)

491 
ušt8_t
 *
d©a
;

492 
size_t
 
size
;

493 
height
;

494 
”r
;

496 ià(!
¡
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

497  
EINVAL
;

499 ià(!
¡
->
g¡_š™ed
 || !
	`vidsz_cmp
(&¡->
size
, &
äame
->size)) {

501 
”r
 = 
	`g¡_’cod”_š™
(
¡
, 
äame
->
size
.
w
, f¿me->size.
h
,

502 
¡
->
ås
, st->
b™¿‹
);

504 ià(
”r
) {

505 
	`w¬nšg
("gst_video codec: gst_video_alloc failed\n");

506  
”r
;

510 
¡
->
size
 = 
äame
->size;

513 ià(
upd©e
) {

514 
	`debug
("gst_video: gstreamer…icture update"

518 
height
 = 
äame
->
size
.
h
;

521 
size
 = 
äame
->
lšesize
[0] * 
height


522 + 
äame
->
lšesize
[1] * 
height
 * 0.5

523 + 
äame
->
lšesize
[2] * 
height
 * 0.5;

525 
d©a
 = 
	`m®loc
(
size
);

526 ià(!
d©a
)

527  
ENOMEM
;

529 
size
 = 0;

532 
	`memıy
(&
d©a
[
size
], 
äame
->d©a[0], f¿me->
lšesize
[0] * 
height
);

533 
size
 +ğ
äame
->
lšesize
[0] * 
height
;

534 
	`memıy
(&
d©a
[
size
], 
äame
->d©a[1], f¿me->
lšesize
[1] * 
height
 * 0.5);

535 
size
 +ğ
äame
->
lšesize
[1] * 
height
 * 0.5;

536 
	`memıy
(&
d©a
[
size
], 
äame
->d©a[2], f¿me->
lšesize
[2] * 
height
 * 0.5);

537 
size
 +ğ
äame
->
lšesize
[2] * 
height
 * 0.5;

539  
	`g¡_video_push
(
¡
, 
d©a
, 
size
);

540 
	}
}

	@baresip/modules/gst_video/gst_video.c

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<g¡/g¡.h
>

12 
	~"g¡_video.h
"

29 
vidcodec
 
	gh264
 = {

30 .
Çme
 = "H264",

31 .
	gv¬ŸÁ
 = "packetization-mode=0",

32 .
	g’cupdh
 = 
g¡_video_’code_upd©e
,

33 .
	g’ch
 = 
g¡_video_’code
,

34 .
	gfm_’ch
 = 
g¡_video_fm_’c
,

35 .
	gfm_cmph
 = 
g¡_video_fm_cmp
,

39 
	$moduË_š™
()

41 
	`g¡_š™
(
NULL
, NULL);

43 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
h264
);

45 
	`šfo
("gst_video: using gstreamer H.264ƒncoder\n");

48 
	}
}

51 
	$moduË_şo£
()

53 
	`vidcodec_uÄegi¡”
(&
h264
);

56 
	}
}

59 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g¡_video
) = {

62 
moduË_š™
,

63 
moduË_şo£


	@baresip/modules/gst_video/gst_video.h

10 
	gvid’c_¡©e
;

12 
g¡_video_’code_upd©e
(
vid’c_¡©e
 **
ve¥
,

13 cÚ¡ 
vidcodec
 *
vc
,

14 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

15 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

16 
g¡_video_’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

17 cÚ¡ 
vidäame
 *
äame
);

21 
ušt32_t
 
g¡_video_h264_·ck‘iz©iÚ_mode
(cÚ¡ *
fm
);

22 
g¡_video_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

23 
boŞ
 
ofãr
, *
¬g
);

24 
boŞ
 
g¡_video_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
);

	@baresip/modules/gst_video/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"g¡_video.h
"

12 cÚ¡ 
ušt8_t
 
	gh264_Ëv–_idc
 = 0x0c;

15 
ušt32_t
 
	$g¡_video_h264_·ck‘iz©iÚ_mode
(cÚ¡ *
fm
)

17 
¶
…l, 
mode
;

19 ià(!
fm
)

22 
	`¶_£t_¡r
(&
¶
, 
fm
);

24 ià(
	`fmt_·¿m_g‘
(&
¶
, "·ck‘iz©iÚ-mode", &
mode
))

25  
	`¶_u32
(&
mode
);

28 
	}
}

31 
	$g¡_video_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

32 
boŞ
 
ofãr
, *
¬g
)

34 
vidcodec
 *
vc
 = 
¬g
;

35 cÚ¡ 
ušt8_t
 
´ofe_idc
 = 0x42;

36 cÚ¡ 
ušt8_t
 
´ofe_iİ
 = 0x80;

37 ()
ofãr
;

39 ià(!
mb
 || !
fmt
 || !
vc
)

42  
	`mbuf_´štf
(
mb
, "a=fmtp:%s"

46 
fmt
->
id
, 
´ofe_idc
, 
´ofe_iİ
, 
h264_Ëv–_idc
);

47 
	}
}

50 
boŞ
 
	$g¡_video_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
)

52 ()
d©a
;

54  
	`g¡_video_h264_·ck‘iz©iÚ_mode
(
fm1
) ==

55 
	`g¡_video_h264_·ck‘iz©iÚ_mode
(
fm2
);

56 
	}
}

	@baresip/modules/gst_video1/encode.c

9 
	#__USE_POSIX199309


	)

10 
	#_DEFAULT_SOURCE
 1

	)

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

13 
	~<sys/time.h
>

14 
	~<uni¡d.h
>

15 
	~<±h»ad.h
>

16 
	~<».h
>

17 
	~<»m.h
>

18 
	~<b¬es.h
>

19 
	~<g¡/g¡.h
>

20 
	~<g¡/video/video.h
>

21 
	~<g¡/­p/g¡­p¤c.h
>

22 
	~<g¡/­p/g¡­psšk.h
>

23 
	~"g¡_video.h
"

26 
	svid’c_¡©e
 {

29 
vidsz
 
	msize
;

30 
	mås
;

31 
	mb™¿‹
;

32 
	mpktsize
;

33 } 
	m’cod”
;

36 
ušt32_t
 
	m·ck‘iz©iÚ_mode
;

37 
ušt32_t
 
	m´ofe_idc
;

38 
ušt32_t
 
	m´ofe_iİ
;

39 
ušt32_t
 
	mËv–_idc
;

40 
ušt32_t
 
	mmax_fs
;

41 
ušt32_t
 
	mmax_smbps
;

42 } 
	mh264
;

44 
vid’c_·ck‘_h
 *
	mpkth
;

45 *
	m¬g
;

49 
boŞ
 
	mv®id
;

51 
G¡EËm’t
 *
	mp–še
;

52 
G¡AµSrc
 *
	msourû
;

54 
G¡AµSrcC®lbacks
 
	m­p¤cC®lbacks
;

55 
G¡AµSškC®lbacks
 
	m­psškC®lbacks
;

58 
±h»ad_mu‹x_t
 
	mmu‹x
;

59 
±h»ad_cÚd_t
 
	mcÚd
;

60 
	mæag
;

61 } 
	meos
;

65 
±h»ad_mu‹x_t
 
	mmu‹x
;

66 
±h»ad_cÚd_t
 
	mcÚd
;

68 
	mæag
;

69 } 
	mwa™
;

70 } 
	m¡»am”
;

74 
	$­p¤c_Ãed_d©a_cb
(
G¡AµSrc
 *
¤c
, 
gušt
 
size
, 
gpoš‹r
 
u£r_d©a
)

76 
vid’c_¡©e
 *
¡
 = 
u£r_d©a
;

77 ()
¤c
;

78 ()
size
;

80 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

81 ià(
¡
->
¡»am”
.
wa™
.
æag
 == 1){

82 
¡
->
¡»am”
.
wa™
.
æag
 = 0;

83 
	`±h»ad_cÚd_sigÇl
(&
¡
->
¡»am”
.
wa™
.
cÚd
);

85 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

86 
	}
}

89 
	$­p¤c_’ough_d©a_cb
(
G¡AµSrc
 *
¤c
, 
gpoš‹r
 
u£r_d©a
)

91 
vid’c_¡©e
 *
¡
 = 
u£r_d©a
;

92 ()
¤c
;

94 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

95 ià(
¡
->
¡»am”
.
wa™
.
æag
 == 0)

96 
¡
->
¡»am”
.
wa™
.
æag
 = 1;

97 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

98 
	}
}

101 
	$­p¤c_de¡roy_nÙify_cb
(
vid’c_¡©e
 *
¡
)

103 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

104 
¡
->
¡»am”
.
wa™
.
æag
 = -1;

105 
	`±h»ad_cÚd_sigÇl
(&
¡
->
¡»am”
.
wa™
.
cÚd
);

106 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

107 
	}
}

111 
G¡FlowR‘uº
 
	$­psšk_Ãw_§m¶e_cb
(
G¡AµSšk
 *
sšk
,

112 
gpoš‹r
 
u£r_d©a
)

114 
vid’c_¡©e
 *
¡
 = 
u£r_d©a
;

115 
G¡Sam¶e
 *
§m¶e
;

116 
G¡Bufãr
 *
bufãr
;

117 
G¡M­Info
 
šfo
;

118 
gušt8
 *
d©a
;

119 
gsize
 
size
;

122 
§m¶e
 = 
	`g¡_­p_sšk_puÎ_§m¶e
(
sšk
);

124 ià(
§m¶e
) {

125 
G¡ClockTime
 
ts
;

126 
ušt32_t
 
¹p_ts
;

128 
bufãr
 = 
	`g¡_§m¶e_g‘_bufãr
(
§m¶e
);

129 
	`g¡_bufãr_m­
Ğ
bufãr
, &
šfo
, (
G¡M­FÏgs
)(
GST_MAP_READ
) );

131 
d©a
 = 
šfo
.data;

132 
size
 = 
šfo
.size;

134 
ts
 = 
	`GST_BUFFER_DTS_OR_PTS
(
bufãr
);

136 ià(
ts
 =ğ
GST_CLOCK_TIME_NONE
) {

137 
	`w¬nšg
("gst_video:imestamp is unknown\n");

138 
¹p_ts
 = 0;

142 
¹p_ts
 = (
ušt32_t
)((90000ULL * 
ts
) / 1000000000UL);

145 
	`h264_·ck‘ize
(
¹p_ts
, 
d©a
, 
size
, 
¡
->
’cod”
.
pktsize
,

146 
¡
->
pkth
, st->
¬g
);

148 
	`g¡_bufãr_unm­
(
bufãr
, &
šfo
);

149 
	`g¡_§m¶e_uÄef
(
§m¶e
);

152  
GST_FLOW_OK
;

153 
	}
}

156 
	$­psšk_’d_of_¡»am_cb
(
G¡AµSšk
 *
¤c
, 
gpoš‹r
 
u£r_d©a
)

158 
vid’c_¡©e
 *
¡
 = 
u£r_d©a
;

159 ()
¤c
;

161 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

162 ià(
¡
->
¡»am”
.
eos
.
æag
 == 0) {

163 
¡
->
¡»am”
.
eos
.
æag
 = 1;

164 
	`±h»ad_cÚd_sigÇl
(&
¡
->
¡»am”
.
eos
.
cÚd
);

166 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

167 
	}
}

170 
	$­psšk_de¡roy_nÙify_cb
(
vid’c_¡©e
 *
¡
)

172 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

173 
¡
->
¡»am”
.
eos
.
æag
 = -1;

174 
	`±h»ad_cÚd_sigÇl
(&
¡
->
¡»am”
.
eos
.
cÚd
);

175 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

176 
	}
}

179 
G¡BusSyncR•ly
 
	$bus_sync_hªdËr_cb
(
G¡Bus
 *
bus
, 
G¡Mes§ge
 *
msg
,

180 
vid’c_¡©e
 *
¡
)

182 ()
bus
;

184 ià((
	`GST_MESSAGE_TYPE
 (
msg
)è=ğ
GST_MESSAGE_ERROR
) {

185 
GE¼Ü
 *
”r
 = 
NULL
;

186 
gch¬
 *
dbg_šfo
 = 
NULL
;

187 
	`g¡_mes§ge_·r£_”rÜ
 (
msg
, &
”r
, &
dbg_šfo
);

188 
	`w¬nšg
("gst_video: Error: %d(%m) message=%s\n",

189 
”r
->
code
,ƒ¼->code,ƒ¼->
mes§ge
);

190 
	`w¬nšg
("g¡_video: Debug: %s\n", 
dbg_šfo
);

191 
	`g_”rÜ_ä“
 (
”r
);

192 
	`g_ä“
 (
dbg_šfo
);

195 
¡
->
¡»am”
.
v®id
 = 
çl£
;

198 
	`g¡_mes§ge_uÄef
(
msg
);

199  
GST_BUS_DROP
;

200 
	}
}

203 
	$bus_de¡roy_nÙify_cb
(
vid’c_¡©e
 *
¡
)

205 ()
¡
;

206 
	}
}

224 
	$p–še_š™
(
vid’c_¡©e
 *
¡
, cÚ¡ 
vidsz
 *
size
)

226 
G¡AµSrc
 *
sourû
;

227 
G¡AµSšk
 *
sšk
;

228 
G¡Bus
 *
bus
;

229 
GE¼Ü
* 
g”rÜ
 = 
NULL
;

230 
p–še
[1024];

231 
G¡S‹ChªgeR‘uº
 
»t
;

232 
”r
 = 0;

234 ià(!
¡
 || !
size
)

235  
EINVAL
;

237 
	`¢´štf
(
p–še
, (pipeline),

245 
size
->
w
, size->
h
,

246 
¡
->
’cod”
.
ås
, st->’cod”.
b™¿‹
 / 1000 );

249 
¡
->
¡»am”
.
p–še
 = 
	`g¡_·r£_Ïunch
Õ–še, &
g”rÜ
);

251 ià(
g”rÜ
) {

252 
	`w¬nšg
("gst_video:†aunchƒrror: %d: %s: %s\n",

253 
g”rÜ
->
code
, g”rÜ->
mes§ge
, 
p–še
);

254 
”r
 = 
g”rÜ
->
code
;

255 
	`g_”rÜ_ä“
(
g”rÜ
);

256  
”r
;

260 
sourû
 = 
	`GST_APP_SRC
(
	`g¡_bš_g‘_by_Çme
(

261 
	`GST_BIN
(
¡
->
¡»am”
.
p–še
), "source"));

262 
	`g¡_­p_¤c_£t_ÿÎbacks
(
sourû
, &(
¡
->
¡»am”
.
­p¤cC®lbacks
),

263 
¡
, (
GDe¡royNÙify
)
­p¤c_de¡roy_nÙify_cb
);

266 
sšk
 = 
	`GST_APP_SINK
(
	`g¡_bš_g‘_by_Çme
(

267 
	`GST_BIN
(
¡
->
¡»am”
.
p–še
), "sink"));

268 
	`g¡_­p_sšk_£t_ÿÎbacks
(
sšk
, &(
¡
->
¡»am”
.
­psškC®lbacks
),

269 
¡
, (
GDe¡royNÙify
)
­psšk_de¡roy_nÙify_cb
);

270 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
sšk
));

273 
bus
 = 
	`g¡_p–še_g‘_bus
(
	`GST_PIPELINE
(
¡
->
¡»am”
.
p–še
));

274 
	`g¡_bus_£t_sync_hªdËr
(
bus
, (
G¡BusSyncHªdËr
)
bus_sync_hªdËr_cb
,

275 
¡
, (
GDe¡royNÙify
)
bus_de¡roy_nÙify_cb
);

276 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
bus
));

279 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

280 
¡
->
¡»am”
.
wa™
.
æag
 = 0;

281 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

283 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

284 
¡
->
¡»am”
.
eos
.
æag
 = 0;

285 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

288 
»t
 = 
	`g¡_–em’t_£t_¡©e
(
¡
->
¡»am”
.
p–še
, 
GST_STATE_PLAYING
);

289 ià(
GST_STATE_CHANGE_FAILURE
 =ğ
»t
) {

290 
	`g_w¬nšg
("set state„eturned GST_STATE_CHANGE_FAILURE\n");

291 
”r
 = 
EPROTO
;

292 
out
;

295 
¡
->
¡»am”
.
sourû
 = source;

298 
¡
->
¡»am”
.
v®id
 = 
Œue
;

300 
out
:

301  
”r
;

302 
	}
}

305 
	$p–še_şo£
(
vid’c_¡©e
 *
¡
)

307 ià(!
¡
)

310 
¡
->
¡»am”
.
v®id
 = 
çl£
;

312 ià(
¡
->
¡»am”
.
sourû
) {

313 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
¡»am”
.
sourû
));

314 
¡
->
¡»am”
.
sourû
 = 
NULL
;

317 ià(
¡
->
¡»am”
.
p–še
) {

318 
	`g¡_–em’t_£t_¡©e
(
¡
->
¡»am”
.
p–še
, 
GST_STATE_NULL
);

321 
	`g¡_objeù_uÄef
(
	`GST_OBJECT
(
¡
->
¡»am”
.
p–še
));

322 
¡
->
¡»am”
.
p–še
 = 
NULL
;

324 
	}
}

327 
	$de¡ruù_»sourûs
(*
d©a
)

329 
vid’c_¡©e
 *
¡
 = 
d©a
;

332 
	`p–še_şo£
(
¡
);

335 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

336 
	`±h»ad_cÚd_de¡roy
(&
¡
->
¡»am”
.
eos
.
cÚd
);

338 
	`±h»ad_mu‹x_de¡roy
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

339 
	`±h»ad_cÚd_de¡roy
(&
¡
->
¡»am”
.
wa™
.
cÚd
);

340 
	}
}

343 
	$®loÿ‹_»sourûs
(
vid’c_¡©e
 **
¡p
)

345 
vid’c_¡©e
 *
¡
;

347 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruù_»sourûs
);

348 ià(!
¡
)

349  
ENOMEM
;

351 *
¡p
 = 
¡
;

354 
	`±h»ad_mu‹x_š™
(&
¡
->
¡»am”
.
eos
.
mu‹x
, 
NULL
);

355 
	`±h»ad_cÚd_š™
(&
¡
->
¡»am”
.
eos
.
cÚd
, 
NULL
);

357 
	`±h»ad_mu‹x_š™
(&
¡
->
¡»am”
.
wa™
.
mu‹x
, 
NULL
);

358 
	`±h»ad_cÚd_š™
(&
¡
->
¡»am”
.
wa™
.
cÚd
, 
NULL
);

362 
¡
->
¡»am”
.
­p¤cC®lbacks
.
Ãed_d©a
 = &
­p¤c_Ãed_d©a_cb
;

363 
¡
->
¡»am”
.
­p¤cC®lbacks
.
’ough_d©a
 = &
­p¤c_’ough_d©a_cb
;

366 
¡
->
¡»am”
.
­psškC®lbacks
.
Ãw_§m¶e
 = &
­psšk_Ãw_§m¶e_cb
;

367 
¡
->
¡»am”
.
­psškC®lbacks
.
eos
 = &
­psšk_’d_of_¡»am_cb
;

370 
	}
}

376 
	$·¿m_hªdËr
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

377 *
¬g
)

379 
vid’c_¡©e
 *
¡
 = 
¬g
;

381 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "packetization-mode")) {

382 
¡
->
h264
.
·ck‘iz©iÚ_mode
 = 
	`¶_u32
(
v®
);

384 ià(
¡
->
h264
.
·ck‘iz©iÚ_mode
 != 0) {

385 
	`w¬nšg
("gst_video: illegal…acketization-mode %u\n",

386 
¡
->
h264
.
·ck‘iz©iÚ_mode
);

390 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "profile-level-id")) {

391 
¶
 
´of
 = *
v®
;

392 ià(
´of
.
l
 != 6) {

393 
	`w¬nšg
("gst_video: invalid…rofile-level-id (%r)\n",

394 
v®
);

398 
´of
.
l
 = 2;

399 
¡
->
h264
.
´ofe_idc
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

400 
¡
->
h264
.
´ofe_iİ
 = 
	`¶_x32
(&
´of
);…rof.
p
 += 2;

401 
¡
->
h264
.
Ëv–_idc
 = 
	`¶_x32
(&
´of
);

403 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-fs")) {

404 
¡
->
h264
.
max_fs
 = 
	`¶_u32
(
v®
);

406 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "max-smbps")) {

407 
¡
->
h264
.
max_smbps
 = 
	`¶_u32
(
v®
);

411 
	}
}

414 
	$g¡_video1_’cod”_£t
(
vid’c_¡©e
 **
¡p
,

415 cÚ¡ 
vidcodec
 *
vc
,

416 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

417 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

419 
vid’c_¡©e
 *
¡
 = *
¡p
;

420 
”r
 = 0;

422 ià(!
¡p
 || !
vc
 || !
´m
 || !
pkth
)

423  
EINVAL
;

425 ià(!
¡
) {

426 
”r
 = 
	`®loÿ‹_»sourûs
(
¡p
);

427 ià(
”r
) {

428 
	`w¬nšg
("gst_video:„esource‡llocation failed\n");

429  
”r
;

431 
¡
 = *
¡p
;

433 
¡
->
pkth
 =…kth;

434 
¡
->
¬g
 =‡rg;

437 ià(!
¡
->
¡»am”
.
v®id
) {

438 
	`w¬nšg
("gst_video codec:ryingo work"

440  
EINVAL
;

443 ià((
¡
->
’cod”
.
b™¿‹
 !ğ
´m
->bitrate ||

444 
¡
->
’cod”
.
pktsize
 !ğ
´m
->pktsize ||

445 
¡
->
’cod”
.
ås
 !ğ
´m
->fps)) {

447 
	`p–še_şo£
(
¡
);

451 
¡
->
’cod”
.
b™¿‹
 = 
´m
->bitrate;

452 
¡
->
’cod”
.
pktsize
 = 
´m
->pktsize;

453 
¡
->
’cod”
.
ås
 = 
´m
->fps;

455 ià(
	`¡r_is£t
(
fm
)) {

456 
¶
 
sdp_fm
;

457 
	`¶_£t_¡r
(&
sdp_fm
, 
fm
);

460 
	`fmt_·¿m_­¶y
(&
sdp_fm
, 
·¿m_hªdËr
, 
¡
);

463 
	`šfo
("gst_video: videoƒncoder %s: %d fps, %d bit/s,…ktsize=%u\n",

464 
vc
->
Çme
, 
¡
->
’cod”
.
ås
,

465 
¡
->
’cod”
.
b™¿‹
, st->’cod”.
pktsize
);

467  
”r
;

468 
	}
}

474 
	$p–še_push
(
vid’c_¡©e
 *
¡
, cÚ¡ 
vidäame
 *
äame
)

476 
G¡Bufãr
 *
bufãr
;

477 
ušt8_t
 *
d©a
;

478 
size_t
 
size
;

479 
G¡FlowR‘uº
 
»t
;

480 
”r
 = 0;

488 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

489 ià(
¡
->
¡»am”
.
wa™
.
æag
 == 1) {

490 
	`±h»ad_cÚd_wa™
(&
¡
->
¡»am”
.
wa™
.
cÚd
,

491 &
¡
->
¡»am”
.
wa™
.
mu‹x
);

493 ià(
¡
->
¡»am”
.
eos
.
æag
 == -1)

495 
”r
 = 
ENODEV
;

496 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

497 ià(
”r
)

498  
”r
;

506 
size
 = 
äame
->
lšesize
[0] * f¿me->size.
h


507 + 
äame
->
lšesize
[1] * f¿me->
size
.
h
 * 0.5

508 + 
äame
->
lšesize
[2] * f¿me->
size
.
h
 * 0.5;

512 
d©a
 = 
	`g_Œy_m®loc
(
size
);

513 ià(!
d©a
)

514  
ENOMEM
;

517 
size
 = 0;

518 
	`memıy
(&
d©a
[
size
], 
äame
->data[0],

519 
äame
->
lšesize
[0] * f¿me->
size
.
h
);

520 
size
 +ğ
äame
->
lšesize
[0] * f¿me->size.
h
;

521 
	`memıy
(&
d©a
[
size
], 
äame
->data[1],

522 
äame
->
lšesize
[1] * f¿me->
size
.
h
 * 0.5);

523 
size
 +ğ
äame
->
lšesize
[1] * f¿me->size.
h
 * 0.5;

524 
	`memıy
(&
d©a
[
size
], 
äame
->data[2],

525 
äame
->
lšesize
[2] * f¿me->
size
.
h
 * 0.5);

526 
size
 +ğ
äame
->
lšesize
[2] * f¿me->size.
h
 * 0.5;

529 
bufãr
 = 
	`g¡_bufãr_Ãw
();

530 
	`g¡_bufãr_š£¹_memÜy
(
bufãr
, -1,

531 
	`g¡_memÜy_Ãw_w¿µed
 (0, 
d©a
, 
size
, 0,

532 
size
, 
d©a
, 
g_ä“
));

538 
»t
 = 
	`g¡_­p_¤c_push_bufãr
(
¡
->
¡»am”
.
sourû
, 
bufãr
);

539 ià(
»t
 !ğ
GST_FLOW_OK
) {

540 
	`w¬nšg
("gst_video:…ushing buffer failed\n");

541 
”r
 = 
EPROTO
;

542 
out
;

546 
»t
 = 
	`g¡_­p_¤c_’d_of_¡»am
(
¡
->
¡»am”
.
sourû
);

547 ià(
»t
 !ğ
GST_FLOW_OK
) {

548 
	`w¬nšg
("gst_video:…ushing EOS failed\n");

549 
”r
 = 
EPROTO
;

550 
out
;

559 
	`±h»ad_mu‹x_lock
(&
¡
->
¡»am”
.
eos
.
mu‹x
);

560 ià(
¡
->
¡»am”
.
eos
.
æag
 == 0)

562 
	`±h»ad_cÚd_wa™
(&
¡
->
¡»am”
.
wa™
.
cÚd
,

563 &
¡
->
¡»am”
.
wa™
.
mu‹x
);

564 ià(
¡
->
¡»am”
.
eos
.
æag
 == 1)

566 
¡
->
¡»am”
.
eos
.
æag
 = 0;

569 
”r
 = -1;

570 
	`±h»ad_mu‹x_uÆock
(&
¡
->
¡»am”
.
wa™
.
mu‹x
);

574 
out
:

575  
”r
;

576 
	}
}

579 
	$g¡_video1_’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

580 cÚ¡ 
vidäame
 *
äame
)

582 
”r
;

584 ià(!
¡
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

585  
EINVAL
;

587 ià(!
¡
->
¡»am”
.
v®id
 ||

588 !
	`vidsz_cmp
(&
¡
->
’cod”
.
size
, &
äame
->size)) {

590 
	`p–še_şo£
(
¡
);

592 
”r
 = 
	`p–še_š™
(
¡
, &
äame
->
size
);

593 ià(
”r
) {

594 
	`w¬nšg
("gst_video:…ipeline initialization failed\n");

595  
”r
;

598 
¡
->
’cod”
.
size
 = 
äame
->size;

601 ià(
upd©e
) {

602 
	`debug
("gst_video: gstreamer…icture update"

610 
”r
 = 
	`p–še_push
(
¡
, 
äame
);

612  
”r
;

613 
	}
}

	@baresip/modules/gst_video1/gst_video.c

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<g¡/g¡.h
>

12 
	~"g¡_video.h
"

29 
vidcodec
 
	gh264
 = {

30 .
Çme
 = "H264",

31 .
	gv¬ŸÁ
 = "packetization-mode=0",

32 .
	g’cupdh
 = 
g¡_video1_’cod”_£t
,

33 .
	g’ch
 = 
g¡_video1_’code
,

34 .
	gfm_’ch
 = 
g¡_video1_fm_’c
,

35 .
	gfm_cmph
 = 
g¡_video1_fm_cmp
,

39 
	$moduË_š™
()

41 
	`g¡_š™
(
NULL
, NULL);

43 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
h264
);

45 
	`šfo
("g¡_video: usšg g¡»am” (%s)\n", 
	`g¡_v”siÚ_¡ršg
());

48 
	}
}

51 
	$moduË_şo£
()

53 
	`vidcodec_uÄegi¡”
(&
h264
);

55 
	`g¡_deš™
();

58 
	}
}

61 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
g¡_video1
) = {

64 
moduË_š™
,

65 
moduË_şo£


	@baresip/modules/gst_video1/gst_video.h

10 
	gvid’c_¡©e
;

12 
g¡_video1_’cod”_£t
(
vid’c_¡©e
 **
¡p
,

13 cÚ¡ 
vidcodec
 *
vc
,

14 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

15 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

16 
g¡_video1_’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

17 cÚ¡ 
vidäame
 *
äame
);

21 
ušt32_t
 
g¡_video1_h264_·ck‘iz©iÚ_mode
(cÚ¡ *
fm
);

22 
g¡_video1_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

23 
boŞ
 
ofãr
, *
¬g
);

24 
boŞ
 
g¡_video1_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
);

	@baresip/modules/gst_video1/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"g¡_video.h
"

12 cÚ¡ 
ušt8_t
 
	gg¡_video_h264_Ëv–_idc
 = 0x0c;

15 
ušt32_t
 
	$g¡_video1_h264_·ck‘iz©iÚ_mode
(cÚ¡ *
fm
)

17 
¶
…l, 
mode
;

19 ià(!
fm
)

22 
	`¶_£t_¡r
(&
¶
, 
fm
);

24 ià(
	`fmt_·¿m_g‘
(&
¶
, "·ck‘iz©iÚ-mode", &
mode
))

25  
	`¶_u32
(&
mode
);

28 
	}
}

31 
	$g¡_video1_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

32 
boŞ
 
ofãr
, *
¬g
)

34 
vidcodec
 *
vc
 = 
¬g
;

35 cÚ¡ 
ušt8_t
 
´ofe_idc
 = 0x42;

36 cÚ¡ 
ušt8_t
 
´ofe_iİ
 = 0x80;

37 ()
ofãr
;

39 ià(!
mb
 || !
fmt
 || !
vc
)

42  
	`mbuf_´štf
(
mb
, "a=fmtp:%s"

46 
fmt
->
id
, 
´ofe_idc
, 
´ofe_iİ
,

47 
g¡_video_h264_Ëv–_idc
);

48 
	}
}

51 
boŞ
 
	$g¡_video1_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
)

53 ()
d©a
;

55  
	`g¡_video1_h264_·ck‘iz©iÚ_mode
(
fm1
) ==

56 
	`g¡_video1_h264_·ck‘iz©iÚ_mode
(
fm2
);

57 
	}
}

	@baresip/modules/gtk/call_window.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<gtk/gtk.h
>

10 
	~"gtk_mod.h
"

13 
	sÿÎ_wšdow
 {

14 
gtk_mod
 *
	mmod
;

15 
ÿÎ
 *
	mÿÎ
;

18 
mqueue
 *
	mmq
;

21 
vum‘”_dec
 *
	mdec
;

22 
vum‘”_’c
 *
	m’c
;

23 } 
	mvu
;

24 
Œªsãr_dŸlog
 *
	mŒªsãr_dŸlog
;

25 
GtkWidg‘
 *
	mwšdow
;

26 
GtkLab–
 *
	m¡©us
;

27 
GtkLab–
 *
	mdu¿tiÚ
;

29 
GtkWidg‘
 *
	mhªgup
, *
	mŒªsãr
, *
	mhŞd
, *
	mmu‹
;

30 } 
	mbu‰Ús
;

32 
GtkProg»ssB¬
 *
	m’c
, *
	mdec
;

33 } 
	m´og»ss
;

34 
gušt
 
	mdu¿tiÚ_tim”_g
;

35 
gušt
 
	mvum‘”_tim”_g
;

36 
boŞ
 
	mşo£d
;

37 
	mcur_key
;

40 
	eÿÎ_wšdow_ev’ts
 {

41 
	mMQ_HANGUP
,

42 
	mMQ_CLOSE
,

43 
	mMQ_HOLD
,

44 
	mMQ_MUTE
,

45 
	mMQ_TRANSFER
,

48 
ÿÎ_wšdow
 *
	gÏ¡_ÿÎ_wš
 = 
NULL
;

49 
vum‘”_dec
 *
	gÏ¡_dec
 = 
NULL
;

50 
vum‘”_’c
 *
	gÏ¡_’c
 = 
NULL
;

53 
	$ÿÎ_wšdow_upd©e_du¿tiÚ
(
ÿÎ_wšdow
 *
wš
)

55 
gch¬
 
buf
[32];

57 cÚ¡ 
ušt32_t
 
dur
 = 
	`ÿÎ_du¿tiÚ
(
wš
->
ÿÎ
);

58 cÚ¡ 
ušt32_t
 
£c
 = 
dur
%60%60;

59 cÚ¡ 
ušt32_t
 
mš
 = 
dur
/60%60;

60 cÚ¡ 
ušt32_t
 
hrs
 = 
dur
/60/60;

62 
	`»_¢´štf
(
buf
,  buf, "%u:%02u:%02u", 
hrs
, 
mš
, 
£c
);

63 
	`gtk_Ïb–_£t_‹xt
(
wš
->
du¿tiÚ
, 
buf
);

64 
	}
}

67 
	$ÿÎ_wšdow_upd©e_vum‘”s
(
ÿÎ_wšdow
 *
wš
)

69 
v®ue
;

71 ià(
wš
->
vu
.
’c
 && wš->vu.’c->
¡¬‹d
) {

72 
v®ue
 = 
	`mš
(()
wš
->
vu
.
’c
->
avg_»c
 / 0x4000, 1);

73 
	`gtk_´og»ss_b¬_£t_äaùiÚ
(
wš
->
´og»ss
.
’c
, 
v®ue
);

75 ià(
wš
->
vu
.
dec
 && wš->vu.dec->
¡¬‹d
) {

76 
v®ue
 = 
	`mš
(()
wš
->
vu
.
dec
->
avg_¶ay
 / 0x4000, 1);

77 
	`gtk_´og»ss_b¬_£t_äaùiÚ
(
wš
->
´og»ss
.
dec
, 
v®ue
);

79 
	}
}

82 
gboŞ—n
 
	$ÿÎ_tim”
(
gpoš‹r
 
¬g
)

84 
ÿÎ_wšdow
 *
wš
 = 
¬g
;

85 
	`ÿÎ_wšdow_upd©e_du¿tiÚ
(
wš
);

86  
G_SOURCE_CONTINUE
;

87 
	}
}

90 
gboŞ—n
 
	$vum‘”_tim”
(
gpoš‹r
 
¬g
)

92 
ÿÎ_wšdow
 *
wš
 = 
¬g
;

93 
	`ÿÎ_wšdow_upd©e_vum‘”s
(
wš
);

94  
G_SOURCE_CONTINUE
;

95 
	}
}

98 
	$vum‘”_tim”_¡¬t
(
ÿÎ_wšdow
 *
wš
)

100 ià(!
wš
->
vum‘”_tim”_g
)

101 
wš
->
vum‘”_tim”_g
 =

102 
	`g_timeout_add
(100, 
vum‘”_tim”
, 
wš
);

103 ià(
wš
->
vu
.
’c
)

104 
wš
->
vu
.
’c
->
avg_»c
 = 0;

105 ià(
wš
->
vu
.
dec
)

106 
wš
->
vu
.
dec
->
avg_¶ay
 = 0;

107 
	}
}

110 
	$vum‘”_tim”_¡İ
(
ÿÎ_wšdow
 *
wš
)

112 ià(
wš
->
vum‘”_tim”_g
) {

113 
	`g_sourû_»move
(
wš
->
vum‘”_tim”_g
);

114 
wš
->
vum‘”_tim”_g
 = 0;

116 
	`gtk_´og»ss_b¬_£t_äaùiÚ
(
wš
->
´og»ss
.
’c
, 0);

117 
	`gtk_´og»ss_b¬_£t_äaùiÚ
(
wš
->
´og»ss
.
dec
, 0);

118 
	}
}

121 
	$ÿÎ_wšdow_£t_vu_dec
(
ÿÎ_wšdow
 *
wš
,

122 
vum‘”_dec
 *
dec
)

124 ià(
wš
->
vu
.
dec
)

125 
	`mem_d”ef
(
wš
->
vu
.
dec
);

126 
wš
->
vu
.
dec
 = 
	`mem_»f
(dec);

127 
	`vum‘”_tim”_¡¬t
(
wš
);

128 
	}
}

131 
	$ÿÎ_wšdow_£t_vu_’c
(
ÿÎ_wšdow
 *
wš
,

132 
vum‘”_’c
 *
’c
)

134 ià(
wš
->
vu
.
’c
)

135 
	`mem_d”ef
(
wš
->
vu
.
’c
);

136 
wš
->
vu
.
’c
 = 
	`mem_»f
(enc);

137 
	`vum‘”_tim”_¡¬t
(
wš
);

138 
	}
}

143 
	$ÿÎ_wšdow_gÙ_vu_dec
(
vum‘”_dec
 *
dec
)

145 ià(
Ï¡_ÿÎ_wš
)

146 
	`ÿÎ_wšdow_£t_vu_dec
(
Ï¡_ÿÎ_wš
, 
dec
);

148 
Ï¡_dec
 = 
dec
;

149 
	}
}

152 
	$ÿÎ_wšdow_gÙ_vu_’c
(
vum‘”_’c
 *
’c
)

154 ià(
Ï¡_ÿÎ_wš
)

155 
	`ÿÎ_wšdow_£t_vu_’c
(
Ï¡_ÿÎ_wš
, 
’c
);

157 
Ï¡_’c
 = 
’c
;

158 
	}
}

161 
	$gÙ_ÿÎ_wšdow
(
ÿÎ_wšdow
 *
wš
)

163 ià(
Ï¡_’c
)

164 
	`ÿÎ_wšdow_£t_vu_’c
(
wš
, 
Ï¡_’c
);

165 ià(
Ï¡_dec
)

166 
	`ÿÎ_wšdow_£t_vu_dec
(
wš
, 
Ï¡_dec
);

167 ià(!
Ï¡_’c
 || !
Ï¡_dec
)

168 
Ï¡_ÿÎ_wš
 = 
wš
;

169 
	}
}

172 
	$ÿÎ_Ú_hªgup
(
GtkToggËBu‰Ú
 *
bŠ
, 
ÿÎ_wšdow
 *
wš
)

174 ()
bŠ
;

175 
	`mqueue_push
(
wš
->
mq
, 
MQ_CLOSE
, win);

176 
	}
}

179 
	$ÿÎ_Ú_hŞd_toggË
(
GtkToggËBu‰Ú
 *
bŠ
, 
ÿÎ_wšdow
 *
wš
)

181 
boŞ
 
hŞd
 = 
	`gtk_toggË_bu‰Ú_g‘_aùive
(
bŠ
);

182 ià(
hŞd
)

183 
	`vum‘”_tim”_¡İ
(
wš
);

185 
	`vum‘”_tim”_¡¬t
(
wš
);

186 
	`mqueue_push
(
wš
->
mq
, 
MQ_HOLD
, (*)(
size_t
)
hŞd
);

187 
	}
}

190 
	$ÿÎ_Ú_mu‹_toggË
(
GtkToggËBu‰Ú
 *
bŠ
, 
ÿÎ_wšdow
 *
wš
)

192 
boŞ
 
mu‹
 = 
	`gtk_toggË_bu‰Ú_g‘_aùive
(
bŠ
);

193 
	`mqueue_push
(
wš
->
mq
, 
MQ_MUTE
, (*)(
size_t
)
mu‹
);

194 
	}
}

197 
	$ÿÎ_Ú_Œªsãr
(
GtkToggËBu‰Ú
 *
bŠ
, 
ÿÎ_wšdow
 *
wš
)

199 ()
bŠ
;

200 ià(!
wš
->
Œªsãr_dŸlog
)

201 
wš
->
Œªsãr_dŸlog
 = 
	`Œªsãr_dŸlog_®loc
(win);

203 
	`Œªsãr_dŸlog_show
(
wš
->
Œªsãr_dŸlog
);

204 
	}
}

206 
gboŞ—n
 
	$ÿÎ_Ú_wšdow_şo£
(
GtkWidg‘
 *
widg‘
, 
GdkEv’tAny
 *
ev’t
,

207 
ÿÎ_wšdow
 *
wš
)

209 ()
ev’t
;

210 ()
widg‘
;

211 
	`mqueue_push
(
wš
->
mq
, 
MQ_CLOSE
, 
NULL
);

212  
TRUE
;

213 
	}
}

216 
gboŞ—n
 
	$ÿÎ_Ú_key_´ess
(
GtkWidg‘
 *
wšdow
, 
GdkEv’t
 *
ev
,

217 
ÿÎ_wšdow
 *
wš
)

219 
gch¬
 
key
 = 
ev
->key.
¡ršg
[0];

220 ()
wšdow
;

222 
key
) {

228 
wš
->
cur_key
 = 
key
;

229 
	`ÿÎ_£nd_dig™
(
wš
->
ÿÎ
, 
key
);

230  
TRUE
;

233  
FALSE
;

235 
	}
}

238 
gboŞ—n
 
	$ÿÎ_Ú_key_»Ëa£
(
GtkWidg‘
 *
wšdow
, 
GdkEv’t
 *
ev
,

239 
ÿÎ_wšdow
 *
wš
)

241 ()
wšdow
;

243 ià(
wš
->
cur_key
 && wš->cur_key =ğ
ev
->
key
.
¡ršg
[0]) {

244 
wš
->
cur_key
 = 0;

245 
	`ÿÎ_£nd_dig™
(
wš
->
ÿÎ
, 0);

246  
TRUE
;

249  
FALSE
;

250 
	}
}

253 
	$ÿÎ_wšdow_£t_¡©us
(
ÿÎ_wšdow
 *
wš
,

254 cÚ¡ *
¡©us
)

256 
	`gtk_Ïb–_£t_‹xt
(
wš
->
¡©us
, status);

257 
	}
}

260 
	$mqueue_hªdËr
(
id
, *
d©a
, *
¬g
)

262 
ÿÎ_wšdow
 *
wš
 = 
¬g
;

264 (
ÿÎ_wšdow_ev’ts
)
id
) {

266 
MQ_HANGUP
:

267 
	`ua_hªgup
(
	`uag_cu¼’t
(), 
wš
->
ÿÎ
, 0, 
NULL
);

270 
MQ_CLOSE
:

271 ià(!
wš
->
şo£d
) {

272 
	`ua_hªgup
(
	`uag_cu¼’t
(), 
wš
->
ÿÎ
, 0, 
NULL
);

273 
wš
->
şo£d
 = 
Œue
;

275 
	`mem_d”ef
(
wš
);

278 
MQ_MUTE
:

279 
	`audio_mu‹
(
	`ÿÎ_audio
(
wš
->
ÿÎ
), (
size_t
)
d©a
);

282 
MQ_HOLD
:

283 
	`ÿÎ_hŞd
(
wš
->
ÿÎ
, (
size_t
)
d©a
);

286 
MQ_TRANSFER
:

287 
	`ÿÎ_Œªsãr
(
wš
->
ÿÎ
, 
d©a
);

290 
	}
}

293 
	$ÿÎ_wšdow_de¡ruùÜ
(*
¬g
)

295 
ÿÎ_wšdow
 *
wšdow
 = 
¬g
;

297 
	`gdk_th»ads_’‹r
();

298 
	`gtk_mod_ÿÎ_wšdow_şo£d
(
wšdow
->
mod
, window);

299 
	`gtk_widg‘_de¡roy
(
wšdow
->window);

300 
	`mem_d”ef
(
wšdow
->
Œªsãr_dŸlog
);

301 
	`gdk_th»ads_Ëave
();

303 
	`mem_d”ef
(
wšdow
->
ÿÎ
);

304 
	`mem_d”ef
(
wšdow
->
mq
);

305 
	`mem_d”ef
(
wšdow
->
vu
.
’c
);

306 
	`mem_d”ef
(
wšdow
->
vu
.
dec
);

307 ià(
wšdow
->
du¿tiÚ_tim”_g
)

308 
	`g_sourû_»move
(
wšdow
->
du¿tiÚ_tim”_g
);

309 ià(
wšdow
->
vum‘”_tim”_g
)

310 
	`g_sourû_»move
(
wšdow
->
vum‘”_tim”_g
);

312 
Ï¡_ÿÎ_wš
 = 
NULL
;

313 
	}
}

316 
ÿÎ_wšdow
 *
	$ÿÎ_wšdow_Ãw
(
ÿÎ
 *ÿÎ, 
gtk_mod
 *
mod
)

318 
ÿÎ_wšdow
 *
wš
;

319 
GtkWidg‘
 *
wšdow
, *
Ïb–
, *
¡©us
, *
bu‰Ú
, *
´og»ss
, *
image
;

320 
GtkWidg‘
 *
bu‰Ú_box
, *
vbox
, *
hbox
;

321 
GtkWidg‘
 *
du¿tiÚ
;

322 
”r
 = 0;

324 
wš
 = 
	`mem_z®loc
((*wš), 
ÿÎ_wšdow_de¡ruùÜ
);

325 ià(!
wš
)

326  
NULL
;

328 
	`mqueue_®loc
(&
wš
->
mq
, 
mqueue_hªdËr
, win);

329 ià(
”r
)

330 
out
;

332 
wšdow
 = 
	`gtk_wšdow_Ãw
(
GTK_WINDOW_TOPLEVEL
);

333 
	`gtk_wšdow_£t_t™Ë
(
	`GTK_WINDOW
(
wšdow
), 
	`ÿÎ_³”uri
(
ÿÎ
));

334 
	`gtk_wšdow_£t_ty³_hšt
(
	`GTK_WINDOW
(
wšdow
),

335 
GDK_WINDOW_TYPE_HINT_DIALOG
);

337 
vbox
 = 
	`gtk_vbox_Ãw
 (
FALSE
, 0);

338 
	`gtk_cÚš”_add
(
	`GTK_CONTAINER
(
wšdow
), 
vbox
);

341 
Ïb–
 = 
	`gtk_Ïb–_Ãw
(
	`ÿÎ_³”Çme
(
ÿÎ
));

342 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
vbox
), 
Ïb–
, 
FALSE
, FALSE, 0);

344 
Ïb–
 = 
	`gtk_Ïb–_Ãw
(
	`ÿÎ_³”uri
(
ÿÎ
));

345 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
vbox
), 
Ïb–
, 
FALSE
, FALSE, 0);

348 
du¿tiÚ
 = 
	`gtk_Ïb–_Ãw
(
NULL
);

349 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
vbox
), 
du¿tiÚ
, 
FALSE
, FALSE, 0);

352 
¡©us
 = 
	`gtk_Ïb–_Ãw
(
NULL
);

353 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
vbox
), 
¡©us
, 
FALSE
, FALSE, 0);

356 
hbox
 = 
	`gtk_hbox_Ãw
(
FALSE
, 0);

357 
	`gtk_box_£t_¥acšg
(
	`GTK_BOX
(
hbox
), 6);

358 
	`gtk_cÚš”_£t_bÜd”_width
(
	`GTK_CONTAINER
(
hbox
), 5);

359 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
vbox
), 
hbox
, 
FALSE
, FALSE, 0);

362 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("audio-input-microphone",

363 
GTK_ICON_SIZE_BUTTON
);

364 
´og»ss
 = 
	`gtk_´og»ss_b¬_Ãw
();

365 
wš
->
´og»ss
.
’c
 = 
	`GTK_PROGRESS_BAR
(progress);

366 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
hbox
), 
image
, 
FALSE
, FALSE, 0);

367 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
hbox
), 
´og»ss
, 
FALSE
, FALSE, 0);

370 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("audio-headphones",

371 
GTK_ICON_SIZE_BUTTON
);

372 
´og»ss
 = 
	`gtk_´og»ss_b¬_Ãw
();

373 
wš
->
´og»ss
.
dec
 = 
	`GTK_PROGRESS_BAR
(progress);

374 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
hbox
), 
´og»ss
, 
FALSE
, FALSE, 0);

375 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
hbox
), 
image
, 
FALSE
, FALSE, 0);

378 
bu‰Ú_box
 = 
	`gtk_hbu‰Ú_box_Ãw
();

379 
	`gtk_bu‰Ú_box_£t_Ïyout
(
	`GTK_BUTTON_BOX
(
bu‰Ú_box
),

380 
GTK_BUTTONBOX_END
);

381 
	`gtk_box_£t_¥acšg
(
	`GTK_BOX
(
bu‰Ú_box
), 6);

382 
	`gtk_cÚš”_£t_bÜd”_width
(
	`GTK_CONTAINER
(
bu‰Ú_box
), 5);

383 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
vbox
), 
bu‰Ú_box
, 
FALSE
, 
TRUE
, 0);

386 
bu‰Ú
 = 
	`gtk_bu‰Ú_Ãw_w™h_Ïb–
("Hangup");

387 
wš
->
bu‰Ús
.
hªgup
 = 
bu‰Ú
;

388 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
bu‰Ú_box
), 
bu‰Ú
, 
FALSE
, 
TRUE
, 0);

389 
	`g_sigÇl_cÚÃù
(
bu‰Ú
, "clicked",

390 
	`G_CALLBACK
(
ÿÎ_Ú_hªgup
), 
wš
);

391 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("call-stop",

392 
GTK_ICON_SIZE_BUTTON
);

393 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

396 
bu‰Ú
 = 
	`gtk_bu‰Ú_Ãw_w™h_Ïb–
("Transfer");

397 
wš
->
bu‰Ús
.
Œªsãr
 = 
bu‰Ú
;

398 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
bu‰Ú_box
), 
bu‰Ú
, 
FALSE
, 
TRUE
, 0);

399 
	`g_sigÇl_cÚÃù
(
bu‰Ú
, "şicked", 
	`G_CALLBACK
(
ÿÎ_Ú_Œªsãr
), 
wš
);

400 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("fÜw¬d", 
GTK_ICON_SIZE_BUTTON
);

401 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

404 
bu‰Ú
 = 
	`gtk_toggË_bu‰Ú_Ãw_w™h_Ïb–
("Hold");

405 
wš
->
bu‰Ús
.
hŞd
 = 
bu‰Ú
;

406 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
bu‰Ú_box
), 
bu‰Ú
, 
FALSE
, 
TRUE
, 0);

407 
	`g_sigÇl_cÚÃù
(
bu‰Ú
, "toggled",

408 
	`G_CALLBACK
(
ÿÎ_Ú_hŞd_toggË
), 
wš
);

409 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("player_pause",

410 
GTK_ICON_SIZE_BUTTON
);

411 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

414 
bu‰Ú
 = 
	`gtk_toggË_bu‰Ú_Ãw_w™h_Ïb–
("Mute");

415 
wš
->
bu‰Ús
.
mu‹
 = 
bu‰Ú
;

416 
	`gtk_box_·ck_’d
(
	`GTK_BOX
(
bu‰Ú_box
), 
bu‰Ú
, 
FALSE
, 
TRUE
, 0);

417 
	`g_sigÇl_cÚÃù
(
bu‰Ú
, "toggled",

418 
	`G_CALLBACK
(
ÿÎ_Ú_mu‹_toggË
), 
wš
);

419 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("microphone-sensitivity-muted",

420 
GTK_ICON_SIZE_BUTTON
);

421 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

423 
	`gtk_widg‘_show_®l
(
wšdow
);

424 
	`gtk_wšdow_´e£Á
(
	`GTK_WINDOW
(
wšdow
));

426 
	`g_sigÇl_cÚÃù
(
wšdow
, "delete_event",

427 
	`G_CALLBACK
(
ÿÎ_Ú_wšdow_şo£
), 
wš
);

428 
	`g_sigÇl_cÚÃù
(
wšdow
, "key-press-event",

429 
	`G_CALLBACK
(
ÿÎ_Ú_key_´ess
), 
wš
);

430 
	`g_sigÇl_cÚÃù
(
wšdow
, "key-release-event",

431 
	`G_CALLBACK
(
ÿÎ_Ú_key_»Ëa£
), 
wš
);

433 
wš
->
ÿÎ
 = 
	`mem_»f
(call);

434 
wš
->
mod
 = mod;

435 
wš
->
wšdow
 = window;

436 
wš
->
Œªsãr_dŸlog
 = 
NULL
;

437 
wš
->
¡©us
 = 
	`GTK_LABEL
(status);

438 
wš
->
du¿tiÚ
 = 
	`GTK_LABEL
(duration);

439 
wš
->
şo£d
 = 
çl£
;

440 
wš
->
du¿tiÚ_tim”_g
 = 0;

441 
wš
->
vum‘”_tim”_g
 = 0;

442 
wš
->
vu
.
’c
 = 
NULL
;

443 
wš
->
vu
.
dec
 = 
NULL
;

445 
	`gÙ_ÿÎ_wšdow
(
wš
);

447 
out
:

448 ià(
”r
)

449 
	`mem_d”ef
(
wš
);

451  
wš
;

452 
	}
}

455 
	$ÿÎ_wšdow_Œªsãr
(
ÿÎ_wšdow
 *
wš
, cÚ¡ *
uri
)

457 
	`mqueue_push
(
wš
->
mq
, 
MQ_TRANSFER
, (*)
uri
);

458 
	}
}

461 
	$ÿÎ_wšdow_şo£d
(
ÿÎ_wšdow
 *
wš
, cÚ¡ *
»asÚ
)

463 
buf
[256];

464 cÚ¡ *
¡©us
;

466 
	`vum‘”_tim”_¡İ
(
wš
);

467 ià(
wš
->
du¿tiÚ_tim”_g
) {

468 
	`g_sourû_»move
(
wš
->
du¿tiÚ_tim”_g
);

469 
wš
->
du¿tiÚ_tim”_g
 = 0;

471 
	`gtk_widg‘_£t_£ns™ive
(
wš
->
bu‰Ús
.
Œªsãr
, 
FALSE
);

472 
	`gtk_widg‘_£t_£ns™ive
(
wš
->
bu‰Ús
.
hŞd
, 
FALSE
);

473 
	`gtk_widg‘_£t_£ns™ive
(
wš
->
bu‰Ús
.
mu‹
, 
FALSE
);

475 ià(
»asÚ
 &&„eason[0]) {

476 
	`»_¢´štf
(
buf
,  buf, "şo£d: %s", 
»asÚ
);

477 
¡©us
 = 
buf
;

480 
¡©us
 = "closed";

482 
	`ÿÎ_wšdow_£t_¡©us
(
wš
, 
¡©us
);

483 
wš
->
Œªsãr_dŸlog
 = 
	`mem_d”ef
(win->transfer_dialog);

484 
wš
->
şo£d
 = 
Œue
;

485 
	}
}

488 
	$ÿÎ_wšdow_ršgšg
(
ÿÎ_wšdow
 *
wš
)

490 
	`ÿÎ_wšdow_£t_¡©us
(
wš
, "ringing");

491 
	}
}

494 
	$ÿÎ_wšdow_´og»ss
(
ÿÎ_wšdow
 *
wš
)

496 
wš
->
du¿tiÚ_tim”_g
 = 
	`g_timeout_add_£cÚds
(1, 
ÿÎ_tim”
, win);

497 
Ï¡_ÿÎ_wš
 = 
wš
;

498 
	`ÿÎ_wšdow_£t_¡©us
(
wš
, "progress");

499 
	}
}

502 
	$ÿÎ_wšdow_e¡ablished
(
ÿÎ_wšdow
 *
wš
)

504 
	`ÿÎ_wšdow_upd©e_du¿tiÚ
(
wš
);

505 
wš
->
du¿tiÚ_tim”_g
 = 
	`g_timeout_add_£cÚds
(1, 
ÿÎ_tim”
, win);

506 
Ï¡_ÿÎ_wš
 = 
wš
;

507 
	`ÿÎ_wšdow_£t_¡©us
(
wš
, "established");

508 
	}
}

511 
	$ÿÎ_wšdow_Œªsãr_çed
(
ÿÎ_wšdow
 *
wš
, cÚ¡ *
»asÚ
)

513 ià(
wš
->
Œªsãr_dŸlog
) {

514 
	`Œªsãr_dŸlog_ç
(
wš
->
Œªsãr_dŸlog
, 
»asÚ
);

516 
	}
}

519 
boŞ
 
	$ÿÎ_wšdow_is_fÜ_ÿÎ
(
ÿÎ_wšdow
 *
wš
, 
ÿÎ
 *call)

521  
wš
->
ÿÎ
 == call;

522 
	}
}

	@baresip/modules/gtk/dial_dialog.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<¡dlib.h
>

10 
	~<±h»ad.h
>

11 
	~<gtk/gtk.h
>

12 
	~"gtk_mod.h
"

14 
	sdŸl_dŸlog
 {

15 
gtk_mod
 *
	mmod
;

16 
GtkWidg‘
 *
	mdŸlog
;

17 
GtkComboBox
 *
	muri_combobox
;

20 
	$dŸl_dŸlog_Ú_»¥Ú£
(
GtkDŸlog
 *
dŸlog
, 
gšt
 
»¥Ú£_id
,

21 
gpoš‹r
 
¬g
)

23 
dŸl_dŸlog
 *
dd
 = 
¬g
;

24 *
uri
;

26 ià(
»¥Ú£_id
 =ğ
GTK_RESPONSE_ACCEPT
) {

27 
uri
 = (*)
	`uri_combo_box_g‘_‹xt
(
dd
->
uri_combobox
);

28 
	`gtk_mod_cÚÃù
(
dd
->
mod
, 
uri
);

31 
	`gtk_widg‘_hide
(
	`GTK_WIDGET
(
dŸlog
));

32 
	}
}

35 
	$de¡ruùÜ
(*
¬g
)

37 
dŸl_dŸlog
 *
dd
 = 
¬g
;

39 
	`gtk_widg‘_de¡roy
(
dd
->
dŸlog
);

40 
	}
}

42 
dŸl_dŸlog
 *
	$dŸl_dŸlog_®loc
(
gtk_mod
 *
mod
)

44 
dŸl_dŸlog
 *
dd
;

45 
GtkWidg‘
 *
dŸl
;

46 
GtkWidg‘
 *
cÚ‹Á
, *
bu‰Ú
, *
image
;

47 
GtkWidg‘
 *
uri_combobox
;

49 
dd
 = 
	`mem_z®loc
((*dd), 
de¡ruùÜ
);

50 ià(!
dd
)

51  
NULL
;

53 
dŸl
 = 
	`gtk_dŸlog_Ãw_w™h_bu‰Ús
("DŸl", 
NULL
, 0, NULL);

56 
bu‰Ú
 = 
	`gtk_bu‰Ú_Ãw_w™h_Ïb–
("Cancel");

57 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("call-stop",

58 
GTK_ICON_SIZE_BUTTON
);

59 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

60 
	`gtk_dŸlog_add_aùiÚ_widg‘
(
	`GTK_DIALOG
(
dŸl
), 
bu‰Ú
,

61 
GTK_RESPONSE_REJECT
);

64 
bu‰Ú
 = 
	`gtk_bu‰Ú_Ãw_w™h_Ïb–
("Call");

65 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("call-start",

66 
GTK_ICON_SIZE_BUTTON
);

67 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

68 
	`gtk_dŸlog_add_aùiÚ_widg‘
(
	`GTK_DIALOG
(
dŸl
), 
bu‰Ú
,

69 
GTK_RESPONSE_ACCEPT
);

70 
	`gtk_widg‘_£t_ÿn_deçuÉ
 (
bu‰Ú
, 
TRUE
);

72 
	`gtk_dŸlog_£t_deçuÉ_»¥Ú£
(
	`GTK_DIALOG
(
dŸl
),

73 
GTK_RESPONSE_ACCEPT
);

74 
uri_combobox
 = 
	`uri_combo_box_Ãw
();

76 
cÚ‹Á
 = 
	`gtk_dŸlog_g‘_cÚ‹Á_¬—
(
	`GTK_DIALOG
(
dŸl
));

77 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
cÚ‹Á
), 
uri_combobox
, 
FALSE
, FALSE, 5);

78 
	`gtk_widg‘_show_®l
(
cÚ‹Á
);

80 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
dŸl
), "response",

81 
	`G_CALLBACK
(
dŸl_dŸlog_Ú_»¥Ú£
), 
dd
);

82 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
dŸl
), "delete-event",

83 
	`G_CALLBACK
(
gtk_widg‘_hide_Ú_d–‘e
), 
dd
);

85 
dd
->
dŸlog
 = 
dŸl
;

86 
dd
->
uri_combobox
 = 
	`GTK_COMBO_BOX
(uri_combobox);

87 
dd
->
mod
 = mod;

89  
dd
;

90 
	}
}

92 
	$dŸl_dŸlog_show
(
dŸl_dŸlog
 *
dd
)

94 
	`gtk_wšdow_´e£Á
(
	`GTK_WINDOW
(
dd
->
dŸlog
));

95 
	`gtk_widg‘_g¿b_focus
(
	`gtk_bš_g‘_chd
(
	`GTK_BIN
(
dd
->
uri_combobox
)));

96 
	}
}

	@baresip/modules/gtk/gtk_mod.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<¡dlib.h
>

10 
	~<±h»ad.h
>

11 
	~<gtk/gtk.h
>

12 
	~<gio/gio.h
>

13 
	~"gtk_mod.h
"

15 #ifdeà
USE_LIBNOTIFY


16 
	~<libnÙify/nÙify.h
>

19 #ià
GLIB_CHECK_VERSION
(2,40,0è|| 
defšed
(
USE_LIBNOTIFY
)

20 
	#USE_NOTIFICATIONS
 1

	)

24 
	#COPYRIGHT
 " Cİyrighˆ(Cè2010 - 2015 Aläed E. Hegge¡adƒˆ®."

	)

25 
	#COMMENTS
 "A moduÏ¸SIP U£r-Ag’ˆw™h‡udiØªd videØsuµÜt"

	)

26 
	#WEBSITE
 "h‰p://www.üeytiv.com/b¬es.html"

	)

27 
	#LICENSE
 "BSD"

	)

38 
	sgtk_mod
 {

39 
±h»ad_t
 
	mth»ad
;

40 
boŞ
 
	mrun
;

41 
boŞ
 
	mcÚùs_š™ed
;

42 
boŞ
 
	maccouÁs_š™ed
;

43 
mes§ge_l¢r
 *
	mmes§ge
;

44 
mqueue
 *
	mmq
;

45 
GAµliÿtiÚ
 *
	m­p
;

46 
GtkStusIcÚ
 *
	m¡©us_icÚ
;

47 
GtkWidg‘
 *
	m­p_m’u
;

48 
GtkWidg‘
 *
	mcÚùs_m’u
;

49 
GtkWidg‘
 *
	maccouÁs_m’u
;

50 
GtkWidg‘
 *
	m¡©us_m’u
;

51 
GSLi¡
 *
	maccouÁs_m’u_group
;

52 
dŸl_dŸlog
 *
	mdŸl_dŸlog
;

53 
GSLi¡
 *
	mÿÎ_wšdows
;

54 
GSLi¡
 *
	mšcomšg_ÿÎ_m’us
;

57 
gtk_mod
 
	gmod_obj
;

59 
	egtk_mod_ev’ts
 {

60 
	mMQ_POPUP
,

61 
	mMQ_CONNECT
,

62 
	mMQ_QUIT
,

63 
	mMQ_ANSWER
,

64 
	mMQ_HANGUP
,

65 
	mMQ_SELECT_UA
,

68 
ªsw”_aùiv©ed
(
GSim¶eAùiÚ
 *, 
GV¬ŸÁ
 *, 
gpoš‹r
);

69 
»jeù_aùiv©ed
(
GSim¶eAùiÚ
 *, 
GV¬ŸÁ
 *, 
gpoš‹r
);

70 
d’Ùify_šcomšg_ÿÎ
(
gtk_mod
 *, 
ÿÎ
 *);

72 
GAùiÚEÁry
 
	g­p_’Œ›s
[] = {

73 {"ªsw”", 
ªsw”_aùiv©ed
, "x", 
NULL
, NULL, {0} },

74 {"»jeù", 
»jeù_aùiv©ed
, "x", 
NULL
, NULL, {0} },

77 
ÿÎ
 *
	$g‘_ÿÎ_äom_gv¬ŸÁ
(
GV¬ŸÁ
 *
·¿m
)

79 
gšt64
 
ÿÎ_±r
;

80 
ÿÎ
 *call;

81 
li¡
 *
ÿÎs
 = 
	`ua_ÿÎs
(
	`uag_cu¼’t
());

82 
Ë
 *le;

84 
ÿÎ_±r
 = 
	`g_v¬ŸÁ_g‘_št64
(
·¿m
);

85 
ÿÎ
 = 
	`GINT_TO_POINTER
(
ÿÎ_±r
);

87 
Ë
 = 
	`li¡_h—d
(
ÿÎs
);†e;†ğË->
Ãxt
)

88 ià(
Ë
->
d©a
 =ğ
ÿÎ
)

89  
ÿÎ
;

91  
NULL
;

92 
	}
}

95 
	$m’u_Ú_about
(
GtkM’uI‹m
 *
m’uI‹m
, 
gpoš‹r
 
¬g
)

97 ()
m’uI‹m
;

98 ()
¬g
;

100 
	`gtk_show_about_dŸlog
(
NULL
,

102 "v”siÚ", 
BARESIP_VERSION
,

104 "cİyright", 
COPYRIGHT
,

105 "comm’ts", 
COMMENTS
,

106 "webs™e", 
WEBSITE
,

107 "liûn£", 
LICENSE
,

108 
NULL
);

109 
	}
}

112 
	$m’u_Ú_qu™
(
GtkM’uI‹m
 *
m’uI‹m
, 
gpoš‹r
 
¬g
)

114 
gtk_mod
 *
mod
 = 
¬g
;

115 ()
m’uI‹m
;

117 
	`gtk_widg‘_de¡roy
(
	`GTK_WIDGET
(
mod
->
­p_m’u
));

118 
	`g_objeù_uÄef
(
	`G_OBJECT
(
mod
->
¡©us_icÚ
));

120 
	`mqueue_push
(
mod
->
mq
, 
MQ_QUIT
, 0);

121 
	`šfo
("quit from gtk\n");

122 
	}
}

125 
	$m’u_Ú_dŸl
(
GtkM’uI‹m
 *
m’uI‹m
, 
gpoš‹r
 
¬g
)

127 
gtk_mod
 *
mod
 = 
¬g
;

128 ()
m’uI‹m
;

129 ià(!
mod
->
dŸl_dŸlog
)

130 
mod
->
dŸl_dŸlog
 = 
	`dŸl_dŸlog_®loc
(mod);

131 
	`dŸl_dŸlog_show
(
mod
->
dŸl_dŸlog
);

132 
	}
}

135 
	$m’u_Ú_dŸl_cÚù
(
GtkM’uI‹m
 *
m’uI‹m
, 
gpoš‹r
 
¬g
)

137 
gtk_mod
 *
mod
 = 
¬g
;

138 cÚ¡ *
uri
 = 
	`gtk_m’u_™em_g‘_Ïb–
(
m’uI‹m
);

140 
	`mqueue_push
(
mod
->
mq
, 
MQ_CONNECT
, (*)
uri
);

141 
	}
}

144 
	$š™_cÚùs_m’u
(
gtk_mod
 *
mod
)

146 
cÚùs
 *cÚù ğ
	`b¬es_cÚùs
();

147 
Ë
 *le;

148 
GtkWidg‘
 *
™em
;

149 
GtkM’uSh–l
 *
cÚùs_m’u
 = 
	`GTK_MENU_SHELL
(
mod
->contacts_menu);

152 
Ë
 = 
	`li¡_h—d
(
	`cÚù_li¡
(
cÚùs
));†e;†ğË->
Ãxt
) {

153 
cÚù
 *
c
 = 
Ë
->
d©a
;

154 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_Ïb–
(
	`cÚù_¡r
(
c
));

155 
	`gtk_m’u_sh–l_­³nd
(
cÚùs_m’u
, 
™em
);

156 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
™em
), "activate",

157 
	`G_CALLBACK
(
m’u_Ú_dŸl_cÚù
), 
mod
);

159 
	}
}

162 
	$m’u_Ú_accouÁ_toggËd
(
GtkCheckM’uI‹m
 *
m’u_™em
,

163 
gtk_mod
 *
mod
)

165 
ua
 *u¨ğ
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
m’u_™em
), "ua");

166 ià(
m’u_™em
->
aùive
)

167 
	`mqueue_push
(
mod
->
mq
, 
MQ_SELECT_UA
, 
ua
);

168 
	}
}

171 
	$m’u_Ú_´e£nû_£t
(
GtkM’uI‹m
 *
™em
, 
gtk_mod
 *
mod
)

173 
Ë
 *le;

174 *
ty³
 = 
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
™em
), "presence");

175 
´e£nû_¡©us
 
¡©us
 = 
	`GPOINTER_TO_UINT
(
ty³
);

176 ()
mod
;

178 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

179 
ua
 *u¨ğ
Ë
->
d©a
;

180 
	`ua_´e£nû_¡©us_£t
(
ua
, 
¡©us
);

182 
	}
}

185 #ifdeà
USE_NOTIFICATIONS


186 
	$m’u_Ú_šcomšg_ÿÎ_ªsw”
(
GtkM’uI‹m
 *
m’uI‹m
,

187 
gtk_mod
 *
mod
)

189 
ÿÎ
 *ÿÎ = 
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
m’uI‹m
), "call");

190 
	`d’Ùify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

191 
	`mqueue_push
(
mod
->
mq
, 
MQ_ANSWER
, 
ÿÎ
);

192 
	}
}

195 
	$m’u_Ú_šcomšg_ÿÎ_»jeù
(
GtkM’uI‹m
 *
m’uI‹m
,

196 
gtk_mod
 *
mod
)

198 
ÿÎ
 *ÿÎ = 
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
m’uI‹m
), "call");

199 
	`d’Ùify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

200 
	`mqueue_push
(
mod
->
mq
, 
MQ_HANGUP
, 
ÿÎ
);

201 
	}
}

205 
GtkM’uI‹m
 *
	$accouÁs_m’u_add_™em
(
gtk_mod
 *
mod
,

206 
ua
 *ua)

208 
GtkM’uSh–l
 *
accouÁs_m’u
 = 
	`GTK_MENU_SHELL
(
mod
->accounts_menu);

209 
GtkWidg‘
 *
™em
;

210 
GSLi¡
 *
group
 = 
mod
->
accouÁs_m’u_group
;

211 
ua
 *
ua_cu¼’t
 = 
	`uag_cu¼’t
();

212 
buf
[256];

214 
	`»_¢´štf
(
buf
,  buf, "%s%s", 
	`ua_aÜ
(
ua
),

215 
	`ua_i¤egi¡”ed
(
ua
) ? " (OK)" : "");

216 
™em
 = 
	`gtk_¿dio_m’u_™em_Ãw_w™h_Ïb–
(
group
, 
buf
);

217 
group
 = 
	`gtk_¿dio_m’u_™em_g‘_group
(

218 
	`GTK_RADIO_MENU_ITEM
 (
™em
));

219 ià(
ua
 =ğ
ua_cu¼’t
)

220 
	`gtk_check_m’u_™em_£t_aùive
(
	`GTK_CHECK_MENU_ITEM
(
™em
),

221 
TRUE
);

222 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
™em
), "ua", 
ua
);

223 
	`g_sigÇl_cÚÃù
(
™em
, "toggled",

224 
	`G_CALLBACK
(
m’u_Ú_accouÁ_toggËd
), 
mod
);

225 
	`gtk_m’u_sh–l_­³nd
(
accouÁs_m’u
, 
™em
);

226 
mod
->
accouÁs_m’u_group
 = 
group
;

228  
	`GTK_MENU_ITEM
(
™em
);

229 
	}
}

232 
GtkM’uI‹m
 *
	$accouÁs_m’u_g‘_™em
(
gtk_mod
 *
mod
,

233 
ua
 *ua)

235 
GtkM’uI‹m
 *
™em
;

236 
GtkM’uSh–l
 *
accouÁs_m’u
 = 
	`GTK_MENU_SHELL
(
mod
->accounts_menu);

237 
GLi¡
 *
™ems
 = 
accouÁs_m’u
->
chd»n
;

239 ; 
™ems
; i‹m ğ™ems->
Ãxt
) {

240 
™em
 = 
™ems
->
d©a
;

241 ià(
ua
 =ğ
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
™em
), "ua"))

242  
™em
;

246  
	`accouÁs_m’u_add_™em
(
mod
, 
ua
);

247 
	}
}

250 
	$upd©e_cu¼’t_accouÁs_m’u_™em
(
gtk_mod
 *
mod
)

252 
GtkM’uI‹m
 *
™em
 = 
	`accouÁs_m’u_g‘_™em
(
mod
,

253 
	`uag_cu¼’t
());

254 
	`gtk_check_m’u_™em_£t_aùive
(
	`GTK_CHECK_MENU_ITEM
(
™em
), 
TRUE
);

255 
	}
}

258 
	$upd©e_ua_´e£nû
(
gtk_mod
 *
mod
)

260 
GtkCheckM’uI‹m
 *
™em
 = 0;

261 
´e£nû_¡©us
 
cur_¡©us
;

262 *
¡©us
;

263 
GtkM’uSh–l
 *
¡©us_m’u
 = 
	`GTK_MENU_SHELL
(
mod
->status_menu);

264 
GLi¡
 *
™ems
 = 
¡©us_m’u
->
chd»n
;

266 
cur_¡©us
 = 
	`ua_´e£nû_¡©us
(
	`uag_cu¼’t
());

268 ; 
™ems
; i‹m ğ™ems->
Ãxt
) {

269 
™em
 = 
™ems
->
d©a
;

270 
¡©us
 = 
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
™em
), "presence");

271 ià(
cur_¡©us
 =ğ
	`GPOINTER_TO_UINT
(
¡©us
))

274 ià(!
™em
)

277 
	`gtk_check_m’u_™em_£t_aùive
(
™em
, 
TRUE
);

278 
	}
}

281 cÚ¡ *
	$ua_ev’t_»g_¡r
(
ua_ev’t
 
ev
)

283 
ev
) {

285 
UA_EVENT_REGISTERING
:  "registering";

286 
UA_EVENT_REGISTER_OK
:  "OK";

287 
UA_EVENT_REGISTER_FAIL
:  "ERR";

288 
UA_EVENT_UNREGISTERING
:  "unregistering";

291 
	}
}

294 
	$accouÁs_m’u_£t_¡©us
(
gtk_mod
 *
mod
,

295 
ua
 *ua, 
ua_ev’t
 
ev
)

297 
GtkM’uI‹m
 *
™em
 = 
	`accouÁs_m’u_g‘_™em
(
mod
, 
ua
);

298 
buf
[256];

299 
	`»_¢´štf
(
buf
,  buf, "% (%s)", 
	`ua_aÜ
(
ua
),

300 
	`ua_ev’t_»g_¡r
(
ev
));

301 
	`gtk_m’u_™em_£t_Ïb–
(
™em
, 
buf
);

302 
	}
}

305 #ifdeà
USE_NOTIFICATIONS


306 
	$nÙify_šcomšg_ÿÎ
(
gtk_mod
 *
mod
,

307 
ÿÎ
 *call)

309 cÚ¡ *
t™Ë
 = "Incoming call";

310 cÚ¡ *
msg
 = 
	`ÿÎ_³”uri
(
ÿÎ
);

311 
GtkWidg‘
 *
ÿÎ_m’u
;

312 
GtkWidg‘
 *
m’u_™em
;

313 #ià
	`defšed
(
USE_LIBNOTIFY
)

314 
NÙifyNÙifiÿtiÚ
 *
nÙifiÿtiÚ
;

316 ià(!
	`nÙify_is_š™‹d
())

318 
nÙifiÿtiÚ
 = 
	`nÙify_nÙifiÿtiÚ_Ãw
(
t™Ë
, 
msg
, "baresip");

319 
	`nÙify_nÙifiÿtiÚ_£t_urg’cy
(
nÙifiÿtiÚ
, 
NOTIFY_URGENCY_CRITICAL
);

320 
	`nÙify_nÙifiÿtiÚ_show
(
nÙifiÿtiÚ
, 
NULL
);

321 
	`g_objeù_uÄef
(
nÙifiÿtiÚ
);

323 #–ià
	`GLIB_CHECK_VERSION
(2,40,0)

324 
id
[64];

325 
GV¬ŸÁ
 *
rg‘
;

326 
GNÙifiÿtiÚ
 *
nÙifiÿtiÚ
 = 
	`g_nÙifiÿtiÚ_Ãw
(
t™Ë
);

328 
	`»_¢´štf
(
id
,  id, "šcomšg-ÿÎ-%p", 
ÿÎ
);

329 
id
[ id - 1] = '\0';

331 #ià
	`GLIB_CHECK_VERSION
(2,42,0)

332 
	`g_nÙifiÿtiÚ_£t_´iÜ™y
(
nÙifiÿtiÚ
,

333 
G_NOTIFICATION_PRIORITY_URGENT
);

335 
	`g_nÙifiÿtiÚ_£t_urg’t
(
nÙifiÿtiÚ
, 
TRUE
);

338 
rg‘
 = 
	`g_v¬ŸÁ_Ãw_št64
(
	`GPOINTER_TO_INT
(
ÿÎ
));

339 
	`g_nÙifiÿtiÚ_£t_body
(
nÙifiÿtiÚ
, 
msg
);

340 
	`g_nÙifiÿtiÚ_add_bu‰Ú_w™h_rg‘_v®ue
(
nÙifiÿtiÚ
,

341 "Answ”", "­p.ªsw”", 
rg‘
);

342 
	`g_nÙifiÿtiÚ_add_bu‰Ú_w™h_rg‘_v®ue
(
nÙifiÿtiÚ
,

343 "Rejeù", "­p.»jeù", 
rg‘
);

344 
	`g_­¶iÿtiÚ_£nd_nÙifiÿtiÚ
(
mod
->
­p
, 
id
, 
nÙifiÿtiÚ
);

345 
	`g_objeù_uÄef
(
nÙifiÿtiÚ
);

348 ()
msg
;

349 ()
t™Ë
;

353 
ÿÎ_m’u
 = 
	`gtk_m’u_Ãw
();

354 
m’u_™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Incoming call");

355 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
m’u_™em
), "ÿÎ", 
ÿÎ
);

356 
	`gtk_m’u_™em_£t_subm’u
(
	`GTK_MENU_ITEM
(
m’u_™em
),

357 
ÿÎ_m’u
);

358 
	`gtk_m’u_sh–l_´•’d
(
	`GTK_MENU_SHELL
(
mod
->
­p_m’u
), 
m’u_™em
);

359 
mod
->
šcomšg_ÿÎ_m’us
 = 
	`g_¦i¡_­³nd
(mod->incoming_call_menus,

360 
m’u_™em
);

362 
m’u_™em
 = 
	`gtk_m’u_™em_Ãw_w™h_Ïb–
(
	`ÿÎ_³”uri
(
ÿÎ
));

363 
	`gtk_widg‘_£t_£ns™ive
(
m’u_™em
, 
FALSE
);

364 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
ÿÎ_m’u
), 
m’u_™em
);

366 
m’u_™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Accept");

367 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
m’u_™em
), "ÿÎ", 
ÿÎ
);

368 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
m’u_™em
), "activate",

369 
	`G_CALLBACK
(
m’u_Ú_šcomšg_ÿÎ_ªsw”
), 
mod
);

370 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
ÿÎ_m’u
), 
m’u_™em
);

372 
m’u_™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Reject");

373 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
m’u_™em
), "ÿÎ", 
ÿÎ
);

374 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
m’u_™em
), "activate",

375 
	`G_CALLBACK
(
m’u_Ú_šcomšg_ÿÎ_»jeù
), 
mod
);

376 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
ÿÎ_m’u
), 
m’u_™em
);

377 
	}
}

381 
	$d’Ùify_šcomšg_ÿÎ
(
gtk_mod
 *
mod
, 
ÿÎ
 *call)

383 
GSLi¡
 *
™em
, *
Ãxt
;

385 #ià
	`GLIB_CHECK_VERSION
(2,40,0)

386 
id
[64];

388 
	`»_¢´štf
(
id
,  id, "šcomšg-ÿÎ-%p", 
ÿÎ
);

389 
id
[ id - 1] = '\0';

390 
	`g_­¶iÿtiÚ_w™hd¿w_nÙifiÿtiÚ
(
mod
->
­p
, 
id
);

394 
™em
 = 
mod
->
šcomšg_ÿÎ_m’us
; i‹m; i‹m = 
Ãxt
) {

395 
GtkWidg‘
 *
m’u_™em
 = 
™em
->
d©a
;

396 
Ãxt
 = 
™em
->next;

398 ià(
ÿÎ
 =ğ
	`g_objeù_g‘_d©a
(
	`G_OBJECT
(
m’u_™em
), "call")) {

399 
	`gtk_widg‘_de¡roy
(
m’u_™em
);

400 
mod
->
šcomšg_ÿÎ_m’us
 =

401 
	`g_¦i¡_d–‘e_lšk
(
mod
->
šcomšg_ÿÎ_m’us
,

402 
™em
);

405 
	}
}

408 
	$ªsw”_aùiv©ed
(
GSim¶eAùiÚ
 *
aùiÚ
, 
GV¬ŸÁ
 *
·¿m‘”
,

409 
gpoš‹r
 
¬g
)

411 
gtk_mod
 *
mod
 = 
¬g
;

412 
ÿÎ
 *ÿÎ = 
	`g‘_ÿÎ_äom_gv¬ŸÁ
(
·¿m‘”
);

413 ()
aùiÚ
;

415 ià(
ÿÎ
) {

416 
	`d’Ùify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

417 
	`mqueue_push
(
mod
->
mq
, 
MQ_ANSWER
, 
ÿÎ
);

419 
	}
}

422 
	$»jeù_aùiv©ed
(
GSim¶eAùiÚ
 *
aùiÚ
, 
GV¬ŸÁ
 *
·¿m‘”
,

423 
gpoš‹r
 
¬g
)

425 
gtk_mod
 *
mod
 = 
¬g
;

426 
ÿÎ
 *ÿÎ = 
	`g‘_ÿÎ_äom_gv¬ŸÁ
(
·¿m‘”
);

427 ()
aùiÚ
;

429 ià(
ÿÎ
) {

430 
	`d’Ùify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

431 
	`mqueue_push
(
mod
->
mq
, 
MQ_HANGUP
, 
ÿÎ
);

433 
	}
}

436 
ÿÎ_wšdow
 *
	$Ãw_ÿÎ_wšdow
(
gtk_mod
 *
mod
,

437 
ÿÎ
 *call)

439 
ÿÎ_wšdow
 *
wš
 = 
	`ÿÎ_wšdow_Ãw
(
ÿÎ
, 
mod
);

440 ià(
ÿÎ
) {

441 
mod
->
ÿÎ_wšdows
 = 
	`g_¦i¡_­³nd
(mod->ÿÎ_wšdows, 
wš
);

443  
wš
;

444 
	}
}

447 
ÿÎ_wšdow
 *
	$g‘_ÿÎ_wšdow
(
gtk_mod
 *
mod
,

448 
ÿÎ
 *call)

450 
GSLi¡
 *
wšs
;

452 
wšs
 = 
mod
->
ÿÎ_wšdows
; wšs; wš ğwšs->
Ãxt
) {

453 
ÿÎ_wšdow
 *
wš
 = 
wšs
->
d©a
;

454 ià(
	`ÿÎ_wšdow_is_fÜ_ÿÎ
(
wš
, 
ÿÎ
))

455  
wš
;

457  
NULL
;

458 
	}
}

461 
ÿÎ_wšdow
 *
	$g‘_ü—‹_ÿÎ_wšdow
(
gtk_mod
 *
mod
,

462 
ÿÎ
 *call)

464 
ÿÎ_wšdow
 *
wš
 = 
	`g‘_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

465 ià(!
wš
)

466 
wš
 = 
	`Ãw_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

467  
wš
;

468 
	}
}

471 
	$gtk_mod_ÿÎ_wšdow_şo£d
(
gtk_mod
 *
mod
, 
ÿÎ_wšdow
 *
wš
)

473 ià(!
mod
)

475 
mod
->
ÿÎ_wšdows
 = 
	`g_¦i¡_»move
(mod->ÿÎ_wšdows, 
wš
);

476 
	}
}

479 
	$ua_ev’t_hªdËr
(
ua
 *ua,

480 
ua_ev’t
 
ev
,

481 
ÿÎ
 *call,

482 cÚ¡ *
´m
,

483 *
¬g
 )

485 
gtk_mod
 *
mod
 = 
¬g
;

486 
ÿÎ_wšdow
 *
wš
;

488 
	`gdk_th»ads_’‹r
();

490 
ev
) {

492 
UA_EVENT_REGISTERING
:

493 
UA_EVENT_UNREGISTERING
:

494 
UA_EVENT_REGISTER_OK
:

495 
UA_EVENT_REGISTER_FAIL
:

496 
	`accouÁs_m’u_£t_¡©us
(
mod
, 
ua
, 
ev
);

499 #ifdeà
USE_NOTIFICATIONS


500 
UA_EVENT_CALL_INCOMING
:

501 
	`nÙify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

505 
UA_EVENT_CALL_CLOSED
:

506 
wš
 = 
	`g‘_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

507 ià(
wš
)

508 
	`ÿÎ_wšdow_şo£d
(
wš
, 
´m
);

510 
	`d’Ùify_šcomšg_ÿÎ
(
mod
, 
ÿÎ
);

513 
UA_EVENT_CALL_RINGING
:

514 
wš
 = 
	`g‘_ü—‹_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

515 ià(
wš
)

516 
	`ÿÎ_wšdow_ršgšg
(
wš
);

519 
UA_EVENT_CALL_PROGRESS
:

520 
wš
 = 
	`g‘_ü—‹_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

521 ià(
wš
)

522 
	`ÿÎ_wšdow_´og»ss
(
wš
);

525 
UA_EVENT_CALL_ESTABLISHED
:

526 
wš
 = 
	`g‘_ü—‹_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

527 ià(
wš
)

528 
	`ÿÎ_wšdow_e¡ablished
(
wš
);

531 
UA_EVENT_CALL_TRANSFER_FAILED
:

532 
wš
 = 
	`g‘_ü—‹_ÿÎ_wšdow
(
mod
, 
ÿÎ
);

533 ià(
wš
)

534 
	`ÿÎ_wšdow_Œªsãr_çed
(
wš
, 
´m
);

541 
	`gdk_th»ads_Ëave
();

542 
	}
}

545 #ifdeà
USE_NOTIFICATIONS


546 
	$mes§ge_hªdËr
(cÚ¡ 
¶
 *
³”
, cÚ¡ ¶ *
ùy³
,

547 
mbuf
 *
body
, *
¬g
)

549 
gtk_mod
 *
mod
 = 
¬g
;

550 
t™Ë
[128];

551 
msg
[512];

553 #ià
	`GLIB_CHECK_VERSION
(2,40,0)

554 
GNÙifiÿtiÚ
 *
nÙifiÿtiÚ
;

555 #–ià
	`defšed
(
USE_LIBNOTIFY
)

556 
NÙifyNÙifiÿtiÚ
 *
nÙifiÿtiÚ
;

559 ()
ùy³
;

564 
	`»_¢´štf
(
t™Ë
, ™Ë, "Ch© from %r", 
³”
);

565 
t™Ë
[itle - 1] = '\0';

567 
	`»_¢´štf
(
msg
,  msg, "%b",

568 
	`mbuf_buf
(
body
), 
	`mbuf_g‘_Ëá
(body));

570 #ià
	`GLIB_CHECK_VERSION
(2,40,0)

571 
nÙifiÿtiÚ
 = 
	`g_nÙifiÿtiÚ_Ãw
(
t™Ë
);

572 
	`g_nÙifiÿtiÚ_£t_body
(
nÙifiÿtiÚ
, 
msg
);

573 
	`g_­¶iÿtiÚ_£nd_nÙifiÿtiÚ
(
mod
->
­p
, 
NULL
, 
nÙifiÿtiÚ
);

574 
	`g_objeù_uÄef
(
nÙifiÿtiÚ
);

576 #–ià
	`defšed
(
USE_LIBNOTIFY
)

577 ()
mod
;

579 ià(!
	`nÙify_is_š™‹d
())

581 
nÙifiÿtiÚ
 = 
	`nÙify_nÙifiÿtiÚ_Ãw
(
t™Ë
, 
msg
, "baresip");

582 
	`nÙify_nÙifiÿtiÚ_show
(
nÙifiÿtiÚ
, 
NULL
);

583 
	`g_objeù_uÄef
(
nÙifiÿtiÚ
);

585 
	}
}

589 
	$pİup_m’u
(
gtk_mod
 *
mod
, 
GtkM’uPos™iÚFunc
 
pos™iÚ
,

590 
gpoš‹r
 
pos™iÚ_¬g
, 
gušt
 
bu‰Ú
, 
gušt32
 
aùiv©e_time
)

592 ià(!
mod
->
cÚùs_š™ed
) {

593 
	`š™_cÚùs_m’u
(
mod
);

594 
mod
->
cÚùs_š™ed
 = 
TRUE
;

598 
	`upd©e_cu¼’t_accouÁs_m’u_™em
(
mod
);

599 
	`upd©e_ua_´e£nû
(
mod
);

601 
	`gtk_widg‘_show_®l
(
mod
->
­p_m’u
);

603 
	`gtk_m’u_pİup
(
	`GTK_MENU
(
mod
->
­p_m’u
), 
NULL
, NULL,

604 
pos™iÚ
, 
pos™iÚ_¬g
,

605 
bu‰Ú
, 
aùiv©e_time
);

606 
	}
}

609 
gboŞ—n
 
	$¡©us_icÚ_Ú_bu‰Ú_´ess
(
GtkStusIcÚ
 *
¡©us_icÚ
,

610 
GdkEv’tBu‰Ú
 *
ev’t
,

611 
gtk_mod
 *
mod
)

613 
	`pİup_m’u
(
mod
, 
gtk_¡©us_icÚ_pos™iÚ_m’u
, 
¡©us_icÚ
,

614 
ev’t
->
bu‰Ú
,ƒv’t->
time
);

615  
TRUE
;

616 
	}
}

619 
	$gtk_mod_cÚÃù
(
gtk_mod
 *
mod
, cÚ¡ *
uri
)

621 ià(!
mod
)

623 
	`mqueue_push
(
mod
->
mq
, 
MQ_CONNECT
, (*)
uri
);

624 
	}
}

627 
	$w¬nšg_dŸlog
(cÚ¡ *
t™Ë
, cÚ¡ *
fmt
, ...)

629 
va_li¡
 
­
;

630 
msg
[512];

631 
GtkWidg‘
 *
dŸlog
;

633 
	`va_¡¬t
(
­
, 
fmt
);

634 ()
	`»_v¢´štf
(
msg
,  msg, 
fmt
, 
­
);

635 
	`va_’d
(
­
);

637 
dŸlog
 = 
	`gtk_mes§ge_dŸlog_Ãw
(
NULL
, 0, 
GTK_MESSAGE_ERROR
,

638 
GTK_BUTTONS_CLOSE
, "%s", 
t™Ë
);

639 
	`gtk_mes§ge_dŸlog_fÜm©_£cÚd¬y_‹xt
(
	`GTK_MESSAGE_DIALOG
(
dŸlog
),

640 "%s", 
msg
);

641 
	`g_sigÇl_cÚÃù_sw­³d
(
	`G_OBJECT
(
dŸlog
), "response",

642 
	`G_CALLBACK
(
gtk_widg‘_de¡roy
), 
dŸlog
);

643 
	`gtk_wšdow_£t_t™Ë
(
	`GTK_WINDOW
(
dŸlog
), 
t™Ë
);

644 
	`gtk_widg‘_show
(
dŸlog
);

645 
	}
}

648 
	$mqueue_hªdËr
(
id
, *
d©a
, *
¬g
)

650 
gtk_mod
 *
mod
 = 
¬g
;

651 cÚ¡ *
uri
;

652 
ÿÎ
 *call;

653 
”r
;

654 
ua
 *u¨ğ
	`uag_cu¼’t
();

655 ()
mod
;

657 (
gtk_mod_ev’ts
)
id
) {

659 
MQ_POPUP
:

660 
	`gdk_th»ads_’‹r
();

661 
	`pİup_m’u
(
mod
, 
NULL
, NULL, 0, 
	`GPOINTER_TO_UINT
(
d©a
));

662 
	`gdk_th»ads_Ëave
();

665 
MQ_CONNECT
:

666 
uri
 = 
d©a
;

667 
”r
 = 
	`ua_cÚÃù
(
ua
, &
ÿÎ
, 
NULL
, 
uri
, NULL, 
VIDMODE_ON
);

668 ià(
”r
) {

669 
	`gdk_th»ads_’‹r
();

670 
	`w¬nšg_dŸlog
("Call failed",

672 "E¼Ü: %m", 
uri
, 
”r
);

673 
	`gdk_th»ads_Ëave
();

676 
	`gdk_th»ads_’‹r
();

677 
”r
 = 
	`Ãw_ÿÎ_wšdow
(
mod
, 
ÿÎ
è=ğ
NULL
;

678 
	`gdk_th»ads_Ëave
();

679 ià(
”r
) {

680 
	`ua_hªgup
(
ua
, 
ÿÎ
, 500, "Server Error");

684 
MQ_HANGUP
:

685 
ÿÎ
 = 
d©a
;

686 
	`ua_hªgup
(
ua
, 
ÿÎ
, 0, 
NULL
);

689 
MQ_QUIT
:

690 
	`ua_¡İ_®l
(
çl£
);

693 
MQ_ANSWER
:

694 
ÿÎ
 = 
d©a
;

695 
”r
 = 
	`ua_ªsw”
(
ua
, 
ÿÎ
);

696 ià(
”r
) {

697 
	`gdk_th»ads_’‹r
();

698 
	`w¬nšg_dŸlog
("Call failed",

702 
	`ÿÎ_³”Çme
(
ÿÎ
), 
”r
);

703 
	`gdk_th»ads_Ëave
();

707 
	`gdk_th»ads_’‹r
();

708 
”r
 = 
	`Ãw_ÿÎ_wšdow
(
mod
, 
ÿÎ
è=ğ
NULL
;

709 
	`gdk_th»ads_Ëave
();

710 ià(
”r
) {

711 
	`ua_hªgup
(
ua
, 
ÿÎ
, 500, "Server Error");

715 
MQ_SELECT_UA
:

716 
ua
 = 
d©a
;

717 
	`uag_cu¼’t_£t
(
ua
);

720 
	}
}

723 *
	$gtk_th»ad
(*
¬g
)

725 
gtk_mod
 *
mod
 = 
¬g
;

726 
GtkM’uSh–l
 *
­p_m’u
;

727 
GtkWidg‘
 *
™em
;

728 
GE¼Ü
 *
”r
 = 
NULL
;

729 
Ë
 *le;

731 
	`gdk_th»ads_š™
();

732 
	`gtk_š™
(0, 
NULL
);

734 
	`g_£t_­¶iÿtiÚ_Çme
("baresip");

735 
mod
->
­p
 = 
	`g_­¶iÿtiÚ_Ãw
 ("com.creytiv.baresip",

736 
G_APPLICATION_FLAGS_NONE
);

738 
	`g_­¶iÿtiÚ_»gi¡”
 (
	`G_APPLICATION
 (
mod
->
­p
), 
NULL
, &
”r
);

739 ià(
”r
 !ğ
NULL
) {

740 
	`w¬nšg
 ("Unableo„egister GApplication: %s",

741 
”r
->
mes§ge
);

742 
	`g_”rÜ_ä“
 (
”r
);

743 
”r
 = 
NULL
;

746 #ifdeà
USE_LIBNOTIFY


747 
	`nÙify_š™
("baresip");

750 
mod
->
¡©us_icÚ
 = 
	`gtk_¡©us_icÚ_Ãw_äom_icÚ_Çme
("call-start");

751 
	`gtk_¡©us_icÚ_£t_toŞt_‹xt
 (
mod
->
¡©us_icÚ
, "baresip");

753 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
mod
->
¡©us_icÚ
),

755 
	`G_CALLBACK
(
¡©us_icÚ_Ú_bu‰Ú_´ess
), 
mod
);

756 
	`gtk_¡©us_icÚ_£t_visibË
(
mod
->
¡©us_icÚ
, 
TRUE
);

758 
mod
->
cÚùs_š™ed
 = 
çl£
;

759 
mod
->
dŸl_dŸlog
 = 
NULL
;

760 
mod
->
ÿÎ_wšdows
 = 
NULL
;

761 
mod
->
šcomšg_ÿÎ_m’us
 = 
NULL
;

764 
mod
->
­p_m’u
 = 
	`gtk_m’u_Ãw
();

765 
­p_m’u
 = 
	`GTK_MENU_SHELL
(
mod
->app_menu);

768 
mod
->
accouÁs_m’u
 = 
	`gtk_m’u_Ãw
();

769 
mod
->
accouÁs_m’u_group
 = 
NULL
;

770 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Account");

771 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
™em
);

772 
	`gtk_m’u_™em_£t_subm’u
(
	`GTK_MENU_ITEM
(
™em
),

773 
mod
->
accouÁs_m’u
);

776 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

777 
ua
 *u¨ğ
Ë
->
d©a
;

778 
	`accouÁs_m’u_add_™em
(
mod
, 
ua
);

782 
mod
->
¡©us_m’u
 = 
	`gtk_m’u_Ãw
();

783 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Status");

784 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
­p_m’u
), 
™em
);

785 
	`gtk_m’u_™em_£t_subm’u
(
	`GTK_MENU_ITEM
(
™em
), 
mod
->
¡©us_m’u
);

788 
™em
 = 
	`gtk_¿dio_m’u_™em_Ãw_w™h_Ïb–
(
NULL
, "Open");

789 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
™em
), "presence",

790 
	`GINT_TO_POINTER
(
PRESENCE_OPEN
));

791 
	`g_sigÇl_cÚÃù
(
™em
, "activate",

792 
	`G_CALLBACK
(
m’u_Ú_´e£nû_£t
), 
mod
);

793 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
mod
->
¡©us_m’u
), 
™em
);

794 
	`gtk_check_m’u_™em_£t_aùive
(
	`GTK_CHECK_MENU_ITEM
(
™em
), 
TRUE
);

797 
™em
 = 
	`gtk_¿dio_m’u_™em_Ãw_w™h_Ïb–_äom_widg‘
(

798 
	`GTK_RADIO_MENU_ITEM
(
™em
), "Closed");

799 
	`g_objeù_£t_d©a
(
	`G_OBJECT
(
™em
), "presence",

800 
	`GINT_TO_POINTER
(
PRESENCE_CLOSED
));

801 
	`g_sigÇl_cÚÃù
(
™em
, "activate",

802 
	`G_CALLBACK
(
m’u_Ú_´e£nû_£t
), 
mod
);

803 
	`gtk_m’u_sh–l_­³nd
(
	`GTK_MENU_SHELL
(
mod
->
¡©us_m’u
), 
™em
);

805 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
	`gtk_£·¿tÜ_m’u_™em_Ãw
());

808 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Dial...");

809 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
™em
);

810 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
™em
), "activate",

811 
	`G_CALLBACK
(
m’u_Ú_dŸl
), 
mod
);

814 
mod
->
cÚùs_m’u
 = 
	`gtk_m’u_Ãw
();

815 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("Dial _contact");

816 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
™em
);

817 
	`gtk_m’u_™em_£t_subm’u
(
	`GTK_MENU_ITEM
(
™em
),

818 
mod
->
cÚùs_m’u
);

820 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
	`gtk_£·¿tÜ_m’u_™em_Ãw
());

823 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("A_bout");

824 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
™em
), "activate",

825 
	`G_CALLBACK
(
m’u_Ú_about
), 
mod
);

826 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
™em
);

828 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
	`gtk_£·¿tÜ_m’u_™em_Ãw
());

831 
™em
 = 
	`gtk_m’u_™em_Ãw_w™h_mÃmÚic
("_Quit");

832 
	`g_sigÇl_cÚÃù
(
	`G_OBJECT
(
™em
), "activate",

833 
	`G_CALLBACK
(
m’u_Ú_qu™
), 
mod
);

834 
	`gtk_m’u_sh–l_­³nd
(
­p_m’u
, 
™em
);

836 
	`g_aùiÚ_m­_add_aùiÚ_’Œ›s
(
	`G_ACTION_MAP
(
mod
->
­p
),

837 
­p_’Œ›s
, 
	`G_N_ELEMENTS
×µ_’Œ›s), 
mod
);

839 
	`šfo
("gtk_menu starting\n");

841 
	`uag_ev’t_»gi¡”
Ğ
ua_ev’t_hªdËr
, 
mod
 );

842 
mod
->
run
 = 
Œue
;

843 
	`gtk_maš
();

844 
mod
->
run
 = 
çl£
;

845 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

847 ià(
mod
->
dŸl_dŸlog
) {

848 
	`mem_d”ef
(
mod
->
dŸl_dŸlog
);

849 
mod
->
dŸl_dŸlog
 = 
NULL
;

852  
NULL
;

853 
	}
}

856 
	$vu_’c_de¡ruùÜ
(*
¬g
)

858 
vum‘”_’c
 *
¡
 = 
¬g
;

860 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

861 
	}
}

864 
	$vu_dec_de¡ruùÜ
(*
¬g
)

866 
vum‘”_dec
 *
¡
 = 
¬g
;

868 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

869 
	}
}

872 
št16_t
 
	$ÿlc_avg_s16
(cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

874 
št32_t
 
v
 = 0;

875 
size_t
 
i
;

877 ià(!
§mpv
 || !
§mpc
)

880 
i
=0; i<
§mpc
; i++)

881 
v
 +ğ
	`abs
(
§mpv
[
i
]);

883  
v
/
§mpc
;

884 
	}
}

887 
	$vu_’code_upd©e
(
auft_’c_¡
 **
¡p
, **
ùx
,

888 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

890 
vum‘”_’c
 *
¡
;

891 ()
ùx
;

892 ()
´m
;

894 ià(!
¡p
 || !
af
)

895  
EINVAL
;

897 ià(*
¡p
)

900 
¡
 = 
	`mem_z®loc
((*¡), 
vu_’c_de¡ruùÜ
);

901 ià(!
¡
)

902  
ENOMEM
;

904 
	`gdk_th»ads_’‹r
();

905 
	`ÿÎ_wšdow_gÙ_vu_’c
(
¡
);

906 
	`gdk_th»ads_Ëave
();

908 *
¡p
 = (
auft_’c_¡
 *)
¡
;

911 
	}
}

914 
	$vu_decode_upd©e
(
auft_dec_¡
 **
¡p
, **
ùx
,

915 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

917 
vum‘”_dec
 *
¡
;

918 ()
ùx
;

919 ()
´m
;

921 ià(!
¡p
 || !
af
)

922  
EINVAL
;

924 ià(*
¡p
)

927 
¡
 = 
	`mem_z®loc
((*¡), 
vu_dec_de¡ruùÜ
);

928 ià(!
¡
)

929  
ENOMEM
;

931 
	`gdk_th»ads_’‹r
();

932 
	`ÿÎ_wšdow_gÙ_vu_dec
(
¡
);

933 
	`gdk_th»ads_Ëave
();

935 *
¡p
 = (
auft_dec_¡
 *)
¡
;

938 
	}
}

941 
	$vu_’code
(
auft_’c_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

943 
vum‘”_’c
 *
vu
 = (vum‘”_’ø*)
¡
;

945 
vu
->
avg_»c
 = 
	`ÿlc_avg_s16
(
§mpv
, *
§mpc
);

946 
vu
->
¡¬‹d
 = 
Œue
;

949 
	}
}

952 
	$vu_decode
(
auft_dec_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

954 
vum‘”_dec
 *
vu
 = (vum‘”_deø*)
¡
;

956 
vu
->
avg_¶ay
 = 
	`ÿlc_avg_s16
(
§mpv
, *
§mpc
);

957 
vu
->
¡¬‹d
 = 
Œue
;

960 
	}
}

963 
auft
 
	gvum‘”
 = {

964 
LE_INIT
, "gtk_vumeter",

965 
vu_’code_upd©e
, 
vu_’code
,

966 
vu_decode_upd©e
, 
vu_decode


970 
	$cmd_pİup_m’u
(
»_´štf
 *
pf
, *
unu£d
)

972 ()
pf
;

973 ()
unu£d
;

975 
	`mqueue_push
(
mod_obj
.
mq
, 
MQ_POPUP
, 
	`GUINT_TO_POINTER
(
GDK_CURRENT_TIME
));

978 
	}
}

981 cÚ¡ 
cmd
 
	gcmdv
[] = {

982 {"gtk", 'G', 0, "Pİ u°GTK+ m’u", 
cmd_pİup_m’u
 },

986 
	$moduË_š™
()

988 
”r
 = 0;

990 
”r
 = 
	`mqueue_®loc
(&
mod_obj
.
mq
, 
mqueue_hªdËr
, &mod_obj);

991 ià(
”r
)

992  
”r
;

994 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
vum‘”
);

996 #ifdeà
USE_NOTIFICATIONS


997 
”r
 = 
	`mes§ge_li¡’
(&
mod_obj
.
mes§ge
, 
	`b¬es_mes§ge
(),

998 
mes§ge_hªdËr
, &
mod_obj
);

999 ià(
”r
) {

1000 
	`w¬nšg
("gtk: mes§ge_š™ faed (%m)\n", 
”r
);

1001  
”r
;

1005 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

1006 ià(
”r
)

1007  
”r
;

1010 
”r
 = 
	`±h»ad_ü—‹
(&
mod_obj
.
th»ad
, 
NULL
, 
gtk_th»ad
,

1011 &
mod_obj
);

1012 ià(
”r
)

1013  
”r
;

1015  
”r
;

1016 
	}
}

1019 
	$moduË_şo£
()

1021 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

1022 ià(
mod_obj
.
run
) {

1023 
	`gdk_th»ads_’‹r
();

1024 
	`gtk_maš_qu™
();

1025 
	`gdk_th»ads_Ëave
();

1027 ià(
mod_obj
.
th»ad
)

1028 
	`±h»ad_još
(
mod_obj
.
th»ad
, 
NULL
);

1029 
mod_obj
.
mq
 = 
	`mem_d”ef
(mod_obj.mq);

1030 
	`auft_uÄegi¡”
(&
vum‘”
);

1031 
mod_obj
.
mes§ge
 = 
	`mem_d”ef
(mod_obj.message);

1033 #ifdeà
USE_LIBNOTIFY


1034 ià(
	`nÙify_is_š™‹d
())

1035 
	`nÙify_unš™
();

1038 
	`g_¦i¡_ä“
(
mod_obj
.
accouÁs_m’u_group
);

1039 
	`g_¦i¡_ä“
(
mod_obj
.
ÿÎ_wšdows
);

1040 
	`g_¦i¡_ä“
(
mod_obj
.
šcomšg_ÿÎ_m’us
);

1042 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

1045 
	}
}

1048 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
gtk
) = {

1051 
moduË_š™
,

1052 
moduË_şo£
,

	@baresip/modules/gtk/gtk_mod.h

7 
	ggtk_mod
;

8 
	gÿÎ_wšdow
;

9 
	gdŸl_dŸlog
;

10 
	gŒªsãr_dŸlog
;

12 
	svum‘”_’c
 {

13 
auft_’c_¡
 
	maf
;

14 
št16_t
 
	mavg_»c
;

15 vŞ©
boŞ
 
	m¡¬‹d
;

18 
	svum‘”_dec
 {

19 
auft_dec_¡
 
	maf
;

20 
št16_t
 
	mavg_¶ay
;

21 vŞ©
boŞ
 
	m¡¬‹d
;

25 
gtk_mod_cÚÃù
(
gtk_mod
 *, cÚ¡ *
uri
);

26 
gtk_mod_ÿÎ_wšdow_şo£d
(
gtk_mod
 *, 
ÿÎ_wšdow
 *);

29 
ÿÎ_wšdow
 *
ÿÎ_wšdow_Ãw
(
ÿÎ
 *ÿÎ, 
gtk_mod
 *
mod
);

30 
ÿÎ_wšdow_gÙ_vu_dec
(
vum‘”_dec
 *);

31 
ÿÎ_wšdow_gÙ_vu_’c
(
vum‘”_’c
 *);

32 
ÿÎ_wšdow_Œªsãr
(
ÿÎ_wšdow
 *, cÚ¡ *
uri
);

33 
ÿÎ_wšdow_şo£d
(
ÿÎ_wšdow
 *, cÚ¡ *
»asÚ
);

34 
ÿÎ_wšdow_ršgšg
(
ÿÎ_wšdow
 *);

35 
ÿÎ_wšdow_´og»ss
(
ÿÎ_wšdow
 *);

36 
ÿÎ_wšdow_e¡ablished
(
ÿÎ_wšdow
 *);

37 
ÿÎ_wšdow_Œªsãr_çed
(
ÿÎ_wšdow
 *, cÚ¡ *
»asÚ
);

38 
boŞ
 
ÿÎ_wšdow_is_fÜ_ÿÎ
(
ÿÎ_wšdow
 *, 
ÿÎ
 *);

41 
dŸl_dŸlog
 *
dŸl_dŸlog_®loc
(
gtk_mod
 *);

42 
dŸl_dŸlog_show
(
dŸl_dŸlog
 *);

45 
Œªsãr_dŸlog
 *
Œªsãr_dŸlog_®loc
(
ÿÎ_wšdow
 *);

46 
Œªsãr_dŸlog_show
(
Œªsãr_dŸlog
 *);

47 
Œªsãr_dŸlog_ç
(
Œªsãr_dŸlog
 *, cÚ¡ *
»asÚ
);

50 
GtkWidg‘
 *
uri_combo_box_Ãw
();

51 cÚ¡ *
uri_combo_box_g‘_‹xt
(
GtkComboBox
 *
box
);

	@baresip/modules/gtk/transfer_dialog.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<gtk/gtk.h
>

9 
	~"gtk_mod.h
"

11 
	sŒªsãr_dŸlog
 {

12 
ÿÎ_wšdow
 *
	mÿÎ_wš
;

13 
GtkWidg‘
 *
	mdŸlog
;

14 
GtkComboBox
 *
	muri_combobox
;

15 
GtkLab–
 *
	m¡©us_Ïb–
;

16 
GtkWidg‘
 *
	m¥šÃr
;

19 cÚ¡ *
	g¡©us_´og»ss
 = "progress";

22 
	$£t_¡©us
(
Œªsãr_dŸlog
 *
td
, cÚ¡ *
¡©us
)

24 ià(
¡©us
 =ğ
¡©us_´og»ss
) {

25 
	`gtk_widg‘_show
(
td
->
¥šÃr
);

26 
	`gtk_¥šÃr_¡¬t
(
	`GTK_SPINNER
(
td
->
¥šÃr
));

27 
	`gtk_Ïb–_£t_‹xt
(
td
->
¡©us_Ïb–
, 
NULL
);

30 
	`gtk_widg‘_hide
(
td
->
¥šÃr
);

31 
	`gtk_¥šÃr_¡İ
(
	`GTK_SPINNER
(
td
->
¥šÃr
));

32 
	`gtk_Ïb–_£t_‹xt
(
td
->
¡©us_Ïb–
, 
¡©us
);

34 
	}
}

37 
	$Ú_dŸlog_»¥Ú£
(
GtkDŸlog
 *
dŸlog
, 
gšt
 
»¥Ú£_id
,

38 
Œªsãr_dŸlog
 *
wš
)

40 *
uri
;

42 ià(
»¥Ú£_id
 =ğ
GTK_RESPONSE_ACCEPT
) {

43 
uri
 = (*)
	`uri_combo_box_g‘_‹xt
(
wš
->
uri_combobox
);

44 
	`£t_¡©us
(
wš
, 
¡©us_´og»ss
);

45 
	`ÿÎ_wšdow_Œªsãr
(
wš
->
ÿÎ_wš
, 
uri
);

48 
	`£t_¡©us
(
wš
, 
NULL
);

49 
	`gtk_widg‘_hide
(
	`GTK_WIDGET
(
dŸlog
));

51 
	}
}

54 
	$de¡ruùÜ
(*
¬g
)

56 
Œªsãr_dŸlog
 *
td
 = 
¬g
;

58 
	`gtk_widg‘_de¡roy
(
td
->
dŸlog
);

59 
	}
}

62 
Œªsãr_dŸlog
 *
	$Œªsãr_dŸlog_®loc
(
ÿÎ_wšdow
 *
ÿÎ_wš
)

64 
Œªsãr_dŸlog
 *
wš
;

65 
GtkWidg‘
 *
dŸlog
, *
cÚ‹Á
, *
bu‰Ú
, *
image
, *
hbox
, *
¥šÃr
, *
Ïb–
;

66 
GtkWidg‘
 *
uri_combobox
;

68 
wš
 = 
	`mem_z®loc
((*wš), 
de¡ruùÜ
);

69 ià(!
wš
)

70  
NULL
;

72 
dŸlog
 = 
	`gtk_dŸlog_Ãw_w™h_bu‰Ús
("T¿nsãr", 
NULL
, 0,

73 
GTK_STOCK_CANCEL
, 
GTK_RESPONSE_REJECT
, 
NULL
);

76 
bu‰Ú
 = 
	`gtk_bu‰Ú_Ãw_w™h_Ïb–
("Transfer");

77 
image
 = 
	`gtk_image_Ãw_äom_icÚ_Çme
("forward",

78 
GTK_ICON_SIZE_BUTTON
);

79 
	`gtk_bu‰Ú_£t_image
(
	`GTK_BUTTON
(
bu‰Ú
), 
image
);

80 
	`gtk_dŸlog_add_aùiÚ_widg‘
(
	`GTK_DIALOG
(
dŸlog
), 
bu‰Ú
,

81 
GTK_RESPONSE_ACCEPT
);

82 
	`gtk_widg‘_£t_ÿn_deçuÉ
(
bu‰Ú
, 
TRUE
);

84 
	`gtk_dŸlog_£t_deçuÉ_»¥Ú£
(
	`GTK_DIALOG
(
dŸlog
),

85 
GTK_RESPONSE_ACCEPT
);

87 
cÚ‹Á
 = 
	`gtk_dŸlog_g‘_cÚ‹Á_¬—
(
	`GTK_DIALOG
(
dŸlog
));

88 
Ïb–
 = 
	`gtk_Ïb–_Ãw
("Transfer callo:");

89 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
cÚ‹Á
), 
Ïb–
, 
FALSE
, FALSE, 0);

92 
uri_combobox
 = 
	`uri_combo_box_Ãw
();

93 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
cÚ‹Á
), 
uri_combobox
, 
FALSE
, FALSE, 5);

95 
	`g_sigÇl_cÚÃù
(
dŸlog
, "response",

96 
	`G_CALLBACK
(
Ú_dŸlog_»¥Ú£
), 
wš
);

97 
	`g_sigÇl_cÚÃù
(
dŸlog
, "delete-event",

98 
	`G_CALLBACK
(
gtk_widg‘_hide_Ú_d–‘e
), 
wš
);

101 
hbox
 = 
	`gtk_hbox_Ãw
(
FALSE
, 0);

102 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
cÚ‹Á
), 
hbox
, 
FALSE
, FALSE, 0);

104 
¥šÃr
 = 
	`gtk_¥šÃr_Ãw
();

105 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
hbox
), 
¥šÃr
, 
TRUE
, TRUE, 0);

107 
Ïb–
 = 
	`gtk_Ïb–_Ãw
(
NULL
);

108 
	`gtk_box_·ck_¡¬t
(
	`GTK_BOX
(
cÚ‹Á
), 
Ïb–
, 
FALSE
, FALSE, 0);

109 
wš
->
¡©us_Ïb–
 = 
	`GTK_LABEL
(
Ïb–
);

111 
wš
->
dŸlog
 = dialog;

112 
wš
->
uri_combobox
 = 
	`GTK_COMBO_BOX
(uri_combobox);

113 
wš
->
ÿÎ_wš
 = call_win;

114 
wš
->
¥šÃr
 = spinner;

116 
	`gtk_widg‘_show_®l
(
dŸlog
);

117 
	`gtk_widg‘_hide
(
¥šÃr
);

119  
wš
;

120 
	}
}

122 
	$Œªsãr_dŸlog_show
(
Œªsãr_dŸlog
 *
td
)

124 
	`gtk_wšdow_´e£Á
(
	`GTK_WINDOW
(
td
->
dŸlog
));

125 
	`gtk_widg‘_g¿b_focus
(
	`gtk_bš_g‘_chd
(
	`GTK_BIN
(
td
->
uri_combobox
)));

126 
	`£t_¡©us
(
td
, 
NULL
);

127 
	}
}

129 
	$Œªsãr_dŸlog_ç
(
Œªsãr_dŸlog
 *
td
, cÚ¡ *
»asÚ
)

131 
buf
[256];

132 
	`»_¢´štf
(
buf
,  buf, "T¿nsã¸çed: %s", 
»asÚ
);

133 
	`£t_¡©us
(
td
, 
buf
);

134 
	}
}

	@baresip/modules/gtk/uri_entry.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<gtk/gtk.h
>

10 
	~"gtk_mod.h
"

19 
GtkWidg‘
 *
	$uri_combo_box_Ãw
()

21 
cÚùs
 *cÚù ğ
	`b¬es_cÚùs
();

22 
Ë
 *le;

23 
GtkEÁry
 *
uri_’Œy
;

24 
GtkWidg‘
 *
uri_combobox
;

26 
uri_combobox
 = 
	`gtk_combo_box_‹xt_Ãw_w™h_’Œy
();

27 
uri_’Œy
 = 
	`GTK_ENTRY
(
	`gtk_bš_g‘_chd
(
	`GTK_BIN
(
uri_combobox
)));

28 
	`gtk_’Œy_£t_aùiv©es_deçuÉ
(
uri_’Œy
, 
TRUE
);

30 
Ë
 = 
	`li¡_h—d
(
	`cÚù_li¡
(
cÚùs
));†e;†ğË->
Ãxt
) {

31 
cÚù
 *
c
 = 
Ë
->
d©a
;

32 
	`gtk_combo_box_‹xt_­³nd_‹xt
(

33 
	`GTK_COMBO_BOX_TEXT
(
uri_combobox
),

34 
	`cÚù_¡r
(
c
));

37  
uri_combobox
;

38 
	}
}

40 cÚ¡ *
	$uri_combo_box_g‘_‹xt
(
GtkComboBox
 *
box
)

42 
GtkEÁry
 *
’Œy
 = 
	`GTK_ENTRY
(
	`gtk_bš_g‘_chd
(
	`GTK_BIN
(
box
)));

43 
GtkEÁryBufãr
 *
buf
 = 
	`gtk_’Œy_g‘_bufãr
(
’Œy
);

44  
	`gtk_’Œy_bufãr_g‘_‹xt
(
buf
);

45 
	}
}

	@baresip/modules/gzrtp/gzrtp.cpp

6 
	~<¡dšt.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

11 
	~<¡ršg.h
>

13 
	~<libz¹pıp/ZR.h
>

15 
	~"£ssiÚ.h
"

16 
	~"¡»am.h
"

42 
ZRTPCÚfig
 *
	gs_z¹p_cÚfig
 = 
NULL
;

45 
	sm’c_£ss
 {

46 
SessiÚ
 *
	m£ssiÚ
;

50 
	sm’c_medŸ
 {

51 
SŒ—m
 *
	m¡»am
;

55 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

57 
m’c_£ss
 *
¡
 = (m’c_£s *)
¬g
;

59 
d–‘e
 
¡
->
£ssiÚ
;

60 
	}
}

63 
	$medŸ_de¡ruùÜ
(*
¬g
)

65 
m’c_medŸ
 *
¡
 = (m’c_medŸ *)
¬g
;

67 
d–‘e
 
¡
->
¡»am
;

68 
	}
}

71 
	$£ssiÚ_®loc
(
m’c_£ss
 **
£s¥
, 
sdp_£ssiÚ
 *
sdp
,

72 
boŞ
 
ofã»r
, 
m’c_”rÜ_h
 *
”rÜh
, *
¬g
)

74 
m’c_£ss
 *
¡
;

75 ()
ofã»r
;

76 ()
”rÜh
;

77 ()
¬g
;

78 
”r
 = 0;

80 ià(!
£s¥
 || !
sdp
)

81  
EINVAL
;

83 
¡
 = (
m’c_£ss
 *)
	`mem_z®loc
((*¡), 
£ssiÚ_de¡ruùÜ
);

84 ià(!
¡
)

85  
ENOMEM
;

87 
¡
->
£ssiÚ
 = 
Ãw
 
	`SessiÚ
(*
s_z¹p_cÚfig
);

88 ià(!
¡
->
£ssiÚ
)

89 
”r
 = 
ENOMEM
;

91 ià(
”r
)

92 
	`mem_d”ef
(
¡
);

94 *
£s¥
 = 
¡
;

96  
”r
;

97 
	}
}

100 
	$medŸ_®loc
(
m’c_medŸ
 **
¡p
, 
m’c_£ss
 *
£ss
,

101 
¹p_sock
 *
¹p
,

102 
´Ùo
, *
¹psock
, *
¹ısock
,

103 
sdp_medŸ
 *
sdpm
)

105 
m’c_medŸ
 *
¡
;

106 
”r
 = 0;

107 
SŒ—mMedŸTy³
 
med_ty³
;

108 cÚ¡ *
med_Çme
;

110 ià(!
¡p
 || !
£ss
 || !£ss->
£ssiÚ
 || 
´Ùo
 !ğ
IPPROTO_UDP
)

111  
EINVAL
;

113 
¡
 = *
¡p
;

114 ià(
¡
)

115 
¡¬t
;

117 
¡
 = (
m’c_medŸ
 *)
	`mem_z®loc
((*¡), 
medŸ_de¡ruùÜ
);

118 ià(!
¡
)

119  
ENOMEM
;

121 
med_Çme
 = 
	`sdp_medŸ_Çme
(
sdpm
);

122 ià(
	`¡r_cmp
(
med_Çme
, "audio") == 0)

123 
med_ty³
 = 
MT_AUDIO
;

124 ià(
	`¡r_cmp
(
med_Çme
, "video") == 0)

125 
med_ty³
 = 
MT_VIDEO
;

126 ià(
	`¡r_cmp
(
med_Çme
, "text") == 0)

127 
med_ty³
 = 
MT_TEXT
;

128 ià(
	`¡r_cmp
(
med_Çme
, "application") == 0)

129 
med_ty³
 = 
MT_APPLICATION
;

130 ià(
	`¡r_cmp
(
med_Çme
, "message") == 0)

131 
med_ty³
 = 
MT_MESSAGE
;

133 
med_ty³
 = 
MT_UNKNOWN
;

135 
¡
->
¡»am
 = 
£ss
->
£ssiÚ
->
	`ü—‹_¡»am
(

136 *
s_z¹p_cÚfig
,

137 (
udp_sock
 *)
¹psock
,

138 (
udp_sock
 *)
¹ısock
,

139 
	`¹p_£ss_s¤c
(
¹p
), 
med_ty³
);

140 ià(!
¡
->
¡»am
) {

141 
”r
 = 
ENOMEM
;

142 
out
;

145 
¡
->
¡»am
->
	`sdp_’code
(
sdpm
);

147 
out
:

148 ià(
”r
) {

149 
	`mem_d”ef
(
¡
);

150  
”r
;

153 *
¡p
 = 
¡
;

155 
¡¬t
:

156 ià(
	`§_is£t
(
	`sdp_medŸ_¿ddr
(
sdpm
), 
SA_ALL
)) {

157 
¡
->
¡»am
->
	`sdp_decode
(
sdpm
);

158 
”r
 = 
£ss
->
£ssiÚ
->
	`¡¬t_¡»am
(
¡
->
¡»am
);

159 ià(
”r
) {

160 
	`w¬nšg
("z¹p: sŒ—m s¹ faed: %d\n", 
”r
);

164  
”r
;

165 
	}
}

168 
m’c
 
	gm’c_z¹p
 = {

169 
LE_INIT
, "z¹p", "RTP/AVP", 
£ssiÚ_®loc
, 
medŸ_®loc


173 cÚ¡ 
cmd
 
	gcmdv
[] = {

174 {"z¹p_v”ify", 0, 
CMD_PRM
, "Verify ZRTP SAS <session ID>",

175 
SessiÚ
::
cmd_v”ify_§s
 },

176 {"z¹p_unv”ify", 0, 
CMD_PRM
, "Unverify ZRTP SAS <session ID>",

177 
SessiÚ
::
cmd_unv”ify_§s
 },

181 
	$moduË_š™
()

183 
cÚfig_·th
[256];

184 
”r
 = 0;

186 
”r
 = 
	`cÚf_·th_g‘
(
cÚfig_·th
, (config_path));

187 ià(
”r
) {

188 
	`w¬nšg
("z¹p: could‚Ù g‘ cÚfig…©h: %m\n", 
”r
);

189  
”r
;

192 
s_z¹p_cÚfig
 = 
Ãw
 
	`ZRTPCÚfig
(
	`cÚf_cur
(), 
cÚfig_·th
);

193 ià(!
s_z¹p_cÚfig
)

194  
ENOMEM
;

196 
	`m’c_»gi¡”
(
	`b¬es_m’ş
(), &
m’c_z¹p
);

198  
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

199 
	}
}

202 
	$moduË_şo£
()

204 
d–‘e
 
s_z¹p_cÚfig
;

205 
s_z¹p_cÚfig
 = 
NULL
;

207 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

209 
	`m’c_uÄegi¡”
(&
m’c_z¹p
);

212 
	}
}

215 "C" 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
gz¹p
) = {

218 
moduË_š™
,

219 
moduË_şo£


	@baresip/modules/gzrtp/messages.cpp

6 
	~<¡dšt.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

11 
	~<libz¹pıp/ZR.h
>

13 
	~"¡»am.h
"

16 
usšg
 
Çme¥aû
 
	gGnuZ¹pCodes
;

19 
	#NO_MESSAGE
 "NO MESSAGE DEFINED"

	)

22 cÚ¡ *
	$šfo_msg
(
št32_t
 
subcode
)

24 cÚ¡ *
msg
;

26 
subcode
) {

27 
InfoH–loReûived
:

28 
msg
 = "Hello„eceived‡nd…repared‡ Commit, "

31 
InfoComm™DHG’”©ed
:

32 
msg
 = "Commit: Generated‡…ublic DH key";

34 
InfoRe¥Comm™Reûived
:

35 
msg
 = "Responder: Commit„eceived,…reparing DHPart1";

37 
InfoDH1DHG’”©ed
:

38 
msg
 = "DH1Part: Generated‡…ublic DH key";

40 
InfoIn™DH1Reûived
:

41 
msg
 = "Initiator: DHPart1„eceived,…reparing DHPart2";

43 
InfoRe¥DH2Reûived
:

44 
msg
 = "Responder: DHPart2„eceived,…reparing Confirm1";

46 
InfoIn™CÚf1Reûived
:

47 
msg
 = "Initiator: Confirm1„eceived,…reparing Confirm2";

49 
InfoRe¥CÚf2Reûived
:

50 
msg
 = "Responder: Confirm2„eceived,…reparing Conf2Ack";

52 
InfoRSM©chFound
:

53 
msg
 = "At†east one„etained secret matches - security OK";

55 
InfoSecu»S‹On
:

56 
msg
 = "Entered secure state";

58 
InfoSecu»S‹Off
:

59 
msg
 = "No more security forhis session";

62 
msg
 = 
NO_MESSAGE
;

66  
msg
;

67 
	}
}

70 cÚ¡ *
	$w¬nšg_msg
(
št32_t
 
subcode
)

72 cÚ¡ *
msg
;

74 
subcode
) {

75 
W¬nšgDHAESmism©ch
:

76 
msg
 = "Commit contains‡n AES256 cipher but does‚ot offer‡ "

79 
W¬nšgGoCË¬Reûived
:

80 
msg
 = "Received‡ GoClear message";

82 
W¬nšgDHShÜt
:

83 
msg
 = "Hello offers‡n AES256 cipher but does‚ot offer‡ "

86 
W¬nšgNoRSM©ch
:

87 
msg
 = "No„etained shared secrets‡vailable - must verify SAS";

89 
W¬nšgCRCmism©ch
:

90 
msg
 = "Internal ZRTP…acket checksum mismatch - "

93 
W¬nšgSRTPauthE¼Ü
:

94 
msg
 = "Dropping…acket because SRTP‡uthentication failed!";

96 
W¬nšgSRTP»¶ayE¼Ü
:

97 
msg
 = "Dropping…acket because SRTP„eplay check failed!";

99 
W¬nšgNoEx³ùedRSM©ch
:

100 
msg
 = "Valid„etained shared secrets‡vailabe but‚o matches "

103 
W¬nšgNoEx³ùedAuxM©ch
:

104 
msg
 = "Our AUX secret was set buthe other…eer's AUX secret "

108 
msg
 = 
NO_MESSAGE
;

112  
msg
;

113 
	}
}

116 cÚ¡ *
	$£v”e_msg
(
št32_t
 
subcode
)

118 cÚ¡ *
msg
;

120 
subcode
) {

121 
Sev”eH–loHMACFaed
:

122 
msg
 = "Hash HMAC check of Hello failed!";

124 
Sev”eComm™HMACFaed
:

125 
msg
 = "Hash HMAC check of Commit failed!";

127 
Sev”eDH1HMACFaed
:

128 
msg
 = "Hash HMAC check of DHPart1 failed!";

130 
Sev”eDH2HMACFaed
:

131 
msg
 = "Hash HMAC check of DHPart2 failed!";

133 
Sev”eCªnÙS’d
:

134 
msg
 = "Cannot send data - connection or…eer down?";

136 
Sev”ePrÙocŞE¼Ü
:

137 
msg
 = "Internal…rotocolƒrror occured!";

139 
Sev”eNoTim”
:

140 
msg
 = "Cannot start‡imer - internal„esourcesƒxhausted?";

142 
Sev”eTooMuchR‘r›s
:

143 
msg
 = "Too much„etries during ZRTP‚egotiation - connection "

147 
msg
 = 
NO_MESSAGE
;

151  
msg
;

152 
	}
}

155 cÚ¡ *
	$z¹p_msg
(
št32_t
 
subcode
)

157 cÚ¡ *
msg
;

159 
subcode
) {

160 
M®fÜmedPack‘
:

161 
msg
 = "Malformed…acket (CRC OK, but wrong structure)";

163 
Cr™iÿlSWE¼Ü
:

164 
msg
 = "Critical softwareƒrror";

166 
UnsuµZRTPV”siÚ
:

167 
msg
 = "Unsupported ZRTP version";

169 
H–loCompMism©ch
:

170 
msg
 = "Hello components mismatch";

172 
UnsuµHashTy³
:

173 
msg
 = "Hashype‚ot supported";

175 
UnsuµCh”ty³
:

176 
msg
 = "Cipherype‚ot supported";

178 
UnsuµPKExchªge
:

179 
msg
 = "Public keyƒxchange‚ot supported";

181 
UnsuµSRTPAuthTag
:

182 
msg
 = "SRTP‡uth.ag‚ot supported";

184 
UnsuµSASScheme
:

185 
msg
 = "SAS scheme‚ot supported";

187 
NoSh¬edSeü‘
:

188 
msg
 = "No shared secret‡vailable, DH mode„equired";

190 
DHE¼ÜWrÚgPV
:

191 
msg
 = "DH Error: bad…vi or…vr ( == 1, 0, or…-1)";

193 
DHE¼ÜWrÚgHVI
:

194 
msg
 = "DH Error: hvi != hashed data";

196 
SASuÁru¡edMiTM
:

197 
msg
 = "Received„elayed SAS from untrusted MiTM";

199 
CÚfœmHMACWrÚg
:

200 
msg
 = "Auth. Error: Bad Confirm…kt HMAC";

202 
NÚûReu£d
:

203 
msg
 = "Nonce„euse";

205 
Equ®ZIDH–lo
:

206 
msg
 = "Equal ZIDs in Hello";

208 
GoCË©NÙAÎowed
:

209 
msg
 = "GoClear…acket„eceived, but‚ot‡llowed";

212 
msg
 = 
NO_MESSAGE
;

216  
msg
;

217 
	}
}

220 
	gSŒ—m
::
	$´št_mes§ge
(
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
,

221 
št32_t
 
subcode
)

223 
£v”™y
) {

224 
Info
:

225 
	`debug
("zrtp: INFO<%s>: %s\n",

226 
	`medŸ_Çme
(), 
	`šfo_msg
(
subcode
));

228 
W¬nšg
:

229 
	`w¬nšg
("zrtp: WARNING<%s>: %s\n",

230 
	`medŸ_Çme
(), 
	`w¬nšg_msg
(
subcode
));

232 
Sev”e
:

233 
	`w¬nšg
("zrtp: SEVERE<%s>: %s\n",

234 
	`medŸ_Çme
(), 
	`£v”e_msg
(
subcode
));

236 
Z¹pE¼Ü
:

237 
	`w¬nšg
("zrtp: ZRTP_ERR<%s>: %s\n",

238 
	`medŸ_Çme
(), 
	`z¹p_msg
(
subcode
));

243 
	}
}

246 cÚ¡ *
	gSŒ—m
::
	$medŸ_Çme
() const

248 
m_medŸ_ty³
) {

249 
MT_AUDIO
:  "audio";

250 
MT_VIDEO
:  "video";

251 
MT_TEXT
:  "text";

252 
MT_APPLICATION
:  "application";

253 
MT_MESSAGE
:  "message";

256 
	}
}

	@baresip/modules/gzrtp/session.cpp

6 
	~<¡dšt.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

11 
	~"£ssiÚ.h
"

14 
	g¡d
::
veùÜ
<
SessiÚ
 *> SessiÚ::
s_£s¦
;

17 
	gSessiÚ
::
	$SessiÚ
(cÚ¡ 
ZRTPCÚfig
& 
cÚfig
)

18 : 
	`m_¡¬t_·¿Î–
(
cÚfig
.
¡¬t_·¿Î–
)

19 , 
	`m_ma¡”
(
NULL
)

20 , 
	$m_’üy±ed
(0)

22 
Ãwid
 = 1;

23 
¡d
::
veùÜ
<
SessiÚ
 *>::
™”©Ü
 
™
 = 
s_£s¦
.
	`begš
();

24 
™
 !ğ
s_£s¦
.
	`’d
(); ++it) {

26 ià((*
™
)->
	`id
(è>ğ
Ãwid
)

27 
Ãwid
 = (*
™
)->
	`id
() + 1;

30 
m_id
 = 
Ãwid
;

32 
s_£s¦
.
	`push_back
(
this
);

34 
	`debug
("z¹p: New sessiÚ <%d>\n", 
	`id
());

35 
	}
}

38 
	gSessiÚ
::~
	$SessiÚ
()

40 
¡d
::
veùÜ
<
SessiÚ
 *>::
™”©Ü
 
™
 = 
s_£s¦
.
	`begš
();

41 
™
 !ğ
s_£s¦
.
	`’d
(); ++it) {

43 ià(*
™
 =ğ
this
) {

44 
s_£s¦
.
	`”a£
(
™
);

49 
	`debug
("z¹p: SessiÚ <%d> i de¡royed\n", 
	`id
());

50 
	}
}

53 
SŒ—m
 *
	gSessiÚ
::
	$ü—‹_¡»am
(cÚ¡ 
ZRTPCÚfig
& 
cÚfig
,

54 
udp_sock
 *
¹psock
,

55 
udp_sock
 *
¹ısock
,

56 
ušt32_t
 
loÿl_s¤c
,

57 
SŒ—mMedŸTy³
 
medŸ_ty³
)

59 
”r
 = 0;

61 
SŒ—m
 *
¡
 = 
Ãw
 
	`SŒ—m
 (
”r
, 
cÚfig
, 
this
, 
¹psock
, 
¹ısock
,

62 
loÿl_s¤c
, 
medŸ_ty³
);

63 ià(!
¡
 || 
”r
) {

64 
d–‘e
 
¡
;

65  
NULL
;

68  
¡
;

69 
	}
}

72 
	gSessiÚ
::
	$¡¬t_¡»am
(
SŒ—m
 *
¡»am
)

74 ià(
¡»am
->
	`¡¬‹d
())

77 
m_¡»ams
.
	`push_back
(
¡»am
);

83 ià(
m_¡¬t_·¿Î–
) {

84 ià(
m_ma¡”
 && 
m_’üy±ed
)

87  
¡»am
->
	`¡¬t
(
m_ma¡”
);

90  
¡»am
->
	`¡¬t
(
NULL
);

93 ià(!
m_ma¡”
) {

95 
m_ma¡”
 = 
¡»am
;

96  
¡»am
->
	`¡¬t
(
NULL
);

98 ià(
m_’üy±ed
) {

100  
¡»am
->
	`¡¬t
(
m_ma¡”
);

105 
	}
}

108 
boŞ
 
	gSessiÚ
::
	$»que¡_ma¡”
(
SŒ—m
 *
¡»am
)

110 ià(!
m_¡¬t_·¿Î–
)

111  
Œue
;

113 ià(
m_ma¡”
)

114  
çl£
;

118 
m_ma¡”
 = 
¡»am
;

121 
¡d
::
veùÜ
<
SŒ—m
 *>::
™”©Ü
 
™
 = 
m_¡»ams
.
	`begš
();

122 
™
 !ğ
m_¡»ams
.
	`’d
(); ++it) {

124 ià(*
™
 !ğ
m_ma¡”
) {

125 (*
™
)->
	`¡İ
();

129  
Œue
;

130 
	}
}

133 
	gSessiÚ
::
	$Ú_£cu»
(
SŒ—m
 *
¡»am
)

135 ++
m_’üy±ed
;

137 ià(
m_’üy±ed
 =ğ
m_¡»ams
.
	`size
(è&& 
m_ma¡”
) {

138 
	`šfo
("zrtp: All streams‡reƒncrypted (%s), "

140 
m_ma¡”
->
	`g‘_ch”s
(),

141 
m_ma¡”
->
	`g‘_§s
(),

142 (
m_ma¡”
->
	`§s_v”if›d
())? "verified" : "NOT VERIFIED");

146 ià(
¡»am
 !ğ
m_ma¡”
)

152 
	`debug
("z¹p: S¹šg oth” sŒ—m (%d)\n", 
m_¡»ams
.
	`size
() - 1);

154 
¡d
::
veùÜ
<
SŒ—m
 *>::
™”©Ü
 
™
 = 
m_¡»ams
.
	`begš
();

155 
™
 !ğ
m_¡»ams
.
	`’d
(); ++it) {

157 ià(*
™
 !ğ
m_ma¡”
) {

158 (*
™
)->
	`¡¬t
(
m_ma¡”
);

161 
	}
}

164 
	gSessiÚ
::
	$cmd_v”ify_§s
(
»_´štf
 *
pf
, *
¬g
)

166  
	`cmd_§s
(
Œue
, 
pf
, 
¬g
);

167 
	}
}

170 
	gSessiÚ
::
	$cmd_unv”ify_§s
(
»_´štf
 *
pf
, *
¬g
)

172  
	`cmd_§s
(
çl£
, 
pf
, 
¬g
);

173 
	}
}

176 
	gSessiÚ
::
	$cmd_§s
(
boŞ
 
v”ify
, 
»_´štf
 *
pf
, *
¬g
)

178 cÚ¡ 
cmd_¬g
 *
ÿrg
 = (cmd_¬g *)
¬g
;

179 ()
pf
;

180 
id
 = -1;

181 
SessiÚ
 *
£ss
 = 
NULL
;

183 ià(
	`¡r_is£t
(
ÿrg
->
´m
))

184 
id
 = 
	`©oi
(
ÿrg
->
´m
);

186 
¡d
::
veùÜ
<
SessiÚ
 *>::
™”©Ü
 
™
 = 
s_£s¦
.
	`begš
();

187 
™
 !ğ
s_£s¦
.
	`’d
(); ++it) {

189 ià((*
™
)->
	`id
(è=ğ
id
) {

190 
£ss
 = *
™
;

195 ià(!
£ss
) {

196 
	`w¬nšg
("z¹p: NØ£ssiÚ w™h id %d\n", 
id
);

197  
EINVAL
;

200 ià(!
£ss
->
m_ma¡”
) {

201 
	`w¬nšg
("zrtp: No master stream forhe session with id %d\n",

202 
£ss
->
	`id
());

203  
EFAULT
;

206 
£ss
->
m_ma¡”
->
	`v”ify_§s
(
v”ify
);

208 
	`šfo
("z¹p: SessiÚ <%d>: SAS [%s] i %s\n", 
£ss
->
	`id
(),

209 
£ss
->
m_ma¡”
->
	`g‘_§s
(),

210 (
£ss
->
m_ma¡”
->
	`§s_v”if›d
())? "verified" : "NOT VERIFIED");

213 
	}
}

	@baresip/modules/gzrtp/session.h

6 #iâdeà
__SESSION_H


7 
	#__SESSION_H


	)

10 
	~"¡»am.h
"

13 
şass
 
	gSŒ—m
;

14 
şass
 
	gZRTPCÚfig
;

16 şas 
	cSessiÚ
 {

17 
	mpublic
:

18 
SessiÚ
(cÚ¡ 
ZRTPCÚfig
& 
cÚfig
);

20 ~
SessiÚ
();

22 
SŒ—m
 *
ü—‹_¡»am
(cÚ¡ 
ZRTPCÚfig
& 
cÚfig
,

23 
udp_sock
 *
¹psock
,

24 
udp_sock
 *
¹ısock
,

25 
ušt32_t
 
loÿl_s¤c
,

26 
SŒ—mMedŸTy³
 
medŸ_ty³
);

28 
¡¬t_¡»am
(
SŒ—m
 *
¡»am
);

29 
	$id
(ècÚ¡ {  
m_id
; }

31 
boŞ
 
	`»que¡_ma¡”
(
SŒ—m
 *
¡»am
);

32 
	`Ú_£cu»
(
SŒ—m
 *
¡»am
);

34 
	`cmd_v”ify_§s
(
»_´štf
 *
pf
, *
¬g
);

35 
	`cmd_unv”ify_§s
(
»_´štf
 *
pf
, *
¬g
);

36 
	`cmd_§s
(
boŞ
 
v”ify
, 
»_´štf
 *
pf
, *
¬g
);

38 
´iv©e
:

39 
¡d
::
veùÜ
<
SessiÚ
 *> 
s_£s¦
;

41 cÚ¡ 
boŞ
 
m_¡¬t_·¿Î–
;

42 
m_id
;

43 
¡d
::
veùÜ
<
SŒ—m
 *> 
m_¡»ams
;

44 
SŒ—m
 *
m_ma¡”
;

45 
m_’üy±ed
;

46 
	}
};

	@baresip/modules/gzrtp/srtp.cpp

6 
	~<¡dšt.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

11 #ifdeà
GZRTP_USE_RE_SRTP


12 
	~<¡ršg.h
>

14 
	~<¤/Cry±oCÚ‹xt.h
>

15 
	~<¤/Cry±oCÚ‹xtCŒl.h
>

16 
	~<¤/S¹pHªdËr.h
>

19 
	~"¤.h
"

22 
	gS¹p
::
	$S¹p
(& 
”r
, cÚ¡ 
S¹pSeü‘_t
 *
£ü‘s
, 
EÇbËSecur™y
 
·¹
)

25 cÚ¡ 
ušt8_t
 *
key
, *
§É
;

26 
ušt32_t
 
key_Ën
, 
§É_Ën
;

28 
”r
 = 
EPERM
;

30 #ifdeà
GZRTP_USE_RE_SRTP


31 
m_¤
 = 
NULL
;

33 
m_cc
 = 
NULL
;

34 
m_cc_ù¾
 = 
NULL
;

37 ià(
·¹
 =ğ
FÜS’d”
) {

40 ià(
£ü‘s
->
rŞe
 =ğ
In™ŸtÜ
) {

41 
key
 = 
£ü‘s
->
keyIn™ŸtÜ
;

42 
key_Ën
 = 
£ü‘s
->
š™KeyL’
 / 8;

43 
§É
 = 
£ü‘s
->
§ÉIn™ŸtÜ
;

44 
§É_Ën
 = 
£ü‘s
->
š™S®tL’
 / 8;

47 
key
 = 
£ü‘s
->
keyRe¥Úd”
;

48 
key_Ën
 = 
£ü‘s
->
»¥KeyL’
 / 8;

49 
§É
 = 
£ü‘s
->
§ÉRe¥Úd”
;

50 
§É_Ën
 = 
£ü‘s
->
»¥S®tL’
 / 8;

53 ià(
·¹
 =ğ
FÜReûiv”
) {

56 ià(
£ü‘s
->
rŞe
 =ğ
In™ŸtÜ
) {

57 
key
 = 
£ü‘s
->
keyRe¥Úd”
;

58 
key_Ën
 = 
£ü‘s
->
»¥KeyL’
 / 8;

59 
§É
 = 
£ü‘s
->
§ÉRe¥Úd”
;

60 
§É_Ën
 = 
£ü‘s
->
»¥S®tL’
 / 8;

63 
key
 = 
£ü‘s
->
keyIn™ŸtÜ
;

64 
key_Ën
 = 
£ü‘s
->
š™KeyL’
 / 8;

65 
§É
 = 
£ü‘s
->
§ÉIn™ŸtÜ
;

66 
§É_Ën
 = 
£ü‘s
->
š™S®tL’
 / 8;

70 
”r
 = 
EINVAL
;

74 #ifdeà
GZRTP_USE_RE_SRTP


76 
ušt8_t
 
key_buf
[32 + 14];

77 
¤_su™e
 
su™e
;

78 
¤
 *
¡
;

80 ià(
£ü‘s
->
symEncAlgÜ™hm
 =ğ
Aes
 &&

81 
£ü‘s
->
authAlgÜ™hm
 =ğ
Sha1
) {

83 ià(
key_Ën
 =ğ16 && 
£ü‘s
->
¤AuthTagL’
 == 32)

84 
su™e
 = 
SRTP_AES_CM_128_HMAC_SHA1_32
;

86 ià(
key_Ën
 =ğ16 && 
£ü‘s
->
¤AuthTagL’
 == 80)

87 
su™e
 = 
SRTP_AES_CM_128_HMAC_SHA1_80
;

89 ià(
key_Ën
 =ğ32 && 
£ü‘s
->
¤AuthTagL’
 == 32)

90 
su™e
 = 
SRTP_AES_256_CM_HMAC_SHA1_32
;

92 ià(
key_Ën
 =ğ32 && 
£ü‘s
->
¤AuthTagL’
 == 80)

93 
su™e
 = 
SRTP_AES_256_CM_HMAC_SHA1_80
;

96 
”r
 = 
ENOTSUP
;

101 
”r
 = 
ENOTSUP
;

105 ià(
§É_Ën
 != 14) {

106 
”r
 = 
EINVAL
;

110 
	`memıy
(
key_buf
, 
key
, 
key_Ën
);

111 
	`memıy
(
key_buf
 + 
key_Ën
, 
§É
, 
§É_Ën
);

113 
”r
 = 
	`¤_®loc
(&
¡
, 
su™e
, 
key_buf
, 
key_Ën
 + 
§É_Ën
, 0);

114 ià(
”r
)

117 
m_auth_g_Ën
 = 
£ü‘s
->
¤AuthTagL’
 / 8;

118 
m_¤
 = 
¡
;

120 
”r
 = 0;

123 
Cry±oCÚ‹xt
 *
cc
 = 
NULL
;

124 
Cry±oCÚ‹xtCŒl
 *
cc_ù¾
 = 
NULL
;

125 
ch”
;

126 
authn
;

127 
auth_key_Ën
;

129 
£ü‘s
->
authAlgÜ™hm
) {

130 
Sha1
:

131 
authn
 = 
S¹pAuth’tiÿtiÚSha1Hmac
;

132 
auth_key_Ën
 = 20;

134 
Skeš
:

135 
authn
 = 
S¹pAuth’tiÿtiÚSkešHmac
;

136 
auth_key_Ën
 = 32;

139 
”r
 = 
ENOTSUP
;

143 
£ü‘s
->
symEncAlgÜ™hm
) {

144 
Aes
:

145 
ch”
 = 
S¹pEnüy±iÚAESCM
;

147 
TwoFish
:

148 
ch”
 = 
S¹pEnüy±iÚTWOCM
;

151 
”r
 = 
ENOTSUP
;

155 
cc
 = 
Ãw
 
	`Cry±oCÚ‹xt
(

159 
ch”
,

160 
authn
,

161 (
ušt8_t
 *)
key
,

162 
key_Ën
,

163 (
ušt8_t
 *)
§É
,

164 
§É_Ën
,

165 
key_Ën
,

166 
auth_key_Ën
,

167 
§É_Ën
,

168 
£ü‘s
->
¤AuthTagL’
 / 8);

170 
cc_ù¾
 = 
Ãw
 
	`Cry±oCÚ‹xtCŒl
(

172 
ch”
,

173 
authn
,

174 (
ušt8_t
 *)
key
,

175 
key_Ën
,

176 (
ušt8_t
 *)
§É
,

177 
§É_Ën
,

178 
key_Ën
,

179 
auth_key_Ën
,

180 
§É_Ën
,

181 
£ü‘s
->
¤AuthTagL’
 / 8);

183 ià(!
cc
 || !
cc_ù¾
) {

184 
d–‘e
 
cc
;

185 
d–‘e
 
cc_ù¾
;

187 
”r
 = 
ENOMEM
;

191 
cc
->
	`d”iveS¹pKeys
(0L);

192 
cc_ù¾
->
	`d”iveS¹ıKeys
();

194 
m_cc
 = 
cc
;

195 
m_cc_ù¾
 = 
cc_ù¾
;

197 
”r
 = 0;

199 
	}
}

202 
	gS¹p
::~
	$S¹p
()

204 #ifdeà
GZRTP_USE_RE_SRTP


205 
	`mem_d”ef
(
m_¤
);

207 
d–‘e
 
m_cc
;

208 
d–‘e
 
m_cc_ù¾
;

210 
	}
}

213 
	gS¹p
::
	$´Ùeù_št
(
mbuf
 *
mb
, 
boŞ
 
cÚŒŞ
)

215 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

217 
št32_t
 
exŒa
 = (
	`mbuf_g‘_¥aû
(
mb
è> 
Ën
)?

218 
	`mbuf_g‘_¥aû
(
mb
è- 
Ën
 : 0;

220 #ifdeà
GZRTP_USE_RE_SRTP


221 ià(
m_auth_g_Ën
 + (
cÚŒŞ
? 4 : 0è> 
exŒa
)

222  
ENOMEM
;

224 ià(
cÚŒŞ
)

225  
	`¤tı_’üy±
(
m_¤
, 
mb
);

227  
	`¤_’üy±
(
m_¤
, 
mb
);

229 ià(
cÚŒŞ
) {

230 ià(
m_cc_ù¾
->
	`g‘TagL’gth
() + 4 +

231 
m_cc_ù¾
->
	`g‘MkiL’gth
(è> 
exŒa
)

232  
ENOMEM
;

235 ià(
m_cc
->
	`g‘TagL’gth
() +

236 
m_cc
->
	`g‘MkiL’gth
(è> 
exŒa
)

237  
ENOMEM
;

240 
boŞ
 
rc
;

242 ià(
cÚŒŞ
)

243 
rc
 = 
S¹pHªdËr
::
	`´ÙeùCŒl
(
m_cc_ù¾
, 
	`mbuf_buf
(
mb
),

244 
Ën
, &len);

246 
rc
 = 
S¹pHªdËr
::
	`´Ùeù
(
m_cc
, 
	`mbuf_buf
(
mb
), 
Ën
, &len);

247 ià(!
rc
)

248  
EPROTO
;

250 ià(
Ën
 > 
	`mbuf_g‘_¥aû
(
mb
)) {

252 
	`”rÜ_msg
("zrtp:…rotect:†ength > space (%u > %u)\n",

253 
Ën
, 
	`mbuf_g‘_¥aû
(
mb
));

254 
	`abÜt
();

257 
mb
->
’d
 = mb->
pos
 + 
Ën
;

261 
	}
}

264 
	gS¹p
::
	$´Ùeù
(
mbuf
 *
mb
)

266  
	`´Ùeù_št
(
mb
, 
çl£
);

267 
	}
}

270 
	gS¹p
::
	$´Ùeù_ù¾
(
mbuf
 *
mb
)

272  
	`´Ùeù_št
(
mb
, 
Œue
);

273 
	}
}

282 
	gS¹p
::
	$uÅrÙeù_št
(
mbuf
 *
mb
, 
boŞ
 
cÚŒŞ
)

284 #ifdeà
GZRTP_USE_RE_SRTP


285 ià(
cÚŒŞ
)

286  
	`¤tı_deüy±
(
m_¤
, 
mb
);

288  
	`¤_deüy±
(
m_¤
, 
mb
);

290 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

291 
ušt32_t
 
rc
;

292 
”r
;

294 ià(
cÚŒŞ
)

295 
rc
 = 
S¹pHªdËr
::
	`uÅrÙeùCŒl
(
m_cc_ù¾
, 
	`mbuf_buf
(
mb
),

296 
Ën
, &len);

298 
rc
 = 
S¹pHªdËr
::
	`uÅrÙeù
(
m_cc
, 
	`mbuf_buf
(
mb
),

299 
Ën
, &Ën, 
NULL
);

301 
rc
) {

302 1: 
”r
 = 0; ;

303 0: 
”r
 = 
EBADMSG
; ;

304 -1: 
”r
 = 
EAUTH
; ;

305 -2: 
”r
 = 
EALREADY
; ;

306 : 
”r
 = 
EINVAL
;

309 ià(!
”r
)

310 
mb
->
’d
 = mb->
pos
 + 
Ën
;

312  
”r
;

314 
	}
}

317 
	gS¹p
::
	$uÅrÙeù
(
mbuf
 *
mb
)

319  
	`uÅrÙeù_št
(
mb
, 
çl£
);

320 
	}
}

323 
	gS¹p
::
	$uÅrÙeù_ù¾
(
mbuf
 *
mb
)

325  
	`uÅrÙeù_št
(
mb
, 
Œue
);

326 
	}
}

	@baresip/modules/gzrtp/srtp.h

6 #iâdeà
__SRTP_H


7 
	#__SRTP_H


	)

10 
	~<libz¹pıp/Z¹pC®lback.h
>

13 #ifdeà
GZRTP_USE_RE_SRTP


14 
	g¤
;

16 
şass
 
	gCry±oCÚ‹xt
;

17 
şass
 
	gCry±oCÚ‹xtCŒl
;

21 şas 
	cS¹p
 {

22 
	mpublic
:

23 
S¹p
(& 
”r
, cÚ¡ 
S¹pSeü‘_t
 *
£ü‘s
, 
EÇbËSecur™y
 
·¹
);

24 ~
S¹p
();

26 
´Ùeù
(
mbuf
 *
mb
);

27 
´Ùeù_ù¾
(
mbuf
 *
mb
);

28 
uÅrÙeù
(
mbuf
 *
mb
);

29 
uÅrÙeù_ù¾
(
mbuf
 *
mb
);

31 
	m´iv©e
:

32 
´Ùeù_št
(
mbuf
 *
mb
, 
boŞ
 
cÚŒŞ
);

33 
uÅrÙeù_št
(
mbuf
 *
mb
, 
boŞ
 
cÚŒŞ
);

35 #ifdeà
GZRTP_USE_RE_SRTP


36 
št32_t
 
	mm_auth_g_Ën
;

37 
¤
 *
	mm_¤
;

39 
Cry±oCÚ‹xt
 *
	mm_cc
;

40 
Cry±oCÚ‹xtCŒl
 *
	mm_cc_ù¾
;

	@baresip/modules/gzrtp/stream.cpp

6 
	~<¡dšt.h
>

7 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<b¬es.h
>

12 
	~<libz¹pıp/ZR.h
>

13 
	~<libz¹pıp/Z¹pS‹CÏss.h
>

15 
	~"£ssiÚ.h
"

16 
	~"¡»am.h
"

17 
	~"¤.h
"

22 
	#SRTP_ERR_BURST_THRESHOLD
 20

	)

26 
	mPRESZ
 = 36

30 
	epkt_ty³
 {

31 
	mPKT_TYPE_UNKNOWN
 = 0,

32 
	mPKT_TYPE_RTP
 = 1,

33 
	mPKT_TYPE_RTCP
 = 2,

34 
	mPKT_TYPE_ZRTP
 = 4

38 
pkt_ty³
 
	$g‘_·ck‘_ty³
(cÚ¡ 
mbuf
 *
mb
)

40 
ušt8_t
 
b
, 
±
;

41 
ušt32_t
 
magic
;

43 ià(
	`mbuf_g‘_Ëá
(
mb
) < 8)

44  
PKT_TYPE_UNKNOWN
;

46 
b
 = 
	`mbuf_buf
(
mb
)[0];

48 ià(127 < 
b
 && b < 192) {

49 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

50 ià(72 <ğ
±
 &&…t <= 76)

51  
PKT_TYPE_RTCP
;

53  
PKT_TYPE_RTP
;

56 
	`memıy
(&
magic
, &
	`mbuf_buf
(
mb
)[4], 4);

57 
magic
 = 
	`Áohl
(magic);

58 ià(
magic
 =ğ
ZRTP_MAGIC
)

59  
PKT_TYPE_ZRTP
;

62  
PKT_TYPE_UNKNOWN
;

63 
	}
}

66 
	gZRTPCÚfig
::
	$ZRTPCÚfig
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
cÚf_dœ
)

68 #ifdeà
GZRTP_USE_RE_SRTP


70 
z¹p
.
	`ş—r
();

72 
z¹p
.
	`addAlgo
(
HashAlgÜ™hm
, 
z¹pHashes
.
	`g‘ByName
(
s256
));

74 
z¹p
.
	`addAlgo
(
Ch”AlgÜ™hm
, 
z¹pSymCh”s
.
	`g‘ByName
(
«s3
));

75 
z¹p
.
	`addAlgo
(
Ch”AlgÜ™hm
, 
z¹pSymCh”s
.
	`g‘ByName
(
«s1
));

77 
z¹p
.
	`addAlgo
(
PubKeyAlgÜ™hm
, 
z¹pPubKeys
.
	`g‘ByName
(
ec25
));

78 
z¹p
.
	`addAlgo
(
PubKeyAlgÜ™hm
, 
z¹pPubKeys
.
	`g‘ByName
(
dh3k
));

79 
z¹p
.
	`addAlgo
(
PubKeyAlgÜ™hm
, 
z¹pPubKeys
.
	`g‘ByName
(
ec38
));

80 
z¹p
.
	`addAlgo
(
PubKeyAlgÜ™hm
, 
z¹pPubKeys
.
	`g‘ByName
(
dh2k
));

81 
z¹p
.
	`addAlgo
(
PubKeyAlgÜ™hm
, 
z¹pPubKeys
.
	`g‘ByName
(
muÉ
));

83 
z¹p
.
	`addAlgo
(
SasTy³
, 
z¹pSasTy³s
.
	`g‘ByName
(
b32
));

85 
z¹p
.
	`addAlgo
(
AuthL’gth
, 
z¹pAuthL’gths
.
	`g‘ByName
(
hs32
));

86 
z¹p
.
	`addAlgo
(
AuthL’gth
, 
z¹pAuthL’gths
.
	`g‘ByName
(
hs80
));

88 
z¹p
.
	`£tSnd¬dCÚfig
();

91 
	`¡r_nıy
(
ş›Á_id
, "baresip/gzrtp", (client_id));

93 
	`»_¢´štf
(
zid_f’ame
, (zid_filename),

94 "%s/gz¹p.zid", 
cÚf_dœ
);

96 
¡¬t_·¿Î–
 = 
Œue
;

97 ()
	`cÚf_g‘_boŞ
(
cÚf
, "z¹p_·¿Î–", &
¡¬t_·¿Î–
);

98 
	}
}

100 
	gSRTPSt
::
	$SRTPSt
(cÚ¡ 
SŒ—m
 *
¡
, 
boŞ
 
¤tı
, 
ušt64_t
 
th»shŞd
)

101 : 
	`m_¡»am
(
¡
)

102 , 
	`m_cÚŒŞ
(
¤tı
)

103 , 
	$m_th»shŞd
(
th»shŞd
)

105 
	`»£t
();

106 
	}
}

109 
	gSRTPSt
::
	$upd©e
(
»t_code
, 
boŞ
 
qu›t
)

111 cÚ¡ *
”r_msg
;

112 
ušt64_t
 *
bur¡
;

115 
»t_code
) {

117 ++
m_ok
;

118 
m_decode_bur¡
 = 0;

119 
m_auth_bur¡
 = 0;

120 
m_»¶ay_bur¡
 = 0;

122 
EBADMSG
:

123 ++
m_decode
;

124 
bur¡
 = &
m_decode_bur¡
;

125 
”r_msg
 = "packet decodeƒrror";

127 
EAUTH
:

128 ++
m_auth
;

129 
bur¡
 = &
m_auth_bur¡
;

130 
”r_msg
 = "authentication failed";

132 
EALREADY
:

133 ++
m_»¶ay
;

134 
bur¡
 = &
m_»¶ay_bur¡
;

135 
”r_msg
 = "replay check failed";

138 
	`w¬nšg
("zrtp: %s unprotect failed: %m\n",

139 (
m_cÚŒŞ
)? "SRTCP" : "SRTP", 
»t_code
);

143 ++(*
bur¡
);

144 ià(*
bur¡
 =ğ
m_th»shŞd
) {

145 *
bur¡
 = 0;

147 ià(!
qu›t
)

148 
	`w¬nšg
("zrtp: Stream <%s>: %s %s, %d…ackets\n",

149 
m_¡»am
->
	`medŸ_Çme
(),

150 (
m_cÚŒŞ
)? "SRTCP" : "SRTP",

151 
”r_msg
,

152 
m_th»shŞd
);

154 
	}
}

157 
	gSRTPSt
::
	$»£t
()

159 
m_ok
 = 0;

160 
m_decode
 = 0; 
m_auth
 = 0; 
m_»¶ay
 = 0;

161 
m_decode_bur¡
 = 0; 
m_auth_bur¡
 = 0; 
m_»¶ay_bur¡
 = 0;

162 
	}
}

165 
	gSŒ—m
::
	$SŒ—m
(& 
”r
, cÚ¡ 
ZRTPCÚfig
& 
cÚfig
, 
SessiÚ
 *
£ssiÚ
,

166 
udp_sock
 *
¹psock
, udp_sock *
¹ısock
,

167 
ušt32_t
 
loÿl_s¤c
, 
SŒ—mMedŸTy³
 
medŸ_ty³
)

168 : 
	`m_£ssiÚ
(
£ssiÚ
)

169 , 
	`m_z¹p
(
NULL
)

170 , 
	`m_¡¬‹d
(
çl£
)

171 , 
	`m_loÿl_s¤c
(
loÿl_s¤c
)

172 , 
	`m_³”_s¤c
(0)

173 , 
	`m_¹psock
(
NULL
)

174 , 
	`m_¹ısock
(
NULL
)

175 , 
	`m_uh_¹p
(
NULL
)

176 , 
	`m_uh_¹ı
(
NULL
)

177 , 
	`m_medŸ_ty³
(
medŸ_ty³
)

178 , 
	`m_£nd_¤
(
NULL
)

179 , 
	`m_»cv_¤
(
NULL
)

180 , 
	`m_¤_¡©
(
this
, 
çl£
, 
SRTP_ERR_BURST_THRESHOLD
)

181 , 
	$m_¤tı_¡©
(
this
, 
Œue
, 
SRTP_ERR_BURST_THRESHOLD
)

183 
”r
 = 0;

185 
m_z¹p_£q
 = 1;

186 
	`§_š™
(&
m_¿ddr
, 
AF_INET
);

187 
	`tmr_š™
(&
m_z¹p_tim”
);

189 
±h»ad_mu‹x©Œ_t
 
©Œ
;

190 
”r
 = 
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
);

191 
”r
 |ğ
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_ERRORCHECK
);

192 
”r
 |ğ
	`±h»ad_mu‹x_š™
(&
m_z¹p_mu‹x
, &
©Œ
);

193 
”r
 |ğ
	`±h»ad_mu‹x_š™
(&
m_£nd_mu‹x
, &
©Œ
);

194 ià(
”r
)

197 
Ïy”
 = 10;

198 ià(
¹psock
) {

199 
m_¹psock
 = (
udp_sock
 *)
	`mem_»f
(
¹psock
);

200 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
m_uh_¹p
, 
¹psock
, 
Ïy”
,

201 
SŒ—m
::
udp_h–³r_£nd_cb
,

202 
SŒ—m
::
udp_h–³r_»cv_cb
,

203 
this
);

205 ià(
¹ısock
 && (¹ısock !ğ
¹psock
)) {

206 
m_¹ısock
 = (
udp_sock
 *)
	`mem_»f
(
¹ısock
);

207 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
m_uh_¹ı
, 
¹ısock
, 
Ïy”
,

208 
SŒ—m
::
udp_h–³r_£nd_cb
,

209 
SŒ—m
::
udp_h–³r_»cv_cb
,

210 
this
);

212 ià(
”r
)

215 
ZIDCache
* 
zf
 = 
	`g‘ZidCacheIn¡ªû
();

216 ià(!
zf
->
	`isO³n
()) {

217 ià(
zf
->
	`İ’
((*)
cÚfig
.
zid_f’ame
) == -1) {

218 
	`w¬nšg
("zrtp: Couldn't open/create ZID file %s\n",

219 
cÚfig
.
zid_f’ame
);

220 
”r
 = 
ENOENT
;

225 
m_z¹p
 = 
Ãw
 
	`ZR
((
ušt8_t
 *)
zf
->
	`g‘Zid
(), 
this
, 
cÚfig
.
ş›Á_id
,

226 (
Z¹pCÚfigu»
 *)&
cÚfig
.
z¹p
, 
çl£
, false);

227 ià(!
m_z¹p
) {

228 
”r
 = 
ENOMEM
;

233 
	}
}

236 
	gSŒ—m
::~
	$SŒ—m
()

238 
	`¡İ
();

240 
d–‘e
 
m_z¹p
;

242 
	`mem_d”ef
(
m_uh_¹p
);

243 
	`mem_d”ef
(
m_uh_¹ı
);

244 
	`mem_d”ef
(
m_¹psock
);

245 
	`mem_d”ef
(
m_¹ısock
);

247 
	`±h»ad_mu‹x_de¡roy
(&
m_z¹p_mu‹x
);

248 
	`±h»ad_mu‹x_de¡roy
(&
m_£nd_mu‹x
);

250 
	`tmr_ÿnûl
(&
m_z¹p_tim”
);

251 
	}
}

254 
	gSŒ—m
::
	$¡¬t
(
SŒ—m
 *
ma¡”
)

256 ià(
	`¡¬‹d
())

257  
EPERM
;

259 ià(
ma¡”
) {

260 
ZR
 *
z¹p_ma¡”
;

262 
¡d
::
¡ršg
 
·¿ms
 =

263 
ma¡”
->
m_z¹p
->
	`g‘MuÉiSŒP¬ams
(&
z¹p_ma¡”
);

264 ià(
·¿ms
.
	`em±y
())

265  
EPROTO
;

267 
m_z¹p
->
	`£tMuÉiSŒP¬ams
(
·¿ms
, 
z¹p_ma¡”
);

270 
	`debug
("z¹p: S¹šg <%s> sŒ—m%s\n", 
	`medŸ_Çme
(),

271 (
m_z¹p
->
	`isMuÉiSŒ—m
())? " (multistream)" : "");

273 
m_¤_¡©
.
	`»£t
();

274 
m_¤tı_¡©
.
	`»£t
();

275 
m_§s
.
	`ş—r
();

276 
m_ch”s
.
	`ş—r
();

278 
m_¡¬‹d
 = 
Œue
;

279 
m_z¹p
->
	`¡¬tZ¹pEngše
();

282 
	}
}

285 
	gSŒ—m
::
	$¡İ
()

287 ià(!
	`¡¬‹d
())

290 
m_¡¬‹d
 = 
çl£
;

297 ià(!
m_z¹p
->
	`isMuÉiSŒ—m
(è&& 
m_»cv_¤
 && 
m_¤_¡©
.
	`ok
() < 20) {

299 
	`debug
("zrtp: Stream <%s>:„eceivedoo few valid SRTP "

301 
	`medŸ_Çme
(), 
m_¤_¡©
.
	`ok
());

303 
m_z¹p
->
	`£tRs2V®id
();

306 
	`debug
("z¹p: Stİpšg <%s> sŒ—m\n", 
	`medŸ_Çme
());

308 
m_z¹p
->
	`¡İZ¹p
();

310 
	`±h»ad_mu‹x_lock
(&
m_£nd_mu‹x
);

311 
d–‘e
 
m_£nd_¤
;

312 
m_£nd_¤
 = 
NULL
;

313 
	`±h»ad_mu‹x_uÆock
(&
m_£nd_mu‹x
);

315 
d–‘e
 
m_»cv_¤
;

316 
m_»cv_¤
 = 
NULL
;

318 
	`debug
("z¹p: SŒ—m <%s> stİ³d\n", 
	`medŸ_Çme
());

319 
	}
}

322 
	gSŒ—m
::
	$sdp_’code
(
sdp_medŸ
 *
sdpm
)

326 
	}
}

329 
	gSŒ—m
::
	$sdp_decode
(cÚ¡ 
sdp_medŸ
 *
sdpm
)

331 ià(
	`§_is£t
(
	`sdp_medŸ_¿ddr
(
sdpm
), 
SA_ALL
)) {

332 
m_¿ddr
 = *
	`sdp_medŸ_¿ddr
(
sdpm
);

337 
	}
}

340 
boŞ
 
	gSŒ—m
::
	$udp_h–³r_£nd_cb
(*
”r
, 
§
 *
¤c
, 
mbuf
 *
mb
,

341 *
¬g
)

343 
SŒ—m
 *
¡
 = (SŒ—m *)
¬g
;

345 ià(
¡
)

346  
¡
->
	`udp_h–³r_£nd
(
”r
, 
¤c
, 
mb
);

348  
çl£
;

349 
	}
}

352 
boŞ
 
	gSŒ—m
::
	$udp_h–³r_£nd
(*
”r
, 
§
 *
¤c
, 
mbuf
 *
mb
)

354 
boŞ
 
»t
 = 
çl£
;

355 
pkt_ty³
 
±y³
 = 
	`g‘_·ck‘_ty³
(
mb
);

356 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

357 
»¼
 = 0;

359 
	`±h»ad_mu‹x_lock
(&
m_£nd_mu‹x
);

361 ià(
±y³
 =ğ
PKT_TYPE_RTCP
 && 
m_£nd_¤
 && 
Ën
 > 8) {

363 
»¼
 = 
m_£nd_¤
->
	`´Ùeù_ù¾
(
mb
);

365 ià(
±y³
 =ğ
PKT_TYPE_RTP
 && 
m_£nd_¤
 &&

366 
Ën
 > 
RTP_HEADER_SIZE
) {

368 
»¼
 = 
m_£nd_¤
->
	`´Ùeù
(
mb
);

371 
out
;

373 ià(
»¼
) {

374 
	`w¬nšg
("zrtp:…rotect/protect_ctrl failed (len=%u): %m\n",

375 
Ën
, 
»¼
);

377 ià(
»¼
 =ğ
ENOMEM
)

378 *
”r
 = 
»¼
;

380 
»t
 = 
Œue
;

383 
out
:

384 
	`±h»ad_mu‹x_uÆock
(&
m_£nd_mu‹x
);

386  
»t
;

387 
	}
}

390 
boŞ
 
	gSŒ—m
::
	$udp_h–³r_»cv_cb
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

392 
SŒ—m
 *
¡
 = (SŒ—m *)
¬g
;

394 ià(
¡
)

395  
¡
->
	`udp_h–³r_»cv
(
¤c
, 
mb
);

397  
çl£
;

398 
	}
}

401 
boŞ
 
	gSŒ—m
::
	$udp_h–³r_»cv
(
§
 *
¤c
, 
mbuf
 *
mb
)

403 ià(!
	`¡¬‹d
())

404  
çl£
;

406 
pkt_ty³
 
±y³
 = 
	`g‘_·ck‘_ty³
(
mb
);

407 
”r
 = 0;

409 ià(
±y³
 =ğ
PKT_TYPE_RTCP
 && 
m_»cv_¤
) {

411 
”r
 = 
m_»cv_¤
->
	`uÅrÙeù_ù¾
(
mb
);

413 
m_¤tı_¡©
.
	`upd©e
(
”r
);

415 ià(
±y³
 =ğ
PKT_TYPE_RTP
 && 
m_»cv_¤
) {

417 
”r
 = 
m_»cv_¤
->
	`uÅrÙeù
(
mb
);

419 
m_¤_¡©
.
	`upd©e
(
”r
);

421 ià(!
”r
) {

425 ià(
m_z¹p
->
	`šS‹
(
Wa™CÚfAck
))

426 
m_z¹p
->
	`cÚf2AckSecu»
();

429 ià(
±y³
 =ğ
PKT_TYPE_ZRTP
) {

430  
	`»cv_z¹p
(
mb
);

433  
çl£
;

435 ià(
”r
)

437  
Œue
;

439  
çl£
;

440 
	}
}

444 
	#ZRTP_MIN_PACKET_LENGTH
 (
RTP_HEADER_SIZE
 + 4 + 8 + 4)

	)

446 
boŞ
 
	gSŒ—m
::
	$»cv_z¹p
(
mbuf
 *
mb
)

448 
ušt32_t
 
üc32
;

449 
ušt8_t
 *
buf
 = 
	`mbuf_buf
(
mb
);

450 
size_t
 
size
 = 
	`mbuf_g‘_Ëá
(
mb
);

452 ià(
size
 < 
ZRTP_MIN_PACKET_LENGTH
) {

453 
	`w¬nšg
("zrtp: incoming…acket size (%d) isoo small\n",

454 
size
);

455  
çl£
;

459 
	`memıy
(&
üc32
, 
buf
 + 
size
 - 4, 4);

460 
üc32
 = 
	`Áohl
(crc32);

461 ià(!
	`z¹pCheckCksum
(
buf
, 
size
 - 4, 
üc32
)) {

462 
	`£ndInfo
(
GnuZ¹pCodes
::
W¬nšg
,

463 
GnuZ¹pCodes
::
W¬nšgCRCmism©ch
);

464  
çl£
;

468 
	`memıy
(&
m_³”_s¤c
, 
buf
 + 8, 4);

469 
m_³”_s¤c
 = 
	`Áohl
(m_peer_ssrc);

471 
m_z¹p
->
	`´oûssZ¹pMes§ge
(
buf
 + 
RTP_HEADER_SIZE
, 
m_³”_s¤c
, 
size
);

473  
Œue
;

474 
	}
}

477 
	gSŒ—m
::
	$v”ify_§s
(
boŞ
 
v”ify
)

479 ià(
v”ify
)

480 
m_z¹p
->
	`SASV”if›d
();

482 
m_z¹p
->
	`»£tSASV”if›d
();

483 
	}
}

486 
boŞ
 
	gSŒ—m
::
	$§s_v”if›d
()

488  
m_z¹p
->
	`isSASV”if›d
();

489 
	}
}

497 
št32_t
 
	gSŒ—m
::
	$£ndD©aZRTP
(cÚ¡ 
ušt8_t
* 
d©a
, 
št32_t
 
Ëngth
)

499 
mbuf
 *
mb
;

500 
ušt8_t
 *
üc_buf
;

501 
ušt32_t
 
üc32
;

502 
size_t
 
¡¬t_pos
 = 
PRESZ
;

503 
”r
 = 0;

505 ià(!
	`§_is£t
(&
m_¿ddr
, 
SA_ALL
))

508 
mb
 = 
	`mbuf_®loc
(
¡¬t_pos
 + 
RTP_HEADER_SIZE
 + 
Ëngth
);

509 ià(!
mb
)

512 
	`mbuf_£t_’d
(
mb
, 
¡¬t_pos
);

513 
	`mbuf_£t_pos
(
mb
, 
¡¬t_pos
);

514 
üc_buf
 = 
	`mbuf_buf
(
mb
);

517 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 0x10);

518 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

519 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
m_z¹p_£q
++));

520 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
ZRTP_MAGIC
));

521 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
m_loÿl_s¤c
));

524 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
d©a
, 
Ëngth
 - 4);

527 
üc32
 = 
	`z¹pG’”©eCksum
(
üc_buf
, 
RTP_HEADER_SIZE
 + 
Ëngth
 - 4);

528 
üc32
 = 
	`z¹pEndCksum
(crc32);

531 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
üc32
));

532 ià(
”r
)

533 
out
;

536 
	`mbuf_£t_pos
(
mb
, 
¡¬t_pos
);

537 
”r
 = 
	`udp_£nd_h–³r
(
m_¹psock
, &
m_¿ddr
, 
mb
, 
m_uh_¹p
);

538 ià(
”r
)

539 
	`w¬nšg
("z¹p: udp_£nd_h–³r: %m\n", 
”r
);

541 
out
:

542 
	`mem_d”ef
(
mb
);

544  (
”r
 == 0);

545 
	}
}

548 
	gSŒ—m
::
	$z¹p_tim”_cb
(*
¬g
)

550 
SŒ—m
 *
s
 = (SŒ—m *)
¬g
;

552 
s
->
m_z¹p
->
	`´oûssTimeout
();

553 
	}
}

556 
št32_t
 
	gSŒ—m
::
	$aùiv©eTim”
(
št32_t
 
time
)

558 
	`tmr_¡¬t
(&
m_z¹p_tim”
, 
time
, &
SŒ—m
::
z¹p_tim”_cb
, 
this
);

560 
	}
}

563 
št32_t
 
	gSŒ—m
::
	$ÿnûlTim”
()

565 
	`tmr_ÿnûl
(&
m_z¹p_tim”
);

567 
	}
}

570 
	gSŒ—m
::
	$£ndInfo
(
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
, 
št32_t
 
subCode
)

572 
	`´št_mes§ge
(
£v”™y
, 
subCode
);

574 ià(
£v”™y
 =ğ
GnuZ¹pCodes
::
Info
) {

575 ià(
subCode
 =ğ
GnuZ¹pCodes
::
InfoSecu»S‹On
) {

576 
m_£ssiÚ
->
	`Ú_£cu»
(
this
);

578 ià(
subCode
 =ğ
GnuZ¹pCodes
::
InfoH–loReûived
 &&

579 !
m_z¹p
->
	`isMuÉiSŒ—m
()) {

581 
m_£ssiÚ
->
	`»que¡_ma¡”
(
this
);

584 
	}
}

587 
boŞ
 
	gSŒ—m
::
	$¤Seü‘sR—dy
(
S¹pSeü‘_t
* 
£ü‘s
, 
EÇbËSecur™y
 
·¹
)

589 
S¹p
 *
s
;

590 
”r
 = 0;

592 
	`debug
("zrtp: Stream <%s>: secrets‡re„eady for %s\n",

593 
	`medŸ_Çme
(),

594 (
·¹
 =ğ
FÜS’d”
)? "sender" : "receiver");

596 
s
 = 
Ãw
 
	`S¹p
(
”r
, 
£ü‘s
, 
·¹
);

597 ià(!
s
 || 
”r
) {

598 
	`w¬nšg
("zrtp: Stream <%s>: Srtp creation failed: %m\n",

599 
	`medŸ_Çme
(), 
”r
);

600 
d–‘e
 
s
;

601  
çl£
;

604 ià(
·¹
 =ğ
FÜS’d”
) {

605 
	`±h»ad_mu‹x_lock
(&
m_£nd_mu‹x
);

606 
m_£nd_¤
 = 
s
;

607 
	`±h»ad_mu‹x_uÆock
(&
m_£nd_mu‹x
);

609 ià(
·¹
 =ğ
FÜReûiv”
)

610 
m_»cv_¤
 = 
s
;

612  
çl£
;

614  
Œue
;

615 
	}
}

618 
	gSŒ—m
::
	$¤Seü‘sOff
(
EÇbËSecur™y
 
·¹
)

620 
	`debug
("zrtp: Stream <%s>: secrets‡re off for %s\n",

621 
	`medŸ_Çme
(),

622 (
·¹
 =ğ
FÜS’d”
)? "sender" : "receiver");

624 ià(
·¹
 =ğ
FÜS’d”
) {

625 
	`±h»ad_mu‹x_lock
(&
m_£nd_mu‹x
);

626 
d–‘e
 
m_£nd_¤
;

627 
m_£nd_¤
 = 
NULL
;

628 
	`±h»ad_mu‹x_uÆock
(&
m_£nd_mu‹x
);

631 ià(
·¹
 =ğ
FÜReûiv”
) {

632 
d–‘e
 
m_»cv_¤
;

633 
m_»cv_¤
 = 
NULL
;

635 
	}
}

638 
	gSŒ—m
::
	$¤Seü‘sOn
(
¡d
::
¡ršg
 
c
, std::¡ršg 
s
, 
boŞ
 
v”if›d
)

640 
m_§s
 = 
s
;

641 
m_ch”s
 = 
c
;

643 ià(
s
.
	`em±y
()) {

644 
	`šfo
("zrtp: Stream <%s> isƒncrypted (%s)\n",

645 
	`medŸ_Çme
(), 
c
.
	`c_¡r
());

648 
	`šfo
("zrtp: Stream <%s> isƒncrypted (%s), "

650 
	`medŸ_Çme
(), 
c
.
	`c_¡r
(), 
s
.c_str(),

651 (
v”if›d
)? "verified" : "NOT VERIFIED");

652 ià(!
v”if›d
)

653 
	`w¬nšg
("zrtp: SAS is‚ot verified,ype "

655 
m_£ssiÚ
->
	`id
());

657 
	}
}

660 
	gSŒ—m
::
	$hªdËGoCË¬
()

662 
	}
}

665 
SŒ—m
::
	$z¹pNegÙŸtiÚFaed
(
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
,

666 
št32_t
 
subCode
)

668 
	}
}

671 
	gSŒ—m
::
	$z¹pNÙSuµOth”
()

673 
	}
}

676 
SŒ—m
::
	$synchEÁ”
()

678 
	`±h»ad_mu‹x_lock
(&
m_z¹p_mu‹x
);

679 
	}
}

682 
	gSŒ—m
::
	$synchL—ve
()

684 
	`±h»ad_mu‹x_uÆock
(&
m_z¹p_mu‹x
);

685 
	}
}

688 
	gSŒ—m
::
	$z¹pAskEÄŞlm’t
(
GnuZ¹pCodes
::
InfoEÄŞlm’t
 
šfo
)

690 
	}
}

693 
SŒ—m
::
	$z¹pInfÜmEÄŞlm’t
(
GnuZ¹pCodes
::
InfoEÄŞlm’t
 
šfo
)

695 
	}
}

698 
SŒ—m
::
	$signSAS
(
ušt8_t
* 
§sHash
)

700 
	}
}

703 
boŞ
 
SŒ—m
::
	$checkSASSigÇtu»
(
ušt8_t
* 
§sHash
)

705  
Œue
;

706 
	}
}

	@baresip/modules/gzrtp/stream.h

6 #iâdeà
__STREAM_H


7 
	#__STREAM_H


	)

10 
	~<libz¹pıp/ZR.h
>

13 
	eSŒ—mMedŸTy³
 {

14 
	mMT_UNKNOWN
 = 0,

15 
	mMT_AUDIO
,

16 
	mMT_VIDEO
,

17 
	mMT_TEXT
,

18 
	mMT_APPLICATION
,

19 
	mMT_MESSAGE


23 şas 
	cZRTPCÚfig
 {

24 
	mpublic
:

25 
ZRTPCÚfig
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
cÚf_dœ
);

26 
	m´iv©e
:

27 
ä›nd
 
şass
 
SŒ—m
;

28 
ä›nd
 
şass
 
	mSessiÚ
;

30 
Z¹pCÚfigu»
 
	mz¹p
;

32 
	mş›Á_id
[
CLIENT_ID_SIZE
 + 1];

33 
	mzid_f’ame
[256];

35 
boŞ
 
	m¡¬t_·¿Î–
;

39 
şass
 
	gSŒ—m
;

41 şas 
	cSRTPSt
 {

42 
	mpublic
:

43 
SRTPSt
(cÚ¡ 
SŒ—m
 *
¡
, 
boŞ
 
¤tı
, 
ušt64_t
 
th»shŞd
);

44 
upd©e
(
»t_code
, 
boŞ
 
qu›t
 = 
çl£
);

45 
»£t
();

46 
ušt64_t
 
	$ok
(è{  
m_ok
; }

47 
´iv©e
:

48 cÚ¡ 
SŒ—m
 *
m_¡»am
;

49 cÚ¡ 
boŞ
 
m_cÚŒŞ
;

50 cÚ¡ 
ušt64_t
 
m_th»shŞd
;

51 
ušt64_t
 
m_ok
, 
m_decode
, 
m_auth
, 
m_»¶ay
;

52 
ušt64_t
 
m_decode_bur¡
, 
m_auth_bur¡
, 
m_»¶ay_bur¡
;

53 
	}
};

56 
şass
 
	gSessiÚ
;

57 
şass
 
	gS¹p
;

59 şas 
	cSŒ—m
 : 
public
 
Z¹pC®lback
 {

60 
public
:

61 
SŒ—m
(& 
”r
, cÚ¡ 
ZRTPCÚfig
& 
cÚfig
, 
SessiÚ
 *
£ssiÚ
,

62 
udp_sock
 *
¹psock
, udp_sock *
¹ısock
,

63 
ušt32_t
 
loÿl_s¤c
, 
SŒ—mMedŸTy³
 
medŸ_ty³
);

65 
	mvœtu®
 ~
SŒ—m
();

67 
¡¬t
(
SŒ—m
 *
ma¡”
);

68 
¡İ
();

69 
boŞ
 
	$¡¬‹d
(è{  
m_¡¬‹d
; }

71 
	`sdp_’code
(
sdp_medŸ
 *
sdpm
);

72 
	`sdp_decode
(cÚ¡ 
sdp_medŸ
 *
sdpm
);

74 cÚ¡ *
	$medŸ_Çme
() const;

76 cÚ¡ *
	$g‘_§s
(ècÚ¡ {  
m_§s
.
	`c_¡r
(); 
	}
}

77 cÚ¡ *
	$g‘_ch”s
(ècÚ¡ {  
m_ch”s
.
	`c_¡r
(); 
	}
}

78 
boŞ
 
§s_v”if›d
();

79 
v”ify_§s
(
boŞ
 
v”ify
);

81 
	g´iv©e
:

82 
z¹p_tim”_cb
(*
¬g
);

83 
boŞ
 
udp_h–³r_£nd_cb
(*
”r
, 
§
 *
¤c
,

84 
mbuf
 *
mb
, *
¬g
);

85 
boŞ
 
udp_h–³r_»cv_cb
(
§
 *
¤c
, 
mbuf
 *
mb
,

86 *
¬g
);

88 
boŞ
 
udp_h–³r_£nd
(*
”r
, 
§
 *
¤c
, 
mbuf
 *
mb
);

89 
boŞ
 
udp_h–³r_»cv
(
§
 *
¤c
, 
mbuf
 *
mb
);

90 
boŞ
 
»cv_z¹p
(
mbuf
 *
mb
);

92 
´št_mes§ge
(
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
,

93 
št32_t
 
subcode
);

95 
SessiÚ
 *
	gm_£ssiÚ
;

96 
ZR
 *
	gm_z¹p
;

97 
boŞ
 
	gm_¡¬‹d
;

98 
tmr
 
	gm_z¹p_tim”
;

99 
±h»ad_mu‹x_t
 
	gm_z¹p_mu‹x
;

100 
ušt16_t
 
	gm_z¹p_£q
;

101 
ušt32_t
 
	gm_loÿl_s¤c
, 
	gm_³”_s¤c
;

102 
§
 
	gm_¿ddr
;

103 
udp_sock
 *
	gm_¹psock
, *
	gm_¹ısock
;

104 
udp_h–³r
 *
	gm_uh_¹p
;

105 
udp_h–³r
 *
	gm_uh_¹ı
;

106 
SŒ—mMedŸTy³
 
	gm_medŸ_ty³
;

107 
S¹p
 *
	gm_£nd_¤
, *
	gm_»cv_¤
;

108 
±h»ad_mu‹x_t
 
	gm_£nd_mu‹x
;

109 
SRTPSt
 
	gm_¤_¡©
, 
	gm_¤tı_¡©
;

110 
	g¡d
::
¡ršg
 
m_§s
, 
	gm_ch”s
;

112 
	g´Ùeùed
:

113 
vœtu®
 
št32_t
 
£ndD©aZRTP
(cÚ¡ 
ušt8_t
* 
d©a
, iÁ32_ˆ
Ëngth
);

114 
vœtu®
 
št32_t
 
aùiv©eTim”
(št32_ˆ
time
);

115 
vœtu®
 
št32_t
 
ÿnûlTim”
();

116 
vœtu®
 
£ndInfo
(
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
,

117 
št32_t
 
subCode
);

118 
vœtu®
 
boŞ
 
¤Seü‘sR—dy
(
S¹pSeü‘_t
* 
£ü‘s
,

119 
EÇbËSecur™y
 
·¹
);

120 
vœtu®
 
¤Seü‘sOff
(
EÇbËSecur™y
 
·¹
);

121 
vœtu®
 
¤Seü‘sOn
(
¡d
::
¡ršg
 
c
, std::¡ršg 
s
,

122 
boŞ
 
v”if›d
);

123 
vœtu®
 
hªdËGoCË¬
();

124 
vœtu®
 
z¹pNegÙŸtiÚFaed
(

125 
GnuZ¹pCodes
::
Mes§geSev”™y
 
£v”™y
,

126 
št32_t
 
subCode
);

127 
vœtu®
 
z¹pNÙSuµOth”
();

128 
vœtu®
 
synchEÁ”
();

129 
vœtu®
 
synchL—ve
();

130 
vœtu®
 
z¹pAskEÄŞlm’t
(
GnuZ¹pCodes
::
InfoEÄŞlm’t
 
šfo
);

131 
vœtu®
 
z¹pInfÜmEÄŞlm’t
(
GnuZ¹pCodes
::
InfoEÄŞlm’t
 
šfo
);

132 
vœtu®
 
signSAS
(
ušt8_t
* 
§sHash
);

133 
vœtu®
 
boŞ
 
checkSASSigÇtu»
(
ušt8_t
* 
§sHash
);

	@baresip/modules/h265/decode.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~<libavut/pixdesc.h
>

11 
	~<libavcodec/avcodec.h
>

12 
	~"h265.h
"

15 #ià
LIBAVUTIL_VERSION_MAJOR
 < 52

16 
	#AV_PIX_FMT_YUV420P
 
PIX_FMT_YUV420P


	)

21 
	mFU_HDR_SIZE
 = 1

25 
	mDECODE_MAXSZ
 = 524288,

29 
	sfu
 {

30 
	ms
:1;

31 
	me
:1;

32 
	mty³
:6;

35 
	sviddec_¡©e
 {

36 
AVCodecCÚ‹xt
 *
	mùx
;

37 
AVF¿me
 *
	mpiù
;

38 
mbuf
 *
	mmb
;

39 
size_t
 
	mäag_¡¬t
;

40 
boŞ
 
	mäag
;

41 
ušt16_t
 
	mäag_£q
;

45 
	$de¡ruùÜ
(*
¬g
)

47 
viddec_¡©e
 *
vds
 = 
¬g
;

49 ià(
vds
->
ùx
) {

50 
	`avcodec_şo£
(
vds
->
ùx
);

51 
	`av_ä“
(
vds
->
ùx
);

54 ià(
vds
->
più
)

55 
	`av_ä“
(
vds
->
più
);

57 
	`mem_d”ef
(
vds
->
mb
);

58 
	}
}

61 
	$h265_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

62 cÚ¡ *
fm
)

64 
viddec_¡©e
 *
vds
;

65 
AVCodec
 *
codec
;

66 
”r
 = 0;

67 ()
vc
;

68 ()
fm
;

70 ià(!
vd¥
)

71  
EINVAL
;

73 
vds
 = *
vd¥
;

75 ià(
vds
)

79 
codec
 = 
	`avcodec_fšd_decod”
(
AV_CODEC_ID_HEVC
);

80 ià(!
codec
) {

81 
	`w¬nšg
("h265: could‚ot find H265 decoder\n");

82  
ENOSYS
;

85 
vds
 = 
	`mem_z®loc
((*vds), 
de¡ruùÜ
);

86 ià(!
vds
)

87  
ENOMEM
;

89 
vds
->
mb
 = 
	`mbuf_®loc
(1024);

90 ià(!
vds
->
mb
) {

91 
”r
 = 
ENOMEM
;

92 
out
;

95 
vds
->
più
 = 
	`av_äame_®loc
();

96 ià(!
vds
->
più
) {

97 
”r
 = 
ENOMEM
;

98 
out
;

101 
vds
->
ùx
 = 
	`avcodec_®loc_cÚ‹xt3
(
codec
);

102 ià(!
vds
->
ùx
) {

103 
”r
 = 
ENOMEM
;

104 
out
;

107 ià(
	`avcodec_İ’2
(
vds
->
ùx
, 
codec
, 
NULL
) < 0) {

108 
”r
 = 
ENOMEM
;

109 
out
;

112 
out
:

113 ià(
”r
)

114 
	`mem_d”ef
(
vds
);

116 *
vd¥
 = 
vds
;

118  
”r
;

119 
	}
}

122 
šlše
 
	$fu_decode
(
fu
 *fu, 
mbuf
 *
mb
)

124 
ušt8_t
 
v
;

126 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

127  
EBADMSG
;

129 
v
 = 
	`mbuf_»ad_u8
(
mb
);

131 
fu
->
s
 = 
v
>>7 & 0x1;

132 
fu
->
e
 = 
v
>>6 & 0x1;

133 
fu
->
ty³
 = 
v
>>0 & 0x3f;

136 
	}
}

139 
šlše
 
št16_t
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

141  (
št16_t
)(
y
 - 
x
);

142 
	}
}

145 
šlše
 
	$äagm’t_»wšd
(
viddec_¡©e
 *
vds
)

147 
vds
->
mb
->
pos
 = vds->
äag_¡¬t
;

148 
vds
->
mb
->
’d
 = vds->
äag_¡¬t
;

149 
	}
}

152 
	$h265_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

153 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

155 cÚ¡ 
ušt8_t
 
Çl_£q
[3] = {0, 0, 1};

156 
”r
, 
»t
, 
gÙ_piùu»
, 
i
;

157 
h265_Çl
 
hdr
;

158 
AVPack‘
 
avpkt
;

159 
vidfmt
 
fmt
;

161 ià(!
vds
 || !
äame
 || !
šŒa
 || !
mb
)

162  
EINVAL
;

164 *
šŒa
 = 
çl£
;

166 
”r
 = 
	`h265_Çl_decode
(&
hdr
, 
	`mbuf_buf
(
mb
));

167 ià(
”r
)

168  
”r
;

170 
	`mbuf_advªû
(
mb
, 
H265_HDR_SIZE
);

173 
	`debug
("h265: decode: %sype=%2d %s\n",

174 
	`h265_is_keyäame
(
hdr
.
Çl_un™_ty³
) ? "<KEY>" : " ",

175 
hdr
.
Çl_un™_ty³
,

176 
	`h265_Çlun™_Çme
(
hdr
.
Çl_un™_ty³
));

179 ià(
vds
->
äag
 && 
hdr
.
Çl_un™_ty³
 !ğ
H265_NAL_FU
) {

180 
	`debug
("h265:†ost fragments; discarding…revious NAL\n");

181 
	`äagm’t_»wšd
(
vds
);

182 
vds
->
äag
 = 
çl£
;

186 ià(0 <ğ
hdr
.
Çl_un™_ty³
 && hdr.nal_unit_type <= 40) {

188 ià(
	`h265_is_keyäame
(
hdr
.
Çl_un™_ty³
))

189 *
šŒa
 = 
Œue
;

191 
mb
->
pos
 -ğ
H265_HDR_SIZE
;

193 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
Çl_£q
, 3);

194 
”r
 |ğ
	`mbuf_wr™e_mem
(
vds
->
mb
, 
	`mbuf_buf
(mb),
	`mbuf_g‘_Ëá
(mb));

195 ià(
”r
)

196 
out
;

198 ià(
H265_NAL_FU
 =ğ
hdr
.
Çl_un™_ty³
) {

200 
fu
 fu;

202 
”r
 = 
	`fu_decode
(&
fu
, 
mb
);

203 ià(
”r
)

204  
”r
;

206 ià(
fu
.
s
) {

207 ià(
	`h265_is_keyäame
(
fu
.
ty³
))

208 *
šŒa
 = 
Œue
;

210 ià(
vds
->
äag
) {

211 
	`debug
("h265:†ost fragments; ignoring NAL\n");

212 
	`äagm’t_»wšd
(
vds
);

215 
vds
->
äag_¡¬t
 = vds->
mb
->
pos
;

216 
vds
->
äag
 = 
Œue
;

218 
hdr
.
Çl_un™_ty³
 = 
fu
.
ty³
;

220 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
Çl_£q
, 3);

221 
”r
 = 
	`h265_Çl_’code_mbuf
(
vds
->
mb
, &
hdr
);

222 ià(
”r
)

223 
out
;

226 ià(!
vds
->
äag
) {

227 
	`debug
("h265: ignoring fragment\n");

231 ià(
	`£q_diff
(
vds
->
äag_£q
, 
£q
) != 1) {

232 
	`debug
("h265:†ost fragments detected\n");

233 
	`äagm’t_»wšd
(
vds
);

234 
vds
->
äag
 = 
çl£
;

239 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
	`mbuf_buf
(mb), 
	`mbuf_g‘_Ëá
(mb));

240 ià(
”r
)

241 
out
;

243 ià(
fu
.
e
)

244 
vds
->
äag
 = 
çl£
;

246 
vds
->
äag_£q
 = 
£q
;

249 
	`w¬nšg
("h265: unknown NALype %u (%s) [%zu bytes]\n",

250 
hdr
.
Çl_un™_ty³
,

251 
	`h265_Çlun™_Çme
(
hdr
.
Çl_un™_ty³
),

252 
	`mbuf_g‘_Ëá
(
mb
));

253  
EPROTO
;

256 ià(!
m¬k”
) {

258 ià(
vds
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

259 
	`w¬nšg
("h265: decode buffer sizeƒxceeded\n");

260 
”r
 = 
ENOMEM
;

261 
out
;

267 ià(
vds
->
äag
) {

268 
”r
 = 
EPROTO
;

269 
out
;

272 
	`av_š™_·ck‘
(&
avpkt
);

273 
avpkt
.
d©a
 = 
vds
->
mb
->
buf
;

274 
avpkt
.
size
 = ()
vds
->
mb
->
’d
;

276 #ià
LIBAVCODEC_VERSION_INT
 >= ((57<<16)+(37<<8)+100)

278 
»t
 = 
	`avcodec_£nd_·ck‘
(
vds
->
ùx
, &
avpkt
);

279 ià(
»t
 < 0) {

280 
”r
 = 
EBADMSG
;

281 
out
;

284 
»t
 = 
	`avcodec_»ûive_äame
(
vds
->
ùx
, vds->
più
);

285 ià(
»t
 < 0) {

286 
”r
 = 
EBADMSG
;

287 
out
;

290 
gÙ_piùu»
 = 
Œue
;

293 
»t
 = 
	`avcodec_decode_video2
(
vds
->
ùx
, vds->
più
, &
gÙ_piùu»
, &
avpkt
);

294 ià(
»t
 < 0) {

295 
	`debug
("h265: decodeƒrror\n");

296 
”r
 = 
EPROTO
;

297 
out
;

301 ià(!
gÙ_piùu»
) {

303 
out
;

306 
vds
->
più
->
fÜm©
) {

308 
AV_PIX_FMT_YUV420P
:

309 
fmt
 = 
VID_FMT_YUV420P
;

312 
AV_PIX_FMT_YUV444P
:

313 
fmt
 = 
VID_FMT_YUV444P
;

317 
	`w¬nšg
("h265: decode: bad…ixel format (%i) (%s)\n",

318 
vds
->
più
->
fÜm©
,

319 
	`av_g‘_pix_fmt_Çme
(
vds
->
più
->
fÜm©
));

320 
out
;

323 
i
=0; i<4; i++) {

324 
äame
->
d©a
[
i
] = 
vds
->
più
->data[i];

325 
äame
->
lšesize
[
i
] = 
vds
->
più
->linesize[i];

328 
äame
->
size
.
w
 = 
vds
->
ùx
->
width
;

329 
äame
->
size
.
h
 = 
vds
->
ùx
->
height
;

330 
äame
->
fmt
 = fmt;

332 
out
:

333 
	`mbuf_»wšd
(
vds
->
mb
);

334 
vds
->
äag
 = 
çl£
;

336  
”r
;

337 
	}
}

	@baresip/modules/h265/encode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<x265.h
>

12 
	~"h265.h
"

15 
	svid’c_¡©e
 {

16 
vidsz
 
	msize
;

17 
x265_·¿m
 *
	m·¿m
;

18 
x265_’cod”
 *
	mx265
;

19 
št64_t
 
	m±s
;

20 
	mås
;

21 
	mb™¿‹
;

22 
	mpktsize
;

23 
vid’c_·ck‘_h
 *
	mpkth
;

24 *
	m¬g
;

28 
	$de¡ruùÜ
(*
¬g
)

30 
vid’c_¡©e
 *
¡
 = 
¬g
;

32 ià(
¡
->
x265
)

33 
	`x265_’cod”_şo£
(
¡
->
x265
);

34 ià(
¡
->
·¿m
)

35 
	`x265_·¿m_ä“
(
¡
->
·¿m
);

36 
	}
}

39 
	$£t_·¿ms
(
vid’c_¡©e
 *
¡
, 
ås
, 
b™¿‹
)

41 
¡
->
·¿m
 = 
	`x265_·¿m_®loc
();

42 ià(!
¡
->
·¿m
) {

43 
	`w¬nšg
("h265: x265_param_alloc failed\n");

44  
ENOMEM
;

47 
	`x265_·¿m_deçuÉ
(
¡
->
·¿m
);

49 ià(0 !ğ
	`x265_·¿m_­¶y_´ofe
(
¡
->
·¿m
, "main")) {

50 
	`w¬nšg
("h265: x265_param_apply_profile failed\n");

51  
EINVAL
;

54 ià(0 !ğ
	`x265_·¿m_deçuÉ_´e£t
(
¡
->
·¿m
,

57 
	`w¬nšg
("h265: x265_param_default_presetƒrror\n");

58  
EINVAL
;

61 
¡
->
·¿m
->
åsNum
 = 
ås
;

62 
¡
->
·¿m
->
åsD’om
 = 1;

65 
¡
->
·¿m
->
bR•—tH—d”s
 = 1;

68 
¡
->
·¿m
->
rc
.
¿‹CÚŒŞMode
 = 
X265_RC_CRF
;

69 
¡
->
·¿m
->
rc
.
b™¿‹
 = bitrate / 1000;

70 
¡
->
·¿m
->
rc
.
vbvMaxB™¿‹
 = 
b™¿‹
 / 1000;

71 
¡
->
·¿m
->
rc
.
vbvBufãrSize
 = 2 * 
b™¿‹
 / 
ås
;

74 
	}
}

77 
	$h265_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

78 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

79 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

81 
vid’c_¡©e
 *
ves
;

82 
”r
 = 0;

83 ()
fm
;

85 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < 3 || !
pkth
)

86  
EINVAL
;

88 
ves
 = *
ve¥
;

90 ià(!
ves
) {

92 
ves
 = 
	`mem_z®loc
((*ves), 
de¡ruùÜ
);

93 ià(!
ves
)

94  
ENOMEM
;

96 *
ve¥
 = 
ves
;

99 ià(
ves
->
x265
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

100 
ves
->
pktsize
 !ğ
´m
->pktsize ||

101 
ves
->
ås
 !ğ
´m
->fps)) {

103 
	`x265_’cod”_şo£
(
ves
->
x265
);

104 
ves
->
x265
 = 
NULL
;

108 
ves
->
b™¿‹
 = 
´m
->bitrate;

109 
ves
->
pktsize
 = 
´m
->pktsize;

110 
ves
->
ås
 = 
´m
->fps;

111 
ves
->
pkth
 =…kth;

112 
ves
->
¬g
 =‡rg;

114 
”r
 = 
	`£t_·¿ms
(
ves
, 
´m
->
ås
,…rm->
b™¿‹
);

115 ià(
”r
)

116  
”r
;

119 
	}
}

122 
	$İ’_’cod”
(
vid’c_¡©e
 *
¡
, cÚ¡ 
vidsz
 *
size
)

124 ià(
¡
->
x265
) {

125 
	`debug
("h265:„e-openingƒncoder\n");

126 
	`x265_’cod”_şo£
(
¡
->
x265
);

129 
¡
->
·¿m
->
sourûWidth
 = 
size
->
w
;

130 
¡
->
·¿m
->
sourûHeight
 = 
size
->
h
;

132 
¡
->
x265
 = 
	`x265_’cod”_İ’
(¡->
·¿m
);

133 ià(!
¡
->
x265
) {

134 
	`w¬nšg
("h265: x265_encoder_open failed\n");

135  
ENOMEM
;

139 
	}
}

142 
šlše
 
	$·ck‘ize
(
boŞ
 
m¬k”
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

143 
size_t
 
maxËn
, 
ušt32_t
 
¹p_ts
,

144 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

146 
”r
 = 0;

148 ià(
Ën
 <ğ
maxËn
) {

149 
”r
 = 
	`pkth
(
m¬k”
, 
¹p_ts
, 
NULL
, 0, 
buf
, 
Ën
, 
¬g
);

152 
h265_Çl
 
Çl
;

153 
ušt8_t
 
fu_hdr
[3];

154 cÚ¡ 
size_t
 
æ’
 = 
maxËn
 - (
fu_hdr
);

156 
”r
 = 
	`h265_Çl_decode
(&
Çl
, 
buf
);

157 ià(
”r
) {

158 
	`w¬nšg
("h265:ƒncode: could‚ot decode"

159 " NAL oà%zu by‹ (%m)\n", 
Ën
, 
”r
);

160  
”r
;

163 
	`h265_Çl_’code
(
fu_hdr
, 
H265_NAL_FU
,

164 
Çl
.
nuh_‹mpÜ®_id_¶us1
);

166 
fu_hdr
[2] = 1<<7 | 
Çl
.
Çl_un™_ty³
;

168 
buf
+=2;

169 
Ën
-=2;

171 
Ën
 > 
æ’
) {

172 
”r
 |ğ
	`pkth
(
çl£
, 
¹p_ts
, 
fu_hdr
, 3, 
buf
, 
æ’
,

173 
¬g
);

175 
buf
 +ğ
æ’
;

176 
Ën
 -ğ
æ’
;

177 
fu_hdr
[2] &= ~(1 << 7);

180 
fu_hdr
[2] |= 1<<6;

182 
”r
 |ğ
	`pkth
(
m¬k”
, 
¹p_ts
, 
fu_hdr
, 3, 
buf
, 
Ën
,

183 
¬g
);

186  
”r
;

187 
	}
}

190 
	$h265_’code
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

191 cÚ¡ 
vidäame
 *
äame
)

193 
x265_piùu»
 *
pic_š
 = 
NULL
, 
pic_out
;

194 
x265_Çl
 *
Çlv
;

195 
ušt32_t
 
i
, 
Çlc
 = 0;

196 
cŞÜ¥aû
;

197 
n
, 
”r
 = 0;

198 
ušt32_t
 
ts
;

200 ià(!
¡
 || !
äame
)

201  
EINVAL
;

203 
äame
->
fmt
) {

205 
VID_FMT_YUV420P
:

206 
cŞÜ¥aû
 = 
X265_CSP_I420
;

209 
VID_FMT_YUV444P
:

210 
cŞÜ¥aû
 = 
X265_CSP_I444
;

214 
	`w¬nšg
("h265:ƒncode:…ixel format‚ot supported (%s)\n",

215 
	`vidfmt_Çme
(
äame
->
fmt
));

216  
EINVAL
;

219 ià(!
¡
->
x265
 || !
	`vidsz_cmp
(&¡->
size
, &
äame
->size) ||

220 
¡
->
·¿m
->
š‹º®C¥
 !ğ
cŞÜ¥aû
) {

222 
	`debug
("h265:ƒncoder:„eset %u x %u (%s)\n",

223 
äame
->
size
.
w
, f¿me->size.
h
, 
	`vidfmt_Çme
(äame->
fmt
));

225 
¡
->
·¿m
->
š‹º®C¥
 = 
cŞÜ¥aû
;

227 
”r
 = 
	`İ’_’cod”
(
¡
, &
äame
->
size
);

228 ià(
”r
)

229  
”r
;

231 
¡
->
size
 = 
äame
->size;

234 ià(
upd©e
) {

235 
	`debug
("h265:ƒncode:…icture update was„equested\n");

238 
pic_š
 = 
	`x265_piùu»_®loc
();

239 ià(!
pic_š
) {

240 
	`w¬nšg
("h265: x265_picture_alloc failed\n");

241  
ENOMEM
;

244 
	`x265_piùu»_š™
(
¡
->
·¿m
, 
pic_š
);

246 
pic_š
->
¦iûTy³
 = 
upd©e
 ? 
X265_TYPE_IDR
 : 
X265_TYPE_AUTO
;

247 
pic_š
->
±s
 = ++
¡
->pts;

248 
pic_š
->
cŞÜS·û
 = 
cŞÜ¥aû
;

250 
i
=0; i<3; i++) {

251 
pic_š
->
¶ªes
[
i
] = 
äame
->
d©a
[i];

252 
pic_š
->
¡ride
[
i
] = 
äame
->
lšesize
[i];

256 
n
 = 
	`x265_’cod”_’code
(
¡
->
x265
, &
Çlv
, &
Çlc
, 
pic_š
, &
pic_out
);

257 ià(
n
 <= 0)

258 
out
;

260 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pic_out
.
±s
, 
¡
->
ås
);

262 
i
=0; i<
Çlc
; i++) {

264 
x265_Çl
 *
Çl
 = &
Çlv
[
i
];

265 
ušt8_t
 *
p
 = 
Çl
->
·ylßd
;

266 
size_t
 
Ën
 = 
Çl
->
sizeBy‹s
;

267 
boŞ
 
m¬k”
;

270 
	`debug
("h265:ƒncode: %sype=%2d %s\n",

271 
	`h265_is_keyäame
(
Çl
->
ty³
) ? "<KEY>" : " ",

272 
Çl
->
ty³
, 
	`h265_Çlun™_Çme
(nal->type));

275 
	`h265_sk_¡¬tcode
(&
p
, &
Ën
);

279 
m¬k”
 = (
i
+1)==
Çlc
;

281 
”r
 = 
	`·ck‘ize
(
m¬k”
, 
p
, 
Ën
, 
¡
->
pktsize
,

282 
ts
, 
¡
->
pkth
, st->
¬g
);

283 ià(
”r
)

284 
out
;

287 
out
:

288 ià(
pic_š
)

289 
	`x265_piùu»_ä“
(
pic_š
);

291  
”r
;

292 
	}
}

	@baresip/modules/h265/fmt.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"h265.h
"

31 
	$h265_Çl_’code
(
ušt8_t
 
buf
[2], 
Çl_un™_ty³
,

32 
nuh_‹mpÜ®_id_¶us1
)

34 ià(!
buf
)

37 
buf
[0] = (
Çl_un™_ty³
 & 0x3f) << 1;

38 
buf
[1] = 
nuh_‹mpÜ®_id_¶us1
 & 0x07;

39 
	}
}

42 
	$h265_Çl_’code_mbuf
(
mbuf
 *
mb
, cÚ¡ 
h265_Çl
 *
Çl
)

44 
ušt8_t
 
buf
[2];

46 
	`h265_Çl_’code
(
buf
, 
Çl
->
Çl_un™_ty³
,‚®->
nuh_‹mpÜ®_id_¶us1
);

48  
	`mbuf_wr™e_mem
(
mb
, 
buf
, (buf));

49 
	}
}

52 
	$h265_Çl_decode
(
h265_Çl
 *
Çl
, cÚ¡ 
ušt8_t
 *
p
)

54 
boŞ
 
fÜbidd’_z”o_b™
;

55 
nuh_Ïy”_id
;

57 ià(!
Çl
 || !
p
)

58  
EINVAL
;

60 
fÜbidd’_z”o_b™
 = 
p
[0] >> 7;

61 
Çl
->
Çl_un™_ty³
 = (
p
[0] >> 1) & 0x3f;

62 
nuh_Ïy”_id
 = (
p
[0]&1)<<5 |…[1] >> 3;

63 
Çl
->
nuh_‹mpÜ®_id_¶us1
 = 
p
[1] & 0x07;

65 ià(
fÜbidd’_z”o_b™
) {

66 
	`w¬nšg
("h265:‚al_decode: FORBIDDEN bit set\n");

67  
EBADMSG
;

69 ià(
nuh_Ïy”_id
 != 0) {

70 
	`w¬nšg
("h265:‚al_decode: LayerId MUST be zero\n");

71  
EBADMSG
;

75 
	}
}

78 
	$h265_Çl_´št
(cÚ¡ 
h265_Çl
 *
Çl
)

80 
	`»_´štf
("type=%u(%s), TID=%u\n",

81 
Çl
->
Çl_un™_ty³
,

82 
	`h265_Çlun™_Çme
(
Çl
->
Çl_un™_ty³
),

83 
Çl
->
nuh_‹mpÜ®_id_¶us1
);

84 
	}
}

87 cÚ¡ 
ušt8_t
 
	gsc3
[3] = {0, 0, 1};

88 cÚ¡ 
ušt8_t
 
	gsc4
[4] = {0, 0, 0, 1};

91 
	$h265_sk_¡¬tcode
(
ušt8_t
 **
p
, 
size_t
 *
n
)

93 ià(*
n
 < 4)

96 ià(0 =ğ
	`memcmp
(*
p
, 
sc4
, 4)) {

97 (*
p
) += 4;

98 *
n
 -= 4;

100 ià(0 =ğ
	`memcmp
(*
p
, 
sc3
, 3)) {

101 (*
p
) += 3;

102 *
n
 -= 3;

104 
	}
}

107 
boŞ
 
	$h265_have_¡¬tcode
(cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
Ën
)

109 ià(
Ën
 >ğ4 && 0 =ğ
	`memcmp
(
p
, 
sc4
, 4)è 
Œue
;

110 ià(
Ën
 >ğ3 && 0 =ğ
	`memcmp
(
p
, 
sc3
, 3)è 
Œue
;

112  
çl£
;

113 
	}
}

116 
boŞ
 
	$h265_is_keyäame
(
h265_ÇÉy³
 
ty³
)

119 
ty³
) {

121 
H265_NAL_BLA_W_LP
:

122 
H265_NAL_BLA_W_RADL
:

123 
H265_NAL_BLA_N_LP
:

124 
H265_NAL_IDR_W_RADL
:

125 
H265_NAL_IDR_N_LP
:

126 
H265_NAL_CRA_NUT
:

127  
Œue
;

129  
çl£
;

131 
	}
}

134 cÚ¡ *
	$h265_Çlun™_Çme
(
h265_ÇÉy³
 
ty³
)

136 
ty³
) {

139 
H265_NAL_TRAIL_N
:  "TRAIL_N";

140 
H265_NAL_TRAIL_R
:  "TRAIL_R";

142 
H265_NAL_RASL_N
:  "RASL_N";

143 
H265_NAL_RASL_R
:  "RASL_R";

145 
H265_NAL_BLA_W_LP
:  "BLA_W_LP";

146 
H265_NAL_BLA_W_RADL
:  "BLA_W_RADL";

147 
H265_NAL_BLA_N_LP
:  "BLA_N_LP";

148 
H265_NAL_IDR_W_RADL
:  "IDR_W_RADL";

149 
H265_NAL_IDR_N_LP
:  "IDR_N_LP";

150 
H265_NAL_CRA_NUT
:  "CRA_NUT";

153 
H265_NAL_VPS_NUT
:  "VPS_NUT";

154 
H265_NAL_SPS_NUT
:  "SPS_NUT";

155 
H265_NAL_PPS_NUT
:  "PPS_NUT";

156 
H265_NAL_PREFIX_SEI_NUT
:  "PREFIX_SEI_NUT";

157 
H265_NAL_SUFFIX_SEI_NUT
:  "SUFFIX_SEI_NUT";

160 
H265_NAL_AP
:  "H265_NAL_AP";

161 
H265_NAL_FU
:  "H265_NAL_FU";

165 
	}
}

	@baresip/modules/h265/h265.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<libavcodec/avcodec.h
>

10 
	~<x265.h
>

11 
	~"h265.h
"

31 
vidcodec
 
	gh265
 = {

32 .
Çme
 = "H265",

33 .
	gfm
 = "profile-id=1",

34 .
	g’cupdh
 = 
h265_’code_upd©e
,

35 .
	g’ch
 = 
h265_’code
,

36 .
	gdecupdh
 = 
h265_decode_upd©e
,

37 .
	gdech
 = 
h265_decode
,

41 
	$moduË_š™
()

43 
	`šfo
("h265: using x265 %s %s\n",

44 
x265_v”siÚ_¡r
, 
x265_bud_šfo_¡r
);

46 
	`avcodec_»gi¡”_®l
();

48 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
h265
);

51 
	}
}

54 
	$moduË_şo£
()

56 
	`vidcodec_uÄegi¡”
(&
h265
);

59 
	}
}

62 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
h265
) = {

65 
moduË_š™
,

66 
moduË_şo£
,

	@baresip/modules/h265/h265.h

12 
	mH265_HDR_SIZE
 = 2

15 
	eh265_ÇÉy³
 {

17 
	mH265_NAL_TRAIL_N
 = 0,

18 
	mH265_NAL_TRAIL_R
 = 1,

20 
	mH265_NAL_RASL_N
 = 8,

21 
	mH265_NAL_RASL_R
 = 9,

23 
	mH265_NAL_BLA_W_LP
 = 16,

24 
	mH265_NAL_BLA_W_RADL
 = 17,

25 
	mH265_NAL_BLA_N_LP
 = 18,

26 
	mH265_NAL_IDR_W_RADL
 = 19,

27 
	mH265_NAL_IDR_N_LP
 = 20,

28 
	mH265_NAL_CRA_NUT
 = 21,

31 
	mH265_NAL_VPS_NUT
 = 32,

32 
	mH265_NAL_SPS_NUT
 = 33,

33 
	mH265_NAL_PPS_NUT
 = 34,

34 
	mH265_NAL_PREFIX_SEI_NUT
 = 39,

35 
	mH265_NAL_SUFFIX_SEI_NUT
 = 40,

38 
	mH265_NAL_AP
 = 48,

39 
	mH265_NAL_FU
 = 49,

42 
	sh265_Çl
 {

43 
	mÇl_un™_ty³
:6;

44 
	mnuh_‹mpÜ®_id_¶us1
:3;

47 
h265_Çl_’code
(
ušt8_t
 
buf
[2], 
Çl_un™_ty³
,

48 
nuh_‹mpÜ®_id_¶us1
);

49 
h265_Çl_’code_mbuf
(
mbuf
 *
mb
, cÚ¡ 
h265_Çl
 *
Çl
);

50 
h265_Çl_decode
(
h265_Çl
 *
Çl
, cÚ¡ 
ušt8_t
 *
p
);

51 
h265_Çl_´št
(cÚ¡ 
h265_Çl
 *
Çl
);

53 
boŞ
 
h265_have_¡¬tcode
(cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
Ën
);

54 
h265_sk_¡¬tcode
(
ušt8_t
 **
p
, 
size_t
 *
n
);

55 
boŞ
 
h265_is_keyäame
(
h265_ÇÉy³
 
ty³
);

56 cÚ¡ *
h265_Çlun™_Çme
(
h265_ÇÉy³
 
ty³
);

60 
h265_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

61 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

62 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

63 
h265_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

64 cÚ¡ 
vidäame
 *
äame
);

67 
h265_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

68 cÚ¡ *
fm
);

69 
h265_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

70 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
);

	@baresip/modules/httpd/httpd.c

6 
	~<».h
>

7 
	~<b¬es.h
>

25 
h‰p_sock
 *
	gh‰psock
;

28 
	$html_´št_h—d
(
»_´štf
 *
pf
, *
unu£d
)

30 ()
unu£d
;

32  
	`»_h´štf
(
pf
,

35 "<t™Ë>B¬es v" 
BARESIP_VERSION
 "</title>\n"

37 
	}
}

40 
	$html_´št_cmd
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *
´m
)

42 
¶
 
·¿ms
;

44 ià(!
pf
 || !
´m
)

45  
EINVAL
;

47 ià(
	`¶_is£t
(
´m
)) {

48 
·¿ms
.
p
 = 
´m
->p + 1;

49 
·¿ms
.
l
 = 
´m
->l - 1;

52 
·¿ms
.
p
 = "h";

53 
·¿ms
.
l
 = 1;

56  
	`»_h´štf
(
pf
,

64 
html_´št_h—d
, 
NULL
,

65 
ui_šput_¶
, &
·¿ms
);

66 
	}
}

69 
	$html_´št_¿w
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *
´m
)

71 
¶
 
·¿ms
;

73 ià(!
pf
 || !
´m
)

74  
EINVAL
;

76 ià(
	`¶_is£t
(
´m
)) {

77 
·¿ms
.
p
 = 
´m
->p + 1;

78 
·¿ms
.
l
 = 
´m
->l - 1;

81 
·¿ms
.
p
 = "h";

82 
·¿ms
.
l
 = 1;

85  
	`»_h´štf
(
pf
,

87 
ui_šput_¶
, &
·¿ms
);

88 
	}
}

90 
	$h‰p_»q_hªdËr
(
h‰p_cÚn
 *
cÚn
,

91 cÚ¡ 
h‰p_msg
 *
msg
, *
¬g
)

93 
”r
;

94 *
buf
 = 
NULL
;

95 
¶
 
Årm
;

96 ()
¬g
;

98 
”r
 = 
	`»_sd´štf
(&
buf
, "%H", 
uri_h—d”_uÃsÿ³
, &
msg
->
´m
);

99 ià(
”r
)

100 
”rÜ
;

102 
	`¶_£t_¡r
(&
Årm
, 
buf
);

104 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
msg
->
·th
, "/")) {

106 
	`h‰p_ü•ly
(
cÚn
, 200, "OK",

108 "%H", 
html_´št_cmd
, &
Årm
);

110 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
msg
->
·th
, "/raw/")) {

112 
	`h‰p_ü•ly
(
cÚn
, 200, "OK",

114 "%H", 
html_´št_¿w
, &
Årm
);

117 
”rÜ
;

119 
	`mem_d”ef
(
buf
);

123 
”rÜ
:

124 
	`mem_d”ef
(
buf
);

125 
	`h‰p_”•ly
(
cÚn
, 404, "Not Found");

126 
	}
}

129 
	$ouut_hªdËr
(cÚ¡ *
¡r
)

131 ()
¡r
;

136 
	}
}

139 
ui
 
	gui_h‰p
 = {

140 .
Çme
 = "http",

141 .
	gouuth
 = 
ouut_hªdËr


145 
	$moduË_š™
()

147 
§
 
Ïddr
;

148 
”r
;

150 ià(
	`cÚf_g‘_§
(
	`cÚf_cur
(), "h‰p_li¡’", &
Ïddr
)) {

151 
	`§_£t_¡r
(&
Ïddr
, "0.0.0.0", 8000);

154 
”r
 = 
	`h‰p_li¡’
(&
h‰psock
, &
Ïddr
, 
h‰p_»q_hªdËr
, 
NULL
);

155 ià(
”r
)

156  
”r
;

158 
	`ui_»gi¡”
(
	`b¬es_uis
(), &
ui_h‰p
);

160 
	`šfo
("h‰pd:†i¡’šg oÀ%J\n", &
Ïddr
);

163 
	}
}

166 
	$moduË_şo£
()

168 
	`ui_uÄegi¡”
(&
ui_h‰p
);

170 
h‰psock
 = 
	`mem_d”ef
(httpsock);

173 
	}
}

176 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
h‰pd
) = {

179 
moduË_š™
,

180 
moduË_şo£
,

	@baresip/modules/ice/ice.c

6 #ifdeà
__APPLE__


7 
	~<CÜeFound©iÚ/CÜeFound©iÚ.h
>

8 
	~<Sy¡emCÚfigu¿tiÚ/SCN‘wÜkR—chab™y.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

33 
	mICE_LAYER
 = 0

37 
	smÇt_£ss
 {

38 
li¡
 
	mmedŸl
;

39 
§
 
	m¤v
;

40 
¡un_dns
 *
	mdnsq
;

41 
sdp_£ssiÚ
 *
	msdp
;

42 
	mluäag
[8];

43 
	mÍwd
[32];

44 
ušt64_t
 
	mt›brk
;

45 
boŞ
 
	mofã»r
;

46 *
	mu£r
;

47 *
	m·ss
;

48 
	mmedŸc
;

49 
boŞ
 
	m¡¬‹d
;

50 
boŞ
 
	m£nd_»šv™e
;

51 
mÇt_e¡ab_h
 *
	me¡abh
;

52 *
	m¬g
;

55 
	smÇt_medŸ
 {

56 
	scomp
 {

57 
mÇt_medŸ
 *
	mm
;

58 
¡un_ù¿ns
 *
	mù_g©h
;

59 
§
 
	mÏddr
;

60 
	mid
;

61 *
	msock
;

62 } 
	mcompv
[2];

63 
Ë
 
	mË
;

64 
mÇt_£ss
 *
	m£ss
;

65 
sdp_medŸ
 *
	msdpm
;

66 
iûm
 *
	miûm
;

67 
boŞ
 
	mcom¶‘e
;

68 
boŞ
 
	m‹rmš©ed
;

69 
	mn¡un
;

73 
mÇt
 *
	gmÇt
;

75 
iû_mode
 
	mmode
;

76 
iû_nomš©iÚ
 
	mnom
;

77 
boŞ
 
	mtuº
;

78 
boŞ
 
	mdebug
;

79 } 
	giû
 = {

80 
ICE_MODE_FULL
,

81 
ICE_NOMINATION_REGULAR
,

82 
Œue
,

83 
çl£


87 
g©h”_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

88 *
¬g
);

91 
	$ÿÎ_g©h”_hªdËr
(
”r
, 
mÇt_medŸ
 *
m
, 
ušt16_t
 
scode
,

92 cÚ¡ *
»asÚ
)

96 ià(
m
->
n¡un
 != 0)

99 
	`debug
("ice:‡ll components gathered.\n");

101 ià(
”r
)

102 
out
;

105 
	`iûm_ÿnd_»dund_–im
(
m
->
iûm
);

107 
”r
 = 
	`iûm_comps_£t_deçuÉ_ÿnd
(
m
->
iûm
);

108 ià(
”r
) {

109 
	`w¬nšg
("iû: s‘ deçuÉ cªd çed (%m)\n", 
”r
);

110 
out
;

113 
out
:

114 
	`g©h”_hªdËr
(
”r
, 
scode
, 
»asÚ
, 
m
);

115 
	}
}

118 
	$¡un_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

119 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

121 
comp
 *com°ğ
¬g
;

122 
mÇt_medŸ
 *
m
 = 
comp
->m;

123 
¡un_©Œ
 *
©Œ
;

124 
iû_ÿnd
 *
lÿnd
;

126 ià(
m
->
‹rmš©ed
)

129 --
m
->
n¡un
;

131 ià(
”r
 || 
scode
 > 0) {

132 
	`w¬nšg
("ice: comp %u: STUN Request failed: %m\n",

133 
comp
->
id
, 
”r
);

134 
out
;

137 
	`debug
("iû: sræx g©h”šg fÜ com°%u com¶‘e.\n", 
comp
->
id
);

140 
lÿnd
 = 
	`iûm_ÿnd_fšd
(
	`iûm_lÿndl
(
m
->
iûm
), 
comp
->
id
, 
NULL
);

141 ià(!
lÿnd
)

142 
out
;

144 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

145 ià(!
©Œ
)

146 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

147 ià(!
©Œ
) {

148 
	`w¬nšg
("ice:‚o Mapped Address in Response\n");

149 
”r
 = 
EPROTO
;

150 
out
;

153 
”r
 = 
	`iûm_lÿnd_add
(
m
->
iûm
, 
	`iûm_lÿnd_ba£
(
lÿnd
),

154 
ICE_CAND_TYPE_SRFLX
,

155 &
©Œ
->
v
.
§
);

157 
out
:

158 
	`ÿÎ_g©h”_hªdËr
(
”r
, 
m
, 
scode
, 
»asÚ
);

159 
	}
}

163 
	$£nd_bšdšg_»que¡
(
mÇt_medŸ
 *
m
, 
comp
 *comp)

165 
”r
;

167 ià(
comp
->
ù_g©h
)

168  
EALREADY
;

170 
	`debug
("iû: g©h”šg sræx fÜ com°%u ..\n", 
comp
->
id
);

172 
”r
 = 
	`¡un_»que¡
(&
comp
->
ù_g©h
, 
	`iûm_¡un
(
m
->
iûm
), 
IPPROTO_UDP
,

173 
comp
->
sock
, &
m
->
£ss
->
¤v
, 0,

174 
STUN_METHOD_BINDING
,

175 
NULL
, 
çl£
, 0,

176 
¡un_»¥_hªdËr
, 
comp
, 1,

177 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

178 ià(
”r
)

179  
”r
;

181 ++
m
->
n¡un
;

184 
	}
}

187 
	$tuºc_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

188 cÚ¡ 
§
 *
»Ïy
, cÚ¡ § *
m­³d
,

189 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

191 
comp
 *com°ğ
¬g
;

192 
mÇt_medŸ
 *
m
 = 
comp
->m;

193 
iû_ÿnd
 *
lÿnd
;

194 ()
msg
;

196 --
m
->
n¡un
;

199 ià(
”r
 || 
scode
) {

200 
	`iûm_£t_tuº_ş›Á
(
m
->
iûm
, 
comp
->
id
, 
NULL
);

203 ià(
”r
) {

204 
	`w¬nšg
("{%u} TURN Clientƒrror: %m\n",

205 
comp
->
id
, 
”r
);

206 
out
;

209 ià(
scode
) {

210 
	`w¬nšg
("{%u} TURN Clientƒrror: %u %s\n",

211 
comp
->
id
, 
scode
, 
»asÚ
);

212 
”r
 = 
	`£nd_bšdšg_»que¡
(
m
, 
comp
);

213 ià(
”r
)

214 
out
;

218 
	`debug
("ice:„elay gathered for comp %u (%u %s)\n",

219 
comp
->
id
, 
scode
, 
»asÚ
);

221 
lÿnd
 = 
	`iûm_ÿnd_fšd
(
	`iûm_lÿndl
(
m
->
iûm
), 
comp
->
id
, 
NULL
);

222 ià(!
lÿnd
)

223 
out
;

225 ià(!
	`§_cmp
(
»Ïy
, 
	`iûm_lÿnd_addr
(
	`iûm_lÿnd_ba£
(
lÿnd
)), 
SA_ALL
)) {

226 
”r
 = 
	`iûm_lÿnd_add
(
m
->
iûm
, 
	`iûm_lÿnd_ba£
(
lÿnd
),

227 
ICE_CAND_TYPE_RELAY
, 
»Ïy
);

230 ià(
m­³d
) {

231 
”r
 |ğ
	`iûm_lÿnd_add
(
m
->
iûm
, 
	`iûm_lÿnd_ba£
(
lÿnd
),

232 
ICE_CAND_TYPE_SRFLX
, 
m­³d
);

235 
”r
 |ğ
	`£nd_bšdšg_»que¡
(
m
, 
comp
);

238 
out
:

239 
	`ÿÎ_g©h”_hªdËr
(
”r
, 
m
, 
scode
, 
»asÚ
);

240 
	}
}

243 
	$ÿnd_g©h”_»Ïyed
(
mÇt_medŸ
 *
m
, 
comp
 *comp,

244 cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
)

246 
tuºc
 *tuºøğ
NULL
;

247 cÚ¡ 
Ïy”
 = 
ICE_LAYER
 - 10;

248 
”r
;

250 
”r
 = 
	`tuºc_®loc
(&
tuºc
, 
	`¡un_cÚf
(
	`iûm_¡un
(
m
->
iûm
)),

251 
IPPROTO_UDP
, 
comp
->
sock
, 
Ïy”
, &
m
->
£ss
->
¤v
,

252 
u£ºame
, 
·sswÜd
,

253 60, 
tuºc_hªdËr
, 
comp
);

254 ià(
”r
)

255  
”r
;

257 
”r
 = 
	`iûm_£t_tuº_ş›Á
(
m
->
iûm
, 
comp
->
id
, 
tuºc
);

258 ià(
”r
)

259 
out
;

261 ++
m
->
n¡un
;

263 
out
:

264 
	`mem_d”ef
(
tuºc
);

266  
”r
;

267 
	}
}

270 
	$¡¬t_g©h”šg
(
mÇt_medŸ
 *
m
,

271 cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
)

273 
i
;

274 
”r
 = 0;

276 ià(
iû
.
mode
 !ğ
ICE_MODE_FULL
)

277  
EINVAL
;

280 
i
=0; i<2; i++) {

281 
comp
 *com°ğ&
m
->
compv
[
i
];

283 ià(!
comp
->
sock
)

286 ià(
u£ºame
 && 
·sswÜd
) {

287 
”r
 |ğ
	`ÿnd_g©h”_»Ïyed
(
m
, 
comp
,

288 
u£ºame
, 
·sswÜd
);

291 
”r
 |ğ
	`£nd_bšdšg_»que¡
(
m
, 
comp
);

294  
”r
;

295 
	}
}

298 
	$iûm_g©h”_¤æx
(
mÇt_medŸ
 *
m
)

300 ià(!
m
)

301  
EINVAL
;

303  
	`¡¬t_g©h”šg
(
m
, 
NULL
, NULL);

304 
	}
}

307 
	$iûm_g©h”_»Ïy
(
mÇt_medŸ
 *
m
,

308 cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
)

310 ià(!
m
 || !
u£ºame
 || !
·sswÜd
)

311  
EINVAL
;

313  
	`¡¬t_g©h”šg
(
m
, 
u£ºame
, 
·sswÜd
);

314 
	}
}

317 
boŞ
 
	$is_ûÎuÏr
(cÚ¡ 
§
 *
Ïddr
)

319 #ià
TARGET_OS_IPHONE


320 
SCN‘wÜkR—chab™yRef
 
r
;

321 
SCN‘wÜkR—chab™yFÏgs
 
æags
 = 0;

322 
boŞ
 
ûÎ
 = 
çl£
;

324 
r
 = 
	`SCN‘wÜkR—chab™yC»©eW™hAdd»ssPaœ
(
NULL
,

325 &
Ïddr
->
u
.
§
, 
NULL
);

326 ià(!
r
)

327  
çl£
;

329 ià(
	`SCN‘wÜkR—chab™yG‘FÏgs
(
r
, &
æags
)) {

331 ià(
æags
 & 
kSCN‘wÜkR—chab™yFÏgsIsWWAN
)

332 
ûÎ
 = 
Œue
;

335 
	`CFR–—£
(
r
);

337  
ûÎ
;

339 ()
Ïddr
;

340  
çl£
;

342 
	}
}

345 
	$iû_´štf
(
mÇt_medŸ
 *
m
, cÚ¡ *
fmt
, ...)

347 
va_li¡
 
­
;

349 
	`va_¡¬t
(
­
, 
fmt
);

350 
	`debug
("%s: %v", 
m
 ? 
	`sdp_medŸ_Çme
(m->
sdpm
è: "ICE", 
fmt
, &
­
);

351 
	`va_’d
(
­
);

352 
	}
}

355 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

357 
mÇt_£ss
 *
£ss
 = 
¬g
;

359 
	`li¡_æush
(&
£ss
->
medŸl
);

360 
	`mem_d”ef
(
£ss
->
dnsq
);

361 
	`mem_d”ef
(
£ss
->
u£r
);

362 
	`mem_d”ef
(
£ss
->
·ss
);

363 
	`mem_d”ef
(
£ss
->
sdp
);

364 
	}
}

367 
	$medŸ_de¡ruùÜ
(*
¬g
)

369 
mÇt_medŸ
 *
m
 = 
¬g
;

370 
i
;

372 
m
->
‹rmš©ed
 = 
Œue
;

374 
	`li¡_uÆšk
(&
m
->
Ë
);

375 
	`mem_d”ef
(
m
->
sdpm
);

376 
	`mem_d”ef
(
m
->
iûm
);

377 
i
=0; i<2; i++) {

378 
	`mem_d”ef
(
m
->
compv
[
i
].
ù_g©h
);

379 
	`mem_d”ef
(
m
->
compv
[
i
].
sock
);

381 
	}
}

384 
boŞ
 
	$ÿndid©e_hªdËr
(
Ë
 *Ë, *
¬g
)

386  0 !ğ
	`sdp_medŸ_£t_Ï‰r
(
¬g
, 
çl£
, 
iû_©Œ_ÿnd
, "%H",

387 
iû_ÿnd_’code
, 
Ë
->
d©a
);

388 
	}
}

395 
	$£t_medŸ_©Œibu‹s
(
mÇt_medŸ
 *
m
)

397 
”r
 = 0;

399 ià(
	`iûm_mism©ch
(
m
->
iûm
)) {

400 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
m
->
sdpm
, 
Œue
,

401 
iû_©Œ_mism©ch
, 
NULL
);

402  
”r
;

405 
	`sdp_medŸ_d–_Ï‰r
(
m
->
sdpm
, 
iû_©Œ_mism©ch
);

409 
	`sdp_medŸ_d–_Ï‰r
(
m
->
sdpm
, 
iû_©Œ_ÿnd
);

410 ià(
	`li¡_­¶y
(
	`iûm_lÿndl
(
m
->
iûm
), 
Œue
, 
ÿndid©e_hªdËr
, m->
sdpm
))

411  
ENOMEM
;

413 ià(
	`iû_»mÙeÿnds_ava
(
m
->
iûm
)) {

414 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
m
->
sdpm
, 
Œue
,

415 
iû_©Œ_»mÙe_ÿnd
, "%H",

416 
iû_»mÙeÿnds_’code
, 
m
->
iûm
);

419  
”r
;

420 
	}
}

423 
boŞ
 
	$if_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *§, *
¬g
)

425 
mÇt_medŸ
 *
m
 = 
¬g
;

426 
ušt16_t
 
Írio
;

427 
i
;

428 
”r
 = 0;

431 ià(
	`§_is_loİback
(
§
è|| 
	`§_is_lškloÿl
(sa))

432  
çl£
;

434 
Írio
 = 
	`is_ûÎuÏr
(
§
) ? 0 : 10;

436 
	`iû_´štf
(
m
, "added interface: %s:%j (local…rio %u)\n",

437 
iâame
, 
§
, 
Írio
);

439 
i
=0; i<2; i++) {

440 ià(
m
->
compv
[
i
].
sock
)

441 
”r
 |ğ
	`iûm_ÿnd_add
(
m
->
iûm
, 
i
+1, 
Írio
, 
iâame
, 
§
);

444 ià(
”r
) {

445 
	`w¬nšg
("iû: %s:%j: iûm_ÿnd_add: %m\n", 
iâame
, 
§
, 
”r
);

448  
çl£
;

449 
	}
}

452 
	$medŸ_¡¬t
(
mÇt_£ss
 *
£ss
, 
mÇt_medŸ
 *
m
)

454 
”r
 = 0;

456 
	`Ãt_if_­¶y
(
if_hªdËr
, 
m
);

458 
iû
.
mode
) {

461 
ICE_MODE_FULL
:

462 ià(
iû
.
tuº
) {

463 
”r
 = 
	`iûm_g©h”_»Ïy
(
m
,

464 
£ss
->
u£r
, sess->
·ss
);

467 
”r
 = 
	`iûm_g©h”_¤æx
(
m
);

471 
ICE_MODE_LITE
:

472 
”r
 = 
	`iûm_l™e_£t_deçuÉ_ÿndid©es
(
m
->
iûm
);

473 ià(
”r
) {

474 
	`w¬nšg
("ice: could‚ot set"

475 " deçuÉ cªdid©e (%m)\n", 
”r
);

476  
”r
;

479 
	`g©h”_hªdËr
(0, 0, 
NULL
, 
m
);

483  
”r
;

484 
	}
}

487 
	$dns_hªdËr
(
”r
, cÚ¡ 
§
 *
¤v
, *
¬g
)

489 
mÇt_£ss
 *
£ss
 = 
¬g
;

490 
Ë
 *le;

492 ià(
”r
)

493 
out
;

495 
	`debug
("ice:„esolved %s-servero‡ddress %J\n",

496 
iû
.
tuº
 ? "TURN" : "STUN", 
¤v
);

498 
£ss
->
¤v
 = *srv;

500 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

502 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

504 
”r
 = 
	`medŸ_¡¬t
(
£ss
, 
m
);

505 ià(
”r
)

506 
out
;

511 
out
:

512 
£ss
->
	`e¡abh
(
”r
, 0, 
NULL
, sess->
¬g
);

513 
	}
}

516 
	$£ssiÚ_®loc
(
mÇt_£ss
 **
£s¥
, 
dnsc
 *dnsc,

517 
af
, cÚ¡ *
¤v
, 
ušt16_t
 
pÜt
,

518 cÚ¡ *
u£r
, cÚ¡ *
·ss
,

519 
sdp_£ssiÚ
 *
ss
, 
boŞ
 
ofã»r
,

520 
mÇt_e¡ab_h
 *
e¡abh
, *
¬g
)

522 
mÇt_£ss
 *
£ss
;

523 cÚ¡ *
u§ge
;

524 
”r
;

526 ià(!
£s¥
 || !
dnsc
 || !
¤v
 || !
u£r
 || !
·ss
 || !
ss
 || !
e¡abh
)

527  
EINVAL
;

529 
	`šfo
("ice:‚ew session with %s-server‡t %s (username=%s)\n",

530 
iû
.
tuº
 ? "TURN" : "STUN",

531 
¤v
, 
u£r
);

533 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ssiÚ_de¡ruùÜ
);

534 ià(!
£ss
)

535  
ENOMEM
;

537 
£ss
->
sdp
 = 
	`mem_»f
(
ss
);

538 
£ss
->
e¡abh
 =ƒstabh;

539 
£ss
->
¬g
 =‡rg;

541 
”r
 = 
	`¡r_dup
(&
£ss
->
u£r
, user);

542 
”r
 |ğ
	`¡r_dup
(&
£ss
->
·ss
,…ass);

543 ià(
”r
)

544 
out
;

546 
	`¿nd_¡r
(
£ss
->
luäag
, (sess->lufrag));

547 
	`¿nd_¡r
(
£ss
->
Íwd
, (sess->lpwd));

548 
£ss
->
t›brk
 = 
	`¿nd_u64
();

549 
£ss
->
ofã»r
 = offerer;

551 ià(
ICE_MODE_LITE
 =ğ
iû
.
mode
) {

552 
”r
 |ğ
	`sdp_£ssiÚ_£t_Ï‰r
(
ss
, 
Œue
,

553 
iû_©Œ_l™e
, 
NULL
);

556 
”r
 |ğ
	`sdp_£ssiÚ_£t_Ï‰r
(
ss
, 
Œue
,

557 
iû_©Œ_uäag
, 
£ss
->
luäag
);

558 
”r
 |ğ
	`sdp_£ssiÚ_£t_Ï‰r
(
ss
, 
Œue
,

559 
iû_©Œ_pwd
, 
£ss
->
Íwd
);

560 ià(
”r
)

561 
out
;

563 
u§ge
 = 
iû
.
tuº
 ? 
¡un_u§ge_»Ïy
 : 
¡un_u§ge_bšdšg
;

565 
”r
 = 
	`¡un_£rv”_discov”
(&
£ss
->
dnsq
, 
dnsc
, 
u§ge
, 
¡un_´Ùo_udp
,

566 
af
, 
¤v
, 
pÜt
, 
dns_hªdËr
, 
£ss
);

568 
out
:

569 ià(
”r
)

570 
	`mem_d”ef
(
£ss
);

572 *
£s¥
 = 
£ss
;

574  
”r
;

575 
	}
}

578 
boŞ
 
	$v”ify_³”_iû
(
mÇt_£ss
 *
ms
)

580 
Ë
 *le;

582 
Ë
 = 
ms
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

583 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

584 
§
 
¿ddr
[2];

585 
i
;

587 ià(!
	`sdp_medŸ_has_medŸ
(
m
->
sdpm
)) {

588 
	`šfo
("ice: stream '%s' is disabled -- ignore\n",

589 
	`sdp_medŸ_Çme
(
m
->
sdpm
));

593 
¿ddr
[0] = *
	`sdp_medŸ_¿ddr
(
m
->
sdpm
);

594 
	`sdp_medŸ_¿ddr_¹ı
(
m
->
sdpm
, &
¿ddr
[1]);

596 
i
=0; i<2; i++) {

597 ià(
m
->
compv
[
i
].
sock
 &&

598 !
	`iûm_v”ify_suµÜt
(
m
->
iûm
, 
i
+1, &
¿ddr
[i])) {

599 
	`w¬nšg
("ice: %s.%u:‚o„emote candidates"

601 
	`sdp_medŸ_Çme
(
m
->
sdpm
),

602 
i
+1, &
¿ddr
[i]);

603  
çl£
;

608  
Œue
;

609 
	}
}

612 
boŞ
 
	$»äesh_comp_Ïddr
(
mÇt_medŸ
 *
m
, 
id
,

613 
comp
 *comp, cÚ¡ 
§
 *
Ïddr
)

615 
boŞ
 
chªged
 = 
çl£
;

617 ià(!
m
 || !
comp
 || !comp->
sock
 || !
Ïddr
)

618  
çl£
;

620 ià(!
	`§_cmp
(&
comp
->
Ïddr
,†addr, 
SA_ALL
)) {

621 
chªged
 = 
Œue
;

623 
	`iû_´štf
(
m
, "comp%u s‘tšg†oÿl: %J\n", 
id
, 
Ïddr
);

626 
	`§_ıy
(&
comp
->
Ïddr
,†addr);

628 ià(
id
 == 1)

629 
	`sdp_medŸ_£t_Ïddr
(
m
->
sdpm
, &
comp
->
Ïddr
);

630 ià(
id
 == 2)

631 
	`sdp_medŸ_£t_Ïddr_¹ı
(
m
->
sdpm
, &
comp
->
Ïddr
);

633  
chªged
;

634 
	}
}

640 
boŞ
 
	$»äesh_Ïddr
(
mÇt_medŸ
 *
m
,

641 cÚ¡ 
§
 *
Ïddr1
,

642 cÚ¡ 
§
 *
Ïddr2
)

644 
boŞ
 
chªged
 = 
çl£
;

646 
chªged
 |ğ
	`»äesh_comp_Ïddr
(
m
, 1, &m->
compv
[0], 
Ïddr1
);

647 
chªged
 |ğ
	`»äesh_comp_Ïddr
(
m
, 2, &m->
compv
[1], 
Ïddr2
);

649  
chªged
;

650 
	}
}

653 
	$g©h”_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

654 *
¬g
)

656 
mÇt_medŸ
 *
m
 = 
¬g
;

657 
mÇt_e¡ab_h
 *
e¡abh
 = 
m
->
£ss
->estabh;

659 ià(
”r
 || 
scode
) {

660 
	`w¬nšg
("ice: gatherƒrror: %m (%u %s)\n",

661 
”r
, 
scode
, 
»asÚ
);

664 
	`»äesh_Ïddr
(
m
,

665 
	`iûm_ÿnd_deçuÉ
(
m
->
iûm
, 1),

666 
	`iûm_ÿnd_deçuÉ
(
m
->
iûm
, 2));

668 
	`šfo
("ice: %s: Default†ocal candidates: %J / %J\n",

669 
	`sdp_medŸ_Çme
(
m
->
sdpm
),

670 &
m
->
compv
[0].
Ïddr
, &m->compv[1].laddr);

672 ()
	`£t_medŸ_©Œibu‹s
(
m
);

674 ià(--
m
->
£ss
->
medŸc
)

678 ià(
”r
 || 
scode
)

679 
m
->
£ss
->
e¡abh
 = 
NULL
;

681 ià(
e¡abh
)

682 
	`e¡abh
(
”r
, 
scode
, 
»asÚ
, 
m
->
£ss
->
¬g
);

683 
	}
}

686 
	$cÚncheck_hªdËr
(
”r
, 
boŞ
 
upd©e
, *
¬g
)

688 
mÇt_medŸ
 *
m
 = 
¬g
;

689 
mÇt_£ss
 *
£ss
 = 
m
->sess;

690 
Ë
 *le;

692 
	`šfo
("ice: %s: connectivity check is complete (update=%d)\n",

693 
	`sdp_medŸ_Çme
(
m
->
sdpm
), 
upd©e
);

695 
	`iû_´štf
(
m
, "Dumpšg medŸ s‹: %H\n", 
iûm_debug
, m->
iûm
);

697 ià(
”r
) {

698 
	`w¬nšg
("iû: cÚÃùiv™y check faed: %m\n", 
”r
);

701 
boŞ
 
chªged
;

703 
m
->
com¶‘e
 = 
Œue
;

705 
chªged
 = 
	`»äesh_Ïddr
(
m
,

706 
	`iûm_£Ëùed_Ïddr
(
m
->
iûm
, 1),

707 
	`iûm_£Ëùed_Ïddr
(
m
->
iûm
, 2));

708 ià(
chªged
)

709 
£ss
->
£nd_»šv™e
 = 
Œue
;

711 ()
	`£t_medŸ_©Œibu‹s
(
m
);

714 
	`LIST_FOREACH
(&
£ss
->
medŸl
, 
Ë
) {

715 
mÇt_medŸ
 *
mx
 = 
Ë
->
d©a
;

716 ià(!
mx
->
com¶‘e
)

722 ià(
£ss
->
£nd_»šv™e
 && 
upd©e
) {

724 
	`šfo
("ice: %s: sending Re-INVITE with updated"

726 
	`sdp_medŸ_Çme
(
m
->
sdpm
));

728 
£ss
->
	`e¡abh
(0, 0, 
NULL
, sess->
¬g
);

729 
£ss
->
£nd_»šv™e
 = 
çl£
;

731 
	}
}

734 
	$iû_¡¬t
(
mÇt_£ss
 *
£ss
)

736 
Ë
 *le;

737 
”r
 = 0;

740 ià(
£ss
->
¡¬‹d
) {

742 
	`LIST_FOREACH
(&
£ss
->
medŸl
, 
Ë
) {

743 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

745 
	`iû_´štf
(
NULL
, "ICE Start: %H",

746 
iûm_debug
, 
m
->
iûm
);

748 
	`iûm_upd©e
(
m
->
iûm
);

750 
	`»äesh_Ïddr
(
m
,

751 
	`iûm_£Ëùed_Ïddr
(
m
->
iûm
, 1),

752 
	`iûm_£Ëùed_Ïddr
(
m
->
iûm
, 2));

754 
”r
 |ğ
	`£t_medŸ_©Œibu‹s
(
m
);

757  
”r
;

761 
	`LIST_FOREACH
(&
£ss
->
medŸl
, 
Ë
) {

762 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

764 ià(
	`sdp_medŸ_has_medŸ
(
m
->
sdpm
)) {

765 
m
->
com¶‘e
 = 
çl£
;

767 ià(
iû
.
mode
 =ğ
ICE_MODE_FULL
) {

768 
”r
 = 
	`iûm_cÚncheck_¡¬t
(
m
->
iûm
);

769 ià(
”r
)

770  
”r
;

774 ià(
£ss
->
medŸl
.
h—d
 =ğ
Ë
) {

775 
	`iû_ÿnd·œ_£t_¡©es
(
m
->
iûm
);

780 
m
->
com¶‘e
 = 
Œue
;

784 
£ss
->
¡¬‹d
 = 
Œue
;

787 
	}
}

790 
	$medŸ_®loc
(
mÇt_medŸ
 **
mp
, 
mÇt_£ss
 *
£ss
,

791 
´Ùo
, *
sock1
, *
sock2
,

792 
sdp_medŸ
 *
sdpm
)

794 
mÇt_medŸ
 *
m
;

795 
iû_rŞe
 
rŞe
;

796 
i
;

797 
”r
 = 0;

799 ià(!
mp
 || !
£ss
 || !
sdpm
)

800  
EINVAL
;

802 
m
 = 
	`mem_z®loc
((*m), 
medŸ_de¡ruùÜ
);

803 ià(!
m
)

804  
ENOMEM
;

806 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

807 
m
->
sdpm
 = 
	`mem_»f
(sdpm);

808 
m
->
£ss
 = sess;

809 
m
->
compv
[0].
sock
 = 
	`mem_»f
(
sock1
);

810 
m
->
compv
[1].
sock
 = 
	`mem_»f
(
sock2
);

812 ià(
£ss
->
ofã»r
)

813 
rŞe
 = 
ICE_ROLE_CONTROLLING
;

815 
rŞe
 = 
ICE_ROLE_CONTROLLED
;

817 
”r
 = 
	`iûm_®loc
(&
m
->
iûm
, 
iû
.
mode
, 
rŞe
,

818 
´Ùo
, 
ICE_LAYER
,

819 
£ss
->
t›brk
, sess->
luäag
, sess->
Íwd
,

820 
cÚncheck_hªdËr
, 
m
);

821 ià(
”r
)

822 
out
;

824 
	`iûm_cÚf
(
m
->
iûm
)->
nom
 = 
iû
.nom;

825 
	`iûm_cÚf
(
m
->
iûm
)->
debug
 = 
iû
.debug;

826 
	`iûm_cÚf
(
m
->
iûm
)->
rc
 = 4;

828 
	`iûm_£t_cÚf
(
m
->
iûm
, 
	`iûm_cÚf
(m->icem));

830 
	`iûm_£t_Çme
(
m
->
iûm
, 
	`sdp_medŸ_Çme
(
sdpm
));

832 
i
=0; i<2; i++) {

833 
m
->
compv
[
i
].m = m;

834 
m
->
compv
[
i
].
id
 = i+1;

835 ià(
m
->
compv
[
i
].
sock
)

836 
”r
 |ğ
	`iûm_comp_add
(
m
->
iûm
, 
i
+1, m->
compv
[i].
sock
);

839 ià(
	`§_is£t
(&
£ss
->
¤v
, 
SA_ALL
))

840 
”r
 |ğ
	`medŸ_¡¬t
(
£ss
, 
m
);

842 
out
:

843 ià(
”r
)

844 
	`mem_d”ef
(
m
);

846 *
mp
 = 
m
;

847 ++
£ss
->
medŸc
;

850  
”r
;

851 
	}
}

854 
boŞ
 
	$sdp_©Œ_hªdËr
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, *
¬g
)

856 
mÇt_£ss
 *
£ss
 = 
¬g
;

857 
Ë
 *le;

859 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

860 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

862 ()
	`iû_sdp_decode
(
m
->
iûm
, 
Çme
, 
v®ue
);

865  
çl£
;

866 
	}
}

869 
boŞ
 
	$medŸ_©Œ_hªdËr
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, *
¬g
)

871 
mÇt_medŸ
 *
m
 = 
¬g
;

872  0 !ğ
	`iûm_sdp_decode
(
m
->
iûm
, 
Çme
, 
v®ue
);

873 
	}
}

876 
	$’abË_tuº_chªÃls
(
mÇt_£ss
 *
£ss
)

878 
Ë
 *le;

879 
”r
 = 0;

881 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

883 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

884 
§
 
¿ddr
[2];

885 
i
;

887 
”r
 |ğ
	`£t_medŸ_©Œibu‹s
(
m
);

889 
¿ddr
[0] = *
	`sdp_medŸ_¿ddr
(
m
->
sdpm
);

890 
	`sdp_medŸ_¿ddr_¹ı
(
m
->
sdpm
, &
¿ddr
[1]);

892 
i
=0; i<2; i++) {

893 ià(
m
->
compv
[
i
].
sock
 && 
	`§_is£t
(&
¿ddr
[i], 
SA_ALL
))

894 
”r
 |ğ
	`iûm_add_chª
(
m
->
iûm
, 
i
+1, &
¿ddr
[i]);

898  
”r
;

899 
	}
}

903 
	$upd©e
(
mÇt_£ss
 *
£ss
)

905 
Ë
 *le;

906 
”r
 = 0;

909 ()
	`sdp_£ssiÚ_¿‰r_­¶y
(
£ss
->
sdp
, 
NULL
, 
sdp_©Œ_hªdËr
, sess);

912 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

913 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

915 
	`sdp_medŸ_¿‰r_­¶y
(
m
->
sdpm
, 
NULL
, 
medŸ_©Œ_hªdËr
, m);

919 ià(
	`v”ify_³”_iû
(
£ss
)) {

920 
”r
 = 
	`iû_¡¬t
(
£ss
);

922 ià(
iû
.
tuº
) {

923 
	`šfo
("ice: ICE‚ot supported by…eer, fallbacko TURN\n");

924 
”r
 = 
	`’abË_tuº_chªÃls
(
£ss
);

927 
	`šfo
("ice: ICE‚ot supported by…eer\n");

929 
	`LIST_FOREACH
(&
£ss
->
medŸl
, 
Ë
) {

930 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

932 
”r
 |ğ
	`£t_medŸ_©Œibu‹s
(
m
);

936  
”r
;

937 
	}
}

940 
	$moduË_š™
()

942 #ifdeà
MODULE_CONF


943 
¶
…l;

945 
	`cÚf_g‘_boŞ
(
	`cÚf_cur
(), "iû_tuº", &
iû
.
tuº
);

946 
	`cÚf_g‘_boŞ
(
	`cÚf_cur
(), "iû_debug", &
iû
.
debug
);

948 ià(!
	`cÚf_g‘
(
	`cÚf_cur
(), "iû_nomš©iÚ", &
¶
)) {

949 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "regular"))

950 
iû
.
nom
 = 
ICE_NOMINATION_REGULAR
;

951 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "aggressive"))

952 
iû
.
nom
 = 
ICE_NOMINATION_AGGRESSIVE
;

954 
	`w¬nšg
("iû: unknowÀnomš©iÚ: %r\n", &
¶
);

955  
EINVAL
;

958 ià(!
	`cÚf_g‘
(
	`cÚf_cur
(), "iû_mode", &
¶
)) {

959 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "full"))

960 
iû
.
mode
 = 
ICE_MODE_FULL
;

961 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "lite"))

962 
iû
.
mode
 = 
ICE_MODE_LITE
;

964 
	`w¬nšg
("iû: unknowÀmode: %r\n", &
¶
);

965  
EINVAL
;

970  
	`mÇt_»gi¡”
(&
mÇt
, 
	`b¬es_mÇ
(),

972 
£ssiÚ_®loc
, 
medŸ_®loc
, 
upd©e
);

973 
	}
}

976 
	$moduË_şo£
()

978 
mÇt
 = 
	`mem_d”ef
(mnat);

981 
	}
}

984 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
iû
) = {

987 
moduË_š™
,

988 
moduË_şo£
,

	@baresip/modules/ilbc/ilbc.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<iLBC_defše.h
>

9 
	~<iLBC_decode.h
>

10 
	~<iLBC_’code.h
>

35 
	mDEFAULT_MODE
 = 20,

36 
	mUSE_ENHANCER
 = 1

39 
	sau’c_¡©e
 {

40 
iLBC_Enc_In¡_t
 
	m’c
;

41 
	mmode
;

42 
ušt32_t
 
	m’c_by‹s
;

45 
	saudec_¡©e
 {

46 
iLBC_Dec_In¡_t
 
	mdec
;

47 
	mmode
;

48 
ušt32_t
 
	mn§mp
;

49 
size_t
 
	mdec_by‹s
;

53 
	gbc_fm
[32];

56 
	$£t_’cod”_mode
(
au’c_¡©e
 *
¡
, 
mode
)

58 ià(
¡
->
mode
 == mode)

61 
	`šfo
("bc: s‘ iLBCƒncod” mod%dms\n", 
mode
);

63 
¡
->
mode
 = mode;

65 
mode
) {

68 
¡
->
’c_by‹s
 = 
NO_OF_BYTES_20MS
;

72 
¡
->
’c_by‹s
 = 
NO_OF_BYTES_30MS
;

76 
	`w¬nšg
("bc: unknowÀ’cod” mod%d\n", 
mode
);

80 
¡
->
’c_by‹s
 = 
	`š™Encode
(&¡->
’c
, 
mode
);

81 
	}
}

84 
	$£t_decod”_mode
(
audec_¡©e
 *
¡
, 
mode
)

86 ià(
¡
->
mode
 == mode)

89 
	`šfo
("bc: s‘ iLBC decod” mod%dms\n", 
mode
);

91 
¡
->
mode
 = mode;

93 
mode
) {

96 
¡
->
n§mp
 = 
BLOCKL_20MS
;

100 
¡
->
n§mp
 = 
BLOCKL_30MS
;

104 
	`w¬nšg
("bc: unknowÀdecod” mod%d\n", 
mode
);

108 
¡
->
n§mp
 = 
	`š™Decode
(&¡->
dec
, 
mode
, 
USE_ENHANCER
);

109 
	}
}

112 
	$’cod”_fm_decode
(
au’c_¡©e
 *
¡
, cÚ¡ *
fm
)

114 
¶
 
mode
;

116 ià(!
fm
)

119 ià(
	`»_»gex
(
fm
, 
	`¡¾’
(fm), "mode=[0-9]+", &
mode
))

122 
	`£t_’cod”_mode
(
¡
, 
	`¶_u32
(&
mode
));

123 
	}
}

126 
	$decod”_fm_decode
(
audec_¡©e
 *
¡
, cÚ¡ *
fm
)

128 
¶
 
mode
;

130 ià(!
fm
)

133 ià(
	`»_»gex
(
fm
, 
	`¡¾’
(fm), "mode=[0-9]+", &
mode
))

136 
	`£t_decod”_mode
(
¡
, 
	`¶_u32
(&
mode
));

137 
	}
}

140 
	$’code_de¡ruùÜ
(*
¬g
)

142 
au’c_¡©e
 *
¡
 = 
¬g
;

143 ()
¡
;

144 
	}
}

147 
	$decode_de¡ruùÜ
(*
¬g
)

149 
audec_¡©e
 *
¡
 = 
¬g
;

150 ()
¡
;

151 
	}
}

154 
	$check_±ime
(cÚ¡ 
au’c_·¿m
 *
´m
)

156 ià(!
´m
)

159 
´m
->
±ime
) {

166 
	`w¬nšg
("bc: inv®id…tim%u ms\n", 
´m
->
±ime
);

167  
EINVAL
;

169 
	}
}

172 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

173 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

175 
au’c_¡©e
 *
¡
;

176 
”r
 = 0;

178 ià(!
«¥
 || !
ac
 || !
´m
)

179  
EINVAL
;

180 ià(
	`check_±ime
(
´m
))

181  
EINVAL
;

182 ià(*
«¥
)

185 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

186 ià(!
¡
)

187  
ENOMEM
;

189 
	`£t_’cod”_mode
(
¡
, 
DEFAULT_MODE
);

191 ià(
	`¡r_is£t
(
fm
))

192 
	`’cod”_fm_decode
(
¡
, 
fm
);

195 ià(
´m
) {

196 
´m
->
±ime
 = 
¡
->
mode
;

199 ià(
”r
)

200 
	`mem_d”ef
(
¡
);

202 *
«¥
 = 
¡
;

204  
”r
;

205 
	}
}

208 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

209 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

211 
audec_¡©e
 *
¡
;

212 
”r
 = 0;

213 ()
fm
;

215 ià(!
ad¥
 || !
ac
)

216  
EINVAL
;

217 ià(*
ad¥
)

220 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

221 ià(!
¡
)

222  
ENOMEM
;

224 
	`£t_decod”_mode
(
¡
, 
DEFAULT_MODE
);

226 ià(
	`¡r_is£t
(
fm
))

227 
	`decod”_fm_decode
(
¡
, 
fm
);

229 ià(
”r
)

230 
	`mem_d”ef
(
¡
);

232 *
ad¥
 = 
¡
;

234  
”r
;

235 
	}
}

238 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
,

239 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

241 
æßt_buf
[
§mpc
];

242 
ušt32_t
 
i
;

245 ià(*
Ën
 < 
¡
->
’c_by‹s
) {

246 
	`w¬nšg
("ilbc:ƒncode: buffer isoo small (%u bytes)\n",

247 *
Ën
);

248  
ENOMEM
;

252 
i
=0; i<
§mpc
; i++) {

253 cÚ¡ 
št16_t
 
v
 = 
§mpv
[
i
];

254 
æßt_buf
[
i
] = ()
v
;

257 
	`iLBC_’code
(
buf
,

258 
æßt_buf
,

259 &
¡
->
’c
);

261 *
Ën
 = 
¡
->
’c_by‹s
;

264 
	}
}

267 
	$do_dec
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

268 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

270 
æßt_buf
[
¡
->
n§mp
];

271 cÚ¡ 
mode
 = 
Ën
 ? 1 : 0;

272 
ušt32_t
 
i
;

275 ià(*
§mpc
 < 
¡
->
n§mp
)

276  
ENOMEM
;

278 
	`iLBC_decode
(
æßt_buf
,

279 (
ušt8_t
 *)
buf
,

280 &
¡
->
dec
,

281 
mode
);

284 
i
=0; i<
¡
->
n§mp
; i++) {

285 
§mpv
[
i
] = (
št16_t
)
æßt_buf
[i];

288 *
§mpc
 = 
¡
->
n§mp
;

291 
	}
}

294 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

295 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

298 ià(
¡
->
dec_by‹s
 !ğ
Ën
) {

300 
¡
->
dec_by‹s
 = 
Ën
;

302 
¡
->
dec_by‹s
) {

304 
NO_OF_BYTES_20MS
:

305 
	`£t_decod”_mode
(
¡
, 20);

308 
NO_OF_BYTES_30MS
:

309 
	`£t_decod”_mode
(
¡
, 30);

313 
	`w¬nšg
("ilbc: decode:ƒxpect %u, got %u\n",

314 
¡
->
dec_by‹s
, 
Ën
);

315  
EINVAL
;

319  
	`do_dec
(
¡
, 
§mpv
, 
§mpc
, 
buf
, 
Ën
);

320 
	}
}

323 
	$pkloss
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

325  
	`do_dec
(
¡
, 
§mpv
, 
§mpc
, 
NULL
, 0);

326 
	}
}

329 
aucodec
 
	gbc
 = {

330 
LE_INIT
, 0, "iLBC", 8000, 8000, 1, 
bc_fm
,

331 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0

335 
	$moduË_š™
()

337 ()
	`»_¢´štf
(
bc_fm
, (ilbc_fmtp),

338 "mode=%d", 
DEFAULT_MODE
);

340 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
bc
);

342 
	}
}

345 
	$moduË_şo£
()

347 
	`aucodec_uÄegi¡”
(&
bc
);

349 
	}
}

352 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
bc
) = {

355 
moduË_š™
,

356 
moduË_şo£


	@baresip/modules/isac/isac.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"i§c.h
"

20 
	sau’c_¡©e
 {

21 
ISACSŒuù
 *
	mš¡
;

24 
	saudec_¡©e
 {

25 
ISACSŒuù
 *
	mš¡
;

29 
	$’code_de¡ruùÜ
(*
¬g
)

31 
au’c_¡©e
 *
¡
 = 
¬g
;

33 ià(
¡
->
š¡
)

34 
	`WebRtcI§c_F»e
(
¡
->
š¡
);

35 
	}
}

38 
	$decode_de¡ruùÜ
(*
¬g
)

40 
audec_¡©e
 *
¡
 = 
¬g
;

42 ià(
¡
->
š¡
)

43 
	`WebRtcI§c_F»e
(
¡
->
š¡
);

44 
	}
}

47 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

48 cÚ¡ 
aucodec
 *
ac
,

49 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

51 
au’c_¡©e
 *
¡
;

52 
”r
 = 0;

53 ()
´m
;

54 ()
fm
;

56 ià(!
«¥
 || !
ac
)

57  
EINVAL
;

59 ià(*
«¥
)

62 
¡
 = 
	`mem_®loc
((*¡), 
’code_de¡ruùÜ
);

63 ià(!
¡
)

64  
ENOMEM
;

66 ià(
	`WebRtcI§c_C»©e
(&
¡
->
š¡
) < 0) {

67 
”r
 = 
ENOMEM
;

68 
out
;

71 
	`WebRtcI§c_Encod”In™
(
¡
->
š¡
, 0);

73 ià(
ac
->
¤©e
 == 32000)

74 
	`WebRtcI§c_S‘EncSampR©e
(
¡
->
š¡
, 
kI§cSu³rWidebªd
);

76 
out
:

77 ià(
”r
)

78 
	`mem_d”ef
(
¡
);

80 *
«¥
 = 
¡
;

82  
”r
;

83 
	}
}

86 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

87 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

89 
audec_¡©e
 *
¡
;

90 
”r
 = 0;

91 ()
fm
;

93 ià(!
ad¥
 || !
ac
)

94  
EINVAL
;

96 ià(*
ad¥
)

99 
¡
 = 
	`mem_®loc
((*¡), 
decode_de¡ruùÜ
);

100 ià(!
¡
)

101  
ENOMEM
;

103 ià(
	`WebRtcI§c_C»©e
(&
¡
->
š¡
) < 0) {

104 
”r
 = 
ENOMEM
;

105 
out
;

108 
	`WebRtcI§c_Decod”In™
(
¡
->
š¡
);

110 ià(
ac
->
¤©e
 == 32000)

111 
	`WebRtcI§c_S‘DecSampR©e
(
¡
->
š¡
, 
kI§cSu³rWidebªd
);

113 
out
:

114 ià(
”r
)

115 
	`mem_d”ef
(
¡
);

117 *
ad¥
 = 
¡
;

119  
”r
;

120 
	}
}

123 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

124 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

126 
WebRtc_WÜd16
 
Ën1
, 
Ën2
;

127 
size_t
 
l
;

129 ià(!
¡
 || !
buf
 || !
Ën
 || !
§mpv
 || !
§mpc
)

130  
EINVAL
;

133 
Ën1
 = 
	`WebRtcI§c_Encode
(
¡
->
š¡
, 
§mpv
, (*)
buf
);

134 
Ën2
 = 
	`WebRtcI§c_Encode
(
¡
->
š¡
, &
§mpv
[
§mpc
/2], (*)
buf
);

136 
l
 = 
Ën1
 ?†’1 : 
Ën2
;

138 ià(
l
 > *
Ën
)

139  
ENOMEM
;

141 *
Ën
 = 
l
;

144 
	}
}

147 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

148 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

150 
WebRtc_WÜd16
 
¥“chTy³
;

151 
n
;

153 ià(!
¡
 || !
§mpv
 || !
§mpc
 || !
buf
 || !
Ën
)

154  
EINVAL
;

156 
n
 = 
	`WebRtcI§c_Decode
(
¡
->
š¡
, (*)
buf
, 
Ën
,

157 (*)
§mpv
, &
¥“chTy³
);

158 ià(
n
 < 0)

159  
EPROTO
;

161 ià((
size_t
)
n
 > *
§mpc
)

162  
ENOMEM
;

164 *
§mpc
 = 
n
;

167 
	}
}

170 
	$¶c
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

172 
n
;

174 ià(!
¡
 || !
§mpv
 || !
§mpc
)

175  
EINVAL
;

177 
n
 = 
	`WebRtcI§c_DecodePlc
(
¡
->
š¡
, (*)
§mpv
, 1);

178 ià(
n
 < 0)

179  
EPROTO
;

181 *
§mpc
 = 
n
;

184 
	}
}

187 
aucodec
 
	gi§cv
[] = {

189 
LE_INIT
, 0, "i§c", 32000, 32000, 1, 
NULL
,

190 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
¶c
, 
NULL
, NULL

193 
LE_INIT
, 0, "i§c", 16000, 16000, 1, 
NULL
,

194 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
¶c
, 
NULL
, NULL

199 
	$moduË_š™
()

201 
i
;

203 
i
=0; i<
	`ARRAY_SIZE
(
i§cv
); i++)

204 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
i§cv
[
i
]);

207 
	}
}

210 
	$moduË_şo£
()

212 
i
 = 
	`ARRAY_SIZE
(
i§cv
);

214 
i
--)

215 
	`aucodec_uÄegi¡”
(&
i§cv
[
i
]);

218 
	}
}

221 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
i§c
) = {

224 
moduË_š™
,

225 
moduË_şo£


	@baresip/modules/jack/jack.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"mod_jack.h
"

12 
au¶ay
 *
	gau¶ay
;

13 
au¤c
 *
	gau¤c
;

16 
	$moduË_š™
()

18 
”r
 = 0;

20 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

21 "jack", 
jack_¶ay_®loc
);

22 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

23 "jack", 
jack_¤c_®loc
);

25  
”r
;

26 
	}
}

29 
	$moduË_şo£
()

31 
au¶ay
 = 
	`mem_d”ef
(auplay);

32 
au¤c
 = 
	`mem_d”ef
(ausrc);

35 
	}
}

38 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
jack
) = {

41 
moduË_š™
,

42 
moduË_şo£


	@baresip/modules/jack/jack_play.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<jack/jack.h
>

10 
	~"mod_jack.h
"

13 
	sau¶ay_¡
 {

14 cÚ¡ 
au¶ay
 *
	m­
;

16 
au¶ay_´m
 
	m´m
;

17 
št16_t
 *
	m§mpv
;

18 
size_t
 
	m§mpc
;

19 
au¶ay_wr™e_h
 *
	mwh
;

20 *
	m¬g
;

22 
jack_ş›Á_t
 *
	mş›Á
;

23 
jack_pÜt_t
 *
	mpÜtv
[2];

24 
jack_näames_t
 
	mnäames
;

28 
šlše
 
	$au§mp_shÜt2æßt
(
št16_t
 
š
)

30 
out
;

32 
out
 = (è(
š
 / (1.0 * 0x8000));

34  
out
;

35 
	}
}

48 
	$´oûss_hªdËr
(
jack_näames_t
 
näames
, *
¬g
)

50 
au¶ay_¡
 *
¡
 = 
¬g
;

51 
size_t
 
§mpc
 = 
näames
 * 
¡
->
´m
.
ch
;

52 
size_t
 
ch
, 
j
;

55 
¡
->
	`wh
(¡->
§mpv
, 
§mpc
, st->
¬g
);

60 
ch
 = 0; ch < 
¡
->
´m
.ch; ch++) {

62 
jack_deçuÉ_audio_§m¶e_t
 *
bufãr
;

64 
bufãr
 = 
	`jack_pÜt_g‘_bufãr
(
¡
->
pÜtv
[
ch
], st->
näames
);

66 
j
 = 0; j < 
näames
; j++) {

67 
št16_t
 
§mp
 = 
¡
->
§mpv
[
j
*¡->
´m
.
ch
 + ch];

68 
bufãr
[
j
] = 
	`au§mp_shÜt2æßt
(
§mp
);

73 
	}
}

76 
	$au¶ay_de¡ruùÜ
(*
¬g
)

78 
au¶ay_¡
 *
¡
 = 
¬g
;

80 
	`šfo
("jack: destroy\n");

82 ià(
¡
->
ş›Á
)

83 
	`jack_ş›Á_şo£
(
¡
->
ş›Á
);

85 
	`mem_d”ef
(
¡
->
§mpv
);

86 
	}
}

89 
	$¡¬t_jack
(
au¶ay_¡
 *
¡
)

91 cÚ¡ **
pÜts
;

92 cÚ¡ *
ş›Á_Çme
 = "baresip";

93 cÚ¡ *
£rv”_Çme
 = 
NULL
;

94 
jack_İtiÚs_t
 
İtiÚs
 = 
JackNuÎO±iÚ
;

95 
jack_¡©us_t
 
¡©us
;

96 
ch
;

97 
jack_näames_t
 
’gše_¤©e
;

101 
¡
->
ş›Á
 = 
	`jack_ş›Á_İ’
(
ş›Á_Çme
, 
İtiÚs
,

102 &
¡©us
, 
£rv”_Çme
);

103 ià(
¡
->
ş›Á
 =ğ
NULL
) {

104 
	`w¬nšg
("jack: jack_client_open() failed, "

105 "¡©u ğ0x%2.0x\n", 
¡©us
);

107 ià(
¡©us
 & 
JackS”v”Faed
) {

108 
	`w¬nšg
("jack: Unableo connecto JACK server\n");

110  
ENODEV
;

112 ià(
¡©us
 & 
JackS”v”S¹ed
) {

113 
	`šfo
("jack: JACK server started\n");

115 ià(
¡©us
 & 
JackNameNÙUnique
) {

116 
ş›Á_Çme
 = 
	`jack_g‘_ş›Á_Çme
(
¡
->
ş›Á
);

117 
	`šfo
("jack: uniquÇm`%s'‡ssigÃd\n", 
ş›Á_Çme
);

120 
	`jack_£t_´oûss_ÿÎback
(
¡
->
ş›Á
, 
´oûss_hªdËr
, st);

122 
’gše_¤©e
 = 
	`jack_g‘_§m¶e_¿‹
(
¡
->
ş›Á
);

123 
¡
->
näames
 = 
	`jack_g‘_bufãr_size
(¡->
ş›Á
);

125 
	`šfo
("jack:ƒngš§m¶¿‹: %" 
PRIu32
 " max_frames=%u\n",

126 
’gše_¤©e
, 
¡
->
näames
);

130 ià(
’gše_¤©e
 !ğ
¡
->
´m
.
¤©e
) {

131 
	`w¬nšg
("jack: sam¶”©%uHzƒx³ùed\n", 
’gše_¤©e
);

132  
EINVAL
;

136 
ch
=0; ch<
¡
->
´m
.ch; ch++) {

138 
buf
[32];

139 
	`»_¢´štf
(
buf
, (buf), "ouut_%u", 
ch
+1);

141 
¡
->
pÜtv
[
ch
] = 
	`jack_pÜt_»gi¡”
 (¡->
ş›Á
, 
buf
,

142 
JACK_DEFAULT_AUDIO_TYPE
,

143 
JackPÜtIsOuut
, 0);

144 iàĞ
¡
->
pÜtv
[
ch
] =ğ
NULL
) {

145 
	`w¬nšg
("jack:‚o more JACK…orts‡vailable\n");

146  
ENODEV
;

153 ià(
	`jack_aùiv©e
 (
¡
->
ş›Á
)) {

154 
	`w¬nšg
("jack: cannot‡ctivate client");

155  
ENODEV
;

166 
pÜts
 = 
	`jack_g‘_pÜts
 (
¡
->
ş›Á
, 
NULL
, NULL,

167 
JackPÜtIsIÅut
);

168 ià(
pÜts
 =ğ
NULL
) {

169 
	`w¬nšg
("jack:‚o…hysical…layback…orts\n");

170  
ENODEV
;

173 
ch
=0; ch<
¡
->
´m
.ch; ch++) {

175 ià(
	`jack_cÚÃù
 (
¡
->
ş›Á
, 
	`jack_pÜt_Çme
 (¡->
pÜtv
[
ch
]),

176 
pÜts
[
ch
])) {

177 
	`w¬nšg
("jack: cannot connect output…orts\n");

181 
	`jack_ä“
(
pÜts
);

184 
	}
}

187 
	$jack_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

188 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

189 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

191 
au¶ay_¡
 *
¡
;

192 
”r
 = 0;

194 ()
deviû
;

196 ià(!
¡p
 || !
­
 || !
´m
 || !
wh
)

197  
EINVAL
;

199 
	`šfo
("jack:…Ïy %uHz,%uch\n", 
´m
->
¤©e
,…rm->
ch
);

201 ià(
´m
->
ch
 > 
	`ARRAY_SIZE
(
¡
->
pÜtv
))

202  
EINVAL
;

204 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

205 
	`w¬nšg
("jack:…layback: unsupported sample format (%s)\n",

206 
	`aufmt_Çme
(
´m
->
fmt
));

207  
ENOTSUP
;

210 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

211 ià(!
¡
)

212  
ENOMEM
;

214 
¡
->
´m
 = *prm;

215 
¡
->
­
 =‡p;

216 
¡
->
wh
 = wh;

217 
¡
->
¬g
 =‡rg;

219 
”r
 = 
	`¡¬t_jack
(
¡
);

220 ià(
”r
)

221 
out
;

223 
¡
->
§mpc
 = st->
näames
 * 
´m
->
ch
;

224 
¡
->
§mpv
 = 
	`mem_®loc
(¡->
§mpc
 * (
št16_t
), 
NULL
);

225 ià(!
¡
->
§mpv
) {

226 
”r
 = 
ENOMEM
;

227 
out
;

230 
	`šfo
("jack: sampc=%zu\n", 
¡
->
§mpc
);

232 
out
:

233 ià(
”r
)

234 
	`mem_d”ef
(
¡
);

236 *
¡p
 = 
¡
;

238  
”r
;

239 
	}
}

	@baresip/modules/jack/jack_src.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<m©h.h
>

10 
	~<jack/jack.h
>

11 
	~"mod_jack.h
"

14 
	sau¤c_¡
 {

15 cÚ¡ 
au¤c
 *
	mas
;

17 
au¤c_´m
 
	m´m
;

18 
št16_t
 *
	m§mpv
;

19 
size_t
 
	m§mpc
;

20 
au¤c_»ad_h
 *
	mrh
;

21 *
	m¬g
;

23 
jack_ş›Á_t
 *
	mş›Á
;

24 
jack_pÜt_t
 *
	mpÜtv
[2];

25 
jack_näames_t
 
	mnäames
;

29 
šlše
 
št16_t
 
	$au§mp_æßt2shÜt
(
š
)

31 
sÿËd_v®ue
;

32 
št16_t
 
out
;

34 
sÿËd_v®ue
 = 
š
 * (8.0 * 0x10000000);

36 ià(
sÿËd_v®ue
 >= (1.0 * 0x7fffffff)) {

37 
out
 = 32767;

39 ià(
sÿËd_v®ue
 <= (-8.0 * 0x10000000)) {

40 
out
 = -32768;

43 
out
 = (è(
	`Ìšt
 (
sÿËd_v®ue
) >> 16);

45  
out
;

46 
	}
}

49 
	$´oûss_hªdËr
(
jack_näames_t
 
näames
, *
¬g
)

51 
au¤c_¡
 *
¡
 = 
¬g
;

52 
size_t
 
§mpc
 = 
näames
 * 
¡
->
´m
.
ch
;

53 
size_t
 
ch
, 
j
;

58 
ch
 = 0; ch < 
¡
->
´m
.ch; ch++) {

60 cÚ¡ 
jack_deçuÉ_audio_§m¶e_t
 *
bufãr
;

62 
bufãr
 = 
	`jack_pÜt_g‘_bufãr
(
¡
->
pÜtv
[
ch
], st->
näames
);

64 
j
 = 0; j < 
näames
; j++) {

65 
št16_t
 
§mp
;

66 
§mp
 = 
	`au§mp_æßt2shÜt
(
bufãr
[
j
]);

67 
¡
->
§mpv
[
j
*¡->
´m
.
ch
 + ch] = 
§mp
;

72 
¡
->
	`rh
(¡->
§mpv
, 
§mpc
, st->
¬g
);

75 
	}
}

78 
	$au¤c_de¡ruùÜ
(*
¬g
)

80 
au¤c_¡
 *
¡
 = 
¬g
;

82 
	`šfo
("jack: source destroy\n");

84 ià(
¡
->
ş›Á
)

85 
	`jack_ş›Á_şo£
(
¡
->
ş›Á
);

87 
	`mem_d”ef
(
¡
->
§mpv
);

88 
	}
}

91 
	$¡¬t_jack
(
au¤c_¡
 *
¡
)

93 cÚ¡ **
pÜts
;

94 cÚ¡ *
ş›Á_Çme
 = "baresip";

95 cÚ¡ *
£rv”_Çme
 = 
NULL
;

96 
jack_İtiÚs_t
 
İtiÚs
 = 
JackNuÎO±iÚ
;

97 
jack_¡©us_t
 
¡©us
;

98 
ch
;

99 
jack_näames_t
 
’gše_¤©e
;

103 
¡
->
ş›Á
 = 
	`jack_ş›Á_İ’
(
ş›Á_Çme
, 
İtiÚs
,

104 &
¡©us
, 
£rv”_Çme
);

105 ià(
¡
->
ş›Á
 =ğ
NULL
) {

106 
	`w¬nšg
("jack: jack_client_open() failed, "

107 "¡©u ğ0x%2.0x\n", 
¡©us
);

109 ià(
¡©us
 & 
JackS”v”Faed
) {

110 
	`w¬nšg
("jack: Unableo connecto JACK server\n");

112  
ENODEV
;

114 ià(
¡©us
 & 
JackS”v”S¹ed
) {

115 
	`šfo
("jack: JACK server started\n");

117 ià(
¡©us
 & 
JackNameNÙUnique
) {

118 
ş›Á_Çme
 = 
	`jack_g‘_ş›Á_Çme
(
¡
->
ş›Á
);

119 
	`šfo
("jack: uniquÇm`%s'‡ssigÃd\n", 
ş›Á_Çme
);

122 
	`jack_£t_´oûss_ÿÎback
(
¡
->
ş›Á
, 
´oûss_hªdËr
, st);

124 
’gše_¤©e
 = 
	`jack_g‘_§m¶e_¿‹
(
¡
->
ş›Á
);

125 
¡
->
näames
 = 
	`jack_g‘_bufãr_size
(¡->
ş›Á
);

127 
	`šfo
("jack:ƒngš§m¶¿‹: %" 
PRIu32
 " max_frames=%u\n",

128 
’gše_¤©e
, 
¡
->
näames
);

132 ià(
’gše_¤©e
 !ğ
¡
->
´m
.
¤©e
) {

133 
	`w¬nšg
("jack: sam¶”©%uHzƒx³ùed\n", 
’gše_¤©e
);

134  
EINVAL
;

138 
ch
=0; ch<
¡
->
´m
.ch; ch++) {

140 
buf
[32];

141 
	`»_¢´štf
(
buf
, (buf), "šput_%u", 
ch
+1);

143 
¡
->
pÜtv
[
ch
] = 
	`jack_pÜt_»gi¡”
(¡->
ş›Á
, 
buf
,

144 
JACK_DEFAULT_AUDIO_TYPE
,

145 
JackPÜtIsIÅut
, 0);

146 iàĞ
¡
->
pÜtv
[
ch
] =ğ
NULL
) {

147 
	`w¬nšg
("jack:‚o more JACK…orts‡vailable\n");

148  
ENODEV
;

155 ià(
	`jack_aùiv©e
 (
¡
->
ş›Á
)) {

156 
	`w¬nšg
("jack: cannot‡ctivate client");

157  
ENODEV
;

160 
pÜts
 = 
	`jack_g‘_pÜts
 (
¡
->
ş›Á
, 
NULL
, NULL,

161 
JackPÜtIsOuut
);

162 ià(
pÜts
 =ğ
NULL
) {

163 
	`w¬nšg
("jack:‚o…hysical…layback…orts\n");

164  
ENODEV
;

167 
ch
=0; ch<
¡
->
´m
.ch; ch++) {

169 ià(
	`jack_cÚÃù
(
¡
->
ş›Á
, 
pÜts
[
ch
],

170 
	`jack_pÜt_Çme
(
¡
->
pÜtv
[
ch
]))) {

171 
	`w¬nšg
("jack: cannot connect output…orts\n");

175 
	`jack_ä“
(
pÜts
);

178 
	}
}

181 
	$jack_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

182 
medŸ_ùx
 **
ùx
,

183 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

184 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

186 
au¤c_¡
 *
¡
;

187 
”r
 = 0;

189 ()
ùx
;

190 ()
deviû
;

191 ()
”rh
;

193 ià(!
¡p
 || !
as
 || !
´m
 || !
rh
)

194  
EINVAL
;

196 ià(
´m
->
ch
 > 
	`ARRAY_SIZE
(
¡
->
pÜtv
))

197  
EINVAL
;

199 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

200 
	`w¬nšg
("jack: source: unsupported sample format (%s)\n",

201 
	`aufmt_Çme
(
´m
->
fmt
));

202  
ENOTSUP
;

205 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

206 ià(!
¡
)

207  
ENOMEM
;

209 
¡
->
´m
 = *prm;

210 
¡
->
as
 =‡s;

211 
¡
->
rh
 =„h;

212 
¡
->
¬g
 =‡rg;

214 
”r
 = 
	`¡¬t_jack
(
¡
);

215 ià(
”r
)

216 
out
;

218 
¡
->
§mpc
 = st->
näames
 * 
´m
->
ch
;

219 
¡
->
§mpv
 = 
	`mem_®loc
(¡->
§mpc
 * (
št16_t
), 
NULL
);

220 ià(!
¡
->
§mpv
) {

221 
”r
 = 
ENOMEM
;

222 
out
;

225 
	`šfo
("jack: sourû sampc=%zu\n", 
¡
->
§mpc
);

227 
out
:

228 ià(
”r
)

229 
	`mem_d”ef
(
¡
);

231 *
¡p
 = 
¡
;

233  
”r
;

234 
	}
}

	@baresip/modules/jack/mod_jack.h

8 
jack_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

9 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

10 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

11 
jack_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

12 
medŸ_ùx
 **
ùx
,

13 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

14 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

	@baresip/modules/l16/l16.c

6 
	~<».h
>

7 
	~<b¬es.h
>

17 ’um {
	mNR_CODECS
 = 8};

20 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

21 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

23 
št16_t
 *
p
 = (*)
buf
;

24 ()
¡
;

26 ià(!
buf
 || !
Ën
 || !
§mpv
)

27  
EINVAL
;

29 ià(*
Ën
 < 
§mpc
*2)

30  
ENOMEM
;

32 *
Ën
 = 
§mpc
*2;

34 
§mpc
--)

35 *
p
++ = 
	`htÚs
(*
§mpv
++);

38 
	}
}

41 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

42 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

44 
št16_t
 *
p
 = (*)
buf
;

45 ()
¡
;

47 ià(!
buf
 || !
Ën
 || !
§mpv
)

48  
EINVAL
;

50 ià(*
§mpc
 < 
Ën
/2)

51  
ENOMEM
;

53 *
§mpc
 = 
Ën
/2;

55 
Ën
 /= 2;

56 
Ën
--)

57 *
§mpv
++ = 
	`Áohs
(*
p
++);

60 
	}
}

64 
aucodec
 
	gl16v
[
NR_CODECS
] = {

65 {
LE_INIT
, "10", "L16", 44100, 44100, 2, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

66 {
LE_INIT
, 0, "L16", 32000, 32000, 2, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

67 {
LE_INIT
, 0, "L16", 16000, 16000, 2, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

68 {
LE_INIT
, 0, "L16", 8000, 8000, 2, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

69 {
LE_INIT
, "11", "L16", 44100, 44100, 1, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

70 {
LE_INIT
, 0, "L16", 32000, 32000, 1, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

71 {
LE_INIT
, 0, "L16", 16000, 16000, 1, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

72 {
LE_INIT
, 0, "L16", 8000, 8000, 1, 0, 0, 
’code
, 0, 
decode
, 0, 0, 0},

76 
	$moduË_š™
()

78 
li¡
 *
aucodeş
 = 
	`b¬es_aucodeş
();

79 
size_t
 
i
;

81 
i
=0; i<
NR_CODECS
; i++)

82 
	`aucodec_»gi¡”
(
aucodeş
, &
l16v
[
i
]);

85 
	}
}

88 
	$moduË_şo£
()

90 
size_t
 
i
;

92 
i
=0; i<
NR_CODECS
; i++)

93 
	`aucodec_uÄegi¡”
(&
l16v
[
i
]);

96 
	}
}

99 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
l16
) = {

102 
moduË_š™
,

103 
moduË_şo£


	@baresip/modules/libsrtp/sdes.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"sdes.h
"

11 cÚ¡ 
	gsdp_©Œ_üy±o
[] = "crypto";

14 
	$lib¤_sdes_’code_üy±o
(
sdp_medŸ
 *
m
, 
ušt32_t
 
g
,

15 cÚ¡ *
su™e
,

16 cÚ¡ *
key
, 
size_t
 
key_Ën
)

18  
	`sdp_medŸ_£t_Ï‰r
(
m
, 
Œue
, 
sdp_©Œ_üy±o
, "%u %s inline:%b",

19 
g
, 
su™e
, 
key
, 
key_Ën
);

20 
	}
}

26 
	$lib¤_sdes_decode_üy±o
(
üy±o
 *
c
, cÚ¡ *
v®
)

28 
¶
 
g
, 
key_´ms
;

29 
”r
;

31 
”r
 = 
	`»_»gex
(
v®
, 
	`¡r_Ën
(val), "[0-9]+ [^ ]+ [^ ]+[]*[^]*",

32 &
g
, &
c
->
su™e
, &
key_´ms
, 
NULL
, &c->
£ss_´ms
);

33 ià(
”r
)

34  
”r
;

36 
c
->
g
 = 
	`¶_u32
(&tag);

38 
c
->
liãtime
 = c->
mki
 = 
¶_nuÎ
;

39 
”r
 = 
	`»_»gex
(
key_´ms
.
p
, key_´ms.
l
, "[^:]+:[^|]+[|]*[^|]*[|]*[^|]*",

40 &
c
->
key_m‘hod
, &c->
key_šfo
,

41 
NULL
, &
c
->
liãtime
, NULL, &c->
mki
);

42 ià(
”r
)

43  
”r
;

46 
	}
}

	@baresip/modules/libsrtp/sdes.h

8 
	süy±o
 {

9 
ušt32_t
 
	mg
;

10 
¶
 
	msu™e
;

11 
¶
 
	mkey_m‘hod
;

12 
¶
 
	mkey_šfo
;

13 
¶
 
	mliãtime
;

14 
¶
 
	mmki
;

15 
¶
 
	m£ss_´ms
;

19 
lib¤_sdes_’code_üy±o
(
sdp_medŸ
 *
m
, 
ušt32_t
 
g
,

20 cÚ¡ *
su™e
,

21 cÚ¡ *
key
, 
size_t
 
key_Ën
);

22 
lib¤_sdes_decode_üy±o
(
üy±o
 *
c
, cÚ¡ *
v®
);

	@baresip/modules/libsrtp/srtp.c

6 #ià
defšed
 (
__GNUC__
è&& !defšed (
asm
)

7 
	#asm
 
__asm__


	)

9 
	~<¤/¤.h
>

10 
	~<¤/üy±o_k”Ãl.h
>

11 
	~<».h
>

12 
	~<b¬es.h
>

13 
	~"sdes.h
"

21 
	sm’c_¡
 {

23 
ušt8_t
 
	mkey_tx
[32];

24 
ušt8_t
 
	mkey_rx
[32];

25 
¤_t
 
	m¤_tx
, 
	m¤_rx
;

26 
¤_pŞicy_t
 
	mpŞicy_tx
, 
	mpŞicy_rx
;

27 
boŞ
 
	mu£_¤
;

28 *
	müy±o_su™e
;

30 *
	m¹psock
;

31 *
	m¹ısock
;

32 
udp_h–³r
 *
	muh_¹p
;

33 
udp_h–³r
 *
	muh_¹ı
;

34 
sdp_medŸ
 *
	msdpm
;

38 cÚ¡ 
	g«s_cm_128_hmac_sha1_32
[] = "AES_CM_128_HMAC_SHA1_32";

39 cÚ¡ 
	g«s_cm_128_hmac_sha1_80
[] = "AES_CM_128_HMAC_SHA1_80";

42 
	$de¡ruùÜ
(*
¬g
)

44 
m’c_¡
 *
¡
 = 
¬g
;

46 
	`mem_d”ef
(
¡
->
sdpm
);

47 
	`mem_d”ef
(
¡
->
üy±o_su™e
);

50 
	`mem_d”ef
(
¡
->
uh_¹p
);

51 
	`mem_d”ef
(
¡
->
uh_¹ı
);

52 
	`mem_d”ef
(
¡
->
¹psock
);

53 
	`mem_d”ef
(
¡
->
¹ısock
);

55 ià(
¡
->
¤_tx
)

56 
	`¤_d—Îoc
(
¡
->
¤_tx
);

57 ià(
¡
->
¤_rx
)

58 
	`¤_d—Îoc
(
¡
->
¤_rx
);

59 
	}
}

62 
boŞ
 
	$üy±osu™e_issuµÜ‹d
(cÚ¡ 
¶
 *
su™e
)

64 ià(0 =ğ
	`¶_¡rÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_32
)è 
Œue
;

65 ià(0 =ğ
	`¶_¡rÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_80
)è 
Œue
;

67  
çl£
;

68 
	}
}

71 
	$”r¡©us_´št
(
»_´štf
 *
pf
, 
”r_¡©us_t
 
e
)

73 cÚ¡ *
s
;

75 
e
) {

77 
”r_¡©us_ok
: 
s
 = "ok"; ;

78 
”r_¡©us_ç
: 
s
 = "fail"; ;

79 
”r_¡©us_auth_ç
: 
s
 = "auth_fail"; ;

80 
”r_¡©us_ch”_ç
: 
s
 = "cipher_fail"; ;

81 
”r_¡©us_»¶ay_ç
: 
s
 = "replay_fail"; ;

84  
	`»_h´štf
(
pf
, "”r=%d", 
e
);

87  
	`»_h´štf
(
pf
, "%s", 
s
);

88 
	}
}

103 
boŞ
 
	$is_¹p_Ü_¹ı
(cÚ¡ 
mbuf
 *
mb
)

105 
ušt8_t
 
b
;

107 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

108  
çl£
;

110 
b
 = 
	`mbuf_buf
(
mb
)[0];

112  127 < 
b
 && b < 192;

113 
	}
}

116 
boŞ
 
	$is_¹ı_·ck‘
(cÚ¡ 
mbuf
 *
mb
)

118 
ušt8_t
 
±
;

120 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

121  
çl£
;

123 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

125  64 <ğ
±
 &&…t <= 95;

126 
	}
}

129 
	$¡¬t_¤
(
m’c_¡
 *
¡
, cÚ¡ *
su™e
)

131 
üy±o_pŞicy_t
 
pŞicy
;

132 
”r_¡©us_t
 
e
;

134 ià(0 =ğ
	`¡r_ÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_32
)) {

135 
	`üy±o_pŞicy_£t_«s_cm_128_hmac_sha1_32
(&
pŞicy
);

137 ià(0 =ğ
	`¡r_ÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_80
)) {

138 
	`üy±o_pŞicy_£t_«s_cm_128_hmac_sha1_80
(&
pŞicy
);

141 
	`w¬nšg
("¤: unknowÀSRTP cry±Øsu™(%s)\n", 
su™e
);

142  
ENOENT
;

146 
¡
->
pŞicy_tx
.
¹p
 = 
pŞicy
;

147 
¡
->
pŞicy_tx
.
¹ı
 = 
pŞicy
;

148 
¡
->
pŞicy_tx
.
s¤c
.
ty³
 = 
s¤c_ªy_outbound
;

149 
¡
->
pŞicy_tx
.
key
 = st->
key_tx
;

150 
¡
->
pŞicy_tx
.
Ãxt
 = 
NULL
;

153 
¡
->
pŞicy_rx
.
¹p
 = 
pŞicy
;

154 
¡
->
pŞicy_rx
.
¹ı
 = 
pŞicy
;

155 
¡
->
pŞicy_rx
.
s¤c
.
ty³
 = 
s¤c_ªy_šbound
;

156 
¡
->
pŞicy_rx
.
key
 = st->
key_rx
;

157 
¡
->
pŞicy_rx
.
Ãxt
 = 
NULL
;

160 
e
 = 
	`¤_ü—‹
(&
¡
->
¤_tx
, &¡->
pŞicy_tx
);

161 ià(
e
 !ğ
”r_¡©us_ok
) {

162 
	`w¬nšg
("srtp: srtp_create TX failed (%H)\n",

163 
”r¡©us_´št
, 
e
);

164  
EPROTO
;

167 
e
 = 
	`¤_ü—‹
(&
¡
->
¤_rx
, &¡->
pŞicy_rx
);

168 ià(
”r_¡©us_ok
 !ğ
e
) {

169 
	`w¬nšg
("srtp: srtp_create RX failed (%H)\n",

170 
”r¡©us_´št
, 
e
);

171  
EPROTO
;

175 
¡
->
u£_¤
 = 
Œue
;

178 
	}
}

181 
	$£tup_¤
(
m’c_¡
 *
¡
)

183 
”r_¡©us_t
 
e
;

186 
e
 = 
	`üy±o_g‘_¿ndom
(
¡
->
key_tx
, 
SRTP_MASTER_KEY_LEN
);

187 ià(
”r_¡©us_ok
 !ğ
e
) {

188 
	`w¬nšg
("srtp: crypto_get_random() failed (%H)\n",

189 
”r¡©us_´št
, 
e
);

190  
ENOSYS
;

194 
	}
}

197 
boŞ
 
	$£nd_hªdËr
(*
”r
, 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

199 
m’c_¡
 *
¡
 = 
¬g
;

200 
”r_¡©us_t
 
e
;

201 
Ën
;

202 ()
d¡
;

204 ià(!
¡
->
u£_¤
 || !
	`is_¹p_Ü_¹ı
(
mb
))

205  
çl£
;

207 
Ën
 = ()
	`mbuf_g‘_Ëá
(
mb
);

209 ià(
	`mbuf_g‘_¥aû
(
mb
è< ((
size_t
)
Ën
 + 
SRTP_MAX_TRAILER_LEN
)) {

210 
	`mbuf_»size
(
mb
, mb->
pos
 + 
Ën
 + 
SRTP_MAX_TRAILER_LEN
);

213 ià(
	`is_¹ı_·ck‘
(
mb
)) {

214 
e
 = 
	`¤_´Ùeù_¹ı
(
¡
->
¤_tx
, 
	`mbuf_buf
(
mb
), &
Ën
);

217 
e
 = 
	`¤_´Ùeù
(
¡
->
¤_tx
, 
	`mbuf_buf
(
mb
), &
Ën
);

220 ià(
”r_¡©us_ok
 !ğ
e
) {

221 
	`w¬nšg
("srtp: send: failedo…rotect %s-packet"

223 
	`is_¹ı_·ck‘
(
mb
) ? "RTCP" : "RTP",

224 
Ën
, 
”r¡©us_´št
, 
e
);

225 *
”r
 = 
EPROTO
;

226  
çl£
;

229 
	`mbuf_£t_’d
(
mb
, mb->
pos
 + 
Ën
);

231  
çl£
;

232 
	}
}

235 
boŞ
 
	$»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

237 
m’c_¡
 *
¡
 = 
¬g
;

238 
”r_¡©us_t
 
e
;

239 
Ën
;

240 ()
¤c
;

242 ià(!
¡
->
u£_¤
 || !
	`is_¹p_Ü_¹ı
(
mb
))

243  
çl£
;

245 
Ën
 = ()
	`mbuf_g‘_Ëá
(
mb
);

247 ià(
	`is_¹ı_·ck‘
(
mb
)) {

248 
e
 = 
	`¤_uÅrÙeù_¹ı
(
¡
->
¤_rx
, 
	`mbuf_buf
(
mb
), &
Ën
);

251 
e
 = 
	`¤_uÅrÙeù
(
¡
->
¤_rx
, 
	`mbuf_buf
(
mb
), &
Ën
);

254 ià(
e
 !ğ
”r_¡©us_ok
) {

255 
	`w¬nšg
("srtp:„ecv: failedo unprotect %s-packet"

257 
	`is_¹ı_·ck‘
(
mb
) ? "RTCP" : "RTP",

258 
Ën
, 
”r¡©us_´št
, 
e
);

259  
Œue
;

262 
	`mbuf_£t_’d
(
mb
, mb->
pos
 + 
Ën
);

264  
çl£
;

265 
	}
}

269 
	$sdp_’c
(
m’c_¡
 *
¡
, 
sdp_medŸ
 *
m
,

270 
ušt32_t
 
g
, cÚ¡ *
su™e
)

272 
key
[128] = "";

273 
size_t
 
Ş’
;

274 
”r
;

276 
Ş’
 = (
key
);

277 
”r
 = 
	`ba£64_’code
(
¡
->
key_tx
, 
SRTP_MASTER_KEY_LEN
, 
key
, &
Ş’
);

278 ià(
”r
)

279  
”r
;

281  
	`lib¤_sdes_’code_üy±o
(
m
, 
g
, 
su™e
, 
key
, 
Ş’
);

282 
	}
}

285 
	$¡¬t_üy±o
(
m’c_¡
 *
¡
, cÚ¡ 
¶
 *
key_šfo
)

287 
size_t
 
Ş’
;

288 
”r
;

292 
Ş’
 = (
¡
->
key_rx
);

293 
”r
 = 
	`ba£64_decode
(
key_šfo
->
p
, key_šfo->
l
, 
¡
->
key_rx
, &
Ş’
);

294 ià(
”r
)

295  
”r
;

297 ià(
SRTP_MASTER_KEY_LEN
 !ğ
Ş’
) {

298 
	`w¬nšg
("¤: s¹°keyËÀi %u (should b30)\n", 
Ş’
);

301 
”r
 = 
	`¡¬t_¤
(
¡
, st->
üy±o_su™e
);

302 ià(
”r
)

303  
”r
;

305 
	`šfo
("srtp: %s: SRTP is Enabled (cryptosuite=%s)\n",

306 
	`sdp_medŸ_Çme
(
¡
->
sdpm
), st->
üy±o_su™e
);

309 
	}
}

312 
boŞ
 
	$sdp_©Œ_hªdËr
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, *
¬g
)

314 
m’c_¡
 *
¡
 = 
¬g
;

315 
üy±o
 
c
;

316 ()
Çme
;

318 ià(
	`lib¤_sdes_decode_üy±o
(&
c
, 
v®ue
))

319  
çl£
;

321 ià(0 !ğ
	`¶_¡rcmp
(&
c
.
key_m‘hod
, "inline"))

322  
çl£
;

324 ià(!
	`üy±osu™e_issuµÜ‹d
(&
c
.
su™e
))

325  
çl£
;

327 
¡
->
üy±o_su™e
 = 
	`mem_d”ef
(st->crypto_suite);

328 
	`¶_¡rdup
(&
¡
->
üy±o_su™e
, &
c
.
su™e
);

330 ià(
	`¡¬t_üy±o
(
¡
, &
c
.
key_šfo
))

331  
çl£
;

333 
	`sdp_’c
(
¡
, st->
sdpm
, 
c
.
g
, st->
üy±o_su™e
);

335  
Œue
;

336 
	}
}

339 
	$®loc
(
m’c_medŸ
 **
¡p
, 
m’c_£ss
 *
£ss
,

340 
¹p_sock
 *
¹p
,

341 
´Ùo
, *
¹psock
, *
¹ısock
,

342 
sdp_medŸ
 *
sdpm
)

344 
m’c_¡
 *
¡
;

345 cÚ¡ *
¿‰r
 = 
NULL
;

346 
Ïy”
 = 10;

347 
”r
 = 0;

348 
boŞ
 
mux
 = (
¹psock
 =ğ
¹ısock
);

349 ()
£ss
;

350 ()
¹p
;

352 ià(!
¡p
 || !
sdpm
)

353  
EINVAL
;

354 ià(
´Ùo
 !ğ
IPPROTO_UDP
)

355  
EPROTONOSUPPORT
;

357 
¡
 = (
m’c_¡
 *)*
¡p
;

358 ià(!
¡
) {

360 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

361 ià(!
¡
)

362  
ENOMEM
;

364 
¡
->
sdpm
 = 
	`mem_»f
(sdpm);

366 
”r
 = 
	`sdp_medŸ_£t_®t_´Ùos
(
¡
->
sdpm
, 4,

371 ià(
”r
)

372 
out
;

374 ià(
¹psock
) {

375 
¡
->
¹psock
 = 
	`mem_»f
(rtpsock);

376 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹p
, 
¹psock
,

377 
Ïy”
, 
£nd_hªdËr
,

378 
»cv_hªdËr
, 
¡
);

380 ià(
¹ısock
 && !
mux
) {

381 
¡
->
¹ısock
 = 
	`mem_»f
(rtcpsock);

382 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹ı
, 
¹ısock
,

383 
Ïy”
, 
£nd_hªdËr
,

384 
»cv_hªdËr
, 
¡
);

386 ià(
”r
)

387 
out
;

390 
”r
 |ğ
	`¡r_dup
(&
¡
->
üy±o_su™e
, 
«s_cm_128_hmac_sha1_80
);

391 ià(
”r
)

392 
out
;

394 
”r
 = 
	`£tup_¤
(
¡
);

395 ià(
”r
)

396 
out
;

401 ià(
	`sdp_medŸ_¿‰r
(
¡
->
sdpm
, "crypto")) {

403 
¿‰r
 = 
	`sdp_medŸ_¿‰r_­¶y
(
¡
->
sdpm
, "crypto",

404 
sdp_©Œ_hªdËr
, 
¡
);

405 ià(!
¿‰r
) {

406 
	`w¬nšg
("srtp:‚o valid‡=crypto‡ttribute from"

411 ià(!
¿‰r
)

412 
”r
 = 
	`sdp_’c
(
¡
, 
sdpm
, 0, st->
üy±o_su™e
);

414 
out
:

415 ià(
”r
)

416 
	`mem_d”ef
(
¡
);

418 *
¡p
 = (
m’c_medŸ
 *)
¡
;

420  
”r
;

421 
	}
}

424 
m’c
 
	gm’c_¤_İt
 = {

425 
LE_INIT
, "¤", "RTP/AVP", 
NULL
, 
®loc


428 
m’c
 
	gm’c_¤_mªd
 = {

429 
LE_INIT
, "¤-mªd", "RTP/SAVP", 
NULL
, 
®loc


432 
m’c
 
	gm’c_¤_mªdf
 = {

433 
LE_INIT
, "¤-mªdf", "RTP/SAVPF", 
NULL
, 
®loc


437 
	$mod_¤_š™
()

439 
li¡
 *
m’ş
 = 
	`b¬es_m’ş
();

440 
”r_¡©us_t
 
”r
;

442 
”r
 = 
	`¤_š™
();

443 ià(
”r_¡©us_ok
 !ğ
”r
) {

444 
	`w¬nšg
("srtp: srtp_init() failed (%H)\n",

445 
”r¡©us_´št
, 
”r
);

446  
ENOSYS
;

449 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_İt
);

450 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_mªd
);

451 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_mªdf
);

454 
	}
}

457 
	$mod_¤_şo£
()

459 
	`m’c_uÄegi¡”
(&
m’c_¤_mªdf
);

460 
	`m’c_uÄegi¡”
(&
m’c_¤_mªd
);

461 
	`m’c_uÄegi¡”
(&
m’c_¤_İt
);

463 
	`üy±o_k”Ãl_shutdown
();

466 
	}
}

469 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
lib¤
) = {

472 
mod_¤_š™
,

473 
mod_¤_şo£


	@baresip/modules/menu/menu.c

6 
	~<¡dlib.h
>

7 
	~<time.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

23 
	e¡©mode
 {

24 
	mSTATMODE_CALL
 = 0,

25 
	mSTATMODE_OFF
,

29 
ušt64_t
 
	g¡¬t_ticks
;

30 
tmr
 
	gtmr_®”t
;

31 
tmr
 
	gtmr_¡©
;

32 
¡©mode
 
	g¡©mode
;

33 
mbuf
 *
	gdŸlbuf
;

34 
Ë
 *
	gË_cur
;

37 
¶ay
 *
	m¶ay
;

38 
mes§ge_l¢r
 *
	mmes§ge
;

39 
boŞ
 
	mb–l
;

40 
boŞ
 
	mršgback_di§bËd
;

41 
tmr
 
	mtmr_»dŸl
;

42 
ušt32_t
 
	m»dŸl_d–ay
;

43 
ušt32_t
 
	m»dŸl_©‹m±s
;

44 
ušt32_t
 
	mcu¼’t_©‹m±s
;

45 } 
	gm’u
;

48 
m’u_£t_šÿÎ
(
boŞ
 
šÿÎ
);

49 
upd©e_ÿÎ¡©us
();

50 
®”t_¡İ
();

51 
sw™ch_audio_sourû
(
»_´štf
 *
pf
, *
¬g
);

52 
sw™ch_audio_¶ay”
(
»_´štf
 *
pf
, *
¬g
);

55 
	$»dŸl_»£t
()

57 
	`tmr_ÿnûl
(&
m’u
.
tmr_»dŸl
);

58 
m’u
.
cu¼’t_©‹m±s
 = 0;

59 
	}
}

62 cÚ¡ *
	$Œª¦©e_”rÜcode
(
ušt16_t
 
scode
)

64 
scode
) {

68 487:  
NULL
;

71 
	}
}

74 
	$check_»gi¡¿tiÚs
()

76 
boŞ
 
u®_»ady
 = 
çl£
;

77 
Ë
 *le;

78 
ušt32_t
 
n
;

80 ià(
u®_»ady
)

83 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

84 
ua
 *u¨ğ
Ë
->
d©a
;

86 ià(!
	`ua_i¤egi¡”ed
(
ua
))

90 
n
 = 
	`li¡_couÁ
(
	`uag_li¡
());

93 
	`ui_ouut
(
	`b¬es_uis
(),

96 
n
,‚==1 ? "" : "s",

97 (
ušt32_t
)(
	`tmr_jiff›s
(è- 
¡¬t_ticks
));

99 
u®_»ady
 = 
Œue
;

100 
	}
}

108 
ua
 *
	$uag_cur
()

110  
	`uag_cu¼’t
();

111 
	}
}

115 
boŞ
 
	$have_aùive_ÿÎs
()

117 
Ë
 *le;

119 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

121 
ua
 *u¨ğ
Ë
->
d©a
;

123 ià(
	`ua_ÿÎ
(
ua
))

124  
Œue
;

127  
çl£
;

128 
	}
}

139 
	$ua_´št_»g_¡©us
(
»_´štf
 *
pf
, *
unu£d
)

141 
Ë
 *le;

142 
”r
;

144 ()
unu£d
;

146 
”r
 = 
	`»_h´štf
(
pf
, "\n--- Useragents: %u ---\n",

147 
	`li¡_couÁ
(
	`uag_li¡
()));

149 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†&& !
”r
;†ğË->
Ãxt
) {

150 cÚ¡ 
ua
 *u¨ğ
Ë
->
d©a
;

152 
”r
 = 
	`»_h´štf
(
pf
, "% ", 
ua
 =ğ
	`uag_cur
() ? ">" : " ");

153 
”r
 |ğ
	`ua_´št_¡©us
(
pf
, 
ua
);

156 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

158  
”r
;

159 
	}
}

170 
	$ua_´št_ÿÎ_¡©us
(
»_´štf
 *
pf
, *
unu£d
)

172 
ÿÎ
 *call;

173 
”r
;

175 ()
unu£d
;

177 
ÿÎ
 = 
	`ua_ÿÎ
(
	`uag_cur
());

178 ià(
ÿÎ
) {

179 
”r
 = 
	`»_h´štf
(
pf
, "\n%H\n", 
ÿÎ_debug
, 
ÿÎ
);

182 
”r
 = 
	`»_h´štf
(
pf
, "\n(no‡ctive calls)\n");

185  
”r
;

186 
	}
}

189 
	$dŸl_hªdËr
(
»_´štf
 *
pf
, *
¬g
)

191 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

192 
”r
 = 0;

194 ()
pf
;

196 ià(
	`¡r_is£t
(
ÿrg
->
´m
)) {

198 
	`mbuf_»wšd
(
dŸlbuf
);

199 ()
	`mbuf_wr™e_¡r
(
dŸlbuf
, 
ÿrg
->
´m
);

201 
”r
 = 
	`ua_cÚÃù
(
	`uag_cur
(), 
NULL
, NULL,

202 
ÿrg
->
´m
, 
NULL
, 
VIDMODE_ON
);

204 ià(
dŸlbuf
->
’d
 > 0) {

206 *
uri
;

208 
dŸlbuf
->
pos
 = 0;

209 
”r
 = 
	`mbuf_¡rdup
(
dŸlbuf
, &
uri
, dŸlbuf->
’d
);

210 ià(
”r
)

211  
”r
;

213 
”r
 = 
	`ua_cÚÃù
(
	`uag_cur
(), 
NULL
, NULL, 
uri
, NULL, 
VIDMODE_ON
);

215 
	`mem_d”ef
(
uri
);

218 ià(
”r
) {

219 
	`w¬nšg
("m’u: ua_cÚÃù faed: %m\n", 
”r
);

222  
”r
;

223 
	}
}

226 
	$İtiÚs_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

228 ()
¬g
;

230 ià(
”r
) {

231 
	`w¬nšg
("İtiÚ »¶yƒ¼Ü: %m\n", 
”r
);

235 ià(
msg
->
scode
 < 200)

238 ià(
msg
->
scode
 < 300) {

240 
	`mbuf_£t_pos
(
msg
->
mb
, 0);

241 
	`šfo
("----- OPTIONS of %r -----\n%b",

242 &(
msg
->
to
.
auri
), 
	`mbuf_buf
(msg->
mb
),

243 
	`mbuf_g‘_Ëá
(
msg
->
mb
));

247 
	`šfo
("%r: OPTIONS faed: %u %r\n", &(
msg
->
to
.
auri
),

248 
msg
->
scode
, &msg->
»asÚ
);

249 
	}
}

252 
	$İtiÚs_commªd
(
»_´štf
 *
pf
, *
¬g
)

254 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

255 
”r
 = 0;

257 ()
pf
;

259 ià(
	`¡r_is£t
(
ÿrg
->
´m
)) {

261 
	`mbuf_»wšd
(
dŸlbuf
);

262 ()
	`mbuf_wr™e_¡r
(
dŸlbuf
, 
ÿrg
->
´m
);

264 
”r
 = 
	`ua_İtiÚs_£nd
(
	`uag_cur
(), 
ÿrg
->
´m
,

265 
İtiÚs_»¥_hªdËr
, 
NULL
);

267 ià(
dŸlbuf
->
’d
 > 0) {

269 *
uri
;

271 
dŸlbuf
->
pos
 = 0;

272 
”r
 = 
	`mbuf_¡rdup
(
dŸlbuf
, &
uri
, dŸlbuf->
’d
);

273 ià(
”r
)

274  
”r
;

276 
”r
 = 
	`ua_İtiÚs_£nd
(
	`uag_cur
(), 
uri
,

277 
İtiÚs_»¥_hªdËr
, 
NULL
);

279 
	`mem_d”ef
(
uri
);

282 ià(
”r
) {

283 
	`w¬nšg
("m’u: ua_İtiÚ çed: %m\n", 
”r
);

286  
”r
;

287 
	}
}

290 
	$cmd_ªsw”
(
»_´štf
 *
pf
, *
unu£d
)

292 
ua
 *u¨ğ
	`uag_cur
();

293 
”r
;

294 ()
unu£d
;

296 
”r
 = 
	`»_h´štf
(
pf
, "%s: Answ”šg incomšg c®l\n", 
	`ua_aÜ
(
ua
));

299 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

301 
	`ua_hŞd_ªsw”
(
ua
, 
NULL
);

303  
”r
;

304 
	}
}

307 
	$cmd_hªgup
(
»_´štf
 *
pf
, *
unu£d
)

309 ()
pf
;

310 ()
unu£d
;

313 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

314 
	`®”t_¡İ
();

316 
	`ua_hªgup
(
	`uag_cur
(), 
NULL
, 0, NULL);

319 
	`m’u_£t_šÿÎ
(
	`have_aùive_ÿÎs
());

322 
	}
}

325 
	$ü—‹_ua
(
»_´štf
 *
pf
, *
¬g
)

327 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

328 
Ë
 *le;

329 
”r
 = 0;

331 ()
pf
;

333 ià(
	`¡r_is£t
(
ÿrg
->
´m
)) {

335 
	`mbuf_»wšd
(
dŸlbuf
);

336 ()
	`mbuf_wr™e_¡r
(
dŸlbuf
, 
ÿrg
->
´m
);

338 ()
	`»_h´štf
(
pf
, "C»©šg UA fÜ % ...\n", 
ÿrg
->
´m
);

339 
”r
 = 
	`ua_®loc
(
NULL
, 
ÿrg
->
´m
);

343 ià(
dŸlbuf
->
’d
 > 0) {

345 *
uri
;

347 
dŸlbuf
->
pos
 = 0;

348 
”r
 = 
	`mbuf_¡rdup
(
dŸlbuf
, &
uri
, dŸlbuf->
’d
);

349 ià(
”r
)

350  
”r
;

352 ()
	`»_h´štf
(
pf
, "C»©šg UA fÜ % ...\n", 
uri
);

353 
”r
 |ğ
	`ua_®loc
(
NULL
, 
uri
);

355 
	`mem_d”ef
(
uri
);

358 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†&& !
”r
;†ğË->
Ãxt
) {

359 cÚ¡ 
ua
 *u¨ğ
Ë
->
d©a
;

361 
”r
 = 
	`»_h´štf
(
pf
, "% ", 
ua
 =ğ
	`uag_cur
() ? ">" : " ");

362 
”r
 |ğ
	`ua_´št_¡©us
(
pf
, 
ua
);

365 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

368 ià(
”r
) {

369 ()
	`»_h´štf
(
pf
, "m’u: c»©e_u¨çed: %m\n", 
”r
);

373  
”r
;

374 
	}
}

377 
	$cmd_ua_Ãxt
(
»_´štf
 *
pf
, *
unu£d
)

379 
”r
;

381 ()
pf
;

382 ()
unu£d
;

384 ià(!
Ë_cur
)

385 
Ë_cur
 = 
	`li¡_h—d
(
	`uag_li¡
());

386 ià(!
Ë_cur
)

389 
Ë_cur
 =†e_cur->
Ãxt
 ?†e_cur->Ãxˆ: 
	`li¡_h—d
(
	`uag_li¡
());

391 
”r
 = 
	`»_h´štf
(
pf
, "ua: %s\n", 
	`ua_aÜ
(
	`li¡_Ëd©a
(
Ë_cur
)));

393 
	`uag_cu¼’t_£t
(
	`li¡_Ëd©a
(
Ë_cur
));

395 
	`upd©e_ÿÎ¡©us
();

397  
”r
;

398 
	}
}

401 
	$´št_commªds
(
»_´štf
 *
pf
, *
unu£d
)

403 ()
unu£d
;

404  
	`cmd_´št
(
pf
, 
	`b¬es_commªds
());

405 
	}
}

408 
	$cmd_´št_ÿÎs
(
»_´štf
 *
pf
, *
unu£d
)

410 ()
unu£d
;

411  
	`ua_´št_ÿÎs
(
pf
, 
	`uag_cur
());

412 
	}
}

415 cÚ¡ 
	gabout_fmt
[] =

433 
	$about_box
(
»_´štf
 *
pf
, *
unu£d
)

435 ()
unu£d
;

437  
	`»_h´štf
(
pf
, 
about_fmt
, 
BARESIP_VERSION
);

438 
	}
}

441 cÚ¡ 
cmd
 
	gcmdv
[] = {

443 {"acû±", 'a', 0, "Acû± incomšg c®l", 
cmd_ªsw”
 },

444 {"hªgup", 'b', 0, "Hªgu°ÿÎ", 
cmd_hªgup
 },

445 {"ÿÎ¡©", 'c', 0, "C®È¡©us", 
ua_´št_ÿÎ_¡©us
 },

446 {"dŸl", 'd', 
CMD_PRM
, "DŸl", 
dŸl_hªdËr
 },

447 {"h–p", 'h', 0, "H–°m’u", 
´št_commªds
 },

448 {"li¡ÿÎs", 'l', 0, "Li¡‡ùivÿÎs", 
cmd_´št_ÿÎs
 },

449 {"İtiÚs", 'o', 
CMD_PRM
, "O±iÚs", 
İtiÚs_commªd
 },

450 {"»gšfo", 'r', 0, "Regi¡¿tiÚ info", 
ua_´št_»g_¡©us
 },

451 {
NULL
, 
KEYCODE_ESC
,0, "Hªgu°ÿÎ", 
cmd_hªgup
 },

452 {"uªext", 'T', 0, "ToggË UAs", 
cmd_ua_Ãxt
 },

453 {"uªew", 0, 
CMD_PRM
, "C»©U£r-Ag’t", 
ü—‹_ua
 },

454 {"au¤c", 0, 
CMD_IPRM
, "Sw™ch‡udiØsourû", 
sw™ch_audio_sourû
 },

455 {"au¶ay", 0, 
CMD_IPRM
, "Sw™ch‡udiØ¶ay”", 
sw™ch_audio_¶ay”
 },

456 {"about", 0, 0, "Abouˆbox", 
about_box
 },

460 cÚ¡ 
cmd
 
	gdŸlcmdv
[] = {

462 {
NULL
, '#', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

463 {
NULL
, '*', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

464 {
NULL
, '0', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

465 {
NULL
, '1', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

466 {
NULL
, '2', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

467 {
NULL
, '3', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

468 {
NULL
, '4', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

469 {
NULL
, '5', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

470 {
NULL
, '6', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

471 {
NULL
, '7', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

472 {
NULL
, '8', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

473 {
NULL
, '9', 
CMD_PRM
, NULL, 
dŸl_hªdËr
 },

477 
	$ÿÎ_audio_debug
(
»_´štf
 *
pf
, *
unu£d
)

479 ()
unu£d
;

480  
	`audio_debug
(
pf
, 
	`ÿÎ_audio
(
	`ua_ÿÎ
(
	`uag_cur
())));

481 
	}
}

484 
	$ÿÎ_audiÛnc_cyşe
(
»_´štf
 *
pf
, *
unu£d
)

486 ()
pf
;

487 ()
unu£d
;

488 
	`audio_’cod”_cyşe
(
	`ÿÎ_audio
(
	`ua_ÿÎ
(
	`uag_cur
())));

490 
	}
}

493 
	$ÿÎ_»šv™e
(
»_´štf
 *
pf
, *
unu£d
)

495 ()
pf
;

496 ()
unu£d
;

497  
	`ÿÎ_modify
(
	`ua_ÿÎ
(
	`uag_cur
()));

498 
	}
}

501 
	$ÿÎ_mu‹
(
»_´štf
 *
pf
, *
unu£d
)

503 
audio
 *audiØğ
	`ÿÎ_audio
(
	`ua_ÿÎ
(
	`uag_cur
()));

504 
boŞ
 
mu‹d
 = !
	`audio_ismu‹d
(
audio
);

505 ()
unu£d
;

507 ()
	`»_h´štf
(
pf
, "\nÿÎ %smu‹d\n", 
mu‹d
 ? "" : "un-");

508 
	`audio_mu‹
(
audio
, 
mu‹d
);

511 
	}
}

514 
	$ÿÎ_xãr
(
»_´štf
 *
pf
, *
¬g
)

516 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

517 
boŞ
 
xãr_š´og»ss
;

519 ià(!
xãr_š´og»ss
 && !
ÿrg
->
com¶‘e
) {

520 
¡©mode
 = 
STATMODE_OFF
;

521 
	`»_h´štf
(
pf
, "\rPleaseƒnterransferarget SIP uri:\n");

524 
xãr_š´og»ss
 = 
Œue
;

526 ià(
ÿrg
->
com¶‘e
) {

527 
¡©mode
 = 
STATMODE_CALL
;

528 
xãr_š´og»ss
 = 
çl£
;

529  
	`ÿÎ_Œªsãr
(
	`ua_ÿÎ
(
	`uag_cur
()), 
ÿrg
->
´m
);

533 
	}
}

536 
	$cmd_ÿÎ_hŞd
(
»_´štf
 *
pf
, *
¬g
)

538 ()
pf
;

539 ()
¬g
;

541  
	`ÿÎ_hŞd
(
	`ua_ÿÎ
(
	`uag_cur
()), 
Œue
);

542 
	}
}

545 
	$cmd_ÿÎ_»sume
(
»_´štf
 *
pf
, *
¬g
)

547 ()
pf
;

548 ()
¬g
;

550  
	`ÿÎ_hŞd
(
	`ua_ÿÎ
(
	`uag_cur
()), 
çl£
);

551 
	}
}

554 
	$hŞd_´ev_ÿÎ
(
»_´štf
 *
pf
, *
¬g
)

556 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

557 ()
pf
;

559  
	`ÿÎ_hŞd
(
	`ua_´ev_ÿÎ
(
	`uag_cur
()), 'H' =ğ
ÿrg
->
key
);

560 
	}
}

563 
	$sw™ch_audio_¶ay”
(
»_´štf
 *
pf
, *
¬g
)

565 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

566 
¶
 
¶_driv”
, 
¶_deviû
;

567 
cÚfig_audio
 *
aucfg
;

568 
cÚfig
 *
cfg
;

569 
audio
 *
a
;

570 
Ë
 *le;

571 
driv”
[16], 
deviû
[128] = "";

572 
”r
 = 0;

574 
boŞ
 
sw™ch_aud_š´og»ss
;

576 ià(!
sw™ch_aud_š´og»ss
 && !
ÿrg
->
com¶‘e
) {

577 
	`»_h´štf
(
pf
,

581 
sw™ch_aud_š´og»ss
 = 
Œue
;

583 ià(
ÿrg
->
com¶‘e
) {

585 
sw™ch_aud_š´og»ss
 = 
çl£
;

587 ià(
	`»_»gex
(
ÿrg
->
´m
, 
	`¡r_Ën
(carg->prm), "[^,]+,[~]*",

588 &
¶_driv”
, &
¶_deviû
)) {

590  
	`»_h´štf
(
pf
, "\rFormat should be:"

594 
	`¶_¡rıy
(&
¶_driv”
, 
driv”
, (driver));

595 
	`¶_¡rıy
(&
¶_deviû
, 
deviû
, (device));

597 ià(!
	`au¶ay_fšd
(
	`b¬es_au¶ayl
(), 
driv”
)) {

598 
	`»_h´štf
(
pf
, "nØsuch‡udio-¶ay”: %s\n", 
driv”
);

602 
	`»_h´štf
(
pf
, "switch‡udio…layer: %s,%s\n",

603 
driv”
, 
deviû
);

605 
cfg
 = 
	`cÚf_cÚfig
();

606 ià(!
cfg
) {

607  
	`»_h´štf
(
pf
, "no config object\n");

610 
aucfg
 = &
cfg
->
audio
;

612 
	`¡r_nıy
(
aucfg
->
¶ay_mod
, 
driv”
, (aucfg->play_mod));

613 
	`¡r_nıy
(
aucfg
->
¶ay_dev
, 
deviû
, (aucfg->play_dev));

615 
	`¡r_nıy
(
aucfg
->
®”t_mod
, 
driv”
, (aucfg->alert_mod));

616 
	`¡r_nıy
(
aucfg
->
®”t_dev
, 
deviû
, (aucfg->alert_dev));

618 
Ë
 = 
	`li¡_
(
	`ua_ÿÎs
(
	`uag_cur
()));†e;†ğË->
´ev
) {

620 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

622 
a
 = 
	`ÿÎ_audio
(
ÿÎ
);

624 
”r
 = 
	`audio_£t_¶ay”
(
a
, 
driv”
, 
deviû
);

625 ià(
”r
) {

626 
	`»_h´štf
(
pf
, "failedo set‡udio-player"

627 " (%m)\n", 
”r
);

634 
	}
}

637 
	$sw™ch_audio_sourû
(
»_´štf
 *
pf
, *
¬g
)

639 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

640 
¶
 
¶_driv”
, 
¶_deviû
;

641 
cÚfig_audio
 *
aucfg
;

642 
cÚfig
 *
cfg
;

643 
audio
 *
a
;

644 
Ë
 *le;

645 
driv”
[16], 
deviû
[128] = "";

646 
”r
 = 0;

648 
boŞ
 
sw™ch_aud_š´og»ss
;

650 ià(!
sw™ch_aud_š´og»ss
 && !
ÿrg
->
com¶‘e
) {

651 
	`»_h´štf
(
pf
,

655 
sw™ch_aud_š´og»ss
 = 
Œue
;

657 ià(
ÿrg
->
com¶‘e
) {

659 
sw™ch_aud_š´og»ss
 = 
çl£
;

661 ià(
	`»_»gex
(
ÿrg
->
´m
, 
	`¡r_Ën
(carg->prm), "[^,]+,[~]*",

662 &
¶_driv”
, &
¶_deviû
)) {

664  
	`»_h´štf
(
pf
, "\rFormat should be:"

668 
	`¶_¡rıy
(&
¶_driv”
, 
driv”
, (driver));

669 
	`¶_¡rıy
(&
¶_deviû
, 
deviû
, (device));

671 ià(!
	`au¤c_fšd
(
	`b¬es_au¤ş
(), 
driv”
)) {

672 
	`»_h´štf
(
pf
, "nØsuch‡udio-sourû: %s\n", 
driv”
);

676 
	`»_h´štf
(
pf
, "switch‡udio device: %s,%s\n",

677 
driv”
, 
deviû
);

679 
cfg
 = 
	`cÚf_cÚfig
();

680 ià(!
cfg
) {

681  
	`»_h´štf
(
pf
, "no config object\n");

684 
aucfg
 = &
cfg
->
audio
;

686 
	`¡r_nıy
(
aucfg
->
¤c_mod
, 
driv”
, (aucfg->src_mod));

687 
	`¡r_nıy
(
aucfg
->
¤c_dev
, 
deviû
, (aucfg->src_dev));

689 
Ë
 = 
	`li¡_
(
	`ua_ÿÎs
(
	`uag_cur
()));†e;†ğË->
´ev
) {

691 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

693 
a
 = 
	`ÿÎ_audio
(
ÿÎ
);

695 
”r
 = 
	`audio_£t_sourû
(
a
, 
driv”
, 
deviû
);

696 ià(
”r
) {

697 
	`»_h´štf
(
pf
, "failedo set‡udio-source"

698 " (%m)\n", 
”r
);

705 
	}
}

708 #ifdeà
USE_VIDEO


709 
	$ÿÎ_videÛnc_cyşe
(
»_´štf
 *
pf
, *
unu£d
)

711 ()
pf
;

712 ()
unu£d
;

713 
	`video_’cod”_cyşe
(
	`ÿÎ_video
(
	`ua_ÿÎ
(
	`uag_cur
())));

715 
	}
}

718 
	$ÿÎ_video_debug
(
»_´štf
 *
pf
, *
unu£d
)

720 ()
unu£d
;

721  
	`video_debug
(
pf
, 
	`ÿÎ_video
(
	`ua_ÿÎ
(
	`uag_cur
())));

722 
	}
}

726 
	$dig™_hªdËr
(
»_´štf
 *
pf
, *
¬g
)

728 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

729 
ÿÎ
 *call;

730 
”r
 = 0;

732 ()
pf
;

734 
ÿÎ
 = 
	`ua_ÿÎ
(
	`uag_cur
());

735 ià(
ÿÎ
)

736 
”r
 = 
	`ÿÎ_£nd_dig™
(
ÿÎ
, 
ÿrg
->
key
);

738  
”r
;

739 
	}
}

742 
	$toggË_¡©mode
(
»_´štf
 *
pf
, *
¬g
)

744 ()
pf
;

745 ()
¬g
;

747 ià(
¡©mode
 =ğ
STATMODE_OFF
)

748 
¡©mode
 = 
STATMODE_CALL
;

750 
¡©mode
 = 
STATMODE_OFF
;

753 
	}
}

756 
	$£t_cu¼’t_ÿÎ
(
»_´štf
 *
pf
, *
¬g
)

758 
cmd_¬g
 *
ÿrg
 = 
¬g
;

759 
ÿÎ
 *call;

760 
ušt32_t
 
lš’um
 = 
	`©oi
(
ÿrg
->
´m
);

761 
”r
;

763 
ÿÎ
 = 
	`ÿÎ_fšd_lš’um
(
	`ua_ÿÎs
(
	`uag_cur
()), 
lš’um
);

764 ià(
ÿÎ
) {

765 
”r
 = 
	`»_h´štf
(
pf
, "setting current call:†ine %u\n",

766 
lš’um
);

767 
	`ÿÎ_£t_cu¼’t
(
	`ua_ÿÎs
(
	`uag_cur
()), 
ÿÎ
);

770 
”r
 = 
	`»_h´štf
(
pf
, "call‚ot found\n");

773  
”r
;

774 
	}
}

777 cÚ¡ 
cmd
 
	gÿÎcmdv
[] = {

778 {"»šv™e", 'I', 0, "S’d„e-INVITE", 
ÿÎ_»šv™e
 },

779 {"»sume", 'X', 0, "C®È»sume", 
cmd_ÿÎ_»sume
 },

780 {"audio_debug",'A', 0, "AudiØ¡»am", 
ÿÎ_audio_debug
 },

781 {"audio_cyşe",'e', 0, "CyşaudiØ’cod”", 
ÿÎ_audiÛnc_cyşe
 },

782 {"mu‹", 'm', 0, "C®Èmu‹/un-mu‹", 
ÿÎ_mu‹
 },

783 {"Œªsãr", 't', 
CMD_IPRM
, "T¿nsã¸ÿÎ", 
ÿÎ_xãr
 },

784 {"hŞd", 'x', 0, "C®ÈhŞd", 
cmd_ÿÎ_hŞd
 },

785 {"", 'H', 0, "HŞd…»viou ÿÎ", 
hŞd_´ev_ÿÎ
 },

786 {"", 'L', 0, "Resum´eviou ÿÎ",
hŞd_´ev_ÿÎ
 },

788 #ifdeà
USE_VIDEO


789 {"video_cyşe", 'E', 0, "CyşvideØ’cod”", 
ÿÎ_videÛnc_cyşe
 },

790 {"video_debug", 'V', 0, "VideØ¡»am", 
ÿÎ_video_debug
 },

794 {
NULL
, '#', 0, NULL, 
dig™_hªdËr
 },

795 {
NULL
, '*', 0, NULL, 
dig™_hªdËr
 },

796 {
NULL
, '0', 0, NULL, 
dig™_hªdËr
 },

797 {
NULL
, '1', 0, NULL, 
dig™_hªdËr
 },

798 {
NULL
, '2', 0, NULL, 
dig™_hªdËr
 },

799 {
NULL
, '3', 0, NULL, 
dig™_hªdËr
 },

800 {
NULL
, '4', 0, NULL, 
dig™_hªdËr
 },

801 {
NULL
, '5', 0, NULL, 
dig™_hªdËr
 },

802 {
NULL
, '6', 0, NULL, 
dig™_hªdËr
 },

803 {
NULL
, '7', 0, NULL, 
dig™_hªdËr
 },

804 {
NULL
, '8', 0, NULL, 
dig™_hªdËr
 },

805 {
NULL
, '9', 0, NULL, 
dig™_hªdËr
 },

806 {
NULL
, 
KEYCODE_REL
, 0, NULL, 
dig™_hªdËr
 },

808 {
NULL
, 'S', 0, "StusmodtoggË", 
toggË_¡©mode
 },

809 {"lše",'@', 
CMD_PRM
, "S‘ cu¼’ˆÿÎ <lše>", 
£t_cu¼’t_ÿÎ
 },

813 
	$m’u_£t_šÿÎ
(
boŞ
 
šÿÎ
)

815 
commªds
 *commªd ğ
	`b¬es_commªds
();

816 
”r
 = 0;

819 ià(
šÿÎ
) {

820 
	`cmd_uÄegi¡”
(
commªds
, 
dŸlcmdv
);

822 ià(!
	`cmds_fšd
(
commªds
, 
ÿÎcmdv
)) {

823 
”r
 = 
	`cmd_»gi¡”
(
commªds
,

824 
ÿÎcmdv
, 
	`ARRAY_SIZE
(callcmdv));

828 
	`cmd_uÄegi¡”
(
commªds
, 
ÿÎcmdv
);

830 ià(!
	`cmds_fšd
(
commªds
, 
dŸlcmdv
)) {

831 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
dŸlcmdv
,

832 
	`ARRAY_SIZE
(
dŸlcmdv
));

835 ià(
”r
) {

836 
	`w¬nšg
("m’u: s‘_šÿÎ: cmd_»gi¡” faed (%m)\n", 
”r
);

839  
”r
;

840 
	}
}

843 
	$tmr¡©_hªdËr
(*
¬g
)

845 
ÿÎ
 *call;

846 ()
¬g
;

849 
ÿÎ
 = 
	`ua_ÿÎ
(
	`uag_cur
());

850 ià(!
ÿÎ
)

853 
	`tmr_¡¬t
(&
tmr_¡©
, 100, 
tmr¡©_hªdËr
, 0);

855 ià(
	`ui_i£d™šg
(
	`b¬es_uis
()))

858 ià(
STATMODE_OFF
 !ğ
¡©mode
) {

859 ()
	`»_årštf
(
¡d”r
, "%H\r", 
ÿÎ_¡©us
, 
ÿÎ
);

861 
	}
}

864 
	$upd©e_ÿÎ¡©us
()

867 ià(
	`have_aùive_ÿÎs
())

868 
	`tmr_¡¬t
(&
tmr_¡©
, 100, 
tmr¡©_hªdËr
, 0);

870 
	`tmr_ÿnûl
(&
tmr_¡©
);

871 
	}
}

874 
	$®”t_¡¬t
(*
¬g
)

876 ()
¬g
;

878 ià(!
m’u
.
b–l
)

881 
	`ui_ouut
(
	`b¬es_uis
(), "\033[10;1000]\033[11;1000]\a");

883 
	`tmr_¡¬t
(&
tmr_®”t
, 1000, 
®”t_¡¬t
, 
NULL
);

884 
	}
}

887 
	$®”t_¡İ
()

889 ià(!
m’u
.
b–l
)

892 ià(
	`tmr_i¤uÂšg
(&
tmr_®”t
))

893 
	`ui_ouut
(
	`b¬es_uis
(), "\r");

895 
	`tmr_ÿnûl
(&
tmr_®”t
);

896 
	}
}

899 
	$»dŸl_hªdËr
(*
¬g
)

901 *
uri
 = 
NULL
;

902 
”r
;

903 ()
¬g
;

905 
	`šfo
("now:„edialing‚ow. current_attempts=%u, max_attempts=%u\n",

906 
m’u
.
cu¼’t_©‹m±s
,

907 
m’u
.
»dŸl_©‹m±s
);

909 ià(
m’u
.
cu¼’t_©‹m±s
 > m’u.
»dŸl_©‹m±s
) {

911 
	`šfo
("menu:„edial:oo many‡ttemptes -- giving up\n");

915 ià(
dŸlbuf
->
’d
 == 0) {

916 
	`w¬nšg
("menu:„edial: dialbuf isƒmpty\n");

920 
dŸlbuf
->
pos
 = 0;

921 
”r
 = 
	`mbuf_¡rdup
(
dŸlbuf
, &
uri
, dŸlbuf->
’d
);

922 ià(
”r
)

925 
”r
 = 
	`ua_cÚÃù
(
	`uag_cur
(), 
NULL
, NULL, 
uri
, NULL, 
VIDMODE_ON
);

926 ià(
”r
) {

927 
	`w¬nšg
("m’u:„edŸl: ua_cÚÃù faed (%m)\n", 
”r
);

930 
	`mem_d”ef
(
uri
);

932 
	}
}

935 
	$ua_ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

936 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

938 
¶ay”
 *¶ay” = 
	`b¬es_¶ay”
();

940 ()
ÿÎ
;

941 ()
´m
;

942 ()
¬g
;

944 
ev
) {

946 
UA_EVENT_CALL_INCOMING
:

949 
	`uag_cu¼’t_£t
(
ua
);

951 
	`šfo
("%s: Incoming call from: %s %s -"

953 
	`ua_aÜ
(
ua
), 
	`ÿÎ_³”Çme
(
ÿÎ
), 
	`ÿÎ_³”uri
(call));

956 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

961 ià(
ANSWERMODE_MANUAL
 =ğ
	`accouÁ_ªsw”mode
(
	`ua_accouÁ
(
ua
))) {

963 ià(
	`li¡_couÁ
(
	`ua_ÿÎs
(
ua
)) > 1) {

964 ()
	`¶ay_fe
(&
m’u
.
¶ay
, 
¶ay”
,

969 ()
	`¶ay_fe
(&
m’u
.
¶ay
, 
¶ay”
,

973 ià(
m’u
.
b–l
)

974 
	`®”t_¡¬t
(0);

978 
UA_EVENT_CALL_RINGING
:

980 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

982 ià(
m’u
.
ršgback_di§bËd
) {

983 
	`šfo
("\nRingback disabled\n");

986 ()
	`¶ay_fe
(&
m’u
.
¶ay
, 
¶ay”
,

991 
UA_EVENT_CALL_ESTABLISHED
:

993 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

995 
	`®”t_¡İ
();

999 
	`»dŸl_»£t
();

1002 
UA_EVENT_CALL_CLOSED
:

1004 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

1006 ià(
	`ÿÎ_scode
(
ÿÎ
)) {

1007 cÚ¡ *
tÚe
;

1008 
tÚe
 = 
	`Œª¦©e_”rÜcode
(
	`ÿÎ_scode
(
ÿÎ
));

1009 ià(
tÚe
) {

1010 ()
	`¶ay_fe
(&
m’u
.
¶ay
, 
¶ay”
,

1011 
tÚe
, 1);

1015 
	`®”t_¡İ
();

1023 ià(
m’u
.
»dŸl_©‹m±s
) {

1025 ià(
m’u
.
cu¼’t_©‹m±s


1027 (
	`ÿÎ_is_outgošg
(
ÿÎ
) &&

1028 
	`ÿÎ_scode
(
ÿÎ
) == 701)) {

1030 
	`šfo
("menu: call closed"

1032 
m’u
.
»dŸl_d–ay
);

1034 ++
m’u
.
cu¼’t_©‹m±s
;

1036 
	`tmr_¡¬t
(&
m’u
.
tmr_»dŸl
,

1037 
m’u
.
»dŸl_d–ay
*1000,

1038 
»dŸl_hªdËr
, 
NULL
);

1041 
	`šfo
("menu: call closed --‚ot„edialing\n");

1047 
UA_EVENT_REGISTER_OK
:

1048 
	`check_»gi¡¿tiÚs
();

1051 
UA_EVENT_UNREGISTERING
:

1058 
	`m’u_£t_šÿÎ
(
	`have_aùive_ÿÎs
());

1059 
	`upd©e_ÿÎ¡©us
();

1060 
	}
}

1063 
	$mes§ge_hªdËr
(cÚ¡ 
¶
 *
³”
, cÚ¡ ¶ *
ùy³
,

1064 
mbuf
 *
body
, *
¬g
)

1066 ()
ùy³
;

1067 ()
¬g
;

1069 
	`ui_ouut
(
	`b¬es_uis
(), "\r%r: \"%b\"\n",

1070 
³”
, 
	`mbuf_buf
(
body
), 
	`mbuf_g‘_Ëá
(body));

1072 ()
	`¶ay_fe
(
NULL
, 
	`b¬es_¶ay”
(), "message.wav", 0);

1073 
	}
}

1076 
	$moduË_š™
()

1078 
¶
 
v®
;

1079 
”r
;

1084 
	`cÚf_g‘_boŞ
(
	`cÚf_cur
(), "m’u_b–l", &
m’u
.
b–l
);

1085 
	`cÚf_g‘_boŞ
(
	`cÚf_cur
(), "ringback_disabled",

1086 &
m’u
.
ršgback_di§bËd
);

1088 ià(0 =ğ
	`cÚf_g‘
(
	`cÚf_cur
(), "»dŸl_©‹m±s", &
v®
) &&

1089 0 =ğ
	`¶_¡rÿ£cmp
(&
v®
, "inf")) {

1090 
m’u
.
»dŸl_©‹m±s
 = (
ušt32_t
)-1;

1093 
	`cÚf_g‘_u32
(
	`cÚf_cur
(), "redial_attempts",

1094 &
m’u
.
»dŸl_©‹m±s
);

1096 
	`cÚf_g‘_u32
(
	`cÚf_cur
(), "»dŸl_d–ay", &
m’u
.
»dŸl_d–ay
);

1098 ià(
m’u
.
»dŸl_©‹m±s
) {

1099 
	`šfo
("menu:„edialƒnabled with %u‡ttempts‡nd"

1101 
m’u
.
»dŸl_©‹m±s
,

1102 
m’u
.
»dŸl_d–ay
);

1105 
dŸlbuf
 = 
	`mbuf_®loc
(64);

1106 ià(!
dŸlbuf
)

1107  
ENOMEM
;

1109 
¡¬t_ticks
 = 
	`tmr_jiff›s
();

1110 
	`tmr_š™
(&
tmr_®”t
);

1111 
¡©mode
 = 
STATMODE_CALL
;

1113 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

1114 
”r
 |ğ
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
dŸlcmdv
,

1115 
	`ARRAY_SIZE
(
dŸlcmdv
));

1116 ià(
”r
)

1117  
”r
;

1119 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, 
NULL
);

1120 ià(
”r
)

1121  
”r
;

1123 
”r
 = 
	`mes§ge_li¡’
(&
m’u
.
mes§ge
, 
	`b¬es_mes§ge
(),

1124 
mes§ge_hªdËr
, 
NULL
);

1125 ià(
”r
)

1126  
”r
;

1128  
”r
;

1129 
	}
}

1132 
	$moduË_şo£
()

1134 
	`debug
("menu: close (redial current_attempts=%d)\n",

1135 
m’u
.
cu¼’t_©‹m±s
);

1137 
m’u
.
mes§ge
 = 
	`mem_d”ef
(menu.message);

1138 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

1139 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

1140 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
dŸlcmdv
);

1141 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
ÿÎcmdv
);

1143 
	`tmr_ÿnûl
(&
tmr_®”t
);

1144 
	`tmr_ÿnûl
(&
tmr_¡©
);

1145 
dŸlbuf
 = 
	`mem_d”ef
(dialbuf);

1147 
Ë_cur
 = 
NULL
;

1149 
m’u
.
¶ay
 = 
	`mem_d”ef
(menu.play);

1151 
	`tmr_ÿnûl
(&
m’u
.
tmr_»dŸl
);

1154 
	}
}

1157 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
m’u
) = {

1160 
moduË_š™
,

1161 
moduË_şo£


	@baresip/modules/mpa/decode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<mpg123.h
>

10 
	~<¥“x/¥“x_»§m¶”.h
>

11 
	~<¡ršg.h
>

12 
	~"m·.h
"

14 
	saudec_¡©e
 {

15 
mpg123_hªdË
 *
	mdec
;

16 
S³exRe§m¶”S‹
 *
	m»§m¶”
;

17 
	mchªÃls
;

18 
št16_t
 
	mš‹rmedŸ‹_bufãr
[
MPA_FRAMESIZE
*2];

19 
	m¡¬t
;

23 
	$de¡ruùÜ
(*
¬g
)

25 
audec_¡©e
 *
ads
 = 
¬g
;

27 ià(
ads
->
»§m¶”
)

28 
	`¥“x_»§m¶”_de¡roy
(
ads
->
»§m¶”
);

30 
	`mpg123_şo£
(
ads
->
dec
);

31 
	`mpg123_d–‘e
(
ads
->
dec
);

32 #ifdeà
DEBUG


33 
	`debug
("MPA dec destroyed\n");

35 
	}
}

38 
	$m·_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

39 cÚ¡ *
fm
)

41 
audec_¡©e
 *
ads
;

42 
»suÉ
, 
”r
=0;

43 ()
fm
;

45 ià(!
ad¥
 || !
ac
 || !ac->
ch
)

46  
EINVAL
;

48 
ads
 = *
ad¥
;

50 #ifdeà
DEBUG


51 
	`debug
("MPA deøü—‹d %s\n",
fm
);

54 ià(!
ads
) {

55 
ads
 = 
	`mem_z®loc
((*ads), 
de¡ruùÜ
);

56 ià(!
ads
)

57  
ENOMEM
;

60 
	`mem£t
(
ads
,0,(*ads));

62 
ads
->
chªÃls
 = 0;

63 
ads
->
»§m¶”
 = 
NULL
;

64 
ads
->
¡¬t
 = 0;

66 
ads
->
dec
 = 
	`mpg123_Ãw
(
NULL
,&
»suÉ
);

67 ià(!
ads
->
dec
) {

68 
	`w¬nšg
("MPA dec create: %s\n",

69 
	`mpg123_¶aš_¡»¼Ü
(
»suÉ
));

70 
”r
 = 
ENOMEM
;

71 
out
;

74 #ifdeà
DEBUG


75 
»suÉ
 = 
	`mpg123_·¿m
(
ads
->
dec
, 
MPG123_VERBOSE
, 4, 4.);

77 
»suÉ
 = 
	`mpg123_·¿m
(
ads
->
dec
, 
MPG123_VERBOSE
, 0, 0.);

79 ià(
»suÉ
 !ğ
MPG123_OK
) {

80 
	`w¬nšg
("MPA dec…aramƒrror %s\n",

81 
	`mpg123_¶aš_¡»¼Ü
(
»suÉ
));

82 
”r
 = 
EINVAL
;

83 
out
;

87 
»suÉ
 = 
	`mpg123_fÜm©_®l
(
ads
->
dec
);

88 ià(
»suÉ
 !ğ
MPG123_OK
) {

89 
	`w¬nšg
("MPA dec formatƒrror %s\n",

90 
	`mpg123_¶aš_¡»¼Ü
(
»suÉ
));

91 
”r
 = 
EINVAL
;

92 
out
;

95 
»suÉ
 = 
	`mpg123_İ’_ãed
(
ads
->
dec
);

96 ià(
»suÉ
 !ğ
MPG123_OK
) {

97 
	`w¬nšg
("MPA dec open feedƒrror %s\n",

98 
	`mpg123_¶aš_¡»¼Ü
(
»suÉ
));

99 
”r
 = 
EINVAL
;

100 
out
;

103 
out
:

104 ià(
”r
)

105 
	`mem_d”ef
(
ads
);

107 *
ad¥
 = 
ads
;

109  
”r
;

110 
	}
}

113 
	$m·_decode_äm
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

114 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

116 
»suÉ
, 
chªÃls
, 
’codšg
, 
i
;

117 
§m¶”©e
;

118 
size_t
 
n
;

119 
¥x_ušt32_t
 
š‹rmedŸ‹_Ën
;

120 
¥x_ušt32_t
 
out_Ën
;

122 #ifdeà
DEBUG


123 
	`debug
("MPA deø¡¬ˆ%d %ld\n",
Ën
, *
§mpc
);

126 ià(!
ads
 || !
§mpv
 || !
§mpc
 || !
buf
 || 
Ën
<=4)

127  
EINVAL
;

129 ià(*(
ušt32_t
*)(*)
buf
 != 0) {

130 
	`w¬nšg
("MPA dec header is‚ot zero %08X,‚ot supported yet\n",

131 *(
ušt32_t
*)(*)
buf
);

132  
EPROTO
;

135 
n
 = 0;

136 
»suÉ
 = 
	`mpg123_decode
(
ads
->
dec
, 
buf
+4, 
Ën
-4,

137 (*)
ads
->
š‹rmedŸ‹_bufãr
,

138 (
ads
->
š‹rmedŸ‹_bufãr
), &
n
);

140 #ifdeà
DEBUG


141 
	`debug
("MPA deø%d %d %d %d\n",
»suÉ
, 
Ën
-4, 
n
, 
ads
->
chªÃls
);

144 ià(
»suÉ
 =ğ
MPG123_NEW_FORMAT
) {

145 
	`mpg123_g‘fÜm©
(
ads
->
dec
, &
§m¶”©e
, &
chªÃls
, &
’codšg
);

146 
	`šfo
("MPA deøfÜm© chªg%d %d %04X\n",
§m¶”©e


147 ,
chªÃls
,
’codšg
);

149 
ads
->
chªÃls
 = channels;

150 
ads
->
¡¬t
 = 0;

151 ià(
ads
->
»§m¶”
)

152 
	`¥“x_»§m¶”_de¡roy
(
ads
->
»§m¶”
);

153 ià(
§m¶”©e
 !ğ
MPA_IORATE
) {

154 
ads
->
»§m¶”
 = 
	`¥“x_»§m¶”_š™
(
chªÃls
,

155 (
ušt32_t
)
§m¶”©e
, 
MPA_IORATE
,

156 3, &
»suÉ
);

157 ià(
»suÉ
!=
RESAMPLER_ERR_SUCCESS


158 || 
ads
->
»§m¶”
==
NULL
) {

159 
	`w¬nšg
("MPA dec upsampler failed %d\n",

160 
»suÉ
);

161  
EINVAL
;

165 
ads
->
»§m¶”
 = 
NULL
;

167 ià(
»suÉ
 =ğ
MPG123_NEED_MORE
)

169 ià(
»suÉ
 !ğ
MPG123_OK
) {

170 
	`w¬nšg
("MPA deøãedƒ¼Ü %d %s\n", 
»suÉ
,

171 
	`mpg123_¶aš_¡»¼Ü
(
»suÉ
));

172  
EPROTO
;

175 ià(
ads
->
»§m¶”
) {

176 
š‹rmedŸ‹_Ën
 = (
ušt32_t
)(
n
 / 2 / 
ads
->
chªÃls
);

178 
out_Ën
 = (
ušt32_t
)(*
§mpc
 / 2);

180 
»suÉ
=
	`¥“x_»§m¶”_´oûss_š‹¾—ved_št
(

181 
ads
->
»§m¶”
,‡ds->
š‹rmedŸ‹_bufãr
,

182 &
š‹rmedŸ‹_Ën
, 
§mpv
, &
out_Ën
);

183 ià(
»suÉ
!=
RESAMPLER_ERR_SUCCESS
) {

184 
	`w¬nšg
("MPA dec upsampleƒrror: %s %d %d\n",

185 
	`¡»¼Ü
(
»suÉ
), 
out_Ën
, *
§mpc
/2);

186  
EPROTO
;

188 ià(
ads
->
chªÃls
==1) {

189 
i
=
out_Ën
-1;i>=0;i--)

190 
§mpv
[
i
+i+1]=sampv[i+i]=sampv[i];

191 *
§mpc
 = 
out_Ën
 * 2;

194 *
§mpc
 = 
out_Ën
 * 
ads
->
chªÃls
;

197 
n
 /= 2;

198 ià(
ads
->
chªÃls
!=1) {

199 
i
=0;()i<
n
;i++)

200 
§mpv
[
i
]=
ads
->
š‹rmedŸ‹_bufãr
[i];

201 *
§mpc
 = 
n
;

204 
i
=0;()i<
n
;i++)

205 
§mpv
[
i
*2]=sampv[i*2+1]=

206 
ads
->
š‹rmedŸ‹_bufãr
[
i
];

207 *
§mpc
 = 
n
 * 2;

210 #ifdeà
DEBUG


211 
	`debug
("MPA deødÚ%d\n",*
§mpc
);

216 
	}
}

	@baresip/modules/mpa/encode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<twŞame.h
>

10 
	~<¡ršg.h
>

11 
	~<¥“x/¥“x_»§m¶”.h
>

12 
	~"m·.h
"

15 
	sau’c_¡©e
 {

16 
twŞame_İtiÚs
 *
	m’c
;

17 
	mchªÃls
, 
	m§m¶”©e
;

18 
S³exRe§m¶”S‹
 *
	m»§m¶”
;

19 
št16_t
 
	mš‹rmedŸ‹_bufãr
[
MPA_FRAMESIZE
*6];

20 
ušt32_t
 
	mtime¡amp
;

24 
	$de¡ruùÜ
(*
¬g
)

26 
au’c_¡©e
 *
«s
 = 
¬g
;

28 ià(
«s
->
»§m¶”
) {

29 
	`¥“x_»§m¶”_de¡roy
(
«s
->
»§m¶”
);

30 
«s
->
»§m¶”
 = 
NULL
;

33 ià(
«s
->
’c
)

34 
	`twŞame_şo£
(&
«s
->
’c
);

35 #ifdeà
DEBUG


36 
	`debug
("MPAƒnc destroyed\n");

38 
	}
}

41 
	$m·_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

42 
au’c_·¿m
 *
·¿m
, cÚ¡ *
fm
)

44 
au’c_¡©e
 *
«s
;

45 
m·_·¿m
 
´m
;

46 
»suÉ
,
”r
=0;

48 ()
·¿m
;

50 ià(!
«¥
 || !
ac
 || !ac->
ch
)

51  
EINVAL
;

53 
«s
 = *
«¥
;

54 ià(!
«s
) {

55 
«s
 = 
	`mem_z®loc
((*«s), 
de¡ruùÜ
);

56 ià(!
«s
)

57  
ENOMEM
;

61 
	`mem£t
(
«s
,0,(*aes));

63 
«s
->
’c
 = 
	`twŞame_š™
();

64 ià(!
«s
->
’c
) {

65 
	`w¬nšg
("MPAƒnc create failed\n");

66 
	`mem_d”ef
(
«s
);

67  
ENOMEM
;

69 #ifdeà
DEBUG


70 
	`debug
("MPAƒnøü—‹d %s\n",
fm
);

72 
«s
->
chªÃls
 = 
ac
->
ch
;

73 
«s
->
time¡amp
 = 
	`¿nd_u32
();

75 
´m
.
§m¶”©e
 = 48000;

76 
´m
.
b™¿‹
 = 128000;

77 
´m
.
Ïy”
 = 2;

78 
´m
.
mode
 = 
SINGLE_CHANNEL
;

79 
	`m·_decode_fm
(&
´m
, 
fm
);

80 
«s
->
§m¶”©e
 = 
´m
.samplerate;

82 
»suÉ
 = 0;

83 #ifdeà
DEBUG


84 
»suÉ
 |ğ
	`twŞame_£t_v”bos™y
(
«s
->
’c
, 5);

86 
»suÉ
 |ğ
	`twŞame_£t_v”bos™y
(
«s
->
’c
, 0);

89 
»suÉ
 |ğ
	`twŞame_£t_mode
(
«s
->
’c
,

90 
´m
.
mode
 =ğ
SINGLE_CHANNEL
 ? 
TWOLAME_MONO
 :

91 
´m
.
mode
 =ğ
DUAL_CHANNEL
 ? 
TWOLAME_DUAL_CHANNEL
 :

92 
´m
.
mode
 =ğ
JOINT_STEREO
 ? 
TWOLAME_JOINT_STEREO
 :

93 
´m
.
mode
 =ğ
STEREO
 ? 
TWOLAME_STEREO
 : 
TWOLAME_AUTO_MODE
);

94 
»suÉ
 |ğ
	`twŞame_£t_v”siÚ
(
«s
->
’c
,

95 
´m
.
§m¶”©e
 < 32000 ? 
TWOLAME_MPEG2
 : 
TWOLAME_MPEG1
);

96 
»suÉ
 |ğ
	`twŞame_£t_b™¿‹
(
«s
->
’c
, 
´m
.
b™¿‹
/1000);

97 
»suÉ
 |ğ
	`twŞame_£t_š_§m¶”©e
(
«s
->
’c
, 
´m
.
§m¶”©e
);

98 
»suÉ
 |ğ
	`twŞame_£t_out_§m¶”©e
(
«s
->
’c
, 
´m
.
§m¶”©e
);

99 
»suÉ
 |ğ
	`twŞame_£t_num_chªÃls
(
«s
->
’c
, 2);

100 ià(
»suÉ
!=0) {

101 
	`w¬nšg
("MPAƒnc set failed\n");

102 
”r
=
EINVAL
;

103 
out
;

106 
»suÉ
 = 
	`twŞame_š™_·¿ms
(
«s
->
’c
);

107 ià(
»suÉ
!=0) {

108 
	`w¬nšg
("MPAƒnc init…arams failed\n");

109 
”r
=
EINVAL
;

110 
out
;

112 #ifdeà
DEBUG


113 
	`twŞame_´št_cÚfig
(
«s
->
’c
);

115 ià(
´m
.
§m¶”©e
 !ğ
MPA_IORATE
) {

116 
«s
->
»§m¶”
 = 
	`¥“x_»§m¶”_š™
(2, 
MPA_IORATE
,

117 
´m
.
§m¶”©e
, 3, &
»suÉ
);

118 ià(
»suÉ
!=
RESAMPLER_ERR_SUCCESS
) {

119 
	`w¬nšg
("MPAƒnø»§m¶” in™ faed %d\n",
»suÉ
);

120 
”r
=
EINVAL
;

121 
out
;

126 
«s
->
»§m¶”
 = 
NULL
;

128 
out
:

129 ià(
”r
)

130 
	`mem_d”ef
(
«s
);

132 *
«¥
 = 
«s
;

134  
”r
;

135 
	}
}

138 
	$m·_’code_äm
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

139 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

141 
n
;

142 
¥x_ušt32_t
 
š‹rmedŸ‹_Ën
,
š_Ën
;

144 ià(!
«s
 || !
buf
 || !
Ën
 || !
§mpv
)

145  
EINVAL
;

147 ià(
«s
->
»§m¶”
) {

148 
š_Ën
 = (
ušt32_t
)
§mpc
/2;

149 
š‹rmedŸ‹_Ën
 = (
«s
->
š‹rmedŸ‹_bufãr
)

150 / (
«s
->
š‹rmedŸ‹_bufãr
[0]);

151 
n
=
	`¥“x_»§m¶”_´oûss_š‹¾—ved_št
(
«s
->
»§m¶”
,

152 
§mpv
, &
š_Ën
, 
«s
->
š‹rmedŸ‹_bufãr
,

153 &
š‹rmedŸ‹_Ën
);

154 ià(
n
!=
RESAMPLER_ERR_SUCCESS
 || 
š_Ën
 !ğ
§mpc
/2) {

155 
	`w¬nšg
("MPAƒnc downsampleƒrror: %s %d %d\n",

156 
	`¡»¼Ü
(
n
), 
š_Ën
, 
§mpc
/2);

157  
EPROTO
;

159 
n
 = 
	`twŞame_’code_bufãr_š‹¾—ved
(
«s
->
’c
,

160 
«s
->
š‹rmedŸ‹_bufãr
, 
š‹rmedŸ‹_Ën
,

161 
buf
+4, ()(*
Ën
)-4);

162 #ifdeà
DEBUG


163 
	`debug
("MPAƒnø%d %d %d %d %d %p\n",
š‹rmedŸ‹_Ën
,
§mpc
,

164 
«s
->
chªÃls
,*
Ën
,
n
,«s->
’c
);

168 
n
 = 
	`twŞame_’code_bufãr_š‹¾—ved
(
«s
->
’c
,

169 
§mpv
, ()(
§mpc
/2),

170 
buf
+4, ()(*
Ën
)-4);

171 #ifdeà
DEBUG


172 
	`debug
("MPAƒnø%d %d %d %d\n",
§mpc
,

173 
«s
->
chªÃls
,*
Ën
,
n
);

176 ià(
n
 < 0) {

177 
	`w¬nšg
("MPAƒnø”rÜ %s\n", 
	`¡»¼Ü
(()
n
));

178  
EPROTO
;

181 ià(
n
 > 0) {

182 *(
ušt32_t
*)(*)
buf
 = 0;

183 *
Ën
 = 
n
+4;

186 *
Ën
 = 0;

188 #ifdeà
DEBUG


189 
	`debug
("MPAƒnødÚ%d %d %d %d %p\n",
§mpc
,
«s
->
chªÃls
,

190 *
Ën
,
n
,
«s
->
’c
);

192 
«s
->
time¡amp
 +ğ((
MPA_FRAMESIZE
*
MPA_RTPRATE
)<<4è/‡es->
§m¶”©e
;

194  0x00010000 | ((
«s
->
time¡amp
>>4) & 0x0000ffff);

195 
	}
}

	@baresip/modules/mpa/mpa.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<ùy³.h
>

10 
	~<¡ršg.h
>

11 
	~"m·.h
"

12 
	~<mpg123.h
>

81 
aucodec
 
	gm·
 = {

82 .
±
 = "14",

83 .
	gÇme
 = "MPA",

84 .
	g¤©e
 = 
MPA_IORATE
,

85 .
	gü©e
 = 
MPA_RTPRATE
,

86 .
	gch
 = 1,

88 .
	gfm
 = "layer=2",

89 .
	g’cupdh
 = 
m·_’code_upd©e
,

90 .
	g’ch
 = 
m·_’code_äm
,

91 .
	gdecupdh
 = 
m·_decode_upd©e
,

92 .
	gdech
 = 
m·_decode_äm
,

96 
	$moduË_š™
()

98 
cÚf
 *cÚàğ
	`cÚf_cur
();

99 
ušt32_t
 
v®ue
;

100 
fm
[256];

101 
mode
[30];

102 
»s
;

106 
	`¡rıy
(
mode
,
m·
.
fm
);

108 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "m·_b™¿‹", &
v®ue
)) {

109 ià(
v®ue
<8000 || value>384000) {

110 
	`w¬nšg
("MPA bitrate between 8000‡nd "

115 ()
	`»_¢´štf
(
fm
+
	`¡¾’
(fmtp),

116 (
fm
)-
	`¡¾’
(fmtp),

117 "; b™¿‹=%d", 
v®ue
);

119 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "m·_Ïy”", &
v®ue
)) {

120 ià(
v®ue
<1 || value>4) {

121 
	`w¬nšg
("MPA†ayer 1, 2 or 3‡re‡llowed.");

124 ()
	`»_¢´štf
(
fm
+
	`¡¾’
(fmtp),

125 (
fm
)-
	`¡¾’
(fmtp),

126 ";†ay”=%d", 
v®ue
);

128 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "m·_§m¶”©e", &
v®ue
)) {

129 
v®ue
) {

138 
	`w¬nšg
("MPA samplerates of 16, 22.05, 24, 32, "

142 ()
	`»_¢´štf
(
fm
+
	`¡¾’
(fmtp),

143 (
fm
)-
	`¡¾’
(fmtp),

144 "; sam¶”©e=%d", 
v®ue
);

146 ià(0 =ğ
	`cÚf_g‘_¡r
(
cÚf
, "m·_mode", 
mode
, (mode))) {

147 *
p
 = 
mode
;

148 *
p
) {

149 *
p
 = 
	`tŞow”
(*p);

150 ++
p
;

153 ià(
	`¡rcmp
(
mode
,"stereo")

154 && 
	`¡rcmp
(
mode
,"joint_stereo")

155 && 
	`¡rcmp
(
mode
,"single_channel")

156 && 
	`¡rcmp
(
mode
,"dual_channel")) {

157 
	`w¬nšg
("MPA mode: Permissible values‡re stereo, "

162 ()
	`»_¢´štf
(
fm
+
	`¡¾’
(fmtp),

163 (
fm
)-
	`¡¾’
(fmtp),

164 "; mode=%s", 
mode
);

167 ià(
fm
[0]==';' && fmtp[1]==' ')

168 
m·
.
fm
 = fmtp+2;

170 
m·
.
fm
 = fmtp;

173 
»s
 = 
	`mpg123_š™
();

174 ià(
»s
 !ğ
MPG123_OK
) {

175 
	`w¬nšg
("MPA†ibmpg123 initƒrror %s\n",

176 
	`mpg123_¶aš_¡»¼Ü
(
»s
));

180 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
m·
);

182 #ifdeà
DEBUG


183 
	`šfo
("MPA in™ w™h %s\n",
m·
.
fm
);

186 
	}
}

189 
	$moduË_şo£
()

191 
	`aucodec_uÄegi¡”
(&
m·
);

193 
	`mpg123_ex™
();

196 
	}
}

199 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
m·
) = {

202 
moduË_š™
,

203 
moduË_şo£
,

	@baresip/modules/mpa/mpa.h

7 
	#MPA_FRAMESIZE
 1152

	)

8 
	#MPA_IORATE
 48000

	)

9 
	#MPA_RTPRATE
 90000

	)

10 
	#BARESIP_FRAMESIZE
 (
MPA_IORATE
/50*2)

	)

12 #undeà
DEBUG


14 
	sm·_·¿m
 {

15 
	m§m¶”©e
;

16 
	mb™¿‹
;

17 
	mÏy”
;

18 ’um { 
	mAUTO
=0, 
	mSTEREO
, 
	mJOINT_STEREO
, 
	mSINGLE_CHANNEL
, 
	mDUAL_CHANNEL
 }

19 
	mmode
;

24 
m·_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

25 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
);

26 
m·_’code_äm
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

27 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
);

31 
m·_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

32 cÚ¡ *
fm
);

33 
m·_decode_äm
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

34 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
);

37 
m·_decode_fm
(
m·_·¿m
 *
´m
, cÚ¡ *
fm
);

	@baresip/modules/mpa/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<¡ršg.h
>

10 
	~"m·.h
"

13 
	$assign_if
 (
ušt32_t
 *
v
, cÚ¡ 
¶
 *pl,

14 
ušt32_t
 
mš
, ušt32_ˆ
max
)

16 cÚ¡ 
ušt32_t
 
v®
 = 
	`¶_u32
(
¶
);

18 ià(
v®
 < 
mš
 || v® > 
max
)

21 *
v
 = 
v®
;

22 
	}
}

25 
	$m·_decode_fm
(
m·_·¿m
 *
´m
, cÚ¡ *
fm
)

27 
¶
…l, 
v®
;

29 ià(!
´m
 || !
fm
)

32 
	`¶_£t_¡r
(&
¶
, 
fm
);

34 ià(
	`fmt_·¿m_g‘
(&
¶
, "b™¿‹", &
v®
))

35 
	`assign_if
 (&
´m
->
b™¿‹
, &
v®
, 8000, 384000);

37 ià(
	`fmt_·¿m_g‘
(&
¶
, "§m¶”©e", &
v®
))

38 
	`assign_if
 (&
´m
->
§m¶”©e
, &
v®
, 16000, 48000);

40 ià(
	`fmt_·¿m_g‘
(&
¶
, "Ïy”", &
v®
))

41 
	`assign_if
 (&
´m
->
Ïy”
, &
v®
, 1, 3);

43 ià(
	`fmt_·¿m_g‘
(&
¶
, "mode", &
v®
)) {

45 ià(!
	`¡ºcmp
("¡”eo",
v®
.
p
,v®.
l
))

46 
´m
->
mode
 = 
STEREO
;

47 ià(!
	`¡ºcmp
("jošt_¡”eo",
v®
.
p
,v®.
l
))

48 
´m
->
mode
 = 
JOINT_STEREO
;

49 ià(!
	`¡ºcmp
("sšgË_chªÃl",
v®
.
p
,v®.
l
))

50 
´m
->
mode
 = 
SINGLE_CHANNEL
;

51 ià(!
	`¡ºcmp
("du®_chªÃl",
v®
.
p
,v®.
l
))

52 
´m
->
mode
 = 
DUAL_CHANNEL
;

54 
	}
}

	@baresip/modules/mqtt/mqtt.c

7 
	~<mosqu™to.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"mq‰.h
"

13 
	gbrok”_ho¡
[256] = "127.0.0.1";

14 
ušt32_t
 
	gbrok”_pÜt
 = 1883;

16 
mq‰
 
	gs_mq‰
;

19 
	$fd_hªdËr
(
æags
, *
¬g
)

21 
mq‰
 *mq‰ = 
¬g
;

23 
	`mosqu™to_loİ_»ad
(
mq‰
->
mosq
, 1);

25 
	`mosqu™to_loİ_wr™e
(
mq‰
->
mosq
, 1);

26 
	}
}

30 
	$tmr_hªdËr
(*
d©a
)

32 
mq‰
 *mq‰ = 
d©a
;

33 
»t
;

35 
	`tmr_¡¬t
(&
mq‰
->
tmr
, 500, 
tmr_hªdËr
, mqtt);

37 
»t
 = 
	`mosqu™to_loİ_misc
(
mq‰
->
mosq
);

38 ià(
»t
 !ğ
MOSQ_ERR_SUCCESS
) {

39 
	`w¬nšg
("mq‰:ƒ¼Ü iÀloİ (%s)\n", 
	`mosqu™to_¡»¼Ü
(
»t
));

41 
	}
}

48 
	$cÚÃù_ÿÎback
(
mosqu™to
 *
mosq
, *
obj
, 
»suÉ
)

50 
mq‰
 *mq‰ = 
obj
;

51 
”r
;

52 ()
mq‰
;

54 ià(
»suÉ
 !ğ
MOSQ_ERR_SUCCESS
) {

55 
	`w¬nšg
("mqtt: could‚ot connecto broker (%s)\n",

56 
	`mosqu™to_¡»¼Ü
(
»suÉ
));

60 
	`šfo
("mqtt: connectedo broker‡t %s:%d\n",

61 
brok”_ho¡
, 
brok”_pÜt
);

63 
”r
 = 
	`mq‰_subsüibe_¡¬t
(
mq‰
);

64 ià(
”r
) {

65 
	`w¬nšg
("mq‰: subsüibe_š™ faed (%m)\n", 
”r
);

67 
	}
}

70 
	$moduË_š™
()

72 cÚ¡ 
k“·live
 = 60;

73 
»t
;

74 
”r
 = 0;

76 
	`tmr_š™
(&
s_mq‰
.
tmr
);

78 
	`mosqu™to_lib_š™
();

80 
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "mqtt_broker_host",

81 
brok”_ho¡
, (broker_host));

82 
	`cÚf_g‘_u32
(
	`cÚf_cur
(), "mq‰_brok”_pÜt", &
brok”_pÜt
);

84 
s_mq‰
.
mosq
 = 
	`mosqu™to_Ãw
("b¬es", 
Œue
, &s_mqtt);

85 ià(!
s_mq‰
.
mosq
) {

86 
	`w¬nšg
("mqtt: failedo create client instance\n");

87  
ENOMEM
;

90 
”r
 = 
	`mq‰_subsüibe_š™
(&
s_mq‰
);

91 ià(
”r
)

92  
”r
;

94 
	`mosqu™to_cÚÃù_ÿÎback_£t
(
s_mq‰
.
mosq
, 
cÚÃù_ÿÎback
);

96 
»t
 = 
	`mosqu™to_cÚÃù
(
s_mq‰
.
mosq
, 
brok”_ho¡
, 
brok”_pÜt
,

97 
k“·live
);

98 ià(
»t
 !ğ
MOSQ_ERR_SUCCESS
) {

100 
”r
 = 
»t
 =ğ
MOSQ_ERR_ERRNO
 ? 
”ºo
 : 
EIO
;

102 
	`w¬nšg
("mqtt: failedo connecto %s:%d (%s)\n",

103 
brok”_ho¡
, 
brok”_pÜt
,

104 
	`mosqu™to_¡»¼Ü
(
»t
));

105  
”r
;

108 
	`tmr_¡¬t
(&
s_mq‰
.
tmr
, 1, 
tmr_hªdËr
, &s_mqtt);

110 
”r
 = 
	`mq‰_publish_š™
(&
s_mq‰
);

111 ià(
”r
)

112  
”r
;

114 
s_mq‰
.
fd
 = 
	`mosqu™to_sock‘
(s_mq‰.
mosq
);

116 
”r
 = 
	`fd_li¡’
(
s_mq‰
.
fd
, 
FD_READ
, 
fd_hªdËr
, &s_mqtt);

117 ià(
”r
)

118  
”r
;

120 
	`šfo
("mqtt: module†oaded\n");

122  
”r
;

123 
	}
}

126 
	$moduË_şo£
()

128 
	`fd_şo£
(
s_mq‰
.
fd
);

130 
	`mq‰_publish_şo£
();

132 
	`mq‰_subsüibe_şo£
();

134 
	`tmr_ÿnûl
(&
s_mq‰
.
tmr
);

136 ià(
s_mq‰
.
mosq
) {

138 
	`mosqu™to_discÚÃù
(
s_mq‰
.
mosq
);

140 
	`mosqu™to_de¡roy
(
s_mq‰
.
mosq
);

141 
s_mq‰
.
mosq
 = 
NULL
;

144 
	`mosqu™to_lib_ş—nup
();

146 
	`šfo
("mqtt: module unloaded\n");

149 
	}
}

152 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
mq‰
) = {

155 
moduË_š™
,

156 
moduË_şo£


	@baresip/modules/mqtt/mqtt.h

3 
	smq‰
 {

4 
mosqu™to
 *
	mmosq
;

5 
tmr
 
	mtmr
;

6 
	mfd
;

14 
mq‰_subsüibe_š™
(
mq‰
 *mqtt);

15 
mq‰_subsüibe_¡¬t
(
mq‰
 *mqtt);

16 
mq‰_subsüibe_şo£
();

23 
mq‰_publish_š™
(
mq‰
 *mqtt);

24 
mq‰_publish_şo£
();

25 
mq‰_publish_mes§ge
(
mq‰
 *mq‰, cÚ¡ *
tİic
,

26 cÚ¡ *
fmt
, ...);

	@baresip/modules/mqtt/publish.c

7 
	~<mosqu™to.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"mq‰.h
"

24 
	$ua_ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

25 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

27 
mq‰
 *mq‰ = 
¬g
;

28 
odiù
 *
od
 = 
NULL
;

29 
”r
;

31 
”r
 = 
	`odiù_®loc
(&
od
, 8);

32 ià(
”r
)

35 
”r
 = 
	`ev’t_’code_diù
(
od
, 
ua
, 
ev
, 
ÿÎ
, 
´m
);

36 ià(
”r
)

37 
out
;

39 
”r
 = 
	`mq‰_publish_mes§ge
(
mq‰
, "/baresip/event", "%H",

40 
jsÚ_’code_odiù
, 
od
);

41 ià(
”r
) {

42 
	`w¬nšg
("mq‰: faedØpublish mes§g(%m)\n", 
”r
);

43 
out
;

46 
out
:

47 
	`mem_d”ef
(
od
);

48 
	}
}

51 
	$mq‰_publish_mes§ge
(
mq‰
 *mq‰, cÚ¡ *
tİic
,

52 cÚ¡ *
fmt
, ...)

54 *
mes§ge
;

55 
va_li¡
 
­
;

56 
»t
;

57 
”r
 = 0;

59 ià(!
mq‰
 || !
tİic
 || !
fmt
)

60  
EINVAL
;

62 
	`va_¡¬t
(
­
, 
fmt
);

63 
”r
 = 
	`»_vsd´štf
(&
mes§ge
, 
fmt
, 
­
);

64 
	`va_’d
(
­
);

66 ià(
”r
)

67  
”r
;

69 
»t
 = 
	`mosqu™to_publish
(
mq‰
->
mosq
,

70 
NULL
,

71 
tİic
,

72 ()
	`¡r_Ën
(
mes§ge
),

73 
mes§ge
,

75 
çl£
);

76 ià(
»t
 !ğ
MOSQ_ERR_SUCCESS
) {

77 
	`w¬nšg
("mqtt: failedo…ublish (%s)\n",

78 
	`mosqu™to_¡»¼Ü
(
»t
));

79 
”r
 = 
EINVAL
;

80 
out
;

83 
out
:

84 
	`mem_d”ef
(
mes§ge
);

85  
”r
;

86 
	}
}

89 
	$mq‰_publish_š™
(
mq‰
 *mqtt)

91 
”r
;

93 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, 
mq‰
);

94 ià(
”r
)

95  
”r
;

97  
”r
;

98 
	}
}

101 
	$mq‰_publish_şo£
()

103 
	`uag_ev’t_uÄegi¡”
(&
ua_ev’t_hªdËr
);

104 
	}
}

	@baresip/modules/mqtt/subscribe.c

7 
	~<mosqu™to.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"mq‰.h
"

13 cÚ¡ *
	gsubsütiÚ_·‰”n
 = "/baresip/+";

16 
	$´št_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

18 
mbuf
 *
mb
 = 
¬g
;

20  
	`mbuf_wr™e_mem
(
mb
, (*)
p
, 
size
);

21 
	}
}

24 
	$hªdË_commªd
(
mq‰
 *mq‰, cÚ¡ 
¶
 *
msg
)

26 
mbuf
 *
»¥
 = 
	`mbuf_®loc
(1024);

27 
»_´štf
 
pf
 = {
´št_hªdËr
, 
»¥
};

28 
odiù
 *
od
 = 
NULL
;

29 cÚ¡ 
odiù_’Œy
 *
Û_cmd
, *
Û_´m
, *
Û_tok
;

30 
buf
[256], 
»¥_tİic
[256];

31 
”r
;

35 
”r
 = 
	`jsÚ_decode_odiù
(&
od
, 32, 
msg
->
p
, msg->
l
, 16);

36 ià(
”r
) {

37 
	`w¬nšg
("mqtt: failedo decode JSON with %zu bytes (%m)\n",

38 
msg
->
l
, 
”r
);

42 
Û_cmd
 = 
	`odiù_lookup
(
od
, "command");

43 
Û_´m
 = 
	`odiù_lookup
(
od
, "params");

44 
Û_tok
 = 
	`odiù_lookup
(
od
, "token");

45 ià(!
Û_cmd
) {

46 
	`w¬nšg
("mqtt: missing jsonƒntries\n");

47 
out
;

50 
	`debug
("mqtt: handle_command: cmd='%s',oken='%s'\n",

51 
Û_cmd
 ? oe_cmd->
u
.
¡r
 : "",

52 
Û_tok
 ? oe_tok->
u
.
¡r
 : "");

54 
	`»_¢´štf
(
buf
, (buf), "%s%s%s",

55 
Û_cmd
->
u
.
¡r
,

56 
Û_´m
 ? " " : "",

57 
Û_´m
 ? oe_´m->
u
.
¡r
 : "");

60 
”r
 = 
	`cmd_´oûss_lÚg
(
	`b¬es_commªds
(),

61 
buf
,

62 
	`¡r_Ën
(
buf
),

63 &
pf
, 
NULL
);

64 ià(
”r
) {

65 
	`w¬nšg
("mq‰:ƒ¼Ü…roûssšg commªd (%m)\n", 
”r
);

71 
	`»_¢´štf
(
»¥_tİic
, (resp_topic),

73 
Û_tok
 ? oe_tok->
u
.
¡r
 : "nil");

75 
”r
 = 
	`mq‰_publish_mes§ge
(
mq‰
, 
»¥_tİic
,

77 
»¥
->
buf
,„e¥->
’d
);

78 ià(
”r
) {

79 
	`w¬nšg
("mq‰: faedØpublish mes§g(%m)\n", 
”r
);

80 
out
;

83 
out
:

84 
	`mem_d”ef
(
»¥
);

85 
	`mem_d”ef
(
od
);

86 
	}
}

92 
	$mes§ge_ÿÎback
(
mosqu™to
 *
mosq
, *
obj
,

93 cÚ¡ 
mosqu™to_mes§ge
 *
mes§ge
)

95 
mq‰
 *mq‰ = 
obj
;

96 
¶
 
msg
;

97 
boŞ
 
m©ch
 = 
çl£
;

99 
	`šfo
("mqtt: got message '%b' foropic '%s'\n",

100 (*è
mes§ge
->
·ylßd
, (
size_t
)mes§ge->
·ylßdËn
,

101 
mes§ge
->
tİic
);

103 
msg
.
p
 = 
mes§ge
->
·ylßd
;

104 
msg
.
l
 = 
mes§ge
->
·ylßdËn
;

106 
	`mosqu™to_tİic_m©ches_sub
("/b¬es/commªd", 
mes§ge
->
tİic
,

107 &
m©ch
);

108 ià(
m©ch
) {

109 
	`šfo
("mq‰: gÙ mes§gfÜ '%s'İic\n", 
mes§ge
->
tİic
);

111 
	`hªdË_commªd
(
mq‰
, &
msg
);

113 
	}
}

116 
	$mq‰_subsüibe_š™
(
mq‰
 *mqtt)

118 ià(!
mq‰
)

119  
EINVAL
;

121 
	`mosqu™to_mes§ge_ÿÎback_£t
(
mq‰
->
mosq
, 
mes§ge_ÿÎback
);

124 
	}
}

127 
	$mq‰_subsüibe_¡¬t
(
mq‰
 *mqtt)

129 
»t
;

131 
»t
 = 
	`mosqu™to_subsüibe
(
mq‰
->
mosq
, 
NULL
, 
subsütiÚ_·‰”n
, 0);

132 ià(
»t
 !ğ
MOSQ_ERR_SUCCESS
) {

133 
	`w¬nšg
("mqtt: failedo subscribe (%s)\n",

134 
	`mosqu™to_¡»¼Ü
(
»t
));

135  
EPROTO
;

138 
	`šfo
("mq‰: subsüibedØ·‰”À'%s'\n", 
subsütiÚ_·‰”n
);

141 
	}
}

144 
	$mq‰_subsüibe_şo£
()

146 
	}
}

	@baresip/modules/mwi/mwi.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

19 
	smwi
 {

20 
Ë
 
	mË
;

21 
ssub
 *
	msub
;

22 
ua
 *
	mua
;

23 
tmr
 
	mtmr
;

24 
boŞ
 
	mshutdown
;

27 
tmr
 
	gtmr
;

28 
li¡
 
	gmw
;

31 
	$de¡ruùÜ
(*
¬g
)

33 
mwi
 *mw˜ğ
¬g
;

35 
	`tmr_ÿnûl
(&
mwi
->
tmr
);

36 
	`li¡_uÆšk
(&
mwi
->
Ë
);

37 
	`mem_d”ef
(
mwi
->
sub
);

38 
	`mem_d”ef
(
mwi
->
ua
);

39 
	}
}

42 
	$d”ef_hªdËr
(*
¬g
)

44 
mwi
 *mw˜ğ
¬g
;

45 
	`mem_d”ef
(
mwi
);

46 
	}
}

49 
	$auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

50 cÚ¡ *
»®m
, *
¬g
)

52 
accouÁ
 *
acc
 = 
¬g
;

53  
	`accouÁ_auth
(
acc
, 
u£ºame
, 
·sswÜd
, 
»®m
);

54 
	}
}

57 
	$nÙify_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

58 *
¬g
)

60 
mwi
 *mw˜ğ
¬g
;

62 ià(
	`mbuf_g‘_Ëá
(
msg
->
mb
)) {

63 
ui_sub
 *
uis
 = 
	`b¬es_uis
();

64 
	`ui_ouut
(
uis
, "----- MWI fÜ % -----\n", 
	`ua_aÜ
(
mwi
->
ua
));

65 
	`ui_ouut
(
uis
, "%b\n", 
	`mbuf_buf
(
msg
->
mb
),

66 
	`mbuf_g‘_Ëá
(
msg
->
mb
));

69 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 200, "OK");

71 ià(
mwi
->
shutdown
)

72 
	`mem_d”ef
(
mwi
);

73 
	}
}

76 
	$şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

77 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
,

78 *
¬g
)

80 
mwi
 *mw˜ğ
¬g
;

81 ()
sub¡©e
;

83 
	`šfo
("mwi: subscription for %s closed: %s (%u %r)\n",

84 
	`ua_aÜ
(
mwi
->
ua
),

85 
”r
 ? 
	`¡»¼Ü
(err) : "",

86 
”r
 ? 0 : 
msg
->
scode
,

87 
”r
 ? 0 : &
msg
->
»asÚ
);

89 
	`mem_d”ef
(
mwi
);

90 
	}
}

93 
	$mwi_subsüibe
(
ua
 *ua)

95 cÚ¡ *
rou‹v
[1];

96 
mwi
 *mwi;

97 
”r
;

99 
mwi
 = 
	`mem_z®loc
((*mwi), 
de¡ruùÜ
);

100 ià(!
mwi
)

101  
ENOMEM
;

103 
	`li¡_­³nd
(&
mw
, &
mwi
->
Ë
, mwi);

104 
mwi
->
ua
 = 
	`mem_»f
(ua);

106 
rou‹v
[0] = 
	`ua_outbound
(
ua
);

108 
	`šfo
("mwi: subsüibšgØmes§ge fÜ %s\n", 
	`ua_aÜ
(
ua
));

110 
”r
 = 
	`sev’t_subsüibe
(&
mwi
->
sub
, 
	`uag_sev’t_sock
(), 
	`ua_aÜ
(
ua
),

111 
NULL
, 
	`ua_aÜ
(
ua
), "message-summary", NULL,

112 600, 
	`ua_cu£r
(
ua
),

113 
rou‹v
,„outev[0] ? 1 : 0,

114 
auth_hªdËr
, 
	`ua_accouÁ
(
ua
), 
Œue
, 
NULL
,

115 
nÙify_hªdËr
, 
şo£_hªdËr
, 
mwi
,

118 ià(
”r
) {

119 
	`w¬nšg
("mwi: subsüibERROR: %m\n", 
”r
);

122 ià(
”r
)

123 
	`mem_d”ef
(
mwi
);

125  
”r
;

126 
	}
}

129 
mwi
 *
	$mwi_fšd
(cÚ¡ 
ua
 *ua)

131 
Ë
 *le;

133 
Ë
 = 
mw
.
h—d
;†e;†ğË->
Ãxt
) {

135 
mwi
 *mw˜ğ
Ë
->
d©a
;

137 ià(
mwi
->
ua
 == ua)

138  
mwi
;

141  
NULL
;

142 
	}
}

145 
	$ua_ev’t_hªdËr
(
ua
 *ua,

146 
ua_ev’t
 
ev
,

147 
ÿÎ
 *call,

148 cÚ¡ *
´m
,

149 *
¬g
 )

151 ()
ÿÎ
;

152 ()
´m
;

153 ()
¬g
;

155 ià(
ev
 =ğ
UA_EVENT_REGISTER_OK
) {

157 ià(!
	`mwi_fšd
(
ua
))

158 
	`mwi_subsüibe
(
ua
);

160 ià(
ev
 =ğ
UA_EVENT_SHUTDOWN
) {

162 
Ë
 *le;

164 
	`šfo
("mwi: shutdown\n");

166 
Ë
 = 
	`li¡_h—d
(&
mw
);

167 
Ë
) {

168 
mwi
 *mw˜ğ
Ë
->
d©a
;

169 
Ë
 =†e->
Ãxt
;

171 
mwi
->
shutdown
 = 
Œue
;

173 ià(
mwi
->
sub
) {

174 
mwi
->
sub
 = 
	`mem_d”ef
(mwi->sub);

175 
	`tmr_¡¬t
(&
mwi
->
tmr
, 500, 
d”ef_hªdËr
, mwi);

178 
	`mem_d”ef
(
mwi
);

181 
	}
}

184 
	$tmr_hªdËr
(*
¬g
)

186 
Ë
 *le;

188 ()
¬g
;

190 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

191 
ua
 *u¨ğ
Ë
->
d©a
;

192 
accouÁ
 *
acc
 = 
	`ua_accouÁ
(
ua
);

194 ià(
	`accouÁ_»gšt
(
acc
) == 0) {

195 
	`mwi_subsüibe
(
ua
);

198 
	}
}

201 
	$moduË_š™
()

203 
	`li¡_š™
(&
mw
);

204 
	`tmr_¡¬t
(&
tmr
, 1, 
tmr_hªdËr
, 0);

206  
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, 
NULL
);

207 
	}
}

210 
	$moduË_şo£
()

212 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

213 
	`tmr_ÿnûl
(&
tmr
);

214 
	`li¡_æush
(&
mw
);

217 
	}
}

220 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
mwi
) = {

223 
moduË_š™
,

224 
moduË_şo£
,

	@baresip/modules/natbd/natbd.c

6 
	~<».h
>

7 
	~<b¬es.h
>

24 
	sÇtbd
 {

25 
Çt_haœpšnšg
 *
	mnh
;

26 
Çt_f‹ršg
 *
	mnf
;

27 
Çt_liãtime
 *
	mÆ
;

28 
Çt_m­pšg
 *
	mnm
;

29 
Çt_g’®g
 *
	mga
;

30 
¡un_dns
 *
	mdns
;

31 
§
 
	m¡un_¤v
;

32 
tmr
 
	mtmr
;

33 
	mho¡
[256];

34 
ušt16_t
 
	mpÜt
;

35 
ušt32_t
 
	mš‹rv®
;

36 
boŞ
 
	m‹rmš©ed
;

37 
	m´Ùo
;

38 
	m»s_hp
;

39 
Çt_ty³
 
	m»s_nm
;

40 
Çt_ty³
 
	m»s_nf
;

41 
Çt_liãtime_š‹rv®
 
	m»s_Æ
;

42 
ušt32_t
 
	mn_Æ
;

43 
	m¡©us_ga
;

46 
Çtbd
 *
	gÇtbdv
[2];

49 cÚ¡ *
	$haœpšnšg_¡r
(
»s_hp
)

51 
»s_hp
) {

57 
	}
}

60 cÚ¡ *
	$g’®g_¡r
(
¡©us
)

62 
¡©us
) {

69 
	}
}

72 
	$Çtbd_¡©us
(
»_´štf
 *
pf
, *
¬g
)

74 cÚ¡ 
Çtbd
 *Çtbd = 
¬g
;

75 
”r
;

77 ià(!
pf
 || !
Çtbd
)

80 
”r
 = 
	`»_h´štf
(
pf
, "NAT Binding Discovery (using %s:%J)\n",

81 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

82 &
Çtbd
->
¡un_¤v
);

83 
”r
 |ğ
	`»_h´štf
(
pf
, " Hairpinning: %s\n",

84 
	`haœpšnšg_¡r
(
Çtbd
->
»s_hp
));

85 
”r
 |ğ
	`»_h´štf
(
pf
, " Mapping: %s\n",

86 
	`Çt_ty³_¡r
(
Çtbd
->
»s_nm
));

87 ià(
Çtbd
->
´Ùo
 =ğ
IPPROTO_UDP
) {

88 
”r
 |ğ
	`»_h´štf
(
pf
, " Filtering: %s\n",

89 
	`Çt_ty³_¡r
(
Çtbd
->
»s_nf
));

90 
”r
 |ğ
	`»_h´štf
(
pf
, " Lifetime: min=%u cur=%u max=%u"

91 " (%u…robes)\n", 
Çtbd
->
»s_Æ
.
mš
,

92 
Çtbd
->
»s_Æ
.
cur
,‚©bd->»s_Æ.
max
,

93 
Çtbd
->
n_Æ
);

95 
”r
 |ğ
	`»_h´štf
(
pf
, " Generic ALG: %s\n",

96 
	`g’®g_¡r
(
Çtbd
->
¡©us_ga
));

98  
”r
;

99 
	}
}

102 
	$Çt_haœpšnšg_hªdËr
(
”r
, 
boŞ
 
suµÜ‹d
, *
¬g
)

104 
Çtbd
 *Çtbd = 
¬g
;

105 cÚ¡ 
»s_hp
 = (0 =ğ
”r
è? 
suµÜ‹d
 : -1;

107 ià(
Çtbd
->
‹rmš©ed
)

110 ià(
»s_hp
 !ğ
Çtbd
->res_hp) {

111 
	`šfo
("NAT Hairpinning %s changed from (%s)o (%s)\n",

112 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

113 
	`haœpšnšg_¡r
(
Çtbd
->
»s_hp
),

114 
	`haœpšnšg_¡r
(
»s_hp
));

117 
Çtbd
->
»s_hp
 =„es_hp;

119 
Çtbd
->
nh
 = 
	`mem_d”ef
(natbd->nh);

120 
	}
}

123 
	$Çt_m­pšg_hªdËr
(
”r
, 
Çt_ty³
 
ty³
, *
¬g
)

125 
Çtbd
 *Çtbd = 
¬g
;

127 ià(
Çtbd
->
‹rmš©ed
)

130 ià(
”r
) {

131 
	`w¬nšg
("Çtbd: NAT m­pšg faed (%m)\n", 
”r
);

132 
out
;

135 ià(
ty³
 !ğ
Çtbd
->
»s_nm
) {

136 
	`šfo
("NAT Mapping %s changed from (%s)o (%s)\n",

137 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

138 
	`Çt_ty³_¡r
(
Çtbd
->
»s_nm
),

139 
	`Çt_ty³_¡r
(
ty³
));

142 
Çtbd
->
»s_nm
 = 
ty³
;

144 
out
:

145 
Çtbd
->
nm
 = 
	`mem_d”ef
(natbd->nm);

146 
	}
}

149 
	$Çt_f‹ršg_hªdËr
(
”r
, 
Çt_ty³
 
ty³
, *
¬g
)

151 
Çtbd
 *Çtbd = 
¬g
;

153 ià(
Çtbd
->
‹rmš©ed
)

156 ià(
”r
) {

157 
	`w¬nšg
("Çtbd: NAT f‹ršg faed (%m)\n", 
”r
);

158 
out
;

161 ià(
ty³
 !ğ
Çtbd
->
»s_nf
) {

162 
	`šfo
("NAT Filtering %s changed from (%s)o (%s)\n",

163 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

164 
	`Çt_ty³_¡r
(
Çtbd
->
»s_nf
),

165 
	`Çt_ty³_¡r
(
ty³
));

168 
Çtbd
->
»s_nf
 = 
ty³
;

170 
out
:

171 
Çtbd
->
nf
 = 
	`mem_d”ef
(natbd->nf);

172 
	}
}

175 
	$Çt_liãtime_hªdËr
(
”r
,

176 cÚ¡ 
Çt_liãtime_š‹rv®
 *
š‹rv®
,

177 *
¬g
)

179 
Çtbd
 *Çtbd = 
¬g
;

181 ++
Çtbd
->
n_Æ
;

183 ià(
”r
) {

184 
	`w¬nšg
("Çtbd:‚©_liãtime_hªdËr: (%m)\n", 
”r
);

188 
Çtbd
->
»s_Æ
 = *
š‹rv®
;

190 
	`šfo
("NAT Binding†ifetime for %s: min=%u cur=%u max=%u\n",

191 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

192 
š‹rv®
->
mš
, iÁ”v®->
cur
, iÁ”v®->
max
);

193 
	}
}

196 
	$Çt_g’®g_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

197 
¡©us
, cÚ¡ 
§
 *
m­
,

198 *
¬g
)

200 
Çtbd
 *Çtbd = 
¬g
;

202 ()
m­
;

204 ià(
Çtbd
->
‹rmš©ed
)

207 ià(
”r
) {

208 
	`w¬nšg
("Çtbd: G’”iøALG d‘eùiÚ faed: %m\n", 
”r
);

209 
out
;

211 ià(
scode
) {

212 
	`w¬nšg
("natbd: Generic ALG detection failed: %u %s\n",

213 
scode
, 
»asÚ
);

214 
out
;

217 ià(
¡©us
 !ğ
Çtbd
->
¡©us_ga
) {

218 
	`šfo
("Generic ALG for %s changed from (%s)o (%s)\n",

219 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
),

220 
	`g’®g_¡r
(
Çtbd
->
¡©us_ga
),

221 
	`g’®g_¡r
(
¡©us
));

224 
Çtbd
->
¡©us_ga
 = 
¡©us
;

226 
out
:

227 
Çtbd
->
ga
 = 
	`mem_d”ef
(natbd->ga);

228 
	}
}

231 
	$de¡ruùÜ
(*
¬g
)

233 
Çtbd
 *Çtbd = 
¬g
;

235 
Çtbd
->
‹rmš©ed
 = 
Œue
;

237 
	`tmr_ÿnûl
(&
Çtbd
->
tmr
);

238 
	`mem_d”ef
(
Çtbd
->
dns
);

239 
	`mem_d”ef
(
Çtbd
->
nh
);

240 
	`mem_d”ef
(
Çtbd
->
nm
);

241 
	`mem_d”ef
(
Çtbd
->
nf
);

242 
	`mem_d”ef
(
Çtbd
->
Æ
);

243 
	`mem_d”ef
(
Çtbd
->
ga
);

244 
	}
}

247 
	$Çtbd_¡¬t
(
Çtbd
 *natbd)

249 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

250 
”r
 = 0;

252 ià(!
Çtbd
->
nh
) {

253 
”r
 |ğ
	`Çt_haœpšnšg_®loc
(&
Çtbd
->
nh
, &Çtbd->
¡un_¤v
,

254 
Çtbd
->
´Ùo
, 
NULL
,

255 
Çt_haœpšnšg_hªdËr
, 
Çtbd
);

256 
”r
 |ğ
	`Çt_haœpšnšg_¡¬t
(
Çtbd
->
nh
);

257 ià(
”r
) {

258 
	`w¬nšg
("natbd:‚at_hairpinning_start() failed (%m)\n",

259 
”r
);

263 ià(!
Çtbd
->
nm
) {

264 
”r
 |ğ
	`Çt_m­pšg_®loc
(&
Çtbd
->
nm
,

265 
	`Ãt_Ïddr_af
(
Ãt
, 
	`Ãt_af
(net)),

266 &
Çtbd
->
¡un_¤v
,‚©bd->
´Ùo
, 
NULL
,

267 
Çt_m­pšg_hªdËr
, 
Çtbd
);

268 
”r
 |ğ
	`Çt_m­pšg_¡¬t
(
Çtbd
->
nm
);

269 ià(
”r
) {

270 
	`w¬nšg
("natbd:‚at_mapping_start() failed (%m)\n",

271 
”r
);

275 ià(
Çtbd
->
´Ùo
 =ğ
IPPROTO_UDP
) {

277 ià(!
Çtbd
->
nf
) {

278 
”r
 |ğ
	`Çt_f‹ršg_®loc
(&
Çtbd
->
nf
,

279 &
Çtbd
->
¡un_¤v
, 
NULL
,

280 
Çt_f‹ršg_hªdËr
,

281 
Çtbd
);

282 
”r
 |ğ
	`Çt_f‹ršg_¡¬t
(
Çtbd
->
nf
);

283 ià(
”r
) {

284 
	`w¬nšg
("natbd:‚at_filtering_start() (%m)\n",

285 
”r
);

290 ià(!
Çtbd
->
ga
) {

291 
”r
 |ğ
	`Çt_g’®g_®loc
(&
Çtbd
->
ga
, &Çtbd->
¡un_¤v
,

292 
Çtbd
->
´Ùo
, 
NULL
,

293 
Çt_g’®g_hªdËr
, 
Çtbd
);

295 ià(
”r
) {

296 
	`w¬nšg
("Çtbd:‚©bd_š™: %m\n", 
”r
);

298 
”r
 |ğ
	`Çt_g’®g_¡¬t
(
Çtbd
->
ga
);

299 ià(
”r
) {

300 
	`w¬nšg
("natbd:‚at_genalg_start() failed (%m)\n",

301 
”r
);

305  
”r
;

306 
	}
}

309 
	$timeout
(*
¬g
)

311 
Çtbd
 *Çtbd = 
¬g
;

313 
	`šfo
("%H\n", 
Çtbd_¡©us
, 
Çtbd
);

315 
	`Çtbd_¡¬t
(
Çtbd
);

317 
	`tmr_¡¬t
(&
Çtbd
->
tmr
,‚©bd->
š‹rv®
 * 1000, 
timeout
,‚atbd);

318 
	}
}

321 
	$dns_hªdËr
(
”r
, cÚ¡ 
§
 *
addr
, *
¬g
)

323 
Çtbd
 *Çtbd = 
¬g
;

325 ià(
”r
) {

326 
	`w¬nšg
("natbd: failedo„esolve '%s' (%m)\n",

327 
Çtbd
->
ho¡
, 
”r
);

328 
out
;

331 
	`šfo
("natbd:„esolved STUN-server for %s -- %J\n",

332 
	`Ãt_´Ùo2Çme
(
Çtbd
->
´Ùo
), 
addr
);

334 
	`§_ıy
(&
Çtbd
->
¡un_¤v
, 
addr
);

336 
	`Çtbd_¡¬t
(
Çtbd
);

339 ià(
Çtbd
->
´Ùo
 =ğ
IPPROTO_UDP
) {

341 
”r
 = 
	`Çt_liãtime_®loc
(&
Çtbd
->
Æ
, &Çtbd->
¡un_¤v
, 3,

342 
NULL
, 
Çt_liãtime_hªdËr
, 
Çtbd
);

343 
”r
 |ğ
	`Çt_liãtime_¡¬t
(
Çtbd
->
Æ
);

344 ià(
”r
) {

345 
	`w¬nšg
("natbd:‚at_lifetime_start() failed (%m)\n",

346 
”r
);

350 
	`tmr_¡¬t
(&
Çtbd
->
tmr
,‚©bd->
š‹rv®
 * 1000, 
timeout
,‚atbd);

352 
out
:

353 
Çtbd
->
dns
 = 
	`mem_d”ef
(natbd->dns);

354 
	}
}

357 
	$timeout_š™
(*
¬g
)

359 
Çtbd
 *Çtbd = 
¬g
;

360 cÚ¡ *
´Ùo_¡r
;

361 
”r
 = 0;

363 ià(
	`§_is£t
(&
Çtbd
->
¡un_¤v
, 
SA_ALL
)) {

364 
	`dns_hªdËr
(0, &
Çtbd
->
¡un_¤v
,‚atbd);

368 ià(
Çtbd
->
´Ùo
 =ğ
IPPROTO_UDP
)

369 
´Ùo_¡r
 = 
¡un_´Ùo_udp
;

370 ià(
Çtbd
->
´Ùo
 =ğ
IPPROTO_TCP
)

371 
´Ùo_¡r
 = 
¡un_´Ùo_tı
;

373 
”r
 = 
EPROTONOSUPPORT
;

374 
out
;

377 
”r
 = 
	`¡un_£rv”_discov”
(&
Çtbd
->
dns
, 
	`Ãt_dnsc
(
	`b¬es_ÃtwÜk
()),

378 
¡un_u§ge_bšdšg
,

379 
´Ùo_¡r
, 
	`Ãt_af
(
	`b¬es_ÃtwÜk
()),

380 
Çtbd
->
ho¡
,‚©bd->
pÜt
,

381 
dns_hªdËr
, 
Çtbd
);

382 ià(
”r
)

383 
out
;

385 
out
:

386 ià(
”r
) {

387 
	`w¬nšg
("Çtbd:imeout_š™: %m\n", 
”r
);

389 
	}
}

392 
	$Çtbd_®loc
(
Çtbd
 **
Çtbdp
, 
ušt32_t
 
š‹rv®
,

393 
´Ùo
, cÚ¡ *
£rv”
)

395 
¶
 
ho¡
, 
pÜt
;

396 
Çtbd
 *natbd;

397 
”r
 = 0;

399 ià(!
Çtbdp
 || !
š‹rv®
 || !
´Ùo
 || !
£rv”
)

400  
EINVAL
;

402 
Çtbd
 = 
	`mem_z®loc
((*Çtbd), 
de¡ruùÜ
);

403 ià(!
Çtbd
)

404  
ENOMEM
;

406 
Çtbd
->
š‹rv®
 = interval;

407 
Çtbd
->
´Ùo
 =…roto;

408 
Çtbd
->
»s_hp
 = -1;

410 ià(0 =ğ
	`§_decode
(&
Çtbd
->
¡un_¤v
, 
£rv”
, 
	`¡r_Ën
(server))) {

413 ià(0 =ğ
	`»_»gex
(
£rv”
, 
	`¡r_Ën
(server), "[^:]+[:]*[^]*",

414 &
ho¡
, 
NULL
, &
pÜt
)) {

416 
	`¶_¡rıy
(&
ho¡
, 
Çtbd
->host, (natbd->host));

417 
Çtbd
->
pÜt
 = 
	`¶_u32
(&port);

420 
	`w¬nšg
("natbd: failedo decode‚atbd_server (%s)\n",

421 
£rv”
);

422 
”r
 = 
EINVAL
;

423 
out
;

426 
	`tmr_¡¬t
(&
Çtbd
->
tmr
, 1, 
timeout_š™
,‚atbd);

428 
out
:

429 ià(
”r
)

430 
	`mem_d”ef
(
Çtbd
);

432 *
Çtbdp
 = 
Çtbd
;

434  
”r
;

435 
	}
}

438 
	$¡©us
(
»_´štf
 *
pf
, *
unu£d
)

440 
size_t
 
i
;

441 
”r
 = 0;

443 ()
unu£d
;

445 
i
=0; i<
	`ARRAY_SIZE
(
Çtbdv
); i++) {

447 ià(
Çtbdv
[
i
])

448 
”r
 |ğ
	`Çtbd_¡©us
(
pf
, 
Çtbdv
[
i
]);

451  
”r
;

452 
	}
}

455 cÚ¡ 
cmd
 
	gcmdv
[] = {

456 {"Çtbd", 'z', 0, "NAT stus", 
¡©us
}

460 
	$moduË_š™
()

462 
£rv”
[256] = "";

463 
ušt32_t
 
š‹rv®
 = 3600;

464 
”r
;

466 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

467 ià(
”r
)

468  
”r
;

470 ()
	`cÚf_g‘_u32
(
	`cÚf_cur
(), "Çtbd_š‹rv®", &
š‹rv®
);

471 ()
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "Çtbd_£rv”", 
£rv”
, (server));

473 ià(!
£rv”
[0]) {

474 
	`w¬nšg
("natbd: missing config 'natbd_server'\n");

475  
EINVAL
;

478 
	`šfo
("natbd: Enable NAT Behavior Discovery using STUN server %s\n",

479 
£rv”
);

481 
”r
 |ğ
	`Çtbd_®loc
(&
Çtbdv
[0], 
š‹rv®
, 
IPPROTO_UDP
, 
£rv”
);

482 
”r
 |ğ
	`Çtbd_®loc
(&
Çtbdv
[1], 
š‹rv®
, 
IPPROTO_TCP
, 
£rv”
);

483 ià(
”r
) {

484 
	`w¬nšg
("Çtbd: faedØ®loÿ‹‚©bd s‹: %m\n", 
”r
);

487  
”r
;

488 
	}
}

491 
	$moduË_şo£
()

493 
size_t
 
i
;

495 
i
=0; i<
	`ARRAY_SIZE
(
Çtbdv
); i++)

496 
Çtbdv
[
i
] = 
	`mem_d”ef
(natbdv[i]);

498 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

501 
	}
}

504 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
Çtbd
) = {

507 
moduË_š™
,

508 
moduË_şo£
,

	@baresip/modules/natpmp/libnatpmp.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"libÇmp.h
"

13 
	mNATPMP_DELAY
 = 250,

14 
	mNATPMP_MAXTX
 = 9,

17 
	sÇmp_»q
 {

18 
Çmp_»q
 **
	mÅp
;

19 
udp_sock
 *
	mus
;

20 
tmr
 
	mtmr
;

21 
mbuf
 *
	mmb
;

22 
§
 
	m¤v
;

23 
	mn
;

24 
Çmp_»¥_h
 *
	m»¥h
;

25 *
	m¬g
;

29 
	$com¶‘ed
(
Çmp_»q
 *
Å
, 
”r
,

30 cÚ¡ 
Çmp_»¥
 *
»¥
)

32 
Çmp_»¥_h
 *
»¥h
 = 
Å
->resph;

33 *
¬g
 = 
Å
->arg;

35 
	`tmr_ÿnûl
(&
Å
->
tmr
);

37 ià(
Å
->
Åp
) {

38 *
Å
->
Åp
 = 
NULL
;

39 
Å
->
Åp
 = 
NULL
;

42 
Å
->
»¥h
 = 
NULL
;

45 
	`mem_d”ef
(
Å
);

47 ià(
»¥h
)

48 
	`»¥h
(
”r
, 
»¥
, 
¬g
);

49 
	}
}

52 
	$de¡ruùÜ
(*
¬g
)

54 
Çmp_»q
 *
Å
 = 
¬g
;

56 
	`tmr_ÿnûl
(&
Å
->
tmr
);

57 
	`mem_d”ef
(
Å
->
us
);

58 
	`mem_d”ef
(
Å
->
mb
);

59 
	}
}

62 
	$timeout
(*
¬g
)

64 
Çmp_»q
 *
Å
 = 
¬g
;

65 
”r
;

67 ià(
Å
->
n
 > 
NATPMP_MAXTX
) {

68 
	`com¶‘ed
(
Å
, 
ETIMEDOUT
, 
NULL
);

72 
	`tmr_¡¬t
(&
Å
->
tmr
, 
NATPMP_DELAY
<<Å->
n
, 
timeout
, 
¬g
);

75 
	`debug
("Çmp: {n=%u}x %u by‹s\n", 
Å
->
n
,‚p->
mb
->
’d
);

78 
Å
->
n
++;

80 
Å
->
mb
->
pos
 = 0;

81 
”r
 = 
	`udp_£nd
(
Å
->
us
, &Å->
¤v
,‚p->
mb
);

82 ià(
”r
) {

83 
	`com¶‘ed
(
Å
, 
”r
, 
NULL
);

85 
	}
}

88 
	$»¥_decode
(
Çmp_»¥
 *
»¥
, 
mbuf
 *
mb
)

90 
»¥
->
v”s
 = 
	`mbuf_»ad_u8
(
mb
);

91 
»¥
->
İ
 = 
	`mbuf_»ad_u8
(
mb
);

92 
»¥
->
»suÉ
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

93 
»¥
->
•och
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

95 ià(!(
»¥
->
İ
 & 0x80))

96  
EPROTO
;

97 
»¥
->
İ
 &= ~0x80;

99 
»¥
->
İ
) {

101 
NATPMP_OP_EXTERNAL
:

102 
»¥
->
u
.
ext_addr
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

105 
NATPMP_OP_MAPPING_UDP
:

106 
NATPMP_OP_MAPPING_TCP
:

107 
»¥
->
u
.
m­
.
št_pÜt
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

108 
»¥
->
u
.
m­
.
ext_pÜt
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

109 
»¥
->
u
.
m­
.
liãtime
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

113 
	`w¬nšg
("Çtm­: unknowÀİcod%d\n", 
»¥
->
İ
);

114  
EBADMSG
;

118 
	}
}

121 
	$udp_»cv
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

123 
Çmp_»q
 *
Å
 = 
¬g
;

124 
Çmp_»¥
 
»¥
;

126 ià(!
	`§_cmp
(
¤c
, &
Å
->
¤v
, 
SA_ALL
))

129 ià(
	`»¥_decode
(&
»¥
, 
mb
))

132 
	`com¶‘ed
(
Å
, 0, &
»¥
);

133 
	}
}

136 
	$Çmp_š™
(
Çmp_»q
 *
Å
, cÚ¡ 
§
 *
¤v
,

137 
ušt8_t
 
İcode
, 
Çmp_»¥_h
 *
»¥h
, *
¬g
)

139 
”r
;

141 ià(!
Å
 || !
¤v
)

142  
EINVAL
;

145 
”r
 = 
	`udp_li¡’
(&
Å
->
us
, 
NULL
, 
udp_»cv
,‚p);

146 ià(
”r
)

147  
”r
;

149 
Å
->
¤v
 = *srv;

150 
Å
->
»¥h
 =„esph;

151 
Å
->
¬g
 =‡rg;

153 
	`udp_cÚÃù
(
Å
->
us
, 
¤v
);

155 
Å
->
mb
 = 
	`mbuf_®loc
(512);

156 ià(!
Å
->
mb
)

157  
ENOMEM
;

159 
”r
 |ğ
	`mbuf_wr™e_u8
(
Å
->
mb
, 
NATPMP_VERSION
);

160 
”r
 |ğ
	`mbuf_wr™e_u8
(
Å
->
mb
, 
İcode
);

162  
”r
;

163 
	}
}

166 
	$Çmp_ex‹º®_»que¡
(
Çmp_»q
 **
Åp
, cÚ¡ 
§
 *
¤v
,

167 
Çmp_»¥_h
 *
»¥h
, *
¬g
)

169 
Çmp_»q
 *
Å
;

170 
”r
;

172 
Å
 = 
	`mem_z®loc
((*Å), 
de¡ruùÜ
);

173 ià(!
Å
)

174  
ENOMEM
;

176 
”r
 = 
	`Çmp_š™
(
Å
, 
¤v
, 
NATPMP_OP_EXTERNAL
, 
»¥h
, 
¬g
);

177 ià(
”r
)

178 
out
;

180 
	`timeout
(
Å
);

182 
out
:

183 ià(
”r
)

184 
	`mem_d”ef
(
Å
);

185 ià(
Åp
) {

186 
Å
->
Åp
 =‚pp;

187 *
Åp
 = 
Å
;

191 
	`mem_d”ef
(
Å
);

194  
”r
;

195 
	}
}

198 
	$Çmp_m­pšg_»que¡
(
Çmp_»q
 **
Åp
, cÚ¡ 
§
 *
¤v
,

199 
ušt16_t
 
št_pÜt
, ušt16_ˆ
ext_pÜt
,

200 
ušt32_t
 
liãtime
, 
Çmp_»¥_h
 *
»¥h
, *
¬g
)

202 
Çmp_»q
 *
Å
;

203 
”r
;

205 
Å
 = 
	`mem_z®loc
((*Å), 
de¡ruùÜ
);

206 ià(!
Å
)

207  
ENOMEM
;

209 
”r
 = 
	`Çmp_š™
(
Å
, 
¤v
, 
NATPMP_OP_MAPPING_UDP
, 
»¥h
, 
¬g
);

210 ià(
”r
)

211 
out
;

213 
”r
 |ğ
	`mbuf_wr™e_u16
(
Å
->
mb
, 0x0000);

214 
”r
 |ğ
	`mbuf_wr™e_u16
(
Å
->
mb
, 
	`htÚs
(
št_pÜt
));

215 
”r
 |ğ
	`mbuf_wr™e_u16
(
Å
->
mb
, 
	`htÚs
(
ext_pÜt
));

216 
”r
 |ğ
	`mbuf_wr™e_u32
(
Å
->
mb
, 
	`htÚl
(
liãtime
));

217 ià(
”r
)

218 
out
;

220 
	`timeout
(
Å
);

222 
out
:

223 ià(
”r
)

224 
	`mem_d”ef
(
Å
);

225 ià(
Åp
) {

226 
Å
->
Åp
 =‚pp;

227 *
Åp
 = 
Å
;

231 
	`mem_d”ef
(
Å
);

234  
”r
;

235 
	}
}

	@baresip/modules/natpmp/libnatpmp.h

9 
	mNATPMP_VERSION
 = 0,

10 
	mNATPMP_PORT
 = 5351,

13 
	eÇmp_İ
 {

14 
	mNATPMP_OP_EXTERNAL
 = 0,

15 
	mNATPMP_OP_MAPPING_UDP
 = 1,

16 
	mNATPMP_OP_MAPPING_TCP
 = 2,

19 
	eÇmp_»suÉ
 {

20 
	mNATPMP_SUCCESS
 = 0,

21 
	mNATPMP_UNSUP_VERSION
 = 1,

22 
	mNATPMP_REFUSED
 = 2,

23 
	mNATPMP_NETWORK_FAILURE
 = 3,

24 
	mNATPMP_OUT_OF_RESOURCES
 = 4,

25 
	mNATPMP_UNSUP_OPCODE
 = 5

28 
	sÇmp_»¥
 {

29 
ušt8_t
 
	mv”s
;

30 
ušt8_t
 
	mİ
;

31 
ušt16_t
 
	m»suÉ
;

32 
ušt32_t
 
	m•och
;

35 
ušt32_t
 
	mext_addr
;

37 
ušt16_t
 
	mšt_pÜt
;

38 
ušt16_t
 
	mext_pÜt
;

39 
ušt32_t
 
	mliãtime
;

40 } 
	mm­
;

41 } 
	mu
;

44 
	gÇmp_»q
;

46 (
	tÇmp_»¥_h
)(
	t”r
, cÚ¡ 
	tÇmp_»¥
 *
	t»¥
,

47 *
	t¬g
);

49 
	`Çmp_ex‹º®_»que¡
(
Çmp_»q
 **
Åp
, cÚ¡ 
§
 *
¤v
,

50 
Çmp_»¥_h
 *
h
, *
¬g
);

51 
	`Çmp_m­pšg_»que¡
(
Çmp_»q
 **
Çmµ
, cÚ¡ 
§
 *
¤v
,

52 
ušt16_t
 
št_pÜt
, ušt16_ˆ
ext_pÜt
,

53 
ušt32_t
 
liãtime
, 
Çmp_»¥_h
 *
»¥h
, *
¬g
);

	@baresip/modules/natpmp/natpmp.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"libÇmp.h
"

20 
	mLIFETIME
 = 300

23 
	smÇt_£ss
 {

24 
li¡
 
	mmedŸl
;

25 
mÇt_e¡ab_h
 *
	me¡abh
;

26 *
	m¬g
;

29 
	smÇt_medŸ
 {

30 
	scomp
 {

31 
Çmp_»q
 *
	mÇmp
;

32 
mÇt_medŸ
 *
	mmedŸ
;

33 
tmr
 
	mtmr
;

34 
ušt16_t
 
	mšt_pÜt
;

35 
ušt32_t
 
	mliãtime
;

36 
	mid
;

37 
boŞ
 
	mg¿Áed
;

38 } 
	mcompv
[2];

39 
	mcompc
;

41 
Ë
 
	mË
;

42 
mÇt_£ss
 *
	m£ss
;

43 
sdp_medŸ
 *
	msdpm
;

47 
mÇt
 *
	gmÇt
;

48 
§
 
	gÇmp_¤v
, 
	gÇmp_exddr
;

49 
Çmp_»q
 *
	gÇmp_ext
;

52 
Çmp_»¥_hªdËr
(
”r
, cÚ¡ 
Çmp_»¥
 *
»¥
,

53 *
¬g
);

56 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

58 
mÇt_£ss
 *
£ss
 = 
¬g
;

60 
	`li¡_æush
(&
£ss
->
medŸl
);

61 
	}
}

64 
	$medŸ_de¡ruùÜ
(*
¬g
)

66 
mÇt_medŸ
 *
m
 = 
¬g
;

67 
i
;

69 
	`li¡_uÆšk
(&
m
->
Ë
);

71 
i
=0; i<
m
->
compc
; i++) {

72 
comp
 *com°ğ&
m
->
compv
[
i
];

75 ià(
comp
->
g¿Áed
) {

76 ()
	`Çmp_m­pšg_»que¡
(
NULL
, &
Çmp_¤v
,

77 
comp
->
št_pÜt
, 0, 0,

78 
NULL
, NULL);

81 
	`tmr_ÿnûl
(&
comp
->
tmr
);

82 
	`mem_d”ef
(
comp
->
Çmp
);

85 
	`mem_d”ef
(
m
->
sdpm
);

86 
	}
}

89 
	$com¶‘e
(
mÇt_£ss
 *
£ss
, 
”r
)

91 
mÇt_e¡ab_h
 *
e¡abh
 = 
£ss
->estabh;

93 ià(
£ss
->
e¡abh
) {

95 
£ss
->
e¡abh
 = 
NULL
;

97 
	`e¡abh
(
”r
, 0, "dÚe", 
£ss
->
¬g
);

99 
	}
}

102 
boŞ
 
	$®l_compÚ’ts_g¿Áed
(cÚ¡ 
mÇt_medŸ
 *
m
)

104 
i
;

106 ià(!
m
 || !m->
compc
)

107  
çl£
;

109 
i
=0; i<
m
->
compc
; i++) {

110 cÚ¡ 
comp
 *com°ğ&
m
->
compv
[
i
];

111 ià(!
comp
->
g¿Áed
)

112  
çl£
;

115  
Œue
;

116 
	}
}

118 
	$is_com¶‘e
(
mÇt_£ss
 *
£ss
)

120 
Ë
 *le;

122 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

124 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

126 ià(!
	`®l_compÚ’ts_g¿Áed
(
m
))

130 
	`com¶‘e
(
£ss
, 0);

131 
	}
}

134 
	$»äesh_timeout
(*
¬g
)

136 
comp
 *com°ğ
¬g
;

138 
comp
->
Çmp
 = 
	`mem_d”ef
(comp->natpmp);

139 ()
	`Çmp_m­pšg_»que¡
(&
comp
->
Çmp
, &
Çmp_¤v
,

140 
comp
->
št_pÜt
, 0, comp->
liãtime
,

141 
Çmp_»¥_hªdËr
, 
comp
);

142 
	}
}

145 
	$Çmp_»¥_hªdËr
(
”r
, cÚ¡ 
Çmp_»¥
 *
»¥
,

146 *
¬g
)

148 
comp
 *com°ğ
¬g
;

149 
mÇt_medŸ
 *
m
 = 
comp
->
medŸ
;

150 
§
 
m­_addr
;

152 ià(
”r
) {

153 
	`w¬nšg
("Çmp:„e¥Ú£ƒ¼Ü: %m\n", 
”r
);

154 
	`com¶‘e
(
m
->
£ss
, 
”r
);

158 ià(
»¥
->
İ
 !ğ
NATPMP_OP_MAPPING_UDP
)

160 ià(
»¥
->
»suÉ
 !ğ
NATPMP_SUCCESS
) {

161 
	`w¬nšg
("natpmp:„equest failed with„esult code: %d\n",

162 
»¥
->
»suÉ
);

163 
	`com¶‘e
(
m
->
£ss
, 
EPROTO
);

167 ià(
»¥
->
u
.
m­
.
št_pÜt
 !ğ
comp
->int_port) {

168 
	`šfo
("natpmp: ignoring„esponse for internal_port=%u\n",

169 
»¥
->
u
.
m­
.
št_pÜt
);

173 
	`šfo
("natpmp: mapping granted for comp %u:"

175 
comp
->
id
,

176 
»¥
->
u
.
m­
.
št_pÜt
,„e¥->u.m­.
ext_pÜt
,

177 
»¥
->
u
.
m­
.
liãtime
);

179 
m­_addr
 = 
Çmp_exddr
;

180 
	`§_£t_pÜt
(&
m­_addr
, 
»¥
->
u
.
m­
.
ext_pÜt
);

181 
comp
->
liãtime
 = 
»¥
->
u
.
m­
.lifetime;

184 ià(
comp
->
id
 == 1)

185 
	`sdp_medŸ_£t_Ïddr
(
m
->
sdpm
, &
m­_addr
);

187 
	`sdp_medŸ_£t_Ïddr_¹ı
(
m
->
sdpm
, &
m­_addr
);

189 
comp
->
g¿Áed
 = 
Œue
;

191 
	`tmr_¡¬t
(&
comp
->
tmr
, comp->
liãtime
 * 1000 * 3/4,

192 
»äesh_timeout
, 
comp
);

194 
	`is_com¶‘e
(
m
->
£ss
);

195 
	}
}

198 
	$£ssiÚ_®loc
(
mÇt_£ss
 **
£s¥
, 
dnsc
 *dnsc,

199 
af
, cÚ¡ *
¤v
, 
ušt16_t
 
pÜt
,

200 cÚ¡ *
u£r
, cÚ¡ *
·ss
,

201 
sdp_£ssiÚ
 *
ss
, 
boŞ
 
ofã»r
,

202 
mÇt_e¡ab_h
 *
e¡abh
, *
¬g
)

204 
mÇt_£ss
 *
£ss
;

205 
”r
 = 0;

206 ()
af
;

207 ()
pÜt
;

208 ()
u£r
;

209 ()
·ss
;

210 ()
ss
;

211 ()
ofã»r
;

213 ià(!
£s¥
 || !
dnsc
 || !
¤v
 || !
ss
 || !
e¡abh
)

214  
EINVAL
;

216 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ssiÚ_de¡ruùÜ
);

217 ià(!
£ss
)

218  
ENOMEM
;

220 
£ss
->
e¡abh
 =ƒstabh;

221 
£ss
->
¬g
 =‡rg;

223 ià(
”r
)

224 
	`mem_d”ef
(
£ss
);

226 *
£s¥
 = 
£ss
;

228  
”r
;

229 
	}
}

232 
	$comp_®loc
(
comp
 *comp, *
sock
)

234 
§
 
Ïddr
;

235 
”r
;

237 
”r
 = 
	`udp_loÿl_g‘
(
sock
, &
Ïddr
);

238 ià(
”r
)

239 
out
;

241 
comp
->
št_pÜt
 = 
	`§_pÜt
(&
Ïddr
);

243 
	`šfo
("natpmp: `%s' stream comp %u†ocal UDP…ort is %u\n",

244 
	`sdp_medŸ_Çme
(
comp
->
medŸ
->
sdpm
), comp->
id
, comp->
št_pÜt
);

246 
”r
 = 
	`Çmp_m­pšg_»que¡
(&
comp
->
Çmp
, &
Çmp_¤v
,

247 
comp
->
št_pÜt
, 0, comp->
liãtime
,

248 
Çmp_»¥_hªdËr
, 
comp
);

249 ià(
”r
)

250 
out
;

252 
out
:

253  
”r
;

254 
	}
}

257 
	$medŸ_®loc
(
mÇt_medŸ
 **
mp
, 
mÇt_£ss
 *
£ss
,

258 
´Ùo
, *
sock1
, *
sock2
,

259 
sdp_medŸ
 *
sdpm
)

261 
mÇt_medŸ
 *
m
;

262 
i
;

263 
”r
 = 0;

264 ()
sock2
;

266 ià(!
mp
 || !
£ss
 || !
sdpm
 || 
´Ùo
 !ğ
IPPROTO_UDP
)

267  
EINVAL
;

268 ià(!
sock1
)

269  
EINVAL
;

271 
m
 = 
	`mem_z®loc
((*m), 
medŸ_de¡ruùÜ
);

272 ià(!
m
)

273  
ENOMEM
;

275 
m
->
compc
 = 
sock2
 ? 2 : 1;

277 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

278 
m
->
£ss
 = sess;

279 
m
->
sdpm
 = 
	`mem_»f
(sdpm);

281 
i
=0; i<
m
->
compc
; i++) {

283 
comp
 *com°ğ&
m
->
compv
[
i
];

285 
comp
->
id
 = 
i
+1;

286 
comp
->
medŸ
 = 
m
;

287 
comp
->
liãtime
 = 
LIFETIME
;

289 
”r
 = 
	`comp_®loc
(
comp
, 
i
==0 ? 
sock1
 : 
sock2
);

290 ià(
”r
)

291 
out
;

294 
out
:

295 ià(
”r
)

296 
	`mem_d”ef
(
m
);

298 *
mp
 = 
m
;

301  
”r
;

302 
	}
}

305 
	$exddr_hªdËr
(
”r
, cÚ¡ 
Çmp_»¥
 *
»¥
, *
¬g
)

307 ()
¬g
;

309 ià(
”r
) {

310 
	`w¬nšg
("Çmp:ƒx‹º®‡dd»s ERROR: %m\n", 
”r
);

314 ià(
»¥
->
»suÉ
 !ğ
NATPMP_SUCCESS
) {

315 
	`w¬nšg
("natpmp:ƒxternal‡ddress failed"

316 " w™h„esuÉ code: %d\n", 
»¥
->
»suÉ
);

320 ià(
»¥
->
İ
 !ğ
NATPMP_OP_EXTERNAL
)

323 
	`§_£t_š
(&
Çmp_exddr
, 
»¥
->
u
.
ext_addr
, 0);

325 
	`šfo
("Çmp: discov”ed Ex‹º®‡dd»ss: %j\n", &
Çmp_exddr
);

326 
	}
}

329 
boŞ
 
	$Ãt_¹_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *
d¡
,

330 
d¡Ën
, cÚ¡ 
§
 *
gw
, *
¬g
)

332 ()
d¡Ën
;

333 ()
¬g
;

335 ià(
	`§_af
(
d¡
è!ğ
AF_INET
)

336  
çl£
;

338 ià(
	`§_š
(
d¡
) == 0) {

339 
Çmp_¤v
 = *
gw
;

340 
	`§_£t_pÜt
(&
Çmp_¤v
, 
NATPMP_PORT
);

341 
	`šfo
("natpmp: found default gateway %j on interface '%s'\n",

342 
gw
, 
iâame
);

343  
Œue
;

346  
çl£
;

347 
	}
}

350 
	$moduË_š™
()

352 
”r
;

354 
	`§_š™
(&
Çmp_¤v
, 
AF_INET
);

355 
	`§_£t_pÜt
(&
Çmp_¤v
, 
NATPMP_PORT
);

357 
	`Ãt_¹_li¡
(
Ãt_¹_hªdËr
, 
NULL
);

359 
	`cÚf_g‘_§
(
	`cÚf_cur
(), "Çmp_£rv”", &
Çmp_¤v
);

361 
	`šfo
("Çmp: usšg NAT-PMP s”v”‡ˆ%J\n", &
Çmp_¤v
);

363 
”r
 = 
	`Çmp_ex‹º®_»que¡
(&
Çmp_ext
, &
Çmp_¤v
,

364 
exddr_hªdËr
, 
NULL
);

365 ià(
”r
)

366  
”r
;

368  
	`mÇt_»gi¡”
(&
mÇt
, 
	`b¬es_mÇ
(), "Çmp", 
NULL
,

369 
£ssiÚ_®loc
, 
medŸ_®loc
, 
NULL
);

370 
	}
}

373 
	$moduË_şo£
()

375 
mÇt
 = 
	`mem_d”ef
(mnat);

376 
Çmp_ext
 = 
	`mem_d”ef
(natpmp_ext);

379 
	}
}

382 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
Çmp
) = {

385 
moduË_š™
,

386 
moduË_şo£
,

	@baresip/modules/omx/module.c

9 
	~"omx.h
"

11 
	~<¡dlib.h
>

13 
	~<».h
>

14 
	~<»m.h
>

15 
	~<b¬es.h
>

17 
omx_vidi¥_®loc
(
vidi¥_¡
 **
vp
, cÚ¡ 
vidi¥
* 
vd
,

18 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
, 
vidi¥_»size_h
 *
»sizeh
,

19 *
¬g
);

20 
omx_vidi¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

21 cÚ¡ 
vidäame
 *
äame
);

23 
	svidi¥_¡
 {

24 cÚ¡ 
vidi¥
 *
	mvd
;

25 
vidsz
 
	msize
;

26 
omx_¡©e
* 
	momx
;

29 
vidi¥
* 
	gvid
;

31 
omx_¡©e
 
	gomx
;

34 
	$de¡ruùÜ
(*
¬g
)

36 
vidi¥_¡
 *
¡
 = 
¬g
;

37 
	`omx_di¥Ïy_di§bË
(
¡
->
omx
);

38 
	}
}

41 
	$omx_vidi¥_®loc
(
vidi¥_¡
 **
vp
, cÚ¡ 
vidi¥
* 
vd
,

42 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

43 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

45 
vidi¥_¡
 *
¡
;

48 (è
´m
;

49 (è
dev
;

50 (è
»sizeh
;

51 (è
¬g
;

53 
	`šfo
("omx: vidisp_alloc\n");

55 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

56 ià(!
¡
)

57  
ENOMEM
;

59 
¡
->
vd
 = vd;

60 *
vp
 = 
¡
;

62 
¡
->
omx
 = &omx;

65 
	}
}

68 
	$omx_vidi¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

69 cÚ¡ 
vidäame
 *
äame
)

71 
”r
 = 0;

72 * 
buf
;

73 
ušt32_t
 
Ën
;

75 
vidäame
 
omx_äame
;

77 ()
t™Ë
;

79 ià(
äame
->
fmt
 !ğ
VID_FMT_YUV420P
) {

80  
EINVAL
;

83 ià(!
	`vidsz_cmp
(&
¡
->
size
, &
äame
->size)) {

84 
	`šfo
("omx:‚ew frame size: w=%d h=%d\n",

85 
äame
->
size
.
w
, f¿me->size.
h
);

86 
	`šfo
("omx:†inesize[0]=%d\tlinesize[1]=%d\tlinesize[2]=%d\n",

87 
äame
->
lšesize
[0], frame->linesize[1],

88 
äame
->
lšesize
[2]);

89 
”r
 = 
	`omx_di¥Ïy_’abË
(
¡
->
omx
,

90 
äame
->
size
.
w
, f¿me->size.
h
, frame->size.w);

91 ià(
”r
) {

92 
	`w¬nšg
("omx_display_enable failed");

93  
”r
;

95 
¡
->
size
 = 
äame
->size;

99 
	`omx_di¥Ïy_šput_bufãr
(
¡
->
omx
, &
buf
, &
Ën
);

101 
	`vidäame_š™_buf
(&
omx_äame
, 
VID_FMT_YUV420P
, &
äame
->
size
,

102 
buf
);

104 
	`vidcÚv
(&
omx_äame
, 
äame
, 0);

106 
	`omx_di¥Ïy_æush_bufãr
(
¡
->
omx
);

108 
	}
}

111 
	$moduË_š™
()

113 ià(
	`omx_š™
(&
omx
) != 0) {

114 
	`w¬nšg
("Could‚ot initialize OpenMAX");

115  
ENODEV
;

118  
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(), "omx",

119 
omx_vidi¥_®loc
, 
NULL
, 
omx_vidi¥_di¥Ïy
, NULL);

120 
	}
}

123 
	$moduË_şo£
()

127 
vid
 = 
	`mem_d”ef
(vid);

129 
	}
}

132 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
omx
) = {

135 
moduË_š™
,

136 
moduË_şo£


	@baresip/modules/omx/omx.c

8 
	~"omx.h
"

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

19 
	~<time.h
>

20 
	~<sys/time.h
>

29 #ifdeà
RASPBERRY_PI


30 cÚ¡ 
	gVIDEO_RENDER_PORT
 = 90;

32 cÚ¡ 
	gVIDEO_RENDER_PORT
 = 0;

48 
OMX_ERRORTYPE
 
	$Ev’tHªdËr
(
OMX_HANDLETYPE
 
hCompÚ’t
, 
OMX_PTR
 
pAµD©a
,

49 
OMX_EVENTTYPE
 
eEv’t
, 
OMX_U32
 
nD©a1
, OMX_U32 
nD©a2
,

50 
OMX_PTR
 
pEv’tD©a
)

52 (è
hCompÚ’t
;

54 
eEv’t
) {

56 
OMX_Ev’tCmdCom¶‘e
:

57 
	`debug
("omx.EventHandler: Previous command completed\n"

59 
nD©a1
, 
nD©a2
, 
pEv’tD©a
, 
pAµD©a
);

64 
OMX_Ev’tE¼Ü
:

65 
	`w¬nšg
("omx.EventHandler: Errorƒventype "

66 "d©a1=%x\td©a2=%x\n", 
nD©a1
, 
nD©a2
);

70 
	`w¬nšg
("omx.EventHandler: Unknownƒventype %d\t"

71 "d©a1=%x d©a2=%x\n", 
eEv’t
, 
nD©a1
, 
nD©a2
);

77 
	}
}

80 
OMX_ERRORTYPE
 
	$Em±yBufãrDÚe
(
OMX_HANDLETYPE
 
hCompÚ’t
,

81 
OMX_PTR
 
pAµD©a
,

82 
OMX_BUFFERHEADERTYPE
* 
pBufãr
)

84 (è
hCompÚ’t
;

85 (è
pAµD©a
;

86 (è
pBufãr
;

91 
	}
}

94 
OMX_ERRORTYPE
 
	$FlBufãrDÚe
(
OMX_HANDLETYPE
 
hCompÚ’t
,

95 
OMX_PTR
 
pAµD©a
, 
OMX_BUFFERHEADERTYPE
* 
pBufãr
)

97 (è
hCompÚ’t
;

98 (è
pAµD©a
;

99 (è
pBufãr
;

100 
	`debug
("FillBufferDone\n");

102 
	}
}

105 
OMX_CALLBACKTYPE
 
	gÿÎbacks
 = {

106 
Ev’tHªdËr
,

107 
Em±yBufãrDÚe
,

108 &
FlBufãrDÚe


112 
	$omx_š™
(
omx_¡©e
* 
¡
)

114 
OMX_ERRORTYPE
 
”r
;

115 #ifdeà
RASPBERRY_PI


116 
	`bcm_ho¡_š™
();

119 
¡
->
bufãrs
 = 
NULL
;

121 
”r
 = 
	`OMX_In™
();

122 #ifdeà
RASPBERRY_PI


123 
”r
 |ğ
	`OMX_G‘HªdË
(&
¡
->
video_»nd”
,

124 "OMX.brßdcom.video_»nd”", 0, &
ÿÎbacks
);

126 
”r
 |ğ
	`OMX_G‘HªdË
(&
¡
->
video_»nd”
,

127 "OMX.¡.video.xvideosšk", 0, &
ÿÎbacks
);

130 ià(!
¡
->
video_»nd”
 || 
”r
 != 0) {

131 
	`w¬nšg
("Failedo create OMX video_render component\n");

132  
ENOENT
;

135 
	`šfo
("created video_render component\n");

138 
	}
}

142 
	$block_uÁ_¡©e_chªged
(
OMX_HANDLETYPE
 
hCompÚ’t
,

143 
OMX_STATETYPE
 
wª‹d_eS‹
)

145 
OMX_STATETYPE
 
eS‹
;

146 
i
 = 0;

147 
i
++ =ğ0 || 
eS‹
 !ğ
wª‹d_eS‹
) {

148 
	`OMX_G‘S‹
(
hCompÚ’t
, &
eS‹
);

149 ià(
eS‹
 !ğ
wª‹d_eS‹
) {

150 
	`sys_u¦“p
(10000);

153 
	}
}

156 
	$omx_deš™
(
omx_¡©e
* 
¡
)

158 
	`šfo
("omx_deinit");

159 
	`OMX_S’dCommªd
(
¡
->
video_»nd”
,

160 
OMX_CommªdS‹S‘
, 
OMX_S‹IdË
, 
NULL
);

161 
	`block_uÁ_¡©e_chªged
(
¡
->
video_»nd”
, 
OMX_S‹IdË
);

162 
	`OMX_S’dCommªd
(
¡
->
video_»nd”
,

163 
OMX_CommªdS‹S‘
, 
OMX_S‹Lßded
, 
NULL
);

164 
	`block_uÁ_¡©e_chªged
(
¡
->
video_»nd”
, 
OMX_S‹Lßded
);

165 
	`OMX_F»eHªdË
(
¡
->
video_»nd”
);

166 
	`OMX_Deš™
();

167 
	}
}

170 
	$omx_di¥Ïy_di§bË
(
omx_¡©e
* 
¡
)

172 ()
¡
;

174 #ifdeà
RASPBERRY_PI


175 
OMX_ERRORTYPE
 
”r
;

176 
OMX_CONFIG_DISPLAYREGIONTYPE
 
cÚfig
;

177 
	`mem£t
(&
cÚfig
, 0, (
OMX_CONFIG_DISPLAYREGIONTYPE
));

178 
cÚfig
.
nSize
 = (
OMX_CONFIG_DISPLAYREGIONTYPE
);

179 
cÚfig
.
nV”siÚ
.nV”siÚ = 
OMX_VERSION
;

180 
cÚfig
.
nPÜtIndex
 = 
VIDEO_RENDER_PORT
;

181 
cÚfig
.
fuÎsü“n
 = 0;

182 
cÚfig
.
£t
 = 
OMX_DISPLAY_SET_FULLSCREEN
;

184 
”r
 = 
	`OMX_S‘P¬am‘”
(
¡
->
video_»nd”
,

185 
OMX_IndexCÚfigDi¥ÏyRegiÚ
, &
cÚfig
);

187 ià(
”r
 != 0) {

188 
	`w¬nšg
("omx_display_disable command failed");

192 
	}
}

195 
	$block_uÁ_pÜt_chªged
(
OMX_HANDLETYPE
 
hCompÚ’t
,

196 
OMX_U32
 
nPÜtIndex
, 
OMX_BOOL
 
bEÇbËd
) {

198 
OMX_ERRORTYPE
 
r
;

199 
OMX_PARAM_PORTDEFINITIONTYPE
 
pÜtdef
;

200 
OMX_U32
 
i
 = 0;

202 
	`mem£t
(&
pÜtdef
, 0, (
OMX_PARAM_PORTDEFINITIONTYPE
));

203 
pÜtdef
.
nSize
 = (
OMX_PARAM_PORTDEFINITIONTYPE
);

204 
pÜtdef
.
nV”siÚ
.nV”siÚ = 
OMX_VERSION
;

205 
pÜtdef
.
nPÜtIndex
 =‚PortIndex;

207 
i
++ =ğ0 || 
pÜtdef
.
bEÇbËd
 != bEnabled) {

208 
r
 = 
	`OMX_G‘P¬am‘”
(
hCompÚ’t
,

209 
OMX_IndexP¬amPÜtDefš™iÚ
, &
pÜtdef
);

210 ià(
r
 !ğ
OMX_E¼ÜNÚe
) {

211 
	`w¬nšg
("block_until_port_changed: OMX_GetParameter "

212 " faed w™h ResuÉ=%d\n", 
r
);

214 ià(
pÜtdef
.
bEÇbËd
 != bEnabled) {

215 
	`sys_u¦“p
(10000);

218 
	}
}

221 
	$omx_di¥Ïy_’abË
(
omx_¡©e
* 
¡
,

222 
width
, 
height
, 
¡ride
)

224 
i
;

225 
OMX_PARAM_PORTDEFINITIONTYPE
 
pÜtdef
;

226 #ifdeà
RASPBERRY_PI


227 
OMX_CONFIG_DISPLAYREGIONTYPE
 
cÚfig
;

229 
OMX_ERRORTYPE
 
”r
 = 0;

231 
	`šfo
("omx_upd©e_siz%d %d\n", 
width
, 
height
);

233 #ifdeà
RASPBERRY_PI


234 
	`mem£t
(&
cÚfig
, 0, (
OMX_CONFIG_DISPLAYREGIONTYPE
));

235 
cÚfig
.
nSize
 = (
OMX_CONFIG_DISPLAYREGIONTYPE
);

236 
cÚfig
.
nV”siÚ
.nV”siÚ = 
OMX_VERSION
;

237 
cÚfig
.
nPÜtIndex
 = 
VIDEO_RENDER_PORT
;

238 
cÚfig
.
fuÎsü“n
 = 1;

239 
cÚfig
.
£t
 = 
OMX_DISPLAY_SET_FULLSCREEN
;

241 
”r
 |ğ
	`OMX_S‘P¬am‘”
(
¡
->
video_»nd”
,

242 
OMX_IndexCÚfigDi¥ÏyRegiÚ
, &
cÚfig
);

246 
	`mem£t
(&
pÜtdef
, 0, (
OMX_PARAM_PORTDEFINITIONTYPE
));

247 
pÜtdef
.
nSize
 = (
OMX_PARAM_PORTDEFINITIONTYPE
);

248 
pÜtdef
.
nV”siÚ
.nV”siÚ = 
OMX_VERSION
;

249 
pÜtdef
.
nPÜtIndex
 = 
VIDEO_RENDER_PORT
;

252 
”r
 |ğ
	`OMX_G‘P¬am‘”
(
¡
->
video_»nd”
,

253 
OMX_IndexP¬amPÜtDefš™iÚ
, &
pÜtdef
);

254 ià(
”r
 != 0) {

255 
	`w¬nšg
("omx_display_enable: couldn't„etrieve…ort def\n");

256 
”r
 = 
ENOMEM
;

257 
ex™
;

260 
	`šfo
("omx…ort definition: h=%d w=%d s=%d sh=%d\n",

261 
pÜtdef
.
fÜm©
.
video
.
nF¿meWidth
,

262 
pÜtdef
.
fÜm©
.
video
.
nF¿meHeight
,

263 
pÜtdef
.
fÜm©
.
video
.
nSŒide
,

264 
pÜtdef
.
fÜm©
.
video
.
nSliûHeight
);

266 
pÜtdef
.
fÜm©
.
video
.
nF¿meWidth
 = 
width
;

267 
pÜtdef
.
fÜm©
.
video
.
nF¿meHeight
 = 
height
;

268 
pÜtdef
.
fÜm©
.
video
.
nSŒide
 = 
¡ride
;

269 
pÜtdef
.
fÜm©
.
video
.
nSliûHeight
 = 
height
;

270 
pÜtdef
.
bEÇbËd
 = 1;

272 
”r
 |ğ
	`OMX_S‘P¬am‘”
(
¡
->
video_»nd”
,

273 
OMX_IndexP¬amPÜtDefš™iÚ
, &
pÜtdef
);

275 ià(
”r
) {

276 
	`w¬nšg
("omx_display_enable: could‚ot set…ort definition\n");

278 
	`block_uÁ_pÜt_chªged
(
¡
->
video_»nd”
, 
VIDEO_RENDER_PORT
, 
Œue
);

280 
”r
 |ğ
	`OMX_G‘P¬am‘”
(
¡
->
video_»nd”
,

281 
OMX_IndexP¬amPÜtDefš™iÚ
, &
pÜtdef
);

283 ià(
”r
 !ğ0 || !
pÜtdef
.
bEÇbËd
) {

284 
	`w¬nšg
("omx_display_enable: failedo set up video…ort\n");

285 
”r
 = 
ENOMEM
;

286 
ex™
;

293 
	`OMX_S’dCommªd
(
¡
->
video_»nd”
, 
OMX_CommªdS‹S‘
,

294 
OMX_S‹IdË
, 
NULL
);

295 
	`sys_u¦“p
(50000);

297 ià(!
¡
->
bufãrs
) {

298 
¡
->
bufãrs
 =

299 
	`m®loc
(
pÜtdef
.
nBufãrCouÁAùu®
 * (*));

300 
¡
->
num_bufãrs
 = 
pÜtdef
.
nBufãrCouÁAùu®
;

301 
¡
->
cu¼’t_bufãr
 = 0;

303 
i
 = 0; i < 
pÜtdef
.
nBufãrCouÁAùu®
; i++) {

304 
”r
 = 
	`OMX_AÎoÿ‹Bufãr
(
¡
->
video_»nd”
,

305 &
¡
->
bufãrs
[
i
], 
VIDEO_RENDER_PORT
,

306 
¡
, 
pÜtdef
.
nBufãrSize
);

307 ià(
”r
) {

308 
	`w¬nšg
("OMX_AllocateBuffer failed: %d\n",

309 
”r
);

310 
”r
 = 
ENOMEM
;

311 
ex™
;

316 
	`debug
("omx_update_size: sendoƒxecute state");

317 
	`OMX_S’dCommªd
(
¡
->
video_»nd”
, 
OMX_CommªdS‹S‘
,

318 
OMX_S‹Executšg
, 
NULL
);

319 
	`block_uÁ_¡©e_chªged
(
¡
->
video_»nd”
, 
OMX_S‹Executšg
);

321 
ex™
:

322  
”r
;

323 
	}
}

326 
	$omx_di¥Ïy_šput_bufãr
(
omx_¡©e
* 
¡
,

327 ** 
pbuf
, 
ušt32_t
* 
¶’
)

329 ià(!
¡
->
bufãrs
è 
EINVAL
;

331 *
pbuf
 = 
¡
->
bufãrs
[0]->
pBufãr
;

332 *
¶’
 = 
¡
->
bufãrs
[0]->
nAÎocL’
;

334 
¡
->
bufãrs
[0]->
nFËdL’
 = *
¶’
;

335 
¡
->
bufãrs
[0]->
nOff£t
 = 0;

338 
	}
}

341 
	$omx_di¥Ïy_æush_bufãr
(
omx_¡©e
* 
¡
)

343 ià(
	`OMX_Em±yThisBufãr
(
¡
->
video_»nd”
, st->
bufãrs
[0])

344 !ğ
OMX_E¼ÜNÚe
) {

345 
	`w¬nšg
("OMX_EmptyThisBufferƒrror");

349 
	}
}

	@baresip/modules/omx/omx.h

8 #ifdeà
RASPBERRY_PI


9 
	~<IL/OMX_CÜe.h
>

10 
	~<IL/OMX_Video.h
>

11 
	~<IL/OMX_Brßdcom.h
>

13 
	~<OMX_CÜe.h
>

14 
	~<OMX_CompÚ’t.h
>

15 
	~<OMX_Video.h
>

17 #undeà
OMX_VERSION


18 
	#OMX_VERSION
 0x01010101

	)

19 
	#OMX_ERROR_NONE
 0

	)

22 
	~<±h»ad.h
>

23 
	~<¡dšt.h
>

24 
	~<¡ršg.h
>

27 
	#_BSD_SOURCE


	)

28 
	~<uni¡d.h
>

30 
	somx_¡©e
 {

31 
OMX_HANDLETYPE
 
	mvideo_»nd”
;

32 
OMX_BUFFERHEADERTYPE
** 
	mbufãrs
;

33 
	mnum_bufãrs
;

34 
	mcu¼’t_bufãr
;

37 
omx_š™
(
omx_¡©e
* 
¡
);

38 
omx_deš™
(
omx_¡©e
* 
¡
);

40 
omx_di¥Ïy_šput_bufãr
(
omx_¡©e
* 
¡
,

41 ** 
pbuf
, 
ušt32_t
* 
¶’
);

42 
omx_di¥Ïy_æush_bufãr
(
omx_¡©e
* 
¡
);

44 
omx_di¥Ïy_’abË
(
omx_¡©e
* 
¡
,

45 
width
, 
height
, 
¡ride
);

46 
omx_di¥Ïy_di§bË
(
omx_¡©e
* 
¡
);

	@baresip/modules/opengles/opengles.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~<O³nGLES/ES1/gl.h
>

11 
	~<O³nGLES/ES1/gËxt.h
>

12 
	~"İ’gËs.h
"

22 
vidi¥
 *
	gvid
;

25 
	$‹xtu»_š™
(
vidi¥_¡
 *
¡
)

27 
	`glG’Textu»s
(1, &
¡
->
‹xtu»_id
);

28 ià(!
¡
->
‹xtu»_id
)

29  
ENOMEM
;

31 
	`glBšdTextu»
(
GL_TEXTURE_2D
, 
¡
->
‹xtu»_id
);

32 
	`glTexP¬am‘”f
(
GL_TEXTURE_2D
, 
GL_GENERATE_MIPMAP
, 
GL_FALSE
);

33 
	`glTexImage2D
(
GL_TEXTURE_2D
, 0, 
GL_RGB
,

34 
¡
->
vf
->
size
.
w
, st->vf->size.
h
, 0,

35 
GL_RGB
, 
GL_UNSIGNED_SHORT_5_6_5
, 
¡
->
vf
->
d©a
[0]);

36 
	`glTexP¬am‘”i
(
GL_TEXTURE_2D
, 
GL_TEXTURE_MIN_FILTER
, 
GL_LINEAR
);

37 
	`glTexP¬am‘”i
(
GL_TEXTURE_2D
, 
GL_TEXTURE_MAG_FILTER
, 
GL_LINEAR
);

38 
	`glTexP¬am‘”f
(
GL_TEXTURE_2D
, 
GL_TEXTURE_WRAP_S
, 
GL_CLAMP_TO_EDGE
);

39 
	`glTexP¬am‘”f
(
GL_TEXTURE_2D
, 
GL_TEXTURE_WRAP_T
, 
GL_CLAMP_TO_EDGE
);

40 
	`glBšdTextu»
(
GL_TEXTURE_2D
, 0);

43 
	}
}

46 
	$‹xtu»_»nd”
(
vidi¥_¡
 *
¡
)

48 cÚ¡ 
GLæßt
 
coÜds
[4 * 2] = {

55 
	`glBšdTextu»
(
GL_TEXTURE_2D
, 
¡
->
‹xtu»_id
);

57 
	`glTexImage2D
(
GL_TEXTURE_2D
, 0, 
GL_RGB
,

58 
¡
->
vf
->
size
.
w
, st->vf->size.
h
, 0,

59 
GL_RGB
, 
GL_UNSIGNED_SHORT_5_6_5
, 
¡
->
vf
->
d©a
[0]);

62 
	`glEÇbËCl›ÁS‹
(
GL_VERTEX_ARRAY
);

63 
	`glV”‹xPoš‹r
(3, 
GL_FLOAT
, 0, 
¡
->
v”tiûs
);

66 
	`glEÇbËCl›ÁS‹
(
GL_TEXTURE_COORD_ARRAY
);

67 
	`glTexCoÜdPoš‹r
(2, 
GL_FLOAT
, 0, 
coÜds
);

69 
	`glBšdTextu»
(
GL_TEXTURE_2D
, 
¡
->
‹xtu»_id
);

71 
	`glEÇbË
(
GL_TEXTURE_2D
);

72 
	`glTexP¬am‘”i
(
GL_TEXTURE_2D
, 
GL_TEXTURE_MIN_FILTER
, 
GL_LINEAR
);

73 
	`glTexP¬am‘”i
(
GL_TEXTURE_2D
, 
GL_TEXTURE_MAG_FILTER
, 
GL_LINEAR
);

74 
	`glTexP¬am‘”f
(
GL_TEXTURE_2D
, 
GL_TEXTURE_WRAP_S
, 
GL_CLAMP_TO_EDGE
);

75 
	`glTexP¬am‘”f
(
GL_TEXTURE_2D
, 
GL_TEXTURE_WRAP_T
, 
GL_CLAMP_TO_EDGE
);

76 
	`glD¿wA¼ays
(
GL_TRIANGLE_STRIP
, 0, 4);

77 
	`glDi§bË
(
GL_TEXTURE_2D
);

78 
	}
}

81 
	$£tup_Ïyout
(
vidi¥_¡
 *
¡
, cÚ¡ 
vidsz
 *
sü“nsz
,

82 
vid»ù
 *
Ütho
, vid»ù *
vp
)

84 
x
, 
y
, 
w
, 
h
, 
i
 = 0;

86 
w
 = 
¡
->
vf
->
size
.w;

87 
h
 = 
¡
->
vf
->
size
.h;

89 
¡
->
v”tiûs
[
i
++] = 0;

90 
¡
->
v”tiûs
[
i
++] = 0;

91 
¡
->
v”tiûs
[
i
++] = 0;

92 
¡
->
v”tiûs
[
i
++] = 
w
;

93 
¡
->
v”tiûs
[
i
++] = 0;

94 
¡
->
v”tiûs
[
i
++] = 0;

95 
¡
->
v”tiûs
[
i
++] = 0;

96 
¡
->
v”tiûs
[
i
++] = 
h
;

97 
¡
->
v”tiûs
[
i
++] = 0;

98 
¡
->
v”tiûs
[
i
++] = 
w
;

99 
¡
->
v”tiûs
[
i
++] = 
h
;

100 
¡
->
v”tiûs
[
i
++] = 0;

102 
x
 = (
sü“nsz
->
w
 - w) / 2;

103 
y
 = (
sü“nsz
->
h
 - h) / 2;

105 ià(
x
 < 0) {

106 
vp
->
x
 = 0;

107 
Ütho
->
x
 = -x;

110 
vp
->
x
 = x;

111 
Ütho
->
x
 = 0;

114 ià(
y
 < 0) {

115 
vp
->
y
 = 0;

116 
Ütho
->
y
 = -y;

119 
vp
->
y
 = y;

120 
Ütho
->
y
 = 0;

123 
vp
->
w
 = 
sü“nsz
->w - 2 * vp->
x
;

124 
vp
->
h
 = 
sü“nsz
->h - 2 * vp->
y
;

126 
Ütho
->
w
 = w - o¹ho->
x
;

127 
Ütho
->
h
 = h - o¹ho->
y
;

128 
	}
}

131 
	$İ’gËs_addbufãrs
(
vidi¥_¡
 *
¡
)

133 
	`glG’F¿mebufãrsOES
(1, &
¡
->
äamebufãr
);

134 
	`glG’R’d”bufãrsOES
(1, &
¡
->
»nd”bufãr
);

135 
	`glBšdF¿mebufãrOES
(
GL_FRAMEBUFFER_OES
, 
¡
->
äamebufãr
);

136 
	`glBšdR’d”bufãrOES
(
GL_RENDERBUFFER_OES
, 
¡
->
»nd”bufãr
);

137 
	}
}

140 
	$İ’gËs_»nd”
(
vidi¥_¡
 *
¡
)

142 ià(!
¡
->
‹xtu»_id
) {

144 
vid»ù
 
Ütho
, 
vp
;

145 
vidsz
 
bufsz
;

146 
”r
 = 0;

148 
	`glG‘R’d”bufãrP¬am‘”ivOES
(
GL_RENDERBUFFER_OES
,

149 
GL_RENDERBUFFER_WIDTH_OES
,

150 (
GLšt
 *)&
bufsz
.
w
);

151 
	`glG‘R’d”bufãrP¬am‘”ivOES
(
GL_RENDERBUFFER_OES
,

152 
GL_RENDERBUFFER_HEIGHT_OES
,

153 (
GLšt
 *)&
bufsz
.
h
);

155 
	`glBšdF¿mebufãrOES
(
GL_FRAMEBUFFER_OES
, 
¡
->
äamebufãr
);

156 
	`glF¿mebufãrR’d”bufãrOES
(
GL_FRAMEBUFFER_OES
,

157 
GL_COLOR_ATTACHMENT0_OES
,

158 
GL_RENDERBUFFER_OES
,

159 
¡
->
»nd”bufãr
);

161 
”r
 = 
	`‹xtu»_š™
(
¡
);

162 ià(
”r
)

165 
	`glBšdR’d”bufãrOES
(
GL_FRAMEBUFFER_OES
, 
¡
->
»nd”bufãr
);

167 
	`£tup_Ïyout
(
¡
, &
bufsz
, &
Ütho
, &
vp
);

172 
	`glBšdF¿mebufãrOES
(
GL_FRAMEBUFFER_OES
, 
¡
->
äamebufãr
);

174 
	`glV›wpÜt
(
vp
.
x
, vp.
y
, vp.
w
, vp.
h
);

176 
	`glCË¬CŞÜ
(0.0f, 0.0f, 0.0f, 1.0f);

177 
	`glCË¬
(
GL_COLOR_BUFFER_BIT
 | 
GL_DEPTH_BUFFER_BIT
);

179 
	`glM©rixMode
(
GL_PROJECTION
);

180 
	`glLßdId’t™y
();

182 
	`glO¹hof
(
Ütho
.
x
, o¹ho.
w
, o¹ho.
y
, o¹ho.
h
, 0.0f, 1.0f);

184 
	`glM©rixMode
(
GL_MODELVIEW
);

185 
	`glLßdId’t™y
();

186 
	`glDi§bË
(
GL_DEPTH_TEST
);

187 
	`glDi§bËCl›ÁS‹
(
GL_COLOR_ARRAY
);

190 
	`‹xtu»_»nd”
(
¡
);

192 
	`glDi§bË
(
GL_TEXTURE_2D
);

193 
	`glDi§bËCl›ÁS‹
(
GL_VERTEX_ARRAY
);

194 
	`glDi§bËCl›ÁS‹
(
GL_COLOR_ARRAY
);

195 
	`glDi§bËCl›ÁS‹
(
GL_TEXTURE_COORD_ARRAY
);

196 
	`glBšdTextu»
(
GL_TEXTURE_2D
, 0);

197 
	`glEÇbË
(
GL_DEPTH_TEST
);

199 
	`glBšdR’d”bufãrOES
(
GL_RENDERBUFFER_OES
, 
¡
->
»nd”bufãr
);

200 
	}
}

203 
	$de¡ruùÜ
(*
¬g
)

205 
vidi¥_¡
 *
¡
 = 
¬g
;

207 
	`glD–‘eTextu»s
(1, &
¡
->
‹xtu»_id
);

208 
	`glD–‘eF¿mebufãrsOES
(1, &
¡
->
äamebufãr
);

209 
	`glD–‘eR’d”bufãrsOES
(1, &
¡
->
»nd”bufãr
);

211 
	`cÚ‹xt_de¡roy
(
¡
);

213 
	`mem_d”ef
(
¡
->
vf
);

214 
	}
}

217 
	$İ’gËs_®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

218 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

219 
vidi¥_»size_h
 *
»sizeh
,

220 *
¬g
)

222 
vidi¥_¡
 *
¡
;

223 
”r
 = 0;

225 ()
´m
;

226 ()
dev
;

227 ()
»sizeh
;

228 ()
¬g
;

230 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

231 ià(!
¡
)

232  
ENOMEM
;

234 
¡
->
vd
 = vd;

236 
”r
 = 
	`cÚ‹xt_š™
(
¡
);

237 ià(
”r
)

238 
out
;

240 
out
:

241 ià(
”r
)

242 
	`mem_d”ef
(
¡
);

244 *
¡p
 = 
¡
;

246  
”r
;

247 
	}
}

250 
	$İ’gËs_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

251 cÚ¡ 
vidäame
 *
äame
)

253 
”r
;

255 ()
t™Ë
;

257 ià(!
¡
->
vf
) {

258 ià(
äame
->
size
.
w
 & 3) {

259 
	`w¬nšg
("opengles: width must be multiple of 4\n");

260  
EINVAL
;

263 
”r
 = 
	`vidäame_®loc
(&
¡
->
vf
, 
VID_FMT_RGB565
, &
äame
->
size
);

264 ià(
”r
)

265  
”r
;

268 
	`vidcÚv
(
¡
->
vf
, 
äame
, 
NULL
);

270 
	`cÚ‹xt_»nd”
(
¡
);

273 
	}
}

276 
	$moduË_š™
()

278  
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(),

279 "İ’gËs", 
İ’gËs_®loc
, 
NULL
,

280 
İ’gËs_di¥Ïy
, 
NULL
);

281 
	}
}

284 
	$moduË_şo£
()

286 
vid
 = 
	`mem_d”ef
(vid);

289 
	}
}

292 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
İ’gËs
) = {

295 
moduË_š™
,

296 
moduË_şo£
,

	@baresip/modules/opengles/opengles.h

8 
	svidi¥_¡
 {

9 cÚ¡ 
vidi¥
 *
	mvd
;

10 
vidäame
 *
	mvf
;

13 
GLušt
 
	mäamebufãr
;

14 
GLušt
 
	m»nd”bufãr
;

15 
GLušt
 
	m‹xtu»_id
;

16 
GLæßt
 
	mv”tiûs
[4 * 3];

18 *
	mv›w
;

22 
İ’gËs_addbufãrs
(
vidi¥_¡
 *
¡
);

23 
İ’gËs_»nd”
(
vidi¥_¡
 *
¡
);

26 
cÚ‹xt_š™
(
vidi¥_¡
 *
¡
);

27 
cÚ‹xt_de¡roy
(
vidi¥_¡
 *
¡
);

28 
cÚ‹xt_»nd”
(
vidi¥_¡
 *
¡
);

	@baresip/modules/opensles/opensles.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<SLES/O³nSLES.h
>

9 
	~"SLES/O³nSLES_Android.h
"

10 
	~"İ’¦es.h
"

20 
SLObjeùItf
 
	g’gšeObjeù
 = 
NULL
;

21 
SLEngšeItf
 
	g’gšeEngše
;

24 
au¶ay
 *
	gau¶ay
;

25 
au¤c
 *
	gau¤c
;

28 
	$moduË_š™
()

30 
SLEngšeO±iÚ
 
’gšeO±iÚ
[] = {

31 { (
SLušt32
è
SL_ENGINEOPTION_THREADSAFE
,

32 (
SLušt32
è
SL_BOOLEAN_TRUE
 },

34 
SL»suÉ
 
r
;

35 
”r
;

37 
r
 = 
	`¦C»©eEngše
(&
’gšeObjeù
, 1, 
’gšeO±iÚ
, 0, 
NULL
, NULL);

38 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

39  
ENODEV
;

41 
r
 = (*
’gšeObjeù
)->
	`R—lize
ÓngšeObjeù, 
SL_BOOLEAN_FALSE
);

42 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

43  
ENODEV
;

45 
r
 = (*
’gšeObjeù
)->
	`G‘IÁ”çû
ÓngšeObjeù, 
SL_IID_ENGINE
,

46 &
’gšeEngše
);

47 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

48  
ENODEV
;

50 
”r
 = 
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

51 "İ’¦es", 
İ’¦es_¶ay”_®loc
);

52 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

53 "İ’¦es", 
İ’¦es_»cÜd”_®loc
);

55  
”r
;

56 
	}
}

59 
	$moduË_şo£
()

61 
au¶ay
 = 
	`mem_d”ef
(auplay);

62 
au¤c
 = 
	`mem_d”ef
(ausrc);

64 ià(
’gšeObjeù
 !ğ
NULL
) {

65 (*
’gšeObjeù
)->
	`De¡roy
(engineObject);

66 
’gšeObjeù
 = 
NULL
;

67 
’gšeEngše
 = 
NULL
;

71 
	}
}

74 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
İ’¦es
) = {

77 
moduË_š™
,

78 
moduË_şo£
,

	@baresip/modules/opensles/opensles.h

8 
SLObjeùItf
 
’gšeObjeù
;

9 
SLEngšeItf
 
’gšeEngše
;

12 
İ’¦es_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

13 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

14 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

15 
İ’¦es_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

16 
medŸ_ùx
 **
ùx
,

17 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

18 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

	@baresip/modules/opensles/player.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<SLES/O³nSLES.h
>

10 
	~"SLES/O³nSLES_Android.h
"

11 
	~"İ’¦es.h
"

14 
	#N_PLAY_QUEUE_BUFFERS
 2

	)

15 
	#PTIME
 10

	)

18 
	sau¶ay_¡
 {

19 cÚ¡ 
au¶ay
 *
	m­
;

20 
au¶ay_wr™e_h
 *
	mwh
;

21 *
	m¬g
;

22 
št16_t
 *
	m§mpv
[
N_PLAY_QUEUE_BUFFERS
];

23 
size_t
 
	m§mpc
;

24 
ušt8_t
 
	mbufãrId
;

26 
SLObjeùItf
 
	mouutMixObjeù
;

27 
SLObjeùItf
 
	mbqPÏy”Objeù
;

28 
SLPÏyItf
 
	mbqPÏy”PÏy
;

29 
SLAndroidSim¶eBufãrQueueItf
 
	mBufãrQueue
;

33 
	$au¶ay_de¡ruùÜ
(*
¬g
)

35 
au¶ay_¡
 *
¡
 = 
¬g
;

37 ià(
¡
->
bqPÏy”Objeù
 !ğ
NULL
)

38 (*
¡
->
bqPÏy”Objeù
)->
	`De¡roy
(st->bqPlayerObject);

40 ià(
¡
->
ouutMixObjeù
 !ğ
NULL
)

41 (*
¡
->
ouutMixObjeù
)->
	`De¡roy
(st->outputMixObject);

43 
¡
->
bufãrId
 = 0;

44 
i
=0; i<
N_PLAY_QUEUE_BUFFERS
; i++) {

45 
	`mem_d”ef
(
¡
->
§mpv
[
i
]);

47 
	}
}

50 
	$bqPÏy”C®lback
(
SLAndroidSim¶eBufãrQueueItf
 
bq
, *
cÚ‹xt
)

52 
au¶ay_¡
 *
¡
 = 
cÚ‹xt
;

54 
¡
->
	`wh
(¡->
§mpv
[¡->
bufãrId
], st->
§mpc
, st->
¬g
);

56 (*
¡
->
BufãrQueue
)->
	`Enqueue
(
bq
 ,

57 
¡
->
§mpv
[¡->
bufãrId
], st->
§mpc
 * 2);

59 
¡
->
bufãrId
 = ( st->bufãrId + 1 ) % 
N_PLAY_QUEUE_BUFFERS
;

60 
	}
}

63 
	$ü—‹Ouut
(
au¶ay_¡
 *
¡
)

65 cÚ¡ 
SLIÁ”çûID
 
ids
[1] = {
SL_IID_ENVIRONMENTALREVERB
};

66 cÚ¡ 
SLboŞ—n
 
»q
[1] = {
SL_BOOLEAN_FALSE
};

67 
SL»suÉ
 
r
;

69 
r
 = (*
’gšeEngše
)->
	`C»©eOuutMix
(engineEngine,

70 &
¡
->
ouutMixObjeù
, 1, 
ids
, 
»q
);

71 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

72  
ENODEV
;

74 
r
 = (*
¡
->
ouutMixObjeù
)->
	`R—lize
(st->outputMixObject,

75 
SL_BOOLEAN_FALSE
);

76 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

77  
ENODEV
;

80 
	}
}

83 
	$ü—‹PÏy”
(
au¶ay_¡
 *
¡
, 
au¶ay_´m
 *
´m
)

85 
SLD©aLoÿtÜ_AndroidSim¶eBufãrQueue
 
loc_bufq
 = {

86 
SL_DATALOCATOR_ANDROIDSIMPLEBUFFERQUEUE
, 2

88 
ušt32_t
 
ch_mask
 = 
´m
->
ch
 == 2

89 ? 
SL_SPEAKER_FRONT_LEFT
 | 
SL_SPEAKER_FRONT_RIGHT


90 : 
SL_SPEAKER_FRONT_CENTER
;

91 
SLD©aFÜm©_PCM
 
fÜm©_pcm
 = {
SL_DATAFORMAT_PCM
, 
´m
->
ch
,

92 
´m
->
¤©e
 * 1000,

93 
SL_PCMSAMPLEFORMAT_FIXED_16
,

94 
SL_PCMSAMPLEFORMAT_FIXED_16
,

95 
ch_mask
,

96 
SL_BYTEORDER_LITTLEENDIAN
};

97 
SLD©aSourû
 
audioSrc
 = {&
loc_bufq
, &
fÜm©_pcm
};

98 
SLD©aLoÿtÜ_OuutMix
 
loc_outmix
 = {

99 
SL_DATALOCATOR_OUTPUTMIX
, 
¡
->
ouutMixObjeù


101 
SLD©aSšk
 
audioSnk
 = {&
loc_outmix
, 
NULL
};

102 cÚ¡ 
SLIÁ”çûID
 
ids
[2] = {
SL_IID_BUFFERQUEUE
, 
SL_IID_EFFECTSEND
};

103 cÚ¡ 
SLboŞ—n
 
»q
[2] = {
SL_BOOLEAN_TRUE
, SL_BOOLEAN_TRUE};

104 
SL»suÉ
 
r
;

106 
r
 = (*
’gšeEngše
)->
	`C»©eAudioPÏy”
(engineEngine,

107 &
¡
->
bqPÏy”Objeù
,

108 &
audioSrc
, &
audioSnk
,

109 
	`ARRAY_SIZE
(
ids
), ids, 
»q
);

110 ià(
SL_RESULT_SUCCESS
 !ğ
r
) {

111 
	`w¬nšg
("İ’¦es: C»©eAudioPÏy”ƒ¼Ü:„ = %d\n", 
r
);

112  
ENODEV
;

115 
r
 = (*
¡
->
bqPÏy”Objeù
)->
	`R—lize
(st->bqPlayerObject,

116 
SL_BOOLEAN_FALSE
);

117 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

118  
ENODEV
;

120 
r
 = (*
¡
->
bqPÏy”Objeù
)->
	`G‘IÁ”çû
(st->bqPlayerObject,

121 
SL_IID_PLAY
,

122 &
¡
->
bqPÏy”PÏy
);

123 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

124  
ENODEV
;

126 
r
 = (*
¡
->
bqPÏy”Objeù
)->
	`G‘IÁ”çû
(st->bqPlayerObject,

127 
SL_IID_BUFFERQUEUE
,

128 &
¡
->
BufãrQueue
);

129 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

130  
ENODEV
;

132 
r
 = (*
¡
->
BufãrQueue
)->
	`Regi¡”C®lback
(st->BufferQueue,

133 
bqPÏy”C®lback
, 
¡
);

134 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

135  
ENODEV
;

137 
r
 = (*
¡
->
bqPÏy”PÏy
)->
	`S‘PÏyS‹
(st->bqPlayerPlay,

138 
SL_PLAYSTATE_PLAYING
);

139 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

140  
ENODEV
;

143 
	}
}

146 
	$İ’¦es_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

147 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

148 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

150 
au¶ay_¡
 *
¡
;

151 
”r
;

152 ()
deviû
;

154 ià(!
¡p
 || !
­
 || !
´m
 || !
wh
)

155  
EINVAL
;

157 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

158 
	`w¬nšg
("opensles:…layer: unsupported sample format (%s)\n",

159 
	`aufmt_Çme
(
´m
->
fmt
));

160  
ENOTSUP
;

163 
	`debug
("opensles: opening…layer %uHz, %uchannels\n",

164 
´m
->
¤©e
,…rm->
ch
);

166 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

167 ià(!
¡
)

168  
ENOMEM
;

170 
¡
->
­
 =‡p;

171 
¡
->
wh
 = wh;

172 
¡
->
¬g
 =‡rg;

174 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 * 
PTIME
 / 1000;

176 
¡
->
bufãrId
 = 0;

177 
i
=0; i<
N_PLAY_QUEUE_BUFFERS
; i++) {

178 
¡
->
§mpv
[
i
] = 
	`mem_z®loc
(2 * st->
§mpc
, 
NULL
);

179 ià(!
¡
->
§mpv
[
i
]) {

180 
”r
 = 
ENOMEM
;

181 
out
;

185 
”r
 = 
	`ü—‹Ouut
(
¡
);

186 ià(
”r
)

187 
out
;

189 
”r
 = 
	`ü—‹PÏy”
(
¡
, 
´m
);

190 ià(
”r
)

191 
out
;

194 
	`bqPÏy”C®lback
(
¡
->
BufãrQueue
, st);

196 
out
:

197 ià(
”r
)

198 
	`mem_d”ef
(
¡
);

200 *
¡p
 = 
¡
;

202  
”r
;

203 
	}
}

	@baresip/modules/opensles/recorder.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<¡ršg.h
>

10 
	~<SLES/O³nSLES.h
>

11 
	~"SLES/O³nSLES_Android.h
"

12 
	~"İ’¦es.h
"

15 
	#N_REC_QUEUE_BUFFERS
 2

	)

16 
	#PTIME
 10

	)

19 
	sau¤c_¡
 {

20 cÚ¡ 
au¤c
 *
	mas
;

22 
št16_t
 *
	m§mpv
[
N_REC_QUEUE_BUFFERS
];

23 
size_t
 
	m§mpc
;

24 
ušt8_t
 
	mbufãrId
;

25 
au¤c_»ad_h
 *
	mrh
;

26 *
	m¬g
;

28 
SLObjeùItf
 
	m»cObjeù
;

29 
SLRecÜdItf
 
	m»cRecÜd
;

30 
SLAndroidSim¶eBufãrQueueItf
 
	m»cBufãrQueue
;

34 
	$au¤c_de¡ruùÜ
(*
¬g
)

36 
au¤c_¡
 *
¡
 = 
¬g
;

38 ià(
¡
->
»cObjeù
 !ğ
NULL
) {

39 
SLušt32
 
¡©e
;

41 ià(
SL_OBJECT_STATE_UNREALIZED
 !=

42 (*
¡
->
»cObjeù
)->
	`G‘S‹
(¡->»cObjeù,&
¡©e
)) {

43 (*
¡
->
»cObjeù
)->
	`De¡roy
(st->recObject);

47 
¡
->
bufãrId
 = 0;

48 
i
=0; i<
N_REC_QUEUE_BUFFERS
; i++) {

49 
	`mem_d”ef
(
¡
->
§mpv
[
i
]);

51 
	}
}

54 
	$bqRecÜd”C®lback
(
SLAndroidSim¶eBufãrQueueItf
 
bq
, *
cÚ‹xt
)

56 
au¤c_¡
 *
¡
 = 
cÚ‹xt
;

58 ()
bq
;

60 
¡
->
	`rh
(¡->
§mpv
[¡->
bufãrId
], st->
§mpc
, st->
¬g
);

62 
¡
->
bufãrId
 = ( st->bufãrId + 1 ) % 
N_REC_QUEUE_BUFFERS
;

64 
	`mem£t
(
¡
->
§mpv
[¡->
bufãrId
], 0, st->
§mpc
 * 2);

66 (*
¡
->
»cBufãrQueue
)->
	`Enqueue
(st->recBufferQueue,

67 
¡
->
§mpv
[¡->
bufãrId
],

68 
¡
->
§mpc
 * 2);

69 
	}
}

72 
	$ü—‹AudioRecÜd”
(
au¤c_¡
 *
¡
, 
au¤c_´m
 *
´m
)

74 
SLD©aLoÿtÜ_IODeviû
 
loc_dev
 = {
SL_DATALOCATOR_IODEVICE
,

75 
SL_IODEVICE_AUDIOINPUT
,

76 
SL_DEFAULTDEVICEID_AUDIOINPUT
,

77 
NULL
};

78 
SLD©aSourû
 
audioSrc
 = {&
loc_dev
, 
NULL
};

80 
SLD©aLoÿtÜ_AndroidSim¶eBufãrQueue
 
loc_bq
 = {

81 
SL_DATALOCATOR_ANDROIDSIMPLEBUFFERQUEUE
, 2

83 
¥—k”s
 = 
´m
->
ch
 > 1

84 ? 
SL_SPEAKER_FRONT_LEFT
 | 
SL_SPEAKER_FRONT_RIGHT


85 : 
SL_SPEAKER_FRONT_CENTER
;

86 
SLD©aFÜm©_PCM
 
fÜm©_pcm
 = {
SL_DATAFORMAT_PCM
, 
´m
->
ch
,

87 
´m
->
¤©e
 * 1000,

88 
SL_PCMSAMPLEFORMAT_FIXED_16
,

89 
SL_PCMSAMPLEFORMAT_FIXED_16
,

90 
¥—k”s
,

91 
SL_BYTEORDER_LITTLEENDIAN
};

92 
SLD©aSšk
 
audioSnk
 = {&
loc_bq
, &
fÜm©_pcm
};

93 cÚ¡ 
SLIÁ”çûID
 
id
[1] = {
SL_IID_ANDROIDSIMPLEBUFFERQUEUE
};

94 cÚ¡ 
SLboŞ—n
 
»q
[1] = {
SL_BOOLEAN_TRUE
};

95 
SL»suÉ
 
r
;

97 
r
 = (*
’gšeEngše
)->
	`C»©eAudioRecÜd”
(engineEngine,

98 &
¡
->
»cObjeù
,

99 &
audioSrc
,

100 &
audioSnk
, 1, 
id
, 
»q
);

101 ià(
SL_RESULT_SUCCESS
 !ğ
r
) {

102 
	`w¬nšg
("İ’¦es: C»©eAudioRecÜd” faed:„ = %d\n", 
r
);

103  
ENODEV
;

106 
r
 = (*
¡
->
»cObjeù
)->
	`R—lize
(¡->»cObjeù, 
SL_BOOLEAN_FALSE
);

107 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

108  
ENODEV
;

110 
r
 = (*
¡
->
»cObjeù
)->
	`G‘IÁ”çû
(¡->»cObjeù, 
SL_IID_RECORD
,

111 &
¡
->
»cRecÜd
);

112 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

113  
ENODEV
;

115 
r
 = (*
¡
->
»cObjeù
)->
	`G‘IÁ”çû
(st->recObject,

116 
SL_IID_ANDROIDSIMPLEBUFFERQUEUE
,

117 &
¡
->
»cBufãrQueue
);

118 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

119  
ENODEV
;

121 
r
 = (*
¡
->
»cBufãrQueue
)->
	`Regi¡”C®lback
(st->recBufferQueue,

122 
bqRecÜd”C®lback
,

123 
¡
);

124 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

125  
ENODEV
;

128 
	}
}

131 
	$¡¬tRecÜdšg
(
au¤c_¡
 *
¡
)

133 
SL»suÉ
 
r
;

135 (*
¡
->
»cRecÜd
)->
	`S‘RecÜdS‹
(st->recRecord,

136 
SL_RECORDSTATE_STOPPED
);

137 (*
¡
->
»cBufãrQueue
)->
	`CË¬
(st->recBufferQueue);

139 
¡
->
bufãrId
 = 0;

140 
r
 = (*
¡
->
»cBufãrQueue
)->
	`Enqueue
(st->recBufferQueue,

141 
¡
->
§mpv
[¡->
bufãrId
],

142 
¡
->
§mpc
 * 2);

143 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

144  
ENODEV
;

146 
r
 = (*
¡
->
»cRecÜd
)->
	`S‘RecÜdS‹
(st->recRecord,

147 
SL_RECORDSTATE_RECORDING
);

148 ià(
SL_RESULT_SUCCESS
 !ğ
r
)

149  
ENODEV
;

152 
	}
}

155 
	$İ’¦es_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

156 
medŸ_ùx
 **
ùx
,

157 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

158 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

160 
au¤c_¡
 *
¡
;

161 
”r
;

162 ()
ùx
;

163 ()
deviû
;

164 ()
”rh
;

166 ià(!
¡p
 || !
as
 || !
´m
 || !
rh
)

167  
EINVAL
;

169 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

170 
	`w¬nšg
("opensles:„ecord: unsupported sample format (%s)\n",

171 
	`aufmt_Çme
(
´m
->
fmt
));

172  
ENOTSUP
;

175 
	`debug
("opensles: opening„ecorder %uHz, %uchannels\n",

176 
´m
->
¤©e
,…rm->
ch
);

178 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

179 ià(!
¡
)

180  
ENOMEM
;

182 
¡
->
as
 =‡s;

183 
¡
->
rh
 =„h;

184 
¡
->
¬g
 =‡rg;

186 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 * 
PTIME
 / 1000;

187 
¡
->
bufãrId
 = 0;

188 
i
=0; i<
N_REC_QUEUE_BUFFERS
; i++) {

189 
¡
->
§mpv
[
i
] = 
	`mem_z®loc
(2 * st->
§mpc
, 
NULL
);

190 ià(!
¡
->
§mpv
[
i
]) {

191 
”r
 = 
ENOMEM
;

192 
out
;

196 
”r
 = 
	`ü—‹AudioRecÜd”
(
¡
, 
´m
);

197 ià(
”r
)

198 
out
;

200 
”r
 = 
	`¡¬tRecÜdšg
(
¡
);

201 ià(
”r
) {

202 
	`w¬nšg
("opensles: failedo start„ecorder\n");

203 
out
;

206 
out
:

208 ià(
”r
)

209 
	`mem_d”ef
(
¡
);

211 *
¡p
 = 
¡
;

213  
”r
;

214 
	}
}

	@baresip/modules/opus/decode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<İus/İus.h
>

10 
	~"İus.h
"

13 
	saudec_¡©e
 {

14 
OpusDecod”
 *
	mdec
;

15 
	mch
;

19 
	$de¡ruùÜ
(*
¬g
)

21 
audec_¡©e
 *
ads
 = 
¬g
;

23 ià(
ads
->
dec
)

24 
	`İus_decod”_de¡roy
(
ads
->
dec
);

25 
	}
}

28 
	$İus_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

29 cÚ¡ *
fm
)

31 
audec_¡©e
 *
ads
;

32 
İu£¼
, 
”r
 = 0;

33 ()
fm
;

35 ià(!
ad¥
 || !
ac
 || !ac->
ch
)

36  
EINVAL
;

38 
ads
 = *
ad¥
;

40 ià(
ads
)

43 
ads
 = 
	`mem_z®loc
((*ads), 
de¡ruùÜ
);

44 ià(!
ads
)

45  
ENOMEM
;

47 
ads
->
ch
 = 
ac
->ch;

49 
ads
->
dec
 = 
	`İus_decod”_ü—‹
(
ac
->
¤©e
,‡c->
ch
, &
İu£¼
);

50 ià(!
ads
->
dec
) {

51 
	`w¬nšg
("İus: decod” c»©e: %s\n", 
	`İus_¡»¼Ü
(
İu£¼
));

52 
”r
 = 
ENOMEM
;

53 
out
;

56 
out
:

57 ià(
”r
)

58 
	`mem_d”ef
(
ads
);

60 *
ad¥
 = 
ads
;

62  
”r
;

63 
	}
}

66 
	$İus_decode_äm
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

67 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

69 
n
;

71 ià(!
ads
 || !
§mpv
 || !
§mpc
 || !
buf
)

72  
EINVAL
;

74 
n
 = 
	`İus_decode
(
ads
->
dec
, 
buf
, (
İus_št32
)
Ën
,

75 
§mpv
, ()(*
§mpc
/
ads
->
ch
), 0);

76 ià(
n
 < 0) {

77 
	`w¬nšg
("İus: decod”rÜ: %s\n", 
	`İus_¡»¼Ü
(
n
));

78  
EPROTO
;

81 *
§mpc
 = 
n
 * 
ads
->
ch
;

84 
	}
}

87 
	$İus_decode_pkloss
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

89 
n
;

91 ià(!
ads
 || !
§mpv
 || !
§mpc
)

92  
EINVAL
;

94 
n
 = 
	`İus_decode
(
ads
->
dec
, 
NULL
, 0, 
§mpv
, ()(*
§mpc
/ads->
ch
), 0);

95 ià(
n
 < 0)

96  
EPROTO
;

98 *
§mpc
 = 
n
 * 
ads
->
ch
;

101 
	}
}

	@baresip/modules/opus/encode.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<İus/İus.h
>

10 
	~"İus.h
"

13 
	sau’c_¡©e
 {

14 
OpusEncod”
 *
	m’c
;

15 
	mch
;

19 
	$de¡ruùÜ
(*
¬g
)

21 
au’c_¡©e
 *
«s
 = 
¬g
;

23 ià(
«s
->
’c
)

24 
	`İus_’cod”_de¡roy
(
«s
->
’c
);

25 
	}
}

28 
İus_št32
 
	$¤©e2bw
(
İus_št32
 
¤©e
)

30 ià(
¤©e
 >= 48000)

31  
OPUS_BANDWIDTH_FULLBAND
;

32 ià(
¤©e
 >= 24000)

33  
OPUS_BANDWIDTH_SUPERWIDEBAND
;

34 ià(
¤©e
 >= 16000)

35  
OPUS_BANDWIDTH_WIDEBAND
;

36 ià(
¤©e
 >= 12000)

37  
OPUS_BANDWIDTH_MEDIUMBAND
;

39  
OPUS_BANDWIDTH_NARROWBAND
;

40 
	}
}

44 cÚ¡ *
	$bwÇme
(
İus_št32
 
bw
)

46 
bw
) {

47 
OPUS_BANDWIDTH_FULLBAND
:  "full";

48 
OPUS_BANDWIDTH_SUPERWIDEBAND
:  "superwide";

49 
OPUS_BANDWIDTH_WIDEBAND
:  "wide";

50 
OPUS_BANDWIDTH_MEDIUMBAND
:  "medium";

51 
OPUS_BANDWIDTH_NARROWBAND
:  "narrow";

54 
	}
}

57 cÚ¡ *
	$chÇme
(
İus_št32
 
ch
)

59 
ch
) {

60 
OPUS_AUTO
:  "auto";

65 
	}
}

69 
	$İus_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

70 
au’c_·¿m
 *
·¿m
, cÚ¡ *
fm
)

72 
au’c_¡©e
 *
«s
;

73 
İus_·¿m
 
´m
, 
cÚf_´m
;

74 
İus_št32
 
fch
, 
vbr
;

75 cÚ¡ 
aucodec
 *
auc
 = 
ac
;

77 ()
·¿m
;

79 ià(!
«¥
 || !
ac
 || !ac->
ch
)

80  
EINVAL
;

82 
	`debug
("İus:ƒncod” fm (%s)\n", 
fm
);

85 ià(
	`¡r_is£t
(
fm
)) {

86 
	`İus_mœrÜ_·¿ms
(
fm
);

89 
«s
 = *
«¥
;

91 ià(!
«s
) {

92 cÚ¡ 
İus_št32
 
com¶ex
 = 10;

93 
İu£¼
;

95 
«s
 = 
	`mem_z®loc
((*«s), 
de¡ruùÜ
);

96 ià(!
«s
)

97  
ENOMEM
;

99 
«s
->
ch
 = 
ac
->ch;

101 
«s
->
’c
 = 
	`İus_’cod”_ü—‹
(
ac
->
¤©e
,‡c->
ch
,

103 
OPUS_APPLICATION_AUDIO
,

104 &
İu£¼
);

105 ià(!
«s
->
’c
) {

106 
	`w¬nšg
("opus:ƒncoder create: %s\n",

107 
	`İus_¡»¼Ü
(
İu£¼
));

108 
	`mem_d”ef
(
«s
);

109  
ENOMEM
;

112 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_COMPLEXITY
(
com¶ex
));

114 *
«¥
 = 
«s
;

117 
´m
.
¤©e
 = 48000;

118 
´m
.
b™¿‹
 = 
OPUS_AUTO
;

119 
´m
.
¡”eo
 = 1;

120 
´m
.
cbr
 = 0;

121 
´m
.
šbªd_ãc
 = 0;

122 
´m
.
dtx
 = 0;

124 
	`İus_decode_fm
(&
´m
, 
fm
);

126 
cÚf_´m
.
b™¿‹
 = 
OPUS_AUTO
;

127 
	`İus_decode_fm
(&
cÚf_´m
, 
auc
->
fm
);

129 ià((
´m
.
b™¿‹
 =ğ
OPUS_AUTO
) ||

130 ((
cÚf_´m
.
b™¿‹
 !ğ
OPUS_AUTO
) &&

131 (
cÚf_´m
.
b™¿‹
 < 
´m
.bitrate)))

132 
´m
.
b™¿‹
 = 
cÚf_´m
.bitrate;

134 
fch
 = 
´m
.
¡”eo
 ? 
OPUS_AUTO
 : 1;

135 
vbr
 = 
´m
.
cbr
 ? 0 : 1;

137 ()
	`İus_’cod”_ùl
(
«s
->
’c
,

138 
	`OPUS_SET_MAX_BANDWIDTH
(
	`¤©e2bw
(
´m
.
¤©e
)));

139 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_BITRATE
(
´m
.
b™¿‹
));

140 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_FORCE_CHANNELS
(
fch
));

141 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_VBR
(
vbr
));

142 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_INBAND_FEC
(
´m
.
šbªd_ãc
));

143 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_SET_DTX
(
´m
.
dtx
));

148 
İus_št32
 
bw
, 
com¶ex
;

150 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_MAX_BANDWIDTH
(&
bw
));

151 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_BITRATE
(&
´m
.
b™¿‹
));

152 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_FORCE_CHANNELS
(&
fch
));

153 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_VBR
(&
vbr
));

154 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_INBAND_FEC
(&
´m
.
šbªd_ãc
));

155 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_DTX
(&
´m
.
dtx
));

156 ()
	`İus_’cod”_ùl
(
«s
->
’c
, 
	`OPUS_GET_COMPLEXITY
(&
com¶ex
));

158 
	`debug
("opus:ƒncode bw=%s bitrate=%i fch=%s "

160 
	`bwÇme
(
bw
), 
´m
.
b™¿‹
, 
	`chÇme
(
fch
),

161 
vbr
, 
´m
.
šbªd_ãc
,…rm.
dtx
, 
com¶ex
);

166 
	}
}

169 
	$İus_’code_äm
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

170 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

172 
İus_št32
 
n
;

174 ià(!
«s
 || !
buf
 || !
Ën
 || !
§mpv
)

175  
EINVAL
;

177 
n
 = 
	`İus_’code
(
«s
->
’c
, 
§mpv
, ()(
§mpc
/«s->
ch
),

178 
buf
, (
İus_št32
)(*
Ën
));

179 ià(
n
 < 0) {

180 
	`w¬nšg
("İus:ƒncod”rÜ: %s\n", 
	`İus_¡»¼Ü
(()
n
));

181  
EPROTO
;

184 *
Ën
 = 
n
;

187 
	}
}

	@baresip/modules/opus/opus.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<İus/İus.h
>

10 
	~"İus.h
"

38 
boŞ
 
	gİus_mœrÜ
;

39 
	gfm
[256] = "";

40 
	gfm_mœrÜ
[256];

43 
	$İus_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

44 
boŞ
 
ofãr
, *
¬g
)

46 
boŞ
 
mœrÜ
;

48 ()
¬g
;

49 ()
ofãr
;

51 ià(!
mb
 || !
fmt
)

54 
mœrÜ
 = !
ofãr
 && 
	`¡r_is£t
(
fm_mœrÜ
);

56  
	`mbuf_´štf
(
mb
, "a=fmtp:%s %s\r\n",

57 
fmt
->
id
, 
mœrÜ
 ? 
fm_mœrÜ
 : 
fm
);

58 
	}
}

61 
aucodec
 
	gİus
 = {

62 .
Çme
 = "opus",

63 .
	g¤©e
 = 48000,

64 .
	gü©e
 = 48000,

65 .
	gch
 = 2,

66 .
	gfm
 = 
fm
,

67 .
	g’cupdh
 = 
İus_’code_upd©e
,

68 .
	g’ch
 = 
İus_’code_äm
,

69 .
	gdecupdh
 = 
İus_decode_upd©e
,

70 .
	gdech
 = 
İus_decode_äm
,

71 .
	g¶ch
 = 
İus_decode_pkloss
,

75 
	$İus_mœrÜ_·¿ms
(cÚ¡ *
x
)

77 ià(!
İus_mœrÜ
)

80 
	`šfo
("İus: mœrÜ…¬am‘”s: \"%s\"\n", 
x
);

82 
	`¡r_nıy
(
fm_mœrÜ
, 
x
, (fmtp_mirror));

83 
	}
}

86 
	$moduË_š™
()

88 
cÚf
 *cÚàğ
	`cÚf_cur
();

89 
ušt32_t
 
v®ue
;

90 *
p
 = 
fm
 + 
	`¡r_Ën
(fmtp);

91 
boŞ
 
b
, 
¡”eo
 = 
Œue
, 
¥rİ_¡”eo
 =rue;

92 
n
 = 0;

94 
	`cÚf_g‘_boŞ
(
cÚf
, "İus_¡”eo", &
¡”eo
);

95 
	`cÚf_g‘_boŞ
(
cÚf
, "İus_¥rİ_¡”eo", &
¥rİ_¡”eo
);

98 
n
 = 
	`»_¢´štf
(
p
, (
fm
è- 
	`¡r_Ën
(p),

99 "¡”eo=%d;¥rİ-¡”eo=%d", 
¡”eo
, 
¥rİ_¡”eo
);

100 ià(
n
 <= 0)

101  
ENOMEM
;

103 
p
 +ğ
n
;

105 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "İus_b™¿‹", &
v®ue
)) {

107 
n
 = 
	`»_¢´štf
(
p
, (
fm
è- 
	`¡r_Ën
(p),

108 ";maxav”ageb™¿‹=%d", 
v®ue
);

109 ià(
n
 <= 0)

110  
ENOMEM
;

112 
p
 +ğ
n
;

115 ià(0 =ğ
	`cÚf_g‘_boŞ
(
cÚf
, "İus_cbr", &
b
)) {

117 
n
 = 
	`»_¢´štf
(
p
, (
fm
è- 
	`¡r_Ën
(p),

118 ";cbr=%d", 
b
);

119 ià(
n
 <= 0)

120  
ENOMEM
;

122 
p
 +ğ
n
;

125 ià(0 =ğ
	`cÚf_g‘_boŞ
(
cÚf
, "İus_šbªdãc", &
b
)) {

127 
n
 = 
	`»_¢´štf
(
p
, (
fm
è- 
	`¡r_Ën
(p),

128 ";u£šbªdãc=%d", 
b
);

129 ià(
n
 <= 0)

130  
ENOMEM
;

132 
p
 +ğ
n
;

135 ià(0 =ğ
	`cÚf_g‘_boŞ
(
cÚf
, "İus_dtx", &
b
)) {

137 
n
 = 
	`»_¢´štf
(
p
, (
fm
è- 
	`¡r_Ën
(p),

138 ";u£dtx=%d", 
b
);

139 ià(
n
 <= 0)

140  
ENOMEM
;

142 
p
 +ğ
n
;

145 ()
	`cÚf_g‘_boŞ
(
cÚf
, "İus_mœrÜ", &
İus_mœrÜ
);

147 ià(
İus_mœrÜ
) {

148 
İus
.
fm
 = 
NULL
;

149 
İus
.
fm_’ch
 = 
İus_fm_’c
;

152 
	`debug
("İus: fm=\"%s\"\n", 
fm
);

154 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
İus
);

157 
	}
}

160 
	$moduË_şo£
()

162 
	`aucodec_uÄegi¡”
(&
İus
);

165 
	}
}

168 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
İus
) = {

171 
moduË_š™
,

172 
moduË_şo£
,

	@baresip/modules/opus/opus.h

8 
	sİus_·¿m
 {

9 
İus_št32
 
	m¤©e
;

10 
İus_št32
 
	mb™¿‹
;

11 
İus_št32
 
	m¡”eo
;

12 
İus_št32
 
	mcbr
;

13 
İus_št32
 
	mšbªd_ãc
;

14 
İus_št32
 
	mdtx
;

19 
İus_’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

20 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
);

21 
İus_’code_äm
(
au’c_¡©e
 *
«s
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

22 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
);

26 
İus_decode_upd©e
(
audec_¡©e
 **
ad¥
, cÚ¡ 
aucodec
 *
ac
,

27 cÚ¡ *
fm
);

28 
İus_decode_äm
(
audec_¡©e
 *
ads
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

29 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
);

30 
İus_decode_pkloss
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
);

34 
İus_decode_fm
(
İus_·¿m
 *
´m
, cÚ¡ *
fm
);

37 
İus_mœrÜ_·¿ms
(cÚ¡ *
fm
);

	@baresip/modules/opus/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~<İus/İus.h
>

10 
	~"İus.h
"

13 
	$assign_if
(
İus_št32
 *
v
, cÚ¡ 
¶
 *pl,

14 
ušt32_t
 
mš
, ušt32_ˆ
max
)

16 cÚ¡ 
ušt32_t
 
v®
 = 
	`¶_u32
(
¶
);

18 ià(
v®
 < 
mš
 || v® > 
max
)

21 *
v
 = 
v®
;

22 
	}
}

25 
	$İus_decode_fm
(
İus_·¿m
 *
´m
, cÚ¡ *
fm
)

27 
¶
…l, 
v®
;

29 ià(!
´m
 || !
fm
)

32 
	`¶_£t_¡r
(&
¶
, 
fm
);

34 ià(
	`fmt_·¿m_g‘
(&
¶
, "max¶ayback¿‹", &
v®
))

35 
	`assign_if
(&
´m
->
¤©e
, &
v®
, 8000, 48000);

37 ià(
	`fmt_·¿m_g‘
(&
¶
, "maxav”ageb™¿‹", &
v®
))

38 
	`assign_if
(&
´m
->
b™¿‹
, &
v®
, 6000, 510000);

40 ià(
	`fmt_·¿m_g‘
(&
¶
, "¡”eo", &
v®
))

41 
	`assign_if
(&
´m
->
¡”eo
, &
v®
, 0, 1);

43 ià(
	`fmt_·¿m_g‘
(&
¶
, "cbr", &
v®
))

44 
	`assign_if
(&
´m
->
cbr
, &
v®
, 0, 1);

46 ià(
	`fmt_·¿m_g‘
(&
¶
, "u£šbªdãc", &
v®
))

47 
	`assign_if
(&
´m
->
šbªd_ãc
, &
v®
, 0, 1);

49 ià(
	`fmt_·¿m_g‘
(&
¶
, "u£dtx", &
v®
))

50 
	`assign_if
(&
´m
->
dtx
, &
v®
, 0, 1);

51 
	}
}

	@baresip/modules/oss/oss.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<¡ršg.h
>

10 
	~<uni¡d.h
>

11 
	~<±h»ad.h
>

12 
	~<fú.h
>

13 
	~<sys/ioùl.h
>

14 #ià
defšed
(
NETBSD
è|| defšed(
OPENBSD
)

15 
	~<soundÿrd.h
>

16 #–ià
defšed
 (
LINUX
)

17 
	~<lšux/soundÿrd.h
>

19 
	~<sys/soundÿrd.h
>

21 #ifdeà
SOLARIS


22 
	~<sys/fio.h
>

38 
	sau¤c_¡
 {

39 cÚ¡ 
au¤c
 *
	mas
;

40 
±h»ad_t
 
	mth»ad
;

41 
boŞ
 
	mrun
;

42 
	mfd
;

43 
št16_t
 *
	m§mpv
;

44 
size_t
 
	m§mpc
;

45 
au¤c_»ad_h
 *
	mrh
;

46 
au¤c_”rÜ_h
 *
	m”rh
;

47 *
	m¬g
;

50 
	sau¶ay_¡
 {

51 cÚ¡ 
au¶ay
 *
	m­
;

52 
±h»ad_t
 
	mth»ad
;

53 
boŞ
 
	mrun
;

54 
	mfd
;

55 
št16_t
 *
	m§mpv
;

56 
size_t
 
	m§mpc
;

57 
au¶ay_wr™e_h
 *
	mwh
;

58 *
	m¬g
;

62 
au¤c
 *
	gau¤c
;

63 
au¶ay
 *
	gau¶ay
;

64 
	goss_dev
[64] = "/dev/dsp";

74 
	$£t_äagm’t
(
fd
, 
ušt32_t
 
§mpc
)

77 
ušt16_t
 
max
;

78 
ušt16_t
 
size
;

79 } 
äagv
[] = {

88 
size_t
 
i
;

89 cÚ¡ 
ušt32_t
 
buf_size
 = 2 * 
§mpc
;

91 
i
=0; i<
	`ARRAY_SIZE
(
äagv
); i++) {

92 cÚ¡ 
ušt16_t
 
äag_max
 = 
äagv
[
i
].
max
;

93 cÚ¡ 
ušt16_t
 
äag_size
 = 
äagv
[
i
].
size
;

94 cÚ¡ 
ušt32_t
 
äagm’t_size
 = 
äag_max
 * (1<<
äag_size
);

96 ià(0 =ğ(
äagm’t_size
%
buf_size
)) {

97 
äagm’t
 = (
äag_max
<<16è| 
äag_size
;

99 ià(0 =ğ
	`ioùl
(
fd
, 
SNDCTL_DSP_SETFRAGMENT
,

100 &
äagm’t
)) {

106  
ENODEV
;

107 
	}
}

110 
	$oss_»£t
(
fd
, 
ušt32_t
 
¤©e
, 
ušt8_t
 
ch
, 
§mpc
,

111 
nÚblock
)

113 
fÜm©
 = 
AFMT_S16_NE
;

114 
¥“d
 = 
¤©e
;

115 
chªÃls
 = 
ch
;

116 
blocksize
 = 0;

117 
”r
;

119 
”r
 = 
	`£t_äagm’t
(
fd
, 
§mpc
);

120 ià(
”r
)

121  
”r
;

123 ià(0 !ğ
	`ioùl
(
fd
, 
FIONBIO
, &
nÚblock
))

124  
”ºo
;

125 ià(0 !ğ
	`ioùl
(
fd
, 
SNDCTL_DSP_SETFMT
, &
fÜm©
))

126  
”ºo
;

127 ià(0 !ğ
	`ioùl
(
fd
, 
SNDCTL_DSP_CHANNELS
, &
chªÃls
))

128  
”ºo
;

129 ià(2 =ğ
chªÃls
) {

130 
¡”eo
 = 1;

131 ià(0 !ğ
	`ioùl
(
fd
, 
SNDCTL_DSP_STEREO
, &
¡”eo
))

132  
”ºo
;

134 ià(0 !ğ
	`ioùl
(
fd
, 
SNDCTL_DSP_SPEED
, &
¥“d
))

135  
”ºo
;

137 ()
	`ioùl
(
fd
, 
SNDCTL_DSP_GETBLKSIZE
, &
blocksize
);

139 
	`šfo
("oss: init: %d Hz %d ch, blocksize=%d\n",

140 
¥“d
, 
chªÃls
, 
blocksize
);

143 
	}
}

146 
	$au¶ay_de¡ruùÜ
(*
¬g
)

148 
au¶ay_¡
 *
¡
 = 
¬g
;

150 ià(
¡
->
run
) {

151 
¡
->
run
 = 
çl£
;

152 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

155 ià(-1 !ğ
¡
->
fd
) {

156 ()
	`şo£
(
¡
->
fd
);

159 
	`mem_d”ef
(
¡
->
§mpv
);

160 
	}
}

163 
	$au¤c_de¡ruùÜ
(*
¬g
)

165 
au¤c_¡
 *
¡
 = 
¬g
;

167 ià(
¡
->
run
) {

168 
¡
->
run
 = 
çl£
;

169 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

172 ià(-1 !ğ
¡
->
fd
) {

173 ()
	`şo£
(
¡
->
fd
);

176 
	`mem_d”ef
(
¡
->
§mpv
);

177 
	}
}

180 *
	$»cÜd_th»ad
(*
¬g
)

182 
au¤c_¡
 *
¡
 = 
¬g
;

183 
n
;

185 
¡
->
run
) {

187 
n
 = 
	`»ad
(
¡
->
fd
, st->
§mpv
, st->
§mpc
*2);

188 ià(
n
 <= 0)

191 
¡
->
	`rh
(¡->
§mpv
, 
n
/2, st->
¬g
);

194  
NULL
;

195 
	}
}

198 *
	$¶ay_th»ad
(*
¬g
)

200 
au¶ay_¡
 *
¡
 = 
¬g
;

201 
n
;

203 
¡
->
run
) {

205 
¡
->
	`wh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

207 
n
 = 
	`wr™e
(
¡
->
fd
, st->
§mpv
, st->
§mpc
*2);

208 ià(
n
 < 0) {

209 
	`w¬nšg
("oss: wr™e: %m\n", 
”ºo
);

214  
NULL
;

215 
	}
}

218 
	$¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

219 
medŸ_ùx
 **
ùx
,

220 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

221 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

223 
au¤c_¡
 *
¡
;

224 
”r
;

226 ()
ùx
;

227 ()
”rh
;

229 ià(!
¡p
 || !
as
 || !
´m
 ||…rm->
fmt
 !ğ
AUFMT_S16LE
 || !
rh
)

230  
EINVAL
;

232 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

233 ià(!
¡
)

234  
ENOMEM
;

236 
¡
->
fd
 = -1;

237 
¡
->
rh
 =„h;

238 
¡
->
”rh
 =ƒrrh;

239 
¡
->
¬g
 =‡rg;

241 ià(!
deviû
)

242 
deviû
 = 
oss_dev
;

244 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

246 
¡
->
§mpv
 = 
	`mem_®loc
(2 * st->
§mpc
, 
NULL
);

247 ià(!
¡
->
§mpv
) {

248 
”r
 = 
ENOMEM
;

249 
out
;

252 
¡
->
fd
 = 
	`İ’
(
deviû
, 
O_RDONLY
);

253 ià(
¡
->
fd
 < 0) {

254 
”r
 = 
”ºo
;

255 
out
;

258 
”r
 = 
	`oss_»£t
(
¡
->
fd
, 
´m
->
¤©e
,…rm->
ch
, st->
§mpc
, 0);

259 ià(
”r
)

260 
out
;

262 
¡
->
as
 =‡s;

264 
¡
->
run
 = 
Œue
;

265 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»cÜd_th»ad
, st);

266 ià(
”r
) {

267 
¡
->
run
 = 
çl£
;

268 
out
;

271 
out
:

272 ià(
”r
)

273 
	`mem_d”ef
(
¡
);

275 *
¡p
 = 
¡
;

277  
”r
;

278 
	}
}

281 
	$¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

282 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

283 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

285 
au¶ay_¡
 *
¡
;

286 
”r
;

288 ià(!
¡p
 || !
­
 || !
´m
 ||…rm->
fmt
 !ğ
AUFMT_S16LE
 || !
wh
)

289  
EINVAL
;

291 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

292 ià(!
¡
)

293  
ENOMEM
;

295 
¡
->
fd
 = -1;

296 
¡
->
wh
 = wh;

297 
¡
->
¬g
 =‡rg;

299 ià(!
deviû
)

300 
deviû
 = 
oss_dev
;

302 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

304 
¡
->
§mpv
 = 
	`mem_®loc
(¡->
§mpc
 * 2, 
NULL
);

305 ià(!
¡
->
§mpv
) {

306 
”r
 = 
ENOMEM
;

307 
out
;

310 
¡
->
fd
 = 
	`İ’
(
deviû
, 
O_WRONLY
);

311 ià(
¡
->
fd
 < 0) {

312 
”r
 = 
”ºo
;

313 
out
;

316 
”r
 = 
	`oss_»£t
(
¡
->
fd
, 
´m
->
¤©e
,…rm->
ch
, st->
§mpc
, 0);

317 ià(
”r
)

318 
out
;

320 
¡
->
­
 =‡p;

322 
¡
->
run
 = 
Œue
;

323 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
¶ay_th»ad
, st);

324 ià(
”r
) {

325 
¡
->
run
 = 
çl£
;

326 
out
;

329 
out
:

330 ià(
”r
)

331 
	`mem_d”ef
(
¡
);

333 *
¡p
 = 
¡
;

335  
”r
;

336 
	}
}

339 
	$moduË_š™
()

341 
”r
;

343 
”r
 = 
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "oss", 
¤c_®loc
);

344 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(), "oss", 
¶ay_®loc
);

346  
”r
;

347 
	}
}

350 
	$moduË_şo£
()

352 
au¤c
 = 
	`mem_d”ef
(ausrc);

353 
au¶ay
 = 
	`mem_d”ef
(auplay);

356 
	}
}

359 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
oss
) = {

362 
moduË_š™
,

363 
moduË_şo£
,

	@baresip/modules/pcp/listener.c

7 
	~<».h
>

8 
	~<»w.h
>

9 
	~<b¬es.h
>

10 
	~"pı.h
"

18 
	spı_li¡’”
 {

19 
udp_sock
 *
	mus
;

20 
§
 
	m¤v
;

21 
§
 
	mgroup
;

22 
pı_msg_h
 *
	mmsgh
;

23 *
	m¬g
;

27 
	$de¡ruùÜ
(*
¬g
)

29 
pı_li¡’”
 *
¶
 = 
¬g
;

31 ià(
	`§_is£t
(&
¶
->
group
, 
SA_ADDR
))

32 ()
	`udp_muÉiÿ¡_Ëave
(
¶
->
us
, &¶->
group
);

34 
	`mem_d”ef
(
¶
->
us
);

35 
	}
}

38 
	$udp_»cv
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

40 
pı_li¡’”
 *
¶
 = 
¬g
;

41 
pı_msg
 *
msg
;

42 
”r
;

45 ià(!
	`§_cmp
(
¤c
, &
¶
->
¤v
, 
SA_ADDR
)) {

46 
	`debug
("pcp:†istener: ignore %zu bytes from‚on-server %J\n",

47 
mb
->
’d
, 
¤c
);

52 
”r
 = 
	`pı_msg_decode
(&
msg
, 
mb
);

53 ià(
”r
)

57 ià(!
msg
->
hdr
.
»¥
) {

58 
	`šfo
("pı:†i¡’”: ignÜ»que¡ from %J\n", 
¤c
);

59 
out
;

62 ià(
¶
->
msgh
)

63 
¶
->
	`msgh
(
msg
,…l->
¬g
);

65 
out
:

66 
	`mem_d”ef
(
msg
);

67 
	}
}

70 
	$pı_li¡’
(
pı_li¡’”
 **
¶p
, cÚ¡ 
§
 *
¤v
,

71 
pı_msg_h
 *
msgh
, *
¬g
)

73 
pı_li¡’”
 *
¶
;

74 
§
 
Ïddr
;

75 
”r
;

77 ià(!
¶p
 || !
¤v
 || !
msgh
)

78  
EINVAL
;

80 
¶
 = 
	`mem_z®loc
((*¶), 
de¡ruùÜ
);

81 ià(!
¶
)

82  
ENOMEM
;

84 
¶
->
¤v
 = *srv;

85 
¶
->
msgh
 = msgh;

86 
¶
->
¬g
 =‡rg;

89 
	`§_š™
(&
Ïddr
, 
	`§_af
(
¤v
));

90 
	`§_£t_pÜt
(&
Ïddr
, 
PCP_PORT_CLI
);

92 
”r
 = 
	`udp_li¡’
(&
¶
->
us
, &
Ïddr
, 
udp_»cv
,…l);

93 ià(
”r
)

94 
out
;

96 
	`§_af
(&
Ïddr
)) {

98 
AF_INET
:

99 
”r
 = 
	`§_£t_¡r
(&
¶
->
group
, "224.0.0.1", 0);

102 
AF_INET6
:

103 
”r
 = 
	`§_£t_¡r
(&
¶
->
group
, "ff02::1", 0);

107 
”r
 = 
EAFNOSUPPORT
;

110 ià(
”r
)

111 
out
;

113 
”r
 = 
	`udp_muÉiÿ¡_još
(
¶
->
us
, &¶->
group
);

114 ià(
”r
)

115 
out
;

117 
out
:

118 ià(
”r
)

119 
	`mem_d”ef
(
¶
);

121 *
¶p
 = 
¶
;

123  
”r
;

124 
	}
}

	@baresip/modules/pcp/pcp.c

6 
	~<».h
>

7 
	~<»w.h
>

8 
	~<b¬es.h
>

9 
	~"pı.h
"

23 
	mLIFETIME
 = 120

26 
	smÇt_£ss
 {

27 
Ë
 
	mË
;

28 
li¡
 
	mmedŸl
;

29 
mÇt_e¡ab_h
 *
	me¡abh
;

30 *
	m¬g
;

33 
	smÇt_medŸ
 {

35 
	scomp
 {

36 
pı_»que¡
 *
	mpı
;

37 
mÇt_medŸ
 *
	mmedŸ
;

38 
	mid
;

39 
boŞ
 
	mg¿Áed
;

40 } 
	mcompv
[2];

41 
	mcompc
;

43 
Ë
 
	mË
;

44 
mÇt_£ss
 *
	m£ss
;

45 
sdp_medŸ
 *
	msdpm
;

46 
ušt32_t
 
	m¤v_•och
;

50 
mÇt
 *
	gmÇt
;

51 
§
 
	gpı_¤v
;

52 
li¡
 
	g£s¦
;

53 
pı_li¡’”
 *
	gl¢r
;

56 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

58 
mÇt_£ss
 *
£ss
 = 
¬g
;

60 
	`li¡_uÆšk
(&
£ss
->
Ë
);

61 
	`li¡_æush
(&
£ss
->
medŸl
);

62 
	}
}

65 
	$medŸ_de¡ruùÜ
(*
¬g
)

67 
mÇt_medŸ
 *
m
 = 
¬g
;

68 
i
;

70 
	`li¡_uÆšk
(&
m
->
Ë
);

72 
i
=0; i<
m
->
compc
; i++) {

73 
comp
 *com°ğ&
m
->
compv
[
i
];

75 
	`mem_d”ef
(
comp
->
pı
);

78 
	`mem_d”ef
(
m
->
sdpm
);

79 
	}
}

82 
	$com¶‘e
(
mÇt_£ss
 *
£ss
, 
”r
, cÚ¡ *
»asÚ
)

84 
mÇt_e¡ab_h
 *
e¡abh
 = 
£ss
->estabh;

85 *
¬g
 = 
£ss
->arg;

87 
£ss
->
e¡abh
 = 
NULL
;

89 ià(
e¡abh
) {

90 
	`e¡abh
(
”r
, 0, 
»asÚ
, 
¬g
);

92 
	}
}

95 
boŞ
 
	$®l_compÚ’ts_g¿Áed
(cÚ¡ 
mÇt_medŸ
 *
m
)

97 
i
;

99 ià(!
m
 || !m->
compc
)

100  
çl£
;

102 
i
=0; i<
m
->
compc
; i++) {

103 cÚ¡ 
comp
 *com°ğ&
m
->
compv
[
i
];

104 ià(!
comp
->
g¿Áed
)

105  
çl£
;

108  
Œue
;

109 
	}
}

112 
	$is_com¶‘e
(
mÇt_£ss
 *
£ss
)

114 
Ë
 *le;

116 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

118 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

120 ià(!
	`®l_compÚ’ts_g¿Áed
(
m
))

124 
	`com¶‘e
(
£ss
, 0, "done");

125 
	}
}

129 
	$pı_»¥_hªdËr
(
”r
, 
pı_msg
 *
msg
, *
¬g
)

131 
comp
 *com°ğ
¬g
;

132 
mÇt_medŸ
 *
m
 = 
comp
->
medŸ
;

133 cÚ¡ 
pı_m­
 *
m­
;

135 ià(
”r
) {

136 
	`w¬nšg
("pı: m­pšgƒ¼Ü: %m\n", 
”r
);

138 
	`com¶‘e
(
m
->
£ss
, 
”r
, 
NULL
);

141 ià(
msg
->
hdr
.
»suÉ
 !ğ
PCP_SUCCESS
) {

142 
	`w¬nšg
("pcp: mappingƒrror: %s\n",

143 
	`pı_»suÉ_Çme
(
msg
->
hdr
.
»suÉ
));

145 
	`»_´štf
("%H\n", 
pı_msg_´št
, 
msg
);

147 
	`com¶‘e
(
m
->
£ss
, 
EPROTO
, "pcpƒrror");

151 
m­
 = 
	`pı_msg_·ylßd
(
msg
);

153 
	`šfo
("pcp: %s: mapping for %s:"

155 
	`sdp_medŸ_Çme
(
m
->
sdpm
),

156 
comp
->
id
==1 ? "RTP" : "RTCP",

157 
m­
->
št_pÜt
, &m­->
ext_addr
);

160 ià(
comp
->
id
 == 1)

161 
	`sdp_medŸ_£t_Ïddr
(
m
->
sdpm
, &
m­
->
ext_addr
);

163 
	`sdp_medŸ_£t_Ïddr_¹ı
(
m
->
sdpm
, &
m­
->
ext_addr
);

165 
comp
->
g¿Áed
 = 
Œue
;

166 
m
->
¤v_•och
 = 
msg
->
hdr
.
•och
;

168 
	`is_com¶‘e
(
m
->
£ss
);

169 
	}
}

172 
	$£ssiÚ_®loc
(
mÇt_£ss
 **
£s¥
, 
dnsc
 *dnsc,

173 
af
, cÚ¡ *
¤v
, 
ušt16_t
 
pÜt
,

174 cÚ¡ *
u£r
, cÚ¡ *
·ss
,

175 
sdp_£ssiÚ
 *
ss
, 
boŞ
 
ofã»r
,

176 
mÇt_e¡ab_h
 *
e¡abh
, *
¬g
)

178 
mÇt_£ss
 *
£ss
;

179 
”r
 = 0;

180 ()
af
;

181 ()
pÜt
;

182 ()
u£r
;

183 ()
·ss
;

184 ()
ss
;

185 ()
ofã»r
;

187 ià(!
£s¥
 || !
dnsc
 || !
¤v
 || !
ss
 || !
e¡abh
)

188  
EINVAL
;

190 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ssiÚ_de¡ruùÜ
);

191 ià(!
£ss
)

192  
ENOMEM
;

194 
£ss
->
e¡abh
 =ƒstabh;

195 
£ss
->
¬g
 =‡rg;

197 
	`li¡_­³nd
(&
£s¦
, &
£ss
->
Ë
, sess);

199 ià(
”r
)

200 
	`mem_d”ef
(
£ss
);

202 *
£s¥
 = 
£ss
;

204  
”r
;

205 
	}
}

208 
	$medŸ_®loc
(
mÇt_medŸ
 **
mp
, 
mÇt_£ss
 *
£ss
,

209 
´Ùo
, *
sock1
, *
sock2
,

210 
sdp_medŸ
 *
sdpm
)

212 
mÇt_medŸ
 *
m
;

213 
§
 
Ïddr
;

214 
pı_m­
 
m­
;

215 
i
;

216 
”r
 = 0;

218 ià(!
mp
 || !
£ss
 || !
sdpm
 || 
´Ùo
 !ğ
IPPROTO_UDP
)

219  
EINVAL
;

221 
m
 = 
	`mem_z®loc
((*m), 
medŸ_de¡ruùÜ
);

222 ià(!
m
)

223  
ENOMEM
;

225 
m
->
compc
 = 
sock2
 ? 2 : 1;

227 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

228 
m
->
£ss
 = sess;

229 
m
->
sdpm
 = 
	`mem_»f
(sdpm);

231 
i
=0; i<
m
->
compc
; i++) {

232 
comp
 *com°ğ&
m
->
compv
[
i
];

234 
comp
->
id
 = 
i
+1;

235 
comp
->
medŸ
 = 
m
;

237 
”r
 = 
	`udp_loÿl_g‘
(
i
==0 ? 
sock1
 : 
sock2
, &
Ïddr
);

238 ià(
”r
)

239 
out
;

241 
	`¿nd_by‹s
(
m­
.
nÚû
, (map.nonce));

242 
m­
.
´Ùo
 =…roto;

243 
m­
.
št_pÜt
 = 
	`§_pÜt
(&
Ïddr
);

245 
	`§_š™
(&
m­
.
ext_addr
, 
	`§_af
(&
pı_¤v
));

247 
	`šfo
("pcp: %s: internal…ort for %s is %u\n",

248 
	`sdp_medŸ_Çme
(
sdpm
),

249 
i
==0 ? "RTP" : "RTCP",

250 
m­
.
št_pÜt
);

252 
”r
 = 
	`pı_»que¡
(&
comp
->
pı
, 
NULL
, &
pı_¤v
, 
PCP_MAP
,

253 
LIFETIME
, &
m­
, 
pı_»¥_hªdËr
, 
comp
, 0);

254 ià(
”r
)

255 
out
;

258 
out
:

259 ià(
”r
)

260 
	`mem_d”ef
(
m
);

261 ià(
mp
) {

262 *
mp
 = 
m
;

265  
”r
;

266 
	}
}

269 
	$medŸ_»äesh
(
mÇt_medŸ
 *
medŸ
)

271 
i
;

273 
i
=0; i<
medŸ
->
compc
; i++) {

274 
comp
 *com°ğ&
medŸ
->
compv
[
i
];

276 
	`pı_fÜû_»äesh
(
comp
->
pı
);

278 
	}
}

281 
	$»äesh_£ssiÚ
(
mÇt_£ss
 *
£ss
, 
ušt32_t
 
•och_time
)

283 
Ë
 *le;

285 
Ë
 = 
£ss
->
medŸl
.
h—d
;†e;†ğË->
Ãxt
) {

287 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

289 ià(
•och_time
 < 
m
->
¤v_•och
) {

290 
	`šfo
("pcp: detected PCP Server„eboot!\n");

291 
	`medŸ_»äesh
(
m
);

294 
m
->
¤v_•och
 = 
•och_time
;

296 
	}
}

299 
	$pı_msg_hªdËr
(cÚ¡ 
pı_msg
 *
msg
, *
¬g
)

301 
Ë
 *le;

303 ()
¬g
;

305 
	`šfo
("pı:„eûived‚ÙifiÿtiÚ: %H\n", 
pı_msg_´št
, 
msg
);

307 ià(
msg
->
hdr
.
İcode
 =ğ
PCP_ANNOUNCE
) {

309 
Ë
 = 
£s¦
.
h—d
;†e;†ğË->
Ãxt
) {

311 
mÇt_£ss
 *
£ss
 = 
Ë
->
d©a
;

313 
	`»äesh_£ssiÚ
(
£ss
, 
msg
->
hdr
.
•och
);

316 
	}
}

319 
	$moduË_š™
()

321 
¶
…l;

322 
”r
;

324 ià(0 =ğ
	`cÚf_g‘
(
	`cÚf_cur
(), "pı_£rv”", &
¶
)) {

325 
”r
 = 
	`§_decode
(&
pı_¤v
, 
¶
.
p
,…l.
l
);

326 ià(
”r
)

327  
”r
;

330 
”r
 = 
	`Ãt_deçuÉ_g©eway_g‘
(
	`Ãt_af
(
	`b¬es_ÃtwÜk
()),

331 &
pı_¤v
);

332 ià(
”r
)

333  
”r
;

334 
	`§_£t_pÜt
(&
pı_¤v
, 
PCP_PORT_SRV
);

337 
	`šfo
("pı: usšg PCP s”v”‡ˆ%J\n", &
pı_¤v
);

341 
”r
 = 
	`pı_li¡’
(&
l¢r
, &
pı_¤v
, 
pı_msg_hªdËr
, 0);

342 ià(
”r
) {

343 
	`šfo
("pı: could‚ÙƒÇbË†i¡’”: %m\n", 
”r
);

344 
”r
 = 0;

347  
	`mÇt_»gi¡”
(&
mÇt
, 
	`b¬es_mÇ
(), "pı", 
NULL
,

348 
£ssiÚ_®loc
, 
medŸ_®loc
, 
NULL
);

349 
	}
}

352 
	$moduË_şo£
()

354 
l¢r
 = 
	`mem_d”ef
(lsnr);

355 
mÇt
 = 
	`mem_d”ef
(mnat);

357 
	}
}

360 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
pı
) = {

363 
moduË_š™
,

364 
moduË_şo£
,

	@baresip/modules/pcp/pcp.h

10 
	gpı_li¡’”
;

12 (
	tpı_msg_h
)(cÚ¡ 
	tpı_msg
 *
	tmsg
, *
	t¬g
);

14 
	`pı_li¡’
(
pı_li¡’”
 **
¶p
, cÚ¡ 
§
 *
¤v
,

15 
pı_msg_h
 *
msgh
, *
¬g
);

	@baresip/modules/plc/plc.c

7 
	#SPANDSP_EXPOSE_INTERNAL_STRUCTURES


	)

9 
	~<¥ªd¥.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

22 
	s¶c_¡
 {

23 
auft_dec_¡
 
	maf
;

24 
¶c_¡©e_t
 
	m¶c
;

25 
size_t
 
	m§mpc
;

29 
	$de¡ruùÜ
(*
¬g
)

31 
¶c_¡
 *
¡
 = 
¬g
;

33 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

34 
	}
}

37 
	$upd©e
(
auft_dec_¡
 **
¡p
, **
ùx
,

38 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

40 
¶c_¡
 *
¡
;

41 
”r
 = 0;

42 ()
ùx
;

43 ()
af
;

45 ià(!
¡p
 || !
´m
)

46  
EINVAL
;

48 ià(*
¡p
)

52 ià(
´m
->
ch
 != 1) {

53 
	`w¬nšg
("¶c: oÆy mÚØsuµÜ‹d (ch=%u)\n", 
´m
->
ch
);

54  
ENOSYS
;

57 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

58 ià(!
¡
)

59  
ENOMEM
;

61 ià(!
	`¶c_š™
(&
¡
->
¶c
)) {

62 
”r
 = 
ENOMEM
;

63 
out
;

66 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

68 
out
:

69 ià(
”r
)

70 
	`mem_d”ef
(
¡
);

72 *
¡p
 = (
auft_dec_¡
 *)
¡
;

74  
”r
;

75 
	}
}

83 
	$decode
(
auft_dec_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

85 
¶c_¡
 *
¶c
 = (¶c_¡ *)
¡
;

87 ià(*
§mpc
)

88 
	`¶c_rx
(&
¶c
->¶c, 
§mpv
, ()*
§mpc
);

90 *
§mpc
 = 
	`¶c_flš
(&
¶c
->¶c, 
§mpv
, ()plc->sampc);

93 
	}
}

96 
auft
 
	g¶c
 = {

97 
LE_INIT
, "¶c", 
NULL
, NULL, 
upd©e
, 
decode


101 
	$moduË_š™
()

103 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
¶c
);

105 
	}
}

108 
	$moduË_şo£
()

110 
	`auft_uÄegi¡”
(&
¶c
);

112 
	}
}

115 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¶c
) = {

118 
moduË_š™
,

119 
moduË_şo£


	@baresip/modules/portaudio/portaudio.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<pÜudio.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

28 
	sau¤c_¡
 {

29 cÚ¡ 
au¤c
 *
	mas
;

30 
PaSŒ—m
 *
	m¡»am_rd
;

31 
au¤c_»ad_h
 *
	mrh
;

32 *
	m¬g
;

33 vŞ©
boŞ
 
	m»ady
;

34 
	mch
;

37 
	sau¶ay_¡
 {

38 cÚ¡ 
au¶ay
 *
	m­
;

39 
PaSŒ—m
 *
	m¡»am_wr
;

40 
au¶ay_wr™e_h
 *
	mwh
;

41 *
	m¬g
;

42 vŞ©
boŞ
 
	m»ady
;

43 
	mch
;

47 
au¤c
 *
	gau¤c
;

48 
au¶ay
 *
	gau¶ay
;

56 
	$»ad_ÿÎback
(cÚ¡ *
šputBufãr
, *
ouutBufãr
,

57 
äameCouÁ
,

58 cÚ¡ 
PaSŒ—mC®lbackTimeInfo
 *
timeInfo
,

59 
PaSŒ—mC®lbackFÏgs
 
¡©usFÏgs
, *
u£rD©a
)

61 
au¤c_¡
 *
¡
 = 
u£rD©a
;

62 
size_t
 
§mpc
;

64 ()
ouutBufãr
;

65 ()
timeInfo
;

66 ()
¡©usFÏgs
;

68 ià(!
¡
->
»ady
)

69  
·AbÜt
;

71 
§mpc
 = 
äameCouÁ
 * 
¡
->
ch
;

73 
¡
->
	`rh
(
šputBufãr
, 
§mpc
, st->
¬g
);

75  
·CÚtšue
;

76 
	}
}

79 
	$wr™e_ÿÎback
(cÚ¡ *
šputBufãr
, *
ouutBufãr
,

80 
äameCouÁ
,

81 cÚ¡ 
PaSŒ—mC®lbackTimeInfo
 *
timeInfo
,

82 
PaSŒ—mC®lbackFÏgs
 
¡©usFÏgs
, *
u£rD©a
)

84 
au¶ay_¡
 *
¡
 = 
u£rD©a
;

85 
size_t
 
§mpc
;

87 ()
šputBufãr
;

88 ()
timeInfo
;

89 ()
¡©usFÏgs
;

91 ià(!
¡
->
»ady
)

92  
·AbÜt
;

94 
§mpc
 = 
äameCouÁ
 * 
¡
->
ch
;

96 
¡
->
	`wh
(
ouutBufãr
, 
§mpc
, st->
¬g
);

98  
·CÚtšue
;

99 
	}
}

102 
PaSam¶eFÜm©
 
	$aufmt_to_·§m¶efÜm©
(
aufmt
 
fmt
)

104 
fmt
) {

106 
AUFMT_S16LE
:  
·IÁ16
;

107 
AUFMT_FLOAT
:  
·Flßt32
;

110 
	}
}

113 
	$»ad_¡»am_İ’
(
au¤c_¡
 *
¡
, cÚ¡ 
au¤c_´m
 *
´m
,

114 
ušt32_t
 
dev
)

116 
PaSŒ—mP¬am‘”s
 
´m_š
;

117 
PaE¼Ü
 
”r
;

118 
äames_³r_bufãr
 = 
´m
->
¤©e
 *…rm->
±ime
 / 1000;

120 
	`mem£t
(&
´m_š
, 0, (prm_in));

121 
´m_š
.
deviû
 = 
dev
;

122 
´m_š
.
chªÃlCouÁ
 = 
´m
->
ch
;

123 
´m_š
.
§m¶eFÜm©
 = 
	`aufmt_to_·§m¶efÜm©
(
´m
->
fmt
);

124 
´m_š
.
sugge¡edL©’cy
 = 0.100;

126 
¡
->
¡»am_rd
 = 
NULL
;

127 
”r
 = 
	`Pa_O³nSŒ—m
(&
¡
->
¡»am_rd
, &
´m_š
, 
NULL
, 
´m
->
¤©e
,

128 
äames_³r_bufãr
, 
·NoFÏg
, 
»ad_ÿÎback
, 
¡
);

129 ià(
·NoE¼Ü
 !ğ
”r
) {

130 
	`w¬nšg
("portaudio:„ead: Pa_OpenStream: %s\n",

131 
	`Pa_G‘E¼ÜText
(
”r
));

132  
EINVAL
;

135 
”r
 = 
	`Pa_S¹SŒ—m
(
¡
->
¡»am_rd
);

136 ià(
·NoE¼Ü
 !ğ
”r
) {

137 
	`w¬nšg
("portaudio:„ead: Pa_StartStream: %s\n",

138 
	`Pa_G‘E¼ÜText
(
”r
));

139  
EINVAL
;

143 
	}
}

146 
	$wr™e_¡»am_İ’
(
au¶ay_¡
 *
¡
,

147 cÚ¡ 
au¶ay_´m
 *
´m
, 
ušt32_t
 
dev
)

149 
PaSŒ—mP¬am‘”s
 
´m_out
;

150 
PaE¼Ü
 
”r
;

151 
äames_³r_bufãr
 = 
´m
->
¤©e
 *…rm->
±ime
 / 1000;

153 
	`mem£t
(&
´m_out
, 0, (prm_out));

154 
´m_out
.
deviû
 = 
dev
;

155 
´m_out
.
chªÃlCouÁ
 = 
´m
->
ch
;

156 
´m_out
.
§m¶eFÜm©
 = 
	`aufmt_to_·§m¶efÜm©
(
´m
->
fmt
);

157 
´m_out
.
sugge¡edL©’cy
 = 0.100;

159 
¡
->
¡»am_wr
 = 
NULL
;

160 
”r
 = 
	`Pa_O³nSŒ—m
(&
¡
->
¡»am_wr
, 
NULL
, &
´m_out
, 
´m
->
¤©e
,

161 
äames_³r_bufãr
, 
·NoFÏg
, 
wr™e_ÿÎback
, 
¡
);

162 ià(
·NoE¼Ü
 !ğ
”r
) {

163 
	`w¬nšg
("portaudio: write: Pa_OpenStream: %s\n",

164 
	`Pa_G‘E¼ÜText
(
”r
));

165  
EINVAL
;

168 
”r
 = 
	`Pa_S¹SŒ—m
(
¡
->
¡»am_wr
);

169 ià(
·NoE¼Ü
 !ğ
”r
) {

170 
	`w¬nšg
("portaudio: write: Pa_StartStream: %s\n",

171 
	`Pa_G‘E¼ÜText
(
”r
));

172  
EINVAL
;

176 
	}
}

179 
	$au¤c_de¡ruùÜ
(*
¬g
)

181 
au¤c_¡
 *
¡
 = 
¬g
;

183 
¡
->
»ady
 = 
çl£
;

185 ià(
¡
->
¡»am_rd
) {

186 
	`Pa_AbÜtSŒ—m
(
¡
->
¡»am_rd
);

187 
	`Pa_Clo£SŒ—m
(
¡
->
¡»am_rd
);

189 
	}
}

192 
	$au¶ay_de¡ruùÜ
(*
¬g
)

194 
au¶ay_¡
 *
¡
 = 
¬g
;

196 
¡
->
»ady
 = 
çl£
;

198 ià(
¡
->
¡»am_wr
) {

199 
	`Pa_AbÜtSŒ—m
(
¡
->
¡»am_wr
);

200 
	`Pa_Clo£SŒ—m
(
¡
->
¡»am_wr
);

202 
	}
}

205 
	$¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

206 
medŸ_ùx
 **
ùx
,

207 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

208 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

210 
au¤c_¡
 *
¡
;

211 
PaDeviûIndex
 
dev_šdex
;

212 
”r
;

214 ()
ùx
;

215 ()
deviû
;

216 ()
”rh
;

218 ià(!
¡p
 || !
as
 || !
´m
)

219  
EINVAL
;

221 ià(
	`¡r_is£t
(
deviû
))

222 
dev_šdex
 = 
	`©oi
(
deviû
);

224 
dev_šdex
 = 
	`Pa_G‘DeçuÉIÅutDeviû
();

226 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

227 ià(!
¡
)

228  
ENOMEM
;

230 
¡
->
as
 =‡s;

231 
¡
->
rh
 =„h;

232 
¡
->
¬g
 =‡rg;

233 
¡
->
ch
 = 
´m
->ch;

235 
¡
->
»ady
 = 
Œue
;

237 
”r
 = 
	`»ad_¡»am_İ’
(
¡
, 
´m
, 
dev_šdex
);

238 ià(
”r
)

239 
out
;

241 
out
:

242 ià(
”r
)

243 
	`mem_d”ef
(
¡
);

245 *
¡p
 = 
¡
;

247  
”r
;

248 
	}
}

251 
	$¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

252 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

253 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

255 
au¶ay_¡
 *
¡
;

256 
PaDeviûIndex
 
dev_šdex
;

257 
”r
;

259 ()
deviû
;

261 ià(!
¡p
 || !
­
 || !
´m
)

262  
EINVAL
;

264 ià(
	`¡r_is£t
(
deviû
))

265 
dev_šdex
 = 
	`©oi
(
deviû
);

267 
dev_šdex
 = 
	`Pa_G‘DeçuÉOuutDeviû
();

269 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

270 ià(!
¡
)

271  
ENOMEM
;

273 
¡
->
­
 =‡p;

274 
¡
->
wh
 = wh;

275 
¡
->
¬g
 =‡rg;

276 
¡
->
ch
 = 
´m
->ch;

278 
¡
->
»ady
 = 
Œue
;

280 
”r
 = 
	`wr™e_¡»am_İ’
(
¡
, 
´m
, 
dev_šdex
);

281 ià(
”r
)

282 
out
;

284 
out
:

285 ià(
”r
)

286 
	`mem_d”ef
(
¡
);

288 *
¡p
 = 
¡
;

290  
”r
;

291 
	}
}

294 
	$·_š™
()

296 
PaE¼Ü
 
·”r
;

297 
i
, 
n
, 
”r
 = 0;

299 
·”r
 = 
	`Pa_In™Ÿlize
();

300 ià(
·NoE¼Ü
 !ğ
·”r
) {

301 
	`w¬nšg
("pÜudio: in™: %s\n", 
	`Pa_G‘E¼ÜText
(
·”r
));

302  
ENODEV
;

305 
n
 = 
	`Pa_G‘DeviûCouÁ
();

307 
	`šfo
("pÜudio: deviû couÁ i %d\n", 
n
);

309 
i
=0; i<
n
; i++) {

310 cÚ¡ 
PaDeviûInfo
 *
devšfo
;

312 
devšfo
 = 
	`Pa_G‘DeviûInfo
(
i
);

314 
	`debug
("pÜudio: deviû %d: %s\n", 
i
, 
devšfo
->
Çme
);

315 ()
devšfo
;

318 ià(
·NoDeviû
 !ğ
	`Pa_G‘DeçuÉIÅutDeviû
())

319 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

320 "pÜudio", 
¤c_®loc
);

322 ià(
·NoDeviû
 !ğ
	`Pa_G‘DeçuÉOuutDeviû
())

323 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

324 "pÜudio", 
¶ay_®loc
);

326  
”r
;

327 
	}
}

330 
	$·_şo£
()

332 
au¤c
 = 
	`mem_d”ef
(ausrc);

333 
au¶ay
 = 
	`mem_d”ef
(auplay);

335 
	`Pa_T”mš©e
();

338 
	}
}

341 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
pÜudio
) = {

344 
·_š™
,

345 
·_şo£


	@baresip/modules/presence/notifier.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"´e£nû.h
"

18 
	snÙif›r
 {

19 
Ë
 
	mË
;

20 
snÙ
 *
	mnÙ
;

21 
ua
 *
	mua
;

24 
li¡
 
	gnÙif›¾
;

27 cÚ¡ *
	$´e£nû_¡©us_¡r
(
´e£nû_¡©us
 
¡
)

29 
¡
) {

31 
PRESENCE_OPEN
:  "open";

32 
PRESENCE_CLOSED
:  "closed";

35 
	}
}

38 
	$nÙify
(
nÙif›r
 *
nÙ
, 
´e£nû_¡©us
 
¡©us
)

40 cÚ¡ *
aÜ
 = 
	`ua_aÜ
(
nÙ
->
ua
);

41 
mbuf
 *
mb
;

42 
”r
;

44 
mb
 = 
	`mbuf_®loc
(1024);

45 ià(!
mb
)

46  
ENOMEM
;

48 
”r
 = 
	`mbuf_´štf
(
mb
,

62 ,
aÜ
, 
	`´e£nû_¡©us_¡r
(
¡©us
),‡or);

63 ià(
”r
)

64 
out
;

66 
mb
->
pos
 = 0;

68 
”r
 = 
	`sev’t_nÙify
(
nÙ
->nÙ, 
mb
, 
SIPEVENT_ACTIVE
, 0, 0);

69 ià(
”r
) {

70 
	`w¬nšg
("´e£nû:‚ÙifyØ% çed (%m)\n", 
aÜ
, 
”r
);

73 
out
:

74 
	`mem_d”ef
(
mb
);

75  
”r
;

76 
	}
}

79 
	$snÙ_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

80 *
¬g
)

82 
nÙif›r
 *
nÙ
 = 
¬g
;

84 ià(
”r
) {

85 
	`šfo
("´e£nû:‚Ùif›¸şo£d (%m)\n", 
”r
);

87 ià(
msg
) {

88 
	`šfo
("presence:‚otifier closed (%u %r)\n",

89 
msg
->
scode
, &msg->
»asÚ
);

92 
	`mem_d”ef
(
nÙ
);

93 
	}
}

96 
	$de¡ruùÜ
(*
¬g
)

98 
nÙif›r
 *
nÙ
 = 
¬g
;

100 
	`li¡_uÆšk
(&
nÙ
->
Ë
);

101 
	`mem_d”ef
(
nÙ
->not);

102 
	`mem_d”ef
(
nÙ
->
ua
);

103 
	}
}

106 
	$auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

107 cÚ¡ *
»®m
, *
¬g
)

109  
	`accouÁ_auth
(
¬g
, 
u£ºame
, 
·sswÜd
, 
»®m
);

110 
	}
}

113 
	$nÙif›r_®loc
(
nÙif›r
 **
nÙp
,

114 cÚ¡ 
s_msg
 *
msg
,

115 cÚ¡ 
sev’t_ev’t
 *
£
, 
ua
 *ua)

117 
nÙif›r
 *
nÙ
;

118 
”r
;

120 ià(!
msg
 || !
£
)

121  
EINVAL
;

123 
nÙ
 = 
	`mem_z®loc
((*nÙ), 
de¡ruùÜ
);

124 ià(!
nÙ
)

125  
ENOMEM
;

127 
nÙ
->
ua
 = 
	`mem_»f
(ua);

129 
”r
 = 
	`sev’t_acû±
(&
nÙ
->nÙ, 
	`uag_sev’t_sock
(),

130 
msg
, 
NULL
, 
£
, 200, "OK",

132 
	`ua_cu£r
(
nÙ
->
ua
), "application/pidf+xml",

133 
auth_hªdËr
, 
	`ua_accouÁ
(
nÙ
->
ua
), 
Œue
,

134 
snÙ_şo£_hªdËr
, 
nÙ
, 
NULL
);

135 ià(
”r
) {

136 
	`w¬nšg
("´e£nû: sev’t_acû± faed: %m\n", 
”r
);

137 
out
;

140 
	`li¡_­³nd
(&
nÙif›¾
, &
nÙ
->
Ë
,‚ot);

142 
out
:

143 ià(
”r
)

144 
	`mem_d”ef
(
nÙ
);

145 ià(
nÙp
)

146 *
nÙp
 = 
nÙ
;

148  
”r
;

149 
	}
}

152 
	$nÙif›r_add
(cÚ¡ 
s_msg
 *
msg
, 
ua
 *ua)

154 cÚ¡ 
s_hdr
 *
hdr
;

155 
sev’t_ev’t
 
£
;

156 
nÙif›r
 *
nÙ
;

157 
”r
;

159 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_EVENT
);

160 ià(!
hdr
)

161  
EPROTO
;

163 
”r
 = 
	`sev’t_ev’t_decode
(&
£
, &
hdr
->
v®
);

164 ià(
”r
)

165  
”r
;

167 ià(
	`¶_¡rÿ£cmp
(&
£
.
ev’t
, "presence")) {

168 
	`šfo
("´e£nû: uÃx³ùedƒv’ˆ'%r'\n", &
£
.
ev’t
);

169  
EPROTO
;

172 
”r
 = 
	`nÙif›r_®loc
(&
nÙ
, 
msg
, &
£
, 
ua
);

173 ià(
”r
)

174  
”r
;

176 ()
	`nÙify
(
nÙ
, 
	`ua_´e£nû_¡©us
(
ua
));

179 
	}
}

182 
	$nÙif›r_upd©e_¡©us
(
ua
 *ua)

184 
Ë
 *le;

186 
Ë
 = 
nÙif›¾
.
h—d
;†e;†ğË->
Ãxt
) {

188 
nÙif›r
 *
nÙ
 = 
Ë
->
d©a
;

190 ià(
nÙ
->
ua
 == ua)

191 ()
	`nÙify
(
nÙ
, 
	`ua_´e£nû_¡©us
ÒÙ->
ua
));

193 
	}
}

196 
boŞ
 
	$sub_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

198 
ua
 *u¨ğ
¬g
;

200 ià(
	`nÙif›r_add
(
msg
, 
ua
))

201 ()
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
, 400, "Bad Presence");

203  
Œue
;

204 
	}
}

207 
	$nÙif›r_š™
()

209 
	`uag_£t_sub_hªdËr
(
sub_hªdËr
);

212 
	}
}

215 
	$nÙif›r_şo£
()

217 
	`li¡_æush
(&
nÙif›¾
);

218 
	`uag_£t_sub_hªdËr
(
NULL
);

219 
	}
}

	@baresip/modules/presence/presence.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"´e£nû.h
"

11 
	$¡©us_upd©e
(
ua
 *
cu¼’t_ua
,

12 cÚ¡ 
´e£nû_¡©us
 
Ãw_¡©us
)

14 ià(
	`ua_´e£nû_¡©us
(
cu¼’t_ua
è=ğ
Ãw_¡©us
)

17 
	`šfo
("presence: update status of '%s' from '%s'o '%s'\n",

18 
	`ua_aÜ
(
cu¼’t_ua
),

19 
	`cÚù_´e£nû_¡r
(
	`ua_´e£nû_¡©us
(
cu¼’t_ua
)),

20 
	`cÚù_´e£nû_¡r
(
Ãw_¡©us
));

22 
	`ua_´e£nû_¡©us_£t
(
cu¼’t_ua
, 
Ãw_¡©us
);

24 
	`publish”_upd©e_¡©us
(
cu¼’t_ua
);

25 
	`nÙif›r_upd©e_¡©us
(
cu¼’t_ua
);

28 
	}
}

31 
	$cmd_Úlše
(
»_´štf
 *
pf
, *
¬g
)

33 ()
pf
;

34 ()
¬g
;

36  
	`¡©us_upd©e
(
	`uag_cu¼’t
(), 
PRESENCE_OPEN
);

37 
	}
}

40 
	$cmd_ofæše
(
»_´štf
 *
pf
, *
¬g
)

42 ()
pf
;

43 ()
¬g
;

45  
	`¡©us_upd©e
(
	`uag_cu¼’t
(), 
PRESENCE_CLOSED
);

46 
	}
}

49 cÚ¡ 
cmd
 
	gcmdv
[] = {

50 {"´e£nû_Úlše", '[', 0, "S‘…»£nû oÆše", 
cmd_Úlše
 },

51 {"´e£nû_ofæše", ']', 0, "S‘…»£nû ofæše", 
cmd_ofæše
 },

55 
	$ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

56 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

58 ()
ÿÎ
;

59 ()
´m
;

60 ()
¬g
;

62 
	`debug
("´e£nû: ua=%°gÙƒv’ˆ%d (%s)\n", 
ua
, 
ev
,

63 
	`uag_ev’t_¡r
(
ev
));

65 ià(
ev
 =ğ
UA_EVENT_SHUTDOWN
) {

67 
	`publish”_şo£
();

68 
	`nÙif›r_şo£
();

69 
	`subsüib”_şo£_®l
();

71 
	}
}

74 
	$moduË_š™
()

76 
”r
;

78 
”r
 = 
	`subsüib”_š™
();

79 ià(
”r
)

80  
”r
;

82 
”r
 = 
	`publish”_š™
();

83 ià(
”r
)

84  
”r
;

86 
”r
 = 
	`nÙif›r_š™
();

87 ià(
”r
)

88  
”r
;

90 
”r
 = 
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

91 ià(
”r
)

92  
”r
;

94 
”r
 = 
	`uag_ev’t_»gi¡”
(
ev’t_hªdËr
, 
NULL
);

95 ià(
”r
)

96  
”r
;

98  
”r
;

99 
	}
}

102 
	$moduË_şo£
()

104 
	`uag_ev’t_uÄegi¡”
(
ev’t_hªdËr
);

106 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

108 
	`publish”_şo£
();

110 
	`nÙif›r_şo£
();

112 
	`subsüib”_şo£
();

115 
	}
}

118 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
´e£nû
) = {

121 
moduË_š™
,

122 
moduË_şo£


	@baresip/modules/presence/presence.h

7 
subsüib”_š™
();

8 
subsüib”_şo£
();

9 
subsüib”_şo£_®l
();

12 
nÙif›r_š™
();

13 
nÙif›r_şo£
();

14 
nÙif›r_upd©e_¡©us
(
ua
 *ua);

17 
publish”_š™
();

18 
publish”_şo£
();

19 
publish”_upd©e_¡©us
(
ua
 *ua);

	@baresip/modules/presence/publisher.c

8 
	~<¡ršg.h
>

9 
	~<».h
>

10 
	~<b¬es.h
>

11 
	~"´e£nû.h
"

14 
	spublish”
 {

15 
Ë
 
	mË
;

16 
tmr
 
	mtmr
;

17 
	mçc
;

18 *
	m‘ag
;

19 
	mexpœes
;

20 
	m»äesh
;

21 
ua
 *
	mua
;

24 
li¡
 
	gpubl
 = 
LIST_INIT
;

26 
tmr_hªdËr
(*
¬g
);

27 
publish
(
publish”
 *
pub
);

30 
	$»¥Ú£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

32 
publish”
 *
pub
 = 
¬g
;

33 cÚ¡ 
s_hdr
 *
‘ag_hdr
;

35 ià(
”r
)

38 ià(
msg
->
scode
 < 200) {

42 ià(
msg
->
scode
 < 300) {

44 ià(
pub
->
expœes
 == 0)

47 
‘ag_hdr
 = 
	`s_msg_xhdr
(
msg
, "SIP-ETag");

48 ià(
‘ag_hdr
) {

49 
	`mem_d”ef
(
pub
->
‘ag
);

50 
	`¶_¡rdup
(&(
pub
->
‘ag
), &(
‘ag_hdr
->
v®
));

51 
pub
->
»äesh
 = 1;

52 
	`tmr_¡¬t
(&
pub
->
tmr
,…ub->
expœes
 * 900,

53 
tmr_hªdËr
, 
pub
);

56 
	`w¬nšg
("%s:…ublisher got 200 OK withoutƒtag\n",

57 
	`ua_aÜ
(
pub
->
ua
));

60 ià(
msg
->
scode
 == 412) {

62 
	`mem_d”ef
(
pub
->
‘ag
);

63 
pub
->
‘ag
 = 
NULL
;

64 
pub
->
»äesh
 = 0;

65 
	`publish
(
pub
);

69 
	`w¬nšg
("%s:…ublisher gotƒrror„esponse %u %r\n",

70 
	`ua_aÜ
(
pub
->
ua
), 
msg
->
scode
, &msg->
»asÚ
);

74 
	}
}

78 cÚ¡ *
	$´e£nû_¡©us_¡r
(
´e£nû_¡©us
 
¡
)

80 
¡
) {

82 
PRESENCE_OPEN
:  "open";

83 
PRESENCE_CLOSED
:  "closed";

84 
PRESENCE_UNKNOWN
:  "unknown";

87 
	}
}

90 
	$publish
(
publish”
 *
pub
)

92 
”r
;

93 cÚ¡ *
aÜ
 = 
	`ua_aÜ
(
pub
->
ua
);

94 
mbuf
 *
mb
;

96 
mb
 = 
	`mbuf_®loc
(1024);

97 ià(!
mb
)

98  
ENOMEM
;

100 ià(
pub
->
expœes
 && !pub->
»äesh
)

101 
”r
 = 
	`mbuf_´štf
(
mb
,

115 ,
aÜ
,

116 
	`´e£nû_¡©us_¡r
(
	`ua_´e£nû_¡©us
(
pub
->
ua
)), 
aÜ
);

118 
”r
 = 
	`mbuf_´štf
(
mb
, "");

119 ià(
”r
)

120 
out
;

122 
mb
->
pos
 = 0;

126 ià(
pub
->
‘ag
)

127 
”r
 = 
	`s_»q_£nd
(
pub
->
ua
, "PUBLISH", 
aÜ
,

128 
pub
->
expœes
 ? 
»¥Ú£_hªdËr
 : 
NULL
,

129 
pub
,

137 
pub
->
expœes


141 
pub
->
expœes
,

142 
pub
->
‘ag
,

143 
	`mbuf_g‘_Ëá
(
mb
),

144 
	`mbuf_buf
(
mb
),

145 
	`mbuf_g‘_Ëá
(
mb
));

147 
”r
 = 
	`s_»q_£nd
(
pub
->
ua
, "PUBLISH", 
aÜ
,

148 
pub
->
expœes
 ? 
»¥Ú£_hªdËr
 : 
NULL
,

149 
pub
,

156 
pub
->
expœes


159 
pub
->
expœes
,

160 
	`mbuf_g‘_Ëá
(
mb
),

161 
	`mbuf_buf
(
mb
),

162 
	`mbuf_g‘_Ëá
(
mb
));

163 ià(
”r
) {

164 
	`w¬nšg
("publish”: s’d PUBLISH: (%m)\n", 
”r
);

167 
out
:

168 
	`mem_d”ef
(
mb
);

170  
”r
;

171 
	}
}

175 
ušt32_t
 
	$wa™_ç
(
çc
)

177 
çc
) {

184 
	}
}

187 
	$tmr_hªdËr
(*
¬g
)

189 
publish”
 *
pub
 = 
¬g
;

191 ià(
	`publish
(
pub
))

192 
	`tmr_¡¬t
(&
pub
->
tmr
, 
	`wa™_ç
(++pub->
çc
) * 1000,

193 
tmr_hªdËr
, 
pub
);

195 
pub
->
çc
 = 0;

196 
	}
}

199 
	$de¡ruùÜ
(*
¬g
)

201 
publish”
 *
pub
 = 
¬g
;

203 
	`li¡_uÆšk
(&
pub
->
Ë
);

204 
	`tmr_ÿnûl
(&
pub
->
tmr
);

205 
	`mem_d”ef
(
pub
->
ua
);

206 
	`mem_d”ef
(
pub
->
‘ag
);

207 
	}
}

210 
	$publish”_upd©e_¡©us
(
ua
 *ua)

212 
Ë
 *le;

214 
Ë
 = 
publ
.
h—d
;†e;†ğË->
Ãxt
) {

216 
publish”
 *
pub
 = 
Ë
->
d©a
;

218 ià(
pub
->
ua
 == ua) {

219 
pub
->
»äesh
 = 0;

220 
	`publish
(
pub
);

223 
	}
}

226 
	$publish”_®loc
(
ua
 *ua)

228 
publish”
 *
pub
;

230 
pub
 = 
	`mem_z®loc
((*pub), 
de¡ruùÜ
);

231 ià(!
pub
)

232  
ENOMEM
;

234 
pub
->
ua
 = 
	`mem_»f
(ua);

235 
pub
->
expœes
 = 
	`accouÁ_pubšt
(
	`ua_accouÁ
(
ua
));

237 
	`tmr_š™
(&
pub
->
tmr
);

238 
	`tmr_¡¬t
(&
pub
->
tmr
, 10, 
tmr_hªdËr
,…ub);

240 
	`li¡_­³nd
(&
publ
, &
pub
->
Ë
,…ub);

243 
	}
}

246 
	$pub_ua_ev’t_hªdËr
(
ua
 *ua,

247 
ua_ev’t
 
ev
,

248 
ÿÎ
 *call,

249 cÚ¡ *
´m
,

250 *
¬g
 )

252 ()
ÿÎ
;

253 ()
´m
;

254 ()
¬g
;

256 ià(
	`accouÁ_pubšt
(
	`ua_accouÁ
(
ua
)) == 0)

259 ià(
ev
 =ğ
UA_EVENT_REGISTER_OK
) {

260 ià(
	`ua_´e£nû_¡©us
(
ua
è=ğ
PRESENCE_UNKNOWN
) {

261 
	`ua_´e£nû_¡©us_£t
(
ua
, 
PRESENCE_OPEN
);

262 
	`publish”_upd©e_¡©us
(
ua
);

265 
	}
}

268 
	$publish”_š™
()

270 
Ë
 *le;

271 
”r
 = 0;

273 
	`uag_ev’t_»gi¡”
(
pub_ua_ev’t_hªdËr
, 
NULL
);

275 
Ë
 = 
	`li¡_h—d
(
	`uag_li¡
());†e;†ğË->
Ãxt
) {

277 
ua
 *u¨ğ
Ë
->
d©a
;

278 
accouÁ
 *
acc
 = 
	`ua_accouÁ
(
ua
);

280 ià(
	`accouÁ_pubšt
(
acc
) == 0)

283 
”r
 |ğ
	`publish”_®loc
(
ua
);

286 ià(
”r
)

287  
”r
;

290 
	}
}

293 
	$publish”_şo£
()

295 
Ë
 *le;

297 
	`uag_ev’t_uÄegi¡”
(
pub_ua_ev’t_hªdËr
);

299 
Ë
 = 
	`li¡_h—d
(&
publ
);†e;†ğË->
Ãxt
) {

301 
publish”
 *
pub
 = 
Ë
->
d©a
;

303 
	`ua_´e£nû_¡©us_£t
(
pub
->
ua
, 
PRESENCE_CLOSED
);

304 
pub
->
expœes
 = 0;

305 
	`publish
(
pub
);

308 
	`li¡_æush
(&
publ
);

309 
	}
}

	@baresip/modules/presence/subscriber.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"´e£nû.h
"

22 
	mSHUTDOWN_DELAY
 = 500

26 
	s´e£nû
 {

27 
Ë
 
	mË
;

28 
ssub
 *
	msub
;

29 
tmr
 
	mtmr
;

30 
´e£nû_¡©us
 
	m¡©us
;

31 
	mçc
;

32 
cÚù
 *
	mcÚù
;

33 
ua
 *
	mua
;

34 
boŞ
 
	mshutdown
;

37 
li¡
 
	g´e£nûl
;

40 
tmr_hªdËr
(*
¬g
);

43 
ušt32_t
 
	$wa™_‹rm
(cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
)

45 
ušt32_t
 
wa™
;

47 
sub¡©e
->
»asÚ
) {

49 
SIPEVENT_DEACTIVATED
:

50 
SIPEVENT_TIMEOUT
:

51 
wa™
 = 5;

54 
SIPEVENT_REJECTED
:

55 
SIPEVENT_NORESOURCE
:

56 
wa™
 = 3600;

59 
SIPEVENT_PROBATION
:

60 
SIPEVENT_GIVEUP
:

62 
wa™
 = 300;

63 ià(
	`¶_is£t
(&
sub¡©e
->
»Œy_aá”
))

64 
wa™
 = 
	`max
(wa™, 
	`¶_u32
(&
sub¡©e
->
»Œy_aá”
));

68  
wa™
;

69 
	}
}

72 
ušt32_t
 
	$wa™_ç
(
çc
)

74 
çc
) {

81 
	}
}

84 
	$nÙify_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

85 *
¬g
)

87 
´e£nû_¡©us
 
¡©us
 = 
PRESENCE_CLOSED
;

88 
´e£nû
 *
´es
 = 
¬g
;

89 cÚ¡ 
s_hdr
 *
ty³_hdr
, *
Ëngth_hdr
;

90 
¶
…l;

92 ià(
´es
->
shutdown
)

93 
dÚe
;

95 
´es
->
çc
 = 0;

97 
ty³_hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTENT_TYPE
);

99 ià(!
ty³_hdr
) {

101 
Ëngth_hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTENT_LENGTH
);

102 ià(0 =ğ
	`¶_¡rcmp
(&
Ëngth_hdr
->
v®
, "0")) {

104 
¡©us
 = 
PRESENCE_UNKNOWN
;

105 
dÚe
;

109 ià(!
ty³_hdr
 ||

110 0 !ğ
	`¶_¡rÿ£cmp
(&
ty³_hdr
->
v®
, "application/pidf+xml")) {

112 ià(
ty³_hdr
)

113 
	`w¬nšg
("presence: unsupported content-type: '%r'\n",

114 &
ty³_hdr
->
v®
);

116 
	`s_Œ•lyf
(
NULL
, NULL, 
s
, 
msg
, 
çl£
,

124 ià(!
	`»_»gex
((cÚ¡ *)
	`mbuf_buf
(
msg
->
mb
), 
	`mbuf_g‘_Ëá
(msg->mb),

125 "<basic[ \t]*>[^<]+</basic[ \t]*>", 
NULL
, &
¶
, NULL)) {

126 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "open"))

127 
¡©us
 = 
PRESENCE_OPEN
;

130 ià(!
	`»_»gex
((cÚ¡ *)
	`mbuf_buf
(
msg
->
mb
), 
	`mbuf_g‘_Ëá
(msg->mb),

131 "<½id:away[ \t]*/>", 
NULL
)) {

133 
¡©us
 = 
PRESENCE_CLOSED
;

135 ià(!
	`»_»gex
((cÚ¡ *)
	`mbuf_buf
(
msg
->
mb
),

136 
	`mbuf_g‘_Ëá
(
msg
->
mb
),

137 "<½id:busy[ \t]*/>", 
NULL
)) {

139 
¡©us
 = 
PRESENCE_BUSY
;

141 ià(!
	`»_»gex
((cÚ¡ *)
	`mbuf_buf
(
msg
->
mb
),

142 
	`mbuf_g‘_Ëá
(
msg
->
mb
),

143 "<½id:Ú-the-phÚe[ \t]*/>", 
NULL
)) {

145 
¡©us
 = 
PRESENCE_BUSY
;

148 
dÚe
:

149 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 200, "OK");

151 
	`cÚù_£t_´e£nû
(
´es
->
cÚù
, 
¡©us
);

153 ià(
´es
->
shutdown
)

154 
	`mem_d”ef
(
´es
);

155 
	}
}

158 
	$şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

159 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
, *
¬g
)

161 
´e£nû
 *
´es
 = 
¬g
;

162 
ušt32_t
 
wa™
;

164 
´es
->
sub
 = 
	`mem_d”ef
(pres->sub);

166 
	`šfo
("presence: subscriber closed <%r>: ",

167 &
	`cÚù_addr
(
´es
->
cÚù
)->
auri
);

169 ià(
sub¡©e
) {

170 
	`šfo
("%s", 
	`sev’t_»asÚ_Çme
(
sub¡©e
->
»asÚ
));

171 
wa™
 = 
	`wa™_‹rm
(
sub¡©e
);

173 ià(
msg
) {

174 
	`šfo
("%u %r", 
msg
->
scode
, &msg->
»asÚ
);

175 
wa™
 = 
	`wa™_ç
(++
´es
->
çc
);

178 
	`šfo
("%m", 
”r
);

179 
wa™
 = 
	`wa™_ç
(++
´es
->
çc
);

182 
	`šfo
("; wÈ»Œy iÀ%u sec (çc=%u)\n", 
wa™
, 
´es
->
çc
);

184 
	`tmr_¡¬t
(&
´es
->
tmr
, 
wa™
 * 1000, 
tmr_hªdËr
,…res);

186 
	`cÚù_£t_´e£nû
(
´es
->
cÚù
, 
PRESENCE_UNKNOWN
);

187 
	}
}

190 
	$de¡ruùÜ
(*
¬g
)

192 
´e£nû
 *
´es
 = 
¬g
;

194 
	`debug
("presence: subscriber destroyed\n");

196 
	`li¡_uÆšk
(&
´es
->
Ë
);

197 
	`tmr_ÿnûl
(&
´es
->
tmr
);

198 
	`mem_d”ef
(
´es
->
cÚù
);

199 
	`mem_d”ef
(
´es
->
sub
);

200 
	`mem_d”ef
(
´es
->
ua
);

201 
	}
}

204 
	$d”ef_hªdËr
(*
¬g
)

206 
´e£nû
 *
´es
 = 
¬g
;

207 
	`mem_d”ef
(
´es
);

208 
	}
}

211 
	$auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

212 cÚ¡ *
»®m
, *
¬g
)

214  
	`accouÁ_auth
(
¬g
, 
u£ºame
, 
·sswÜd
, 
»®m
);

215 
	}
}

218 
	$subsüibe
(
´e£nû
 *
´es
)

220 cÚ¡ *
rou‹v
[1];

221 
ua
 *ua;

222 
uri
[256];

223 
”r
;

226 
ua
 = 
	`uag_fšd_aÜ
(
NULL
);

227 ià(!
ua
) {

228 
	`w¬nšg
("presence:‚o UA found\n");

229  
ENOENT
;

232 
	`mem_d”ef
(
´es
->
ua
);

233 
´es
->
ua
 = 
	`mem_»f
(ua);

235 
	`¶_¡rıy
(&
	`cÚù_addr
(
´es
->
cÚù
)->
auri
, 
uri
, (uri));

237 
rou‹v
[0] = 
	`ua_outbound
(
ua
);

239 
”r
 = 
	`sev’t_subsüibe
(&
´es
->
sub
, 
	`uag_sev’t_sock
(), 
uri
, 
NULL
,

240 
	`ua_aÜ
(
ua
), "´e£nû", 
NULL
, 600,

241 
	`ua_cu£r
(
ua
), 
rou‹v
,„outev[0] ? 1 : 0,

242 
auth_hªdËr
, 
	`ua_accouÁ
(
ua
), 
Œue
, 
NULL
,

243 
nÙify_hªdËr
, 
şo£_hªdËr
, 
´es
,

244 "%H", 
ua_´št_suµÜ‹d
, 
ua
);

245 ià(
”r
) {

246 
	`w¬nšg
("´e£nû: sev’t_subsüibçed: %m\n", 
”r
);

249  
”r
;

250 
	}
}

253 
	$tmr_hªdËr
(*
¬g
)

255 
´e£nû
 *
´es
 = 
¬g
;

257 ià(
	`subsüibe
(
´es
)) {

258 
	`tmr_¡¬t
(&
´es
->
tmr
, 
	`wa™_ç
(++´es->
çc
) * 1000,

259 
tmr_hªdËr
, 
´es
);

261 
	}
}

264 
	$´e£nû_®loc
(
cÚù
 *contact)

266 
´e£nû
 *
´es
;

268 
´es
 = 
	`mem_z®loc
((*´es), 
de¡ruùÜ
);

269 ià(!
´es
)

270  
ENOMEM
;

272 
´es
->
¡©us
 = 
PRESENCE_UNKNOWN
;

273 
´es
->
cÚù
 = 
	`mem_»f
(contact);

275 
	`tmr_š™
(&
´es
->
tmr
);

276 
	`tmr_¡¬t
(&
´es
->
tmr
, 1000, 
tmr_hªdËr
,…res);

278 
	`li¡_­³nd
(&
´e£nûl
, &
´es
->
Ë
,…res);

281 
	}
}

284 
	$cÚù_hªdËr
(
cÚù
 *contact,

285 
boŞ
 
»moved
, *
¬g
)

287 
Ë
 *le;

288 
¶
 
v®
;

289 
´e£nû
 *
´es
 = 
NULL
;

290 
s_addr
 *
addr
 = 
	`cÚù_addr
(
cÚù
);

291 ()
¬g
;

293 ià(0 =ğ
	`msg_·¿m_decode
(&
addr
->
·¿ms
, "´e£nû", &
v®
) &&

294 0 =ğ
	`¶_¡rÿ£cmp
(&
v®
, "p2p")) {

295 ià(!
»moved
) {

296 ià(
	`´e£nû_®loc
(
cÚù
) != 0) {

297 
	`w¬nšg
("presence:…resence_alloc failed\n");

303 
Ë
 = 
	`li¡_h—d
(&
´e£nûl
);†e;†ğË->
Ãxt
) {

304 
´es
 = (
´e£nû
*)
Ë
->
d©a
;

305 ià(
´es
->
cÚù
 == contact) {

308 
´es
 = 
NULL
;

311 ià(
´es
) {

312 
	`mem_d”ef
(
´es
);

315 
	`w¬nšg
("presence: No contacto„emove\n");

319 
	}
}

322 
	$subsüib”_š™
()

324 
cÚùs
 *cÚù ğ
	`b¬es_cÚùs
();

325 
Ë
 *le;

326 
”r
 = 0;

328 
Ë
 = 
	`li¡_h—d
(
	`cÚù_li¡
(
cÚùs
));†e;†ğË->
Ãxt
) {

330 
cÚù
 *
c
 = 
Ë
->
d©a
;

331 
s_addr
 *
addr
 = 
	`cÚù_addr
(
c
);

332 
¶
 
v®
;

334 ià(0 =ğ
	`msg_·¿m_decode
(&
addr
->
·¿ms
, "´e£nû", &
v®
) &&

335 0 =ğ
	`¶_¡rÿ£cmp
(&
v®
, "p2p")) {

337 
”r
 |ğ
	`´e£nû_®loc
(
Ë
->
d©a
);

341 
	`šfo
("SubsüibšgØ%u cÚùs\n", 
	`li¡_couÁ
(&
´e£nûl
));

343 
	`cÚù_£t_upd©e_hªdËr
(
cÚùs
, 
cÚù_hªdËr
, 
NULL
);

345  
”r
;

346 
	}
}

349 
	$subsüib”_şo£
()

351 
	`cÚù_£t_upd©e_hªdËr
(
	`b¬es_cÚùs
(), 
NULL
, NULL);

352 
	`li¡_æush
(&
´e£nûl
);

353 
	}
}

356 
	$subsüib”_şo£_®l
()

358 
Ë
 *le;

360 
	`šfo
("presence: subscriber: closing %u subs\n",

361 
	`li¡_couÁ
(&
´e£nûl
));

363 
	`cÚù_£t_upd©e_hªdËr
(
	`b¬es_cÚùs
(), 
NULL
, NULL);

365 
Ë
 = 
´e£nûl
.
h—d
;

366 
Ë
) {

368 
´e£nû
 *
´es
 = 
Ë
->
d©a
;

369 
Ë
 =†e->
Ãxt
;

371 
	`debug
("´e£nû: shutdown: sub=%p\n", 
´es
->
sub
);

373 
´es
->
shutdown
 = 
Œue
;

374 ià(
´es
->
sub
) {

375 
´es
->
sub
 = 
	`mem_d”ef
(pres->sub);

376 
	`tmr_¡¬t
(&
´es
->
tmr
, 
SHUTDOWN_DELAY
,

377 
d”ef_hªdËr
, 
´es
);

380 
	`mem_d”ef
(
´es
);

382 
	}
}

	@baresip/modules/pulse/player.c

6 
	~<pul£/pul£audio.h
>

7 
	~<pul£/sim¶e.h
>

8 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

12 
	~"pul£.h
"

15 
	sau¶ay_¡
 {

16 cÚ¡ 
au¶ay
 *
	m­
;

18 
·_sim¶e
 *
	ms
;

19 
±h»ad_t
 
	mth»ad
;

20 
boŞ
 
	mrun
;

21 *
	m§mpv
;

22 
size_t
 
	m§mpc
;

23 
size_t
 
	m§mpsz
;

24 
au¶ay_wr™e_h
 *
	mwh
;

25 *
	m¬g
;

29 
	$au¶ay_de¡ruùÜ
(*
¬g
)

31 
au¶ay_¡
 *
¡
 = 
¬g
;

34 ià(
¡
->
run
) {

35 
	`debug
("pulse: stopping…laybackhread\n");

36 
¡
->
run
 = 
çl£
;

37 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

40 ià(
¡
->
s
)

41 
	`·_sim¶e_ä“
(
¡
->
s
);

43 
	`mem_d”ef
(
¡
->
§mpv
);

44 
	}
}

47 *
	$wr™e_th»ad
(*
¬g
)

49 
au¶ay_¡
 *
¡
 = 
¬g
;

50 cÚ¡ 
size_t
 
num_by‹s
 = 
¡
->
§mpc
 * st->
§mpsz
;

51 
»t
, 
·_”rÜ
 = 0;

53 
¡
->
run
) {

55 
¡
->
	`wh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

57 
»t
 = 
	`·_sim¶e_wr™e
(
¡
->
s
, st->
§mpv
, 
num_by‹s
, &
·_”rÜ
);

58 ià(
»t
 < 0) {

59 
	`w¬nšg
("pulse:…a_simple_writeƒrror (%s)\n",

60 
	`·_¡»¼Ü
(
·_”rÜ
));

64  
NULL
;

65 
	}
}

68 
	$aufmt_to_pul£_fÜm©
(
aufmt
 
fmt
)

70 
fmt
) {

72 
AUFMT_S16LE
:  
PA_SAMPLE_S16NE
;

73 
AUFMT_FLOAT
:  
PA_SAMPLE_FLOAT32NE
;

76 
	}
}

79 
	$pul£_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

80 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

81 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

83 
au¶ay_¡
 *
¡
;

84 
·_§m¶e_¥ec
 
ss
;

85 
·_bufãr_©Œ
 
©Œ
;

86 
”r
 = 0, 
·_”rÜ
 = 0;

88 ià(!
¡p
 || !
­
 || !
´m
 || !
wh
)

89  
EINVAL
;

91 
	`debug
("pulse: opening…layer (%u Hz, %d channels, device '%s')\n",

92 
´m
->
¤©e
,…rm->
ch
, 
deviû
);

94 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

95 ià(!
¡
)

96  
ENOMEM
;

98 
¡
->
­
 =‡p;

99 
¡
->
wh
 = wh;

100 
¡
->
¬g
 =‡rg;

102 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

103 
¡
->
§mpsz
 = 
	`aufmt_§m¶e_size
(
´m
->
fmt
);

105 
¡
->
§mpv
 = 
	`mem_®loc
(¡->
§mpsz
 * st->
§mpc
, 
NULL
);

106 ià(!
¡
->
§mpv
) {

107 
”r
 = 
ENOMEM
;

108 
out
;

111 
ss
.
fÜm©
 = 
	`aufmt_to_pul£_fÜm©
(
´m
->
fmt
);

112 
ss
.
chªÃls
 = 
´m
->
ch
;

113 
ss
.
¿‹
 = 
´m
->
¤©e
;

115 
©Œ
.
maxËngth
 = (
ušt32_t
)-1;

116 
©Œ
.
’gth
 = (
ušt32_t
)
	`·_u£c_to_by‹s
(
´m
->
±ime
 * 1000, &
ss
);

117 
©Œ
.
´ebuf
 = (
ušt32_t
)-1;

118 
©Œ
.
mš»q
 = (
ušt32_t
)-1;

119 
©Œ
.
äagsize
 = (
ušt32_t
)-1;

121 
¡
->
s
 = 
	`·_sim¶e_Ãw
(
NULL
,

123 
PA_STREAM_PLAYBACK
,

124 
	`¡r_is£t
(
deviû
) ? device : 0,

126 &
ss
,

127 
NULL
,

128 &
©Œ
,

129 &
·_”rÜ
);

130 ià(!
¡
->
s
) {

131 
	`w¬nšg
("pulse: could‚ot connecto server (%s)\n",

132 
	`·_¡»¼Ü
(
·_”rÜ
));

133 
”r
 = 
ENODEV
;

134 
out
;

137 
¡
->
run
 = 
Œue
;

138 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
wr™e_th»ad
, st);

139 ià(
”r
) {

140 
¡
->
run
 = 
çl£
;

141 
out
;

144 
	`debug
("pulse:…layback started\n");

146 
out
:

147 ià(
”r
)

148 
	`mem_d”ef
(
¡
);

150 *
¡p
 = 
¡
;

152  
”r
;

153 
	}
}

	@baresip/modules/pulse/pulse.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"pul£.h
"

23 
au¶ay
 *
	gau¶ay
;

24 
au¤c
 *
	gau¤c
;

27 
	$moduË_š™
()

29 
”r
;

31 
”r
 = 
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

32 "pul£", 
pul£_¶ay”_®loc
);

33 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

34 "pul£", 
pul£_»cÜd”_®loc
);

36  
”r
;

37 
	}
}

40 
	$moduË_şo£
()

42 
au¶ay
 = 
	`mem_d”ef
(auplay);

43 
au¤c
 = 
	`mem_d”ef
(ausrc);

46 
	}
}

49 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
pul£
) = {

52 
moduË_š™
,

53 
moduË_şo£
,

	@baresip/modules/pulse/pulse.h

8 
pul£_¶ay”_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

9 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

10 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

11 
pul£_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

12 
medŸ_ùx
 **
ùx
,

13 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

14 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

	@baresip/modules/pulse/recorder.c

6 
	~<pul£/pul£audio.h
>

7 
	~<pul£/sim¶e.h
>

8 
	~<±h»ad.h
>

9 
	~<».h
>

10 
	~<»m.h
>

11 
	~<b¬es.h
>

12 
	~"pul£.h
"

15 
	sau¤c_¡
 {

16 cÚ¡ 
au¤c
 *
	mas
;

18 
·_sim¶e
 *
	ms
;

19 
±h»ad_t
 
	mth»ad
;

20 
boŞ
 
	mrun
;

21 *
	m§mpv
;

22 
size_t
 
	m§mpc
;

23 
size_t
 
	m§mpsz
;

24 
ušt32_t
 
	m±ime
;

25 
au¤c_»ad_h
 *
	mrh
;

26 *
	m¬g
;

30 
	$au¤c_de¡ruùÜ
(*
¬g
)

32 
au¤c_¡
 *
¡
 = 
¬g
;

35 ià(
¡
->
run
) {

36 
	`debug
("pulse: stopping„ecordhread\n");

37 
¡
->
run
 = 
çl£
;

38 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

41 ià(
¡
->
s
)

42 
	`·_sim¶e_ä“
(
¡
->
s
);

44 
	`mem_d”ef
(
¡
->
§mpv
);

45 
	}
}

48 *
	$»ad_th»ad
(*
¬g
)

50 
au¤c_¡
 *
¡
 = 
¬g
;

51 cÚ¡ 
size_t
 
num_by‹s
 = 
¡
->
§mpc
 * st->
§mpsz
;

52 
»t
, 
·_”rÜ
 = 0;

53 
ušt64_t
 
now
, 
Ï¡_»ad
, 
diff
;

54 
drİ³d
 = 0;

55 
boŞ
 
š™
 = 
Œue
;

57 ià(
	`·_sim¶e_æush
(
¡
->
s
, &
·_”rÜ
)) {

58 
	`w¬nšg
("pulse:…a_simple_flushƒrror (%s)\n",

59 
	`·_¡»¼Ü
(
·_”rÜ
));

62 
Ï¡_»ad
 = 
	`tmr_jiff›s
();

64 
¡
->
run
) {

66 
»t
 = 
	`·_sim¶e_»ad
(
¡
->
s
, st->
§mpv
, 
num_by‹s
, &
·_”rÜ
);

67 ià(
»t
 < 0) {

68 
	`w¬nšg
("pulse:…a_simple_writeƒrror (%s)\n",

69 
	`·_¡»¼Ü
(
·_”rÜ
));

75 ià(
š™
) {

76 
now
 = 
	`tmr_jiff›s
();

77 
diff
 = (
now
 > 
Ï¡_»ad
)?‚ow -†ast_read : 0;

79 ià(
diff
 < 
¡
->
±ime
 / 2) {

80 
Ï¡_»ad
 = 
now
;

81 ++
drİ³d
;

85 
š™
 = 
çl£
;

87 ià(
drİ³d
)

88 
	`debug
("pulse: dropped %u frames of "

90 "th»cÜdšg\n", 
drİ³d
);

94 
¡
->
	`rh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

97  
NULL
;

98 
	}
}

101 
	$aufmt_to_pul£_fÜm©
(
aufmt
 
fmt
)

103 
fmt
) {

105 
AUFMT_S16LE
:  
PA_SAMPLE_S16NE
;

106 
AUFMT_FLOAT
:  
PA_SAMPLE_FLOAT32NE
;

109 
	}
}

112 
	$pul£_»cÜd”_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

113 
medŸ_ùx
 **
ùx
,

114 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

115 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

117 
au¤c_¡
 *
¡
;

118 
·_§m¶e_¥ec
 
ss
;

119 
·_bufãr_©Œ
 
©Œ
;

120 
·_”rÜ
;

121 
”r
;

123 ()
ùx
;

124 ()
deviû
;

125 ()
”rh
;

127 ià(!
¡p
 || !
as
 || !
´m
)

128  
EINVAL
;

130 
	`debug
("pulse: opening„ecorder (%u Hz, %d channels, device '%s')\n",

131 
´m
->
¤©e
,…rm->
ch
, 
deviû
);

133 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

134 ià(!
¡
)

135  
ENOMEM
;

137 
¡
->
as
 =‡s;

138 
¡
->
rh
 =„h;

139 
¡
->
¬g
 =‡rg;

141 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

142 
¡
->
§mpsz
 = 
	`aufmt_§m¶e_size
(
´m
->
fmt
);

143 
¡
->
±ime
 = 
´m
->ptime;

145 
¡
->
§mpv
 = 
	`mem_®loc
(¡->
§mpsz
 * st->
§mpc
, 
NULL
);

146 ià(!
¡
->
§mpv
) {

147 
”r
 = 
ENOMEM
;

148 
out
;

151 
ss
.
fÜm©
 = 
	`aufmt_to_pul£_fÜm©
(
´m
->
fmt
);

152 
ss
.
chªÃls
 = 
´m
->
ch
;

153 
ss
.
¿‹
 = 
´m
->
¤©e
;

155 
©Œ
.
maxËngth
 = (
ušt32_t
)-1;

156 
©Œ
.
’gth
 = (
ušt32_t
)-1;

157 
©Œ
.
´ebuf
 = (
ušt32_t
)-1;

158 
©Œ
.
mš»q
 = (
ušt32_t
)-1;

159 
©Œ
.
äagsize
 = (
ušt32_t
)
	`·_u£c_to_by‹s
(
´m
->
±ime
 * 1000, &
ss
);

161 
¡
->
s
 = 
	`·_sim¶e_Ãw
(
NULL
,

163 
PA_STREAM_RECORD
,

164 
	`¡r_is£t
(
deviû
) ? device : 0,

166 &
ss
,

167 
NULL
,

168 &
©Œ
,

169 &
·_”rÜ
);

170 ià(!
¡
->
s
) {

171 
	`w¬nšg
("pulse: could‚ot connecto server (%s)\n",

172 
	`·_¡»¼Ü
(
·_”rÜ
));

173 
”r
 = 
ENODEV
;

174 
out
;

177 
¡
->
run
 = 
Œue
;

178 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

179 ià(
”r
) {

180 
¡
->
run
 = 
çl£
;

181 
out
;

184 
	`debug
("pulse:„ecording started\n");

186 
out
:

187 ià(
”r
)

188 
	`mem_d”ef
(
¡
);

190 *
¡p
 = 
¡
;

192  
”r
;

193 
	}
}

	@baresip/modules/rst/audio.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<±h»ad.h
>

9 
	~<fú.h
>

10 
	~<uni¡d.h
>

11 
	~<¡ršg.h
>

12 
	~<».h
>

13 
	~<»m.h
>

14 
	~<b¬es.h
>

15 
	~<mpg123.h
>

16 
	~"r¡.h
"

19 
	sau¤c_¡
 {

20 cÚ¡ 
au¤c
 *
	mas
;

21 
±h»ad_t
 
	mth»ad
;

22 
r¡
 *
	mr¡
;

23 
mpg123_hªdË
 *
	mmp3
;

24 
aubuf
 *
	maubuf
;

25 
au¤c_»ad_h
 *
	mrh
;

26 
au¤c_”rÜ_h
 *
	m”rh
;

27 *
	m¬g
;

28 
boŞ
 
	mrun
;

29 
ušt32_t
 
	m±ime
;

30 
size_t
 
	m§mpc
;

31 
size_t
 
	m§mpsz
;

35 
au¤c
 *
	gau¤c
;

38 
	$de¡ruùÜ
(*
¬g
)

40 
au¤c_¡
 *
¡
 = 
¬g
;

42 
	`r¡_£t_audio
(
¡
->
r¡
, 
NULL
);

43 
	`mem_d”ef
(
¡
->
r¡
);

45 ià(
¡
->
run
) {

46 
¡
->
run
 = 
çl£
;

47 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

50 ià(
¡
->
mp3
) {

51 
	`mpg123_şo£
(
¡
->
mp3
);

52 
	`mpg123_d–‘e
(
¡
->
mp3
);

55 
	`mem_d”ef
(
¡
->
aubuf
);

56 
	}
}

59 *
	$¶ay_th»ad
(*
¬g
)

61 
ušt64_t
 
now
, 
ts
 = 
	`tmr_jiff›s
();

62 
au¤c_¡
 *
¡
 = 
¬g
;

63 *
§mpv
;

64 
size_t
 
num_by‹s
 = 
¡
->
§mpc
 * st->
§mpsz
;

66 
§mpv
 = 
	`mem_®loc
(
num_by‹s
, 
NULL
);

67 ià(!
§mpv
)

68  
NULL
;

70 
¡
->
run
) {

72 
	`sys_m¦“p
(4);

74 
now
 = 
	`tmr_jiff›s
();

76 ià(
ts
 > 
now
)

79 ià(
now
 > 
ts
 + 100) {

80 
	`debug
("rst: cpu†agging behind (%u ms)\n",

81 
now
 - 
ts
);

85 
	`aubuf_»ad
(
¡
->
aubuf
, 
§mpv
, 
num_by‹s
);

87 
¡
->
	`rh
(
§mpv
, st->
§mpc
, st->
¬g
);

89 
ts
 +ğ
¡
->
±ime
;

92 
	`mem_d”ef
(
§mpv
);

94  
NULL
;

95 
	}
}

98 
šlše
 
	$decode
(
au¤c_¡
 *
¡
)

100 
”r
, 
ch
, 
’codšg
;

101 
mbuf
 *
mb
;

102 
¤©e
;

104 
mb
 = 
	`mbuf_®loc
(4096);

105 ià(!
mb
)

106  
ENOMEM
;

108 
”r
 = 
	`mpg123_»ad
(
¡
->
mp3
, 
mb
->
buf
, mb->
size
, &mb->
’d
);

110 
”r
) {

112 
MPG123_NEW_FORMAT
:

113 
	`mpg123_g‘fÜm©
(
¡
->
mp3
, &
¤©e
, &
ch
, &
’codšg
);

114 
	`šfo
("rst:‚ew format: %i hz, %i ch,ƒncoding 0x%04x\n",

115 
¤©e
, 
ch
, 
’codšg
);

118 
MPG123_OK
:

119 
MPG123_NEED_MORE
:

120 ià(
mb
->
’d
 == 0)

122 
	`aubuf_­³nd
(
¡
->
aubuf
, 
mb
);

126 
	`w¬nšg
("rst: mpg123_readƒrror: %s\n",

127 
	`mpg123_¶aš_¡»¼Ü
(
”r
));

131 
	`mem_d”ef
(
mb
);

133  
”r
;

134 
	}
}

137 
	$r¡_audio_ãed
(
au¤c_¡
 *
¡
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
)

139 
”r
;

141 ià(!
¡
)

144 
”r
 = 
	`mpg123_ãed
(
¡
->
mp3
, 
buf
, 
sz
);

145 ià(
”r
)

148 
MPG123_OK
 =ğ
	`decode
(
¡
))

150 
	}
}

153 
	$aufmt_to_’codšg
(
aufmt
 
fmt
)

155 
fmt
) {

157 
AUFMT_S16LE
:  
MPG123_ENC_SIGNED_16
;

158 
AUFMT_FLOAT
:  
MPG123_ENC_FLOAT_32
;

159 
AUFMT_S24_3LE
:  
MPG123_ENC_SIGNED_24
;

162 
	}
}

165 
	$®loc_hªdËr
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

166 
medŸ_ùx
 **
ùx
,

167 
au¤c_´m
 *
´m
, cÚ¡ *
dev
,

168 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

170 
au¤c_¡
 *
¡
;

171 
”r
;

173 ià(!
¡p
 || !
as
 || !
´m
 || !
rh
)

174  
EINVAL
;

176 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

177 ià(!
¡
)

178  
ENOMEM
;

180 
¡
->
as
 =‡s;

181 
¡
->
rh
 =„h;

182 
¡
->
”rh
 =ƒrrh;

183 
¡
->
¬g
 =‡rg;

185 
¡
->
mp3
 = 
	`mpg123_Ãw
(
NULL
, &
”r
);

186 ià(!
¡
->
mp3
) {

187 
”r
 = 
ENODEV
;

188 
out
;

191 
”r
 = 
	`mpg123_İ’_ãed
(
¡
->
mp3
);

192 ià(
”r
 !ğ
MPG123_OK
) {

193 
	`w¬nšg
("rst: mpg123_open_feed: %s\n",

194 
	`mpg123_¡»¼Ü
(
¡
->
mp3
));

195 
”r
 = 
ENODEV
;

196 
out
;

200 
	`mpg123_fÜm©_nÚe
(
¡
->
mp3
);

201 
	`mpg123_fÜm©
(
¡
->
mp3
, 
´m
->
¤©e
,…rm->
ch
,

202 
	`aufmt_to_’codšg
(
´m
->
fmt
));

203 
	`mpg123_vŞume
(
¡
->
mp3
, 0.3);

205 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

206 
¡
->
§mpsz
 = 
	`aufmt_§m¶e_size
(
´m
->
fmt
);

208 
¡
->
±ime
 = 
´m
->ptime;

210 
	`šfo
("rst:‡udio…time=%u sampc=%zu‡ubuf=[%u:%u]\n",

211 
¡
->
±ime
, st->
§mpc
,

212 
´m
->
¤©e
 *…rm->
ch
 * 2,

213 
´m
->
¤©e
 *…rm->
ch
 * 40);

216 
”r
 = 
	`aubuf_®loc
(&
¡
->
aubuf
,

217 
´m
->
¤©e
 *…rm->
ch
 * 
¡
->
§mpsz
,

218 
´m
->
¤©e
 *…rm->
ch
 * 
¡
->
§mpsz
 * 20);

219 ià(
”r
)

220 
out
;

222 ià(
ùx
 && *ùx && (*ùx)->
id
 && !
	`¡rcmp
((*ctx)->id, "rst")) {

223 
¡
->
r¡
 = 
	`mem_»f
(*
ùx
);

226 
”r
 = 
	`r¡_®loc
(&
¡
->
r¡
, 
dev
);

227 ià(
”r
)

228 
out
;

230 ià(
ùx
)

231 *
ùx
 = (
medŸ_ùx
 *)
¡
->
r¡
;

234 
	`r¡_£t_audio
(
¡
->
r¡
, st);

236 
¡
->
run
 = 
Œue
;

238 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
¶ay_th»ad
, st);

239 ià(
”r
) {

240 
¡
->
run
 = 
çl£
;

241 
out
;

244 
out
:

245 ià(
”r
)

246 
	`mem_d”ef
(
¡
);

248 *
¡p
 = 
¡
;

250  
”r
;

251 
	}
}

254 
	$r¡_audio_š™
()

256 
”r
;

258 
”r
 = 
	`mpg123_š™
();

259 ià(
”r
 !ğ
MPG123_OK
) {

260 
	`w¬nšg
("r¡: mpg123_š™: %s\n", 
	`mpg123_¶aš_¡»¼Ü
(
”r
));

261  
ENODEV
;

264  
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "r¡", 
®loc_hªdËr
);

265 
	}
}

268 
	$r¡_audio_şo£
()

270 
au¤c
 = 
	`mem_d”ef
(ausrc);

272 
	`mpg123_ex™
();

273 
	}
}

	@baresip/modules/rst/rst.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"r¡.h
"

31 
	mRETRY_WAIT
 = 10000,

35 
	sr¡
 {

36 cÚ¡ *
	mid
;

37 
au¤c_¡
 *
	mau¤c_¡
;

38 
vid¤c_¡
 *
	mvid¤c_¡
;

39 
tmr
 
	mtmr
;

40 
dns_qu”y
 *
	mdnsq
;

41 
tı_cÚn
 *
	mtc
;

42 
mbuf
 *
	mmb
;

43 *
	mho¡
;

44 *
	m·th
;

45 *
	mÇme
;

46 *
	mm‘a
;

47 
boŞ
 
	mh—d_»cv
;

48 
size_t
 
	mm‘ašt
;

49 
size_t
 
	mm‘asz
;

50 
size_t
 
	mby‹c
;

51 
ušt16_t
 
	mpÜt
;

55 
r¡_cÚÃù
(
r¡
 *rst);

58 
	$de¡ruùÜ
(*
¬g
)

60 
r¡
 *r¡ = 
¬g
;

62 
	`tmr_ÿnûl
(&
r¡
->
tmr
);

63 
	`mem_d”ef
(
r¡
->
dnsq
);

64 
	`mem_d”ef
(
r¡
->
tc
);

65 
	`mem_d”ef
(
r¡
->
mb
);

66 
	`mem_d”ef
(
r¡
->
ho¡
);

67 
	`mem_d”ef
(
r¡
->
·th
);

68 
	`mem_d”ef
(
r¡
->
Çme
);

69 
	`mem_d”ef
(
r¡
->
m‘a
);

70 
	}
}

73 
	$»cÚÃù
(*
¬g
)

75 
r¡
 *r¡ = 
¬g
;

76 
”r
;

78 
r¡
->
mb
 = 
	`mem_d”ef
(rst->mb);

79 
r¡
->
Çme
 = 
	`mem_d”ef
(rst->name);

80 
r¡
->
m‘a
 = 
	`mem_d”ef
(rst->meta);

82 
r¡
->
h—d_»cv
 = 
çl£
;

83 
r¡
->
m‘ašt
 = 0;

84 
r¡
->
m‘asz
 = 0;

85 
r¡
->
by‹c
 = 0;

87 
”r
 = 
	`r¡_cÚÃù
(
r¡
);

88 ià(
”r
)

89 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
, 
»cÚÃù
,„st);

90 
	}
}

93 
	$»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

95 
r¡
 *r¡ = 
¬g
;

96 
size_t
 
n
;

98 ià(!
r¡
->
h—d_»cv
) {

100 
¶
 
hdr
, 
Çme
, 
m‘ašt
, 
eoh
;

102 ià(
r¡
->
mb
) {

103 
size_t
 
pos
;

104 
”r
;

106 
pos
 = 
r¡
->
mb
->pos;

108 
r¡
->
mb
->
pos
 =„¡->mb->
’d
;

110 
”r
 = 
	`mbuf_wr™e_mem
(
r¡
->
mb
, 
	`mbuf_buf
(mb),

111 
	`mbuf_g‘_Ëá
(
mb
));

112 ià(
”r
) {

113 
	`w¬nšg
("r¡: bufã¸wr™”rÜ: %m\n", 
”r
);

114 
r¡
->
tc
 = 
	`mem_d”ef
(rst->tc);

115 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
,

116 
»cÚÃù
, 
r¡
);

120 
r¡
->
mb
->
pos
 =…os;

123 
r¡
->
mb
 = 
	`mem_»f
(mb);

126 ià(
	`»_»gex
((cÚ¡ *)
	`mbuf_buf
(
r¡
->
mb
),

127 
	`mbuf_g‘_Ëá
(
r¡
->
mb
),

128 "[^\r\n]1\r\n\r\n", &
eoh
))

131 
r¡
->
h—d_»cv
 = 
Œue
;

133 
hdr
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
r¡
->
mb
);

134 
hdr
.
l
 = 
eoh
.
p
 + 5 - hdr.p;

136 ià(!
	`»_»gex
(
hdr
.
p
, hdr.
l
, "icy-name:[ \t]*[^\r\n]+\r\n",

137 
NULL
, &
Çme
))

138 ()
	`¶_¡rdup
(&
r¡
->
Çme
, &name);

140 ià(!
	`»_»gex
(
hdr
.
p
, hdr.
l
, "icy-metaint:[ \t]*[0-9]+\r\n",

141 
NULL
, &
m‘ašt
))

142 
r¡
->
m‘ašt
 = 
	`¶_u32
(&metaint);

144 ià(
r¡
->
m‘ašt
 == 0) {

145 
	`šfo
("rst: icy meta interval‚ot‡vailable\n");

146 
r¡
->
tc
 = 
	`mem_d”ef
(rst->tc);

147 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
, 
»cÚÃù
,„st);

151 
	`r¡_video_upd©e
(
r¡
->
vid¤c_¡
,„¡->
Çme
, 
NULL
);

153 
r¡
->
mb
->
pos
 +ğ
hdr
.
l
;

155 
	`šfo
("r¡:‚ame='%s' m‘ašt=%zu\n", 
r¡
->
Çme
,„¡->
m‘ašt
);

157 ià(
r¡
->
mb
->
pos
 >ğr¡->mb->
’d
)

160 
mb
 = 
r¡
->mb;

163 
mb
->
pos
 < mb->
’d
) {

165 ià(
r¡
->
m‘asz
 > 0) {

167 
n
 = 
	`mš
(
	`mbuf_g‘_Ëá
(
mb
), 
r¡
->
m‘asz
 -„¡->
by‹c
);

169 ià(
r¡
->
m‘a
)

170 
	`mbuf_»ad_mem
(
mb
,

171 (
ušt8_t
 *)&
r¡
->
m‘a
[r¡->
by‹c
],

172 
n
);

174 
mb
->
pos
 +ğ
n
;

176 
r¡
->
by‹c
 +ğ
n
;

178 
	`šfo
("r¡: m‘ad©¨%zu by‹s\n", 
n
);

180 ià(
r¡
->
by‹c
 >ğr¡->
m‘asz
) {

182 
	`šfo
("r¡: m‘ad©a: [%s]\n", 
r¡
->
m‘a
);

184 
r¡
->
m‘asz
 = 0;

185 
r¡
->
by‹c
 = 0;

187 
	`r¡_video_upd©e
(
r¡
->
vid¤c_¡
,„¡->
Çme
,

188 
r¡
->
m‘a
);

191 ià(
r¡
->
by‹c
 <„¡->
m‘ašt
) {

193 
n
 = 
	`mš
(
	`mbuf_g‘_Ëá
(
mb
), 
r¡
->
m‘ašt
 -„¡->
by‹c
);

195 
	`r¡_audio_ãed
(
r¡
->
au¤c_¡
, 
	`mbuf_buf
(
mb
), 
n
);

197 
r¡
->
by‹c
 +ğ
n
;

198 
mb
->
pos
 +ğ
n
;

200 
	`šfo
("r¡: mp3d©¨%zu by‹s\n", 
n
);

204 
r¡
->
m‘asz
 = 
	`mbuf_»ad_u8
(
mb
) * 16;

205 
r¡
->
by‹c
 = 0;

207 
r¡
->
m‘a
 = 
	`mem_d”ef
(rst->meta);

208 
r¡
->
m‘a
 = 
	`mem_z®loc
Ô¡->
m‘asz
 + 1, 
NULL
);

210 
	`šfo
("r¡: m‘®’gth %zu by‹s\n", 
r¡
->
m‘asz
);

214 
	}
}

217 
	$e¡ab_hªdËr
(*
¬g
)

219 
r¡
 *r¡ = 
¬g
;

220 
mbuf
 *
mb
;

221 
”r
;

223 
	`šfo
("rst: connectionƒstablished\n");

225 
mb
 = 
	`mbuf_®loc
(512);

226 ià(!
mb
) {

227 
”r
 = 
ENOMEM
;

228 
out
;

231 
”r
 = 
	`mbuf_´štf
(
mb
,

235 
r¡
->
·th
);

236 ià(
”r
)

237 
out
;

239 
mb
->
pos
 = 0;

241 
”r
 = 
	`tı_£nd
(
r¡
->
tc
, 
mb
);

242 ià(
”r
)

243 
out
;

245 
out
:

246 ià(
”r
) {

247 
	`w¬nšg
("r¡:ƒ¼Ü s’dšg HTTP„eque¡: %m\n", 
”r
);

250 
	`mem_d”ef
(
mb
);

251 
	}
}

254 
	$şo£_hªdËr
(
”r
, *
¬g
)

256 
r¡
 *r¡ = 
¬g
;

258 
	`šfo
("r¡:ı clo£d: %m\n", 
”r
);

260 
r¡
->
tc
 = 
	`mem_d”ef
(rst->tc);

262 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
, 
»cÚÃù
,„st);

263 
	}
}

266 
	$dns_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

267 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

269 
r¡
 *r¡ = 
¬g
;

270 
dn¤r
 *
¼
;

271 
§
 
¤v
;

273 ()
”r
;

274 ()
hdr
;

275 ()
authl
;

276 ()
addl
;

278 
¼
 = 
	`dns_¼li¡_fšd
(
ª¦
, 
r¡
->
ho¡
, 
DNS_TYPE_A
, 
DNS_CLASS_IN
, 
Œue
);

279 ià(!
¼
) {

280 
	`w¬nšg
("r¡: uÇbËØ»sŞve: %s\n", 
r¡
->
ho¡
);

281 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
, 
»cÚÃù
,„st);

285 
	`§_£t_š
(&
¤v
, 
¼
->
rd©a
.
a
.
addr
, 
r¡
->
pÜt
);

287 
”r
 = 
	`tı_cÚÃù
(&
r¡
->
tc
, &
¤v
, 
e¡ab_hªdËr
, 
»cv_hªdËr
,

288 
şo£_hªdËr
, 
r¡
);

289 ià(
”r
) {

290 
	`w¬nšg
("r¡:ı cÚÃùƒ¼Ü: %m\n", 
”r
);

291 
	`tmr_¡¬t
(&
r¡
->
tmr
, 
RETRY_WAIT
, 
»cÚÃù
,„st);

294 
	}
}

297 
	$r¡_cÚÃù
(
r¡
 *rst)

299 
§
 
¤v
;

300 
”r
;

302 ià(!
	`§_£t_¡r
(&
¤v
, 
r¡
->
ho¡
,„¡->
pÜt
)) {

304 
”r
 = 
	`tı_cÚÃù
(&
r¡
->
tc
, &
¤v
, 
e¡ab_hªdËr
, 
»cv_hªdËr
,

305 
şo£_hªdËr
, 
r¡
);

306 ià(
”r
) {

307 
	`w¬nšg
("r¡:ı cÚÃùƒ¼Ü: %m\n", 
”r
);

311 
”r
 = 
	`dnsc_qu”y
(&
r¡
->
dnsq
, 
	`Ãt_dnsc
(
	`b¬es_ÃtwÜk
()),

312 
r¡
->
ho¡
, 
DNS_TYPE_A
,

313 
DNS_CLASS_IN
, 
Œue
, 
dns_hªdËr
, 
r¡
);

314 ià(
”r
) {

315 
	`w¬nšg
("r¡: dn qu”yƒ¼Ü: %m\n", 
”r
);

319  
”r
;

320 
	}
}

323 
	$r¡_®loc
(
r¡
 **
r¡p
, cÚ¡ *
dev
)

325 
¶
 
ho¡
, 
pÜt
, 
·th
;

326 
r¡
 *rst;

327 
”r
;

329 ià(!
r¡p
 || !
dev
)

330  
EINVAL
;

332 ià(
	`»_»gex
(
dev
, 
	`¡¾’
(dev), "http://[^:/]+[:]*[0-9]*[^]+",

333 &
ho¡
, 
NULL
, &
pÜt
, &
·th
)) {

334 
	`w¬nšg
("r¡: bad h‰°u¾: %s\n", 
dev
);

335  
EBADMSG
;

338 
r¡
 = 
	`mem_z®loc
((*r¡), 
de¡ruùÜ
);

339 ià(!
r¡
)

340  
ENOMEM
;

342 
r¡
->
id
 = "rst";

344 
”r
 = 
	`¶_¡rdup
(&
r¡
->
ho¡
, &host);

345 ià(
”r
)

346 
out
;

348 
”r
 = 
	`¶_¡rdup
(&
r¡
->
·th
, &path);

349 ià(
”r
)

350 
out
;

352 
r¡
->
pÜt
 = 
	`¶_u32
(&port);

353 
r¡
->
pÜt
 =„st->port ?„st->port : 80;

355 
”r
 = 
	`r¡_cÚÃù
(
r¡
);

356 ià(
”r
)

357 
out
;

359 
out
:

360 ià(
”r
)

361 
	`mem_d”ef
(
r¡
);

363 *
r¡p
 = 
r¡
;

365  
”r
;

366 
	}
}

369 
	$r¡_£t_audio
(
r¡
 *r¡, 
au¤c_¡
 *
¡
)

371 ià(!
r¡
)

374 
r¡
->
au¤c_¡
 = 
¡
;

375 
	}
}

378 
	$r¡_£t_video
(
r¡
 *r¡, 
vid¤c_¡
 *
¡
)

380 ià(!
r¡
)

383 
r¡
->
vid¤c_¡
 = 
¡
;

384 
	}
}

387 
	$moduË_š™
()

389 
”r
;

391 
”r
 = 
	`r¡_audio_š™
();

392 ià(
”r
)

393 
out
;

395 
”r
 = 
	`r¡_video_š™
();

396 ià(
”r
)

397 
out
;

399 
out
:

400 ià(
”r
) {

401 
	`r¡_audio_şo£
();

402 
	`r¡_video_şo£
();

405  
”r
;

406 
	}
}

409 
	$moduË_şo£
()

411 
	`r¡_audio_şo£
();

412 
	`r¡_video_şo£
();

415 
	}
}

418 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
r¡
) = {

421 
moduË_š™
,

422 
moduË_şo£


	@baresip/modules/rst/rst.h

9 
	gr¡
;

11 
r¡_®loc
(
r¡
 **
r¡p
, cÚ¡ *
dev
);

12 
r¡_£t_audio
(
r¡
 *r¡, 
au¤c_¡
 *
¡
);

13 
r¡_£t_video
(
r¡
 *r¡, 
vid¤c_¡
 *
¡
);

17 
r¡_audio_ãed
(
au¤c_¡
 *
¡
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
);

18 
r¡_audio_š™
();

19 
r¡_audio_şo£
();

23 
r¡_video_upd©e
(
vid¤c_¡
 *
¡
, cÚ¡ *
Çme
,

24 cÚ¡ *
m‘a
);

25 
r¡_video_š™
();

26 
r¡_video_şo£
();

	@baresip/modules/rst/video.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<±h»ad.h
>

9 
	~<¡ršg.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

13 
	~<ÿœo/ÿœo.h
>

14 
	~"r¡.h
"

17 
	svid¤c_¡
 {

18 cÚ¡ 
vid¤c
 *
	mvs
;

19 
±h»ad_mu‹x_t
 
	mmu‹x
;

20 
±h»ad_t
 
	mth»ad
;

21 
vid¤c_´m
 
	m´m
;

22 
vidsz
 
	msize
;

23 
r¡
 *
	mr¡
;

24 
ÿœo_surçû_t
 *
	msurçû
;

25 
ÿœo_t
 *
	mÿœo
;

26 
vidäame
 *
	mäame
;

27 
vid¤c_äame_h
 *
	mäameh
;

28 *
	m¬g
;

29 
boŞ
 
	mrun
;

33 
vid¤c
 *
	gvid¤c
;

36 
	$de¡ruùÜ
(*
¬g
)

38 
vid¤c_¡
 *
¡
 = 
¬g
;

40 
	`r¡_£t_video
(
¡
->
r¡
, 
NULL
);

41 
	`mem_d”ef
(
¡
->
r¡
);

43 ià(
¡
->
run
) {

44 
¡
->
run
 = 
çl£
;

45 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

48 ià(
¡
->
ÿœo
)

49 
	`ÿœo_de¡roy
(
¡
->
ÿœo
);

51 ià(
¡
->
surçû
)

52 
	`ÿœo_surçû_de¡roy
(
¡
->
surçû
);

54 
	`mem_d”ef
(
¡
->
äame
);

55 
	}
}

58 *
	$video_th»ad
(*
¬g
)

60 
ušt64_t
 
now
, 
ts
 = 
	`tmr_jiff›s
();

61 
vid¤c_¡
 *
¡
 = 
¬g
;

63 
¡
->
run
) {

65 
	`sys_m¦“p
(4);

67 
now
 = 
	`tmr_jiff›s
();

69 ià(
ts
 > 
now
)

72 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

73 
¡
->
	`äameh
(¡->
äame
, st->
¬g
);

74 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

76 
ts
 +ğ1000/
¡
->
´m
.
ås
;

79  
NULL
;

80 
	}
}

83 
	$background
(
ÿœo_t
 *
ü
, 
width
, 
height
)

85 
ÿœo_·‰”n_t
 *
·t
;

86 
r
, 
g
, 
b
;

88 
·t
 = 
	`ÿœo_·‰”n_ü—‹_lš—r
(0.0, 0.0, 0.0, 
height
);

89 ià(!
·t
)

92 
r
 = 0.0;

93 
g
 = 0.0;

94 
b
 = 0.8;

96 
	`ÿœo_·‰”n_add_cŞÜ_¡İ_rgba
(
·t
, 1, 
r
, 
g
, 
b
, 1);

97 
	`ÿœo_·‰”n_add_cŞÜ_¡İ_rgba
(
·t
, 0, 0, 0, 0.2, 1);

98 
	`ÿœo_»ùªgË
(
ü
, 0, 0, 
width
, 
height
);

99 
	`ÿœo_£t_sourû
(
ü
, 
·t
);

100 
	`ÿœo_fl
(
ü
);

102 
	`ÿœo_·‰”n_de¡roy
(
·t
);

103 
	}
}

106 
	$icy_´štf
(
ÿœo_t
 *
ü
, 
x
, 
y
, 
size
,

107 cÚ¡ *
fmt
, ...)

109 
buf
[4096] = "";

110 
va_li¡
 
­
;

112 
	`va_¡¬t
(
­
, 
fmt
);

113 ()
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

114 
	`va_’d
(
­
);

117 
	`ÿœo_£Ëù_fÚt_çû
(
ü
, "Sªs", 
CAIRO_FONT_SLANT_NORMAL
,

118 
CAIRO_FONT_WEIGHT_NORMAL
);

119 
	`ÿœo_£t_fÚt_size
(
ü
, 
size
);

120 
	`ÿœo_move_to
(
ü
, 
x
, 
y
);

121 
	`ÿœo_‹xt_·th
(
ü
, 
buf
);

122 
	`ÿœo_£t_sourû_rgb
(
ü
, 1, 1, 1);

123 
	`ÿœo_fl
(
ü
);

124 
	}
}

127 
size_t
 
	$lš–’
(cÚ¡ 
¶
 *pl)

129 
size_t
 
Ën
 = 72, 
i
;

131 ià(
¶
->
l
 <ğ
Ën
)

132  
¶
->
l
;

134 
i
=
Ën
; i>1; i--) {

136 ià(
¶
->
p
[
i
-1] == ' ') {

137 
Ën
 = 
i
;

142  
Ën
;

143 
	}
}

146 
	$r¡_video_upd©e
(
vid¤c_¡
 *
¡
, cÚ¡ *
Çme
, cÚ¡ *
m‘a
)

148 
vidäame
 
äame
;

150 ià(!
¡
)

153 
	`background
(
¡
->
ÿœo
, st->
size
.
w
, st->size.
h
);

155 
	`icy_´štf
(
¡
->
ÿœo
, 50, 100, 40.0, "%s", 
Çme
);

157 ià(
m‘a
) {

159 
¶
 
t™Ë
;

161 ià(!
	`»_»gex
(
m‘a
, 
	`¡¾’
(meta),

162 "SŒ—mT™Ë='[ \t]*[^;]+;", 
NULL
, &
t™Ë
)) {

164 
i
;

166 
t™Ë
.
l
--;

168 
i
=0; 
t™Ë
.
l
; i++) {

170 cÚ¡ 
size_t
 
Ën
 = 
	`lš–’
(&
t™Ë
);

172 
	`icy_´štf
(
¡
->
ÿœo
, 50, 150 + 25*
i
, 18.0,

173 "%b", 
t™Ë
.
p
, 
Ën
);

175 
t™Ë
.
p
 +ğ
Ën
;

176 
t™Ë
.
l
 -ğ
Ën
;

181 
	`vidäame_š™_buf
(&
äame
, 
VID_FMT_RGB32
, &
¡
->
size
,

182 
	`ÿœo_image_surçû_g‘_d©a
(
¡
->
surçû
));

184 
	`±h»ad_mu‹x_lock
(&
¡
->
mu‹x
);

185 
	`vidcÚv
(
¡
->
äame
, &äame, 
NULL
);

186 
	`±h»ad_mu‹x_uÆock
(&
¡
->
mu‹x
);

187 
	}
}

190 
	$®loc_hªdËr
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

191 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

192 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

193 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

194 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

196 
vid¤c_¡
 *
¡
;

197 
”r
;

199 ()
fmt
;

200 ()
”rÜh
;

202 ià(!
¡p
 || !
vs
 || !
´m
 || !
size
 || !
äameh
)

203  
EINVAL
;

205 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

206 ià(!
¡
)

207  
ENOMEM
;

209 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¡
->
mu‹x
, 
NULL
);

210 ià(
”r
)

211 
out
;

213 
¡
->
vs
 = vs;

214 
¡
->
´m
 = *prm;

215 
¡
->
size
 = *size;

216 
¡
->
äameh
 = frameh;

217 
¡
->
¬g
 =‡rg;

219 
¡
->
surçû
 = 
	`ÿœo_image_surçû_ü—‹
(
CAIRO_FORMAT_ARGB32
,

220 
size
->
w
, size->
h
);

221 ià(!
¡
->
surçû
) {

222 
”r
 = 
ENOMEM
;

223 
out
;

226 
¡
->
ÿœo
 = 
	`ÿœo_ü—‹
(¡->
surçû
);

227 ià(!
¡
->
ÿœo
) {

228 
”r
 = 
ENOMEM
;

229 
out
;

232 
”r
 = 
	`vidäame_®loc
(&
¡
->
äame
, 
VID_FMT_YUV420P
, 
size
);

233 ià(
”r
)

234 
out
;

236 
	`vidäame_fl
(
¡
->
äame
, 0, 0, 0);

238 ià(
ùx
 && *ùx && (*ùx)->
id
 && !
	`¡rcmp
((*ctx)->id, "rst")) {

239 
¡
->
r¡
 = 
	`mem_»f
(*
ùx
);

242 
”r
 = 
	`r¡_®loc
(&
¡
->
r¡
, 
dev
);

243 ià(
”r
)

244 
out
;

246 ià(
ùx
)

247 *
ùx
 = (
medŸ_ùx
 *)
¡
->
r¡
;

250 
	`r¡_£t_video
(
¡
->
r¡
, st);

252 
¡
->
run
 = 
Œue
;

254 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
video_th»ad
, st);

255 ià(
”r
) {

256 
¡
->
run
 = 
çl£
;

257 
out
;

260 
out
:

261 ià(
”r
)

262 
	`mem_d”ef
(
¡
);

264 *
¡p
 = 
¡
;

266  
”r
;

267 
	}
}

270 
	$r¡_video_š™
()

272  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

273 "r¡", 
®loc_hªdËr
, 
NULL
);

274 
	}
}

277 
	$r¡_video_şo£
()

279 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

280 
	}
}

	@baresip/modules/sdl/sdl.c

6 
	~<SDL/SDL.h
>

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"sdl.h
"

23 
	mKEY_RELEASE_VAL
 = 250

26 
	svidi¥_¡
 {

27 cÚ¡ 
vidi¥
 *
	mvd
;

32 
tmr
 
	mtmr
;

33 
SDL_Surçû
 *
	msü“n
;

34 
SDL_Ov”Ïy
 *
	mbmp
;

35 
vidsz
 
	msize
;

36 
vidi¥_»size_h
 *
	m»sizeh
;

37 *
	m¬g
;

38 
boŞ
 
	mfuÎsü“n
;

39 
boŞ
 
	mİ’
;

40 } 
	gsdl
;

43 
vidi¥
 *
	gvid
;

46 
ev’t_hªdËr
(*
¬g
);

49 
	$sdl_»£t
()

51 ià(
sdl
.
bmp
) {

52 
	`SDL_F»eYUVOv”Ïy
(
sdl
.
bmp
);

53 
sdl
.
bmp
 = 
NULL
;

56 ià(
sdl
.
sü“n
) {

57 
	`SDL_F»eSurçû
(
sdl
.
sü“n
);

58 
sdl
.
sü“n
 = 
NULL
;

60 
	}
}

63 
	$hªdË_»size
(
w
, 
h
)

65 
vidsz
 
size
;

67 
size
.
w
 = w;

68 
size
.
h
 = h;

71 ià(
sdl
.
»sizeh
)

72 
sdl
.
	`»sizeh
(&
size
, sdl.
¬g
);

73 
	}
}

76 
	$timeout
(*
¬g
)

78 ()
¬g
;

80 
	`tmr_¡¬t
(&
sdl
.
tmr
, 1, 
ev’t_hªdËr
, 
NULL
);

83 
	`ui_šput_key
(
	`b¬es_uis
(), 
KEYCODE_REL
, 
NULL
);

84 
	}
}

87 
	$ev’t_hªdËr
(*
¬g
)

89 
SDL_Ev’t
 
ev’t
;

90 
ch
;

92 ()
¬g
;

94 
	`tmr_¡¬t
(&
sdl
.
tmr
, 100, 
ev’t_hªdËr
, 
NULL
);

96 
	`SDL_PŞlEv’t
(&
ev’t
)) {

98 
ev’t
.
ty³
) {

100 
SDL_KEYDOWN
:

102 
ev’t
.
key
.
keysym
.
sym
) {

104 
SDLK_ESCAPE
:

105 ià(!
sdl
.
fuÎsü“n
)

108 
sdl
.
fuÎsü“n
 = 
çl£
;

109 
	`sdl_»£t
();

112 
SDLK_f
:

113 ià(
sdl
.
fuÎsü“n
)

116 
sdl
.
fuÎsü“n
 = 
Œue
;

117 
	`sdl_»£t
();

121 
ch
 = 
ev’t
.
key
.
keysym
.
unicode
 & 0x7f;

124 ià(
	`i¥ršt
(
ch
)) {

125 
	`tmr_¡¬t
(&
sdl
.
tmr
, 
KEY_RELEASE_VAL
,

126 
timeout
, 
NULL
);

127 
	`ui_šput_key
(
	`b¬es_uis
(), 
ch
, 
NULL
);

134 
SDL_VIDEORESIZE
:

135 
	`hªdË_»size
(
ev’t
.
»size
.
w
,ƒv’t.»size.
h
);

138 
SDL_QUIT
:

139 
	`ui_šput_key
(
	`b¬es_uis
(), 'q', 
NULL
);

146 
	}
}

149 
	$sdl_İ’
()

151 ià(
sdl
.
İ’
)

154 ià(
	`SDL_In™
(
SDL_INIT_VIDEO
) < 0) {

155 
	`w¬nšg
("sdl: uÇbËØš™ SDL: %s\n", 
	`SDL_G‘E¼Ü
());

156  
ENODEV
;

159 
	`SDL_EÇbËUNICODE
(1);

161 
	`tmr_¡¬t
(&
sdl
.
tmr
, 100, 
ev’t_hªdËr
, 
NULL
);

162 
sdl
.
İ’
 = 
Œue
;

165 
	}
}

168 
	$sdl_şo£
()

170 
	`tmr_ÿnûl
(&
sdl
.
tmr
);

171 
	`sdl_»£t
();

173 ià(
sdl
.
İ’
) {

174 
	`SDL_Qu™
();

175 
sdl
.
İ’
 = 
çl£
;

177 
	}
}

180 
	$de¡ruùÜ
(*
¬g
)

182 
vidi¥_¡
 *
¡
 = 
¬g
;

183 ()
¡
;

185 
	`sdl_şo£
();

186 
	}
}

189 
	$®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

190 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

191 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

193 
vidi¥_¡
 *
¡
;

194 
”r
;

197 ()
´m
;

198 ()
dev
;

200 ià(
sdl
.
İ’
)

201  
EBUSY
;

203 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

204 ià(!
¡
)

205  
ENOMEM
;

207 
¡
->
vd
 = vd;

209 
sdl
.
»sizeh
 =„esizeh;

210 
sdl
.
¬g
 =‡rg;

212 
”r
 = 
	`sdl_İ’
();

214 ià(
”r
)

215 
	`mem_d”ef
(
¡
);

217 *
¡p
 = 
¡
;

219  
”r
;

220 
	}
}

234 
	$di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

235 cÚ¡ 
vidäame
 *
äame
)

237 
SDL_Reù
 
»ù
;

239 ià(!
¡
 || !
sdl
.
İ’
)

240  
EINVAL
;

242 ià(!
	`vidsz_cmp
(&
sdl
.
size
, &
äame
->size)) {

243 ià(
sdl
.
size
.
w
 && sdl.size.
h
) {

244 
	`šfo
("sdl:„eset size %u x %u ---> %u x %u\n",

245 
sdl
.
size
.
w
, sdl.size.
h
,

246 
äame
->
size
.
w
, f¿me->size.
h
);

248 
	`sdl_»£t
();

251 ià(!
sdl
.
sü“n
) {

252 
æags
 = 
SDL_HWSURFACE
 | 
SDL_ASYNCBLIT
 | 
SDL_HWACCEL
;

253 
ÿ±
[256];

255 ià(
sdl
.
fuÎsü“n
)

256 
æags
 |ğ
SDL_FULLSCREEN
;

257 ià(
sdl
.
»sizeh
)

258 
æags
 |ğ
SDL_RESIZABLE
;

260 ià(
t™Ë
) {

261 
	`»_¢´štf
(
ÿ±
, (capt), "%s - %u x %u",

262 
t™Ë
, 
äame
->
size
.
w
, f¿me->size.
h
);

265 
	`»_¢´štf
(
ÿ±
, (capt), "%u x %u",

266 
äame
->
size
.
w
, f¿me->size.
h
);

269 
	`SDL_WM_S‘C­tiÚ
(
ÿ±
, capt);

271 
sdl
.
sü“n
 = 
	`SDL_S‘VideoMode
(
äame
->
size
.
w
, f¿me->size.
h
,

272 0, 
æags
);

273 ià(!
sdl
.
sü“n
) {

274 
	`w¬nšg
("sdl: unableo get video screen: %s\n",

275 
	`SDL_G‘E¼Ü
());

276  
ENODEV
;

279 
sdl
.
size
 = 
äame
->size;

282 ià(!
sdl
.
bmp
) {

283 
sdl
.
bmp
 = 
	`SDL_C»©eYUVOv”Ïy
(
äame
->
size
.
w
, f¿me->size.
h
,

284 
SDL_YV12_OVERLAY
, 
sdl
.
sü“n
);

285 ià(!
sdl
.
bmp
) {

286 
	`w¬nšg
("sdl: unableo create overlay: %s\n",

287 
	`SDL_G‘E¼Ü
());

288  
ENODEV
;

292 
	`SDL_LockYUVOv”Ïy
(
sdl
.
bmp
);

293 
	`piùu»_cİy
(
sdl
.
bmp
->
pix–s
, sdl.bmp->
p™ches
, 
äame
);

294 
	`SDL_UÆockYUVOv”Ïy
(
sdl
.
bmp
);

296 
»ù
.
x
 = 0;

297 
»ù
.
y
 = 0;

298 
»ù
.
w
 = 
sdl
.
size
.w;

299 
»ù
.
h
 = 
sdl
.
size
.h;

301 
	`SDL_Di¥ÏyYUVOv”Ïy
(
sdl
.
bmp
, &
»ù
);

304 
	}
}

307 
	$moduË_š™
()

309  
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(),

310 "sdl", 
®loc
, 
NULL
, 
di¥Ïy
, NULL);

311 
	}
}

314 
	$moduË_şo£
()

316 
vid
 = 
	`mem_d”ef
(vid);

319 
	}
}

322 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
sdl
) = {

325 
moduË_š™
,

326 
moduË_şo£
,

	@baresip/modules/sdl/sdl.h

8 
piùu»_cİy
(
ušt8_t
 *
d©a
[4], 
ušt16_t
 
lšesize
[4],

9 cÚ¡ 
vidäame
 *
äame
);

	@baresip/modules/sdl/util.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"sdl.h
"

13 
	$img_cİy_¶ªe
(
ušt8_t
 *
d¡
, 
d¡_w¿p
,

14 cÚ¡ 
ušt8_t
 *
¤c
, 
¤c_w¿p
,

15 
width
, 
height
)

17 ià(!
d¡
 || !
¤c
)

20 ;
height
 > 0; height--) {

21 
	`memıy
(
d¡
, 
¤c
, 
width
);

22 
d¡
 +ğ
d¡_w¿p
;

23 
¤c
 +ğ
¤c_w¿p
;

25 
	}
}

28 
	$g‘_¶ªe_by‹width
(
width
, 
¶ªe
)

30 ià(
¶ªe
 == 1 ||…lane == 2)

31 
width
 = -((-width) >> 1);

33  (
width
 * 8 + 7) >> 3;

34 
	}
}

37 
	$piùu»_cİy
(
ušt8_t
 *
d©a
[4], 
ušt16_t
 
lšesize
[4],

38 cÚ¡ 
vidäame
 *
äame
)

40 cÚ¡ 
m­
[3] = {0, 2, 1};

41 
i
;

43 
i
=0; i<3; i++) {

44 
h
;

45 
bwidth
 = 
	`g‘_¶ªe_by‹width
(
äame
->
size
.
w
, 
i
);

46 
h
 = 
äame
->
size
.h;

47 ià(
i
 == 1 || i == 2) {

48 
h
 = -((-
äame
->
size
.h) >> 1);

50 
	`img_cİy_¶ªe
(
d©a
[
m­
[
i
]], 
lšesize
[map[i]],

51 
äame
->
d©a
[
i
], f¿me->
lšesize
[i],

52 
bwidth
, 
h
);

54 
	}
}

	@baresip/modules/sdl2/sdl.c

7 
	~<SDL2/SDL.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

20 
	svidi¥_¡
 {

21 cÚ¡ 
vidi¥
 *
	mvd
;

22 
SDL_Wšdow
 *
	mwšdow
;

23 
SDL_R’d””
 *
	m»nd””
;

24 
SDL_Textu»
 *
	m‹xtu»
;

25 
vidsz
 
	msize
;

26 
vidfmt
 
	mfmt
;

27 
boŞ
 
	mfuÎsü“n
;

28 
tmr
 
	mtmr
;

29 
Ušt32
 
	mæags
;

33 
vidi¥
 *
	gvid
;

36 
ev’t_hªdËr
(*
¬g
);

39 
ušt32_t
 
	$m©ch_fmt
(
vidfmt
 
fmt
)

41 
fmt
) {

43 
VID_FMT_YUV420P
:  
SDL_PIXELFORMAT_IYUV
;

44 #ià
	`SDL_VERSION_ATLEAST
(2, 0, 4)

45 
VID_FMT_NV12
:  
SDL_PIXELFORMAT_NV12
;

47 
VID_FMT_RGB32
:  
SDL_PIXELFORMAT_ARGB8888
;

48 :  
SDL_PIXELFORMAT_UNKNOWN
;

50 
	}
}

53 
ušt32_t
 
	$chroma_¡•
(
vidfmt
 
fmt
)

55 
fmt
) {

57 
VID_FMT_YUV420P
:  2;

58 
VID_FMT_NV12
:  1;

59 
VID_FMT_RGB32
:  0;

62 
	}
}

65 
	$sdl_»£t
(
vidi¥_¡
 *
¡
)

67 ià(
¡
->
‹xtu»
) {

69 
¡
->
‹xtu»
 = 
NULL
;

72 ià(
¡
->
»nd””
) {

74 
¡
->
»nd””
 = 
NULL
;

77 ià(
¡
->
wšdow
) {

78 
	`SDL_De¡royWšdow
(
¡
->
wšdow
);

79 
¡
->
wšdow
 = 
NULL
;

81 
	}
}

84 
	$ev’t_hªdËr
(*
¬g
)

86 
vidi¥_¡
 *
¡
 = 
¬g
;

87 
SDL_Ev’t
 
ev’t
;

89 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
ev’t_hªdËr
, st);

92 
	`SDL_PŞlEv’t
(&
ev’t
)) {

94 ià(
ev’t
.
ty³
 =ğ
SDL_KEYDOWN
) {

96 
ev’t
.
key
.
keysym
.
sym
) {

98 
SDLK_f
:

100 
¡
->
fuÎsü“n
 = !st->fullscreen;

101 
	`šfo
("sdl: %sable fullscreen mode\n",

102 
¡
->
fuÎsü“n
 ? "en" : "dis");

104 ià(
¡
->
fuÎsü“n
)

105 
¡
->
æags
 |=

106 
SDL_WINDOW_FULLSCREEN_DESKTOP
;

108 
¡
->
æags
 &=

109 ~
SDL_WINDOW_FULLSCREEN_DESKTOP
;

111 
	`SDL_S‘WšdowFuÎsü“n
(
¡
->
wšdow
, st->
æags
);

119 
	}
}

122 
	$de¡ruùÜ
(*
¬g
)

124 
vidi¥_¡
 *
¡
 = 
¬g
;

126 
	`tmr_ÿnûl
(&
¡
->
tmr
);

127 
	`sdl_»£t
(
¡
);

128 
	}
}

131 
	$®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

132 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

133 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

135 
vidi¥_¡
 *
¡
;

136 
”r
 = 0;

139 ()
dev
;

140 ()
»sizeh
;

141 ()
¬g
;

143 ià(!
¡p
 || !
vd
)

144  
EINVAL
;

146 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

147 ià(!
¡
)

148  
ENOMEM
;

150 
¡
->
vd
 = vd;

151 
¡
->
fuÎsü“n
 = 
´m
 ?…rm->fuÎsü“À: 
çl£
;

153 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
ev’t_hªdËr
, st);

155 ià(
”r
)

156 
	`mem_d”ef
(
¡
);

158 *
¡p
 = 
¡
;

160  
”r
;

161 
	}
}

164 
	$di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

165 cÚ¡ 
vidäame
 *
äame
)

167 *
pix–s
;

168 
ušt8_t
 *
d
;

169 
dp™ch
, 
»t
;

170 
i
, 
h
;

171 
ušt32_t
 
fÜm©
;

173 ià(!
¡
 || !
äame
)

174  
EINVAL
;

176 
fÜm©
 = 
	`m©ch_fmt
(
äame
->
fmt
);

177 ià(
fÜm©
 =ğ
SDL_PIXELFORMAT_UNKNOWN
) {

178 
	`w¬nšg
("sdl2:…ixel format‚ot supported (%s)\n",

179 
	`vidfmt_Çme
(
äame
->
fmt
));

180  
ENOTSUP
;

183 ià(!
	`vidsz_cmp
(&
¡
->
size
, &
äame
->sizeè|| f¿me->
fmt
 != st->fmt) {

184 ià(
¡
->
size
.
w
 && st->size.
h
) {

185 
	`šfo
("sdl:„eset size:"

187 
	`vidfmt_Çme
(
¡
->
fmt
), st->
size
.
w
, st->size.
h
,

188 
	`vidfmt_Çme
(
äame
->
fmt
),

189 
äame
->
size
.
w
, f¿me->size.
h
);

191 
	`sdl_»£t
(
¡
);

194 ià(!
¡
->
wšdow
) {

195 
ÿ±
[256];

197 
¡
->
æags
 = 
SDL_WINDOW_SHOWN
 | 
SDL_WINDOW_INPUT_FOCUS
;

199 ià(
¡
->
fuÎsü“n
)

200 
¡
->
æags
 |ğ
SDL_WINDOW_FULLSCREEN_DESKTOP
;

202 ià(
t™Ë
) {

203 
	`»_¢´štf
(
ÿ±
, (capt), "%s - %u x %u",

204 
t™Ë
, 
äame
->
size
.
w
, f¿me->size.
h
);

207 
	`»_¢´štf
(
ÿ±
, (capt), "%u x %u",

208 
äame
->
size
.
w
, f¿me->size.
h
);

211 
¡
->
wšdow
 = 
	`SDL_C»©eWšdow
(
ÿ±
,

212 
SDL_WINDOWPOS_CENTERED
,

213 
SDL_WINDOWPOS_CENTERED
,

214 
äame
->
size
.
w
, f¿me->size.
h
,

215 
¡
->
æags
);

216 ià(!
¡
->
wšdow
) {

217 
	`w¬nšg
("sdl: unableo create sdl window: %s\n",

218 
	`SDL_G‘E¼Ü
());

219  
ENODEV
;

222 
¡
->
size
 = 
äame
->size;

223 
¡
->
fmt
 = 
äame
->fmt;

225 
	`SDL_Rai£Wšdow
(
¡
->
wšdow
);

226 
	`SDL_S‘WšdowBÜd”ed
(
¡
->
wšdow
, 
Œue
);

227 
	`SDL_ShowWšdow
(
¡
->
wšdow
);

230 ià(!
¡
->
»nd””
) {

232 
Ušt32
 
æags
 = 0;

234 
æags
 |ğ
SDL_RENDERER_ACCELERATED
;

235 
æags
 |ğ
SDL_RENDERER_PRESENTVSYNC
;

237 
¡
->
»nd””
 = 
	`SDL_C»©eR’d””
(¡->
wšdow
, -1, 
æags
);

238 ià(!
¡
->
»nd””
) {

239 
	`w¬nšg
("sdl: unableo create„enderer: %s\n",

240 
	`SDL_G‘E¼Ü
());

241  
ENOMEM
;

245 ià(!
¡
->
‹xtu»
) {

247 
¡
->
‹xtu»
 = 
	`SDL_C»©eTextu»
(¡->
»nd””
,

248 
fÜm©
,

249 
SDL_TEXTUREACCESS_STREAMING
,

250 
äame
->
size
.
w
, f¿me->size.
h
);

251 ià(!
¡
->
‹xtu»
) {

252 
	`w¬nšg
("sdl: unableo createexture: %s\n",

253 
	`SDL_G‘E¼Ü
());

254  
ENODEV
;

258 
»t
 = 
	`SDL_LockTextu»
(
¡
->
‹xtu»
, 
NULL
, &
pix–s
, &
dp™ch
);

259 ià(
»t
 != 0) {

260 
	`w¬nšg
("sdl: uÇbËØlockextu» (»t=%d)\n", 
»t
);

261  
ENODEV
;

264 
d
 = 
pix–s
;

265 
i
=0; i<3; i++) {

267 cÚ¡ 
ušt8_t
 *
s
 = 
äame
->
d©a
[
i
];

268 
sz
, 
dsz
, 
h¡•
, 
w¡•
;

270 ià(!
äame
->
d©a
[
i
] || !äame->
lšesize
[i])

273 
h¡•
 = 
i
==0 ? 1 : 2;

274 
w¡•
 = 
i
==0 ? 1 : 
	`chroma_¡•
(
äame
->
fmt
);

276 
dsz
 = 
dp™ch
 / 
w¡•
;

277 
sz
 = 
	`mš
(
äame
->
lšesize
[
i
], 
dsz
);

279 
h
 = 0; h < 
äame
->
size
.h; h +ğ
h¡•
) {

281 
	`memıy
(
d
, 
s
, 
sz
);

283 
s
 +ğ
äame
->
lšesize
[
i
];

284 
d
 +ğ
dsz
;

288 
	`SDL_UÆockTextu»
(
¡
->
‹xtu»
);

291 
	`SDL_R’d”Cİy
(
¡
->
»nd””
, st->
‹xtu»
, 
NULL
, NULL);

294 
	`SDL_R’d”P»£Á
(
¡
->
»nd””
);

297 
	}
}

300 
	$hide
(
vidi¥_¡
 *
¡
)

302 ià(!
¡
 || !¡->
wšdow
)

305 
	`SDL_HideWšdow
(
¡
->
wšdow
);

306 
	}
}

309 
	$moduË_š™
()

311 
”r
;

313 ià(
	`SDL_VideoIn™
(
NULL
) < 0) {

314 
	`w¬nšg
("sdl2: unableo init Video: %s\n",

315 
	`SDL_G‘E¼Ü
());

316  
ENODEV
;

319 
”r
 = 
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(),

320 "sdl2", 
®loc
, 
NULL
, 
di¥Ïy
, 
hide
);

321 ià(
”r
)

322  
”r
;

325 
	}
}

328 
	$moduË_şo£
()

330 
vid
 = 
	`mem_d”ef
(vid);

332 
	`SDL_VideoQu™
();

335 
	}
}

338 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
sdl2
) = {

341 
moduË_š™
,

342 
moduË_şo£
,

	@baresip/modules/selfview/selfview.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

26 
	s£lfv›w
 {

27 
lock
 *
	mlock
;

28 
vidäame
 *
	mäame
;

31 
	s£lfv›w_’c
 {

32 
vidft_’c_¡
 
	mvf
;

33 
£lfv›w
 *
	m£lfv›w
;

34 
vidi¥_¡
 *
	mdi¥
;

37 
	s£lfv›w_dec
 {

38 
vidft_dec_¡
 
	mvf
;

39 
£lfv›w
 *
	m£lfv›w
;

43 
vidsz
 
	g£lfv›w_size
 = {0, 0};

46 
	$de¡ruùÜ
(*
¬g
)

48 
£lfv›w
 *
¡
 = 
¬g
;

50 
	`lock_wr™e_g‘
(
¡
->
lock
);

51 
	`mem_d”ef
(
¡
->
äame
);

52 
	`lock_»l
(
¡
->
lock
);

53 
	`mem_d”ef
(
¡
->
lock
);

54 
	}
}

57 
	$’code_de¡ruùÜ
(*
¬g
)

59 
£lfv›w_’c
 *
¡
 = 
¬g
;

61 
	`li¡_uÆšk
(&
¡
->
vf
.
Ë
);

62 
	`mem_d”ef
(
¡
->
£lfv›w
);

63 
	`mem_d”ef
(
¡
->
di¥
);

64 
	}
}

67 
	$decode_de¡ruùÜ
(*
¬g
)

69 
£lfv›w_dec
 *
¡
 = 
¬g
;

71 
	`li¡_uÆšk
(&
¡
->
vf
.
Ë
);

72 
	`mem_d”ef
(
¡
->
£lfv›w
);

73 
	}
}

76 
	$£lfv›w_®loc
(
£lfv›w
 **
£lfv›wp
, **
ùx
)

78 
£lfv›w
 *selfview;

79 
”r
;

81 ià(!
£lfv›wp
 || !
ùx
)

82  
EINVAL
;

84 ià(*
ùx
) {

85 *
£lfv›wp
 = 
	`mem_»f
(*
ùx
);

88 
£lfv›w
 = 
	`mem_z®loc
((*£lfv›w), 
de¡ruùÜ
);

89 ià(!
£lfv›w
)

90  
ENOMEM
;

92 
”r
 = 
	`lock_®loc
(&
£lfv›w
->
lock
);

93 ià(
”r
)

94  
”r
;

96 *
ùx
 = 
£lfv›w
;

97 *
£lfv›wp
 = 
£lfv›w
;

101 
	}
}

104 
	$’code_upd©e
(
vidft_’c_¡
 **
¡p
, **
ùx
,

105 cÚ¡ 
vidft
 *
vf
)

107 
£lfv›w_’c
 *
¡
;

108 
”r
;

110 ià(!
¡p
 || !
ùx
 || !
vf
)

111  
EINVAL
;

113 ià(*
¡p
)

116 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

117 ià(!
¡
)

118  
ENOMEM
;

120 
”r
 = 
	`£lfv›w_®loc
(&
¡
->
£lfv›w
, 
ùx
);

122 ià(
”r
)

123 
	`mem_d”ef
(
¡
);

125 *
¡p
 = (
vidft_’c_¡
 *)
¡
;

127  
”r
;

128 
	}
}

131 
	$decode_upd©e
(
vidft_dec_¡
 **
¡p
, **
ùx
,

132 cÚ¡ 
vidft
 *
vf
)

134 
£lfv›w_dec
 *
¡
;

135 
”r
;

137 ià(!
¡p
 || !
ùx
 || !
vf
)

138  
EINVAL
;

140 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

141 ià(!
¡
)

142  
ENOMEM
;

144 
”r
 = 
	`£lfv›w_®loc
(&
¡
->
£lfv›w
, 
ùx
);

146 ià(
”r
)

147 
	`mem_d”ef
(
¡
);

149 *
¡p
 = (
vidft_dec_¡
 *)
¡
;

151  
”r
;

152 
	}
}

155 
	$’code_wš
(
vidft_’c_¡
 *
¡
, 
vidäame
 *
äame
)

157 
£lfv›w_’c
 *
’c
 = (£lfv›w_’ø*)
¡
;

158 
”r
;

160 ià(!
äame
)

163 ià(!
’c
->
di¥
) {

165 
”r
 = 
	`vidi¥_®loc
(&
’c
->
di¥
, 
	`b¬es_vidi¥l
(),

166 
NULL
, NULL, NULL, NULL, NULL);

167 ià(
”r
)

168  
”r
;

171  
	`vidi¥_di¥Ïy
(
’c
->
di¥
, "S–fv›w", 
äame
);

172 
	}
}

175 
	$’code_p
(
vidft_’c_¡
 *
¡
, 
vidäame
 *
äame
)

177 
£lfv›w_’c
 *
’c
 = (£lfv›w_’ø*)
¡
;

178 
£lfv›w
 *£lfv›w = 
’c
->selfview;

179 
”r
 = 0;

181 ià(!
äame
)

184 
	`lock_wr™e_g‘
(
£lfv›w
->
lock
);

185 ià(!
£lfv›w
->
äame
) {

186 
vidsz
 
sz
;

189 ià(
£lfv›w_size
.
w
 && s–fv›w_size.
h
) {

190 
sz
 = 
£lfv›w_size
;

193 
sz
.
w
 = 
äame
->
size
.w / 5;

194 
sz
.
h
 = 
äame
->
size
.h / 5;

197 
”r
 = 
	`vidäame_®loc
(&
£lfv›w
->
äame
, 
VID_FMT_YUV420P
, &
sz
);

199 ià(!
”r
)

200 
	`vidcÚv
(
£lfv›w
->
äame
, f¿me, 
NULL
);

201 
	`lock_»l
(
£lfv›w
->
lock
);

203  
”r
;

204 
	}
}

207 
	$decode_p
(
vidft_dec_¡
 *
¡
, 
vidäame
 *
äame
)

209 
£lfv›w_dec
 *
dec
 = (£lfv›w_deø*)
¡
;

210 
£lfv›w
 *
sv
 = 
dec
->selfview;

212 ià(!
äame
)

215 
	`lock_»ad_g‘
(
sv
->
lock
);

216 ià(
sv
->
äame
) {

217 
vid»ù
 
»ù
;

219 
»ù
.
w
 = 
	`mš
(
sv
->
äame
->
size
.w, frame->size.w/2);

220 
»ù
.
h
 = 
	`mš
(
sv
->
äame
->
size
.h, frame->size.h/2);

221 ià(
»ù
.
w
 <ğ(
äame
->
size
.w - 10))

222 
»ù
.
x
 = 
äame
->
size
.
w
 -„ect.w - 10;

224 
»ù
.
x
 = 
äame
->
size
.
w
/2;

225 ià(
»ù
.
h
 <ğ(
äame
->
size
.h - 10))

226 
»ù
.
y
 = 
äame
->
size
.
h
 -„ect.h - 10;

228 
»ù
.
y
 = 
äame
->
size
.
h
/2;

230 
	`vidcÚv
(
äame
, 
sv
->äame, &
»ù
);

232 
	`vidäame_d¿w_»ù
(
äame
, 
»ù
.
x
,„eù.
y
,„eù.
w
,„eù.
h
,

235 
	`lock_»l
(
sv
->
lock
);

238 
	}
}

241 
vidft
 
	g£lfv›w_wš
 = {

242 
LE_INIT
, "£lfv›w_wšdow", 
’code_upd©e
, 
’code_wš
, 
NULL
, NULL

244 
vidft
 
	g£lfv›w_p
 = {

245 
LE_INIT
, "selfview_pip",

246 
’code_upd©e
, 
’code_p
, 
decode_upd©e
, 
decode_p


250 
	$moduË_š™
()

252 
¶
…Èğ
	`PL
("pip");

254 ()
	`cÚf_g‘
(
	`cÚf_cur
(), "video_£lfv›w", &
¶
);

256 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "window"))

257 
	`vidft_»gi¡”
(
	`b¬es_vidf
(), &
£lfv›w_wš
);

258 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "pip"))

259 
	`vidft_»gi¡”
(
	`b¬es_vidf
(), &
£lfv›w_p
);

261 ()
	`cÚf_g‘_vidsz
(
	`cÚf_cur
(), "£lfv›w_size", &
£lfv›w_size
);

264 
	}
}

267 
	$moduË_şo£
()

269 
	`vidft_uÄegi¡”
(&
£lfv›w_wš
);

270 
	`vidft_uÄegi¡”
(&
£lfv›w_p
);

272 
	}
}

275 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
£lfv›w
) = {

278 
moduË_š™
,

279 
moduË_şo£


	@baresip/modules/silk/silk.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<sk/SKP_Sk_SDK_API.h
>

21 
	mMAX_BYTES_PER_FRAME
 = 250,

22 
	mMAX_FRAME_SIZE
 = 2*480,

26 
	sau’c_¡©e
 {

27 *
	m’c
;

28 
SKP_SILK_SDK_EncCÚŒŞSŒuù
 
	m’cCÚŒŞ
;

31 
	saudec_¡©e
 {

32 *
	mdec
;

33 
SKP_SILK_SDK_DecCÚŒŞSŒuù
 
	mdecCÚŒŞ
;

37 
	$’code_de¡ruùÜ
(*
¬g
)

39 
au’c_¡©e
 *
¡
 = 
¬g
;

41 
	`mem_d”ef
(
¡
->
’c
);

42 
	}
}

45 
	$decode_de¡ruùÜ
(*
¬g
)

47 
audec_¡©e
 *
¡
 = 
¬g
;

49 
	`mem_d”ef
(
¡
->
dec
);

50 
	}
}

53 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
,

54 cÚ¡ 
aucodec
 *
ac
,

55 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

57 
au’c_¡©e
 *
¡
;

58 
»t
, 
”r
 = 0;

59 
št32_t
 
’c_size
;

60 ()
fm
;

62 ià(!
«¥
 || !
ac
 || !
´m
)

63  
EINVAL
;

64 ià(*
«¥
)

67 
»t
 = 
	`SKP_Sk_SDK_G‘_Encod”_Size
(&
’c_size
);

68 ià(
»t
 || 
’c_size
 <= 0)

69  
EINVAL
;

71 
¡
 = 
	`mem_®loc
((*¡), 
’code_de¡ruùÜ
);

72 ià(!
¡
)

73  
ENOMEM
;

75 
¡
->
’c
 = 
	`mem_®loc
(
’c_size
, 
NULL
);

76 ià(!
¡
->
’c
) {

77 
”r
 = 
ENOMEM
;

78 
out
;

81 
»t
 = 
	`SKP_Sk_SDK_In™Encod”
(
¡
->
’c
, &¡->
’cCÚŒŞ
);

82 ià(
»t
) {

83 
”r
 = 
EPROTO
;

84 
out
;

87 
¡
->
’cCÚŒŞ
.
API_§m¶eR©e
 = 
ac
->
¤©e
;

88 
¡
->
’cCÚŒŞ
.
maxIÁ”ÇlSam¶eR©e
 = 
ac
->
¤©e
;

89 
¡
->
’cCÚŒŞ
.
·ck‘Size
 = 
´m
->
±ime
 * 
ac
->
¤©e
 / 1000;

90 
¡
->
’cCÚŒŞ
.
b™R©e
 = 64000;

91 
¡
->
’cCÚŒŞ
.
com¶ex™y
 = 2;

92 
¡
->
’cCÚŒŞ
.
u£InBªdFEC
 = 0;

93 
¡
->
’cCÚŒŞ
.
u£DTX
 = 0;

95 
	`šfo
("silk:ƒncoder: %dHz,…size=%d, bitrate=%d, complex=%d,"

97 
¡
->
’cCÚŒŞ
.
API_§m¶eR©e
,

98 
¡
->
’cCÚŒŞ
.
·ck‘Size
,

99 
¡
->
’cCÚŒŞ
.
b™R©e
,

100 
¡
->
’cCÚŒŞ
.
com¶ex™y
,

101 
¡
->
’cCÚŒŞ
.
u£InBªdFEC
,

102 
¡
->
’cCÚŒŞ
.
u£DTX
);

104 
out
:

105 ià(
”r
)

106 
	`mem_d”ef
(
¡
);

108 *
«¥
 = 
¡
;

110  
”r
;

111 
	}
}

114 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

115 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

117 
audec_¡©e
 *
¡
;

118 
»t
, 
”r
 = 0;

119 
št32_t
 
dec_size
;

120 ()
fm
;

122 ià(*
ad¥
)

125 
»t
 = 
	`SKP_Sk_SDK_G‘_Decod”_Size
(&
dec_size
);

126 ià(
»t
 || 
dec_size
 <= 0)

127  
EINVAL
;

129 
¡
 = 
	`mem_®loc
((*¡), 
decode_de¡ruùÜ
);

130 ià(!
¡
)

131  
ENOMEM
;

133 
¡
->
dec
 = 
	`mem_®loc
(
dec_size
, 
NULL
);

134 ià(!
¡
->
dec
) {

135 
”r
 = 
ENOMEM
;

136 
out
;

139 
»t
 = 
	`SKP_Sk_SDK_In™Decod”
(
¡
->
dec
);

140 ià(
»t
) {

141 
”r
 = 
EPROTO
;

142 
out
;

145 
¡
->
decCÚŒŞ
.
API_§m¶eR©e
 = 
ac
->
¤©e
;

147 
out
:

148 ià(
”r
)

149 
	`mem_d”ef
(
¡
);

151 *
ad¥
 = 
¡
;

153  
”r
;

154 
	}
}

157 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

158 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

160 
»t
;

161 
št16_t
 
nBy‹sOut
;

163 ià(*
Ën
 < 
MAX_BYTES_PER_FRAME
)

164  
ENOMEM
;

166 
nBy‹sOut
 = *
Ën
;

167 
»t
 = 
	`SKP_Sk_SDK_Encode
(
¡
->
’c
,

168 &
¡
->
’cCÚŒŞ
,

169 
§mpv
,

170 ()
§mpc
,

171 
buf
,

172 &
nBy‹sOut
);

173 ià(
»t
) {

174 
	`w¬nšg
("sk: SKP_Sk_SDK_Encode:„‘=%d\n", 
»t
);

177 *
Ën
 = 
nBy‹sOut
;

180 
	}
}

183 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

184 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

186 
št16_t
 
n§mp
 = *
§mpc
;

187 
»t
;

189 
»t
 = 
	`SKP_Sk_SDK_Decode
(
¡
->
dec
,

190 &
¡
->
decCÚŒŞ
,

192 
buf
,

193 ()
Ën
,

194 
§mpv
,

195 &
n§mp
);

196 ià(
»t
) {

197 
	`w¬nšg
("sk: SKP_Sk_SDK_Decode:„‘=%d\n", 
»t
);

200 *
§mpc
 = 
n§mp
;

203 
	}
}

206 
	$¶c
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

208 
št16_t
 
n§mp
 = *
§mpc
;

209 
»t
;

211 
»t
 = 
	`SKP_Sk_SDK_Decode
(
¡
->
dec
,

212 &
¡
->
decCÚŒŞ
,

214 
NULL
,

216 
§mpv
,

217 &
n§mp
);

218 ià(
»t
)

219  
EPROTO
;

221 *
§mpc
 = 
n§mp
;

224 
	}
}

227 
aucodec
 
	gsk
[] = {

229 
LE_INIT
, 0, "SILK", 24000, 24000, 1, 
NULL
,

230 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
¶c
, 0, 0

236 
	$moduË_š™
()

238 
	`debug
("sk: SILK %s\n", 
	`SKP_Sk_SDK_g‘_v”siÚ
());

240 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
sk
[0]);

243 
	}
}

246 
	$moduË_şo£
()

248 
i
 = 
	`ARRAY_SIZE
(
sk
);

250 
i
--)

251 
	`aucodec_uÄegi¡”
(&
sk
[
i
]);

254 
	}
}

257 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
sk
) = {

260 
moduË_š™
,

261 
moduË_şo£


	@baresip/modules/snapshot/png_vf.c

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	#_BSD_SOURCE
 1

	)

9 
	~<¡ršg.h
>

10 
	~<time.h
>

11 
	~<²g.h
>

12 
	~<».h
>

13 
	~<»m.h
>

14 
	~<b¬es.h
>

15 
	~"²g_vf.h
"

18 *
²g_f’ame
(cÚ¡ 
tm
 *
tmx
, cÚ¡ *
Çme
,

19 *
buf
, 
Ëngth
);

20 
²g_§ve_ä“
(
²g_¡ruùp
 
²g_±r
, 
²g_by‹
 **
²g_row_poš‹rs
,

21 
²g_height
);

24 
	$²g_§ve_vidäame
(cÚ¡ 
vidäame
 *
vf
, cÚ¡ *
·th
)

26 
²g_by‹
 **
²g_row_poš‹rs
 = 
NULL
;

27 
²g_by‹
 *
row
;

28 cÚ¡ 
²g_by‹
 *
p
;

29 
²g_by‹
 
»d
, 
g»’
, 
blue
;

30 
²g_¡ruùp
 
²g_±r
 = 
NULL
;

31 
²g_šfİ
 
šfo_±r
 = 
NULL
;

32 
FILE
 *
å
 = 
NULL
;

33 
size_t
 
x
, 
y
;

34 
width
 = 
vf
->
size
.
w
 & ~1;

35 
height
 = 
vf
->
size
.
h
 & ~1;

36 
by‹s_³r_pix–
 = 3;

37 
time_t
 
Šow
;

38 
tm
 *
tmx
;

39 
f’ame_buf
[64];

40 
vidäame
 *
f2
 = 
NULL
;

41 
”r
 = 0;

43 
Šow
 = 
	`time
(
NULL
);

44 
tmx
 = 
	`loÿÉime
(&
Šow
);

46 ià(
vf
->
fmt
 !ğ
VID_FMT_RGB32
) {

48 
”r
 = 
	`vidäame_®loc
(&
f2
, 
VID_FMT_RGB32
, &
vf
->
size
);

49 ià(
”r
)

50 
out
;

52 
	`vidcÚv
(
f2
, 
vf
, 
NULL
);

53 
vf
 = 
f2
;

57 
²g_±r
 = 
	`²g_ü—‹_wr™e_¡ruù
(
PNG_LIBPNG_VER_STRING
,

58 
NULL
, NULL, NULL);

59 ià(
²g_±r
 =ğ
NULL
) {

60 
”r
 = 
ENOMEM
;

61 
out
;

65 
šfo_±r
 = 
	`²g_ü—‹_šfo_¡ruù
(
²g_±r
);

66 ià(
šfo_±r
 =ğ
NULL
) {

67 
”r
 = 
ENOMEM
;

68 
out
;

72 ià(
	`£tjmp
(
	`²g_jmpbuf
(
²g_±r
))) {

73 
”r
 = 
ENOMEM
;

74 
out
;

78 
	`²g_£t_IHDR
(
²g_±r
,

79 
šfo_±r
,

80 
width
,

81 
height
,

83 
PNG_COLOR_TYPE_RGB
,

84 
PNG_INTERLACE_NONE
,

85 
PNG_COMPRESSION_TYPE_DEFAULT
,

86 
PNG_FILTER_TYPE_DEFAULT
);

91 
²g_row_poš‹rs
 = 
	`²g_m®loc
(
²g_±r
,

92 
height
 * (
²g_by‹
 *));

94 
y
 = 0; y < 
height
; ++y) {

95 
²g_row_poš‹rs
[
y
] =

96 (
²g_by‹
 *è
	`²g_m®loc
(
²g_±r
,

97 
width
 * (
ušt8_t
) *

98 
by‹s_³r_pix–
);

101 
p
 = 
vf
->
d©a
[0];

102 
y
 = 0; y < 
height
; ++y) {

104 
row
 = 
²g_row_poš‹rs
[
y
];

106 
x
 = 0; x < 
width
; ++x) {

108 
»d
 = *
p
++;

109 
g»’
 = *
p
++;

110 
blue
 = *
p
++;

112 *
row
++ = 
blue
;

113 *
row
++ = 
g»’
;

114 *
row
++ = 
»d
;

116 ++
p
;

121 
å
 = 
	`fİ’
(
	`²g_f’ame
(
tmx
, 
·th
,

122 
f’ame_buf
, (filename_buf)), "wb");

123 ià(
å
 =ğ
NULL
) {

124 
”r
 = 
”ºo
;

125 
out
;

128 
	`²g_š™_io
(
²g_±r
, 
å
);

129 
	`²g_£t_rows
(
²g_±r
, 
šfo_±r
, 
²g_row_poš‹rs
);

130 
	`²g_wr™e_²g
(
²g_±r
, 
šfo_±r
, 
PNG_TRANSFORM_IDENTITY
, 
NULL
);

132 
	`šfo
("²g: wrÙ%s\n", 
f’ame_buf
);

134 
out
:

136 
	`mem_d”ef
(
f2
);

137 
	`²g_§ve_ä“
(
²g_±r
, 
²g_row_poš‹rs
, 
height
);

138 
	`²g_de¡roy_wr™e_¡ruù
(&
²g_±r
, &
šfo_±r
);

139 ià(
å
)

140 
	`fşo£
(
å
);

143 
	}
}

146 
	$²g_§ve_ä“
(
²g_¡ruùp
 
²g_±r
, 
²g_by‹
 **
²g_row_poš‹rs
,

147 
²g_height
)

149 
y
;

152 ià(
²g_height
 =ğ0 || 
²g_row_poš‹rs
 =ğ
NULL
)

155 
y
 = 0; y < 
²g_height
; y++) {

156 
	`²g_ä“
(
²g_±r
, 
²g_row_poš‹rs
[
y
]);

158 
	`²g_ä“
(
²g_±r
, 
²g_row_poš‹rs
);

159 
	}
}

162 *
	$²g_f’ame
(cÚ¡ 
tm
 *
tmx
, cÚ¡ *
Çme
,

163 *
buf
, 
Ëngth
)

168 ià(
	`¡¾’
(
Çme
è+ 24 >ğ
Ëngth
) {

169 
buf
[0] = '\0';

170  
buf
;

173 
	`¥rštf
(
buf
, (
tmx
->
tm_mÚ
 < 9 ? "%s-%d-0%d" : "%s-%d-%d"), 
Çme
,

174 1900 + 
tmx
->
tm_y—r
,mx->
tm_mÚ
 + 1);

176 
	`¥rštf
(
buf
 + 
	`¡¾’
(buf), (
tmx
->
tm_mday
 < 10 ? "-0%d" : "-%d"),

177 
tmx
->
tm_mday
);

179 
	`¥rštf
(
buf
 + 
	`¡¾’
(buf), (
tmx
->
tm_hour
 < 10 ? "-0%d" : "-%d"),

180 
tmx
->
tm_hour
);

182 
	`¥rštf
(
buf
 + 
	`¡¾’
(buf), (
tmx
->
tm_mš
 < 10 ? "-0%d" : "-%d"),

183 
tmx
->
tm_mš
);

185 
	`¥rštf
(
buf
 + 
	`¡¾’
(buf), (
tmx
->
tm_£c
 < 10 ? "-0%d.png" : "-%d.png"),

186 
tmx
->
tm_£c
);

188  
buf
;

189 
	}
}

	@baresip/modules/snapshot/png_vf.h

6 
²g_§ve_vidäame
(cÚ¡ 
vidäame
 *
vf
, cÚ¡ *
·th
);

	@baresip/modules/snapshot/snapshot.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"²g_vf.h
"

27 
boŞ
 
	gæag_’c
, 
	gæag_dec
;

30 
	$’code
(
vidft_’c_¡
 *
¡
, 
vidäame
 *
äame
)

32 ()
¡
;

34 ià(!
äame
)

37 ià(
æag_’c
) {

38 
æag_’c
 = 
çl£
;

39 
	`²g_§ve_vidäame
(
äame
, "snapshot-send");

43 
	}
}

46 
	$decode
(
vidft_dec_¡
 *
¡
, 
vidäame
 *
äame
)

48 ()
¡
;

50 ià(!
äame
)

53 ià(
æag_dec
) {

54 
æag_dec
 = 
çl£
;

55 
	`²g_§ve_vidäame
(
äame
, "snapshot-recv");

59 
	}
}

62 
	$do_¢­shÙ
(
»_´štf
 *
pf
, *
¬g
)

64 ()
pf
;

65 ()
¬g
;

68 
æag_’c
 = 
æag_dec
 = 
Œue
;

71 
	}
}

74 
vidft
 
	g¢­shÙ
 = {

75 
LE_INIT
, "¢­shÙ", 
NULL
, 
’code
, NULL, 
decode
,

79 cÚ¡ 
cmd
 
	gcmdv
[] = {

80 {"¢­shÙ", 0, 0, "TakvideØ¢­shÙ", 
do_¢­shÙ
 },

84 
	$moduË_š™
()

86 
	`vidft_»gi¡”
(
	`b¬es_vidf
(), &
¢­shÙ
);

87  
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

88 
	}
}

91 
	$moduË_şo£
()

93 
	`vidft_uÄegi¡”
(&
¢­shÙ
);

94 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

96 
	}
}

99 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¢­shÙ
) = {

102 
moduË_š™
,

103 
moduË_şo£


	@baresip/modules/sndfile/sndfile.c

6 
	~<¢dfe.h
>

7 
	~<time.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

24 
	s¢dfe_’c
 {

25 
auft_’c_¡
 
	maf
;

26 
SNDFILE
 *
	m’c
;

29 
	s¢dfe_dec
 {

30 
auft_dec_¡
 
	maf
;

31 
SNDFILE
 *
	mdec
;

34 
	gfe_·th
[256] = ".";

37 
	$time¡amp_´št
(
»_´štf
 *
pf
, cÚ¡ 
tm
 *tm)

39 ià(!
tm
)

42  
	`»_h´štf
(
pf
, "%d-%02d-%02d-%02d-%02d-%02d",

43 1900 + 
tm
->
tm_y—r
,m->
tm_mÚ
 + 1,m->
tm_mday
,

44 
tm
->
tm_hour
,m->
tm_mš
,m->
tm_£c
);

45 
	}
}

48 
	$’c_de¡ruùÜ
(*
¬g
)

50 
¢dfe_’c
 *
¡
 = 
¬g
;

52 ià(
¡
->
’c
)

53 
	`sf_şo£
(
¡
->
’c
);

55 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

56 
	}
}

59 
	$dec_de¡ruùÜ
(*
¬g
)

61 
¢dfe_dec
 *
¡
 = 
¬g
;

63 ià(
¡
->
dec
)

64 
	`sf_şo£
(
¡
->
dec
);

66 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

67 
	}
}

70 
SNDFILE
 *
	$İ’fe
(cÚ¡ 
auft_´m
 *
´m
, 
boŞ
 
’c
)

72 
f’ame
[128];

73 
SF_INFO
 
sfšfo
;

74 
time_t
 
Šow
 = 
	`time
(0);

75 
tm
 *tm = 
	`loÿÉime
(&
Šow
);

76 
SNDFILE
 *
sf
;

78 ()
	`»_¢´štf
(
f’ame
, (filename),

80 
fe_·th
,

81 
time¡amp_´št
, 
tm
, 
’c
 ? "enc" : "dec");

83 
sfšfo
.
§m¶”©e
 = 
´m
->
¤©e
;

84 
sfšfo
.
chªÃls
 = 
´m
->
ch
;

85 
sfšfo
.
fÜm©
 = 
SF_FORMAT_WAV
 | 
SF_FORMAT_PCM_16
;

87 
sf
 = 
	`sf_İ’
(
f’ame
, 
SFM_WRITE
, &
sfšfo
);

88 ià(!
sf
) {

89 
	`w¬nšg
("¢dfe: could‚Ù o³n: %s\n", 
f’ame
);

90 
	`puts
(
	`sf_¡»¼Ü
(
NULL
));

91  
NULL
;

94 
	`šfo
("sndfile: dumping %s‡udioo %s\n",

95 
’c
 ? "’code" : "decode", 
f’ame
);

97  
sf
;

98 
	}
}

101 
	$’code_upd©e
(
auft_’c_¡
 **
¡p
, **
ùx
,

102 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

104 
¢dfe_’c
 *
¡
;

105 
”r
 = 0;

106 ()
ùx
;

107 ()
af
;

109 
¡
 = 
	`mem_z®loc
((*¡), 
’c_de¡ruùÜ
);

110 ià(!
¡
)

111  
EINVAL
;

113 
¡
->
’c
 = 
	`İ’fe
(
´m
, 
Œue
);

114 ià(!
¡
->
’c
)

115 
”r
 = 
ENOMEM
;

117 ià(
”r
)

118 
	`mem_d”ef
(
¡
);

120 *
¡p
 = (
auft_’c_¡
 *)
¡
;

122  
”r
;

123 
	}
}

126 
	$decode_upd©e
(
auft_dec_¡
 **
¡p
, **
ùx
,

127 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

129 
¢dfe_dec
 *
¡
;

130 
”r
 = 0;

131 ()
ùx
;

132 ()
af
;

134 
¡
 = 
	`mem_z®loc
((*¡), 
dec_de¡ruùÜ
);

135 ià(!
¡
)

136  
EINVAL
;

138 
¡
->
dec
 = 
	`İ’fe
(
´m
, 
çl£
);

139 ià(!
¡
->
dec
)

140 
”r
 = 
ENOMEM
;

142 ià(
”r
)

143 
	`mem_d”ef
(
¡
);

145 *
¡p
 = (
auft_dec_¡
 *)
¡
;

147  
”r
;

148 
	}
}

151 
	$’code
(
auft_’c_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

153 
¢dfe_’c
 *
sf
 = (¢dfe_’ø*)
¡
;

155 
	`sf_wr™e_shÜt
(
sf
->
’c
, 
§mpv
, *
§mpc
);

158 
	}
}

161 
	$decode
(
auft_dec_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

163 
¢dfe_dec
 *
sf
 = (¢dfe_deø*)
¡
;

165 
	`sf_wr™e_shÜt
(
sf
->
dec
, 
§mpv
, *
§mpc
);

168 
	}
}

171 
auft
 
	g¢dfe
 = {

172 
LE_INIT
, "¢dfe", 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode


176 
	$moduË_š™
()

178 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
¢dfe
);

180 
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "¢d_·th", 
fe_·th
, (file_path));

182 
	`šfo
("¢dfe: savšg fe š %s\n", 
fe_·th
);

185 
	}
}

188 
	$moduË_şo£
()

190 
	`auft_uÄegi¡”
(&
¢dfe
);

192 
	}
}

195 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¢dfe
) = {

198 
moduË_š™
,

199 
moduË_şo£


	@baresip/modules/sndio/sndio.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<¢dio.h
>

9 
	~<±h»ad.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

22 
	sau¤c_¡
 {

23 cÚ¡ 
au¤c
 *
	mas
;

24 
sio_hdl
 *
	mhdl
;

25 
±h»ad_t
 
	mth»ad
;

26 
št16_t
 *
	m§mpv
;

27 
size_t
 
	m§mpc
;

28 
	mrun
;

29 
au¤c_»ad_h
 *
	mrh
;

30 *
	m¬g
;

33 
	sau¶ay_¡
 {

34 cÚ¡ 
au¶ay
 *
	m­
;

35 
sio_hdl
 *
	mhdl
;

36 
±h»ad_t
 
	mth»ad
;

37 
št16_t
 *
	m§mpv
;

38 
size_t
 
	m§mpc
;

39 
	mrun
;

40 
au¶ay_wr™e_h
 *
	mwh
;

41 *
	m¬g
;

44 
au¤c
 *
	gau¤c
;

45 
au¶ay
 *
	gau¶ay
;

48 
sio_·r
 *
	$¢dio_š™·r
(
ušt32_t
 
¤©e
, 
ušt8_t
 
ch
)

50 
sio_·r
 *
·r
 = 
NULL
;

52 ià((
·r
 = 
	`mem_z®loc
((*·r), 
NULL
)) == NULL)

53  
NULL
;

55 
	`sio_š™·r
(
·r
);

58 
·r
->
b™s
 = 16;

59 
·r
->
bps
 = 
	`SIO_BPS
Õ¬->
b™s
);

60 
·r
->
sig
 = 1;

61 
·r
->
Ë
 = 
SIO_LE_NATIVE
;

63 
·r
->
rchª
 = 
ch
;

64 
·r
->
pchª
 = 
ch
;

65 
·r
->
¿‹
 = 
¤©e
;

67  
·r
;

68 
	}
}

71 *
	$»ad_th»ad
(*
¬g
)

73 
au¤c_¡
 *
¡
 = 
¬g
;

75 ià(!
	`sio_¡¬t
(
¡
->
hdl
)) {

76 
	`w¬nšg
("sndio: could‚ot start„ecord\n");

77 
out
;

80 
¡
->
run
) {

81 
size_t
 
n
 = 
	`sio_»ad
(
¡
->
hdl
, st->
§mpv
, st->
§mpc
*2);

82 
¡
->
	`rh
(¡->
§mpv
, 
n
/2, st->
¬g
);

85 
out
:

86  
NULL
;

87 
	}
}

90 *
	$wr™e_th»ad
(*
¬g
)

92 
au¶ay_¡
 *
¡
 = 
¬g
;

94 ià(!
	`sio_¡¬t
(
¡
->
hdl
)) {

95 
	`w¬nšg
("sndio: could‚ot start…layback\n");

96 
out
;

99 
¡
->
run
) {

100 
¡
->
	`wh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

101 
	`sio_wr™e
(
¡
->
hdl
, st->
§mpv
, st->
§mpc
*2);

104 
out
:

105  
NULL
;

106 
	}
}

109 
	$au¤c_de¡ruùÜ
(*
¬g
)

111 
au¤c_¡
 *
¡
 = 
¬g
;

113 ià(
¡
->
run
) {

114 
¡
->
run
 = 
çl£
;

115 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

118 ià(
¡
->
hdl
)

119 
	`sio_şo£
(
¡
->
hdl
);

121 
	`mem_d”ef
(
¡
->
§mpv
);

122 
	}
}

125 
	$au¶ay_de¡ruùÜ
(*
¬g
)

127 
au¶ay_¡
 *
¡
 = 
¬g
;

129 ià(
¡
->
run
) {

130 
¡
->
run
 = 
çl£
;

131 ()
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

134 ià(
¡
->
hdl
)

135 
	`sio_şo£
(
¡
->
hdl
);

137 
	`mem_d”ef
(
¡
->
§mpv
);

138 
	}
}

141 
	$¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

142 
medŸ_ùx
 **
ùx
,

143 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

144 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

146 
au¤c_¡
 *
¡
;

147 
sio_·r
 *
·r
 = 
NULL
;

148 
”r
;

149 cÚ¡ *
Çme
;

151 ()
ùx
;

152 ()
”rh
;

154 ià(!
¡p
 || !
as
 || !
´m
)

155  
EINVAL
;

157 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

158 
	`w¬nšg
("sndio: source: unsupported sample format (%s)\n",

159 
	`aufmt_Çme
(
´m
->
fmt
));

160  
ENOTSUP
;

163 
Çme
 = (
	`¡r_is£t
(
deviû
)è? deviû : 
SIO_DEVANY
;

165 ià((
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
)è=ğ
NULL
)

166  
ENOMEM
;

168 
¡
->
as
 =‡s;

169 
¡
->
rh
 =„h;

170 
¡
->
¬g
 =‡rg;

171 
¡
->
hdl
 = 
	`sio_İ’
(
Çme
, 
SIO_REC
, 0);

173 ià(!
¡
->
hdl
) {

174 
	`w¬nšg
("¢dio: could‚Ù o³Àau¤ødeviû '%s'\n", 
Çme
);

175 
”r
 = 
EINVAL
;

176 
out
;

179 
·r
 = 
	`¢dio_š™·r
(
´m
->
¤©e
,…rm->
ch
);

180 ià(!
·r
) {

181 
”r
 = 
ENOMEM
;

182 
out
;

185 ià(!
	`sio_£¬
(
¡
->
hdl
, 
·r
)) {

186 
”r
 = 
EINVAL
;

187 
out
;

190 ià(!
	`sio_g‘·r
(
¡
->
hdl
, 
·r
)) {

191 
”r
 = 
EINVAL
;

192 
out
;

195 
¡
->
§mpc
 = 
·r
->
bufsz
 / 2;

197 
¡
->
§mpv
 = 
	`mem_®loc
(2 * st->
§mpc
, 
NULL
);

198 ià(!
¡
->
§mpv
) {

199 
”r
 = 
ENOMEM
;

200 
out
;

203 
¡
->
run
 = 
Œue
;

204 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

205 ià(
”r
)

206 
¡
->
run
 = 
çl£
;

208 
out
:

209 
	`mem_d”ef
(
·r
);

210 ià(
”r
)

211 
	`mem_d”ef
(
¡
);

213 *
¡p
 = 
¡
;

215  
”r
;

216 
	}
}

219 
	$¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

220 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

221 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

223 
au¶ay_¡
 *
¡
;

224 
sio_·r
 *
·r
 = 
NULL
;

225 
”r
;

226 cÚ¡ *
Çme
;

228 ià(!
¡p
 || !
­
 || !
´m
)

229  
EINVAL
;

231 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

232 
	`w¬nšg
("sndio:…layback: unsupported sample format (%s)\n",

233 
	`aufmt_Çme
(
´m
->
fmt
));

234  
ENOTSUP
;

237 
Çme
 = (
	`¡r_is£t
(
deviû
)è? deviû : 
SIO_DEVANY
;

239 ià((
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
)è=ğ
NULL
)

240  
ENOMEM
;

242 
¡
->
­
 =‡p;

243 
¡
->
wh
 = wh;

244 
¡
->
¬g
 =‡rg;

245 
¡
->
hdl
 = 
	`sio_İ’
(
Çme
, 
SIO_PLAY
, 0);

247 ià(!
¡
->
hdl
) {

248 
	`w¬nšg
("¢dio: could‚Ù o³Àau¶ay deviû '%s'\n", 
Çme
);

249 
”r
 = 
EINVAL
;

250 
out
;

253 
·r
 = 
	`¢dio_š™·r
(
´m
->
¤©e
,…rm->
ch
);

254 ià(!
·r
) {

255 
”r
 = 
ENOMEM
;

256 
out
;

259 ià(!
	`sio_£¬
(
¡
->
hdl
, 
·r
)) {

260 
”r
 = 
EINVAL
;

261 
out
;

264 ià(!
	`sio_g‘·r
(
¡
->
hdl
, 
·r
)) {

265 
”r
 = 
EINVAL
;

266 
out
;

269 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

271 
¡
->
§mpv
 = 
	`mem_®loc
(2 * st->
§mpc
, 
NULL
);

272 ià(!
¡
->
§mpv
) {

273 
”r
 = 
ENOMEM
;

274 
out
;

277 
¡
->
run
 = 
Œue
;

278 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
wr™e_th»ad
, st);

279 ià(
”r
)

280 
¡
->
run
 = 
çl£
;

282 
out
:

283 
	`mem_d”ef
(
·r
);

284 ià(
”r
)

285 
	`mem_d”ef
(
¡
);

287 *
¡p
 = 
¡
;

289  
”r
;

290 
	}
}

293 
	$¢dio_š™
()

295 
”r
 = 0;

297 
”r
 |ğ
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(), "¢dio", 
¤c_®loc
);

298 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

299 "¢dio", 
¶ay_®loc
);

301  
”r
;

302 
	}
}

305 
	$¢dio_şo£
()

307 
au¤c
 = 
	`mem_d”ef
(ausrc);

308 
au¶ay
 = 
	`mem_d”ef
(auplay);

311 
	}
}

314 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¢dio
) = {

317 
¢dio_š™
,

318 
¢dio_şo£


	@baresip/modules/speex/speex.c

6 
	~<¡dlib.h
>

7 
	~<¥“x/¥“x.h
>

8 
	~<¥“x/¥“x_¡”eo.h
>

9 
	~<¥“x/¥“x_ÿÎbacks.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

24 
	mMIN_FRAME_SIZE
 = 43,

25 
	mSPEEX_PTIME
 = 20,

29 
	sau’c_¡©e
 {

30 *
	m’c
;

31 
S³exB™s
 
	mb™s
;

33 
ušt32_t
 
	mäame_size
;

34 
ušt8_t
 
	mchªÃls
;

38 
	saudec_¡©e
 {

39 *
	mdec
;

40 
S³exB™s
 
	mb™s
;

41 
S³exS‹»oS‹
 
	m¡”eo
;

42 
S³exC®lback
 
	mÿÎback
;

44 
ušt32_t
 
	mäame_size
;

45 
ušt8_t
 
	mchªÃls
;

49 
	g¥“x_fm_nb
[128];

50 
	g¥“x_fm_wb
[128];

55 
	mqu®™y
;

56 
	mcom¶ex™y
;

57 
	m’hªûm’t
;

58 
	mmode_nb
;

59 
	mmode_wb
;

60 
	mvbr
;

61 
	mvad
;

62 } 
	gscÚf
 = {

73 
	$’code_de¡ruùÜ
(*
¬g
)

75 
au’c_¡©e
 *
¡
 = 
¬g
;

77 
	`¥“x_b™s_de¡roy
(&
¡
->
b™s
);

78 
	`¥“x_’cod”_de¡roy
(
¡
->
’c
);

79 
	}
}

82 
	$decode_de¡ruùÜ
(*
¬g
)

84 
audec_¡©e
 *
¡
 = 
¬g
;

86 
	`¥“x_b™s_de¡roy
(&
¡
->
b™s
);

87 
	`¥“x_decod”_de¡roy
(
¡
->
dec
);

88 
	}
}

91 
	$’cod”_cÚfig
(*
¡
)

93 
»t
;

95 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
, 
SPEEX_SET_QUALITY
, &
scÚf
.
qu®™y
);

96 ià(
»t
) {

97 
	`w¬nšg
("¥“x: SPEEX_SET_QUALITY: %d\n", 
»t
);

100 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
, 
SPEEX_SET_COMPLEXITY
, &
scÚf
.
com¶ex™y
);

101 ià(
»t
) {

102 
	`w¬nšg
("¥“x: SPEEX_SET_COMPLEXITY: %d\n", 
»t
);

105 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
, 
SPEEX_SET_VBR
, &
scÚf
.
vbr
);

106 ià(
»t
) {

107 
	`w¬nšg
("¥“x: SPEEX_SET_VBR: %d\n", 
»t
);

110 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
, 
SPEEX_SET_VAD
, &
scÚf
.
vad
);

111 ià(
»t
) {

112 
	`w¬nšg
("¥“x: SPEEX_SET_VAD: %d\n", 
»t
);

114 
	}
}

117 
	$decod”_cÚfig
(*
¡
)

119 
»t
;

121 
»t
 = 
	`¥“x_decod”_ùl
(
¡
, 
SPEEX_SET_ENH
, &
scÚf
.
’hªûm’t
);

122 ià(
»t
) {

123 
	`w¬nšg
("¥“x: SPEEX_SET_ENH: %d\n", 
»t
);

125 
	}
}

128 
	$decode_·¿m
(
au’c_¡©e
 *
¡
, cÚ¡ 
¶
 *
Çme
,

129 cÚ¡ 
¶
 *
v®
)

131 
»t
;

138 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "mode")) {

139 
¶
 
v
;

140 
mode
;

143 ià(
	`»_»gex
(
v®
->
p
, v®->
l
, "\"[^\"]+\"", &
v
))

144 
v
 = *
v®
;

146 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
v
, "any"))

149 
mode
 = 
	`¶_u32
(&
v
);

151 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
->
’c
, 
SPEEX_SET_MODE
, &
mode
);

152 ià(
»t
) {

153 
	`w¬nšg
("¥“x: SPEEX_SET_MODE:„‘=%d\n", 
»t
);

157 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "vbr")) {

158 
vbr
 = 0, 
vad
 = 0;

160 ià(0 =ğ
	`¶_¡rÿ£cmp
(
v®
, "on"))

161 
vbr
 = 1;

162 ià(0 =ğ
	`¶_¡rÿ£cmp
(
v®
, "off"))

163 
vbr
 = 0;

164 ià(0 =ğ
	`¶_¡rÿ£cmp
(
v®
, "vad"))

165 
vad
 = 1;

167 
	`w¬nšg
("¥“x: inv®id vb¸v®u%r\n", 
v®
);

170 
	`debug
("¥“x: s‘tšg VBR=%d VAD=%d\n", 
vbr
, 
vad
);

171 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
->
’c
, 
SPEEX_SET_VBR
, &
vbr
);

172 ià(
»t
) {

173 
	`w¬nšg
("¥“x: SPEEX_SET_VBR:„‘=%d\n", 
»t
);

175 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
->
’c
, 
SPEEX_SET_VAD
, &
vad
);

176 ià(
»t
) {

177 
	`w¬nšg
("¥“x: SPEEX_SET_VAD:„‘=%d\n", 
»t
);

180 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, "cng")) {

181 
dtx
 = 0;

183 ià(0 =ğ
	`¶_¡rÿ£cmp
(
v®
, "on"))

184 
dtx
 = 0;

185 ià(0 =ğ
	`¶_¡rÿ£cmp
(
v®
, "off"))

186 
dtx
 = 1;

188 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
->
’c
, 
SPEEX_SET_DTX
, &
dtx
);

189 ià(
»t
) {

190 
	`w¬nšg
("¥“x: SPEEX_SET_DTX:„‘=%d\n", 
»t
);

194 
	`debug
("¥“x: unknowÀS³ex…¬am: %r=%r\n", 
Çme
, 
v®
);

198 
	}
}

201 
	$·¿m_hªdËr
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

202 *
¬g
)

204 
au’c_¡©e
 *
¡
 = 
¬g
;

206 
	`decode_·¿m
(
¡
, 
Çme
, 
v®
);

207 
	}
}

210 cÚ¡ 
S³exMode
 *
	$»sŞve_mode
(
ušt32_t
 
¤©e
)

212 
¤©e
) {

215 8000:  &
¥“x_nb_mode
;

216 16000:  &
¥“x_wb_mode
;

217 32000:  &
¥“x_uwb_mode
;

219 
	}
}

222 
	$’code_upd©e
(
au’c_¡©e
 **
«¥
, cÚ¡ 
aucodec
 *
ac
,

223 
au’c_·¿m
 *
´m
, cÚ¡ *
fm
)

225 
au’c_¡©e
 *
¡
;

226 
»t
, 
”r
 = 0;

228 ià(!
«¥
 || !
ac
 || !
´m
)

229  
EINVAL
;

230 ià(
´m
->
±ime
 !ğ
SPEEX_PTIME
)

231  
EPROTO
;

232 ià(*
«¥
)

235 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

236 ià(!
¡
)

237  
ENOMEM
;

239 
¡
->
äame_size
 = 
ac
->
¤©e
 * 
SPEEX_PTIME
 / 1000;

240 
¡
->
chªÃls
 = 
ac
->
ch
;

243 
¡
->
’c
 = 
	`¥“x_’cod”_š™
(
	`»sŞve_mode
(
ac
->
¤©e
));

244 ià(!
¡
->
’c
) {

245 
”r
 = 
ENOMEM
;

246 
out
;

249 
	`¥“x_b™s_š™
(&
¡
->
b™s
);

251 
	`’cod”_cÚfig
(
¡
->
’c
);

253 
»t
 = 
	`¥“x_’cod”_ùl
(
¡
->
’c
, 
SPEEX_GET_FRAME_SIZE
,

254 &
¡
->
äame_size
);

255 ià(
»t
) {

256 
	`w¬nšg
("¥“x: SPEEX_GET_FRAME_SIZE: %d\n", 
»t
);

259 ià(
	`¡r_is£t
(
fm
)) {

260 
¶
 
·¿ms
;

262 
	`¶_£t_¡r
(&
·¿ms
, 
fm
);

264 
	`fmt_·¿m_­¶y
(&
·¿ms
, 
·¿m_hªdËr
, 
¡
);

267 
out
:

268 ià(
”r
)

269 
	`mem_d”ef
(
¡
);

271 *
«¥
 = 
¡
;

273  
”r
;

274 
	}
}

277 
	$decode_upd©e
(
audec_¡©e
 **
ad¥
,

278 cÚ¡ 
aucodec
 *
ac
, cÚ¡ *
fm
)

280 
audec_¡©e
 *
¡
;

281 
”r
 = 0;

282 ()
fm
;

284 ià(!
ad¥
 || !
ac
)

285  
EINVAL
;

286 ià(*
ad¥
)

289 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

290 ià(!
¡
)

291  
ENOMEM
;

293 
¡
->
äame_size
 = 
ac
->
¤©e
 * 
SPEEX_PTIME
 / 1000;

294 
¡
->
chªÃls
 = 
ac
->
ch
;

297 
¡
->
dec
 = 
	`¥“x_decod”_š™
(
	`»sŞve_mode
(
ac
->
¤©e
));

298 ià(!
¡
->
dec
) {

299 
”r
 = 
ENOMEM
;

300 
out
;

303 
	`¥“x_b™s_š™
(&
¡
->
b™s
);

305 ià(2 =ğ
¡
->
chªÃls
) {

308 
¡
->
¡”eo
.
b®ªû
 = 1;

309 
¡
->
¡”eo
.
e_¿tio
 = .5f;

310 
¡
->
¡”eo
.
smoÙh_Ëá
 = 1;

311 
¡
->
¡”eo
.
smoÙh_right
 = 1;

313 
¡
->
ÿÎback
.
ÿÎback_id
 = 
SPEEX_INBAND_STEREO
;

314 
¡
->
ÿÎback
.
func
 = 
¥“x_¡d_¡”eo_»que¡_hªdËr
;

315 
¡
->
ÿÎback
.
d©a
 = &¡->
¡”eo
;

316 
	`¥“x_decod”_ùl
(
¡
->
dec
, 
SPEEX_SET_HANDLER
,

317 &
¡
->
ÿÎback
);

320 
	`decod”_cÚfig
(
¡
->
dec
);

322 
out
:

323 ià(
”r
)

324 
	`mem_d”ef
(
¡
);

326 *
ad¥
 = 
¡
;

328  
”r
;

329 
	}
}

332 
	$’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
,

333 
size_t
 *
Ën
, cÚ¡ 
št16_t
 *
§mpv
, size_ˆ
§mpc
)

335 cÚ¡ 
size_t
 
n
 = 
¡
->
chªÃls
 * st->
äame_size
;

336 
»t
, 
r
;

338 ià(*
Ën
 < 128)

339  
ENOMEM
;

342 ià(!
§mpv
 || !
§mpc
) {

344 
	`¥“x_b™s_·ck
(&
¡
->
b™s
, 0, 5);

345 
out
;

349 
§mpc
 > 0) {

352 ià(2 =ğ
¡
->
chªÃls
) {

353 
	`¥“x_’code_¡”eo_št
((
št16_t
 *)
§mpv
,

354 
¡
->
äame_size
, &¡->
b™s
);

357 
»t
 = 
	`¥“x_’code_št
(
¡
->
’c
, (
št16_t
 *)
§mpv
, &¡->
b™s
);

358 ià(1 !ğ
»t
) {

359 
	`w¬nšg
("¥“x: s³ex_’code_št:„‘=%d\n", 
»t
);

362 
§mpc
 -ğ
n
;

363 
§mpv
 +ğ
n
;

366 
out
:

368 
	`¥“x_b™s_·ck
(&
¡
->
b™s
, 15, 5);

370 
r
 = 
	`¥“x_b™s_wr™e
(&
¡
->
b™s
, (*)
buf
, ()*
Ën
);

371 *
Ën
 = 
r
;

373 
	`¥“x_b™s_»£t
(&
¡
->
b™s
);

376 
	}
}

379 
	$decode
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
,

380 
size_t
 *
§mpc
, cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
Ën
)

382 cÚ¡ 
size_t
 
n
 = 
¡
->
chªÃls
 * st->
äame_size
;

383 
size_t
 
i
 = 0;

386 
	`¥“x_b™s_»ad_äom
(&
¡
->
b™s
, (*)
buf
, ()
Ën
);

389 
	`¥“x_b™s_»maššg
(&
¡
->
b™s
è>ğ
MIN_FRAME_SIZE
) {

390 
»t
;

392 ià(*
§mpc
 < 
n
)

393  
ENOMEM
;

395 
»t
 = 
	`¥“x_decode_št
(
¡
->
dec
, &¡->
b™s
,

396 (
št16_t
 *)&
§mpv
[
i
]);

397 ià(
»t
 < 0) {

398 ià(-1 =ğ
»t
) {

400 ià(-2 =ğ
»t
) {

401 
	`w¬nšg
("speex: decode: corrupt stream\n");

404 
	`w¬nšg
("speex: decode: speex_decode_int:"

405 "„‘=%d\n", 
»t
);

412 ià(2 =ğ
¡
->
chªÃls
) {

413 
	`¥“x_decode_¡”eo_št
((
št16_t
 *)&
§mpv
[
i
],

414 
¡
->
äame_size
,

415 &
¡
->
¡”eo
);

418 
i
 +ğ
n
;

419 *
§mpc
 -ğ
n
;

422 *
§mpc
 = 
i
;

425 
	}
}

428 
	$pkloss
(
audec_¡©e
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

430 cÚ¡ 
size_t
 
n
 = 
¡
->
chªÃls
 * st->
äame_size
;

432 ià(*
§mpc
 < 
n
)

433  
ENOMEM
;

436 
	`¥“x_decode_št
(
¡
->
dec
, 
NULL
, 
§mpv
);

437 *
§mpc
 = 
n
;

440 
	}
}

443 
	$cÚfig_·r£
(
cÚf
 *conf)

445 
ušt32_t
 
v
;

447 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_qu®™y", &
v
))

448 
scÚf
.
qu®™y
 = 
v
;

449 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_com¶ex™y", &
v
))

450 
scÚf
.
com¶ex™y
 = 
v
;

451 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_’hªûm’t", &
v
))

452 
scÚf
.
’hªûm’t
 = 
v
;

453 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_mode_nb", &
v
))

454 
scÚf
.
mode_nb
 = 
v
;

455 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_mode_wb", &
v
))

456 
scÚf
.
mode_wb
 = 
v
;

457 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_vbr", &
v
))

458 
scÚf
.
vbr
 = 
v
;

459 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_vad", &
v
))

460 
scÚf
.
vad
 = 
v
;

461 
	}
}

464 
aucodec
 
	g¥“xv
[] = {

467 {
LE_INIT
, 0, "¥“x", 32000, 32000, 2, 
¥“x_fm_wb
,

468 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

469 {
LE_INIT
, 0, "¥“x", 16000, 16000, 2, 
¥“x_fm_wb
,

470 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

471 {
LE_INIT
, 0, "¥“x", 8000, 8000, 2, 
¥“x_fm_nb
,

472 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

475 {
LE_INIT
, 0, "¥“x", 32000, 32000, 1, 
¥“x_fm_wb
,

476 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

477 {
LE_INIT
, 0, "¥“x", 16000, 16000, 1, 
¥“x_fm_wb
,

478 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

479 {
LE_INIT
, 0, "¥“x", 8000, 8000, 1, 
¥“x_fm_nb
,

480 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode
, 
pkloss
, 0, 0},

484 
	$¥“x_š™
()

486 
size_t
 
i
;

488 
	`cÚfig_·r£
(
	`cÚf_cur
());

490 ()
	`»_¢´štf
(
¥“x_fm_nb
, (speex_fmtp_nb),

491 "mode=\"%d\";vbr=%s;úg=Ú", 
scÚf
.
mode_nb
,

492 
scÚf
.
vad
 ? "vad" : (scÚf.
vbr
 ? "on" : "off"));

494 ()
	`»_¢´štf
(
¥“x_fm_wb
, (speex_fmtp_wb),

495 "mode=\"%d\";vbr=%s;úg=Ú", 
scÚf
.
mode_wb
,

496 
scÚf
.
vad
 ? "vad" : (scÚf.
vbr
 ? "on" : "off"));

498 
i
=0; i<
	`ARRAY_SIZE
(
¥“xv
); i++)

499 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
¥“xv
[
i
]);

502 
	}
}

505 
	$¥“x_şo£
()

507 
size_t
 
i
;

508 
i
=0; i<
	`ARRAY_SIZE
(
¥“xv
); i++)

509 
	`aucodec_uÄegi¡”
(&
¥“xv
[
i
]);

511 
	}
}

514 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¥“x
) = {

517 
¥“x_š™
,

518 
¥“x_şo£


	@baresip/modules/speex_aec/speex_aec.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<¥“x/¥“x.h
>

9 
	~<¥“x/¥“x_echo.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

21 
	s¥“x_¡
 {

22 
št16_t
 *
	mout
;

23 
S³exEchoS‹
 *
	m¡©e
;

26 
	s’c_¡
 {

27 
auft_’c_¡
 
	maf
;

28 
¥“x_¡
 *
	m¡
;

31 
	sdec_¡
 {

32 
auft_dec_¡
 
	maf
;

33 
¥“x_¡
 *
	m¡
;

37 
	$’c_de¡ruùÜ
(*
¬g
)

39 
’c_¡
 *
¡
 = 
¬g
;

41 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

42 
	`mem_d”ef
(
¡
->st);

43 
	}
}

46 
	$dec_de¡ruùÜ
(*
¬g
)

48 
dec_¡
 *
¡
 = 
¬g
;

50 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

51 
	`mem_d”ef
(
¡
->st);

52 
	}
}

55 #ifdeà
SPEEX_SET_VBR_MAX_BITRATE


56 
	$¥“x_«c_de¡ruùÜ
(*
¬g
)

58 
¥“x_¡
 *
¡
 = 
¬g
;

60 ià(
¡
->
¡©e
)

61 
	`¥“x_echo_¡©e_de¡roy
(
¡
->
¡©e
);

63 
	`mem_d”ef
(
¡
->
out
);

64 
	}
}

67 
	$«c_®loc
(
¥“x_¡
 **
¡p
, **
ùx
, 
auft_´m
 *
´m
)

69 
¥“x_¡
 *
¡
;

70 
ušt32_t
 
§mpc
;

71 
”r
, 
tmp
, 
æ
;

73 ià(!
¡p
 || !
ùx
 || !
´m
)

74  
EINVAL
;

76 ià(*
ùx
) {

77 *
¡p
 = 
	`mem_»f
(*
ùx
);

81 
¡
 = 
	`mem_z®loc
((*¡), 
¥“x_«c_de¡ruùÜ
);

82 ià(!
¡
)

83  
ENOMEM
;

85 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

87 
¡
->
out
 = 
	`mem_®loc
(2 * 
§mpc
, 
NULL
);

88 ià(!
¡
->
out
) {

89 
”r
 = 
ENOMEM
;

90 
out
;

94 
æ
 = 10 * 
§mpc
;

95 
¡
->
¡©e
 = 
	`¥“x_echo_¡©e_š™
(
§mpc
, 
æ
);

96 ià(!
¡
->
¡©e
) {

97 
”r
 = 
ENOMEM
;

98 
out
;

101 
tmp
 = 
´m
->
¤©e
;

102 
”r
 = 
	`¥“x_echo_ùl
(
¡
->
¡©e
, 
SPEEX_ECHO_SET_SAMPLING_RATE
, &
tmp
);

103 ià(
”r
 < 0) {

104 
	`w¬nšg
("¥“x_«c: s³ex_echo_ùl:ƒ¼=%d\n", 
”r
);

107 
	`šfo
("¥“x_«c: S³ex AEC†ßded: s¿‹ = %uHz\n", 
´m
->
¤©e
);

109 
out
:

110 ià(
”r
)

111 
	`mem_d”ef
(
¡
);

113 *
ùx
 = *
¡p
 = 
¡
;

115  
”r
;

116 
	}
}

119 
	$’code_upd©e
(
auft_’c_¡
 **
¡p
, **
ùx
,

120 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

122 
’c_¡
 *
¡
;

123 
”r
;

125 ià(!
¡p
 || !
ùx
 || !
af
 || !
´m
)

126  
EINVAL
;

128 ià(*
¡p
)

131 
¡
 = 
	`mem_z®loc
((*¡), 
’c_de¡ruùÜ
);

132 ià(!
¡
)

133  
ENOMEM
;

135 
”r
 = 
	`«c_®loc
(&
¡
->¡, 
ùx
, 
´m
);

137 ià(
”r
)

138 
	`mem_d”ef
(
¡
);

140 *
¡p
 = (
auft_’c_¡
 *)
¡
;

142  
”r
;

143 
	}
}

146 
	$decode_upd©e
(
auft_dec_¡
 **
¡p
, **
ùx
,

147 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

149 
dec_¡
 *
¡
;

150 
”r
;

152 ià(!
¡p
 || !
ùx
 || !
af
 || !
´m
)

153  
EINVAL
;

155 ià(*
¡p
)

158 
¡
 = 
	`mem_z®loc
((*¡), 
dec_de¡ruùÜ
);

159 ià(!
¡
)

160  
ENOMEM
;

162 
”r
 = 
	`«c_®loc
(&
¡
->¡, 
ùx
, 
´m
);

164 ià(
”r
)

165 
	`mem_d”ef
(
¡
);

167 *
¡p
 = (
auft_dec_¡
 *)
¡
;

169  
”r
;

170 
	}
}

173 
	$’code
(
auft_’c_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

175 
’c_¡
 *
e¡
 = (’c_¡ *)
¡
;

176 
¥“x_¡
 *
¥
 = 
e¡
->
¡
;

178 ià(*
§mpc
) {

179 
	`¥“x_echo_ÿ±u»
(
¥
->
¡©e
, 
§mpv
, sp->
out
);

180 
	`memıy
(
§mpv
, 
¥
->
out
, *
§mpc
 * 2);

184 
	}
}

187 
	$decode
(
auft_dec_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

189 
dec_¡
 *
d¡
 = (dec_¡ *)
¡
;

190 
¥“x_¡
 *
¥
 = 
d¡
->
¡
;

192 ià(*
§mpc
)

193 
	`¥“x_echo_¶ayback
(
¥
->
¡©e
, 
§mpv
);

196 
	}
}

200 
auft
 
	g¥“x_«c
 = {

201 
LE_INIT
, "¥“x_«c", 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode


205 
	$moduË_š™
()

208 #ifdeà
SPEEX_SET_VBR_MAX_BITRATE


209 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
¥“x_«c
);

212  
ENOSYS
;

214 
	}
}

217 
	$moduË_şo£
()

219 
	`auft_uÄegi¡”
(&
¥“x_«c
);

221 
	}
}

224 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¥“x_«c
) = {

227 
moduË_š™
,

228 
moduË_şo£


	@baresip/modules/speex_pp/speex_pp.c

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

8 
	~<¥“x/¥“x.h
>

9 
	~<¥“x/¥“x_´•roûss.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

21 
	s´•roc
 {

22 
auft_’c_¡
 
	maf
;

23 
S³exP»´oûssS‹
 *
	m¡©e
;

29 
	md’oi£_’abËd
;

30 
	magc_’abËd
;

31 
	mvad_’abËd
;

32 
	md”ev”b_’abËd
;

33 
¥x_št32_t
 
	magc_Ëv–
;

34 } 
	gµ_cÚf
 = {

43 
	$¥“xµ_de¡ruùÜ
(*
¬g
)

45 
´•roc
 *
¡
 = 
¬g
;

47 ià(
¡
->
¡©e
)

48 
	`¥“x_´•roûss_¡©e_de¡roy
(
¡
->
¡©e
);

50 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

51 
	}
}

54 
	$’code_upd©e
(
auft_’c_¡
 **
¡p
, **
ùx
,

55 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

57 
´•roc
 *
¡
;

58 
§mpc
;

59 ()
ùx
;

61 ià(!
¡p
 || !
af
 || !
´m
 ||…rm->
ch
 != 1)

62  
EINVAL
;

64 
¡
 = 
	`mem_z®loc
((*¡), 
¥“xµ_de¡ruùÜ
);

65 ià(!
¡
)

66  
ENOMEM
;

68 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

70 
¡
->
¡©e
 = 
	`¥“x_´•roûss_¡©e_š™
(
§mpc
, 
´m
->
¤©e
);

71 ià(!
¡
->
¡©e
)

72 
”rÜ
;

74 
	`¥“x_´•roûss_ùl
(
¡
->
¡©e
, 
SPEEX_PREPROCESS_SET_DENOISE
,

75 &
µ_cÚf
.
d’oi£_’abËd
);

76 
	`¥“x_´•roûss_ùl
(
¡
->
¡©e
, 
SPEEX_PREPROCESS_SET_AGC
,

77 &
µ_cÚf
.
agc_’abËd
);

79 #ifdeà
SPEEX_PREPROCESS_SET_AGC_TARGET


80 ià(
µ_cÚf
.
agc_’abËd
) {

81 
	`¥“x_´•roûss_ùl
(
¡
->
¡©e
,

82 
SPEEX_PREPROCESS_SET_AGC_TARGET
,

83 &
µ_cÚf
.
agc_Ëv–
);

87 
	`¥“x_´•roûss_ùl
(
¡
->
¡©e
, 
SPEEX_PREPROCESS_SET_VAD
,

88 &
µ_cÚf
.
vad_’abËd
);

89 
	`¥“x_´•roûss_ùl
(
¡
->
¡©e
, 
SPEEX_PREPROCESS_SET_DEREVERB
,

90 &
µ_cÚf
.
d”ev”b_’abËd
);

92 
	`šfo
("speex_pp: Speex…reprocessor†oaded: srate = %uHz\n",

93 
´m
->
¤©e
);

95 *
¡p
 = (
auft_’c_¡
 *)
¡
;

98 
”rÜ
:

99 
	`mem_d”ef
(
¡
);

100  
ENOMEM
;

101 
	}
}

104 
	$’code
(
auft_’c_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

106 
´•roc
 *
µ
 = (´•roø*)
¡
;

107 
is_¥“ch
 = 1;

109 ià(!*
§mpc
)

113 #ifdeà
SPEEX_PREPROCESS_SET_NOISE_SUPPRESS


115 
is_¥“ch
 = 
	`¥“x_´•roûss_run
(
µ
->
¡©e
, 
§mpv
);

118 
is_¥“ch
 = 
	`¥“x_´•roûss
(
µ
->
¡©e
, 
§mpv
, 
NULL
);

122 ()
is_¥“ch
;

125 
	}
}

128 
	$cÚfig_·r£
(
cÚf
 *conf)

130 
ušt32_t
 
v
;

132 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¥“x_agc_Ëv–", &
v
))

133 
µ_cÚf
.
agc_Ëv–
 = 
v
;

134 
	}
}

137 
auft
 
	g´•roc
 = {

138 
LE_INIT
, "¥“x_µ", 
’code_upd©e
, 
’code
, 
NULL
, NULL

141 
	$moduË_š™
()

143 
	`cÚfig_·r£
(
	`cÚf_cur
());

144 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
´•roc
);

146 
	}
}

149 
	$moduË_şo£
()

151 
	`auft_uÄegi¡”
(&
´•roc
);

153 
	}
}

156 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¥“x_µ
) = {

159 
moduË_š™
,

160 
moduË_şo£


	@baresip/modules/srtp/sdes.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"sdes.h
"

11 cÚ¡ 
	gsdp_©Œ_üy±o
[] = "crypto";

14 
	$sdes_’code_üy±o
(
sdp_medŸ
 *
m
, 
ušt32_t
 
g
, cÚ¡ *
su™e
,

15 cÚ¡ *
key
, 
size_t
 
key_Ën
)

17  
	`sdp_medŸ_£t_Ï‰r
(
m
, 
Œue
, 
sdp_©Œ_üy±o
, "%u %s inline:%b",

18 
g
, 
su™e
, 
key
, 
key_Ën
);

19 
	}
}

25 
	$sdes_decode_üy±o
(
üy±o
 *
c
, cÚ¡ *
v®
)

27 
¶
 
g
, 
key_´ms
;

28 
”r
;

30 
”r
 = 
	`»_»gex
(
v®
, 
	`¡r_Ën
(val), "[0-9]+ [^ ]+ [^ ]+[]*[^]*",

31 &
g
, &
c
->
su™e
, &
key_´ms
, 
NULL
, &c->
£ss_´ms
);

32 ià(
”r
)

33  
”r
;

35 
c
->
g
 = 
	`¶_u32
(&tag);

37 
c
->
liãtime
 = c->
mki
 = 
¶_nuÎ
;

38 
”r
 = 
	`»_»gex
(
key_´ms
.
p
, key_´ms.
l
, "[^:]+:[^|]+[|]*[^|]*[|]*[^|]*",

39 &
c
->
key_m‘hod
, &c->
key_šfo
,

40 
NULL
, &
c
->
liãtime
, NULL, &c->
mki
);

41 ià(
”r
)

42  
”r
;

45 
	}
}

	@baresip/modules/srtp/sdes.h

8 
	süy±o
 {

9 
ušt32_t
 
	mg
;

10 
¶
 
	msu™e
;

11 
¶
 
	mkey_m‘hod
;

12 
¶
 
	mkey_šfo
;

13 
¶
 
	mliãtime
;

14 
¶
 
	mmki
;

15 
¶
 
	m£ss_´ms
;

18 cÚ¡ 
sdp_©Œ_üy±o
[];

20 
sdes_’code_üy±o
(
sdp_medŸ
 *
m
, 
ušt32_t
 
g
, cÚ¡ *
su™e
,

21 cÚ¡ *
key
, 
size_t
 
key_Ën
);

22 
sdes_decode_üy±o
(
üy±o
 *
c
, cÚ¡ *
v®
);

	@baresip/modules/srtp/srtp.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"sdes.h
"

28 
	#SRTP_MASTER_KEY_LEN
 30

	)

31 
	sm’c_¡
 {

33 
ušt8_t
 
	mkey_tx
[32];

34 
ušt8_t
 
	mkey_rx
[32];

35 
¤
 *
	m¤_tx
, *
	m¤_rx
;

36 
boŞ
 
	mu£_¤
;

37 
boŞ
 
	mgÙ_sdp
;

38 *
	müy±o_su™e
;

40 *
	m¹psock
;

41 *
	m¹ısock
;

42 
udp_h–³r
 *
	muh_¹p
;

43 
udp_h–³r
 *
	muh_¹ı
;

44 
sdp_medŸ
 *
	msdpm
;

48 cÚ¡ 
	g«s_cm_128_hmac_sha1_32
[] = "AES_CM_128_HMAC_SHA1_32";

49 cÚ¡ 
	g«s_cm_128_hmac_sha1_80
[] = "AES_CM_128_HMAC_SHA1_80";

51 cÚ¡ *
	g´eã¼ed_su™e
 = 
«s_cm_128_hmac_sha1_80
;

54 
	$de¡ruùÜ
(*
¬g
)

56 
m’c_¡
 *
¡
 = 
¬g
;

58 
	`mem_d”ef
(
¡
->
sdpm
);

59 
	`mem_d”ef
(
¡
->
üy±o_su™e
);

62 
	`mem_d”ef
(
¡
->
uh_¹p
);

63 
	`mem_d”ef
(
¡
->
uh_¹ı
);

64 
	`mem_d”ef
(
¡
->
¹psock
);

65 
	`mem_d”ef
(
¡
->
¹ısock
);

67 
	`mem_d”ef
(
¡
->
¤_tx
);

68 
	`mem_d”ef
(
¡
->
¤_rx
);

69 
	}
}

72 
boŞ
 
	$üy±osu™e_issuµÜ‹d
(cÚ¡ 
¶
 *
su™e
)

74 ià(0 =ğ
	`¶_¡rÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_32
)è 
Œue
;

75 ià(0 =ğ
	`¶_¡rÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_80
)è 
Œue
;

77  
çl£
;

78 
	}
}

93 
boŞ
 
	$is_¹p_Ü_¹ı
(cÚ¡ 
mbuf
 *
mb
)

95 
ušt8_t
 
b
;

97 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

98  
çl£
;

100 
b
 = 
	`mbuf_buf
(
mb
)[0];

102  127 < 
b
 && b < 192;

103 
	}
}

106 
boŞ
 
	$is_¹ı_·ck‘
(cÚ¡ 
mbuf
 *
mb
)

108 
ušt8_t
 
±
;

110 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

111  
çl£
;

113 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

115  64 <ğ
±
 &&…t <= 95;

116 
	}
}

119 
¤_su™e
 
	$»sŞve_su™e
(cÚ¡ *
su™e
)

121 ià(0 =ğ
	`¡r_ÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_32
))

122  
SRTP_AES_CM_128_HMAC_SHA1_32
;

123 ià(0 =ğ
	`¡r_ÿ£cmp
(
su™e
, 
«s_cm_128_hmac_sha1_80
))

124  
SRTP_AES_CM_128_HMAC_SHA1_80
;

127 
	}
}

130 
	$¡¬t_¤
(
m’c_¡
 *
¡
, cÚ¡ *
su™e_Çme
)

132 
¤_su™e
 
su™e
;

133 
”r
;

135 
su™e
 = 
	`»sŞve_su™e
(
su™e_Çme
);

138 ià(!
¡
->
¤_tx
) {

139 
”r
 = 
	`¤_®loc
(&
¡
->
¤_tx
, 
su™e
, st->
key_tx
, 30, 0);

140 ià(
”r
) {

141 
	`w¬nšg
("¤: s¹p_®loøTX faed (%m)\n", 
”r
);

142  
”r
;

146 ià(!
¡
->
¤_rx
) {

147 
”r
 = 
	`¤_®loc
(&
¡
->
¤_rx
, 
su™e
, st->
key_rx
, 30, 0);

148 ià(
”r
) {

149 
	`w¬nšg
("¤: s¹p_®loøRX faed (%m)\n", 
”r
);

150  
”r
;

155 
¡
->
u£_¤
 = 
Œue
;

158 
	}
}

161 
boŞ
 
	$£nd_hªdËr
(*
”r
, 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

163 
m’c_¡
 *
¡
 = 
¬g
;

164 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

165 
Ë¼
 = 0;

166 ()
d¡
;

168 ià(!
¡
->
u£_¤
 || !
	`is_¹p_Ü_¹ı
(
mb
))

169  
çl£
;

171 ià(
	`is_¹ı_·ck‘
(
mb
)) {

172 
Ë¼
 = 
	`¤tı_’üy±
(
¡
->
¤_tx
, 
mb
);

175 
Ë¼
 = 
	`¤_’üy±
(
¡
->
¤_tx
, 
mb
);

178 ià(
Ë¼
) {

179 
	`w¬nšg
("srtp: failedoƒncrypt %s-packet"

181 
	`is_¹ı_·ck‘
(
mb
) ? "RTCP" : "RTP",

182 
Ën
, 
Ë¼
);

183 *
”r
 = 
Ë¼
;

184  
çl£
;

187  
çl£
;

188 
	}
}

191 
boŞ
 
	$»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

193 
m’c_¡
 *
¡
 = 
¬g
;

194 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

195 
”r
 = 0;

196 ()
¤c
;

198 ià(!
¡
->
gÙ_sdp
)

199  
Œue
;

201 ià(!
¡
->
u£_¤
 || !
	`is_¹p_Ü_¹ı
(
mb
))

202  
çl£
;

204 ià(
	`is_¹ı_·ck‘
(
mb
)) {

205 
”r
 = 
	`¤tı_deüy±
(
¡
->
¤_rx
, 
mb
);

206 ià(
”r
) {

207 
	`w¬nšg
("srtp: failedo decrypt RTCP…acket"

208 " w™h %zu by‹ (%m)\n", 
Ën
, 
”r
);

212 
”r
 = 
	`¤_deüy±
(
¡
->
¤_rx
, 
mb
);

213 ià(
”r
) {

214 
	`w¬nšg
("srtp: failedo decrypt RTP…acket"

215 " w™h %zu by‹ (%m)\n", 
Ën
, 
”r
);

219  
”r
 ? 
Œue
 : 
çl£
;

220 
	}
}

224 
	$sdp_’c
(
m’c_¡
 *
¡
, 
sdp_medŸ
 *
m
,

225 
ušt32_t
 
g
, cÚ¡ *
su™e
)

227 
key
[128] = "";

228 
size_t
 
Ş’
;

229 
”r
;

231 
Ş’
 = (
key
);

232 
”r
 = 
	`ba£64_’code
(
¡
->
key_tx
, 
SRTP_MASTER_KEY_LEN
, 
key
, &
Ş’
);

233 ià(
”r
)

234  
”r
;

236  
	`sdes_’code_üy±o
(
m
, 
g
, 
su™e
, 
key
, 
Ş’
);

237 
	}
}

240 
	$¡¬t_üy±o
(
m’c_¡
 *
¡
, cÚ¡ 
¶
 *
key_šfo
)

242 
size_t
 
Ş’
;

243 
”r
;

247 
Ş’
 = (
¡
->
key_rx
);

248 
”r
 = 
	`ba£64_decode
(
key_šfo
->
p
, key_šfo->
l
, 
¡
->
key_rx
, &
Ş’
);

249 ià(
”r
)

250  
”r
;

252 ià(
SRTP_MASTER_KEY_LEN
 !ğ
Ş’
) {

253 
	`w¬nšg
("¤: s¹°keyËÀi %u (should b30)\n", 
Ş’
);

256 
”r
 = 
	`¡¬t_¤
(
¡
, st->
üy±o_su™e
);

257 ià(
”r
)

258  
”r
;

260 
	`šfo
("srtp: %s: SRTP is Enabled (cryptosuite=%s)\n",

261 
	`sdp_medŸ_Çme
(
¡
->
sdpm
), st->
üy±o_su™e
);

264 
	}
}

267 
boŞ
 
	$sdp_©Œ_hªdËr
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, *
¬g
)

269 
m’c_¡
 *
¡
 = 
¬g
;

270 
üy±o
 
c
;

271 ()
Çme
;

273 ià(
	`sdes_decode_üy±o
(&
c
, 
v®ue
))

274  
çl£
;

276 ià(0 !ğ
	`¶_¡rcmp
(&
c
.
key_m‘hod
, "inline"))

277  
çl£
;

279 ià(!
	`üy±osu™e_issuµÜ‹d
(&
c
.
su™e
))

280  
çl£
;

282 
¡
->
üy±o_su™e
 = 
	`mem_d”ef
(st->crypto_suite);

283 
	`¶_¡rdup
(&
¡
->
üy±o_su™e
, &
c
.
su™e
);

285 ià(
	`¡¬t_üy±o
(
¡
, &
c
.
key_šfo
))

286  
çl£
;

288 
	`sdp_’c
(
¡
, st->
sdpm
, 
c
.
g
, st->
üy±o_su™e
);

290  
Œue
;

291 
	}
}

294 
	$®loc
(
m’c_medŸ
 **
¡p
, 
m’c_£ss
 *
£ss
,

295 
¹p_sock
 *
¹p
,

296 
´Ùo
, *
¹psock
, *
¹ısock
,

297 
sdp_medŸ
 *
sdpm
)

299 
m’c_¡
 *
¡
;

300 cÚ¡ *
¿‰r
 = 
NULL
;

301 
Ïy”
 = 10;

302 
”r
 = 0;

303 
boŞ
 
mux
 = (
¹psock
 =ğ
¹ısock
);

304 ()
£ss
;

305 ()
¹p
;

307 ià(!
¡p
 || !
sdpm
)

308  
EINVAL
;

309 ià(
´Ùo
 !ğ
IPPROTO_UDP
)

310  
EPROTONOSUPPORT
;

312 
¡
 = (
m’c_¡
 *)*
¡p
;

313 ià(!
¡
) {

315 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

316 ià(!
¡
)

317  
ENOMEM
;

319 
¡
->
sdpm
 = 
	`mem_»f
(sdpm);

321 
”r
 = 
	`sdp_medŸ_£t_®t_´Ùos
(
¡
->
sdpm
, 4,

326 ià(
”r
)

327 
out
;

329 ià(
¹psock
) {

330 
¡
->
¹psock
 = 
	`mem_»f
(rtpsock);

331 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹p
, 
¹psock
,

332 
Ïy”
, 
£nd_hªdËr
,

333 
»cv_hªdËr
, 
¡
);

335 ià(
¹ısock
 && !
mux
) {

336 
¡
->
¹ısock
 = 
	`mem_»f
(rtcpsock);

337 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹ı
, 
¹ısock
,

338 
Ïy”
, 
£nd_hªdËr
,

339 
»cv_hªdËr
, 
¡
);

341 ià(
”r
)

342 
out
;

345 
”r
 |ğ
	`¡r_dup
(&
¡
->
üy±o_su™e
, 
´eã¼ed_su™e
);

346 ià(
”r
)

347 
out
;

349 
	`¿nd_by‹s
(
¡
->
key_tx
, 
SRTP_MASTER_KEY_LEN
);

354 ià(
	`sdp_medŸ_½Üt
(
sdpm
))

355 
¡
->
gÙ_sdp
 = 
Œue
;

357 ià(
	`sdp_medŸ_¿‰r
(
¡
->
sdpm
, "crypto")) {

359 
¿‰r
 = 
	`sdp_medŸ_¿‰r_­¶y
(
¡
->
sdpm
, "crypto",

360 
sdp_©Œ_hªdËr
, 
¡
);

361 ià(!
¿‰r
) {

362 
	`w¬nšg
("srtp:‚o valid‡=crypto‡ttribute from"

367 ià(!
¿‰r
)

368 
”r
 = 
	`sdp_’c
(
¡
, 
sdpm
, 1, st->
üy±o_su™e
);

370 
out
:

371 ià(
”r
)

372 
	`mem_d”ef
(
¡
);

374 *
¡p
 = (
m’c_medŸ
 *)
¡
;

376  
”r
;

377 
	}
}

380 
m’c
 
	gm’c_¤_İt
 = {

381 
LE_INIT
, "¤", "RTP/AVP", 
NULL
, 
®loc


384 
m’c
 
	gm’c_¤_mªd
 = {

385 
LE_INIT
, "¤-mªd", "RTP/SAVP", 
NULL
, 
®loc


388 
m’c
 
	gm’c_¤_mªdf
 = {

389 
LE_INIT
, "¤-mªdf", "RTP/SAVPF", 
NULL
, 
®loc


393 
	$mod_¤_š™
()

395 
li¡
 *
m’ş
 = 
	`b¬es_m’ş
();

397 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_İt
);

398 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_mªd
);

399 
	`m’c_»gi¡”
(
m’ş
, &
m’c_¤_mªdf
);

402 
	}
}

405 
	$mod_¤_şo£
()

407 
	`m’c_uÄegi¡”
(&
m’c_¤_mªdf
);

408 
	`m’c_uÄegi¡”
(&
m’c_¤_mªd
);

409 
	`m’c_uÄegi¡”
(&
m’c_¤_İt
);

412 
	}
}

415 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¤
) = {

418 
mod_¤_š™
,

419 
mod_¤_şo£


	@baresip/modules/stdio/stdio.c

6 
	~<¡ršg.h
>

7 
	~<uni¡d.h
>

8 
	~<fú.h
>

9 
	~<‹rmios.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

26 
	mRELEASE_VAL
 = 250

29 
	sui_¡
 {

30 
tmr
 
	mtmr
;

31 
‹rmios
 
	m‹rm
;

32 
boŞ
 
	m‹rm_£t
;

37 
ui_¡
 *
	gui_¡©e
;

40 
	$ui_de¡ruùÜ
(*
¬g
)

42 
ui_¡
 *
¡
 = 
¬g
;

44 
	`fd_şo£
(
STDIN_FILENO
);

46 ià(
¡
->
‹rm_£t
)

47 
	`tc£‰r
(
STDIN_FILENO
, 
TCSANOW
, &
¡
->
‹rm
);

49 
	`tmr_ÿnûl
(&
¡
->
tmr
);

50 
	}
}

53 
	$´št_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

55 ()
¬g
;

57  1 =ğ
	`fwr™e
(
p
, 
size
, 1, 
¡d”r
è? 0 : 
ENOMEM
;

58 
	}
}

61 
	$»pÜt_key
(
ui_¡
 *
ui
, 
key
)

63 
»_´štf
 
pf_¡d”r
 = {
´št_hªdËr
, 
NULL
};

64 ()
ui
;

66 
	`ui_šput_key
(
	`b¬es_uis
(), 
key
, &
pf_¡d”r
);

67 
	}
}

70 
	$timeout
(*
¬g
)

72 
ui_¡
 *
¡
 = 
¬g
;

75 
	`»pÜt_key
(
¡
, 
KEYCODE_REL
);

76 
	}
}

79 
	$ui_fd_hªdËr
(
æags
, *
¬g
)

81 
ui_¡
 *
¡
 = 
¬g
;

82 
key
;

83 ()
æags
;

85 ià(1 !ğ
	`»ad
(
STDIN_FILENO
, &
key
, 1)) {

89 
	`tmr_¡¬t
(&
¡
->
tmr
, 
RELEASE_VAL
, 
timeout
, st);

90 
	`»pÜt_key
(
¡
, 
key
);

91 
	}
}

94 
	$‹rm_£tup
(
ui_¡
 *
¡
)

96 
‹rmios
 
now
;

98 ià(
	`tcg‘©Œ
(
STDIN_FILENO
, &
¡
->
‹rm
) < 0)

99  
”ºo
;

101 
now
 = 
¡
->
‹rm
;

103 
now
.
c_læag
 |ğ
ISIG
;

104 
now
.
c_læag
 &ğ~(
ECHO
|
ECHONL
|
ICANON
|
IEXTEN
);

107 
now
.
c_cc
[
VMIN
] = 1;

108 
now
.
c_cc
[
VTIME
] = 0;

110 ià(
	`tc£‰r
(
STDIN_FILENO
, 
TCSANOW
, &
now
) < 0)

111  
”ºo
;

113 
¡
->
‹rm_£t
 = 
Œue
;

116 
	}
}

119 
	$ui_®loc
(
ui_¡
 **
¡p
)

121 
ui_¡
 *
¡
;

122 
”r
;

124 ià(!
¡p
)

125  
EINVAL
;

127 
¡
 = 
	`mem_z®loc
((*¡), 
ui_de¡ruùÜ
);

128 ià(!
¡
)

129  
ENOMEM
;

131 
	`tmr_š™
(&
¡
->
tmr
);

133 
”r
 = 
	`fd_li¡’
(
STDIN_FILENO
, 
FD_READ
, 
ui_fd_hªdËr
, 
¡
);

134 ià(
”r
)

135 
out
;

137 
”r
 = 
	`‹rm_£tup
(
¡
);

138 ià(
”r
) {

139 
	`šfo
("¡dio: could‚Ù s‘u°‹rmš®: %m\n", 
”r
);

140 
”r
 = 0;

143 
out
:

144 ià(
”r
)

145 
	`mem_d”ef
(
¡
);

147 *
¡p
 = 
¡
;

149  
”r
;

150 
	}
}

153 
	$ouut_hªdËr
(cÚ¡ *
¡r
)

155  
	`´št_hªdËr
(
¡r
, 
	`¡r_Ën
(¡r), 
NULL
);

156 
	}
}

159 
ui
 
	gui_¡dio
 = {

160 .
Çme
 = "stdio",

161 .
	gouuth
 = 
ouut_hªdËr


165 
	$moduË_š™
()

167 
”r
;

169 
”r
 = 
	`ui_®loc
(&
ui_¡©e
);

170 ià(
”r
)

171  
”r
;

173 
	`ui_»gi¡”
(
	`b¬es_uis
(), &
ui_¡dio
);

176 
	}
}

179 
	$moduË_şo£
()

181 
	`ui_uÄegi¡”
(&
ui_¡dio
);

182 
ui_¡©e
 = 
	`mem_d”ef
(ui_state);

185 
	}
}

188 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¡dio
) = {

191 
moduË_š™
,

192 
moduË_şo£


	@baresip/modules/stun/stun.c

6 
	~<».h
>

7 
	~<b¬es.h
>

17 ’um {
	mLAYER
 = 0, 
	mINTERVAL
 = 30};

19 
	smÇt_£ss
 {

20 
li¡
 
	mmedŸl
;

21 
§
 
	m¤v
;

22 
¡un_dns
 *
	mdnsq
;

23 
mÇt_e¡ab_h
 *
	me¡abh
;

24 *
	m¬g
;

25 
	mmedŸc
;

29 
	smÇt_medŸ
 {

30 
Ë
 
	mË
;

31 
§
 
	maddr1
;

32 
§
 
	maddr2
;

33 
mÇt_£ss
 *
	m£ss
;

34 
sdp_medŸ
 *
	msdpm
;

35 
¡un_k“·live
 *
	mska1
;

36 
¡un_k“·live
 *
	mska2
;

37 *
	msock1
;

38 *
	msock2
;

39 
	m´Ùo
;

43 
mÇt
 *
	gmÇt
;

46 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

48 
mÇt_£ss
 *
£ss
 = 
¬g
;

50 
	`li¡_æush
(&
£ss
->
medŸl
);

51 
	`mem_d”ef
(
£ss
->
dnsq
);

52 
	}
}

55 
	$medŸ_de¡ruùÜ
(*
¬g
)

57 
mÇt_medŸ
 *
m
 = 
¬g
;

59 
	`li¡_uÆšk
(&
m
->
Ë
);

60 
	`mem_d”ef
(
m
->
sdpm
);

61 
	`mem_d”ef
(
m
->
ska1
);

62 
	`mem_d”ef
(
m
->
ska2
);

63 
	`mem_d”ef
(
m
->
sock1
);

64 
	`mem_d”ef
(
m
->
sock2
);

65 
	}
}

68 
	$m­³d_hªdËr1
(
”r
, cÚ¡ 
§
 *
m­_addr
, *
¬g
)

70 
mÇt_medŸ
 *
m
 = 
¬g
;

72 ià(!
”r
) {

74 
	`sdp_medŸ_£t_Ïddr
(
m
->
sdpm
, 
m­_addr
);

76 
m
->
addr1
 = *
m­_addr
;

78 ià(
m
->
ska2
 && !
	`§_is£t
(&m->
addr2
, 
SA_ALL
))

81 ià(--
m
->
£ss
->
medŸc
)

85 
m
->
£ss
->
	`e¡abh
(
”r
, 0, 
NULL
, m->£ss->
¬g
);

86 
	}
}

89 
	$m­³d_hªdËr2
(
”r
, cÚ¡ 
§
 *
m­_addr
, *
¬g
)

91 
mÇt_medŸ
 *
m
 = 
¬g
;

93 ià(!
”r
) {

95 
	`sdp_medŸ_£t_Ïddr_¹ı
(
m
->
sdpm
, 
m­_addr
);

97 
m
->
addr2
 = *
m­_addr
;

99 ià(
m
->
ska1
 && !
	`§_is£t
(&m->
addr1
, 
SA_ALL
))

102 ià(--
m
->
£ss
->
medŸc
)

106 
m
->
£ss
->
	`e¡abh
(
”r
, 0, 
NULL
, m->£ss->
¬g
);

107 
	}
}

110 
	$medŸ_¡¬t
(
mÇt_£ss
 *
£ss
, 
mÇt_medŸ
 *
m
)

112 
”r
 = 0;

114 ià(
m
->
sock1
) {

115 
”r
 |ğ
	`¡un_k“·live_®loc
(&
m
->
ska1
, m->
´Ùo
,

116 
m
->
sock1
, 
LAYER
, &
£ss
->
¤v
, 
NULL
,

117 
m­³d_hªdËr1
, 
m
);

119 ià(
m
->
sock2
) {

120 
”r
 |ğ
	`¡un_k“·live_®loc
(&
m
->
ska2
, m->
´Ùo
,

121 
m
->
sock2
, 
LAYER
, &
£ss
->
¤v
, 
NULL
,

122 
m­³d_hªdËr2
, 
m
);

124 ià(
”r
)

125  
”r
;

127 
	`¡un_k“·live_’abË
(
m
->
ska1
, 
INTERVAL
);

128 
	`¡un_k“·live_’abË
(
m
->
ska2
, 
INTERVAL
);

131 
	}
}

134 
	$dns_hªdËr
(
”r
, cÚ¡ 
§
 *
¤v
, *
¬g
)

136 
mÇt_£ss
 *
£ss
 = 
¬g
;

137 
Ë
 *le;

139 ià(
”r
)

140 
out
;

142 
£ss
->
¤v
 = *srv;

144 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

146 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

148 
”r
 = 
	`medŸ_¡¬t
(
£ss
, 
m
);

149 ià(
”r
)

150 
out
;

155 
out
:

156 
£ss
->
	`e¡abh
(
”r
, 0, 
NULL
, sess->
¬g
);

157 
	}
}

160 
	$£ssiÚ_®loc
(
mÇt_£ss
 **
£s¥
, 
dnsc
 *dnsc,

161 
af
, cÚ¡ *
¤v
, 
ušt16_t
 
pÜt
,

162 cÚ¡ *
u£r
, cÚ¡ *
·ss
,

163 
sdp_£ssiÚ
 *
ss
, 
boŞ
 
ofã»r
,

164 
mÇt_e¡ab_h
 *
e¡abh
, *
¬g
)

166 
mÇt_£ss
 *
£ss
;

167 
”r
;

168 ()
u£r
;

169 ()
·ss
;

170 ()
ss
;

171 ()
ofã»r
;

173 ià(!
£s¥
 || !
dnsc
 || !
¤v
 || !
ss
 || !
e¡abh
)

174  
EINVAL
;

176 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ssiÚ_de¡ruùÜ
);

177 ià(!
£ss
)

178  
ENOMEM
;

180 
£ss
->
e¡abh
 =ƒstabh;

181 
£ss
->
¬g
 =‡rg;

183 
”r
 = 
	`¡un_£rv”_discov”
(&
£ss
->
dnsq
, 
dnsc
,

184 
¡un_u§ge_bšdšg
, 
¡un_´Ùo_udp
,

185 
af
, 
¤v
, 
pÜt
, 
dns_hªdËr
, 
£ss
);

187 ià(
”r
)

188 
	`mem_d”ef
(
£ss
);

190 *
£s¥
 = 
£ss
;

192  
”r
;

193 
	}
}

196 
	$medŸ_®loc
(
mÇt_medŸ
 **
mp
, 
mÇt_£ss
 *
£ss
,

197 
´Ùo
, *
sock1
, *
sock2
,

198 
sdp_medŸ
 *
sdpm
)

200 
mÇt_medŸ
 *
m
;

201 
”r
 = 0;

203 ià(!
mp
 || !
£ss
 || !
sdpm
)

204  
EINVAL
;

206 
m
 = 
	`mem_z®loc
((*m), 
medŸ_de¡ruùÜ
);

207 ià(!
m
)

208  
ENOMEM
;

210 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

211 
m
->
sdpm
 = 
	`mem_»f
(sdpm);

212 
m
->
£ss
 = sess;

213 
m
->
sock1
 = 
	`mem_»f
(sock1);

214 
m
->
sock2
 = 
	`mem_»f
(sock2);

215 
m
->
´Ùo
 =…roto;

217 ià(
	`§_is£t
(&
£ss
->
¤v
, 
SA_ALL
))

218 
”r
 = 
	`medŸ_¡¬t
(
£ss
, 
m
);

220 ià(
”r
)

221 
	`mem_d”ef
(
m
);

223 *
mp
 = 
m
;

224 ++
£ss
->
medŸc
;

227  
”r
;

228 
	}
}

231 
	$moduË_š™
()

233  
	`mÇt_»gi¡”
(&
mÇt
, 
	`b¬es_mÇ
(),

234 "¡un", 
NULL
, 
£ssiÚ_®loc
, 
medŸ_®loc
,

235 
NULL
);

236 
	}
}

239 
	$moduË_şo£
()

241 
mÇt
 = 
	`mem_d”ef
(mnat);

244 
	}
}

247 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
¡un
) = {

250 
moduË_š™
,

251 
moduË_şo£
,

	@baresip/modules/swscale/swscale.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~<libswsÿË/swsÿË.h
>

12 
	sswsÿË_’c
 {

13 
vidft_’c_¡
 
	mvf
;

15 
SwsCÚ‹xt
 *
	msws
;

16 
vidäame
 *
	mäame
;

17 
vidsz
 
	md¡_size
;

21 
vidfmt
 
	gswsÿË_fÜm©
 = 
VID_FMT_YUV420P
;

24 
AVPix–FÜm©
 
	$vidfmt_to_avpixfmt
(
vidfmt
 
fmt
)

26 
fmt
) {

28 
VID_FMT_YUV420P
:  
AV_PIX_FMT_YUV420P
;

29 
VID_FMT_NV12
:  
AV_PIX_FMT_NV12
;

30 
VID_FMT_NV21
:  
AV_PIX_FMT_NV21
;

31 :  
AV_PIX_FMT_NONE
;

33 
	}
}

36 
	$’code_de¡ruùÜ
(*
¬g
)

38 
swsÿË_’c
 *
¡
 = 
¬g
;

40 
	`li¡_uÆšk
(&
¡
->
vf
.
Ë
);

42 
	`mem_d”ef
(
¡
->
äame
);

43 
	`sws_ä“CÚ‹xt
(
¡
->
sws
);

44 
	}
}

47 
	$’code_upd©e
(
vidft_’c_¡
 **
¡p
, **
ùx
,

48 cÚ¡ 
vidft
 *
vf
)

50 
swsÿË_’c
 *
¡
;

51 
cÚfig
 *cÚfig = 
	`cÚf_cÚfig
();

52 
”r
 = 0;

54 ià(!
cÚfig
) {

55 
	`w¬nšg
("swscale:‚o config\n");

56  
EINVAL
;

59 ià(!
¡p
 || !
ùx
 || !
vf
)

60  
EINVAL
;

62 ià(*
¡p
)

65 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

66 ià(!
¡
)

67  
ENOMEM
;

69 
¡
->
d¡_size
.
w
 = 
cÚfig
->
video
.
width
;

70 
¡
->
d¡_size
.
h
 = 
cÚfig
->
video
.
height
;

72 ià(
”r
)

73 
	`mem_d”ef
(
¡
);

75 *
¡p
 = (
vidft_’c_¡
 *)
¡
;

77  
”r
;

78 
	}
}

81 
	$’code_´oûss
(
vidft_’c_¡
 *
¡
, 
vidäame
 *
äame
)

83 
swsÿË_’c
 *
’c
 = (swsÿË_’ø*)
¡
;

84 
AVPix–FÜm©
 
avpixfmt
, 
avpixfmt_d¡
;

85 cÚ¡ 
ušt8_t
 *
¤cSliû
[4];

86 
ušt8_t
 *
d¡
[4];

87 
¤cSŒide
[4], 
d¡SŒide
[4];

88 
width
, 
height
, 
i
, 
h
;

89 
”r
 = 0;

91 ià(!
¡
)

92  
EINVAL
;

94 ià(!
äame
)

97 
width
 = 
äame
->
size
.
w
;

98 
height
 = 
äame
->
size
.
h
;

100 
avpixfmt
 = 
	`vidfmt_to_avpixfmt
(
äame
->
fmt
);

101 ià(
avpixfmt
 =ğ
AV_PIX_FMT_NONE
) {

102 
	`w¬nšg
("swscale: unknown…ixel-format (%s)\n",

103 
	`vidfmt_Çme
(
äame
->
fmt
));

104  
EINVAL
;

107 
avpixfmt_d¡
 = 
	`vidfmt_to_avpixfmt
(
swsÿË_fÜm©
);

108 ià(
avpixfmt_d¡
 =ğ
AV_PIX_FMT_NONE
) {

109 
	`w¬nšg
("swscale: unknown…ixel-format (%s)\n",

110 
	`vidfmt_Çme
(
swsÿË_fÜm©
));

111  
EINVAL
;

114 ià(!
’c
->
sws
) {

116 
SwsCÚ‹xt
 *
sws
;

117 
æags
 = 0;

119 
sws
 = 
	`sws_g‘CÚ‹xt
(
width
, 
height
, 
avpixfmt
,

120 
’c
->
d¡_size
.
w
,ƒnc->d¡_size.
h
,

121 
avpixfmt_d¡
,

122 
æags
, 
NULL
, NULL, NULL);

123 ià(!
sws
) {

124 
	`w¬nšg
("swscale: sws_getContextƒrror\n");

125  
ENOMEM
;

128 
’c
->
sws
 = sws;

130 
	`šfo
("swscale: created SwsContext:"

132 
	`vidfmt_Çme
(
äame
->
fmt
), 
width
, 
height
,

133 
	`vidfmt_Çme
(
swsÿË_fÜm©
),

134 
’c
->
d¡_size
.
w
,ƒnc->d¡_size.
h
);

137 ià(!
’c
->
äame
) {

139 
”r
 = 
	`vidäame_®loc
(&
’c
->
äame
, 
swsÿË_fÜm©
,

140 &
’c
->
d¡_size
);

141 ià(
”r
) {

142 
	`w¬nšg
("swsÿË: vidäame_®loø”rÜ (%m)\n", 
”r
);

143  
”r
;

147 
i
=0; i<4; i++) {

148 
¤cSliû
[
i
] = 
äame
->
d©a
[i];

149 
¤cSŒide
[
i
] = 
äame
->
lšesize
[i];

150 
d¡
[
i
] = 
’c
->
äame
->
d©a
[i];

151 
d¡SŒide
[
i
] = 
’c
->
äame
->
lšesize
[i];

154 
h
 = 
	`sws_sÿË
(
’c
->
sws
, 
¤cSliû
, 
¤cSŒide
,

155 0, 
height
, 
d¡
, 
d¡SŒide
);

156 ià(
h
 <= 0) {

157 
	`w¬nšg
("swsÿË: sws_sÿËƒ¼Ü (%d)\n", 
h
);

158  
EPROTO
;

162 
i
=0; i<4; i++) {

163 
äame
->
d©a
[
i
] = 
’c
->frame->data[i];

164 
äame
->
lšesize
[
i
] = 
’c
->frame->linesize[i];

166 
äame
->
size
 = 
’c
->frame->size;

167 
äame
->
fmt
 = 
’c
->frame->fmt;

170 
	}
}

173 
vidft
 
	gvf_swsÿË
 = {

174 
LE_INIT
, "swsÿË", 
’code_upd©e
, 
’code_´oûss
, 
NULL
, NULL

178 
	$moduË_š™
()

180 
	`vidft_»gi¡”
(
	`b¬es_vidf
(), &
vf_swsÿË
);

182 
	}
}

185 
	$moduË_şo£
()

187 
	`vidft_uÄegi¡”
(&
vf_swsÿË
);

189 
	}
}

192 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
swsÿË
) = {

195 
moduË_š™
,

196 
moduË_şo£


	@baresip/modules/syslog/syslog.c

7 
	~<sy¦og.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

19 
	#DEBUG_MODULE
 ""

	)

20 
	#DEBUG_LEVEL
 0

	)

21 
	~<»_dbg.h
>

24 cÚ¡ 
	glm­
[] = { 
LOG_DEBUG
, 
LOG_INFO
, 
LOG_WARNING
, 
LOG_ERR
 };

27 
	$log_hªdËr
(
ušt32_t
 
Ëv–
, cÚ¡ *
msg
)

29 
	`sy¦og
(
lm­
[
	`MIN
(
Ëv–
, 
	`ARRAY_SIZE
Öm­)-1)], "%s", 
msg
);

30 
	}
}

33 
log
 
	glg
 = {

34 .
h
 = 
log_hªdËr
,

38 
	$sy¦og_hªdËr
(
Ëv–
, cÚ¡ *
p
, 
size_t
 
Ën
, *
¬g
)

40 ()
¬g
;

42 
	`sy¦og
(
Ëv–
, "%.*s", ()
Ën
, 
p
);

43 
	}
}

46 
	$moduË_š™
()

48 
	`İ’log
("b¬es", 
LOG_NDELAY
 | 
LOG_PID
, 
LOG_LOCAL0
);

50 
	`dbg_š™
(
DBG_INFO
, 
DBG_NONE
);

51 
	`dbg_hªdËr_£t
(
sy¦og_hªdËr
, 
NULL
);

53 
	`log_»gi¡”_hªdËr
(&
lg
);

56 
	}
}

59 
	$moduË_şo£
()

61 
	`log_uÄegi¡”_hªdËr
(&
lg
);

63 
	`dbg_hªdËr_£t
(
NULL
, NULL);

65 
	`şo£log
();

68 
	}
}

71 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
sy¦og
) = {

74 
moduË_š™
,

75 
moduË_şo£


	@baresip/modules/turn/turn.c

6 
	~<».h
>

7 
	~<b¬es.h
>

19 ’um {
	mLAYER
 = 0};

22 
	smÇt_£ss
 {

23 
li¡
 
	mmedŸl
;

24 
§
 
	m¤v
;

25 
¡un_dns
 *
	mdnsq
;

26 *
	mu£r
;

27 *
	m·ss
;

28 
mÇt_e¡ab_h
 *
	me¡abh
;

29 *
	m¬g
;

30 
	mmedŸc
;

34 
	smÇt_medŸ
 {

35 
Ë
 
	mË
;

36 
§
 
	maddr1
;

37 
§
 
	maddr2
;

38 
mÇt_£ss
 *
	m£ss
;

39 
sdp_medŸ
 *
	msdpm
;

40 
tuºc
 *
	mtuºc1
;

41 
tuºc
 *
	mtuºc2
;

42 *
	msock1
;

43 *
	msock2
;

44 
	m´Ùo
;

48 
mÇt
 *
	gmÇt
;

51 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

53 
mÇt_£ss
 *
£ss
 = 
¬g
;

55 
	`li¡_æush
(&
£ss
->
medŸl
);

56 
	`mem_d”ef
(
£ss
->
dnsq
);

57 
	`mem_d”ef
(
£ss
->
u£r
);

58 
	`mem_d”ef
(
£ss
->
·ss
);

59 
	}
}

62 
	$medŸ_de¡ruùÜ
(*
¬g
)

64 
mÇt_medŸ
 *
m
 = 
¬g
;

66 
	`li¡_uÆšk
(&
m
->
Ë
);

67 
	`mem_d”ef
(
m
->
sdpm
);

68 
	`mem_d”ef
(
m
->
tuºc1
);

69 
	`mem_d”ef
(
m
->
tuºc2
);

70 
	`mem_d”ef
(
m
->
sock1
);

71 
	`mem_d”ef
(
m
->
sock2
);

72 
	}
}

75 
	$tuº_hªdËr1
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

76 cÚ¡ 
§
 *
»Ïy_addr
,

77 cÚ¡ 
§
 *
m­³d_addr
,

78 cÚ¡ 
¡un_msg
 *
msg
,

79 *
¬g
)

81 
mÇt_medŸ
 *
m
 = 
¬g
;

82 ()
m­³d_addr
;

83 ()
msg
;

85 ià(!
”r
 && !
scode
) {

87 
	`sdp_medŸ_£t_Ïddr
(
m
->
sdpm
, 
»Ïy_addr
);

89 
m
->
addr1
 = *
»Ïy_addr
;

91 ià(
m
->
tuºc2
 && !
	`§_is£t
(&m->
addr2
, 
SA_ALL
))

94 ià(--
m
->
£ss
->
medŸc
)

98 
m
->
£ss
->
	`e¡abh
(
”r
, 
scode
, 
»asÚ
, m->£ss->
¬g
);

99 
	}
}

102 
	$tuº_hªdËr2
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

103 cÚ¡ 
§
 *
»Ïy_addr
,

104 cÚ¡ 
§
 *
m­³d_addr
,

105 cÚ¡ 
¡un_msg
 *
msg
,

106 *
¬g
)

108 
mÇt_medŸ
 *
m
 = 
¬g
;

109 ()
m­³d_addr
;

110 ()
msg
;

112 ià(!
”r
 && !
scode
) {

114 
	`sdp_medŸ_£t_Ïddr_¹ı
(
m
->
sdpm
, 
»Ïy_addr
);

116 
m
->
addr2
 = *
»Ïy_addr
;

118 ià(
m
->
tuºc1
 && !
	`§_is£t
(&m->
addr1
, 
SA_ALL
))

121 ià(--
m
->
£ss
->
medŸc
)

125 
m
->
£ss
->
	`e¡abh
(
”r
, 
scode
, 
»asÚ
, m->£ss->
¬g
);

126 
	}
}

129 
	$medŸ_¡¬t
(
mÇt_£ss
 *
£ss
, 
mÇt_medŸ
 *
m
)

131 
”r
 = 0;

133 ià(
m
->
sock1
) {

134 
”r
 |ğ
	`tuºc_®loc
(&
m
->
tuºc1
, 
NULL
,

135 
m
->
´Ùo
, m->
sock1
, 
LAYER
,

136 &
£ss
->
¤v
, sess->
u£r
, sess->
·ss
,

137 
TURN_DEFAULT_LIFETIME
,

138 
tuº_hªdËr1
, 
m
);

140 ià(
m
->
sock2
) {

141 
”r
 |ğ
	`tuºc_®loc
(&
m
->
tuºc2
, 
NULL
,

142 
m
->
´Ùo
, m->
sock2
, 
LAYER
,

143 &
£ss
->
¤v
, sess->
u£r
, sess->
·ss
,

144 
TURN_DEFAULT_LIFETIME
,

145 
tuº_hªdËr2
, 
m
);

148  
”r
;

149 
	}
}

152 
	$dns_hªdËr
(
”r
, cÚ¡ 
§
 *
¤v
, *
¬g
)

154 
mÇt_£ss
 *
£ss
 = 
¬g
;

155 
Ë
 *le;

157 ià(
”r
)

158 
out
;

160 
£ss
->
¤v
 = *srv;

162 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

164 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

166 
”r
 = 
	`medŸ_¡¬t
(
£ss
, 
m
);

167 ià(
”r
)

168 
out
;

173 
out
:

174 
£ss
->
	`e¡abh
(
”r
, 0, 
NULL
, sess->
¬g
);

175 
	}
}

178 
	$£ssiÚ_®loc
(
mÇt_£ss
 **
£s¥
, 
dnsc
 *dnsc,

179 
af
, cÚ¡ *
¤v
, 
ušt16_t
 
pÜt
,

180 cÚ¡ *
u£r
, cÚ¡ *
·ss
,

181 
sdp_£ssiÚ
 *
ss
, 
boŞ
 
ofã»r
,

182 
mÇt_e¡ab_h
 *
e¡abh
, *
¬g
)

184 
mÇt_£ss
 *
£ss
;

185 
”r
;

186 ()
ss
;

187 ()
ofã»r
;

189 ià(!
£s¥
 || !
dnsc
 || !
¤v
 || !
u£r
 || !
·ss
 || !
ss
 || !
e¡abh
)

190  
EINVAL
;

192 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ssiÚ_de¡ruùÜ
);

193 ià(!
£ss
)

194  
ENOMEM
;

196 
”r
 = 
	`¡r_dup
(&
£ss
->
u£r
, user);

197 
”r
 |ğ
	`¡r_dup
(&
£ss
->
·ss
,…ass);

198 ià(
”r
)

199 
out
;

201 
£ss
->
e¡abh
 =ƒstabh;

202 
£ss
->
¬g
 =‡rg;

204 
”r
 = 
	`¡un_£rv”_discov”
(&
£ss
->
dnsq
, 
dnsc
,

205 
¡un_u§ge_»Ïy
, 
¡un_´Ùo_udp
,

206 
af
, 
¤v
, 
pÜt
, 
dns_hªdËr
, 
£ss
);

208 
out
:

209 ià(
”r
)

210 
	`mem_d”ef
(
£ss
);

212 *
£s¥
 = 
£ss
;

214  
”r
;

215 
	}
}

218 
	$medŸ_®loc
(
mÇt_medŸ
 **
mp
, 
mÇt_£ss
 *
£ss
,

219 
´Ùo
, *
sock1
, *
sock2
,

220 
sdp_medŸ
 *
sdpm
)

222 
mÇt_medŸ
 *
m
;

223 
”r
 = 0;

225 ià(!
mp
 || !
£ss
 || !
sdpm
)

226  
EINVAL
;

228 
m
 = 
	`mem_z®loc
((*m), 
medŸ_de¡ruùÜ
);

229 ià(!
m
)

230  
ENOMEM
;

232 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

233 
m
->
sdpm
 = 
	`mem_»f
(sdpm);

234 
m
->
£ss
 = sess;

235 
m
->
sock1
 = 
	`mem_»f
(sock1);

236 
m
->
sock2
 = 
	`mem_»f
(sock2);

237 
m
->
´Ùo
 =…roto;

239 ià(
	`§_is£t
(&
£ss
->
¤v
, 
SA_ALL
))

240 
”r
 = 
	`medŸ_¡¬t
(
£ss
, 
m
);

242 ià(
”r
)

243 
	`mem_d”ef
(
m
);

245 *
mp
 = 
m
;

246 ++
£ss
->
medŸc
;

249  
”r
;

250 
	}
}

253 
	$upd©e
(
mÇt_£ss
 *
£ss
)

255 
Ë
 *le;

256 
”r
 = 0;

258 ià(!
£ss
)

259  
EINVAL
;

261 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

263 
mÇt_medŸ
 *
m
 = 
Ë
->
d©a
;

264 
§
 
¿ddr1
, 
¿ddr2
;

266 
¿ddr1
 = *
	`sdp_medŸ_¿ddr
(
m
->
sdpm
);

267 
	`sdp_medŸ_¿ddr_¹ı
(
m
->
sdpm
, &
¿ddr2
);

269 ià(
m
->
tuºc1
 && 
	`§_is£t
(&
¿ddr1
, 
SA_ALL
))

270 
”r
 |ğ
	`tuºc_add_chª
(
m
->
tuºc1
, &
¿ddr1
, 
NULL
, NULL);

272 ià(
m
->
tuºc2
 && 
	`§_is£t
(&
¿ddr2
, 
SA_ALL
))

273 
”r
 |ğ
	`tuºc_add_chª
(
m
->
tuºc2
, &
¿ddr2
, 
NULL
, NULL);

276  
”r
;

277 
	}
}

280 
	$moduË_š™
()

282  
	`mÇt_»gi¡”
(&
mÇt
, 
	`b¬es_mÇ
(),

283 "tuº", 
NULL
, 
£ssiÚ_®loc
, 
medŸ_®loc
,

284 
upd©e
);

285 
	}
}

288 
	$moduË_şo£
()

290 
mÇt
 = 
	`mem_d”ef
(mnat);

293 
	}
}

296 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
tuº
) = {

299 
moduË_š™
,

300 
moduË_şo£
,

	@baresip/modules/uuid/uuid.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<¡dio.h
>

9 
	~<».h
>

10 
	~<b¬es.h
>

20 ’um { 
	mUUID_LEN
 = 36 };

23 
	$g’”©e_¿ndom_uuid
(
FILE
 *
f
)

25 ià(
	`»_årštf
(
f
, "%08x-%04x-%04x-%04x-%08x%04x",

26 
	`¿nd_u32
(), 
	`¿nd_u16
(),„and_u16(),„and_u16(),

27 
	`¿nd_u32
(), 
	`¿nd_u16
()è!ğ
UUID_LEN
)

28  
ENOMEM
;

31 
	}
}

34 
	$uuid_š™
(cÚ¡ *
fe
)

36 
FILE
 *
f
 = 
NULL
;

37 
”r
 = 0;

39 
f
 = 
	`fİ’
(
fe
, "r");

40 ià(
f
) {

41 
”r
 = 0;

42 
out
;

45 
f
 = 
	`fİ’
(
fe
, "w");

46 ià(!
f
) {

47 
”r
 = 
”ºo
;

48 
	`w¬nšg
("uuid: fİ’(è% (%m)\n", 
fe
, 
”r
);

49 
out
;

52 
”r
 = 
	`g’”©e_¿ndom_uuid
(
f
);

53 ià(
”r
) {

54 
	`w¬nšg
("uuid: g’”©¿ndom UUID faed (%m)\n", 
”r
);

55 
out
;

58 
	`šfo
("uuid: g’”©ed‚ew UUID iÀ%s\n", 
fe
);

60 
out
:

61 ià(
f
)

62 
	`fşo£
(
f
);

64  
”r
;

65 
	}
}

68 
	$uuid_lßd
(cÚ¡ *
fe
, *
uuid
, 
size_t
 
sz
)

70 
FILE
 *
f
 = 
NULL
;

71 
”r
 = 0;

73 
f
 = 
	`fİ’
(
fe
, "r");

74 ià(!
f
)

75  
”ºo
;

77 ià(!
	`fg‘s
(
uuid
, ()
sz
, 
f
))

78 
”r
 = 
”ºo
;

80 ()
	`fşo£
(
f
);

82 
	`debug
("uuid:†ßded UUID % äom f%s\n", 
uuid
, 
fe
);

84  
”r
;

85 
	}
}

88 
	$moduË_š™
()

90 
cÚfig
 *
cfg
 = 
	`cÚf_cÚfig
();

91 
·th
[256];

92 
”r
 = 0;

94 
”r
 = 
	`cÚf_·th_g‘
(
·th
, (path));

95 ià(
”r
)

96  
”r
;

98 
	`¡ºÿt
(
·th
, "/uuid", Õ©hè- 
	`¡¾’
(path) - 1);

100 
”r
 = 
	`uuid_š™
(
·th
);

101 ià(
”r
)

102  
”r
;

104 
”r
 = 
	`uuid_lßd
(
·th
, 
cfg
->
s
.
uuid
, (cfg->sip.uuid));

105 ià(
”r
)

106  
”r
;

109 
	}
}

112 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
uuid
) = {

114 
NULL
,

115 
moduË_š™
,

116 
NULL


	@baresip/modules/v4l/v4l.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 
	~<¡dlib.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/¡©.h
>

12 
	~<sys/ioùl.h
>

13 
	~<fú.h
>

14 
	~<uni¡d.h
>

15 #undeà
__STRICT_ANSI__


16 
	~<libv4l1-videodev.h
>

17 
	~<±h»ad.h
>

18 
	~<».h
>

19 
	~<»m.h
>

20 
	~<b¬es.h
>

30 
	svid¤c_¡
 {

31 cÚ¡ 
vid¤c
 *
	mvs
;

33 
	mfd
;

34 
±h»ad_t
 
	mth»ad
;

35 
boŞ
 
	mrun
;

36 
vidsz
 
	msize
;

37 
mbuf
 *
	mmb
;

38 
vidfmt
 
	mfmt
;

39 
vid¤c_äame_h
 *
	mäameh
;

40 *
	m¬g
;

44 
vid¤c
 *
	gvid¤c
;

47 
	$v4l_g‘_ÿps
(
vid¤c_¡
 *
¡
)

49 
video_ÿ·b™y
 
ÿps
;

51 ià(-1 =ğ
	`ioùl
(
¡
->
fd
, 
VIDIOCGCAP
, &
ÿps
)) {

52 
	`w¬nšg
("v4l: VIDIOCGCAP: %m\n", 
”ºo
);

56 
	`šfo
("v4l: video: \"%s\" (%ux%uè- (%ux%u)\n", 
ÿps
.
Çme
,

57 
ÿps
.
mšwidth
, c­s.
mšheight
,

58 
ÿps
.
maxwidth
, c­s.
maxheight
);

60 ià(
VID_TYPE_CAPTURE
 !ğ
ÿps
.
ty³
) {

61 
	`w¬nšg
("v4l:‚Ù‡ c­tu» deviû (%d)\n", 
ÿps
.
ty³
);

63 
	}
}

66 
	$v4l_check_·Ë‰e
(
vid¤c_¡
 *
¡
)

68 
video_piùu»
 
pic
;

70 ià(-1 =ğ
	`ioùl
(
¡
->
fd
, 
VIDIOCGPICT
, &
pic
)) {

71 
	`w¬nšg
("v4l: VIDIOCGPICT: %m\n", 
”ºo
);

72  
”ºo
;

75 
pic
.
·Ë‰e
) {

77 
VIDEO_PALETTE_RGB24
:

78 
¡
->
fmt
 = 
VID_FMT_RGB32
;

81 
VIDEO_PALETTE_YUYV
:

82 
¡
->
fmt
 = 
VID_FMT_YUYV422
;

86 
	`w¬nšg
("v4l: unsuµÜ‹d…®‘‹ %d\n", 
pic
.
·Ë‰e
);

87  
ENODEV
;

90 
	`šfo
("v4l:…ix– fÜm© i %s\n", 
	`vidfmt_Çme
(
¡
->
fmt
));

93 
	}
}

96 
	$v4l_g‘_wš
(
fd
, 
width
, 
height
)

98 
video_wšdow
 
wš
;

100 ià(-1 =ğ
	`ioùl
(
fd
, 
VIDIOCGWIN
, &
wš
)) {

101 
	`w¬nšg
("v4l: VIDIOCGWIN: %m\n", 
”ºo
);

102  
”ºo
;

105 
	`šfo
("v4l: video window: x,y=%u,%u (%u x %u)\n",

106 
wš
.
x
, wš.
y
, wš.
width
, wš.
height
);

108 
wš
.
width
 = width;

109 
wš
.
height
 = height;

111 ià(-1 =ğ
	`ioùl
(
fd
, 
VIDIOCSWIN
, &
wš
)) {

112 
	`w¬nšg
("v4l: VIDIOCSWIN: %m\n", 
”ºo
);

113  
”ºo
;

117 
	}
}

120 
	$ÿÎ_äame_hªdËr
(
vid¤c_¡
 *
¡
, 
ušt8_t
 *
buf
)

122 
vidäame
 
äame
;

124 
	`vidäame_š™_buf
(&
äame
, 
¡
->
fmt
, &¡->
size
, 
buf
);

126 
¡
->
	`äameh
(&
äame
, st->
¬g
);

127 
	}
}

130 *
	$»ad_th»ad
(*
¬g
)

132 
vid¤c_¡
 *
¡
 = 
¬g
;

134 
¡
->
run
) {

135 
ssize_t
 
n
;

137 
n
 = 
	`»ad
(
¡
->
fd
, st->
mb
->
buf
, st->mb->
size
);

138 ià((
ssize_t
)
¡
->
mb
->
size
 !ğ
n
) {

139 
	`w¬nšg
("v4l: video„ead: %d -> %d bytes\n",

140 
¡
->
mb
->
size
, 
n
);

144 
	`ÿÎ_äame_hªdËr
(
¡
, st->
mb
->
buf
);

147  
NULL
;

148 
	}
}

151 
	$vd_İ’
(
vid¤c_¡
 *
v4l
, cÚ¡ *
deviû
)

156 
v4l
->
fd
 = 
	`İ’
(
deviû
, 
O_RDWR
);

157 ià(
v4l
->
fd
 < 0) {

158 
	`w¬nšg
("v4l: o³À%s: %m\n", 
deviû
, 
”ºo
);

159  
”ºo
;

163 
	}
}

166 
	$de¡ruùÜ
(*
¬g
)

168 
vid¤c_¡
 *
¡
 = 
¬g
;

170 ià(
¡
->
run
) {

171 
¡
->
run
 = 
çl£
;

172 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

175 ià(
¡
->
fd
 >= 0)

176 
	`şo£
(
¡
->
fd
);

178 
	`mem_d”ef
(
¡
->
mb
);

179 
	}
}

182 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

183 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

184 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

185 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

186 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

188 
vid¤c_¡
 *
¡
;

189 
”r
;

191 ()
ùx
;

192 ()
´m
;

193 ()
fmt
;

194 ()
”rÜh
;

196 ià(!
¡p
 || !
size
 || !
äameh
)

197  
EINVAL
;

199 ià(!
	`¡r_is£t
(
dev
))

200 
dev
 = "/dev/video0";

202 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

203 ià(!
¡
)

204  
ENOMEM
;

206 
¡
->
vs
 = vs;

207 
¡
->
fd
 = -1;

208 
¡
->
size
 = *size;

209 
¡
->
äameh
 = frameh;

210 
¡
->
¬g
 =‡rg;

212 
	`šfo
("v4l: o³n: % (%u x %u)\n", 
dev
, 
size
->
w
, size->
h
);

214 
”r
 = 
	`vd_İ’
(
¡
, 
dev
);

215 ià(
”r
)

216 
out
;

218 
	`v4l_g‘_ÿps
(
¡
);

220 
”r
 = 
	`v4l_check_·Ë‰e
(
¡
);

221 ià(
”r
)

222 
out
;

224 
”r
 = 
	`v4l_g‘_wš
(
¡
->
fd
, st->
size
.
w
, st->size.
h
);

225 ià(
”r
)

226 
out
;

229 
¡
->
mb
 = 
	`mbuf_®loc
(
	`vidäame_size
(¡->
fmt
, &¡->
size
));

230 ià(!
¡
->
mb
) {

231 
”r
 = 
ENOMEM
;

232 
out
;

235 
¡
->
run
 = 
Œue
;

236 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

237 ià(
”r
) {

238 
¡
->
run
 = 
çl£
;

239 
out
;

242 
out
:

243 ià(
”r
)

244 
	`mem_d”ef
(
¡
);

246 *
¡p
 = 
¡
;

248  
”r
;

249 
	}
}

252 
	$v4l_š™
()

254  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(), "v4l", 
®loc
, 
NULL
);

255 
	}
}

258 
	$v4l_şo£
()

260 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

262 
	}
}

265 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
v4l
) = {

268 
v4l_š™
,

269 
v4l_şo£


	@baresip/modules/v4l2/v4l2.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<sys/ty³s.h
>

12 
	~<sys/¡©.h
>

13 
	~<sys/mmª.h
>

14 
	~<sys/ioùl.h
>

15 
	~<fú.h
>

16 
	~<uni¡d.h
>

17 #undeà
__STRICT_ANSI__


18 
	~<±h»ad.h
>

19 
	~<».h
>

20 
	~<»m.h
>

21 
	~<b¬es.h
>

22 #ià
defšed
 (
OPENBSD
è|| defšed (
NETBSD
)

23 
	~<sys/videoio.h
>

25 
	~<lšux/videodev2.h
>

28 #ifdeà
HAVE_LIBV4L2


29 
	~<libv4l2.h
>

31 
	#v4l2_İ’
 
İ’


	)

32 
	#v4l2_»ad
 
»ad


	)

33 
	#v4l2_ioùl
 
ioùl


	)

34 
	#v4l2_mm­
 
mm­


	)

35 
	#v4l2_munm­
 
munm­


	)

36 
	#v4l2_şo£
 
şo£


	)

47 
	sbufãr
 {

48 *
	m¡¬t
;

49 
size_t
 
	mËngth
;

52 
	svid¤c_¡
 {

53 cÚ¡ 
vid¤c
 *
	mvs
;

55 
	mfd
;

56 
±h»ad_t
 
	mth»ad
;

57 
boŞ
 
	mrun
;

58 
vidsz
 
	msz
;

59 
u_št32_t
 
	mpixfmt
;

60 
bufãr
 *
	mbufãrs
;

61 
	mn_bufãrs
;

62 
vid¤c_äame_h
 *
	mäameh
;

63 *
	m¬g
;

67 
vid¤c
 *
	gvid¤c
;

70 
vidfmt
 
	$m©ch_fmt
(
u_št32_t
 
fmt
)

72 
fmt
) {

74 
V4L2_PIX_FMT_YUV420
:  
VID_FMT_YUV420P
;

75 
V4L2_PIX_FMT_YUYV
:  
VID_FMT_YUYV422
;

76 
V4L2_PIX_FMT_UYVY
:  
VID_FMT_UYVY422
;

77 
V4L2_PIX_FMT_RGB32
:  
VID_FMT_RGB32
;

78 
V4L2_PIX_FMT_RGB565
:  
VID_FMT_RGB565
;

79 
V4L2_PIX_FMT_RGB555
:  
VID_FMT_RGB555
;

80 
V4L2_PIX_FMT_NV12
:  
VID_FMT_NV12
;

81 
V4L2_PIX_FMT_NV21
:  
VID_FMT_NV21
;

82 :  
VID_FMT_N
;

84 
	}
}

87 
	$´št_video_šput
(cÚ¡ 
vid¤c_¡
 *
¡
)

89 
v4l2_šput
 
šput
;

91 
	`mem£t
(&
šput
, 0, (input));

93 #iâdeà
OPENBSD


94 ià(-1 =ğ
	`v4l2_ioùl
(
¡
->
fd
, 
VIDIOC_G_INPUT
, &
šput
.
šdex
)) {

95 
	`w¬nšg
("v4l2: VIDIOC_G_INPUT: %m\n", 
”ºo
);

100 ià(-1 =ğ
	`v4l2_ioùl
(
¡
->
fd
, 
VIDIOC_ENUMINPUT
, &
šput
)) {

101 
	`w¬nšg
("v4l2: VIDIOC_ENUMINPUT: %m\n", 
”ºo
);

105 
	`šfo
("v4l2: Cu¼’ˆšput: \"%s\"\n", 
šput
.
Çme
);

106 
	}
}

109 
	$xioùl
(
fd
, 
»que¡
, *
¬g
)

111 
r
;

114 
r
 = 
	`v4l2_ioùl
(
fd
, 
»que¡
, 
¬g
);

116 -1 =ğ
r
 && 
EINTR
 =ğ
”ºo
);

118  
r
;

119 
	}
}

122 
	$š™_mm­
(
vid¤c_¡
 *
¡
, cÚ¡ *
dev_Çme
)

124 
v4l2_»que¡bufãrs
 
»q
;

126 
	`mem£t
(&
»q
, 0, (req));

128 
»q
.
couÁ
 = 4;

129 
»q
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

130 
»q
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

132 ià(-1 =ğ
	`xioùl
(
¡
->
fd
, 
VIDIOC_REQBUFS
, &
»q
)) {

133 ià(
EINVAL
 =ğ
”ºo
) {

134 
	`w¬nšg
("v4l2: %s does‚ot support "

135 "memÜy m­pšg\n", 
dev_Çme
);

136  
”ºo
;

139  
”ºo
;

143 ià(
»q
.
couÁ
 < 2) {

144 
	`w¬nšg
("v4l2: Insuffic›Á bufã¸memÜy oÀ%s\n", 
dev_Çme
);

145  
ENOMEM
;

148 
¡
->
bufãrs
 = 
	`mem_z®loc
(
»q
.
couÁ
 * (*¡->bufãrs), 
NULL
);

149 ià(!
¡
->
bufãrs
)

150  
ENOMEM
;

152 
¡
->
n_bufãrs
 = 0; st->n_bufãrs<
»q
.
couÁ
; ++st->n_buffers) {

153 
v4l2_bufãr
 
buf
;

155 
	`mem£t
(&
buf
, 0, (buf));

157 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

158 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

159 
buf
.
šdex
 = 
¡
->
n_bufãrs
;

161 ià(-1 =ğ
	`xioùl
(
¡
->
fd
, 
VIDIOC_QUERYBUF
, &
buf
)) {

162 
	`w¬nšg
("v4l2: VIDIOC_QUERYBUF\n");

163  
”ºo
;

166 
¡
->
bufãrs
[¡->
n_bufãrs
].
Ëngth
 = 
buf
.length;

167 
¡
->
bufãrs
[¡->
n_bufãrs
].
¡¬t
 =

168 
	`v4l2_mm­
(
NULL
 ,

169 
buf
.
Ëngth
,

170 
PROT_READ
 | 
PROT_WRITE
 ,

171 
MAP_SHARED
 ,

172 
¡
->
fd
, 
buf
.
m
.
off£t
);

174 ià(
MAP_FAILED
 =ğ
¡
->
bufãrs
[¡->
n_bufãrs
].
¡¬t
) {

175 
	`w¬nšg
("v4l2: mmap failed\n");

176  
ENODEV
;

181 
	}
}

184 
	$v4l2_š™_deviû
(
vid¤c_¡
 *
¡
, cÚ¡ *
dev_Çme
,

185 
width
, 
height
)

187 
v4l2_ÿ·b™y
 
ÿp
;

188 
v4l2_fÜm©
 
fmt
;

189 
v4l2_fmtdesc
 
fmts
;

190 
mš
;

191 cÚ¡ *
pix
;

192 
”r
;

194 ià(-1 =ğ
	`xioùl
(
¡
->
fd
, 
VIDIOC_QUERYCAP
, &
ÿp
)) {

195 ià(
EINVAL
 =ğ
”ºo
) {

196 
	`w¬nšg
("v4l2: % i nØV4L2 deviû\n", 
dev_Çme
);

197  
ENODEV
;

200 
	`w¬nšg
("v4l2: VIDIOC_QUERYCAP: %m\n", 
”ºo
);

201  
”ºo
;

205 ià(!(
ÿp
.
ÿ·b™›s
 & 
V4L2_CAP_VIDEO_CAPTURE
)) {

206 
	`w¬nšg
("v4l2: % i nØvideØÿ±u» deviû\n", 
dev_Çme
);

207  
ENODEV
;

210 ià(!(
ÿp
.
ÿ·b™›s
 & 
V4L2_CAP_STREAMING
)) {

211 
	`w¬nšg
("v4l2: %s does‚ot support streaming i/o\n",

212 
dev_Çme
);

213  
ENOSYS
;

217 
	`mem£t
(&
fmts
, 0, (fmts));

219 
fmts
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

220 
fmts
.
šdex
=0; !
	`v4l2_ioùl
(
¡
->
fd
, 
VIDIOC_ENUM_FMT
, &fmts);

221 
fmts
.
šdex
++) {

222 ià(
	`m©ch_fmt
(
fmts
.
pix–fÜm©
è!ğ
VID_FMT_N
) {

223 
¡
->
pixfmt
 = 
fmts
.
pix–fÜm©
;

228 ià(!
¡
->
pixfmt
) {

229 
	`w¬nšg
("v4l2: fÜm©‚egÙŸtiÚ faed: %m\n", 
”ºo
);

230  
”ºo
;

235 
	`mem£t
(&
fmt
, 0, (fmt));

237 
fmt
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

238 
fmt
.fmt.
pix
.
width
 = width;

239 
fmt
.fmt.
pix
.
height
 = height;

240 
fmt
.fmt.
pix
.
pix–fÜm©
 = 
¡
->
pixfmt
;

241 
fmt
.fmt.
pix
.
f›ld
 = 
V4L2_FIELD_INTERLACED
;

243 ià(-1 =ğ
	`xioùl
(
¡
->
fd
, 
VIDIOC_S_FMT
, &
fmt
)) {

244 
	`w¬nšg
("v4l2: VIDIOC_S_FMT: %m\n", 
”ºo
);

245  
”ºo
;

251 
mš
 = 
fmt
.fmt.
pix
.
width
 * 2;

252 ià(
fmt
.fmt.
pix
.
by‹¥”lše
 < 
mš
)

253 
fmt
.fmt.
pix
.
by‹¥”lše
 = 
mš
;

254 
mš
 = 
fmt
.fmt.
pix
.
by‹¥”lše
 * fmt.fmt.pix.
height
;

255 ià(
fmt
.fmt.
pix
.
sizeimage
 < 
mš
)

256 
fmt
.fmt.
pix
.
sizeimage
 = 
mš
;

258 
¡
->
sz
.
w
 = 
fmt
.fmt.
pix
.
width
;

259 
¡
->
sz
.
h
 = 
fmt
.fmt.
pix
.
height
;

261 
”r
 = 
	`š™_mm­
(
¡
, 
dev_Çme
);

262 ià(
”r
)

263  
”r
;

265 
pix
 = (*)&
fmt
.fmt.pix.
pix–fÜm©
;

267 ià(
¡
->
pixfmt
 !ğ
fmt
.fmt.
pix
.
pix–fÜm©
) {

268 
	`w¬nšg
("v4l2: %s: uÃx³ùedly gÙ %c%c%c%c\n", 
dev_Çme
,

269 
pix
[0],…ix[1],…ix[2],…ix[3]);

270  
ENODEV
;

273 
	`šfo
("v4l2: %s: found valid V4L2 device (%u x %u)…ixfmt=%c%c%c%c\n",

274 
dev_Çme
, 
fmt
.fmt.
pix
.
width
, fmt.fmt.pix.
height
,

275 
pix
[0],…ix[1],…ix[2],…ix[3]);

278 
	}
}

281 
	$¡İ_ÿ±uršg
(
vid¤c_¡
 *
¡
)

283 
v4l2_buf_ty³
 
ty³
;

285 ià(
¡
->
fd
 < 0)

288 
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

290 
	`xioùl
(
¡
->
fd
, 
VIDIOC_STREAMOFF
, &
ty³
);

291 
	}
}

294 
	$unš™_deviû
(
vid¤c_¡
 *
¡
)

296 
i
;

298 
i
=0; i<
¡
->
n_bufãrs
; ++i) {

299 
	`v4l2_munm­
(
¡
->
bufãrs
[
i
].
¡¬t
, st->bufãrs[i].
Ëngth
);

302 
¡
->
bufãrs
 = 
	`mem_d”ef
(st->buffers);

303 
¡
->
n_bufãrs
 = 0;

304 
	}
}

307 
	$¡¬t_ÿ±uršg
(
vid¤c_¡
 *
¡
)

309 
i
;

310 
v4l2_buf_ty³
 
ty³
;

312 
i
 = 0; i < 
¡
->
n_bufãrs
; ++i) {

313 
v4l2_bufãr
 
buf
;

315 
	`mem£t
(&
buf
, 0, (buf));

317 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

318 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

319 
buf
.
šdex
 = 
i
;

321 ià(-1 =ğ
	`xioùl
 (
¡
->
fd
, 
VIDIOC_QBUF
, &
buf
))

322  
”ºo
;

325 
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

327 ià(-1 =ğ
	`xioùl
 (
¡
->
fd
, 
VIDIOC_STREAMON
, &
ty³
))

328  
”ºo
;

331 
	}
}

334 
	$ÿÎ_äame_hªdËr
(
vid¤c_¡
 *
¡
, 
ušt8_t
 *
buf
)

336 
vidäame
 
äame
;

338 
	`vidäame_š™_buf
(&
äame
, 
	`m©ch_fmt
(
¡
->
pixfmt
), &¡->
sz
, 
buf
);

340 
¡
->
	`äameh
(&
äame
, st->
¬g
);

341 
	}
}

344 
	$»ad_äame
(
vid¤c_¡
 *
¡
)

346 
v4l2_bufãr
 
buf
;

348 
	`mem£t
(&
buf
, 0, (buf));

350 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

351 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

353 ià(-1 =ğ
	`xioùl
 (
¡
->
fd
, 
VIDIOC_DQBUF
, &
buf
)) {

354 
”ºo
) {

356 
EAGAIN
:

359 
EIO
:

365 
	`w¬nšg
("v4l2: VIDIOC_DQBUF: %m\n", 
”ºo
);

366  
”ºo
;

370 ià(
buf
.
šdex
 >ğ
¡
->
n_bufãrs
) {

371 
	`w¬nšg
("v4l2: index >=‚_buffers\n");

374 
	`ÿÎ_äame_hªdËr
(
¡
, st->
bufãrs
[
buf
.
šdex
].
¡¬t
);

376 ià(-1 =ğ
	`xioùl
 (
¡
->
fd
, 
VIDIOC_QBUF
, &
buf
)) {

377 
	`w¬nšg
("v4l2: VIDIOC_QBUF\n");

378  
”ºo
;

382 
	}
}

385 
	$vd_İ’
(
vid¤c_¡
 *
¡
, cÚ¡ *
deviû
)

387 
¡
->
fd
 = 
	`v4l2_İ’
(
deviû
, 
O_RDWR
);

388 ià(
¡
->
fd
 < 0) {

389 
	`w¬nšg
("v4l2: o³À%s: %m\n", 
deviû
, 
”ºo
);

390  
”ºo
;

394 
	}
}

397 
	$de¡ruùÜ
(*
¬g
)

399 
vid¤c_¡
 *
¡
 = 
¬g
;

401 
	`debug
("v4l2: stopping video source..\n");

403 ià(
¡
->
run
) {

404 
¡
->
run
 = 
çl£
;

405 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

408 
	`¡İ_ÿ±uršg
(
¡
);

409 
	`unš™_deviû
(
¡
);

411 ià(
¡
->
fd
 >= 0)

412 
	`v4l2_şo£
(
¡
->
fd
);

413 
	}
}

416 *
	$»ad_th»ad
(*
¬g
)

418 
vid¤c_¡
 *
¡
 = 
¬g
;

419 
”r
;

421 
¡
->
run
) {

422 
”r
 = 
	`»ad_äame
(
¡
);

423 ià(
”r
) {

424 
	`w¬nšg
("v4l2:„—d_äame: %m\n", 
”r
);

428  
NULL
;

429 
	}
}

432 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

433 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

434 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

435 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

436 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

438 
vid¤c_¡
 *
¡
;

439 
”r
;

441 ()
ùx
;

442 ()
´m
;

443 ()
fmt
;

444 ()
”rÜh
;

446 ià(!
¡p
 || !
size
 || !
äameh
)

447  
EINVAL
;

449 ià(!
	`¡r_is£t
(
dev
))

450 
dev
 = "/dev/video0";

452 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

453 ià(!
¡
)

454  
ENOMEM
;

456 
¡
->
vs
 = vs;

457 
¡
->
fd
 = -1;

458 
¡
->
sz
 = *
size
;

459 
¡
->
äameh
 = frameh;

460 
¡
->
¬g
 =‡rg;

461 
¡
->
pixfmt
 = 0;

463 
”r
 = 
	`vd_İ’
(
¡
, 
dev
);

464 ià(
”r
)

465 
out
;

467 
”r
 = 
	`v4l2_š™_deviû
(
¡
, 
dev
, 
size
->
w
, size->
h
);

468 ià(
”r
)

469 
out
;

471 
	`´št_video_šput
(
¡
);

473 
”r
 = 
	`¡¬t_ÿ±uršg
(
¡
);

474 ià(
”r
)

475 
out
;

477 
¡
->
run
 = 
Œue
;

478 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

479 ià(
”r
) {

480 
¡
->
run
 = 
çl£
;

481 
out
;

484 
out
:

485 ià(
”r
)

486 
	`mem_d”ef
(
¡
);

488 *
¡p
 = 
¡
;

490  
”r
;

491 
	}
}

494 
	$v4l_š™
()

496  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

497 "v4l2", 
®loc
, 
NULL
);

498 
	}
}

501 
	$v4l_şo£
()

503 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

505 
	}
}

508 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
v4l2
) = {

511 
v4l_š™
,

512 
v4l_şo£


	@baresip/modules/v4l2_codec/v4l2_codec.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	~<uni¡d.h
>

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/¡©.h
>

12 
	~<sys/mmª.h
>

13 
	~<sys/ioùl.h
>

14 
	~<fú.h
>

15 
	~<».h
>

16 
	~<»m.h
>

17 
	~<b¬es.h
>

18 #ià
defšed
 (
OPENBSD
è|| defšed (
NETBSD
)

19 
	~<sys/videoio.h
>

21 
	~<lšux/videodev2.h
>

43 
	svid¤c_¡
 {

44 cÚ¡ 
vid¤c
 *
	mvs
;

46 
ušt8_t
 *
	mbufãr
;

47 
size_t
 
	mbufãr_Ën
;

48 
	mfd
;

50 
	mn_key
;

51 
	mn_d–
;

52 } 
	m¡©s
;

55 
	svid’c_¡©e
 {

56 
Ë
 
	mË
;

57 
vid’c_·¿m
 
	m’ırm
;

58 
vid’c_·ck‘_h
 *
	mpkth
;

59 *
	m¬g
;

66 
li¡
 
	m’cod”l
;

67 } 
	gv4l2
;

70 
vid¤c
 *
	gvid¤c
;

73 
	$xioùl
(
fd
, 
»que¡
, *
¬g
)

75 
r
;

77 dØ
r
 = 
	`ioùl
 (
fd
, 
»que¡
, 
¬g
);

78 -1 =ğ
r
 && 
EINTR
 =ğ
”ºo
);

80  
r
;

81 
	}
}

84 
	$´št_ÿps
(
fd
, 
width
, 
height
)

86 
v4l2_ÿ·b™y
 
ÿps
;

87 
v4l2_fmtdesc
 
fmtdesc
;

88 
v4l2_fÜm©
 
fmt
;

89 
boŞ
 
suµÜt_h264
 = 
çl£
;

90 
fourcc
[5] = {0};

91 
c
;

92 
”r
;

94 
	`mem£t
(&
ÿps
, 0, (caps));

95 
	`mem£t
(&
fmtdesc
, 0, (fmtdesc));

96 
	`mem£t
(&
fmt
, 0, (fmt));

98 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_QUERYCAP
, &
ÿps
)) {

99 
”r
 = 
”ºo
;

100 
	`w¬nšg
("v4l2_codec:ƒ¼Ü Qu”yšg C­ab™› (%m)\n", 
”r
);

101  
”r
;

104 
	`šfo
("v4l2_codec: Driver Caps:\n"

110 
ÿps
.
driv”
,

111 
ÿps
.
ÿrd
,

112 
ÿps
.
bus_šfo
,

113 (
ÿps
.
v”siÚ
>>16) & 0xff,

114 (
ÿps
.
v”siÚ
>>24) & 0xff,

115 
ÿps
.
ÿ·b™›s
);

118 
fmtdesc
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

120 
	`šfo
(" Formats:\n");

122 0 =ğ
	`xioùl
(
fd
, 
VIDIOC_ENUM_FMT
, &
fmtdesc
)) {

123 
boŞ
 
£Ëùed
 = 
çl£
;

125 
	`¡ºıy
(
fourcc
, (*)&
fmtdesc
.
pix–fÜm©
, 4);

127 #ifdeà
V4L2_PIX_FMT_H264


128 ià(
fmtdesc
.
pix–fÜm©
 =ğ
V4L2_PIX_FMT_H264
) {

129 
suµÜt_h264
 = 
Œue
;

130 
£Ëùed
 = 
Œue
;

134 
c
 = 
fmtdesc
.
æags
 & 
V4L2_FMT_FLAG_COMPRESSED
 ? 'C' : ' ';

136 
	`šfo
(" %c %s: %c '%s'\n",

137 
£Ëùed
 ? '>' : ' ',

138 
fourcc
, 
c
, 
fmtdesc
.
desütiÚ
);

140 
fmtdesc
.
šdex
++;

143 
	`šfo
("\n");

145 ià(!
suµÜt_h264
) {

146 
	`w¬nšg
("v4l2_codec: Doesn't support H264.\n");

147  
ENODEV
;

150 
fmt
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

151 
fmt
.fmt.
pix
.
width
 = width;

152 
fmt
.fmt.
pix
.
height
 = height;

153 #ifdeà
V4L2_PIX_FMT_H264


154 
fmt
.fmt.
pix
.
pix–fÜm©
 = 
V4L2_PIX_FMT_H264
;

156 
fmt
.fmt.
pix
.
f›ld
 = 
V4L2_FIELD_NONE
;

158 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_S_FMT
, &
fmt
)) {

159 
”r
 = 
”ºo
;

160 
	`w¬nšg
("v4l2_codec: S‘tšg Pix– FÜm© (%m)\n", 
”r
);

161  
”r
;

164 
	`¡ºıy
(
fourcc
, (*)&
fmt
.fmt.
pix
.
pix–fÜm©
, 4);

165 
	`šfo
("v4l2_codec: Selected Camera Mode:\n"

170 
fmt
.fmt.
pix
.
width
,

171 
fmt
.fmt.
pix
.
height
,

172 
fourcc
,

173 
fmt
.fmt.
pix
.
f›ld
);

176 
	}
}

179 
	$š™_mm­
(
vid¤c_¡
 *
¡
, 
fd
)

181 
v4l2_»que¡bufãrs
 
»q
;

182 
v4l2_bufãr
 
buf
;

183 
”r
;

185 
	`mem£t
(&
»q
, 0, (req));

186 
	`mem£t
(&
buf
, 0, (buf));

188 
»q
.
couÁ
 = 1;

189 
»q
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

190 
»q
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

192 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_REQBUFS
, &
»q
)) {

193 
”r
 = 
”ºo
;

194 
	`w¬nšg
("v4l2_codec: Reque¡šg Bufã¸(%m)\n", 
”r
);

195  
”r
;

198 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

199 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

200 
buf
.
šdex
 = 0;

201 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_QUERYBUF
, &
buf
)) {

202 
”r
 = 
”ºo
;

203 
	`w¬nšg
("v4l2_codec: Qu”yšg Bufã¸(%m)\n", 
”r
);

204  
”r
;

207 
¡
->
bufãr
 = 
	`mm­
(
NULL
, 
buf
.
Ëngth
,

208 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
,

209 
fd
, 
buf
.
m
.
off£t
);

210 ià(
¡
->
bufãr
 =ğ
MAP_FAILED
) {

211 
”r
 = 
”ºo
;

212 
	`w¬nšg
("v4l2_codec: mm­ faed (%m)\n", 
”r
);

213  
”r
;

215 
¡
->
bufãr_Ën
 = 
buf
.
Ëngth
;

218 
	}
}

221 
	$qu”y_bufãr
(
fd
)

223 
v4l2_bufãr
 
buf
;

225 
	`mem£t
(&
buf
, 0, (buf));

227 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

228 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

229 
buf
.
šdex
 = 0;

231 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_QBUF
, &
buf
))

232  
”ºo
;

235 
	}
}

238 
	$¡¬t_¡»amšg
(
fd
)

240 
v4l2_bufãr
 
buf
;

241 
”r
;

243 
	`mem£t
(&
buf
, 0, (buf));

245 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

246 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

247 
buf
.
šdex
 = 0;

249 ià(-1 =ğ
	`xioùl
(
fd
, 
VIDIOC_STREAMON
, &
buf
.
ty³
)) {

250 
”r
 = 
”ºo
;

251 
	`w¬nšg
("v4l2_codec: S¹ C­tu» (%m)\n", 
”r
);

252  
”r
;

256 
	}
}

259 
	$¡İ_ÿ±uršg
(
fd
)

261 
v4l2_buf_ty³
 
ty³
;

263 ià(
fd
 < 0)

266 
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

268 
	`xioùl
(
fd
, 
VIDIOC_STREAMOFF
, &
ty³
);

269 
	}
}

272 
	$’c_de¡ruùÜ
(*
¬g
)

274 
vid’c_¡©e
 *
¡
 = 
¬g
;

276 
	`li¡_uÆšk
(&
¡
->
Ë
);

277 
	}
}

280 
	$’cod”s_»ad
(
ušt32_t
 
¹p_ts
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
)

282 
Ë
 *le;

283 
”r
;

285 
Ë
 = 
v4l2
.
’cod”l
.
h—d
;†e;†ğË->
Ãxt
) {

286 
vid’c_¡©e
 *
¡
 = 
Ë
->
d©a
;

288 
”r
 = 
	`h264_·ck‘ize
(
¹p_ts
, 
buf
, 
sz
,

289 
¡
->
’ırm
.
pktsize
,

290 
¡
->
pkth
, st->
¬g
);

291 ià(
”r
) {

292 
	`w¬nšg
("h264_·ck‘iz”rÜ (%m)\n", 
”r
);

295 
	}
}

298 
	$»ad_hªdËr
(
æags
, *
¬g
)

300 
vid¤c_¡
 *
¡
 = 
¬g
;

301 
v4l2_bufãr
 
buf
;

302 
boŞ
 
keyäame
 = 
çl£
;

303 
timev®
 
ts
;

304 
ušt32_t
 
¹p_ts
;

305 
”r
;

307 ià(
æags
 & 
FD_EXCEPT
) {

308 
	`w¬nšg
("v4l2_codec: deviceƒrror\n");

312 
	`mem£t
(&
buf
, 0, (buf));

314 
buf
.
ty³
 = 
V4L2_BUF_TYPE_VIDEO_CAPTURE
;

315 
buf
.
memÜy
 = 
V4L2_MEMORY_MMAP
;

316 
buf
.
šdex
 = 0;

318 ià(-1 =ğ
	`xioùl
(
¡
->
fd
, 
VIDIOC_DQBUF
, &
buf
)) {

319 
”r
 = 
”ºo
;

320 
	`w¬nšg
("v4l2_codec: R‘r›všg F¿m(%m)\n", 
”r
);

326 
mbuf
 
mb
 = {0,0,0,0};

327 
h264_hdr
 
hdr
;

329 
mb
.
buf
 = 
¡
->
bufãr
;

330 
mb
.
pos
 = 4;

331 
mb
.
’d
 = 
buf
.
by‹su£d
 - 4;

332 
mb
.
size
 = 
buf
.
by‹su£d
;

334 
”r
 = 
	`h264_hdr_decode
(&
hdr
, &
mb
);

335 ià(
”r
) {

336 
	`w¬nšg
("could‚ot decode H.264 header\n");

339 
keyäame
 = 
	`h264_is_keyäame
(
hdr
.
ty³
);

340 ià(
keyäame
) {

341 ++
¡
->
¡©s
.
n_key
;

344 ++
¡
->
¡©s
.
n_d–
;

348 
ts
 = 
buf
.
time¡amp
;

349 
¹p_ts
 = (90000ULL * (1000000*
ts
.
tv_£c
 +s.
tv_u£c
)) / 1000000;

352 
	`debug
("v4l2_codec: %s frame captured‡t %ldsec, %ldusec (%zu bytes)\n",

353 
keyäame
 ? "KEY" : " ",

354 
buf
.
time¡amp
.
tv_£c
, buf.time¡amp.
tv_u£c
,

355 (
size_t
)
buf
.
by‹su£d
);

359 
	`’cod”s_»ad
(
¹p_ts
, 
¡
->
bufãr
, 
buf
.
by‹su£d
);

361 
”r
 = 
	`qu”y_bufãr
(
¡
->
fd
);

362 ià(
”r
) {

363 
	`w¬nšg
("v4l2_codec: qu”y_bufã¸çed (%m)\n", 
”r
);

365 
	}
}

368 
	$İ’_’cod”
(
vid¤c_¡
 *
¡
, cÚ¡ *
deviû
,

369 
width
, 
height
)

371 
”r
;

373 
	`debug
("v4l2_codec: opening video-encoder device (device=%s)\n",

374 
deviû
);

376 
¡
->
fd
 = 
	`İ’
(
deviû
, 
O_RDWR
);

377 ià(
¡
->
fd
 == -1) {

378 
”r
 = 
”ºo
;

379 
	`w¬nšg
("O³nšg videØdeviû (%m)\n", 
”r
);

380 
out
;

383 
”r
 = 
	`´št_ÿps
(
¡
->
fd
, 
width
, 
height
);

384 ià(
”r
)

385 
out
;

387 
”r
 = 
	`š™_mm­
(
¡
, st->
fd
);

388 ià(
”r
)

389 
out
;

391 
”r
 = 
	`qu”y_bufãr
(
¡
->
fd
);

392 ià(
”r
)

393 
out
;

395 
”r
 = 
	`¡¬t_¡»amšg
(
¡
->
fd
);

396 ià(
”r
)

397 
out
;

399 
”r
 = 
	`fd_li¡’
(
¡
->
fd
, 
FD_READ
, 
»ad_hªdËr
, st);

400 ià(
”r
)

401 
out
;

403 
out
:

404  
”r
;

405 
	}
}

408 
	$’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

409 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

410 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

412 
vid’c_¡©e
 *
¡
;

413 
”r
 = 0;

414 ()
fm
;

416 ià(!
ve¥
 || !
vc
 || !
´m
 || !
pkth
)

417  
EINVAL
;

419 ià(*
ve¥
)

422 
¡
 = 
	`mem_z®loc
((*¡), 
’c_de¡ruùÜ
);

423 ià(!
¡
)

424  
ENOMEM
;

426 
¡
->
’ırm
 = *
´m
;

427 
¡
->
pkth
 =…kth;

428 
¡
->
¬g
 =‡rg;

430 
	`li¡_­³nd
(&
v4l2
.
’cod”l
, &
¡
->
Ë
, st);

432 
	`šfo
("v4l2_codec: videoƒncoder %s: %d fps, %d bit/s,…ktsize=%u\n",

433 
vc
->
Çme
, 
´m
->
ås
,…rm->
b™¿‹
,…rm->
pktsize
);

435 ià(
”r
)

436 
	`mem_d”ef
(
¡
);

438 *
ve¥
 = 
¡
;

440  
”r
;

441 
	}
}

445 
	$’code_·ck‘
(
vid’c_¡©e
 *
¡
, 
boŞ
 
upd©e
,

446 cÚ¡ 
vidäame
 *
äame
)

448 ()
¡
;

449 ()
upd©e
;

450 ()
äame
;

452 
	}
}

455 
ušt32_t
 
	$·ck‘iz©iÚ_mode
(cÚ¡ *
fm
)

457 
¶
…l, 
mode
;

459 ià(!
fm
)

462 
	`¶_£t_¡r
(&
¶
, 
fm
);

464 ià(
	`fmt_·¿m_g‘
(&
¶
, "·ck‘iz©iÚ-mode", &
mode
))

465  
	`¶_u32
(&
mode
);

468 
	}
}

471 
	$h264_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

472 
boŞ
 
ofãr
, *
¬g
)

474 
vidcodec
 *
vc
 = 
¬g
;

475 cÚ¡ 
ušt8_t
 
´ofe_idc
 = 0x42;

476 cÚ¡ 
ušt8_t
 
´ofe_iİ
 = 0x80;

477 cÚ¡ 
ušt8_t
 
h264_Ëv–_idc
 = 0x0c;

478 ()
ofãr
;

480 ià(!
mb
 || !
fmt
 || !
vc
)

483  
	`mbuf_´štf
(
mb
, "a=fmtp:%s"

487 
fmt
->
id
, 
´ofe_idc
, 
´ofe_iİ
, 
h264_Ëv–_idc
);

488 
	}
}

491 
boŞ
 
	$h264_fm_cmp
(cÚ¡ *
fm1
, cÚ¡ *
fm2
, *
d©a
)

493 ()
d©a
;

495  
	`·ck‘iz©iÚ_mode
(
fm1
è=ğ·ck‘iz©iÚ_mode(
fm2
);

496 
	}
}

499 
	$¤c_de¡ruùÜ
(*
¬g
)

501 
vid¤c_¡
 *
¡
 = 
¬g
;

503 ià(
¡
->
fd
 >=0 ) {

504 
	`šfo
("v4l2_codec:ƒncoder stats"

506 
¡
->
¡©s
.
n_key
, st->¡©s.
n_d–
);

509 
	`¡İ_ÿ±uršg
(
¡
->
fd
);

511 ià(
¡
->
bufãr
)

512 
	`munm­
(
¡
->
bufãr
, st->
bufãr_Ën
);

514 ià(
¡
->
fd
 >= 0) {

515 
	`fd_şo£
(
¡
->
fd
);

516 
	`şo£
(
¡
->
fd
);

518 
	}
}

521 
	$¤c_®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

522 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

523 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

524 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

525 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

527 
vid¤c_¡
 *
¡
;

528 
”r
 = 0;

530 ()
ùx
;

531 ()
´m
;

532 ()
fmt
;

533 ()
”rÜh
;

534 ()
¬g
;

536 ià(!
¡p
 || !
size
 || !
äameh
)

537  
EINVAL
;

539 ià(!
	`¡r_is£t
(
dev
))

540 
dev
 = "/dev/video0";

542 
	`debug
("v4l2_codec: video-sourû‡Îoø(deviû=%s)\n", 
dev
);

544 
¡
 = 
	`mem_z®loc
((*¡), 
¤c_de¡ruùÜ
);

545 ià(!
¡
)

546  
ENOMEM
;

548 
¡
->
vs
 = vs;

550 
”r
 = 
	`İ’_’cod”
(
¡
, 
dev
, 
size
->
w
, size->
h
);

551 ià(
”r
)

552 
out
;

554 
out
:

555 ià(
”r
)

556 
	`mem_d”ef
(
¡
);

558 *
¡p
 = 
¡
;

560  
”r
;

561 
	}
}

564 
vidcodec
 
	gh264
 = {

565 
LE_INIT
,

566 
NULL
,

569 
NULL
,

570 
’code_upd©e
,

571 
’code_·ck‘
,

572 
NULL
,

573 
NULL
,

574 
h264_fm_’c
,

575 
h264_fm_cmp
,

579 
	$moduË_š™
()

581 
	`šfo
("v4l2_codec inited\n");

583 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
h264
);

584  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

585 "v4l2_codec", 
¤c_®loc
, 
NULL
);

586 
	}
}

589 
	$moduË_şo£
()

591 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

592 
	`vidcodec_uÄegi¡”
(&
h264
);

595 
	}
}

598 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
v4l2_codec
) = {

601 
moduË_š™
,

602 
moduË_şo£


	@baresip/modules/vidbridge/disp.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vidbridge.h
"

12 
	$de¡ruùÜ
(*
¬g
)

14 
vidi¥_¡
 *
¡
 = 
¬g
;

16 ià(
¡
->
vid¤c
)

17 
¡
->
vid¤c
->
vidi¥
 = 
NULL
;

19 
	`li¡_uÆšk
(&
¡
->
Ë
);

20 
	`mem_d”ef
(
¡
->
deviû
);

21 
	}
}

24 
	$vidbridge_di¥_®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

25 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

26 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

28 
vidi¥_¡
 *
¡
;

29 
”r
 = 0;

30 ()
´m
;

31 ()
»sizeh
;

32 ()
¬g
;

34 ià(!
¡p
 || !
vd
 || !
dev
)

35  
EINVAL
;

37 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

38 ià(!
¡
)

39  
ENOMEM
;

41 
¡
->
vd
 = vd;

43 
”r
 = 
	`¡r_dup
(&
¡
->
deviû
, 
dev
);

44 ià(
”r
)

45 
out
;

48 
¡
->
vid¤c
 = 
	`vidbridge_¤c_fšd
(
dev
);

49 ià(
¡
->
vid¤c
) {

50 
¡
->
vid¤c
->
vidi¥
 = st;

53 
	`hash_­³nd
(
ht_di¥
, 
	`hash_jß©_¡r
(
dev
), &
¡
->
Ë
, st);

55 
out
:

56 ià(
”r
)

57 
	`mem_d”ef
(
¡
);

59 *
¡p
 = 
¡
;

61  
”r
;

62 
	}
}

65 
boŞ
 
	$li¡_­¶y_hªdËr
(
Ë
 *Ë, *
¬g
)

67 
vidi¥_¡
 *
¡
 = 
Ë
->
d©a
;

69  0 =ğ
	`¡r_cmp
(
¡
->
deviû
, 
¬g
);

70 
	}
}

73 
	$vidbridge_di¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

74 cÚ¡ 
vidäame
 *
äame
)

76 
”r
 = 0;

77 ()
t™Ë
;

79 ià(
¡
->
vid¤c
)

80 
	`vidbridge_¤c_šput
(
¡
->
vid¤c
, 
äame
);

82 
	`debug
("vidbridge: display: dropping frame (%u x %u)\n",

83 
äame
->
size
.
w
, f¿me->size.
h
);

86  
”r
;

87 
	}
}

90 
vidi¥_¡
 *
	$vidbridge_di¥_fšd
(cÚ¡ *
deviû
)

92  
	`li¡_Ëd©a
(
	`hash_lookup
(
ht_di¥
, 
	`hash_jß©_¡r
(
deviû
),

93 
li¡_­¶y_hªdËr
, (*)
deviû
));

94 
	}
}

	@baresip/modules/vidbridge/src.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vidbridge.h
"

12 
	$de¡ruùÜ
(*
¬g
)

14 
vid¤c_¡
 *
¡
 = 
¬g
;

16 ià(
¡
->
vidi¥
)

17 
¡
->
vidi¥
->
vid¤c
 = 
NULL
;

19 
	`li¡_uÆšk
(&
¡
->
Ë
);

20 
	`mem_d”ef
(
¡
->
deviû
);

21 
	}
}

24 
	$vidbridge_¤c_®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

25 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

26 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

27 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

28 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

30 
vid¤c_¡
 *
¡
;

31 
”r
;

32 ()
ùx
;

33 ()
´m
;

34 ()
fmt
;

35 ()
”rÜh
;

37 ià(!
¡p
 || !
size
 || !
äameh
)

38  
EINVAL
;

40 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

41 ià(!
¡
)

42  
ENOMEM
;

44 
¡
->
vs
 = vs;

45 
¡
->
äameh
 = frameh;

46 
¡
->
¬g
 =‡rg;

48 
”r
 = 
	`¡r_dup
(&
¡
->
deviû
, 
dev
);

49 ià(
”r
)

50 
out
;

53 
¡
->
vidi¥
 = 
	`vidbridge_di¥_fšd
(
dev
);

54 ià(
¡
->
vidi¥
) {

55 
¡
->
vidi¥
->
vid¤c
 = st;

58 
	`hash_­³nd
(
ht_¤c
, 
	`hash_jß©_¡r
(
dev
), &
¡
->
Ë
, st);

60 
out
:

61 ià(
”r
)

62 
	`mem_d”ef
(
¡
);

64 *
¡p
 = 
¡
;

66  
”r
;

67 
	}
}

70 
boŞ
 
	$li¡_­¶y_hªdËr
(
Ë
 *Ë, *
¬g
)

72 
vid¤c_¡
 *
¡
 = 
Ë
->
d©a
;

74  0 =ğ
	`¡r_cmp
(
¡
->
deviû
, 
¬g
);

75 
	}
}

78 
vid¤c_¡
 *
	$vidbridge_¤c_fšd
(cÚ¡ *
deviû
)

80  
	`li¡_Ëd©a
(
	`hash_lookup
(
ht_¤c
, 
	`hash_jß©_¡r
(
deviû
),

81 
li¡_­¶y_hªdËr
, (*)
deviû
));

82 
	}
}

85 
	$vidbridge_¤c_šput
(cÚ¡ 
vid¤c_¡
 *
¡
,

86 cÚ¡ 
vidäame
 *
äame
)

88 ià(!
¡
 || !
äame
)

91 ià(
¡
->
äameh
)

92 
¡
->
	`äameh
((
vidäame
 *)
äame
, st->
¬g
);

93 
	}
}

	@baresip/modules/vidbridge/vidbridge.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vidbridge.h
"

30 
vidi¥
 *
	gvidi¥
;

31 
vid¤c
 *
	gvid¤c
;

33 
hash
 *
	ght_¤c
;

34 
hash
 *
	ght_di¥
;

37 
	$moduË_š™
()

39 
”r
;

41 
”r
 = 
	`hash_®loc
(&
ht_¤c
, 32);

42 
”r
 |ğ
	`hash_®loc
(&
ht_di¥
, 32);

43 ià(
”r
)

44  
”r
;

46 
”r
 = 
	`vidi¥_»gi¡”
(&
vidi¥
, 
	`b¬es_vidi¥l
(),

47 "vidbridge", 
vidbridge_di¥_®loc
,

48 
NULL
, 
vidbridge_di¥_di¥Ïy
, 0);

49 ià(
”r
)

50  
”r
;

52 
”r
 = 
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

53 "vidbridge", 
vidbridge_¤c_®loc
, 
NULL
);

54 ià(
”r
)

55  
”r
;

57  
”r
;

58 
	}
}

61 
	$moduË_şo£
()

63 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

64 
vidi¥
 = 
	`mem_d”ef
(vidisp);

66 
ht_¤c
 = 
	`mem_d”ef
(ht_src);

67 
ht_di¥
 = 
	`mem_d”ef
(ht_disp);

70 
	}
}

73 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vidbridge
) = {

76 
moduË_š™
,

77 
moduË_şo£
,

	@baresip/modules/vidbridge/vidbridge.h

8 
	svid¤c_¡
 {

9 cÚ¡ 
vid¤c
 *
	mvs
;

11 
Ë
 
	mË
;

12 
vidi¥_¡
 *
	mvidi¥
;

13 *
	mdeviû
;

14 
vid¤c_äame_h
 *
	mäameh
;

15 *
	m¬g
;

19 
	svidi¥_¡
 {

20 cÚ¡ 
vidi¥
 *
	mvd
;

22 
Ë
 
	mË
;

23 
vid¤c_¡
 *
	mvid¤c
;

24 *
	mdeviû
;

28 
hash
 *
ht_¤c
;

29 
hash
 *
ht_di¥
;

32 
vidbridge_di¥_®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

33 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

34 
vidi¥_»size_h
 *
»sizeh
, *
¬g
);

35 
vidbridge_di¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

36 cÚ¡ 
vidäame
 *
äame
);

37 
vidi¥_¡
 *
vidbridge_di¥_fšd
(cÚ¡ *
deviû
);

40 
vidbridge_¤c_®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

41 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

42 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

43 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

44 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
);

45 
vid¤c_¡
 *
vidbridge_¤c_fšd
(cÚ¡ *
deviû
);

46 
vidbridge_¤c_šput
(cÚ¡ 
vid¤c_¡
 *
¡
,

47 cÚ¡ 
vidäame
 *
äame
);

	@baresip/modules/vidinfo/panel.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vidšfo.h
"

12 
	$¼d_­³nd
(
·Ãl
 *·Ãl, 
ušt64_t
 
v®
)

14 ià(!
·Ãl
)

17 
·Ãl
->
¼dv
[·Ãl->
¼dc
++] = 
v®
;

18 
·Ãl
->
¼d_sum
 +ğ
v®
;

20 ià(
·Ãl
->
¼dc
 >ğ·Ãl->
¼dsz
) {

21 
·Ãl
->
¼dc
 = 0;

22 
·Ãl
->
¼d_sum
 = 0;

24 
	}
}

27 
	$¼d_g‘_av”age
(
·Ãl
 *·Ãl, 
ušt64_t
 *
av”age
)

29 ià(!
·Ãl
->
¼dc
)

30  
ENOENT
;

32 *
av”age
 = 
·Ãl
->
¼d_sum
 /…ª–->
¼dc
;

35 
	}
}

38 
	$tmr_hªdËr
(*
¬g
)

40 
·Ãl
 *·ÃÈğ
¬g
;

41 
ušt64_t
 
now
 = 
	`tmr_jiff›s
();

43 
	`tmr_¡¬t
(&
·Ãl
->
tmr
, 2000, 
tmr_hªdËr
,…anel);

45 ià(
·Ãl
->
ts
) {

46 
·Ãl
->
ås
 = 1000.0 *…ª–->
näames
 / (
now
 -…ª–->
ts
);

48 
·Ãl
->
näames
 = 0;

50 
·Ãl
->
ts
 = 
now
;

51 
	}
}

54 
	$de¡ruùÜ
(*
¬g
)

56 
·Ãl
 *·ÃÈğ
¬g
;

58 
	`tmr_ÿnûl
(&
·Ãl
->
tmr
);

59 
	`mem_d”ef
(
·Ãl
->
Ïb–
);

60 
	`mem_d”ef
(
·Ãl
->
¼dv
);

62 ià(
·Ãl
->
ü
)

63 
	`ÿœo_de¡roy
(
·Ãl
->
ü
);

64 ià(
·Ãl
->
surçû
)

65 
	`ÿœo_surçû_de¡roy
(
·Ãl
->
surçû
);

66 
	}
}

69 
	$·Ãl_®loc
(
·Ãl
 **
·ÃÍ
, cÚ¡ *
Ïb–
,

70 
yoffs
, 
width
, 
height
)

72 
·Ãl
 *panel;

73 
”r
;

75 ià(!
·ÃÍ
 || !
width
 || !
height
)

76  
EINVAL
;

78 
·Ãl
 = 
	`mem_z®loc
((*·Ãl), 
de¡ruùÜ
);

79 ià(!
·Ãl
)

80  
ENOMEM
;

82 
”r
 = 
	`¡r_dup
(&
·Ãl
->
Ïb–
,†abel);

83 ià(
”r
)

84 
out
;

86 
·Ãl
->
size
.
w
 = 
width
;

87 
·Ãl
->
size
.
h
 = 
height
;

88 
·Ãl
->
yoffs
 = yoffs;

89 
·Ãl
->
xoffs
 = 
TEXT_WIDTH
;

91 
·Ãl
->
size_‹xt
.
w
 = 
TEXT_WIDTH
;

92 
·Ãl
->
size_‹xt
.
h
 = 
height
;

94 
·Ãl
->
surçû
 = 
	`ÿœo_image_surçû_ü—‹
(
CAIRO_FORMAT_ARGB32
,

95 
·Ãl
->
size_‹xt
.
w
,

96 
·Ãl
->
size_‹xt
.
h
);

97 
·Ãl
->
ü
 = 
	`ÿœo_ü—‹
Õª–->
surçû
);

98 ià(!
·Ãl
->
surçû
 || !·Ãl->
ü
) {

99 
	`w¬nšg
("vidinfo: cairoƒrror\n");

100  
ENOMEM
;

103 
	`ÿœo_£Ëù_fÚt_çû
 (
·Ãl
->
ü
, "Hyperfont",

104 
CAIRO_FONT_SLANT_NORMAL
,

105 
CAIRO_FONT_WEIGHT_NORMAL
);

106 
	`ÿœo_£t_fÚt_size
 (
·Ãl
->
ü
, 
height
-2);

108 
·Ãl
->
¼dc
 = 0;

109 
·Ãl
->
¼dsz
 = (
width
 - 
TEXT_WIDTH
) / 2;

110 
·Ãl
->
¼dv
 = 
	`mem_»®loÿ¼ay
(
NULL
,…ª–->
¼dsz
,

111 (*
·Ãl
->
¼dv
), 
NULL
);

112 ià(!
·Ãl
->
¼dv
) {

113 
”r
 = 
ENOMEM
;

114 
out
;

117 
	`tmr_¡¬t
(&
·Ãl
->
tmr
, 0, 
tmr_hªdËr
,…anel);

119 
	`šfo
("new…anel '%s' (%u x %u) with RRD size %u\n",

120 
Ïb–
, 
width
, 
height
, 
·Ãl
->
¼dsz
);

122 
out
:

123 ià(
”r
)

124 
	`mem_d”ef
(
·Ãl
);

126 *
·ÃÍ
 = 
·Ãl
;

128  
”r
;

129 
	}
}

132 
	$ov”Ïy
(
vidäame
 *
d¡
, 
yoffs
, vidäam*
¤c
)

134 
ušt8_t
 *
pd¡
, *
p¤c
;

135 
x
, 
y
;

137 
pd¡
 = 
d¡
->
d©a
[0] + 
yoffs
 * d¡->
lšesize
[0];

138 
p¤c
 = 
¤c
->
d©a
[0];

140 
y
=0; y<
¤c
->
size
.
h
; y++) {

142 
x
=0; x<
¤c
->
size
.
w
; x++) {

145 ià(
p¤c
[
x
] > 16)

146 
pd¡
[
x
] = 
p¤c
[x];

149 
pd¡
 +ğ
d¡
->
lšesize
[0];

150 
p¤c
 +ğ
¤c
->
lšesize
[0];

152 
	}
}

155 
	$d¿w_‹xt
(
·Ãl
 *·Ãl, 
vidäame
 *
äame
)

157 
buf
[256];

158 
width
 = 
·Ãl
->
size_‹xt
.
w
;

159 
height
 = 
·Ãl
->
size_‹xt
.
h
;

160 
vidäame
 
f
;

161 
vidäame
 *
f2
 = 
NULL
;

162 
ÿœo_t
 *
ü
 = 
·Ãl
->cr;

163 
tx
, 
ty
;

164 
”r
;

166 
tx
 = 1;

167 
ty
 = 
height
 - 3;

170 
	`ÿœo_»ùªgË
 (
ü
, 0, 0, 
width
, 
height
);

171 
	`ÿœo_£t_sourû_rgb
 (
ü
, 0.0, 0.0, 0.0);

172 
	`ÿœo_fl
 (
ü
);

175 ià(
	`»_¢´štf
(
buf
, (buf), "%s %2.2f fps",

176 
·Ãl
->
Ïb–
,…ª–->
ås
) < 0)

177  
ENOMEM
;

179 
	`ÿœo_move_to
 (
ü
, 
tx
, 
ty
);

180 
	`ÿœo_‹xt_·th
 (
ü
, 
buf
);

181 
	`ÿœo_£t_sourû_rgb
 (
ü
, 1.0, 1.0, 1.0);

182 
	`ÿœo_fl_´e£rve
 (
ü
);

183 
	`ÿœo_£t_lše_width
 (
ü
, 0.6);

184 
	`ÿœo_¡roke
 (
ü
);

186 
	`vidäame_š™_buf
(&
f
, 
VID_FMT_RGB32
, &
·Ãl
->
size_‹xt
,

187 
	`ÿœo_image_surçû_g‘_d©a
(
·Ãl
->
surçû
));

189 
”r
 = 
	`vidäame_®loc
(&
f2
, 
äame
->
fmt
, &
·Ãl
->
size_‹xt
);

190 ià(
”r
)

191 
out
;

193 
	`vidcÚv
(
f2
, &
f
, 0);

195 
	`ov”Ïy
(
äame
, 
·Ãl
->
yoffs
, 
f2
);

197 
out
:

198 
	`mem_d”ef
(
f2
);

199  
”r
;

200 
	}
}

203 
	$dim_äame
(
vidäame
 *
äame
, 
yoffs
, 
height
)

205 
x
, 
y
;

206 
ušt8_t
 *
p
;

207 
boŞ
 
low”
 = (
yoffs
 > 0);

208 
g¿de
 = 
low”
 ? 1.00 : (1.00 - 
PANEL_HEIGHT
/100.0);

210 
p
 = 
äame
->
d©a
[0] + 
yoffs
 * f¿me->
lšesize
[0];

213 
y
 = 0; y < 
height
; y++) {

215 
x
 = 0; x < 
äame
->
size
.
w
; x++) {

216 
p
[
x
] =…[x] * 
g¿de
;

219 
p
 +ğ
äame
->
lšesize
[0];

221 ià(
low”
)

222 
g¿de
 -= 0.01;

224 
g¿de
 += 0.01;

226 
	}
}

229 
	$d¿w_g¿ph
(
·Ãl
 *·Ãl, 
vidäame
 *
äame
)

231 
ušt64_t
 
avg
;

232 
y0
 = 
·Ãl
->
yoffs
;

233 
size_t
 
i
;

235 ià(
	`¼d_g‘_av”age
(
·Ãl
, &
avg
))

238 
i
=0; i<
·Ãl
->
¼dc
; i++) {

240 
ušt64_t
 
v®ue
;

241 
¿tio
;

242 
pix–s
;

243 
x
 = 
·Ãl
->
xoffs
 + ()
i
 * 2;

244 
y
;

245 
v®ue
 = 
·Ãl
->
¼dv
[
i
];

247 
¿tio
 = ()
v®ue
 / ()
avg
;

249 
pix–s
 = ()(()
·Ãl
->
size
.
h
 * 
¿tio
 * 0.5f);

251 
pix–s
 = 
	`mš
Õix–s, 
·Ãl
->
size
.
h
);

253 
y
 = 
y0
 + 
·Ãl
->
size
.
h
 - 
pix–s
;

255 
	`vidäame_d¿w_vlše
(
äame
, 
x
, 
y
, 
pix–s
, 220, 220, 220);

257 
	}
}

260 
	$·Ãl_d¿w
(
·Ãl
 *·Ãl, 
vidäame
 *
äame
)

262 
”r
;

264 ià(!
·Ãl
 || !
äame
)

265  
EINVAL
;

267 
	`dim_äame
(
äame
, 
·Ãl
->
yoffs
,…ª–->
size
.
h
);

269 
”r
 = 
	`d¿w_‹xt
(
·Ãl
, 
äame
);

270 ià(
”r
)

271  
”r
;

272 
	`d¿w_g¿ph
(
·Ãl
, 
äame
);

275 
	}
}

278 
	$·Ãl_add_äame
(
·Ãl
 *·Ãl, 
ušt64_t
 
±s
)

280 ià(!
·Ãl
)

283 ià(
·Ãl
->
±s_´ev
) {

284 
	`¼d_­³nd
(
·Ãl
, 
±s
 -…ª–->
±s_´ev
);

287 
·Ãl
->
näames
++;

288 
·Ãl
->
±s_´ev
 = 
±s
;

289 
	}
}

	@baresip/modules/vidinfo/vidinfo.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vidšfo.h
"

22 
	svidšfo_’c
 {

23 
vidft_’c_¡
 
	mvf
;

25 
·Ãl
 *
	m·Ãl
;

29 
	svidšfo_dec
 {

30 
vidft_dec_¡
 
	mvf
;

32 
·Ãl
 *
	m·Ãl
;

36 
	$’code_de¡ruùÜ
(*
¬g
)

38 
vidšfo_’c
 *
¡
 = 
¬g
;

40 
	`li¡_uÆšk
(&
¡
->
vf
.
Ë
);

41 
	`mem_d”ef
(
¡
->
·Ãl
);

42 
	}
}

45 
	$decode_de¡ruùÜ
(*
¬g
)

47 
vidšfo_dec
 *
¡
 = 
¬g
;

49 
	`li¡_uÆšk
(&
¡
->
vf
.
Ë
);

50 
	`mem_d”ef
(
¡
->
·Ãl
);

51 
	}
}

54 
	$’code_upd©e
(
vidft_’c_¡
 **
¡p
, **
ùx
,

55 cÚ¡ 
vidft
 *
vf
)

57 
vidšfo_’c
 *
¡
;

58 
”r
 = 0;

60 ià(!
¡p
 || !
ùx
 || !
vf
)

61  
EINVAL
;

63 ià(*
¡p
)

66 
¡
 = 
	`mem_z®loc
((*¡), 
’code_de¡ruùÜ
);

67 ià(!
¡
)

68  
ENOMEM
;

70 ià(
”r
)

71 
	`mem_d”ef
(
¡
);

73 *
¡p
 = (
vidft_’c_¡
 *)
¡
;

75  
”r
;

76 
	}
}

79 
	$decode_upd©e
(
vidft_dec_¡
 **
¡p
, **
ùx
,

80 cÚ¡ 
vidft
 *
vf
)

82 
vidšfo_dec
 *
¡
;

83 
”r
 = 0;

85 ià(!
¡p
 || !
ùx
 || !
vf
)

86  
EINVAL
;

88 ià(*
¡p
)

91 
¡
 = 
	`mem_z®loc
((*¡), 
decode_de¡ruùÜ
);

92 ià(!
¡
)

93  
ENOMEM
;

95 ià(
”r
)

96 
	`mem_d”ef
(
¡
);

98 *
¡p
 = (
vidft_dec_¡
 *)
¡
;

100  
”r
;

101 
	}
}

104 
	$’code
(
vidft_’c_¡
 *
_¡
, 
vidäame
 *
äame
)

106 
vidšfo_’c
 *
¡
 = (vidšfo_’ø*)
_¡
;

107 
”r
 = 0;

109 ià(!
¡
->
·Ãl
) {

111 
width
 = 
äame
->
size
.
w
;

112 
height
 = 
	`MIN
(
PANEL_HEIGHT
, 
äame
->
size
.
h
);

114 
”r
 = 
	`·Ãl_®loc
(&
¡
->
·Ãl
, "’code", 0, 
width
, 
height
);

115 ià(
”r
)

116  
”r
;

119 
	`·Ãl_add_äame
(
¡
->
·Ãl
, 
	`tmr_jiff›s
());

121 
	`·Ãl_d¿w
(
¡
->
·Ãl
, 
äame
);

124 
	}
}

127 
	$decode
(
vidft_dec_¡
 *
_¡
, 
vidäame
 *
äame
)

129 
vidšfo_dec
 *
¡
 = (vidšfo_deø*)
_¡
;

130 
”r
 = 0;

132 ià(!
¡
->
·Ãl
) {

134 
width
 = 
äame
->
size
.
w
;

135 
height
 = 
	`MIN
(
PANEL_HEIGHT
, 
äame
->
size
.
h
);

136 
yoffs
 = 
äame
->
size
.
h
 - 
PANEL_HEIGHT
;

138 
”r
 = 
	`·Ãl_®loc
(&
¡
->
·Ãl
, "decode", 
yoffs
, 
width
, 
height
);

139 ià(
”r
)

140  
”r
;

143 
	`·Ãl_add_äame
(
¡
->
·Ãl
, 
	`tmr_jiff›s
());

145 
	`·Ãl_d¿w
(
¡
->
·Ãl
, 
äame
);

148 
	}
}

151 
vidft
 
	gvidšfo
 = {

152 
LE_INIT
, "vidšfo", 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode


156 
	$moduË_š™
()

158 
	`vidft_»gi¡”
(
	`b¬es_vidf
(), &
vidšfo
);

161 
	}
}

164 
	$moduË_şo£
()

166 
	`vidft_uÄegi¡”
(&
vidšfo
);

169 
	}
}

172 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vidšfo
) = {

175 
moduË_š™
,

176 
moduË_şo£


	@baresip/modules/vidinfo/vidinfo.h

8 
	~<ÿœo/ÿœo.h
>

11 
	#PANEL_HEIGHT
 24

	)

12 
	#TEXT_WIDTH
 220

	)

15 
	s·Ãl
 {

16 
vidsz
 
	msize
;

17 
vidsz
 
	msize_‹xt
;

18 
	myoffs
;

19 
	mxoffs
;

20 *
	mÏb–
;

22 
ušt64_t
 *
	m¼dv
;

23 
size_t
 
	m¼dsz
;

24 
size_t
 
	m¼dc
;

25 
ušt64_t
 
	m¼d_sum
;

27 
	mnäames
;

28 
ušt64_t
 
	mts
;

29 
	mås
;

30 
tmr
 
	mtmr
;

32 
ušt64_t
 
	m±s_´ev
;

35 
ÿœo_surçû_t
 *
	msurçû
;

36 
ÿœo_t
 *
	mü
;

39 
·Ãl_®loc
(
·Ãl
 **
·ÃÍ
, cÚ¡ *
Ïb–
,

40 
yoffs
, 
width
, 
height
);

41 
·Ãl_add_äame
(
·Ãl
 *·Ãl, 
ušt64_t
 
±s
);

42 
·Ãl_d¿w
(
·Ãl
 *·Ãl, 
vidäame
 *
äame
);

	@baresip/modules/vidloop/vidloop.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<¡ršg.h
>

9 
	~<time.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

36 #iâdeà
VIDLOOP_INTERNAL_FMT


37 
	#VIDLOOP_INTERNAL_FMT
 (
VID_FMT_YUV420P
)

	)

42 
	sv¡©
 {

43 
ušt64_t
 
	mt§mp
;

44 
ušt32_t
 
	mäames
;

45 
size_t
 
	mby‹s
;

46 
ušt32_t
 
	mb™¿‹
;

47 
	meås
;

48 
size_t
 
	mn_šŒa
;

53 
	svideo_loİ
 {

54 cÚ¡ 
vidcodec
 *
	mvc_’c
;

55 cÚ¡ 
vidcodec
 *
	mvc_dec
;

56 
cÚfig_video
 
	mcfg
;

57 
vid’c_¡©e
 *
	m’c
;

58 
viddec_¡©e
 *
	mdec
;

59 
vidi¥_¡
 *
	mvidi¥
;

60 
vid¤c_¡
 *
	mv¤c
;

61 
li¡
 
	mf‹nş
;

62 
li¡
 
	mftdeş
;

63 
v¡©
 
	m¡©
;

64 
tmr
 
	mtmr_bw
;

65 
ušt16_t
 
	m£q
;

66 
boŞ
 
	mÃed_cÚv
;

67 
	m”r
;

71 
video_loİ
 *
	ggvl
;

74 
	$di¥Ïy
(
video_loİ
 *
vl
, 
vidäame
 *
äame
)

76 
vidäame
 *
äame_ft
 = 
NULL
;

77 
Ë
 *le;

78 
”r
 = 0;

80 ià(!
	`vidäame_isv®id
(
äame
))

84 
Ë
 = 
vl
->
ftdeş
.
h—d
;†e;†ğË->
Ãxt
) {

86 
vidft_dec_¡
 *
¡
 = 
Ë
->
d©a
;

91 ià(!
äame_ft
) {

93 
”r
 = 
	`vidäame_®loc
(&
äame_ft
, 
äame
->
fmt
,

94 &
äame
->
size
);

95 ià(
”r
)

96  
”r
;

98 
	`vidäame_cİy
(
äame_ft
, 
äame
);

100 
äame
 = 
äame_ft
;

103 ià(
¡
->
vf
->
dech
)

104 
”r
 |ğ
¡
->
vf
->
	`dech
(¡, 
äame
);

107 ià(
”r
) {

108 
	`w¬nšg
("vidloİ:ƒ¼Ü iÀvideo-f‹r (%m)\n", 
”r
);

112 
”r
 = 
	`vidi¥_di¥Ïy
(
vl
->
vidi¥
, "VideØLoİ", 
äame
);

113 ià(
”r
 =ğ
ENODEV
) {

114 
	`šfo
("vidloop: video-display was closed\n");

115 
vl
->
vidi¥
 = 
	`mem_d”ef
(vl->vidisp);

116 
vl
->
”r
 =ƒrr;

119 
	`mem_d”ef
(
äame_ft
);

121  
”r
;

122 
	}
}

125 
	$·ck‘_hªdËr
(
boŞ
 
m¬k”
, 
ušt32_t
 
¹p_ts
,

126 cÚ¡ 
ušt8_t
 *
hdr
, 
size_t
 
hdr_Ën
,

127 cÚ¡ 
ušt8_t
 *
¶d
, 
size_t
 
¶d_Ën
,

128 *
¬g
)

130 
video_loİ
 *
vl
 = 
¬g
;

131 
vidäame
 
äame
;

132 
mbuf
 *
mb
;

133 
boŞ
 
šŒa
;

134 
”r
 = 0;

135 ()
¹p_ts
;

137 
mb
 = 
	`mbuf_®loc
(
hdr_Ën
 + 
¶d_Ën
);

138 ià(!
mb
)

139  
ENOMEM
;

141 ià(
hdr_Ën
)

142 
	`mbuf_wr™e_mem
(
mb
, 
hdr
, 
hdr_Ën
);

143 
	`mbuf_wr™e_mem
(
mb
, 
¶d
, 
¶d_Ën
);

145 
mb
->
pos
 = 0;

147 
vl
->
¡©
.
by‹s
 +ğ
	`mbuf_g‘_Ëá
(
mb
);

150 
äame
.
d©a
[0] = 
NULL
;

151 ià(
vl
->
vc_dec
 && vl->
dec
) {

152 
”r
 = 
vl
->
vc_dec
->
	`dech
(vl->
dec
, &
äame
, &
šŒa
,

153 
m¬k”
, 
vl
->
£q
++, 
mb
);

154 ià(
”r
) {

155 
	`w¬nšg
("vidloİ: codeødecode: %m\n", 
”r
);

156 
out
;

159 ià(
šŒa
)

160 ++
vl
->
¡©
.
n_šŒa
;

163 ià(
	`vidäame_isv®id
(&
äame
)) {

165 
	`di¥Ïy
(
vl
, &
äame
);

168 
out
:

169 
	`mem_d”ef
(
mb
);

172 
	}
}

175 
	$vid¤c_äame_hªdËr
(
vidäame
 *
äame
, *
¬g
)

177 
video_loİ
 *
vl
 = 
¬g
;

178 
vidäame
 *
f2
 = 
NULL
;

179 
Ë
 *le;

180 
”r
 = 0;

182 ++
vl
->
¡©
.
äames
;

184 ià(
äame
->
fmt
 !ğ
VIDLOOP_INTERNAL_FMT
) {

186 ià(!
vl
->
Ãed_cÚv
) {

187 
	`šfo
("vidloop: NOTE:…ixel-format conversion"

189 
	`vidfmt_Çme
(
äame
->
fmt
),

190 
	`vidfmt_Çme
(
VIDLOOP_INTERNAL_FMT
));

191 
vl
->
Ãed_cÚv
 = 
Œue
;

194 ià(
	`vidäame_®loc
(&
f2
, 
VIDLOOP_INTERNAL_FMT
, &
äame
->
size
))

197 
	`vidcÚv
(
f2
, 
äame
, 0);

199 
äame
 = 
f2
;

203 
Ë
 = 
vl
->
f‹nş
.
h—d
;†e;†ğË->
Ãxt
) {

205 
vidft_’c_¡
 *
¡
 = 
Ë
->
d©a
;

207 ià(
¡
->
vf
->
’ch
)

208 
”r
 |ğ
¡
->
vf
->
	`’ch
(¡, 
äame
);

211 ià(
vl
->
vc_’c
 && vl->
’c
) {

212 ()
vl
->
vc_’c
->
	`’ch
(vl->
’c
, 
çl£
, 
äame
);

215 
vl
->
¡©
.
by‹s
 +ğ
	`vidäame_size
(
äame
->
fmt
, &äame->
size
);

216 ()
	`di¥Ïy
(
vl
, 
äame
);

219 
	`mem_d”ef
(
f2
);

220 
	}
}

223 
	$vidloİ_de¡ruùÜ
(*
¬g
)

225 
video_loİ
 *
vl
 = 
¬g
;

227 
	`tmr_ÿnûl
(&
vl
->
tmr_bw
);

228 
	`mem_d”ef
(
vl
->
v¤c
);

229 
	`mem_d”ef
(
vl
->
’c
);

230 
	`mem_d”ef
(
vl
->
dec
);

231 
	`mem_d”ef
(
vl
->
vidi¥
);

232 
	`li¡_æush
(&
vl
->
f‹nş
);

233 
	`li¡_æush
(&
vl
->
ftdeş
);

234 
	}
}

237 
	$’abË_codec
(
video_loİ
 *
vl
, cÚ¡ *
Çme
)

239 
li¡
 *
vidcodeş
 = 
	`b¬es_vidcodeş
();

240 
vid’c_·¿m
 
´m
;

241 
”r
;

243 
´m
.
ås
 = 
vl
->
cfg
.fps;

244 
´m
.
pktsize
 = 1480;

245 
´m
.
b™¿‹
 = 
vl
->
cfg
.bitrate;

246 
´m
.
max_fs
 = -1;

250 
vl
->
vc_’c
 = 
	`vidcodec_fšd_’cod”
(
vidcodeş
, 
Çme
);

251 ià(!
vl
->
vc_’c
) {

252 
	`w¬nšg
("vidloİ: could‚Ù fšdƒncod” (%s)\n", 
Çme
);

253  
ENOENT
;

256 
	`šfo
("vidloop:ƒnabledƒncoder %s (%u fps, %u bit/s)\n",

257 
vl
->
vc_’c
->
Çme
, 
´m
.
ås
,…rm.
b™¿‹
);

259 
vl
->
vc_dec
 = 
	`vidcodec_fšd_decod”
(
vidcodeş
, 
Çme
);

260 ià(!
vl
->
vc_dec
) {

261 
	`w¬nšg
("vidloİ: could‚Ù fšd decod” (%s)\n", 
Çme
);

262  
ENOENT
;

265 
	`šfo
("vidloİ:ƒÇbËd decod” %s\n", 
vl
->
vc_dec
->
Çme
);

267 
”r
 = 
vl
->
vc_’c
->
	`’cupdh
(&vl->
’c
, vl->vc_’c, &
´m
, 
NULL
,

268 
·ck‘_hªdËr
, 
vl
);

269 ià(
”r
) {

270 
	`w¬nšg
("vidloİ: upd©’cod” faed: %m\n", 
”r
);

271  
”r
;

274 ià(
vl
->
vc_dec
->
decupdh
) {

275 
”r
 = 
vl
->
vc_dec
->
	`decupdh
(&vl->
dec
, vl->vc_dec, 
NULL
);

276 ià(
”r
) {

277 
	`w¬nšg
("vidloİ: upd©decod” faed: %m\n", 
”r
);

278  
”r
;

283 
	}
}

286 
	$´št_¡©us
(
video_loİ
 *
vl
)

288 ()
	`»_årštf
(
¡dout
,

292 
vl
->
vc_’c
 ? vl->vc_’c->
Çme
 : "",

293 
vl
->
vc_dec
 ? vl->vc_dec->
Çme
 : "",

294 
vl
->
¡©
.
n_šŒa
,

295 
vl
->
¡©
.
eås
, vl->¡©.
b™¿‹
);

296 
	`fæush
(
¡dout
);

297 
	}
}

300 
	$ÿlc_b™¿‹
(
video_loİ
 *
vl
)

302 cÚ¡ 
ušt64_t
 
now
 = 
	`tmr_jiff›s
();

304 ià(
now
 > 
vl
->
¡©
.
t§mp
) {

306 cÚ¡ 
ušt32_t
 
dur
 = (ušt32_t)(
now
 - 
vl
->
¡©
.
t§mp
);

308 
vl
->
¡©
.
eås
 = 1000.0à* vl->¡©.
äames
 / 
dur
;

310 
vl
->
¡©
.
b™¿‹
 = (
ušt32_t
è(8 * vl->¡©.
by‹s
 / 
dur
);

313 
vl
->
¡©
.
äames
 = 0;

314 
vl
->
¡©
.
by‹s
 = 0;

315 
vl
->
¡©
.
t§mp
 = 
now
;

316 
	}
}

319 
	$timeout_bw
(*
¬g
)

321 
video_loİ
 *
vl
 = 
¬g
;

323 ià(
vl
->
”r
) {

324 
	`šfo
("”rÜ iÀvideo-loİ -- closšg (%m)\n", 
vl
->
”r
);

325 
gvl
 = 
	`mem_d”ef
(gvl);

329 
	`tmr_¡¬t
(&
vl
->
tmr_bw
, 2000, 
timeout_bw
, vl);

331 
	`ÿlc_b™¿‹
(
vl
);

332 
	`´št_¡©us
(
vl
);

333 
	}
}

336 
	$v¤c_»İ’
(
video_loİ
 *
vl
, cÚ¡ 
vidsz
 *
sz
)

338 
vid¤c_´m
 
´m
;

339 
”r
;

341 
	`šfo
("vidloop: %s,%s: open video source: %u x %u‡t %u fps\n",

342 
vl
->
cfg
.
¤c_mod
, vl->cfg.
¤c_dev
,

343 
sz
->
w
, sz->
h
, 
vl
->
cfg
.
ås
);

345 
´m
.
Ü›Á
 = 
VIDORIENT_PORTRAIT
;

346 
´m
.
ås
 = 
vl
->
cfg
.fps;

348 
vl
->
v¤c
 = 
	`mem_d”ef
(vl->vsrc);

349 
”r
 = 
	`vid¤c_®loc
(&
vl
->
v¤c
, 
	`b¬es_vid¤ş
(),

350 
vl
->
cfg
.
¤c_mod
, 
NULL
, &
´m
, 
sz
,

351 
NULL
, 
vl
->
cfg
.
¤c_dev
, 
vid¤c_äame_hªdËr
,

352 
NULL
, 
vl
);

353 ià(
”r
) {

354 
	`w¬nšg
("vidloop: vidsrc '%s' failed: %m\n",

355 
vl
->
cfg
.
¤c_dev
, 
”r
);

358  
”r
;

359 
	}
}

362 
	$video_loİ_®loc
(
video_loİ
 **
vÍ
)

364 
video_loİ
 *
vl
;

365 
cÚfig
 *
cfg
;

366 
Ë
 *le;

367 
”r
 = 0;

369 
cfg
 = 
	`cÚf_cÚfig
();

370 ià(!
cfg
)

371  
EINVAL
;

373 
vl
 = 
	`mem_z®loc
((*vl), 
vidloİ_de¡ruùÜ
);

374 ià(!
vl
)

375  
ENOMEM
;

377 
vl
->
cfg
 = cfg->
video
;

378 
	`tmr_š™
(&
vl
->
tmr_bw
);

381 
Ë
 = 
	`li¡_h—d
(
	`b¬es_vidf
());†e;†ğË->
Ãxt
) {

382 
vidft
 *
vf
 = 
Ë
->
d©a
;

383 *
ùx
 = 
NULL
;

385 
	`šfo
("vidloİ:‡dded video-f‹¸`%s'\n", 
vf
->
Çme
);

387 
”r
 |ğ
	`vidft_’c_­³nd
(&
vl
->
f‹nş
, &
ùx
, 
vf
);

388 
”r
 |ğ
	`vidft_dec_­³nd
(&
vl
->
ftdeş
, &
ùx
, 
vf
);

389 ià(
”r
) {

390 
	`w¬nšg
("vidloİ: vidfˆ”rÜ: %m\n", 
”r
);

394 
	`šfo
("vidloop: open video display (%s.%s)\n",

395 
vl
->
cfg
.
di¥_mod
, vl->cfg.
di¥_dev
);

397 
”r
 = 
	`vidi¥_®loc
(&
vl
->
vidi¥
, 
	`b¬es_vidi¥l
(),

398 
vl
->
cfg
.
di¥_mod
, 
NULL
,

399 
vl
->
cfg
.
di¥_dev
, 
NULL
, vl);

400 ià(
”r
) {

401 
	`w¬nšg
("vidloİ: videØdi¥Ïy faed: %m\n", 
”r
);

402 
out
;

405 
	`tmr_¡¬t
(&
vl
->
tmr_bw
, 1000, 
timeout_bw
, vl);

407 
out
:

408 ià(
”r
)

409 
	`mem_d”ef
(
vl
);

411 *
vÍ
 = 
vl
;

413  
”r
;

414 
	}
}

420 
	$vidloİ_¡¬t
(
»_´štf
 *
pf
, *
¬g
)

422 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

423 
vidsz
 
size
;

424 
cÚfig
 *
cfg
 = 
	`cÚf_cÚfig
();

425 cÚ¡ *
codec_Çme
 = 
ÿrg
->
´m
;

426 
”r
 = 0;

428 
size
.
w
 = 
cfg
->
video
.
width
;

429 
size
.
h
 = 
cfg
->
video
.
height
;

431 ià(
gvl
) {

432  
	`»_h´štf
(
pf
, "video-loop‡lready„unning.\n");

435 ()
	`»_h´štf
(
pf
, "Enable video-loop on %s,%s: %u x %u\n",

436 
cfg
->
video
.
¤c_mod
, cfg->video.
¤c_dev
,

437 
size
.
w
, size.
h
);

439 
”r
 = 
	`video_loİ_®loc
(&
gvl
);

440 ià(
”r
) {

441 
	`w¬nšg
("vidloİ:‡Îoc: %m\n", 
”r
);

442  
”r
;

445 ià(
	`¡r_is£t
(
codec_Çme
)) {

447 
”r
 = 
	`’abË_codec
(
gvl
, 
codec_Çme
);

448 ià(
”r
) {

449 
gvl
 = 
	`mem_d”ef
(gvl);

450  
”r
;

453 ()
	`»_h´štf
(
pf
, "%sabled codec: %s\n",

454 
gvl
->
vc_’c
 ? "En" : "Dis",

455 
gvl
->
vc_’c
 ? gvl->vc_’c->
Çme
 : "");

459 
”r
 = 
	`v¤c_»İ’
(
gvl
, &
size
);

460 ià(
”r
) {

461 
gvl
 = 
	`mem_d”ef
(gvl);

462  
”r
;

465  
”r
;

466 
	}
}

469 
	$vidloİ_¡İ
(
»_´štf
 *
pf
, *
¬g
)

471 ()
¬g
;

473 ià(
gvl
)

474 ()
	`»_h´štf
(
pf
, "Disable video-loop\n");

475 
gvl
 = 
	`mem_d”ef
(gvl);

477 
	}
}

480 cÚ¡ 
cmd
 
	gcmdv
[] = {

481 {"vidloİ", 0, 
CMD_PRM
, "S¹ video-loİ <codec>", 
vidloİ_¡¬t
},

482 {"vidloİ_¡İ",0, 0, "Stİ video-loİ", 
vidloİ_¡İ
 },

486 
	$moduË_š™
()

488  
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

489 
	}
}

492 
	$moduË_şo£
()

494 
gvl
 = 
	`mem_d”ef
(gvl);

495 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

497 
	}
}

500 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vidloİ
) = {

503 
moduË_š™
,

504 
moduË_şo£
,

	@baresip/modules/vp8/decode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<vpx/vpx_decod”.h
>

12 
	~<vpx/vp8dx.h
>

13 
	~"vp8.h
"

17 
	mDECODE_MAXSZ
 = 524288,

21 
	shdr
 {

22 
	mx
:1;

23 
	mnÜef
:1;

24 
	m¡¬t
:1;

25 
	m·¹id
:4;

27 
	mi
:1;

28 
	ml
:1;

29 
	mt
:1;

30 
	mk
:1;

31 
ušt16_t
 
	mpicid
;

32 
ušt8_t
 
	m0picidx
;

33 
	mtid
:2;

34 
	my
:1;

35 
	mkeyidx
:5;

38 
	sviddec_¡©e
 {

39 
vpx_codec_ùx_t
 
	mùx
;

40 
mbuf
 *
	mmb
;

41 
boŞ
 
	mùxup
;

42 
boŞ
 
	m¡¬‹d
;

43 
ušt16_t
 
	m£q
;

47 
	$de¡ruùÜ
(*
¬g
)

49 
viddec_¡©e
 *
vds
 = 
¬g
;

51 ià(
vds
->
ùxup
)

52 
	`vpx_codec_de¡roy
(&
vds
->
ùx
);

54 
	`mem_d”ef
(
vds
->
mb
);

55 
	}
}

58 
	$vp8_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

59 cÚ¡ *
fm
)

61 
viddec_¡©e
 *
vds
;

62 
vpx_codec_”r_t
 
»s
;

63 
”r
 = 0;

64 ()
vc
;

65 ()
fm
;

67 ià(!
vd¥
)

68  
EINVAL
;

70 
vds
 = *
vd¥
;

72 ià(
vds
)

75 
vds
 = 
	`mem_z®loc
((*vds), 
de¡ruùÜ
);

76 ià(!
vds
)

77  
ENOMEM
;

79 
vds
->
mb
 = 
	`mbuf_®loc
(1024);

80 ià(!
vds
->
mb
) {

81 
”r
 = 
ENOMEM
;

82 
out
;

85 
»s
 = 
	`vpx_codec_dec_š™
(&
vds
->
ùx
, &
vpx_codec_vp8_dx_®go
, 
NULL
, 0);

86 ià(
»s
) {

87 
”r
 = 
ENOMEM
;

88 
out
;

91 
vds
->
ùxup
 = 
Œue
;

93 
out
:

94 ià(
”r
)

95 
	`mem_d”ef
(
vds
);

97 *
vd¥
 = 
vds
;

99  
”r
;

100 
	}
}

103 
šlše
 
	$hdr_decode
(
hdr
 *hdr, 
mbuf
 *
mb
)

105 
ušt8_t
 
v
;

107 
	`mem£t
(
hdr
, 0, (*hdr));

109 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

110  
EBADMSG
;

112 
v
 = 
	`mbuf_»ad_u8
(
mb
);

114 
hdr
->
x
 = 
v
>>7 & 0x1;

115 
hdr
->
nÜef
 = 
v
>>5 & 0x1;

116 
hdr
->
¡¬t
 = 
v
>>4 & 0x1;

117 
hdr
->
·¹id
 = 
v
 & 0x07;

119 ià(
hdr
->
x
) {

121 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

122  
EBADMSG
;

124 
v
 = 
	`mbuf_»ad_u8
(
mb
);

126 
hdr
->
i
 = 
v
>>7 & 0x1;

127 
hdr
->
l
 = 
v
>>6 & 0x1;

128 
hdr
->
t
 = 
v
>>5 & 0x1;

129 
hdr
->
k
 = 
v
>>4 & 0x1;

132 ià(
hdr
->
i
) {

134 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

135  
EBADMSG
;

137 
v
 = 
	`mbuf_»ad_u8
(
mb
);

139 ià(
v
>>7 & 0x1) {

141 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

142  
EBADMSG
;

144 
hdr
->
picid
 = (
v
 & 0x7f)<<8;

145 
hdr
->
picid
 +ğ
	`mbuf_»ad_u8
(
mb
);

148 
hdr
->
picid
 = 
v
 & 0x7f;

152 ià(
hdr
->
l
) {

154 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

155  
EBADMSG
;

157 
hdr
->
0picidx
 = 
	`mbuf_»ad_u8
(
mb
);

160 ià(
hdr
->
t
 || hdr->
k
) {

162 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

163  
EBADMSG
;

165 
v
 = 
	`mbuf_»ad_u8
(
mb
);

167 
hdr
->
tid
 = 
v
>>6 & 0x3;

168 
hdr
->
y
 = 
v
>>5 & 0x1;

169 
hdr
->
keyidx
 = 
v
 & 0x1f;

173 
	}
}

176 
šlše
 
boŞ
 
	$is_keyäame
(
mbuf
 *
mb
)

178 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

179  
çl£
;

181 ià(
mb
->
buf
[mb->
pos
] & 0x01)

182  
çl£
;

184  
Œue
;

185 
	}
}

188 
šlše
 
št16_t
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

190  (
št16_t
)(
y
 - 
x
);

191 
	}
}

194 
	$vp8_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

195 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

197 
vpx_codec_™”_t
 
™”
 = 
NULL
;

198 
vpx_codec_”r_t
 
»s
;

199 
vpx_image_t
 *
img
;

200 
hdr
 hdr;

201 
”r
, 
i
;

203 ià(!
vds
 || !
äame
 || !
šŒa
 || !
mb
)

204  
EINVAL
;

206 *
šŒa
 = 
çl£
;

208 
”r
 = 
	`hdr_decode
(&
hdr
, 
mb
);

209 ià(
”r
)

210  
”r
;

213 
	`debug
("vp8: header: x=%u‚oref=%u start=%u…artid=%u "

216 
hdr
.
x
, hdr.
nÜef
, hdr.
¡¬t
, hdr.
·¹id
,

217 
hdr
.
i
, hdr.
l
, hdr.
t
, hdr.
k
,

218 
hdr
.
picid
, hdr.
0picidx
, hdr.
tid
, hdr.
y
, hdr.
keyidx
);

221 ià(
hdr
.
¡¬t
 && hdr.
·¹id
 == 0) {

223 ià(
	`is_keyäame
(
mb
))

224 *
šŒa
 = 
Œue
;

226 
	`mbuf_»wšd
(
vds
->
mb
);

227 
vds
->
¡¬‹d
 = 
Œue
;

230 ià(!
vds
->
¡¬‹d
)

233 ià(
	`£q_diff
(
vds
->
£q
, seq) != 1) {

234 
	`mbuf_»wšd
(
vds
->
mb
);

235 
vds
->
¡¬‹d
 = 
çl£
;

240 
vds
->
£q
 = seq;

242 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
	`mbuf_buf
(mb), 
	`mbuf_g‘_Ëá
(mb));

243 ià(
”r
)

244 
out
;

246 ià(!
m¬k”
) {

248 ià(
vds
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

249 
	`w¬nšg
("vp8: decode buffer sizeƒxceeded\n");

250 
”r
 = 
ENOMEM
;

251 
out
;

257 
»s
 = 
	`vpx_codec_decode
(&
vds
->
ùx
, vds->
mb
->
buf
,

258 ()
vds
->
mb
->
’d
, 
NULL
, 1);

259 ià(
»s
) {

260 
	`debug
("vp8: decod”rÜ: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

261 
”r
 = 
EPROTO
;

262 
out
;

265 
img
 = 
	`vpx_codec_g‘_äame
(&
vds
->
ùx
, &
™”
);

266 ià(!
img
) {

267 
	`debug
("vp8:‚o…icture\n");

268 
out
;

271 ià(
img
->
fmt
 !ğ
VPX_IMG_FMT_I420
) {

272 
	`w¬nšg
("vp8: bad…ix– fÜm© (%i)\n", 
img
->
fmt
);

273 
out
;

276 
i
=0; i<4; i++) {

277 
äame
->
d©a
[
i
] = 
img
->
¶ªes
[i];

278 
äame
->
lšesize
[
i
] = 
img
->
¡ride
[i];

281 
äame
->
size
.
w
 = 
img
->
d_w
;

282 
äame
->
size
.
h
 = 
img
->
d_h
;

283 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

285 
out
:

286 
	`mbuf_»wšd
(
vds
->
mb
);

287 
vds
->
¡¬‹d
 = 
çl£
;

289  
”r
;

290 
	}
}

	@baresip/modules/vp8/encode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<vpx/vpx_’cod”.h
>

12 
	~<vpx/vp8cx.h
>

13 
	~"vp8.h
"

17 
	mHDR_SIZE
 = 4,

21 
	svid’c_¡©e
 {

22 
vpx_codec_ùx_t
 
	mùx
;

23 
vidsz
 
	msize
;

24 
vpx_codec_±s_t
 
	m±s
;

25 
	mås
;

26 
	mb™¿‹
;

27 
	mpktsize
;

28 
boŞ
 
	mùxup
;

29 
ušt16_t
 
	mpicid
;

30 
vid’c_·ck‘_h
 *
	mpkth
;

31 *
	m¬g
;

35 
	$de¡ruùÜ
(*
¬g
)

37 
vid’c_¡©e
 *
ves
 = 
¬g
;

39 ià(
ves
->
ùxup
)

40 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

41 
	}
}

44 
	$vp8_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

45 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

46 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

48 cÚ¡ 
vp8_vidcodec
 *
vp8
 = (vp8_vidcodeø*)
vc
;

49 
vid’c_¡©e
 *
ves
;

50 
ušt32_t
 
max_fs
;

51 ()
vp8
;

53 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < (
HDR_SIZE
 + 1))

54  
EINVAL
;

56 
ves
 = *
ve¥
;

58 ià(!
ves
) {

60 
ves
 = 
	`mem_z®loc
((*ves), 
de¡ruùÜ
);

61 ià(!
ves
)

62  
ENOMEM
;

64 
ves
->
picid
 = 
	`¿nd_u16
();

66 *
ve¥
 = 
ves
;

69 ià(
ves
->
ùxup
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

70 
ves
->
ås
 !ğ
´m
->fps)) {

72 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

73 
ves
->
ùxup
 = 
çl£
;

77 
ves
->
b™¿‹
 = 
´m
->bitrate;

78 
ves
->
pktsize
 = 
´m
->pktsize;

79 
ves
->
ås
 = 
´m
->fps;

80 
ves
->
pkth
 =…kth;

81 
ves
->
¬g
 =‡rg;

83 
max_fs
 = 
	`vp8_max_fs
(
fm
);

84 ià(
max_fs
 > 0)

85 
´m
->
max_fs
 = max_fs * 256;

88 
	}
}

91 
	$İ’_’cod”
(
vid’c_¡©e
 *
ves
, cÚ¡ 
vidsz
 *
size
)

93 
vpx_codec_’c_cfg_t
 
cfg
;

94 
vpx_codec_”r_t
 
»s
;

95 
vpx_codec_æags_t
 
æags
 = 0;

97 
»s
 = 
	`vpx_codec_’c_cÚfig_deçuÉ
(&
vpx_codec_vp8_cx_®go
, &
cfg
, 0);

98 ià(
»s
)

99  
EPROTO
;

101 
cfg
.
g_´ofe
 = 2;

102 
cfg
.
g_w
 = 
size
->
w
;

103 
cfg
.
g_h
 = 
size
->
h
;

104 
cfg
.
g_timeba£
.
num
 = 1;

105 
cfg
.
g_timeba£
.
d’
 = 
ves
->
ås
;

106 #ifdeà
VPX_ERROR_RESILIENT_DEFAULT


107 
cfg
.
g_”rÜ_»s›Á
 = 
VPX_ERROR_RESILIENT_DEFAULT
;

109 
cfg
.
g_·ss
 = 
VPX_RC_ONE_PASS
;

110 
cfg
.
g_Ïg_š_äames
 = 0;

111 
cfg
.
rc_’d_u§ge
 = 
VPX_VBR
;

112 
cfg
.
rc_rg‘_b™¿‹
 = 
ves
->
b™¿‹
;

113 
cfg
.
kf_mode
 = 
VPX_KF_AUTO
;

115 ià(
ves
->
ùxup
) {

116 
	`debug
("vp8:„e-openingƒncoder\n");

117 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

118 
ves
->
ùxup
 = 
çl£
;

121 #ifdeà
VPX_CODEC_USE_OUTPUT_PARTITION


122 
æags
 |ğ
VPX_CODEC_USE_OUTPUT_PARTITION
;

125 
»s
 = 
	`vpx_codec_’c_š™
(&
ves
->
ùx
, &
vpx_codec_vp8_cx_®go
, &
cfg
,

126 
æags
);

127 ià(
»s
) {

128 
	`w¬nšg
("vp8:ƒnøš™: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

129  
EPROTO
;

132 
ves
->
ùxup
 = 
Œue
;

134 
»s
 = 
	`vpx_codec_cÚŒŞ
(&
ves
->
ùx
, 
VP8E_SET_CPUUSED
, 16);

135 ià(
»s
) {

136 
	`w¬nšg
("vp8: codeøù¾: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

139 
»s
 = 
	`vpx_codec_cÚŒŞ
(&
ves
->
ùx
, 
VP8E_SET_NOISE_SENSITIVITY
, 0);

140 ià(
»s
) {

141 
	`w¬nšg
("vp8: codeøù¾: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

145 
	}
}

148 
šlše
 
	$hdr_’code
(
ušt8_t
 
hdr
[
HDR_SIZE
], 
boŞ
 
nÜef
, boŞ 
¡¬t
,

149 
ušt8_t
 
·¹id
, 
ušt16_t
 
picid
)

151 
hdr
[0] = 1<<7 | 
nÜef
<<5 | 
¡¬t
<<4 | (
·¹id
 & 0x7);

152 
hdr
[1] = 1<<7;

153 
hdr
[2] = 1<<7 | (
picid
>>8 & 0x7f);

154 
hdr
[3] = 
picid
 & 0xff;

155 
	}
}

158 
šlše
 
	$·ck‘ize
(
boŞ
 
m¬k”
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

159 
size_t
 
maxËn
, 
boŞ
 
nÜef
, 
ušt8_t
 
·¹id
,

160 
ušt16_t
 
picid
, 
ušt32_t
 
¹p_ts
,

161 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

163 
ušt8_t
 
hdr
[
HDR_SIZE
];

164 
boŞ
 
¡¬t
 = 
Œue
;

165 
”r
 = 0;

167 
maxËn
 -ğ(
hdr
);

169 
Ën
 > 
maxËn
) {

171 
	`hdr_’code
(
hdr
, 
nÜef
, 
¡¬t
, 
·¹id
, 
picid
);

173 
”r
 |ğ
	`pkth
(
çl£
, 
¹p_ts
, 
hdr
, (hdr), 
buf
, 
maxËn
,

174 
¬g
);

176 
buf
 +ğ
maxËn
;

177 
Ën
 -ğ
maxËn
;

178 
¡¬t
 = 
çl£
;

181 
	`hdr_’code
(
hdr
, 
nÜef
, 
¡¬t
, 
·¹id
, 
picid
);

183 
”r
 |ğ
	`pkth
(
m¬k”
, 
¹p_ts
, 
hdr
, (hdr), 
buf
, 
Ën
, 
¬g
);

185  
”r
;

186 
	}
}

189 
	$vp8_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

190 cÚ¡ 
vidäame
 *
äame
)

192 
vpx_’c_äame_æags_t
 
æags
 = 0;

193 
vpx_codec_™”_t
 
™”
 = 
NULL
;

194 
vpx_codec_”r_t
 
»s
;

195 
vpx_image_t
 
img
;

196 
”r
, 
i
;

198 ià(!
ves
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

199  
EINVAL
;

201 ià(!
ves
->
ùxup
 || !
	`vidsz_cmp
(&ves->
size
, &
äame
->size)) {

203 
”r
 = 
	`İ’_’cod”
(
ves
, &
äame
->
size
);

204 ià(
”r
)

205  
”r
;

207 
ves
->
size
 = 
äame
->size;

210 ià(
upd©e
) {

212 
æags
 |ğ
VPX_EFLAG_FORCE_KF
;

215 
	`mem£t
(&
img
, 0, (img));

217 
img
.
fmt
 = 
VPX_IMG_FMT_I420
;

218 
img
.
w
 = img.
d_w
 = 
äame
->
size
.w;

219 
img
.
h
 = img.
d_h
 = 
äame
->
size
.h;

221 
i
=0; i<4; i++) {

222 
img
.
¡ride
[
i
] = 
äame
->
lšesize
[i];

223 
img
.
¶ªes
[
i
] = 
äame
->
d©a
[i];

226 
»s
 = 
	`vpx_codec_’code
(&
ves
->
ùx
, &
img
, ves->
±s
++, 1,

227 
æags
, 
VPX_DL_REALTIME
);

228 ià(
»s
) {

229 
	`w¬nšg
("vp8:ƒnø”rÜ: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

230  
ENOMEM
;

233 ++
ves
->
picid
;

236 
boŞ
 
keyäame
 = 
çl£
, 
m¬k”
 = 
Œue
;

237 cÚ¡ 
vpx_codec_cx_pkt_t
 *
pkt
;

238 
ušt8_t
 
·¹id
 = 0;

239 
ušt32_t
 
ts
;

241 
pkt
 = 
	`vpx_codec_g‘_cx_d©a
(&
ves
->
ùx
, &
™”
);

242 ià(!
pkt
)

245 ià(
pkt
->
kšd
 !ğ
VPX_CODEC_CX_FRAME_PKT
)

248 ià(
pkt
->
d©a
.
äame
.
æags
 & 
VPX_FRAME_IS_KEY
)

249 
keyäame
 = 
Œue
;

251 #ifdeà
VPX_FRAME_IS_FRAGMENT


252 ià(
pkt
->
d©a
.
äame
.
æags
 & 
VPX_FRAME_IS_FRAGMENT
)

253 
m¬k”
 = 
çl£
;

255 ià(
pkt
->
d©a
.
äame
.
·¹™iÚ_id
 >= 0)

256 
·¹id
 = 
pkt
->
d©a
.
äame
.
·¹™iÚ_id
;

259 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pkt
->
d©a
.
äame
.
±s
, 
ves
->
ås
);

261 
”r
 = 
	`·ck‘ize
(
m¬k”
,

262 
pkt
->
d©a
.
äame
.
buf
,

263 
pkt
->
d©a
.
äame
.
sz
,

264 
ves
->
pktsize
, !
keyäame
, 
·¹id
, ves->
picid
,

265 
ts
,

266 
ves
->
pkth
, ves->
¬g
);

267 ià(
”r
)

268  
”r
;

272 
	}
}

	@baresip/modules/vp8/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"vp8.h
"

12 
ušt32_t
 
	$vp8_max_fs
(cÚ¡ *
fm
)

14 
¶
…l, 
max_fs
;

16 ià(!
fm
)

19 
	`¶_£t_¡r
(&
¶
, 
fm
);

21 ià(
	`fmt_·¿m_g‘
(&
¶
, "max-fs", &
max_fs
))

22  
	`¶_u32
(&
max_fs
);

25 
	}
}

28 
	$vp8_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

29 
boŞ
 
ofãr
, *
¬g
)

31 cÚ¡ 
vp8_vidcodec
 *
vp8
 = 
¬g
;

32 ()
ofãr
;

34 ià(!
mb
 || !
fmt
 || !
vp8
 || !vp8->
max_fs
)

37  
	`mbuf_´štf
(
mb
, "a=fmtp:%s max-fs=%u\r\n",

38 
fmt
->
id
, 
vp8
->
max_fs
);

39 
	}
}

	@baresip/modules/vp8/vp8.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"vp8.h
"

28 
vp8_vidcodec
 
	gvp8
 = {

29 .
vc
 = {

30 .
Çme
 = "VP8",

31 .
	g’cupdh
 = 
vp8_’code_upd©e
,

32 .
	g’ch
 = 
vp8_’code
,

33 .
	gdecupdh
 = 
vp8_decode_upd©e
,

34 .
	gdech
 = 
vp8_decode
,

35 .
	gfm_’ch
 = 
vp8_fm_’c
,

37 .
	gmax_fs
 = 3600,

41 
	$moduË_š™
()

43 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), (
vidcodec
 *)&
vp8
);

46 
	}
}

49 
	$moduË_şo£
()

51 
	`vidcodec_uÄegi¡”
((
vidcodec
 *)&
vp8
);

54 
	}
}

57 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vp8
) = {

60 
moduË_š™
,

61 
moduË_şo£


	@baresip/modules/vp8/vp8.h

7 
	svp8_vidcodec
 {

8 
vidcodec
 
	mvc
;

9 
ušt32_t
 
	mmax_fs
;

13 
vp8_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

14 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

15 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

16 
vp8_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

17 cÚ¡ 
vidäame
 *
äame
);

21 
vp8_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

22 cÚ¡ *
fm
);

23 
vp8_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

24 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
);

28 
ušt32_t
 
vp8_max_fs
(cÚ¡ *
fm
);

29 
vp8_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

30 
boŞ
 
ofãr
, *
¬g
);

	@baresip/modules/vp9/decode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<vpx/vpx_decod”.h
>

12 
	~<vpx/vp8dx.h
>

13 
	~"vp9.h
"

17 
	mDECODE_MAXSZ
 = 524288,

21 
	shdr
 {

23 
	mi
:1;

24 
	mp
:1;

25 
	ml
:1;

26 
	mf
:1;

27 
	mb
:1;

28 
	me
:1;

29 
	mv
:1;

32 
ušt16_t
 
	mpicid
;

35 
	sviddec_¡©e
 {

36 
vpx_codec_ùx_t
 
	mùx
;

37 
mbuf
 *
	mmb
;

38 
boŞ
 
	mùxup
;

39 
boŞ
 
	m¡¬‹d
;

40 
ušt16_t
 
	m£q
;

42 
	mn_äames
;

43 
size_t
 
	mn_by‹s
;

47 
	$de¡ruùÜ
(*
¬g
)

49 
viddec_¡©e
 *
vds
 = 
¬g
;

51 ià(
vds
->
ùxup
) {

52 
	`debug
("vp9: decoder stats: frames=%u, bytes=%zu\n",

53 
vds
->
n_äames
, vds->
n_by‹s
);

55 
	`vpx_codec_de¡roy
(&
vds
->
ùx
);

58 
	`mem_d”ef
(
vds
->
mb
);

59 
	}
}

62 
	$vp9_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

63 cÚ¡ *
fm
)

65 
viddec_¡©e
 *
vds
;

66 
vpx_codec_”r_t
 
»s
;

67 
”r
 = 0;

68 ()
vc
;

69 ()
fm
;

71 ià(!
vd¥
)

72  
EINVAL
;

74 
vds
 = *
vd¥
;

76 ià(
vds
)

79 
vds
 = 
	`mem_z®loc
((*vds), 
de¡ruùÜ
);

80 ià(!
vds
)

81  
ENOMEM
;

83 
vds
->
mb
 = 
	`mbuf_®loc
(1024);

84 ià(!
vds
->
mb
) {

85 
”r
 = 
ENOMEM
;

86 
out
;

89 
»s
 = 
	`vpx_codec_dec_š™
(&
vds
->
ùx
, &
vpx_codec_vp9_dx_®go
, 
NULL
, 0);

90 ià(
»s
) {

91 
”r
 = 
ENOMEM
;

92 
out
;

95 
vds
->
ùxup
 = 
Œue
;

97 
out
:

98 ià(
”r
)

99 
	`mem_d”ef
(
vds
);

101 *
vd¥
 = 
vds
;

103  
”r
;

104 
	}
}

107 
šlše
 
	$hdr_decode
(
hdr
 *hdr, 
mbuf
 *
mb
)

109 
ušt8_t
 
v
;

111 
	`mem£t
(
hdr
, 0, (*hdr));

113 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

114  
EBADMSG
;

116 
v
 = 
	`mbuf_»ad_u8
(
mb
);

118 
hdr
->
i
 = 
v
>>7 & 0x1;

119 
hdr
->
p
 = 
v
>>6 & 0x1;

120 
hdr
->
l
 = 
v
>>5 & 0x1;

121 
hdr
->
f
 = 
v
>>4 & 0x1;

122 
hdr
->
b
 = 
v
>>3 & 0x1;

123 
hdr
->
e
 = 
v
>>2 & 0x1;

124 
hdr
->
v
 = v>>1 & 0x1;

126 ià(
hdr
->
p
) {

127 
	`w¬nšg
("vp9: decode: P-bit‚ot supported\n");

128  
EPROTO
;

130 ià(
hdr
->
l
) {

131 
	`w¬nšg
("vp9: decode: L-bit‚ot supported\n");

132  
EPROTO
;

134 ià(
hdr
->
f
) {

135 
	`w¬nšg
("vp9: decode: F-bit‚ot supported\n");

136  
EPROTO
;

138 ià(
hdr
->
v
) {

139 
	`w¬nšg
("vp9: decode: V-bit‚ot supported\n");

140  
EPROTO
;

143 ià(
hdr
->
i
) {

145 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

146  
EBADMSG
;

148 
v
 = 
	`mbuf_»ad_u8
(
mb
);

150 ià(
v
>>7 & 0x1) {

152 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

153  
EBADMSG
;

155 
hdr
->
picid
 = (
v
 & 0x7f)<<8;

156 
hdr
->
picid
 +ğ
	`mbuf_»ad_u8
(
mb
);

159 
hdr
->
picid
 = 
v
 & 0x7f;

164 
	}
}

167 
šlše
 
boŞ
 
	$is_keyäame
(cÚ¡ 
mbuf
 *
mb
)

169 
vpx_codec_¡»am_šfo_t
 
si
;

170 
vpx_codec_”r_t
 
»t
;

172 
	`mem£t
(&
si
, 0, (si));

173 
si
.
sz
 = (si);

175 
»t
 = 
	`vpx_codec_³ek_¡»am_šfo
(&
vpx_codec_vp9_dx_®go
,

176 
	`mbuf_buf
(
mb
),

177 ()
	`mbuf_g‘_Ëá
(
mb
), &
si
);

178 ià(
»t
 !ğ
VPX_CODEC_OK
)

179  
çl£
;

181  
si
.
is_kf
;

182 
	}
}

185 
šlše
 
št16_t
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

187  (
št16_t
)(
y
 - 
x
);

188 
	}
}

191 
	$vp9_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

192 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

194 
vpx_codec_™”_t
 
™”
 = 
NULL
;

195 
vpx_codec_”r_t
 
»s
;

196 
vpx_image_t
 *
img
;

197 
hdr
 hdr;

198 
”r
, 
i
;

200 ià(!
vds
 || !
äame
 || !
šŒa
 || !
mb
)

201  
EINVAL
;

203 *
šŒa
 = 
çl£
;

205 
vds
->
n_by‹s
 +ğ
	`mbuf_g‘_Ëá
(
mb
);

207 
”r
 = 
	`hdr_decode
(&
hdr
, 
mb
);

208 ià(
”r
)

209  
”r
;

212 
	`debug
("vp9: [%c] header: i=%u start=%uƒnd=%u…icid=%u \n",

213 
m¬k”
 ? 'M' : ' ', 
hdr
.
i
, hdr.
b
, hdr.
e
, hdr.
picid
);

216 ià(
hdr
.
b
) {

218 ià(
	`is_keyäame
(
mb
))

219 *
šŒa
 = 
Œue
;

221 
	`mbuf_»wšd
(
vds
->
mb
);

222 
vds
->
¡¬‹d
 = 
Œue
;

225 ià(!
vds
->
¡¬‹d
)

228 ià(
	`£q_diff
(
vds
->
£q
, seq) != 1) {

229 
	`mbuf_»wšd
(
vds
->
mb
);

230 
vds
->
¡¬‹d
 = 
çl£
;

235 
vds
->
£q
 = seq;

237 
”r
 = 
	`mbuf_wr™e_mem
(
vds
->
mb
, 
	`mbuf_buf
(mb), 
	`mbuf_g‘_Ëá
(mb));

238 ià(
”r
)

239 
out
;

241 ià(!
m¬k”
) {

243 ià(
vds
->
mb
->
’d
 > 
DECODE_MAXSZ
) {

244 
	`w¬nšg
("vp9: decode buffer sizeƒxceeded\n");

245 
”r
 = 
ENOMEM
;

246 
out
;

252 
»s
 = 
	`vpx_codec_decode
(&
vds
->
ùx
, vds->
mb
->
buf
,

253 ()
vds
->
mb
->
’d
, 
NULL
, 1);

254 ià(
»s
) {

255 
	`debug
("vp9: decod”rÜ: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

256 
”r
 = 
EPROTO
;

257 
out
;

260 
img
 = 
	`vpx_codec_g‘_äame
(&
vds
->
ùx
, &
™”
);

261 ià(!
img
) {

262 
	`debug
("vp9:‚o…icture\n");

263 
out
;

266 ià(
img
->
fmt
 !ğ
VPX_IMG_FMT_I420
) {

267 
	`w¬nšg
("vp9: bad…ix– fÜm© (%i)\n", 
img
->
fmt
);

268 
out
;

271 
i
=0; i<4; i++) {

272 
äame
->
d©a
[
i
] = 
img
->
¶ªes
[i];

273 
äame
->
lšesize
[
i
] = 
img
->
¡ride
[i];

276 
äame
->
size
.
w
 = 
img
->
d_w
;

277 
äame
->
size
.
h
 = 
img
->
d_h
;

278 
äame
->
fmt
 = 
VID_FMT_YUV420P
;

280 ++
vds
->
n_äames
;

282 
out
:

283 
	`mbuf_»wšd
(
vds
->
mb
);

284 
vds
->
¡¬‹d
 = 
çl£
;

286  
”r
;

287 
	}
}

	@baresip/modules/vp9/encode.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~<vpx/vpx_’cod”.h
>

12 
	~<vpx/vp8cx.h
>

13 
	~"vp9.h
"

17 
	mHDR_SIZE
 = 3,

21 
	svid’c_¡©e
 {

22 
vpx_codec_ùx_t
 
	mùx
;

23 
vidsz
 
	msize
;

24 
vpx_codec_±s_t
 
	m±s
;

25 
	mås
;

26 
	mb™¿‹
;

27 
	mpktsize
;

28 
boŞ
 
	mùxup
;

29 
ušt16_t
 
	mpicid
;

30 
vid’c_·ck‘_h
 *
	mpkth
;

31 *
	m¬g
;

33 
	mn_äames
;

34 
	mn_key_äames
;

35 
size_t
 
	mn_by‹s
;

39 
	$de¡ruùÜ
(*
¬g
)

41 
vid’c_¡©e
 *
ves
 = 
¬g
;

43 ià(
ves
->
ùxup
) {

45 
	`debug
("vp9:ƒncoder stats:"

47 
ves
->
n_äames
,

48 
ves
->
n_key_äames
,

49 
ves
->
n_by‹s
);

51 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

53 
	}
}

56 
	$vp9_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

57 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

58 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

60 cÚ¡ 
vp9_vidcodec
 *
vp9
 = (vp9_vidcodeø*)
vc
;

61 
vid’c_¡©e
 *
ves
;

62 
ušt32_t
 
max_fs
;

63 ()
vp9
;

65 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < (
HDR_SIZE
 + 1))

66  
EINVAL
;

68 
ves
 = *
ve¥
;

70 ià(!
ves
) {

72 
ves
 = 
	`mem_z®loc
((*ves), 
de¡ruùÜ
);

73 ià(!
ves
)

74  
ENOMEM
;

76 
ves
->
picid
 = 
	`¿nd_u16
();

78 *
ve¥
 = 
ves
;

81 ià(
ves
->
ùxup
 && (ves->
b™¿‹
 !ğ
´m
->bitrate ||

82 
ves
->
ås
 !ğ
´m
->fps)) {

84 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

85 
ves
->
ùxup
 = 
çl£
;

89 
ves
->
b™¿‹
 = 
´m
->bitrate;

90 
ves
->
pktsize
 = 
´m
->pktsize;

91 
ves
->
ås
 = 
´m
->fps;

92 
ves
->
pkth
 =…kth;

93 
ves
->
¬g
 =‡rg;

95 
max_fs
 = 
	`vp9_max_fs
(
fm
);

96 ià(
max_fs
 > 0)

97 
´m
->
max_fs
 = max_fs * 256;

100 
	}
}

103 
	$İ’_’cod”
(
vid’c_¡©e
 *
ves
, cÚ¡ 
vidsz
 *
size
)

105 
vpx_codec_’c_cfg_t
 
cfg
;

106 
vpx_codec_”r_t
 
»s
;

108 
»s
 = 
	`vpx_codec_’c_cÚfig_deçuÉ
(&
vpx_codec_vp9_cx_®go
, &
cfg
, 0);

109 ià(
»s
)

110  
EPROTO
;

119 
cfg
.
g_´ofe
 = 0;

120 
cfg
.
g_w
 = 
size
->
w
;

121 
cfg
.
g_h
 = 
size
->
h
;

122 
cfg
.
g_timeba£
.
num
 = 1;

123 
cfg
.
g_timeba£
.
d’
 = 
ves
->
ås
;

124 
cfg
.
rc_rg‘_b™¿‹
 = 
ves
->
b™¿‹
 / 1000;

125 
cfg
.
g_”rÜ_»s›Á
 = 
VPX_ERROR_RESILIENT_DEFAULT
;

126 
cfg
.
g_·ss
 = 
VPX_RC_ONE_PASS
;

127 
cfg
.
g_Ïg_š_äames
 = 0;

128 
cfg
.
rc_’d_u§ge
 = 
VPX_VBR
;

129 
cfg
.
kf_mode
 = 
VPX_KF_AUTO
;

131 ià(
ves
->
ùxup
) {

132 
	`debug
("vp9:„e-openingƒncoder\n");

133 
	`vpx_codec_de¡roy
(&
ves
->
ùx
);

134 
ves
->
ùxup
 = 
çl£
;

137 
»s
 = 
	`vpx_codec_’c_š™
(&
ves
->
ùx
, &
vpx_codec_vp9_cx_®go
, &
cfg
,

139 ià(
»s
) {

140 
	`w¬nšg
("vp9:ƒnøš™: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

141  
EPROTO
;

144 
ves
->
ùxup
 = 
Œue
;

146 
»s
 = 
	`vpx_codec_cÚŒŞ
(&
ves
->
ùx
, 
VP8E_SET_CPUUSED
, 8);

147 ià(
»s
) {

148 
	`w¬nšg
("vp9: codeøù¾: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

150 #ifdeà
VP9E_SET_NOISE_SENSITIVITY


151 
»s
 = 
	`vpx_codec_cÚŒŞ
(&
ves
->
ùx
, 
VP9E_SET_NOISE_SENSITIVITY
, 0);

152 ià(
»s
) {

153 
	`w¬nšg
("vp9: codeøù¾: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

157 
	`šfo
("vp9:ƒncod” o³Ãd,…iùu» siz%u x %u\n", 
size
->
w
, size->
h
);

160 
	}
}

163 
šlše
 
	$hdr_’code
(
ušt8_t
 
hdr
[
HDR_SIZE
], 
boŞ
 
¡¬t
, boŞ 
’d
,

164 
ušt16_t
 
picid
)

166 
hdr
[0] = 1<<7 | 
¡¬t
<<3 | 
’d
<<2;

167 
hdr
[1] = 1<<7 | (
picid
>>8 & 0x7f);

168 
hdr
[2] = 
picid
 & 0xff;

169 
	}
}

172 
	$£nd_·ck‘
(
vid’c_¡©e
 *
ves
, 
boŞ
 
m¬k”
,

173 cÚ¡ 
ušt8_t
 *
hdr
, 
size_t
 
hdr_Ën
,

174 cÚ¡ 
ušt8_t
 *
¶d
, 
size_t
 
¶d_Ën
,

175 
ušt32_t
 
¹p_ts
)

177 
ves
->
n_by‹s
 +ğ(
hdr_Ën
 + 
¶d_Ën
);

179  
ves
->
	`pkth
(
m¬k”
, 
¹p_ts
, 
hdr
, 
hdr_Ën
, 
¶d
, 
¶d_Ën
,

180 
ves
->
¬g
);

181 
	}
}

184 
šlše
 
	$·ck‘ize
(
vid’c_¡©e
 *
ves
,

185 
boŞ
 
m¬k”
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

186 
size_t
 
maxËn
, 
ušt16_t
 
picid
,

187 
ušt32_t
 
¹p_ts
)

189 
ušt8_t
 
hdr
[
HDR_SIZE
];

190 
boŞ
 
¡¬t
 = 
Œue
;

191 
”r
 = 0;

193 
maxËn
 -ğ(
hdr
);

195 
Ën
 > 
maxËn
) {

197 
	`hdr_’code
(
hdr
, 
¡¬t
, 
çl£
, 
picid
);

199 
”r
 |ğ
	`£nd_·ck‘
(
ves
, 
çl£
, 
hdr
, (hdr), 
buf
, 
maxËn
,

200 
¹p_ts
);

202 
buf
 +ğ
maxËn
;

203 
Ën
 -ğ
maxËn
;

204 
¡¬t
 = 
çl£
;

207 
	`hdr_’code
(
hdr
, 
¡¬t
, 
Œue
, 
picid
);

209 
”r
 |ğ
	`£nd_·ck‘
(
ves
, 
m¬k”
, 
hdr
, (hdr), 
buf
, 
Ën
,

210 
¹p_ts
);

212  
”r
;

213 
	}
}

216 
	$vp9_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

217 cÚ¡ 
vidäame
 *
äame
)

219 
vpx_’c_äame_æags_t
 
æags
 = 0;

220 
vpx_codec_™”_t
 
™”
 = 
NULL
;

221 
vpx_codec_”r_t
 
»s
;

222 
vpx_image_t
 *
img
 = 
NULL
;

223 
vpx_img_fmt_t
 
img_fmt
;

224 
”r
, 
i
;

226 ià(!
ves
 || !
äame
)

227  
EINVAL
;

229 
äame
->
fmt
) {

231 
VID_FMT_YUV420P
:

232 
img_fmt
 = 
VPX_IMG_FMT_I420
;

236 
	`w¬nšg
("vp9:…ixel format‚ot supported (%s)\n",

237 
	`vidfmt_Çme
(
äame
->
fmt
));

238  
EINVAL
;

241 ià(!
ves
->
ùxup
 || !
	`vidsz_cmp
(&ves->
size
, &
äame
->size)) {

243 
”r
 = 
	`İ’_’cod”
(
ves
, &
äame
->
size
);

244 ià(
”r
)

245  
”r
;

247 
ves
->
size
 = 
äame
->size;

250 ++
ves
->
n_äames
;

252 ià(
upd©e
) {

254 
æags
 |ğ
VPX_EFLAG_FORCE_KF
;

257 
img
 = 
	`vpx_img_w¿p
(
NULL
, 
img_fmt
, 
äame
->
size
.
w
, f¿me->size.
h
,

258 16, 
NULL
);

259 ià(!
img
) {

260 
	`w¬nšg
("vp9:ƒncoder: could‚ot‡llocate image\n");

261 
”r
 = 
ENOMEM
;

262 
out
;

265 
i
=0; i<4; i++) {

266 
img
->
¡ride
[
i
] = 
äame
->
lšesize
[i];

267 
img
->
¶ªes
[
i
] = 
äame
->
d©a
[i];

270 
»s
 = 
	`vpx_codec_’code
(&
ves
->
ùx
, 
img
, ves->
±s
++, 1,

271 
æags
, 
VPX_DL_REALTIME
);

272 ià(
»s
) {

273 
	`w¬nšg
("vp9:ƒnø”rÜ: %s\n", 
	`vpx_codec_”r_to_¡ršg
(
»s
));

274 
”r
 = 
ENOMEM
;

275 
out
;

278 ++
ves
->
picid
;

281 
boŞ
 
m¬k”
 = 
Œue
;

282 cÚ¡ 
vpx_codec_cx_pkt_t
 *
pkt
;

283 
ušt32_t
 
ts
;

285 
pkt
 = 
	`vpx_codec_g‘_cx_d©a
(&
ves
->
ùx
, &
™”
);

286 ià(!
pkt
)

289 ià(
pkt
->
kšd
 !ğ
VPX_CODEC_CX_FRAME_PKT
) {

293 ià(
pkt
->
d©a
.
äame
.
æags
 & 
VPX_FRAME_IS_KEY
) {

294 ++
ves
->
n_key_äames
;

297 ià(
pkt
->
d©a
.
äame
.
æags
 & 
VPX_FRAME_IS_FRAGMENT
)

298 
m¬k”
 = 
çl£
;

300 
ts
 = 
	`video_ÿlc_¹p_time¡amp
(
pkt
->
d©a
.
äame
.
±s
, 
ves
->
ås
);

302 
”r
 = 
	`·ck‘ize
(
ves
,

303 
m¬k”
,

304 
pkt
->
d©a
.
äame
.
buf
,

305 
pkt
->
d©a
.
äame
.
sz
,

306 
ves
->
pktsize
, ves->
picid
,

307 
ts
);

308 ià(
”r
)

309  
”r
;

312 
out
:

313 ià(
img
)

314 
	`vpx_img_ä“
(
img
);

316  
”r
;

317 
	}
}

	@baresip/modules/vp9/sdp.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"vp9.h
"

12 
ušt32_t
 
	$vp9_max_fs
(cÚ¡ *
fm
)

14 
¶
…l, 
max_fs
;

16 ià(!
fm
)

19 
	`¶_£t_¡r
(&
¶
, 
fm
);

21 ià(
	`fmt_·¿m_g‘
(&
¶
, "max-fs", &
max_fs
))

22  
	`¶_u32
(&
max_fs
);

25 
	}
}

28 
	$vp9_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

29 
boŞ
 
ofãr
, *
¬g
)

31 cÚ¡ 
vp9_vidcodec
 *
vp9
 = 
¬g
;

32 ()
ofãr
;

34 ià(!
mb
 || !
fmt
 || !
vp9
 || !vp9->
max_fs
)

37  
	`mbuf_´štf
(
mb
, "a=fmtp:%s max-fs=%u\r\n",

38 
fmt
->
id
, 
vp9
->
max_fs
);

39 
	}
}

	@baresip/modules/vp9/vp9.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"vp9.h
"

32 
vp9_vidcodec
 
	gvp9
 = {

33 .
vc
 = {

34 .
Çme
 = "VP9",

35 .
	g’cupdh
 = 
vp9_’code_upd©e
,

36 .
	g’ch
 = 
vp9_’code
,

37 .
	gdecupdh
 = 
vp9_decode_upd©e
,

38 .
	gdech
 = 
vp9_decode
,

39 .
	gfm_’ch
 = 
vp9_fm_’c
,

41 .
	gmax_fs
 = 3600

45 
	$moduË_š™
()

47 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), (
vidcodec
 *)&
vp9
);

49 
	}
}

52 
	$moduË_şo£
()

54 
	`vidcodec_uÄegi¡”
((
vidcodec
 *)&
vp9
);

56 
	}
}

59 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vp9
) = {

62 
moduË_š™
,

63 
moduË_şo£


	@baresip/modules/vp9/vp9.h

7 
	svp9_vidcodec
 {

8 
vidcodec
 
	mvc
;

9 
ušt32_t
 
	mmax_fs
;

13 
vp9_’code_upd©e
(
vid’c_¡©e
 **
ve¥
, cÚ¡ 
vidcodec
 *
vc
,

14 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

15 
vid’c_·ck‘_h
 *
pkth
, *
¬g
);

16 
vp9_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

17 cÚ¡ 
vidäame
 *
äame
);

21 
vp9_decode_upd©e
(
viddec_¡©e
 **
vd¥
, cÚ¡ 
vidcodec
 *
vc
,

22 cÚ¡ *
fm
);

23 
vp9_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

24 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
);

28 
ušt32_t
 
vp9_max_fs
(cÚ¡ *
fm
);

29 
vp9_fm_’c
(
mbuf
 *
mb
, cÚ¡ 
sdp_fÜm©
 *
fmt
,

30 
boŞ
 
ofãr
, *
¬g
);

	@baresip/modules/vumeter/vumeter.c

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

23 
	svum‘”_’c
 {

24 
auft_’c_¡
 
	maf
;

25 
tmr
 
	mtmr
;

26 
	mavg_»c
;

27 vŞ©
boŞ
 
	m¡¬‹d
;

30 
	svum‘”_dec
 {

31 
auft_dec_¡
 
	maf
;

32 
tmr
 
	mtmr
;

33 
	mavg_¶ay
;

34 vŞ©
boŞ
 
	m¡¬‹d
;

38 
	$’c_de¡ruùÜ
(*
¬g
)

40 
vum‘”_’c
 *
¡
 = 
¬g
;

42 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

43 
	`tmr_ÿnûl
(&
¡
->
tmr
);

44 
	}
}

47 
	$dec_de¡ruùÜ
(*
¬g
)

49 
vum‘”_dec
 *
¡
 = 
¬g
;

51 
	`li¡_uÆšk
(&
¡
->
af
.
Ë
);

52 
	`tmr_ÿnûl
(&
¡
->
tmr
);

53 
	}
}

56 
	$audio_´št_vu
(
»_´štf
 *
pf
, *
Ëv–
)

58 
buf
[16];

59 
size_t
 
»s
;

60 
x
;

62 
x
 = (*
Ëv–
 + -
AULEVEL_MIN
) / -AULEVEL_MIN;

64 
»s
 = 
	`mš
((
buf
è* 
x
,

65 (
buf
)-1);

67 
	`mem£t
(
buf
, '=', 
»s
);

68 
buf
[
»s
] = '\0';

70  
	`»_h´štf
(
pf
, "[%-16s]", 
buf
);

71 
	}
}

74 
	$´št_vum‘”
(
pos
, 
cŞÜ
, 
v®ue
)

77 
	`»_årštf
(
¡d”r
, "\x1b[%dG", 
pos
);

80 
	`»_årštf
(
¡d”r
, " \x1b[%dm%H\x1b[;m\r",

81 
cŞÜ
, 
audio_´št_vu
, &
v®ue
);

82 
	}
}

85 
	$’c_tmr_hªdËr
(*
¬g
)

87 
vum‘”_’c
 *
¡
 = 
¬g
;

89 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
’c_tmr_hªdËr
, st);

91 ià(
¡
->
¡¬‹d
)

92 
	`´št_vum‘”
(60, 31, 
¡
->
avg_»c
);

93 
	}
}

96 
	$dec_tmr_hªdËr
(*
¬g
)

98 
vum‘”_dec
 *
¡
 = 
¬g
;

100 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
dec_tmr_hªdËr
, st);

102 ià(
¡
->
¡¬‹d
)

103 
	`´št_vum‘”
(80, 32, 
¡
->
avg_¶ay
);

104 
	}
}

107 
	$’code_upd©e
(
auft_’c_¡
 **
¡p
, **
ùx
,

108 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

110 
vum‘”_’c
 *
¡
;

111 ()
ùx
;

112 ()
´m
;

114 ià(!
¡p
 || !
af
)

115  
EINVAL
;

117 ià(*
¡p
)

120 
¡
 = 
	`mem_z®loc
((*¡), 
’c_de¡ruùÜ
);

121 ià(!
¡
)

122  
ENOMEM
;

124 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
’c_tmr_hªdËr
, st);

126 *
¡p
 = (
auft_’c_¡
 *)
¡
;

129 
	}
}

132 
	$decode_upd©e
(
auft_dec_¡
 **
¡p
, **
ùx
,

133 cÚ¡ 
auft
 *
af
, 
auft_´m
 *
´m
)

135 
vum‘”_dec
 *
¡
;

136 ()
ùx
;

137 ()
´m
;

139 ià(!
¡p
 || !
af
)

140  
EINVAL
;

142 ià(*
¡p
)

145 
¡
 = 
	`mem_z®loc
((*¡), 
dec_de¡ruùÜ
);

146 ià(!
¡
)

147  
ENOMEM
;

149 
	`tmr_¡¬t
(&
¡
->
tmr
, 100, 
dec_tmr_hªdËr
, st);

151 *
¡p
 = (
auft_dec_¡
 *)
¡
;

154 
	}
}

157 
	$’code
(
auft_’c_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

159 
vum‘”_’c
 *
vu
 = (*)
¡
;

161 
vu
->
avg_»c
 = 
	`auËv–_ÿlc_dbov
(
§mpv
, *
§mpc
);

162 
vu
->
¡¬‹d
 = 
Œue
;

165 
	}
}

168 
	$decode
(
auft_dec_¡
 *
¡
, 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
)

170 
vum‘”_dec
 *
vu
 = (*)
¡
;

172 
vu
->
avg_¶ay
 = 
	`auËv–_ÿlc_dbov
(
§mpv
, *
§mpc
);

173 
vu
->
¡¬‹d
 = 
Œue
;

176 
	}
}

179 
auft
 
	gvum‘”
 = {

180 
LE_INIT
, "vum‘”", 
’code_upd©e
, 
’code
, 
decode_upd©e
, 
decode


184 
	$moduË_š™
()

186 
	`auft_»gi¡”
(
	`b¬es_auf
(), &
vum‘”
);

188 
	}
}

191 
	$moduË_şo£
()

193 
	`auft_uÄegi¡”
(&
vum‘”
);

195 
	}
}

198 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
vum‘”
) = {

201 
moduË_š™
,

202 
moduË_şo£


	@baresip/modules/wincons/wincons.c

7 
	~<wšsock2.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

21 
	mRELEASE_VAL
 = 250

24 
	sui_¡
 {

25 
tmr
 
	mtmr
;

26 
mqueue
 *
	mmq
;

27 
HANDLE
 
	mhTh»ad
;

28 
boŞ
 
	mrun
;

29 
HANDLE
 
	mh¡dš
;

30 
DWORD
 
	mmode
;

34 
ui_¡
 *
	gwšcÚs
;

37 
	$de¡ruùÜ
(*
¬g
)

39 
ui_¡
 *
¡
 = 
¬g
;

42 ià(
¡
->
mode
)

43 
	`S‘CÚsŞeMode
(
	`G‘StdHªdË
(
STD_INPUT_HANDLE
), 
¡
->
mode
);

45 
¡
->
run
 = 
çl£
;

46 
	`Wa™FÜSšgËObjeù
(
¡
->
hTh»ad
, 5000);

47 
	`Clo£HªdË
(
¡
->
hTh»ad
);

49 
	`tmr_ÿnûl
(&
¡
->
tmr
);

50 
	`mem_d”ef
(
¡
->
mq
);

51 
	}
}

54 
	$´št_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

56 ()
¬g
;

58  1 =ğ
	`fwr™e
(
p
, 
size
, 1, 
¡d”r
è? 0 : 
ENOMEM
;

59 
	}
}

62 
	$»pÜt_key
(
ui_¡
 *
ui
, 
key
)

64 
»_´štf
 
pf_¡d”r
 = {
´št_hªdËr
, 
NULL
};

65 ()
ui
;

67 
	`ui_šput_key
(
	`b¬es_uis
(), 
key
, &
pf_¡d”r
);

68 
	}
}

71 
	$timeout
(*
¬g
)

73 
ui_¡
 *
¡
 = 
¬g
;

76 
	`»pÜt_key
(
¡
, 
KEYCODE_REL
);

77 
	}
}

80 
DWORD
 
WINAPI
 
	$šput_th»ad
(
LPVOID
 
¬g
)

82 
ui_¡
 *
¡
 = 
¬g
;

85 
	`S‘CÚsŞeMode
(
¡
->
h¡dš
, 0);

87 
¡
->
run
) {

89 
INPUT_RECORD
 
buf
[4];

90 
DWORD
 
i
, 
couÁ
 = 0;

92 
	`R—dCÚsŞeIÅut
(
¡
->
h¡dš
, 
buf
, 
	`ARRAY_SIZE
(buf), &
couÁ
);

94 
i
=0; i<
couÁ
; i++) {

96 ià(
buf
[
i
].
Ev’tTy³
 !ğ
KEY_EVENT
)

99 ià(
buf
[
i
].
Ev’t
.
KeyEv’t
.
bKeyDown
) {

101 
ch
 = 
buf
[
i
].
Ev’t
.
KeyEv’t
.
uCh¬
.
AsciiCh¬
;

103 ià(
ch
 == '\r')

104 
ch
 = '\n';

107 ià(
ch
 == 'q')

108 
¡
->
run
 = 
çl£
;

115 ià(
ch
)

116 
	`mqueue_push
(
¡
->
mq
, 
ch
, 
NULL
);

122 
	}
}

125 
	$mqueue_hªdËr
(
id
, *
d©a
, *
¬g
)

127 
ui_¡
 *
¡
 = 
¬g
;

128 ()
d©a
;

130 
	`tmr_¡¬t
(&
¡
->
tmr
, 
RELEASE_VAL
, 
timeout
, st);

131 
	`»pÜt_key
(
¡
, 
id
);

132 
	}
}

135 
	$ui_®loc
(
ui_¡
 **
¡p
)

137 
ui_¡
 *
¡
;

138 
DWORD
 
th»adID
;

139 
”r
 = 0;

141 ià(!
¡p
)

142  
EINVAL
;

144 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

145 ià(!
¡
)

146  
ENOMEM
;

148 
	`tmr_š™
(&
¡
->
tmr
);

150 
”r
 = 
	`mqueue_®loc
(&
¡
->
mq
, 
mqueue_hªdËr
, st);

151 ià(
”r
)

152 
out
;

154 
¡
->
h¡dš
 = 
	`G‘StdHªdË
(
STD_INPUT_HANDLE
);

157 
	`G‘CÚsŞeMode
(
¡
->
h¡dš
, &¡->
mode
);

159 
¡
->
run
 = 
Œue
;

160 
¡
->
hTh»ad
 = 
	`C»©eTh»ad
(
NULL
, 0, 
šput_th»ad
, st, 0, &
th»adID
);

161 ià(!
¡
->
hTh»ad
) {

162 
¡
->
run
 = 
çl£
;

163 
”r
 = 
ENOMEM
;

164 
out
;

167 
out
:

168 ià(
”r
)

169 
	`mem_d”ef
(
¡
);

171 *
¡p
 = 
¡
;

173  
”r
;

174 
	}
}

177 
	$ouut_hªdËr
(cÚ¡ *
¡r
)

179  
	`´št_hªdËr
(
¡r
, 
	`¡r_Ën
(¡r), 
NULL
);

180 
	}
}

183 
ui
 
	gui_wšcÚs
 = {

184 
LE_INIT
,

186 
ouut_hªdËr


190 
	$moduË_š™
()

192 
”r
;

194 
”r
 = 
	`ui_®loc
(&
wšcÚs
);

195 ià(
”r
)

196  
”r
;

198 
	`ui_»gi¡”
(
	`b¬es_uis
(), &
ui_wšcÚs
);

201 
	}
}

204 
	$moduË_şo£
()

206 
	`ui_uÄegi¡”
(&
ui_wšcÚs
);

207 
wšcÚs
 = 
	`mem_d”ef
(wincons);

209 
	}
}

212 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
wšcÚs
) = {

215 
moduË_š™
,

216 
moduË_şo£


	@baresip/modules/winwave/play.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<wšdows.h
>

9 
	~<mmsy¡em.h
>

10 
	~<b¬es.h
>

11 
	~"wšwave.h
"

14 
	#WRITE_BUFFERS
 4

	)

15 
	#INC_WPOS
(
a
è(×èğ((×è+ 1è% 
WRITE_BUFFERS
))

	)

18 
	sau¶ay_¡
 {

19 cÚ¡ 
au¶ay
 *
	m­
;

20 
d¥buf
 
	mbufs
[
WRITE_BUFFERS
];

21 
	mpos
;

22 
HWAVEOUT
 
	mwaveout
;

23 vŞ©
boŞ
 
	mrdy
;

24 
size_t
 
	mšu£
;

25 
au¶ay_wr™e_h
 *
	mwh
;

26 *
	m¬g
;

30 
	$au¶ay_de¡ruùÜ
(*
¬g
)

32 
au¶ay_¡
 *
¡
 = 
¬g
;

33 
i
;

35 
¡
->
wh
 = 
NULL
;

40 
¡
->
rdy
 = 
çl£
;

41 
¡
->
šu£
 > 0)

42 
	`SË•
(50);

44 
	`waveOutRe£t
(
¡
->
waveout
);

46 
i
 = 0; i < 
WRITE_BUFFERS
; i++) {

47 
	`waveOutUÅ»·»H—d”
(
¡
->
waveout
, &¡->
bufs
[
i
].
wh
,

48 (
WAVEHDR
));

49 
	`mem_d”ef
(
¡
->
bufs
[
i
].
mb
);

52 
	`waveOutClo£
(
¡
->
waveout
);

53 
	}
}

56 
	$d¥_wr™e
(
au¶ay_¡
 *
¡
)

58 
MMRESULT
 
»s
;

59 
WAVEHDR
 *
wh
;

60 
mbuf
 *
mb
;

62 ià(!
¡
->
rdy
)

63  
EINVAL
;

65 
wh
 = &
¡
->
bufs
[¡->
pos
].wh;

66 ià(
wh
->
dwFÏgs
 & 
WHDR_PREPARED
) {

67  
EINVAL
;

69 
mb
 = 
¡
->
bufs
[¡->
pos
].mb;

70 
wh
->
ÍD©a
 = (
LPSTR
)
mb
->
buf
;

72 ià(
¡
->
wh
) {

73 
¡
->
	`wh
((*)
mb
->
buf
, mb->
size
/2, st->
¬g
);

76 
wh
->
dwBufãrL’gth
 = 
mb
->
size
;

77 
wh
->
dwFÏgs
 = 0;

78 
wh
->
dwU£r
 = (
DWORD_PTR
è
mb
;

80 
	`waveOutP»·»H—d”
(
¡
->
waveout
, 
wh
, (*wh));

82 
	`INC_WPOS
(
¡
->
pos
);

84 
»s
 = 
	`waveOutWr™e
(
¡
->
waveout
, 
wh
, (*wh));

85 ià(
»s
 !ğ
MMSYSERR_NOERROR
)

86 
	`w¬nšg
("winwave: dsp_write: waveOutWrite: failed: %08x\n",

87 
»s
);

89 
¡
->
šu£
++;

92 
	}
}

95 
CALLBACK
 
	$waveOutC®lback
(
HWAVEOUT
 
hwo
,

96 
UINT
 
uMsg
,

97 
DWORD_PTR
 
dwIn¡ªû
,

98 
DWORD_PTR
 
dwP¬am1
,

99 
DWORD_PTR
 
dwP¬am2
)

101 
au¶ay_¡
 *
¡
 = (au¶ay_¡ *)
dwIn¡ªû
;

102 
WAVEHDR
 *
wh
 = (WAVEHDR *)
dwP¬am1
;

104 ()
hwo
;

105 ()
dwP¬am2
;

107 
uMsg
) {

109 
WOM_OPEN
:

110 
¡
->
rdy
 = 
Œue
;

113 
WOM_DONE
:

115 
	`waveOutUÅ»·»H—d”
(
¡
->
waveout
, 
wh
, (*wh));

117 
¡
->
šu£
--;

118 
	`d¥_wr™e
(
¡
);

121 
WOM_CLOSE
:

122 
¡
->
rdy
 = 
çl£
;

128 
	}
}

131 
	$fšd_dev
(cÚ¡ *
Çme
)

133 
WAVEOUTCAPS
 
wic
;

134 
i
, 
nInDeviûs
 = 
	`waveOutG‘NumDevs
();

136 ià(!
	`¡r_is£t
(
Çme
))

137  
WAVE_MAPPER
;

139 
i
=0; i<
nInDeviûs
; i++) {

140 ià(
	`waveOutG‘DevC­s
(
i
, &
wic
,

141 (
WAVEOUTCAPS
))==
MMSYSERR_NOERROR
) {

143 ià(0 =ğ
	`¡r_cmp
(
Çme
, 
wic
.
szPÇme
)) {

144  
i
;

149  
WAVE_MAPPER
;

150 
	}
}

153 
	$wr™e_¡»am_İ’
(
au¶ay_¡
 *
¡
,

154 cÚ¡ 
au¶ay_´m
 *
´m
,

155 
dev
)

157 
WAVEFORMATEX
 
wfmt
;

158 
MMRESULT
 
»s
;

159 
ušt32_t
 
§mpc
;

160 
i
;

163 
¡
->
waveout
 = 
NULL
;

164 
¡
->
pos
 = 0;

165 
¡
->
rdy
 = 
çl£
;

167 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

169 
i
 = 0; i < 
WRITE_BUFFERS
; i++) {

170 
	`mem£t
(&
¡
->
bufs
[
i
].
wh
, 0, (
WAVEHDR
));

171 
¡
->
bufs
[
i
].
mb
 = 
	`mbuf_®loc
(2 * 
§mpc
);

174 
wfmt
.
wFÜm©Tag
 = 
WAVE_FORMAT_PCM
;

175 
wfmt
.
nChªÃls
 = 
´m
->
ch
;

176 
wfmt
.
nSam¶esP”Sec
 = 
´m
->
¤©e
;

177 
wfmt
.
wB™sP”Sam¶e
 = 16;

178 
wfmt
.
nBlockAlign
 = (
´m
->
ch
 * wfmt.
wB™sP”Sam¶e
) / 8;

179 
wfmt
.
nAvgBy‹sP”Sec
 = wfmt.
nSam¶esP”Sec
 * wfmt.
nBlockAlign
;

180 
wfmt
.
cbSize
 = 0;

182 
»s
 = 
	`waveOutO³n
(&
¡
->
waveout
, 
dev
, &
wfmt
,

183 (
DWORD_PTR
è
waveOutC®lback
,

184 (
DWORD_PTR
è
¡
,

185 
CALLBACK_FUNCTION
 | 
WAVE_FORMAT_DIRECT
);

186 ià(
»s
 !ğ
MMSYSERR_NOERROR
) {

187 
	`w¬nšg
("wšwave: waveOutO³n: faed %d\n", 
»s
);

188  
EINVAL
;

192 
	}
}

195 
	$wšwave_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

196 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

197 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

199 
au¶ay_¡
 *
¡
;

200 
i
, 
”r
;

202 ià(!
¡p
 || !
­
 || !
´m
)

203  
EINVAL
;

205 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

206 
	`w¬nšg
("winwave:…layback: unsupported sample format (%s)\n",

207 
	`aufmt_Çme
(
´m
->
fmt
));

208  
ENOTSUP
;

211 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

212 ià(!
¡
)

213  
ENOMEM
;

215 
¡
->
­
 =‡p;

216 
¡
->
wh
 = wh;

217 
¡
->
¬g
 =‡rg;

219 
”r
 = 
	`wr™e_¡»am_İ’
(
¡
, 
´m
, 
	`fšd_dev
(
deviû
));

220 ià(
”r
)

221 
out
;

226 
i
 = 0; i < 5; i++)

227 
	`d¥_wr™e
(
¡
);

229 
out
:

230 ià(
”r
)

231 
	`mem_d”ef
(
¡
);

233 *
¡p
 = 
¡
;

235  
”r
;

236 
	}
}

	@baresip/modules/winwave/src.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<wšdows.h
>

9 
	~<mmsy¡em.h
>

10 
	~<b¬es.h
>

11 
	~"wšwave.h
"

14 
	#READ_BUFFERS
 4

	)

15 
	#INC_RPOS
(
a
è(×èğ((×è+ 1è% 
READ_BUFFERS
))

	)

18 
	sau¤c_¡
 {

19 cÚ¡ 
au¤c
 *
	mas
;

20 
d¥buf
 
	mbufs
[
READ_BUFFERS
];

21 
	mpos
;

22 
HWAVEIN
 
	mwaveš
;

23 vŞ©
boŞ
 
	mrdy
;

24 
size_t
 
	mšu£
;

25 
au¤c_»ad_h
 *
	mrh
;

26 *
	m¬g
;

30 
	$au¤c_de¡ruùÜ
(*
¬g
)

32 
au¤c_¡
 *
¡
 = 
¬g
;

33 
i
;

35 
¡
->
rh
 = 
NULL
;

37 
	`waveInStİ
(
¡
->
waveš
);

38 
	`waveInRe£t
(
¡
->
waveš
);

40 
i
 = 0; i < 
READ_BUFFERS
; i++) {

41 
	`waveInUÅ»·»H—d”
(
¡
->
waveš
, &¡->
bufs
[
i
].
wh
,

42 (
WAVEHDR
));

43 
	`mem_d”ef
(
¡
->
bufs
[
i
].
mb
);

46 
	`waveInClo£
(
¡
->
waveš
);

47 
	}
}

50 
	$add_wave_š
(
au¤c_¡
 *
¡
)

52 
d¥buf
 *
db
 = &
¡
->
bufs
[¡->
pos
];

53 
WAVEHDR
 *
wh
 = &
db
->wh;

54 
MMRESULT
 
»s
;

56 
wh
->
ÍD©a
 = (
LPSTR
)
db
->
mb
->
buf
;

57 
wh
->
dwBufãrL’gth
 = 
db
->
mb
->
size
;

58 
wh
->
dwBy‹sRecÜded
 = 0;

59 
wh
->
dwFÏgs
 = 0;

60 
wh
->
dwU£r
 = (
DWORD_PTR
)
db
->
mb
;

62 
	`waveInP»·»H—d”
(
¡
->
waveš
, 
wh
, (*wh));

63 
»s
 = 
	`waveInAddBufãr
(
¡
->
waveš
, 
wh
, (*wh));

64 ià(
»s
 !ğ
MMSYSERR_NOERROR
) {

65 
	`w¬nšg
("winwave:‡dd_wave_in: waveInAddBuffer fail: %08x\n",

66 
»s
);

67  
ENOMEM
;

70 
	`INC_RPOS
(
¡
->
pos
);

72 
¡
->
šu£
++;

75 
	}
}

78 
CALLBACK
 
	$waveInC®lback
(
HWAVEOUT
 
hwo
,

79 
UINT
 
uMsg
,

80 
DWORD_PTR
 
dwIn¡ªû
,

81 
DWORD_PTR
 
dwP¬am1
,

82 
DWORD_PTR
 
dwP¬am2
)

84 
au¤c_¡
 *
¡
 = (au¤c_¡ *)
dwIn¡ªû
;

85 
WAVEHDR
 *
wh
 = (WAVEHDR *)
dwP¬am1
;

87 ()
hwo
;

88 ()
dwP¬am2
;

90 ià(!
¡
->
rh
)

93 
uMsg
) {

95 
WIM_CLOSE
:

96 
¡
->
rdy
 = 
çl£
;

99 
WIM_OPEN
:

100 
¡
->
rdy
 = 
Œue
;

103 
WIM_DATA
:

104 ià(
¡
->
šu£
 < (
READ_BUFFERS
-1))

105 
	`add_wave_š
(
¡
);

107 
¡
->
	`rh
((*)
wh
->
ÍD©a
, wh->
dwBy‹sRecÜded
/2, st->
¬g
);

109 
	`waveInUÅ»·»H—d”
(
¡
->
waveš
, 
wh
, (*wh));

110 
¡
->
šu£
--;

116 
	}
}

119 
	$fšd_dev
(cÚ¡ *
Çme
)

121 
WAVEINCAPS
 
wic
;

122 
i
, 
nInDeviûs
 = 
	`waveInG‘NumDevs
();

124 ià(!
	`¡r_is£t
(
Çme
))

125  
WAVE_MAPPER
;

127 
i
=0; i<
nInDeviûs
; i++) {

128 ià(
	`waveInG‘DevC­s
(
i
, &
wic
,

129 (
WAVEINCAPS
))==
MMSYSERR_NOERROR
) {

131 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
wic
.
szPÇme
)) {

132  
i
;

137  
WAVE_MAPPER
;

138 
	}
}

141 
	$»ad_¡»am_İ’
(
au¤c_¡
 *
¡
, cÚ¡ 
au¤c_´m
 *
´m
,

142 
dev
)

144 
WAVEFORMATEX
 
wfmt
;

145 
MMRESULT
 
»s
;

146 
ušt32_t
 
§mpc
;

147 
i
, 
”r
 = 0;

150 
¡
->
waveš
 = 
NULL
;

151 
¡
->
pos
 = 0;

152 
¡
->
rdy
 = 
çl£
;

154 
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

156 
i
 = 0; i < 
READ_BUFFERS
; i++) {

157 
	`mem£t
(&
¡
->
bufs
[
i
].
wh
, 0, (
WAVEHDR
));

158 
¡
->
bufs
[
i
].
mb
 = 
	`mbuf_®loc
(2 * 
§mpc
);

159 ià(!
¡
->
bufs
[
i
].
mb
)

160  
ENOMEM
;

163 
wfmt
.
wFÜm©Tag
 = 
WAVE_FORMAT_PCM
;

164 
wfmt
.
nChªÃls
 = 
´m
->
ch
;

165 
wfmt
.
nSam¶esP”Sec
 = 
´m
->
¤©e
;

166 
wfmt
.
wB™sP”Sam¶e
 = 16;

167 
wfmt
.
nBlockAlign
 = (
´m
->
ch
 * wfmt.
wB™sP”Sam¶e
) / 8;

168 
wfmt
.
nAvgBy‹sP”Sec
 = wfmt.
nSam¶esP”Sec
 * wfmt.
nBlockAlign
;

169 
wfmt
.
cbSize
 = 0;

171 
»s
 = 
	`waveInO³n
(&
¡
->
waveš
, 
dev
, &
wfmt
,

172 (
DWORD_PTR
è
waveInC®lback
,

173 (
DWORD_PTR
è
¡
,

174 
CALLBACK_FUNCTION
 | 
WAVE_FORMAT_DIRECT
);

175 ià(
»s
 !ğ
MMSYSERR_NOERROR
) {

176 
	`w¬nšg
("wšwave: waveInO³n: faed %d\n", 
”r
);

177  
EINVAL
;

181 
i
 = 0; i < 
READ_BUFFERS
; i++)

182 
”r
 |ğ
	`add_wave_š
(
¡
);

184 
	`waveInS¹
(
¡
->
waveš
);

186  
”r
;

187 
	}
}

190 
	$wšwave_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

191 
medŸ_ùx
 **
ùx
,

192 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

193 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

195 
au¤c_¡
 *
¡
;

196 
”r
;

198 ()
ùx
;

199 ()
”rh
;

201 ià(!
¡p
 || !
as
 || !
´m
)

202  
EINVAL
;

204 ià(
´m
->
fmt
 !ğ
AUFMT_S16LE
) {

205 
	`w¬nšg
("winwave: source: unsupported sample format (%s)\n",

206 
	`aufmt_Çme
(
´m
->
fmt
));

207  
ENOTSUP
;

210 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

211 ià(!
¡
)

212  
ENOMEM
;

214 
¡
->
as
 =‡s;

215 
¡
->
rh
 =„h;

216 
¡
->
¬g
 =‡rg;

218 
”r
 = 
	`»ad_¡»am_İ’
(
¡
, 
´m
, 
	`fšd_dev
(
deviû
));

220 ià(
”r
)

221 
	`mem_d”ef
(
¡
);

223 *
¡p
 = 
¡
;

225  
”r
;

226 
	}
}

	@baresip/modules/winwave/winwave.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<wšdows.h
>

9 
	~<mmsy¡em.h
>

10 
	~<b¬es.h
>

11 
	~"wšwave.h
"

22 
au¤c
 *
	gau¤c
;

23 
au¶ay
 *
	gau¶ay
;

26 
	$ww_š™
()

28 
¶ay_dev_couÁ
, 
¤c_dev_couÁ
;

29 
”r
;

31 
¶ay_dev_couÁ
 = 
	`waveOutG‘NumDevs
();

32 
¤c_dev_couÁ
 = 
	`waveInG‘NumDevs
();

34 
	`šfo
("winwave: output devices: %d, input devices: %d\n",

35 
¶ay_dev_couÁ
, 
¤c_dev_couÁ
);

37 
”r
 = 
	`au¤c_»gi¡”
(&
au¤c
, 
	`b¬es_au¤ş
(),

38 "wšwave", 
wšwave_¤c_®loc
);

39 
”r
 |ğ
	`au¶ay_»gi¡”
(&
au¶ay
, 
	`b¬es_au¶ayl
(),

40 "wšwave", 
wšwave_¶ay_®loc
);

42  
”r
;

43 
	}
}

46 
	$ww_şo£
()

48 
au¤c
 = 
	`mem_d”ef
(ausrc);

49 
au¶ay
 = 
	`mem_d”ef
(auplay);

52 
	}
}

55 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
wšwave
) = {

58 
ww_š™
,

59 
ww_şo£


	@baresip/modules/winwave/winwave.h

8 
	sd¥buf
 {

9 
WAVEHDR
 
	mwh
;

10 
mbuf
 *
	mmb
;

14 
wšwave_¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

15 
medŸ_ùx
 **
ùx
,

16 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

17 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
);

18 
wšwave_¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

19 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

20 
au¶ay_wr™e_h
 *
wh
, *
¬g
);

	@baresip/modules/x11/x11.c

7 #iâdeà
SOLARIS


8 
	#_XOPEN_SOURCE
 1

	)

10 
	~<X11/Xlib.h
>

11 
	~<X11/Xut.h
>

12 
	~<sys/c.h
>

13 
	~<sys/shm.h
>

14 
	~<X11/ex‹nsiÚs/XShm.h
>

15 
	~<».h
>

16 
	~<»m.h
>

17 
	~<b¬es.h
>

26 
	#DO_REDIRECT
 1

	)

36 
	svidi¥_¡
 {

37 cÚ¡ 
vidi¥
 *
	mvd
;

38 
vidsz
 
	msize
;

40 
Di¥Ïy
 *
	mdi¥
;

41 
Wšdow
 
	mwš
;

42 
GC
 
	mgc
;

43 
XImage
 *
	mimage
;

44 
XShmSegm’tInfo
 
	mshm
;

45 
boŞ
 
	mxshm©
;

46 
boŞ
 
	mš‹º®
;

47 
vidfmt
 
	mpixfmt
;

48 
Atom
 
	mXwšD–‘ed
;

49 
	mbu‰Ú_is_down
;

50 
Time
 
	mÏ¡_time
;

54 
vidi¥
 *
	gvid
;

57 
	mshm_”rÜ
;

58 (*
	m”rÜh
è(
	mDi¥Ïy
 *, 
	mXE¼ÜEv’t
 *);

59 } 
	gx11
;

63 
	$”rÜ_hªdËr
(
Di¥Ïy
 *
d
, 
XE¼ÜEv’t
 *
e
)

65 ià(
e
->
”rÜ_code
 =ğ
BadAcûss
)

66 
x11
.
shm_”rÜ
 = 1;

67 ià(
x11
.
”rÜh
)

68  
x11
.
	`”rÜh
(
d
, 
e
);

71 
	}
}

74 
	$şo£_wšdow
(
vidi¥_¡
 *
¡
)

76 ià(
¡
->
gc
 && st->
di¥
) {

77 
	`XF»eGC
(
¡
->
di¥
, st->
gc
);

78 
¡
->
gc
 = 
NULL
;

81 ià(
¡
->
xshm©
 && st->
di¥
) {

82 
	`XShmD‘ach
(
¡
->
di¥
, &¡->
shm
);

85 ià(
¡
->
shm
.
shmaddr
 != (*)-1) {

86 
	`shmdt
(
¡
->
shm
.
shmaddr
);

87 
¡
->
shm
.
shmaddr
 = (*)-1;

90 ià(
¡
->
shm
.
shmid
 >= 0)

91 
	`shmùl
(
¡
->
shm
.
shmid
, 
IPC_RMID
, 
NULL
);

93 ià(
¡
->
di¥
) {

94 ià(
¡
->
š‹º®
 && st->
wš
) {

95 
	`XDe¡royWšdow
(
¡
->
di¥
, st->
wš
);

96 
¡
->
wš
 = 0;

99 
	`XClo£Di¥Ïy
(
¡
->
di¥
);

100 
¡
->
di¥
 = 
NULL
;

102 
	}
}

105 
	$de¡ruùÜ
(*
¬g
)

107 
vidi¥_¡
 *
¡
 = 
¬g
;

109 ià(
¡
->
image
) {

110 
¡
->
image
->
d©a
 = 
NULL
;

111 
	`XDe¡royImage
(
¡
->
image
);

114 
	`şo£_wšdow
(
¡
);

115 
	}
}

118 
	$ü—‹_wšdow
(
vidi¥_¡
 *
¡
, cÚ¡ 
vidsz
 *
sz
)

120 #ifdeà
DO_REDIRECT


121 
XS‘WšdowA‰ribu‹s
 
©Œ
;

123 
¡
->
wš
 = 
	`XC»©eSim¶eWšdow
(¡->
di¥
, 
	`DeçuÉRoÙWšdow
(st->disp),

124 0, 0, 
sz
->
w
, sz->
h
, 1, 0, 0);

125 ià(!
¡
->
wš
) {

126 
	`w¬nšg
("x11: failedo create X window\n");

127  
ENOMEM
;

130 #ifdeà
DO_REDIRECT


136 
©Œ
.
ov”ride_»dœeù
 = 
Œue
;

137 
©Œ
.
ev’t_mask
 = 
Sub¡ruùu»RedœeùMask
 |

138 
Bu‰ÚP»ssMask
 | 
Bu‰ÚR–—£Mask
 |

139 
Poš‹rMÙiÚMask
 | 
Bu‰Ú1MÙiÚMask
;

141 
	`XChªgeWšdowA‰ribu‹s
(
¡
->
di¥
, st->
wš
,

142 
CWOv”rideRedœeù
 | 
CWEv’tMask
 , &
©Œ
);

144 
	`XCË¬Wšdow
(
¡
->
di¥
, st->
wš
);

145 
	`XM­Rai£d
(
¡
->
di¥
, st->
wš
);

150 
¡
->
XwšD–‘ed
 = 
	`XIÁ”nAtom
(¡->
di¥
, "WM_DELETE_WINDOW", 
True
);

151 
	`XS‘WMPrÙocŞs
(
¡
->
di¥
, st->
wš
, &¡->
XwšD–‘ed
, 1);

154 
	}
}

157 
	$x11_»£t
(
vidi¥_¡
 *
¡
, cÚ¡ 
vidsz
 *
sz
)

159 
XWšdowA‰ribu‹s
 
©Œs
;

160 
XGCV®ues
 
gcv
;

161 
size_t
 
bufsz
, 
pixsz
;

162 
”r
 = 0;

164 ià(!
	`XG‘WšdowA‰ribu‹s
(
¡
->
di¥
, st->
wš
, &
©Œs
)) {

165 
	`w¬nšg
("x11: cant't get window‡ttributes\n");

166  
EINVAL
;

169 
©Œs
.
d•th
) {

172 
¡
->
pixfmt
 = 
VID_FMT_RGB32
;

173 
pixsz
 = 4;

177 
¡
->
pixfmt
 = 
VID_FMT_RGB565
;

178 
pixsz
 = 2;

182 
¡
->
pixfmt
 = 
VID_FMT_RGB555
;

183 
pixsz
 = 2;

187 
	`w¬nšg
("x11: cŞÜd•th‚Ù suµÜ‹d: %d\n", 
©Œs
.
d•th
);

188  
ENOSYS
;

191 
bufsz
 = 
sz
->
w
 * sz->
h
 * 
pixsz
;

193 ià(
¡
->
image
) {

194 
	`XDe¡royImage
(
¡
->
image
);

195 
¡
->
image
 = 
NULL
;

198 ià(
¡
->
xshm©
)

199 
	`XShmD‘ach
(
¡
->
di¥
, &¡->
shm
);

201 ià(
¡
->
shm
.
shmaddr
 != (*)-1)

202 
	`shmdt
(
¡
->
shm
.
shmaddr
);

204 ià(
¡
->
shm
.
shmid
 >= 0)

205 
	`shmùl
(
¡
->
shm
.
shmid
, 
IPC_RMID
, 
NULL
);

207 
¡
->
shm
.
shmid
 = 
	`shmg‘
(
IPC_PRIVATE
, 
bufsz
, 
IPC_CREAT
 | 0777);

208 ià(
¡
->
shm
.
shmid
 < 0) {

209 
	`w¬nšg
("x11: failedo‡llocate shared memory\n");

210  
ENOMEM
;

213 
¡
->
shm
.
shmaddr
 = 
	`shm©
(¡->shm.
shmid
, 
NULL
, 0);

214 ià(
¡
->
shm
.
shmaddr
 == (*)-1) {

215 
	`w¬nšg
("x11: failedo‡ttacho shared memory\n");

216  
ENOMEM
;

219 
¡
->
shm
.
»adOÆy
 = 
Œue
;

221 
x11
.
shm_”rÜ
 = 0;

222 
x11
.
”rÜh
 = 
	`XS‘E¼ÜHªdËr
(
”rÜ_hªdËr
);

224 ià(!
	`XShmA‰ach
(
¡
->
di¥
, &¡->
shm
)) {

225 
	`w¬nšg
("x11: failedo‡ttach Xo shared memory\n");

226  
ENOMEM
;

229 
	`XSync
(
¡
->
di¥
, 
F®£
);

230 
	`XS‘E¼ÜHªdËr
(
x11
.
”rÜh
);

232 ià(
x11
.
shm_”rÜ
)

233 
	`šfo
("x11: shared memory disabled\n");

235 
¡
->
xshm©
 = 
Œue
;

237 
gcv
.
g¿phics_exposu»s
 = 
çl£
;

239 
¡
->
gc
 = 
	`XC»©eGC
(¡->
di¥
, st->
wš
, 
GCG¿phicsExposu»s
, &
gcv
);

240 ià(!
¡
->
gc
) {

241 
	`w¬nšg
("x11: failedo create graphics context\n");

242  
ENOMEM
;

245 ià(
¡
->
xshm©
) {

246 
¡
->
image
 = 
	`XShmC»©eImage
(¡->
di¥
, 
©Œs
.
visu®
,

247 
©Œs
.
d•th
, 
ZPixm­
,

248 
¡
->
shm
.
shmaddr
, &st->shm,

249 
sz
->
w
, sz->
h
);

252 
¡
->
image
 = 
	`XC»©eImage
(¡->
di¥
, 
©Œs
.
visu®
,

253 
©Œs
.
d•th
, 
ZPixm­
, 0,

254 
¡
->
shm
.
shmaddr
,

255 
sz
->
w
, sz->
h
, 32, 0);

258 ià(!
¡
->
image
) {

259 
	`w¬nšg
("x11: Failedo create X image\n");

260  
ENOMEM
;

263 
	`XResizeWšdow
(
¡
->
di¥
, st->
wš
, 
sz
->
w
, sz->
h
);

265 
¡
->
size
 = *
sz
;

267  
”r
;

268 
	}
}

272 
	$®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

273 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

274 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

276 
vidi¥_¡
 *
¡
;

277 
”r
 = 0;

278 ()
dev
;

279 ()
»sizeh
;

280 ()
¬g
;

282 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

283 ià(!
¡
)

284  
ENOMEM
;

286 
¡
->
vd
 = vd;

287 
¡
->
shm
.
shmaddr
 = (*)-1;

289 
¡
->
di¥
 = 
	`XO³nDi¥Ïy
(
NULL
);

290 ià(!
¡
->
di¥
) {

291 
	`w¬nšg
("x11: could‚ot open X display\n");

292 
”r
 = 
ENODEV
;

293 
out
;

297 ià(
´m
 &&…rm->
v›w
)

298 
¡
->
wš
 = (
Wšdow
)
´m
->
v›w
;

300 
¡
->
š‹º®
 = 
Œue
;

302 
out
:

303 ià(
”r
)

304 
	`mem_d”ef
(
¡
);

306 *
¡p
 = 
¡
;

308  
”r
;

309 
	}
}

312 
	$di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

313 cÚ¡ 
vidäame
 *
äame
)

315 
vidäame
 
äame_rgb
;

316 
”r
 = 0;

318 ià(!
¡
->
di¥
)

319  
ENODEV
;

326 
	`XP’dšg
(
¡
->
di¥
)) {

328 
XEv’t
 
e
;

330 
	`XNextEv’t
(
¡
->
di¥
, &
e
);

332 
e
.
ty³
) {

334 
Cl›ÁMes§ge
:

335 ià((
Atom
è
e
.
xş›Á
.
d©a
.
l
[0] =ğ
¡
->
XwšD–‘ed
) {

337 
	`šfo
("x11: window deleted\n");

343 
	`şo£_wšdow
(
¡
);

344  
ENODEV
;

348 
Bu‰ÚP»ss
:

349 
¡
->
bu‰Ú_is_down
 = 1;

352 
Bu‰ÚR–—£
:

353 
¡
->
bu‰Ú_is_down
 = 0;

356 
MÙiÚNÙify
:

357 ià(
¡
->
bu‰Ú_is_down
 == 0)

359 ià((
e
.
xmÙiÚ
.
time
 - 
¡
->
Ï¡_time
) < 32)

362 
	`XMoveWšdow
(
¡
->
di¥
, st->
wš
,

363 
e
.
xmÙiÚ
.
x_roÙ
 - 16,

364 
e
.
xmÙiÚ
.
y_roÙ
 - 16);

365 
¡
->
Ï¡_time
 = 
e
.
xmÙiÚ
.
time
;

373 ià(!
	`vidsz_cmp
(&
¡
->
size
, &
äame
->size)) {

374 
ÿ±
[256];

376 ià(
¡
->
size
.
w
 && st->size.
h
) {

377 
	`šfo
("x11:„eset: %u x %u ---> %u x %u\n",

378 
¡
->
size
.
w
, st->size.
h
,

379 
äame
->
size
.
w
, f¿me->size.
h
);

382 ià(
¡
->
š‹º®
 && !¡->
wš
)

383 
”r
 = 
	`ü—‹_wšdow
(
¡
, &
äame
->
size
);

385 
”r
 |ğ
	`x11_»£t
(
¡
, &
äame
->
size
);

386 ià(
”r
)

387  
”r
;

389 ià(
t™Ë
) {

390 
	`»_¢´štf
(
ÿ±
, (capt), "%s - %u x %u",

391 
t™Ë
, 
äame
->
size
.
w
, f¿me->size.
h
);

394 
	`»_¢´štf
(
ÿ±
, (capt), "%u x %u",

395 
äame
->
size
.
w
, f¿me->size.
h
);

398 
	`XStÜeName
(
¡
->
di¥
, st->
wš
, 
ÿ±
);

403 
	`vidäame_š™_buf
(&
äame_rgb
, 
¡
->
pixfmt
, &
äame
->
size
,

404 (
ušt8_t
 *)
¡
->
shm
.
shmaddr
);

406 
	`vidcÚv
(&
äame_rgb
, 
äame
, 0);

409 ià(
¡
->
xshm©
)

410 
	`XShmPutImage
(
¡
->
di¥
, st->
wš
, st->
gc
, st->
image
,

411 0, 0, 0, 0, 
¡
->
size
.
w
, st->size.
h
, 
çl£
);

413 
	`XPutImage
(
¡
->
di¥
, st->
wš
, st->
gc
, st->
image
,

414 0, 0, 0, 0, 
¡
->
size
.
w
, st->size.
h
);

416 
	`XSync
(
¡
->
di¥
, 
çl£
);

418  
”r
;

419 
	}
}

422 
	$hide
(
vidi¥_¡
 *
¡
)

424 ià(!
¡
)

427 ià(
¡
->
wš
)

428 
	`XLow”Wšdow
(
¡
->
di¥
, st->
wš
);

429 
	}
}

432 
	$moduË_š™
()

434  
	`vidi¥_»gi¡”
(&
vid
, 
	`b¬es_vidi¥l
(),

435 "x11", 
®loc
, 
NULL
, 
di¥Ïy
, 
hide
);

436 
	}
}

439 
	$moduË_şo£
()

441 
vid
 = 
	`mem_d”ef
(vid);

444 
	}
}

447 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
x11
) = {

450 
moduË_š™
,

451 
moduË_şo£
,

	@baresip/modules/x11grab/x11grab.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<uni¡d.h
>

9 #iâdeà
SOLARIS


10 
	#_XOPEN_SOURCE
 1

	)

12 
	~<X11/Xlib.h
>

13 
	~<X11/Xut.h
>

14 
	~<±h»ad.h
>

15 
	~<».h
>

16 
	~<»m.h
>

17 
	~<b¬es.h
>

30 
	svid¤c_¡
 {

31 cÚ¡ 
vid¤c
 *
	mvs
;

32 
Di¥Ïy
 *
	mdi¥
;

33 
XImage
 *
	mimage
;

34 
±h»ad_t
 
	mth»ad
;

35 
boŞ
 
	mrun
;

36 
	mås
;

37 
vidsz
 
	msize
;

38 
vidfmt
 
	mpixfmt
;

39 
vid¤c_äame_h
 *
	mäameh
;

40 *
	m¬g
;

44 
vid¤c
 *
	gvid¤c
;

47 
	$x11g¿b_İ’
(
vid¤c_¡
 *
¡
, cÚ¡ 
vidsz
 *
sz
)

49 
x
 = 0, 
y
 = 0;

51 
¡
->
di¥
 = 
	`XO³nDi¥Ïy
(
NULL
);

52 ià(!
¡
->
di¥
) {

53 
	`w¬nšg
("x11grab:ƒrror opening display\n");

54  
ENODEV
;

57 
¡
->
image
 = 
	`XG‘Image
(¡->
di¥
,

58 
	`RoÙWšdow
(
¡
->
di¥
, 
	`DeçuÉSü“n
(st->disp)),

59 
x
, 
y
, 
sz
->
w
, sz->
h
, 
AÎPÏÃs
, 
ZPixm­
);

60 ià(!
¡
->
image
) {

61 
	`w¬nšg
("x11grab:ƒrror creating Ximage\n");

62  
ENODEV
;

65 
¡
->
image
->
b™s_³r_pix–
) {

68 
¡
->
pixfmt
 = 
VID_FMT_RGB32
;

72 
¡
->
pixfmt
 = (¡->
image
->
g»’_mask
 == 0x7e0)

73 ? 
VID_FMT_RGB565


74 : 
VID_FMT_RGB555
;

78 
	`w¬nšg
("x11grab:‚ot supported: bpp=%d\n",

79 
¡
->
image
->
b™s_³r_pix–
);

80  
ENOSYS
;

84 
	}
}

87 
šlše
 
ušt8_t
 *
	$x11g¿b_»ad
(
vid¤c_¡
 *
¡
)

89 cÚ¡ 
x
 = 0, 
y
 = 0;

90 
XImage
 *
im
;

92 
im
 = 
	`XG‘SubImage
(
¡
->
di¥
,

93 
	`RoÙWšdow
(
¡
->
di¥
, 
	`DeçuÉSü“n
(st->disp)),

94 
x
, 
y
, 
¡
->
size
.
w
, st->size.
h
, 
AÎPÏÃs
, 
ZPixm­
,

95 
¡
->
image
, 0, 0);

96 ià(!
im
)

97  
NULL
;

99  (
ušt8_t
 *)
¡
->
image
->
d©a
;

100 
	}
}

103 
	$ÿÎ_äame_hªdËr
(
vid¤c_¡
 *
¡
, 
ušt8_t
 *
buf
)

105 
vidäame
 
äame
;

107 
	`vidäame_š™_buf
(&
äame
, 
¡
->
pixfmt
, &¡->
size
, 
buf
);

109 
¡
->
	`äameh
(&
äame
, st->
¬g
);

110 
	}
}

113 *
	$»ad_th»ad
(*
¬g
)

115 
vid¤c_¡
 *
¡
 = 
¬g
;

116 
ušt64_t
 
ts
 = 
	`tmr_jiff›s
();

117 
ušt8_t
 *
buf
;

119 
¡
->
run
) {

121 ià(
	`tmr_jiff›s
(è< 
ts
) {

122 
	`sys_m¦“p
(4);

126 
buf
 = 
	`x11g¿b_»ad
(
¡
);

127 ià(!
buf
)

130 
ts
 +ğ(1000/
¡
->
ås
);

132 
	`ÿÎ_äame_hªdËr
(
¡
, 
buf
);

135  
NULL
;

136 
	}
}

139 
	$de¡ruùÜ
(*
¬g
)

141 
vid¤c_¡
 *
¡
 = 
¬g
;

143 ià(
¡
->
run
) {

144 
¡
->
run
 = 
çl£
;

145 
	`±h»ad_još
(
¡
->
th»ad
, 
NULL
);

148 ià(
¡
->
image
)

149 
	`XDe¡royImage
(
¡
->
image
);

151 ià(
¡
->
di¥
)

152 
	`XClo£Di¥Ïy
(
¡
->
di¥
);

153 
	}
}

156 
	$®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

157 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

158 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

159 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

160 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

162 
vid¤c_¡
 *
¡
;

163 
”r
;

165 ()
ùx
;

166 ()
fmt
;

167 ()
dev
;

168 ()
”rÜh
;

170 ià(!
¡p
 || !
´m
 || !
size
 || !
äameh
)

171  
EINVAL
;

173 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

174 ià(!
¡
)

175  
ENOMEM
;

177 
¡
->
vs
 = vs;

178 
¡
->
size
 = *size;

179 
¡
->
ås
 = 
´m
->fps;

180 
¡
->
äameh
 = frameh;

181 
¡
->
¬g
 =‡rg;

183 
”r
 = 
	`x11g¿b_İ’
(
¡
, 
size
);

184 ià(
”r
)

185 
out
;

187 
¡
->
run
 = 
Œue
;

188 
”r
 = 
	`±h»ad_ü—‹
(&
¡
->
th»ad
, 
NULL
, 
»ad_th»ad
, st);

189 ià(
”r
) {

190 
¡
->
run
 = 
çl£
;

191 
out
;

194 
out
:

195 ià(
”r
)

196 
	`mem_d”ef
(
¡
);

198 *
¡p
 = 
¡
;

200  
”r
;

201 
	}
}

204 
	$x11g¿b_š™
()

206  
	`vid¤c_»gi¡”
(&
vid¤c
, 
	`b¬es_vid¤ş
(),

207 "x11g¿b", 
®loc
, 
NULL
);

208 
	}
}

211 
	$x11g¿b_şo£
()

213 
vid¤c
 = 
	`mem_d”ef
(vidsrc);

215 
	}
}

218 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
x11g¿b
) = {

221 
x11g¿b_š™
,

222 
x11g¿b_şo£


	@baresip/modules/zrtp/zrtp.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~<z¹p.h
>

10 
	~<¡ršg.h
>

40 
	mPRESZ
 = 36

43 
	sm’c_£ss
 {

44 
z¹p_£ssiÚ_t
 *
	mz¹p_£ssiÚ
;

45 
m’c_”rÜ_h
 *
	m”rÜh
;

46 *
	m¬g
;

47 
tmr
 
	mabÜt_tim”
;

48 
	m”r
;

51 
	sm’c_medŸ
 {

52 
m’c_£ss
 *
	m£ss
;

53 
udp_h–³r
 *
	muh_¹p
;

54 
udp_h–³r
 *
	muh_¹ı
;

55 
§
 
	m¿ddr
;

56 *
	m¹psock
;

57 *
	m¹ısock
;

58 
z¹p_¡»am_t
 *
	mz¹p_¡»am
;

62 
z¹p_glob®_t
 *
	gz¹p_glob®
;

63 
z¹p_cÚfig_t
 
	gz¹p_cÚfig
;

64 
z¹p_zid_t
 
	gzid
;

68 
boŞ
 
	gu£_sig_hash
 = 
Œue
;

71 
	epkt_ty³
 {

72 
	mPKT_TYPE_UNKNOWN
 = 0,

73 
	mPKT_TYPE_RTP
 = 1,

74 
	mPKT_TYPE_RTCP
 = 2,

75 
	mPKT_TYPE_ZRTP
 = 4

79 
pkt_ty³
 
	$g‘_·ck‘_ty³
(cÚ¡ 
mbuf
 *
mb
)

81 
ušt8_t
 
b
, 
±
;

82 
ušt32_t
 
magic
;

84 ià(
	`mbuf_g‘_Ëá
(
mb
) < 8)

85  
PKT_TYPE_UNKNOWN
;

87 
b
 = 
	`mbuf_buf
(
mb
)[0];

89 ià(127 < 
b
 && b < 192) {

90 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

91 ià(72 <ğ
±
 &&…t <= 76)

92  
PKT_TYPE_RTCP
;

94  
PKT_TYPE_RTP
;

97 
	`memıy
(&
magic
, &
	`mbuf_buf
(
mb
)[4], 4);

98 
magic
 = 
	`Áohl
(magic);

99 ià(
magic
 =ğ
ZRTP_PACKETS_MAGIC
)

100  
PKT_TYPE_ZRTP
;

103  
PKT_TYPE_UNKNOWN
;

104 
	}
}

107 
	$£ssiÚ_de¡ruùÜ
(*
¬g
)

109 
m’c_£ss
 *
¡
 = 
¬g
;

111 
	`tmr_ÿnûl
(&
¡
->
abÜt_tim”
);

113 ià(
¡
->
z¹p_£ssiÚ
)

114 
	`z¹p_£ssiÚ_down
(
¡
->
z¹p_£ssiÚ
);

115 
	}
}

118 
	$medŸ_de¡ruùÜ
(*
¬g
)

120 
m’c_medŸ
 *
¡
 = 
¬g
;

122 
	`mem_d”ef
(
¡
->
uh_¹p
);

123 
	`mem_d”ef
(
¡
->
uh_¹ı
);

124 
	`mem_d”ef
(
¡
->
¹psock
);

125 
	`mem_d”ef
(
¡
->
¹ısock
);

127 ià(
¡
->
z¹p_¡»am
)

128 
	`z¹p_¡»am_¡İ
(
¡
->
z¹p_¡»am
);

129 
	}
}

132 
	$abÜt_tim”_h
(*
¬g
)

134 
m’c_£ss
 *
£ss
 = 
¬g
;

136 ià(
£ss
->
”rÜh
) {

137 
£ss
->
	`”rÜh
(£ss->
”r
, sess->
¬g
);

138 
£ss
->
”rÜh
 = 
NULL
;

140 
	}
}

143 
	$abÜt_ÿÎ
(
m’c_£ss
 *
£ss
)

145 ià(!
£ss
->
”r
) {

146 
£ss
->
”r
 = 
EPIPE
;

147 
	`tmr_¡¬t
(&
£ss
->
abÜt_tim”
, 0, 
abÜt_tim”_h
, sess);

149 
	}
}

152 
boŞ
 
	$drİ_·ck‘s
(cÚ¡ 
m’c_medŸ
 *
¡
)

154  (
¡
)? st->
£ss
->
”r
 !ğ0 : 
Œue
;

155 
	}
}

158 
boŞ
 
	$udp_h–³r_£nd
(*
”r
, 
§
 *
d¡
,

159 
mbuf
 *
mb
, *
¬g
)

161 
m’c_medŸ
 *
¡
 = 
¬g
;

162 
Ëngth
;

163 
z¹p_¡©us_t
 
s
;

164 cÚ¡ *
´Ùo_Çme
 = "rtp";

165 
pkt_ty³
 
±y³
 = 
	`g‘_·ck‘_ty³
(
mb
);

167 ià(
	`drİ_·ck‘s
(
¡
))

168  
Œue
;

170 
Ëngth
 = ()
	`mbuf_g‘_Ëá
(
mb
);

173 ià(
±y³
 =ğ
PKT_TYPE_RTCP
) {

174 
´Ùo_Çme
 = "rtcp";

175 
s
 = 
	`z¹p_´oûss_¹ı
(
¡
->
z¹p_¡»am
,

176 (*)
	`mbuf_buf
(
mb
), &
Ëngth
);

178 ià(
±y³
 =ğ
PKT_TYPE_RTP
) {

179 
s
 = 
	`z¹p_´oûss_¹p
(
¡
->
z¹p_¡»am
,

180 (*)
	`mbuf_buf
(
mb
), &
Ëngth
);

183  
çl£
;

185 ià(
s
 !ğ
z¹p_¡©us_ok
) {

187 ià(
s
 =ğ
z¹p_¡©us_drİ
)

188  
Œue
;

190 
	`w¬nšg
("zrtp: send(port=%d): zrtp_process_%s failed"

192 
	`§_pÜt
(
d¡
), 
´Ùo_Çme
, 
s
, 
	`z¹p_log_¡©us2¡r
(s));

193  
çl£
;

197 ià(
Ëngth
 > 
	`mbuf_g‘_¥aû
(
mb
)) {

198 
	`w¬nšg
("zrtp: zrtp_process_%s:†ength > space (%u > %u)\n",

199 
´Ùo_Çme
, 
Ëngth
, 
	`mbuf_g‘_¥aû
(
mb
));

200 *
”r
 = 
ENOMEM
;

203 
mb
->
’d
 = mb->
pos
 + 
Ëngth
;

205  
çl£
;

206 
	}
}

209 
boŞ
 
	$udp_h–³r_»cv
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

211 
m’c_medŸ
 *
¡
 = 
¬g
;

212 
Ëngth
;

213 
z¹p_¡©us_t
 
s
;

214 cÚ¡ *
´Ùo_Çme
 = "srtp";

215 
pkt_ty³
 
±y³
 = 
	`g‘_·ck‘_ty³
(
mb
);

217 ià(
	`drİ_·ck‘s
(
¡
))

218  
Œue
;

220 
Ëngth
 = ()
	`mbuf_g‘_Ëá
(
mb
);

222 ià(
±y³
 =ğ
PKT_TYPE_RTCP
) {

223 
´Ùo_Çme
 = "srtcp";

224 
s
 = 
	`z¹p_´oûss_¤tı
(
¡
->
z¹p_¡»am
,

225 (*)
	`mbuf_buf
(
mb
), &
Ëngth
);

227 ià(
±y³
 =ğ
PKT_TYPE_RTP
 ||…ty³ =ğ
PKT_TYPE_ZRTP
) {

228 
s
 = 
	`z¹p_´oûss_¤
(
¡
->
z¹p_¡»am
,

229 (*)
	`mbuf_buf
(
mb
), &
Ëngth
);

232  
çl£
;

234 ià(
s
 !ğ
z¹p_¡©us_ok
) {

236 ià(
s
 =ğ
z¹p_¡©us_drİ
)

237  
Œue
;

239 
	`w¬nšg
("zrtp:„ecv(port=%d): zrtp_process_%s: %d '%s'\n",

240 
	`§_pÜt
(
¤c
), 
´Ùo_Çme
, 
s
, 
	`z¹p_log_¡©us2¡r
(s));

241  
çl£
;

244 
mb
->
’d
 = mb->
pos
 + 
Ëngth
;

246  
çl£
;

247 
	}
}

250 
	$sig_hash_’code
(
z¹p_¡»am_t
 *
¡»am
,

251 
sdp_medŸ
 *
m
)

253 
buf
[
ZRTP_SIGN_ZRTP_HASH_LENGTH
 + 1];

254 
z¹p_¡©us_t
 
s
;

255 
”r
 = 0;

257 
s
 = 
	`z¹p_sigÇlšg_hash_g‘
(
¡»am
, 
buf
, (buf));

258 ià(
s
 !ğ
z¹p_¡©us_ok
) {

259 
	`w¬nšg
("z¹p: z¹p_sigÇlšg_hash_g‘: stu ğ%d\n", 
s
);

260  
EINVAL
;

263 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
m
, 
Œue
, "zrtp-hash", "%s %s",

264 
ZRTP_PROTOCOL_VERSION
, 
buf
);

265 ià(
”r
) {

266 
	`w¬nšg
("z¹p: sdp_medŸ_£t_Ï‰r: %d\n", 
”r
);

269  
”r
;

270 
	}
}

273 
	$sig_hash_decode
(
z¹p_¡»am_t
 *
¡»am
,

274 cÚ¡ 
sdp_medŸ
 *
m
)

276 cÚ¡ *
©Œ_v®
;

277 
¶
 
majÜ
, 
mšÜ
, 
hash
;

278 
ušt32_t
 
v”siÚ
;

279 
”r
;

280 
z¹p_¡©us_t
 
s
;

282 
©Œ_v®
 = 
	`sdp_medŸ_¿‰r
(
m
, "zrtp-hash");

283 ià(!
©Œ_v®
)

286 
”r
 = 
	`»_»gex
(
©Œ_v®
, 
	`¡¾’
(attr_val),

288 &
majÜ
, &
mšÜ
, &
hash
);

289 ià(
”r
 || 
hash
.
l
 < 
ZRTP_SIGN_ZRTP_HASH_LENGTH
) {

290 
	`w¬nšg
("zrtp: malformed zrtp-hash‡ttribute, ignoring...\n");

294 
v”siÚ
 = 
	`¶_u32
(&
majÜ
è* 100 +…l_u32(&
mšÜ
);

296 ià(
v”siÚ
 < 110) {

297 
	`w¬nšg
("zrtp: zrtp-hash: version (%d) isoo†ow, "

298 "ignÜšg...", 
v”siÚ
);

301 
s
 = 
	`z¹p_sigÇlšg_hash_£t
(
¡»am
, 
hash
.
p
, (
ušt32_t
)hash.
l
);

302 ià(
s
 !ğ
z¹p_¡©us_ok
)

303 
	`w¬nšg
("z¹p: z¹p_sigÇlšg_hash_£t: stu ğ%d\n", 
s
);

304 
	}
}

307 
	$£ssiÚ_®loc
(
m’c_£ss
 **
£s¥
, 
sdp_£ssiÚ
 *
sdp
,

308 
boŞ
 
ofã»r
, 
m’c_”rÜ_h
 *
”rÜh
, *
¬g
)

310 
m’c_£ss
 *
¡
;

311 
z¹p_¡©us_t
 
s
;

312 
”r
 = 0;

313 ()
ofã»r
;

315 ià(!
£s¥
 || !
sdp
)

316  
EINVAL
;

318 
¡
 = 
	`mem_z®loc
((*¡), 
£ssiÚ_de¡ruùÜ
);

319 ià(!
¡
)

320  
ENOMEM
;

322 
¡
->
”rÜh
 =ƒrrorh;

323 
¡
->
¬g
 =‡rg;

324 
¡
->
”r
 = 0;

325 
	`tmr_š™
(&
¡
->
abÜt_tim”
);

327 
s
 = 
	`z¹p_£ssiÚ_š™
(
z¹p_glob®
, 
NULL
, 
zid
,

328 
ZRTP_SIGNALING_ROLE_UNKNOWN
, &
¡
->
z¹p_£ssiÚ
);

329 ià(
s
 !ğ
z¹p_¡©us_ok
) {

330 
	`w¬nšg
("z¹p: z¹p_£ssiÚ_š™ faed (¡©u ğ%d)\n", 
s
);

331 
”r
 = 
EPROTO
;

332 
out
;

335 
out
:

336 ià(
”r
)

337 
	`mem_d”ef
(
¡
);

339 *
£s¥
 = 
¡
;

341  
”r
;

342 
	}
}

345 
	$medŸ_®loc
(
m’c_medŸ
 **
¡p
, 
m’c_£ss
 *
£ss
,

346 
¹p_sock
 *
¹p
,

347 
´Ùo
, *
¹psock
, *
¹ısock
,

348 
sdp_medŸ
 *
sdpm
)

350 
m’c_medŸ
 *
¡
;

351 
z¹p_¡©us_t
 
s
;

352 
Ïy”
 = 10;

353 
”r
 = 0;

355 ià(!
¡p
 || !
£ss
 || 
´Ùo
 !ğ
IPPROTO_UDP
)

356  
EINVAL
;

358 
¡
 = *
¡p
;

359 ià(
¡
)

360 
¡¬t
;

362 
¡
 = 
	`mem_z®loc
((*¡), 
medŸ_de¡ruùÜ
);

363 ià(!
¡
)

364  
ENOMEM
;

366 
¡
->
£ss
 = sess;

367 ià(
¹psock
) {

368 
¡
->
¹psock
 = 
	`mem_»f
(rtpsock);

369 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹p
, 
¹psock
, 
Ïy”
,

370 
udp_h–³r_£nd
, 
udp_h–³r_»cv
, 
¡
);

372 ià(
¹ısock
 && (¹ısock !ğ
¹psock
)) {

373 
¡
->
¹ısock
 = 
	`mem_»f
(rtcpsock);

374 
”r
 |ğ
	`udp_»gi¡”_h–³r
(&
¡
->
uh_¹ı
, 
¹ısock
, 
Ïy”
,

375 
udp_h–³r_£nd
, 
udp_h–³r_»cv
, 
¡
);

377 ià(
”r
)

378 
out
;

380 
s
 = 
	`z¹p_¡»am_©ch
(
£ss
->
z¹p_£ssiÚ
, &
¡
->
z¹p_¡»am
);

381 ià(
s
 !ğ
z¹p_¡©us_ok
) {

382 
	`w¬nšg
("z¹p: z¹p_¡»am_©ch faed (¡©us=%d)\n", 
s
);

383 
”r
 = 
EPROTO
;

384 
out
;

387 
	`z¹p_¡»am_£t_u£rd©a
(
¡
->
z¹p_¡»am
, st);

389 ià(
u£_sig_hash
) {

390 
”r
 = 
	`sig_hash_’code
(
¡
->
z¹p_¡»am
, 
sdpm
);

391 ià(
”r
)

392 
out
;

395 
out
:

396 ià(
”r
) {

397 
	`mem_d”ef
(
¡
);

398  
”r
;

401 *
¡p
 = 
¡
;

403 
¡¬t
:

404 ià(
	`§_is£t
(
	`sdp_medŸ_¿ddr
(
sdpm
), 
SA_ALL
)) {

405 
¡
->
¿ddr
 = *
	`sdp_medŸ_¿ddr
(
sdpm
);

407 ià(
u£_sig_hash
)

408 
	`sig_hash_decode
(
¡
->
z¹p_¡»am
, 
sdpm
);

410 
s
 = 
	`z¹p_¡»am_¡¬t
(
¡
->
z¹p_¡»am
, 
	`¹p_£ss_s¤c
(
¹p
));

411 ià(
s
 !ğ
z¹p_¡©us_ok
) {

412 
	`w¬nšg
("z¹p: z¹p_¡»am_¡¬t: stu ğ%d\n", 
s
);

416  
”r
;

417 
	}
}

420 
	$Ú_£nd_·ck‘
(cÚ¡ 
z¹p_¡»am_t
 *
¡»am
,

421 *
¹p_·ck‘
,

422 
¹p_·ck‘_Ëngth
)

424 
m’c_medŸ
 *
¡
 = 
	`z¹p_¡»am_g‘_u£rd©a
(
¡»am
);

425 
mbuf
 *
mb
;

426 
”r
;

428 ià(
	`drİ_·ck‘s
(
¡
))

429  
z¹p_¡©us_ok
;

431 ià(!
	`§_is£t
(&
¡
->
¿ddr
, 
SA_ALL
))

432  
z¹p_¡©us_ok
;

434 
mb
 = 
	`mbuf_®loc
(
PRESZ
 + 
¹p_·ck‘_Ëngth
);

435 ià(!
mb
)

436  
z¹p_¡©us_®loc_ç
;

438 
mb
->
pos
 = 
PRESZ
;

439 ()
	`mbuf_wr™e_mem
(
mb
, (*)
¹p_·ck‘
, 
¹p_·ck‘_Ëngth
);

440 
mb
->
pos
 = 
PRESZ
;

442 
”r
 = 
	`udp_£nd_h–³r
(
¡
->
¹psock
, &¡->
¿ddr
, 
mb
, st->
uh_¹p
);

443 ià(
”r
) {

444 
	`w¬nšg
("zrtp: udp_send %u bytes (%m)\n",

445 
¹p_·ck‘_Ëngth
, 
”r
);

448 
	`mem_d”ef
(
mb
);

450  
z¹p_¡©us_ok
;

451 
	}
}

454 
	$Ú_z¹p_£cu»
(
z¹p_¡»am_t
 *
¡»am
)

456 cÚ¡ 
m’c_medŸ
 *
¡
 = 
	`z¹p_¡»am_g‘_u£rd©a
(
¡»am
);

457 cÚ¡ 
m’c_£ss
 *
£ss
 = 
¡
->sess;

458 
z¹p_£ssiÚ_šfo_t
 
£ss_šfo
;

460 
	`z¹p_£ssiÚ_g‘
(
£ss
->
z¹p_£ssiÚ
, &
£ss_šfo
);

461 ià(!
£ss_šfo
.
§s_is_v”if›d
 && sess_šfo.
§s_is_»ady
) {

462 
	`šfo
("zrtp: verify SAS <%s> <%s> for„emote…eer %w"

464 
£ss_šfo
.
§s1
.
bufãr
,

465 
£ss_šfo
.
§s2
.
bufãr
,

466 
£ss_šfo
.
³”_zid
.
bufãr
,

467 (
size_t
)
£ss_šfo
.
³”_zid
.
Ëngth
,

468 
£ss_šfo
.
³”_zid
.
bufãr
,

469 (
size_t
)
£ss_šfo
.
³”_zid
.
Ëngth
);

471 ià(
£ss_šfo
.
§s_is_v”if›d
) {

472 
	`šfo
("zrtp: secure session with verified„emote…eer %w\n",

473 
£ss_šfo
.
³”_zid
.
bufãr
,

474 (
size_t
)
£ss_šfo
.
³”_zid
.
Ëngth
);

476 
	}
}

479 
	$Ú_z¹p_£cur™y_ev’t
(
z¹p_¡»am_t
 *
¡»am
,

480 
z¹p_£cur™y_ev’t_t
 
ev’t
)

482 ià(
ev’t
 =ğ
ZRTP_EVENT_WRONG_SIGNALING_HASH
) {

483 cÚ¡ 
m’c_medŸ
 *
¡
 = 
	`z¹p_¡»am_g‘_u£rd©a
(
¡»am
);

485 
	`w¬nšg
("zrtp: Attack detected!!! Signaling hash fromhe "

491 
	`abÜt_ÿÎ
(
¡
->
£ss
);

493 
	}
}

496 
m’c
 
	gm’c_z¹p
 = {

497 
LE_INIT
, "z¹p", "RTP/AVP", 
£ssiÚ_®loc
, 
medŸ_®loc


501 
	$v”ify_§s
(
»_´štf
 *
pf
, *
¬g
)

503 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

504 ()
pf
;

506 ià(
	`¡r_is£t
(
ÿrg
->
´m
)) {

507 
rzid
[
ZRTP_STRING16
] = "";

508 
z¹p_¡©us_t
 
s
;

509 
z¹p_¡ršg16_t
 
loÿl_zid
 = 
	`ZSTR_INIT_EMPTY
(local_zid);

510 
z¹p_¡ršg16_t
 
»mÙe_zid
 = 
	`ZSTR_INIT_EMPTY
(remote_zid);

512 
	`z¹p_z¡ºıyc
(
	`ZSTR_GV
(
loÿl_zid
), (cÚ¡ *)
zid
,

513 (
z¹p_zid_t
));

515 ià(
	`¡r_Ën
(
ÿrg
->
´m
) != 24) {

516 
	`w¬nšg
("z¹p: inv®id„emÙZID (%s)\n", 
ÿrg
->
´m
);

517  
EINVAL
;

520 (è
	`¡r2hex
(
ÿrg
->
´m
, (è
	`¡r_Ën
(carg->prm),

521 
rzid
, (rzid));

522 
	`z¹p_z¡ºıyc
(
	`ZSTR_GV
(
»mÙe_zid
), (cÚ¡ *)
rzid
,

523 (
z¹p_zid_t
));

525 
s
 = 
	`z¹p_v”if›d_£t
(
z¹p_glob®
, &
loÿl_zid
, &
»mÙe_zid
,

526 
Œue
);

527 ià(
s
 =ğ
z¹p_¡©us_ok
)

528 
	`šfo
("z¹p: SAS fÜ…“¸% v”if›d\n", 
ÿrg
->
´m
);

530 
	`w¬nšg
("zrtp: zrtp_verified_set"

531 " faed (¡©u ğ%d)\n", 
s
);

532  
EINVAL
;

537 
	}
}

540 
	$z¹p_log
(
Ëv–
, *
d©a
, 
Ën
, 
off£t
)

542 ()
off£t
;

544 ià(
Ëv–
 == 1) {

545 
	`w¬nšg
("%b\n", 
d©a
, 
Ën
);

547 ià(
Ëv–
 == 2) {

548 
	`šfo
("%b\n", 
d©a
, 
Ën
);

551 
	`debug
("%b\n", 
d©a
, 
Ën
);

553 
	}
}

556 cÚ¡ 
cmd
 
	gcmdv
[] = {

557 {"z¹p", 0, 
CMD_PRM
, "V”ify ZRTP SAS <»mÙZID>", 
v”ify_§s
 },

561 
	$moduË_š™
()

563 
z¹p_¡©us_t
 
s
;

564 
cÚfig_·th
[256] = "";

565 
z¹p_zid_·th
[256] = "";

566 
FILE
 *
f
;

567 
»t
, 
”r
;

569 ()
	`cÚf_g‘_boŞ
(
	`cÚf_cur
(), "z¹p_hash", &
u£_sig_hash
);

571 
	`z¹p_log_£t_log_’gše
(
z¹p_log
);

573 
	`z¹p_cÚfig_deçuÉs
(&
z¹p_cÚfig
);

575 
	`¡r_nıy
(
z¹p_cÚfig
.
ş›Á_id
, "baresip/zrtp",

576 (
z¹p_cÚfig
.
ş›Á_id
));

578 
z¹p_cÚfig
.
lic_mode
 = 
ZRTP_LICENSE_MODE_UNLIMITED
;

580 
z¹p_cÚfig
.
cb
.
misc_cb
.
Ú_£nd_·ck‘
 = on_send_packet;

581 
z¹p_cÚfig
.
cb
.
ev’t_cb
.
Ú_z¹p_£cu»
 = on_zrtp_secure;

582 
z¹p_cÚfig
.
cb
.
ev’t_cb
.
Ú_z¹p_£cur™y_ev’t
 =

583 
Ú_z¹p_£cur™y_ev’t
;

585 
”r
 = 
	`cÚf_·th_g‘
(
cÚfig_·th
, (config_path));

586 ià(
”r
) {

587 
	`w¬nšg
("z¹p: could‚Ù g‘ cÚfig…©h: %m\n", 
”r
);

588  
”r
;

590 
»t
 = 
	`»_¢´štf
(
z¹p_cÚfig
.
def_ÿche_·th
.
bufãr
,

591 
z¹p_cÚfig
.
def_ÿche_·th
.
max_Ëngth
,

592 "%s/z¹p_ÿche.d©", 
cÚfig_·th
);

593 ià(
»t
 < 0) {

594 
	`w¬nšg
("zrtp: could‚ot write cache…ath\n");

595  
ENOMEM
;

597 
z¹p_cÚfig
.
def_ÿche_·th
.
Ëngth
 = 
»t
;

599 ià(
	`»_¢´štf
(
z¹p_zid_·th
,

600 (
z¹p_zid_·th
),

601 "%s/z¹p_zid", 
cÚfig_·th
) < 0)

602  
ENOMEM
;

603 ià((
f
 = 
	`fİ’
(
z¹p_zid_·th
, "rb")è!ğ
NULL
) {

604 ià(
	`ä—d
(
zid
, (zid), 1, 
f
) != 1) {

605 ià(
	`ãof
(
f
è|| 
	`ã¼Ü
(f)) {

606 
	`w¬nšg
("zrtp: invalid zrtp_zid file\n");

610 ià((
f
 = 
	`fİ’
(
z¹p_zid_·th
, "wb")è!ğ
NULL
) {

611 
	`¿nd_by‹s
(
zid
, (zid));

612 ià(
	`fwr™e
(
zid
, (zid), 1, 
f
) != 1) {

613 
	`w¬nšg
("zrtp: zrtp_zid file write failed\n");

615 
	`šfo
("zrtp: generated‚ew…ersistent ZID (%s)\n",

616 
z¹p_zid_·th
);

619 
”r
 = 
”ºo
;

620 
	`w¬nšg
("z¹p: fİ’(è% (%m)\n", 
z¹p_zid_·th
, 
”r
);

622 ià(
f
)

623 (è
	`fşo£
(
f
);

625 
s
 = 
	`z¹p_š™
(&
z¹p_cÚfig
, &
z¹p_glob®
);

626 ià(
z¹p_¡©us_ok
 !ğ
s
) {

627 
	`w¬nšg
("z¹p: z¹p_š™(èçed (¡©u ğ%d)\n", 
s
);

628  
ENOSYS
;

631 
	`m’c_»gi¡”
(
	`b¬es_m’ş
(), &
m’c_z¹p
);

633 
	`debug
("z¹p: cache_fe: %s\n", 
z¹p_cÚfig
.
def_ÿche_·th
.
bufãr
);

634 
	`debug
(" zid_fe: %s\n", 
z¹p_zid_·th
);

635 
	`debug
(" zid: %w\n",

636 
zid
, (zid));

638  
	`cmd_»gi¡”
(
	`b¬es_commªds
(), 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

639 
	}
}

642 
	$moduË_şo£
()

644 
	`cmd_uÄegi¡”
(
	`b¬es_commªds
(), 
cmdv
);

645 
	`m’c_uÄegi¡”
(&
m’c_z¹p
);

647 ià(
z¹p_glob®
) {

648 
	`z¹p_down
(
z¹p_glob®
);

649 
z¹p_glob®
 = 
NULL
;

653 
	}
}

656 
EXPORT_SYM
 cÚ¡ 
mod_expÜt
 
DECL_EXPORTS
(
z¹p
) = {

659 
moduË_š™
,

660 
moduË_şo£


	@baresip/src/account.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

13 
	mREG_INTERVAL
 = 3600,

17 
	$de¡ruùÜ
(*
¬g
)

19 
accouÁ
 *
acc
 = 
¬g
;

20 
size_t
 
i
;

22 
	`li¡_ş—r
(&
acc
->
aucodeş
);

23 
	`li¡_ş—r
(&
acc
->
vidcodeş
);

24 
	`mem_d”ef
(
acc
->
auth_u£r
);

25 
	`mem_d”ef
(
acc
->
auth_·ss
);

26 
i
=0; i<
	`ARRAY_SIZE
(
acc
->
outboundv
); i++)

27 
	`mem_d”ef
(
acc
->
outboundv
[
i
]);

28 
	`mem_d”ef
(
acc
->
»gq
);

29 
	`mem_d”ef
(
acc
->
¹pk“p
);

30 
	`mem_d”ef
(
acc
->
sÇt
);

31 
	`mem_d”ef
(
acc
->
¡un_u£r
);

32 
	`mem_d”ef
(
acc
->
¡un_·ss
);

33 
	`mem_d”ef
(
acc
->
¡un_ho¡
);

34 
	`mem_d”ef
(
acc
->
mÇtid
);

35 
	`mem_d”ef
(
acc
->
m’cid
);

36 
	`mem_d”ef
(
acc
->
aÜ
);

37 
	`mem_d”ef
(
acc
->
di¥Çme
);

38 
	`mem_d”ef
(
acc
->
buf
);

39 
	}
}

42 
	$·¿m_d¡r
(**
d¡r
, cÚ¡ 
¶
 *
·¿ms
, cÚ¡ *
Çme
)

44 
¶
…l;

46 ià(
	`msg_·¿m_decode
(
·¿ms
, 
Çme
, &
¶
))

49  
	`¶_¡rdup
(
d¡r
, &
¶
);

50 
	}
}

53 
	$·¿m_u32
(
ušt32_t
 *
v
, cÚ¡ 
¶
 *
·¿ms
, cÚ¡ *
Çme
)

55 
¶
…l;

57 ià(
	`msg_·¿m_decode
(
·¿ms
, 
Çme
, &
¶
))

60 *
v
 = 
	`¶_u32
(&
¶
);

63 
	}
}

75 
	$¡un¤v_decode
(
accouÁ
 *
acc
, cÚ¡ 
s_addr
 *
aÜ
)

77 
¶
 
¤v
, 
tmp
;

78 
uri
 uri;

79 
”r
;

81 ià(!
acc
 || !
aÜ
)

82  
EINVAL
;

84 
	`mem£t
(&
uri
, 0, (uri));

86 ià(0 =ğ
	`msg_·¿m_decode
(&
aÜ
->
·¿ms
, "¡un£rv”", &
¤v
)) {

88 
	`šfo
("usšg stun£rv”: '%r'\n", &
¤v
);

90 
”r
 = 
	`uri_decode
(&
uri
, &
¤v
);

91 ià(
”r
) {

92 
	`w¬nšg
("accouÁ: %r: decodçed: %m\n", &
¤v
, 
”r
);

93 
	`mem£t
(&
uri
, 0, (uri));

96 ià(0 !ğ
	`¶_¡rÿ£cmp
(&
uri
.
scheme
, "stun")) {

97 
	`w¬nšg
("accouÁ: unknowÀscheme: %r\n", &
uri
.
scheme
);

98  
EINVAL
;

102 
”r
 = 0;

104 ià(0 =ğ
	`msg_·¿m_exi¡s
(&
aÜ
->
·¿ms
, "¡unu£r", &
tmp
))

105 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
¡un_u£r
, &
aÜ
->
·¿ms
, "stunuser");

106 ià(
	`¶_is£t
(&
uri
.
u£r
))

107 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
¡un_u£r
, &
uri
.
u£r
);

109 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
¡un_u£r
, &
aÜ
->
uri
.
u£r
);

111 ià(0 =ğ
	`msg_·¿m_exi¡s
(&
aÜ
->
·¿ms
, "¡uÅass", &
tmp
))

112 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
¡un_·ss
, &
aÜ
->
·¿ms
, "stunpass");

113 ià(
	`¶_is£t
(&
uri
.
·sswÜd
))

114 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
¡un_·ss
, &
uri
.
·sswÜd
);

115 ià(
acc
->
auth_·ss
)

116 
”r
 |ğ
	`¡r_dup
(&
acc
->
¡un_·ss
,‡cc->
auth_·ss
);

118 ià(
	`¶_is£t
(&
uri
.
ho¡
))

119 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
¡un_ho¡
, &
uri
.
ho¡
);

121 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
¡un_ho¡
, &
aÜ
->
uri
.
ho¡
);

123 
acc
->
¡un_pÜt
 = 
uri
.
pÜt
;

125  
”r
;

126 
	}
}

130 
	$medŸ_decode
(
accouÁ
 *
acc
, cÚ¡ 
¶
 *
´m
)

132 
”r
 = 0;

134 ià(!
acc
 || !
´m
)

135  
EINVAL
;

137 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
m’cid
, 
´m
, "mediaenc");

138 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
mÇtid
, 
´m
, "medianat");

139 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
¹pk“p
, 
´m
, "rtpkeep" );

140 
”r
 |ğ
	`·¿m_u32
(&
acc
->
±ime
, 
´m
, "ptime" );

142  
”r
;

143 
	}
}

147 
	$ªsw”mode_decode
(
accouÁ
 *
´m
, cÚ¡ 
¶
 *pl)

149 
¶
 
amode
;

151 ià(0 =ğ
	`msg_·¿m_decode
(
¶
, "ªsw”mode", &
amode
)) {

153 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
amode
, "manual")) {

154 
´m
->
ªsw”mode
 = 
ANSWERMODE_MANUAL
;

156 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
amode
, "early")) {

157 
´m
->
ªsw”mode
 = 
ANSWERMODE_EARLY
;

159 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
amode
, "auto")) {

160 
´m
->
ªsw”mode
 = 
ANSWERMODE_AUTO
;

163 
	`w¬nšg
("accouÁ:‡nsw”modunknowÀ(%r)\n", &
amode
);

164 
´m
->
ªsw”mode
 = 
ANSWERMODE_MANUAL
;

167 
	}
}

170 
	$c¦_·r£
(
¶
 *¶, *
¡r
, 
size_t
 
sz
)

172 
¶
 
ws
 = 
PL_INIT
, 
v®
, 
ws2
 = PL_INIT, 
cma
 = PL_INIT;

173 
”r
;

175 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
, "[ \t]*[^, \t]+[ \t]*[,]*",

176 &
ws
, &
v®
, &
ws2
, &
cma
);

177 ià(
”r
)

178  
”r
;

180 
	`¶_advªû
(
¶
, 
ws
.
l
 + 
v®
.È+ 
ws2
.È+ 
cma
.l);

182 ()
	`¶_¡rıy
(&
v®
, 
¡r
, 
sz
);

185 
	}
}

188 
	$audio_codecs_decode
(
accouÁ
 *
acc
, cÚ¡ 
¶
 *
´m
)

190 
li¡
 *
aucodeş
 = 
	`b¬es_aucodeş
();

191 
¶
 
tmp
;

193 ià(!
acc
 || !
´m
)

194  
EINVAL
;

196 
	`li¡_š™
(&
acc
->
aucodeş
);

198 ià(0 =ğ
	`msg_·¿m_exi¡s
(
´m
, "audio_codecs", &
tmp
)) {

199 
¶
 
acs
;

200 
úame
[64];

201 
i
 = 0;

203 ià(
	`msg_·¿m_decode
(
´m
, "audio_codecs", &
acs
))

206 0 =ğ
	`c¦_·r£
(&
acs
, 
úame
, (cname))) {

207 
aucodec
 *
ac
;

208 
¶
 
¶_úame
, 
¶_¤©e
, 
¶_ch
 = 
PL_INIT
;

209 
ušt32_t
 
¤©e
 = 8000;

210 
ušt8_t
 
ch
 = 1;

213 ià(0 =ğ
	`»_»gex
(
úame
, 
	`¡r_Ën
(cname),

215 &
¶_úame
, &
¶_¤©e
,

216 
NULL
, &
¶_ch
)) {

217 ()
	`¶_¡rıy
(&
¶_úame
, 
úame
,

218 (
úame
));

219 
¤©e
 = 
	`¶_u32
(&
¶_¤©e
);

220 ià(
	`¶_is£t
(&
¶_ch
))

221 
ch
 = 
	`¶_u32
(&
¶_ch
);

224 
ac
 = (
aucodec
 *)
	`aucodec_fšd
(
aucodeş
,

225 
úame
, 
¤©e
, 
ch
);

226 ià(!
ac
) {

227 
	`w¬nšg
("account:‡udio codec‚ot found:"

229 
úame
, 
¤©e
, 
ch
);

234 
	`li¡_­³nd
(&
acc
->
aucodeş
, &acc->
acv
[
i
++], 
ac
);

236 ià(
i
 >ğ
	`ARRAY_SIZE
(
acc
->
acv
))

242 
	}
}

245 #ifdeà
USE_VIDEO


246 
	$video_codecs_decode
(
accouÁ
 *
acc
, cÚ¡ 
¶
 *
´m
)

248 
li¡
 *
vidcodeş
 = 
	`b¬es_vidcodeş
();

249 
¶
 
tmp
;

251 ià(!
acc
 || !
´m
)

252  
EINVAL
;

254 
	`li¡_š™
(&
acc
->
vidcodeş
);

256 ià(0 =ğ
	`msg_·¿m_exi¡s
(
´m
, "video_codecs", &
tmp
)) {

257 
¶
 
vcs
;

258 
úame
[64];

259 
i
 = 0;

261 ià(
	`msg_·¿m_decode
(
´m
, "video_codecs", &
vcs
))

264 0 =ğ
	`c¦_·r£
(&
vcs
, 
úame
, (cname))) {

265 
vidcodec
 *
vc
;

267 
vc
 = (
vidcodec
 *)
	`vidcodec_fšd
(
vidcodeş
,

268 
úame
, 
NULL
);

269 ià(!
vc
) {

270 
	`w¬nšg
("account: video codec‚ot found: %s\n",

271 
úame
);

276 
	`li¡_­³nd
(&
acc
->
vidcodeş
, &acc->
vcv
[
i
++], 
vc
);

278 ià(
i
 >ğ
	`ARRAY_SIZE
(
acc
->
vcv
))

284 
	}
}

288 
	$s_·¿ms_decode
(
accouÁ
 *
acc
, cÚ¡ 
s_addr
 *
aÜ
)

290 
¶
 
auth_u£r
;

291 
size_t
 
i
;

292 
”r
 = 0;

294 ià(!
acc
 || !
aÜ
)

295  
EINVAL
;

297 
acc
->
»gšt
 = 
REG_INTERVAL
 + (
	`¿nd_u32
()&0xff);

298 
”r
 |ğ
	`·¿m_u32
(&
acc
->
»gšt
, &
aÜ
->
·¿ms
, "regint");

300 
acc
->
pubšt
 = 0;

301 
”r
 |ğ
	`·¿m_u32
(&
acc
->
pubšt
, &
aÜ
->
·¿ms
, "pubint");

303 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
»gq
, &
aÜ
->
·¿ms
, "regq");

305 
i
=0; i<
	`ARRAY_SIZE
(
acc
->
outboundv
); i++) {

307 
ex´
[16] = "outbound";

309 
ex´
[8] = 
i
 + 1 + 0x30;

310 
ex´
[9] = '\0';

312 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
outboundv
[
i
], &
aÜ
->
·¿ms
, 
ex´
);

316 ià(!
acc
->
outboundv
[0]) {

317 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
outboundv
[0], &
aÜ
->
·¿ms
,

321 
”r
 |ğ
	`·¿m_d¡r
(&
acc
->
sÇt
, &
aÜ
->
·¿ms
, "sipnat");

323 ià(0 =ğ
	`msg_·¿m_decode
(&
aÜ
->
·¿ms
, "auth_u£r", &
auth_u£r
))

324 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
auth_u£r
, &auth_user);

326 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
auth_u£r
, &
aÜ
->
uri
.
u£r
);

328 ià(
	`¶_is£t
(&
aÜ
->
dÇme
))

329 
”r
 |ğ
	`¶_¡rdup
(&
acc
->
di¥Çme
, &
aÜ
->
dÇme
);

331  
”r
;

332 
	}
}

335 
	$’code_uri_u£r
(
»_´štf
 *
pf
, cÚ¡ 
uri
 *uri)

337 
uri
 
uuri
 = *uri;

339 
uuri
.
·sswÜd
 = uuri.
·¿ms
 = uuri.
h—d”s
 = 
¶_nuÎ
;

341  
	`uri_’code
(
pf
, &
uuri
);

342 
	}
}

345 
	$accouÁ_®loc
(
accouÁ
 **
acı
, cÚ¡ *
saddr
)

347 
accouÁ
 *
acc
;

348 
¶
…l;

349 
”r
 = 0;

351 ià(!
acı
 || !
saddr
)

352  
EINVAL
;

354 
acc
 = 
	`mem_z®loc
((*acc), 
de¡ruùÜ
);

355 ià(!
acc
)

356  
ENOMEM
;

358 
”r
 = 
	`¡r_dup
(&
acc
->
buf
, 
saddr
);

359 ià(
”r
)

360 
out
;

362 
	`¶_£t_¡r
(&
¶
, 
acc
->
buf
);

363 
”r
 = 
	`s_addr_decode
(&
acc
->
Ïddr
, &
¶
);

364 ià(
”r
) {

365 
	`w¬nšg
("accouÁ:ƒ¼Ü…¬sšg SIP‡dd»ss: '%r'\n", &
¶
);

366 
out
;

369 
acc
->
luri
 =‡cc->
Ïddr
.
uri
;

370 
acc
->
luri
.
·sswÜd
 = 
¶_nuÎ
;

372 
”r
 = 
	`»_sd´štf
(&
acc
->
aÜ
, "%H", 
’code_uri_u£r
, &acc->
luri
);

373 ià(
”r
)

374 
out
;

377 
acc
->
±ime
 = 20;

378 
”r
 |ğ
	`s_·¿ms_decode
(
acc
, &acc->
Ïddr
);

379 
	`ªsw”mode_decode
(
acc
, &acc->
Ïddr
.
·¿ms
);

380 
”r
 |ğ
	`audio_codecs_decode
(
acc
, &acc->
Ïddr
.
·¿ms
);

381 #ifdeà
USE_VIDEO


382 
”r
 |ğ
	`video_codecs_decode
(
acc
, &acc->
Ïddr
.
·¿ms
);

384 
”r
 |ğ
	`medŸ_decode
(
acc
, &acc->
Ïddr
.
·¿ms
);

385 ià(
”r
)

386 
out
;

389 ià(
	`¶_is£t
(&
acc
->
Ïddr
.
uri
.
·sswÜd
)) {

391 
	`w¬nšg
("account: username:password is‚ow deprecated"

394 
”r
 = 
	`»_sd´štf
(&
acc
->
auth_·ss
, "%H",

395 
uri_·sswÜd_uÃsÿ³
,

396 &
acc
->
Ïddr
.
uri
.
·sswÜd
);

397 ià(
”r
)

398 
out
;

400 ià(0 =ğ
	`msg_·¿m_decode
(&
acc
->
Ïddr
.
·¿ms
, "auth_·ss", &
¶
)) {

401 
”r
 = 
	`¶_¡rdup
(&
acc
->
auth_·ss
, &
¶
);

402 ià(
”r
)

403 
out
;

406 
”r
 = 
	`¡un¤v_decode
(
acc
, &acc->
Ïddr
);

407 ià(
”r
)

408 
out
;

410 ià(
acc
->
mÇtid
) {

411 
acc
->
mÇt
 = 
	`mÇt_fšd
(
	`b¬es_mÇ
(),‡cc->
mÇtid
);

412 ià(!
acc
->
mÇt
) {

413 
	`w¬nšg
("account: medianat‚ot found: `%s'\n",

414 
acc
->
mÇtid
);

418 ià(
acc
->
m’cid
) {

419 
acc
->
m’c
 = 
	`m’c_fšd
(
	`b¬es_m’ş
(),‡cc->
m’cid
);

420 ià(!
acc
->
m’c
) {

421 
	`w¬nšg
("account: mediaenc‚ot found: `%s'\n",

422 
acc
->
m’cid
);

426 
out
:

427 ià(
”r
)

428 
	`mem_d”ef
(
acc
);

430 *
acı
 = 
acc
;

432  
”r
;

433 
	}
}

436 
	$accouÁ_£t_auth_·ss
(
accouÁ
 *
acc
, cÚ¡ *
·ss
)

438 ià(!
acc
)

439  
EINVAL
;

441 
acc
->
auth_·ss
 = 
	`mem_d”ef
(acc->auth_pass);

443 ià(
·ss
)

444  
	`¡r_dup
(&
acc
->
auth_·ss
, 
·ss
);

447 
	}
}

458 
	$accouÁ_£t_di¥Ïy_Çme
(
accouÁ
 *
acc
, cÚ¡ *
dÇme
)

460 ià(!
acc
)

461  
EINVAL
;

463 
acc
->
di¥Çme
 = 
	`mem_d”ef
(acc->dispname);

465 ià(
dÇme
)

466  
	`¡r_dup
(&
acc
->
di¥Çme
, 
dÇme
);

469 
	}
}

482 
	$accouÁ_auth
(cÚ¡ 
accouÁ
 *
acc
, **
u£ºame
, **
·sswÜd
,

483 cÚ¡ *
»®m
)

485 ià(!
acc
)

486  
EINVAL
;

488 ()
»®m
;

490 *
u£ºame
 = 
	`mem_»f
(
acc
->
auth_u£r
);

491 *
·sswÜd
 = 
	`mem_»f
(
acc
->
auth_·ss
);

494 
	}
}

497 
li¡
 *
	$accouÁ_aucodeş
(cÚ¡ 
accouÁ
 *
acc
)

499  (
acc
 && !
	`li¡_i£m±y
(&acc->
aucodeş
))

500 ? (
li¡
 *)&
acc
->
aucodeş
 : 
	`b¬es_aucodeş
();

501 
	}
}

504 #ifdeà
USE_VIDEO


505 
li¡
 *
	$accouÁ_vidcodeş
(cÚ¡ 
accouÁ
 *
acc
)

507  (
acc
 && !
	`li¡_i£m±y
(&acc->
vidcodeş
))

508 ? (
li¡
 *)&
acc
->
vidcodeş
 : 
	`b¬es_vidcodeş
();

509 
	}
}

513 
s_addr
 *
	$accouÁ_Ïddr
(cÚ¡ 
accouÁ
 *
acc
)

515  
acc
 ? (
s_addr
 *)&acc->
Ïddr
 : 
NULL
;

516 
	}
}

519 
ušt32_t
 
	$accouÁ_»gšt
(cÚ¡ 
accouÁ
 *
acc
)

521  
acc
 ?‡cc->
»gšt
 : 0;

522 
	}
}

525 
ušt32_t
 
	$accouÁ_pubšt
(cÚ¡ 
accouÁ
 *
acc
)

527  
acc
 ?‡cc->
pubšt
 : 0;

528 
	}
}

531 
ªsw”mode
 
	$accouÁ_ªsw”mode
(cÚ¡ 
accouÁ
 *
acc
)

533  
acc
 ?‡cc->
ªsw”mode
 : 
ANSWERMODE_MANUAL
;

534 
	}
}

537 cÚ¡ *
	$accouÁ_aÜ
(cÚ¡ 
accouÁ
 *
acc
)

539  
acc
 ?‡cc->
aÜ
 : 
NULL
;

540 
	}
}

550 cÚ¡ *
	$accouÁ_auth_u£r
(cÚ¡ 
accouÁ
 *
acc
)

552  
acc
 ?‡cc->
auth_u£r
 : 
NULL
;

553 
	}
}

563 cÚ¡ *
	$accouÁ_auth_·ss
(cÚ¡ 
accouÁ
 *
acc
)

565  
acc
 ?‡cc->
auth_·ss
 : 
NULL
;

566 
	}
}

577 cÚ¡ *
	$accouÁ_outbound
(cÚ¡ 
accouÁ
 *
acc
, 
ix
)

579 ià(!
acc
 || 
ix
 >ğ
	`ARRAY_SIZE
×cc->
outboundv
))

580  
NULL
;

582  
acc
->
outboundv
[
ix
];

583 
	}
}

593 
ušt32_t
 
	$accouÁ_±ime
(cÚ¡ 
accouÁ
 *
acc
)

595  
acc
 ?‡cc->
±ime
 : 0;

596 
	}
}

606 cÚ¡ *
	$accouÁ_¡un_u£r
(cÚ¡ 
accouÁ
 *
acc
)

608  
acc
 ?‡cc->
¡un_u£r
 : 
NULL
;

609 
	}
}

619 cÚ¡ *
	$accouÁ_¡un_·ss
(cÚ¡ 
accouÁ
 *
acc
)

621  
acc
 ?‡cc->
¡un_·ss
 : 
NULL
;

622 
	}
}

632 cÚ¡ *
	$accouÁ_¡un_ho¡
(cÚ¡ 
accouÁ
 *
acc
)

634  
acc
 ?‡cc->
¡un_ho¡
 : 
NULL
;

635 
	}
}

638 cÚ¡ *
	$ªsw”mode_¡r
(
ªsw”mode
 
mode
)

640 
mode
) {

642 
ANSWERMODE_MANUAL
:  "manual";

643 
ANSWERMODE_EARLY
:  "early";

644 
ANSWERMODE_AUTO
:  "auto";

647 
	}
}

650 
	$accouÁ_debug
(
»_´štf
 *
pf
, cÚ¡ 
accouÁ
 *
acc
)

652 
Ë
 *le;

653 
size_t
 
i
;

654 
”r
 = 0;

656 ià(!
acc
)

659 
”r
 |ğ
	`»_h´štf
(
pf
, "\nAccount:\n");

661 
”r
 |ğ
	`»_h´štf
(
pf
, "‡dd»ss: %s\n", 
acc
->
buf
);

662 
”r
 |ğ
	`»_h´štf
(
pf
, "†uri: %H\n",

663 
uri_’code
, &
acc
->
luri
);

664 
”r
 |ğ
	`»_h´štf
(
pf
, "‡Ü: %s\n", 
acc
->
aÜ
);

665 
”r
 |ğ
	`»_h´štf
(
pf
, " di¥Çme: %s\n", 
acc
->
di¥Çme
);

666 
”r
 |ğ
	`»_h´štf
(
pf
, "‡nswermode: %s\n",

667 
	`ªsw”mode_¡r
(
acc
->
ªsw”mode
));

668 ià(!
	`li¡_i£m±y
(&
acc
->
aucodeş
)) {

669 
”r
 |ğ
	`»_h´štf
(
pf
, "‡udio_codecs:");

670 
Ë
 = 
	`li¡_h—d
(&
acc
->
aucodeş
);†e;†ğË->
Ãxt
) {

671 cÚ¡ 
aucodec
 *
ac
 = 
Ë
->
d©a
;

672 
”r
 |ğ
	`»_h´štf
(
pf
, " %s/%u/%u",

673 
ac
->
Çme
,‡c->
¤©e
,‡c->
ch
);

675 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

677 
”r
 |ğ
	`»_h´štf
(
pf
, "‡uth_u£r: %s\n", 
acc
->
auth_u£r
);

678 
”r
 |ğ
	`»_h´štf
(
pf
, " mediaenc: %s\n",

679 
acc
->
m’cid
 ?‡cc->mencid : "none");

680 
”r
 |ğ
	`»_h´štf
(
pf
, " medianat: %s\n",

681 
acc
->
mÇtid
 ?‡cc->mnatid : "none");

682 
i
=0; i<
	`ARRAY_SIZE
(
acc
->
outboundv
); i++) {

683 ià(
acc
->
outboundv
[
i
]) {

684 
”r
 |ğ
	`»_h´štf
(
pf
, " outbound%d: %s\n",

685 
i
+1, 
acc
->
outboundv
[i]);

688 
”r
 |ğ
	`»_h´štf
(
pf
, "…time: %u\n", 
acc
->
±ime
);

689 
”r
 |ğ
	`»_h´štf
(
pf
, "„egšt: %u\n", 
acc
->
»gšt
);

690 
”r
 |ğ
	`»_h´štf
(
pf
, "…ubšt: %u\n", 
acc
->
pubšt
);

691 
”r
 |ğ
	`»_h´štf
(
pf
, "„egq: %s\n", 
acc
->
»gq
);

692 
”r
 |ğ
	`»_h´štf
(
pf
, "„k“p: %s\n", 
acc
->
¹pk“p
);

693 
”r
 |ğ
	`»_h´štf
(
pf
, " sÇt: %s\n", 
acc
->
sÇt
);

694 
”r
 |ğ
	`»_h´štf
(
pf
, " stunserver: stun:%s@%s:%u\n",

695 
acc
->
¡un_u£r
,‡cc->
¡un_ho¡
,‡cc->
¡un_pÜt
);

696 ià(!
	`li¡_i£m±y
(&
acc
->
vidcodeş
)) {

697 
”r
 |ğ
	`»_h´štf
(
pf
, " video_codecs:");

698 
Ë
 = 
	`li¡_h—d
(&
acc
->
vidcodeş
);†e;†ğË->
Ãxt
) {

699 cÚ¡ 
vidcodec
 *
vc
 = 
Ë
->
d©a
;

700 
”r
 |ğ
	`»_h´štf
(
pf
, " %s", 
vc
->
Çme
);

702 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

705  
”r
;

706 
	}
}

	@baresip/src/aucodec.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

18 
	$aucodec_»gi¡”
(
li¡
 *
aucodeş
, 
aucodec
 *
ac
)

20 ià(!
aucodeş
 || !
ac
)

23 
	`li¡_­³nd
(
aucodeş
, &
ac
->
Ë
,‡c);

25 
	`šfo
("aucodec: %s/%u/%u\n", 
ac
->
Çme
,‡c->
¤©e
,‡c->
ch
);

26 
	}
}

34 
	$aucodec_uÄegi¡”
(
aucodec
 *
ac
)

36 ià(!
ac
)

39 
	`li¡_uÆšk
(&
ac
->
Ë
);

40 
	}
}

43 cÚ¡ 
aucodec
 *
	$aucodec_fšd
(cÚ¡ 
li¡
 *
aucodeş
,

44 cÚ¡ *
Çme
, 
ušt32_t
 
¤©e
,

45 
ušt8_t
 
ch
)

47 
Ë
 *le;

49 
Ë
=
	`li¡_h—d
(
aucodeş
);†e;†eöe->
Ãxt
) {

51 
aucodec
 *
ac
 = 
Ë
->
d©a
;

53 ià(
Çme
 && 0 !ğ
	`¡r_ÿ£cmp
Òame, 
ac
->name))

56 ià(
¤©e
 && s¿‹ !ğ
ac
->srate)

59 ià(
ch
 && ch !ğ
ac
->ch)

62  
ac
;

65  
NULL
;

66 
	}
}

	@baresip/src/audio.c

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	#_BSD_SOURCE
 1

	)

9 
	~<¡ršg.h
>

10 
	~<¡dlib.h
>

11 #ifdeà
HAVE_UNISTD_H


12 
	~<uni¡d.h
>

14 #ifdeà
HAVE_PTHREAD


15 
	~<±h»ad.h
>

17 
	~<».h
>

18 
	~<»m.h
>

19 
	~<b¬es.h
>

20 
	~"cÜe.h
"

24 
	#MAGIC
 0x000a0d10

	)

25 
	~"magic.h
"

56 
	mAUDIO_SAMPSZ
 = 3*1920

77 
	sautx
 {

78 
au¤c_¡
 *
	mau¤c
;

79 
au¤c_´m
 
	mau¤c_´m
;

80 cÚ¡ 
aucodec
 *
	mac
;

81 
au’c_¡©e
 *
	m’c
;

82 
aubuf
 *
	maubuf
;

83 
size_t
 
	maubuf_maxsz
;

84 vŞ©
boŞ
 
	maubuf_¡¬‹d
;

85 
au»§mp
 
	m»§mp
;

86 
li¡
 
	mf
;

87 
mbuf
 *
	mmb
;

88 
	mdeviû
[64];

89 
št16_t
 *
	m§mpv
;

90 
št16_t
 *
	m§mpv_rs
;

91 
ušt32_t
 
	m±ime
;

92 
ušt64_t
 
	mts_ext
;

93 
ušt32_t
 
	mts_ba£
;

94 
ušt32_t
 
	mts_‹l
;

95 
size_t
 
	mpsize
;

96 
boŞ
 
	mm¬k”
;

97 
boŞ
 
	mmu‹d
;

98 
	mcur_key
;

99 
aufmt
 
	m¤c_fmt
;

100 
boŞ
 
	mÃed_cÚv
;

103 
ušt64_t
 
	maubuf_ov”run
;

104 
ušt64_t
 
	maubuf_und”run
;

105 } 
	m¡©s
;

107 #ifdeà
HAVE_PTHREAD


110 
±h»ad_t
 
	mtid
;

111 
boŞ
 
	mrun
;

112 } 
	mthr
;

113 } 
	mu
;

133 
	saurx
 {

134 
au¶ay_¡
 *
	mau¶ay
;

135 
au¶ay_´m
 
	mau¶ay_´m
;

136 cÚ¡ 
aucodec
 *
	mac
;

137 
audec_¡©e
 *
	mdec
;

138 
aubuf
 *
	maubuf
;

139 
size_t
 
	maubuf_maxsz
;

140 vŞ©
boŞ
 
	maubuf_¡¬‹d
;

141 
au»§mp
 
	m»§mp
;

142 
li¡
 
	mf
;

143 
	mdeviû
[64];

144 
št16_t
 *
	m§mpv
;

145 
št16_t
 *
	m§mpv_rs
;

146 
ušt32_t
 
	m±ime
;

147 
	m±
;

148 
	mËv–_Ï¡
;

149 
boŞ
 
	mËv–_£t
;

150 
aufmt
 
	m¶ay_fmt
;

151 
boŞ
 
	mÃed_cÚv
;

152 
time¡amp_»cv
 
	mts_»cv
;

153 
ušt64_t
 
	mn_disÿrd
;

156 
ušt64_t
 
	maubuf_ov”run
;

157 
ušt64_t
 
	maubuf_und”run
;

158 } 
	m¡©s
;

163 
	saudio
 {

164 
MAGIC_DECL


165 
autx
 
	mtx
;

166 
aurx
 
	mrx
;

167 
¡»am
 *
	m¡rm
;

168 
‹Ëv
 *
	m‹Ëv
;

169 
cÚfig_audio
 
	mcfg
;

170 
boŞ
 
	m¡¬‹d
;

171 
boŞ
 
	mËv–_’abËd
;

172 
	mextm­_auËv–
;

173 
audio_ev’t_h
 *
	mev’th
;

174 
audio_”r_h
 *
	m”rh
;

175 *
	m¬g
;

180 cÚ¡ *
	guri_auËv–
 = "urn:ietf:params:rtp-hdrext:ssrc-audio-level";

183 
	$audio_ÿlc_£cÚds
(
ušt64_t
 
¹p_ts
, 
ušt32_t
 
şock_¿‹
)

185 
time¡amp
;

188 
time¡amp
 = ()
¹p_ts
 / ()
şock_¿‹
;

190  
time¡amp
;

191 
	}
}

194 
	$autx_ÿlc_£cÚds
(cÚ¡ 
autx
 *autx)

196 
ušt64_t
 
dur
;

198 ià(!
autx
->
ac
)

201 
dur
 = 
autx
->
ts_ext
 -‡utx->
ts_ba£
;

203  
	`audio_ÿlc_£cÚds
(
dur
, 
autx
->
ac
->
ü©e
);

204 
	}
}

207 
	$aurx_ÿlc_£cÚds
(cÚ¡ 
aurx
 *aurx)

209 
ušt64_t
 
dur
;

211 ià(!
aurx
->
ac
)

214 
dur
 = 
	`time¡amp_du¿tiÚ
(&
aurx
->
ts_»cv
);

216  
	`audio_ÿlc_£cÚds
(
dur
, 
aurx
->
ac
->
ü©e
);

217 
	}
}

220 
	$¡İ_tx
(
autx
 *
tx
, 
audio
 *
a
)

222 ià(!
tx
 || !
a
)

225 
a
->
cfg
.
txmode
) {

227 #ifdeà
HAVE_PTHREAD


228 
AUDIO_MODE_THREAD
:

229 ià(
tx
->
u
.
thr
.
run
) {

230 
tx
->
u
.
thr
.
run
 = 
çl£
;

231 
	`±h»ad_još
(
tx
->
u
.
thr
.
tid
, 
NULL
);

240 
tx
->
au¤c
 = 
	`mem_d”ef
(tx->ausrc);

241 
tx
->
aubuf
 = 
	`mem_d”ef
(tx->aubuf);

243 
	`li¡_æush
(&
tx
->
f
);

244 
	}
}

247 
	$¡İ_rx
(
aurx
 *
rx
)

249 ià(!
rx
)

253 
rx
->
au¶ay
 = 
	`mem_d”ef
(rx->auplay);

254 
rx
->
aubuf
 = 
	`mem_d”ef
(rx->aubuf);

256 
	`li¡_æush
(&
rx
->
f
);

257 
	}
}

260 
	$audio_de¡ruùÜ
(*
¬g
)

262 
audio
 *
a
 = 
¬g
;

264 
	`¡İ_tx
(&
a
->
tx
,‡);

265 
	`¡İ_rx
(&
a
->
rx
);

267 
	`mem_d”ef
(
a
->
tx
.
’c
);

268 
	`mem_d”ef
(
a
->
rx
.
dec
);

269 
	`mem_d”ef
(
a
->
tx
.
aubuf
);

270 
	`mem_d”ef
(
a
->
tx
.
mb
);

271 
	`mem_d”ef
(
a
->
tx
.
§mpv
);

272 
	`mem_d”ef
(
a
->
rx
.
§mpv
);

273 
	`mem_d”ef
(
a
->
rx
.
aubuf
);

274 
	`mem_d”ef
(
a
->
tx
.
§mpv_rs
);

275 
	`mem_d”ef
(
a
->
rx
.
§mpv_rs
);

277 
	`li¡_æush
(&
a
->
tx
.
f
);

278 
	`li¡_æush
(&
a
->
rx
.
f
);

280 
	`mem_d”ef
(
a
->
¡rm
);

281 
	`mem_d”ef
(
a
->
‹Ëv
);

282 
	}
}

294 
šlše
 
ušt32_t
 
	$ÿlc_n§mp
(
ušt32_t
 
¤©e
, 
ušt8_t
 
chªÃls
,

295 
ušt16_t
 
±ime
)

297  
¤©e
 * 
chªÃls
 * 
±ime
 / 1000;

298 
	}
}

301 
šlše
 
	$ÿlc_±ime
(
size_t
 
n§mp
, 
ušt32_t
 
¤©e
, 
ušt8_t
 
chªÃls
)

303 
±ime
;

305 
±ime
 = 1000.0 * ()
n§mp
 / ()(
¤©e
 * 
chªÃls
);

307  
±ime
;

308 
	}
}

314 
šlše
 
ušt32_t
 
	$g‘_¤©e
(cÚ¡ 
aucodec
 *
ac
)

316 ià(!
ac
)

319  
ac
->
¤©e
;

320 
	}
}

326 
šlše
 
ušt32_t
 
	$g‘_ch
(cÚ¡ 
aucodec
 *
ac
)

328 ià(!
ac
)

331  !
	`¡r_ÿ£cmp
(
ac
->
Çme
, "MPA"è? 2 :‡c->
ch
;

332 
	}
}

335 
šlše
 
ušt32_t
 
	$g‘_äamesize
(cÚ¡ 
aucodec
 *
ac
,

336 
ušt32_t
 
±ime
)

338 ià(!
ac
)

341  
	`ÿlc_n§mp
(
	`g‘_¤©e
(
ac
), 
	`g‘_ch
×c), 
±ime
);

342 
	}
}

345 
boŞ
 
	$aucodec_equ®
(cÚ¡ 
aucodec
 *
a
, cÚ¡ aucodeø*
b
)

347 ià(!
a
 || !
b
)

348  
çl£
;

350  
	`g‘_¤©e
(
a
è=ğg‘_¤©e(
b
è&& 
	`g‘_ch
(a) == get_ch(b);

351 
	}
}

354 
	$add_audio_codec
(
audio
 *
a
, 
sdp_medŸ
 *
m
,

355 
aucodec
 *
ac
)

357 ià(!
	`š_¿nge
(&
a
->
cfg
.
¤©e
, 
	`g‘_¤©e
(
ac
))) {

358 
	`debug
("audio: skip %uHz codec (audio„ange %uHz - %uHz)\n",

359 
	`g‘_¤©e
(
ac
), 
a
->
cfg
.
¤©e
.
mš
,‡->cfg.¤©e.
max
);

363 ià(!
	`š_¿nge
(&
a
->
cfg
.
chªÃls
, 
	`g‘_ch
(
ac
))) {

364 
	`debug
("audio: skip codec with %uch (audio„ange %uch-%uch)\n",

365 
	`g‘_ch
(
ac
), 
a
->
cfg
.
chªÃls
.
mš
,‡->cfg.chªÃls.
max
);

369 ià(
ac
->
ü©e
 < 8000) {

370 
	`w¬nšg
("audio: iÎeg® clock„©%u\n", 
ac
->
ü©e
);

371  
EINVAL
;

374  
	`sdp_fÜm©_add
(
NULL
, 
m
, 
çl£
, 
ac
->
±
,‡c->
Çme
,‡c->
ü©e
,

375 
ac
->
ch
,‡c->
fm_’ch
,‡c->
fm_cmph
,‡c, 
çl£
,

376 "%s", 
ac
->
fm
);

377 
	}
}

380 
	$­³nd_¹³xt
(
audio
 *
au
, 
mbuf
 *
mb
,

381 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

383 
ušt8_t
 
d©a
[1];

384 
Ëv–
;

385 
”r
;

389 
Ëv–
 = 
	`auËv–_ÿlc_dbov
(
§mpv
, 
§mpc
);

391 
d©a
[0] = ()-
Ëv–
 & 0x7f;

393 
”r
 = 
	`¹³xt_’code
(
mb
, 
au
->
extm­_auËv–
, 1, 
d©a
);

394 ià(
”r
) {

395 
	`w¬nšg
("audio:„ext_’codçed (%m)\n", 
”r
);

396  
”r
;

399  
”r
;

400 
	}
}

413 
	$’code_¹p_£nd
(
audio
 *
a
, 
autx
 *
tx
,

414 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

416 
size_t
 
äame_size
;

417 
size_t
 
§mpc_¹p
;

418 
size_t
 
Ën
;

419 
size_t
 
ext_Ën
 = 0;

420 
”r
;

422 ià(!
tx
->
ac
 || !tx->ac->
’ch
)

425 
tx
->
mb
->
pos
 =x->mb->
’d
 = 
STREAM_PRESZ
;

427 ià(
a
->
Ëv–_’abËd
) {

430 
tx
->
mb
->
pos
 +ğ
RTPEXT_HDR_SIZE
;

432 
”r
 = 
	`­³nd_¹³xt
(
a
, 
tx
->
mb
, 
§mpv
, 
§mpc
);

433 ià(
”r
)

436 
ext_Ën
 = 
tx
->
mb
->
pos
 - 
STREAM_PRESZ
;

439 
tx
->
mb
->
pos
 = 
STREAM_PRESZ
;

441 
”r
 = 
	`¹³xt_hdr_’code
(
tx
->
mb
, 
ext_Ën
 - 
RTPEXT_HDR_SIZE
);

442 ià(
”r
)

445 
tx
->
mb
->
pos
 = 
STREAM_PRESZ
 + 
ext_Ën
;

446 
tx
->
mb
->
’d
 = 
STREAM_PRESZ
 + 
ext_Ën
;

449 
Ën
 = 
	`mbuf_g‘_¥aû
(
tx
->
mb
);

451 
”r
 = 
tx
->
ac
->
	`’ch
Ñx->
’c
, 
	`mbuf_buf
Ñx->
mb
), &
Ën
, 
§mpv
, 
§mpc
);

452 ià((
”r
 & 0xffff0000) == 0x00010000) {

454 
tx
->
ts_ext
 = 
”r
 & 0xffff;

455 
”r
 = 0;

457 ià(
”r
) {

458 
	`w¬nšg
("audio: %sƒncodeƒrror: %d samples (%m)\n",

459 
tx
->
ac
->
Çme
, 
§mpc
, 
”r
);

460 
out
;

463 
tx
->
mb
->
pos
 = 
STREAM_PRESZ
;

464 
tx
->
mb
->
’d
 = 
STREAM_PRESZ
 + 
ext_Ën
 + 
Ën
;

466 ià(
	`mbuf_g‘_Ëá
(
tx
->
mb
)) {

468 
ušt32_t
 
¹p_ts
 = 
tx
->
ts_ext
 & 0xffffffff;

470 ià(
Ën
) {

471 
”r
 = 
	`¡»am_£nd
(
a
->
¡rm
, 
ext_Ën
!=0, 
tx
->
m¬k”
, -1,

472 
¹p_ts
, 
tx
->
mb
);

473 ià(
”r
)

474 
out
;

479 
§mpc_¹p
 = 
§mpc
 * 
tx
->
ac
->
ü©e
 /x->ac->
¤©e
;

486 
äame_size
 = 
§mpc_¹p
 / 
	`g‘_ch
(
tx
->
ac
);

488 
tx
->
ts_ext
 +ğ(
ušt32_t
)
äame_size
;

490 
out
:

491 
tx
->
m¬k”
 = 
çl£
;

492 
	}
}

498 
	$pŞl_aubuf_tx
(
audio
 *
a
)

500 
autx
 *
tx
 = &
a
->tx;

501 
št16_t
 *
§mpv
 = 
tx
->sampv;

502 
size_t
 
§mpc
;

503 
size_t
 
sz
;

504 
size_t
 
num_by‹s
;

505 
Ë
 *le;

506 
”r
 = 0;

508 
sz
 = 
	`aufmt_§m¶e_size
(
tx
->
¤c_fmt
);

509 ià(!
sz
)

512 
num_by‹s
 = 
tx
->
psize
;

513 
§mpc
 = 
tx
->
psize
 / 
sz
;

517 ià(
tx
->
¤c_fmt
 =ğ
AUFMT_S16LE
) {

519 
	`aubuf_»ad
(
tx
->
aubuf
, (
ušt8_t
 *éx->
§mpv
, 
num_by‹s
);

524 *
tmp_§mpv
;

526 ià(!
tx
->
Ãed_cÚv
) {

527 
	`šfo
("audio: NOTE: source sample conversion"

529 
	`aufmt_Çme
(
tx
->
¤c_fmt
),‡ufmt_Çme(
AUFMT_S16LE
));

530 
tx
->
Ãed_cÚv
 = 
Œue
;

533 
tmp_§mpv
 = 
	`mem_z®loc
(
num_by‹s
, 
NULL
);

534 ià(!
tmp_§mpv
)

537 
	`aubuf_»ad
(
tx
->
aubuf
, 
tmp_§mpv
, 
num_by‹s
);

539 
	`aucÚv_to_s16
(
§mpv
, 
tx
->
¤c_fmt
, 
tmp_§mpv
, 
§mpc
);

541 
	`mem_d”ef
(
tmp_§mpv
);

545 ià(
tx
->
»§mp
.
»§m¶e
) {

546 
size_t
 
§mpc_rs
 = 
AUDIO_SAMPSZ
;

548 
”r
 = 
	`au»§mp
(&
tx
->
»§mp
,

549 
tx
->
§mpv_rs
, &
§mpc_rs
,

550 
tx
->
§mpv
, 
§mpc
);

551 ià(
”r
)

554 
§mpv
 = 
tx
->
§mpv_rs
;

555 
§mpc
 = 
§mpc_rs
;

559 
Ë
 = 
tx
->
f
.
h—d
;†e;†ğË->
Ãxt
) {

560 
auft_’c_¡
 *
¡
 = 
Ë
->
d©a
;

562 ià(
¡
->
af
 && st->af->
’ch
)

563 
”r
 |ğ
¡
->
af
->
	`’ch
(¡, 
§mpv
, &
§mpc
);

565 ià(
”r
) {

566 
	`w¬nšg
("audio:‡uf‹¸’code: %m\n", 
”r
);

570 
	`’code_¹p_£nd
(
a
, 
tx
, 
§mpv
, 
§mpc
);

571 
	}
}

574 
	$check_‹Ëv
(
audio
 *
a
, 
autx
 *
tx
)

576 cÚ¡ 
sdp_fÜm©
 *
fmt
;

577 
boŞ
 
m¬k”
 = 
çl£
;

578 
”r
;

580 
tx
->
mb
->
pos
 =x->mb->
’d
 = 
STREAM_PRESZ
;

582 
”r
 = 
	`‹Ëv_pŞl
(
a
->
‹Ëv
, &
m¬k”
, 
tx
->
mb
);

583 ià(
”r
)

586 ià(
m¬k”
)

587 
tx
->
ts_‹l
 = (
ušt32_t
éx->
ts_ext
;

589 
fmt
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
a
)), 
‹Ëv_¹pfmt
);

590 ià(!
fmt
)

593 
tx
->
mb
->
pos
 = 
STREAM_PRESZ
;

594 
”r
 = 
	`¡»am_£nd
(
a
->
¡rm
, 
çl£
, 
m¬k”
, 
fmt
->
±
, 
tx
->
ts_‹l
,x->
mb
);

595 ià(
”r
) {

596 
	`w¬nšg
("audio:–ev: sŒ—m_£nd %m\n", 
”r
);

598 
	}
}

617 
	$au¶ay_wr™e_hªdËr
(*
§mpv
, 
size_t
 
§mpc
, *
¬g
)

619 
aurx
 *
rx
 = 
¬g
;

620 
size_t
 
num_by‹s
 = 
§mpc
 * 
	`aufmt_§m¶e_size
(
rx
->
¶ay_fmt
);

622 ià(
rx
->
aubuf_¡¬‹d
 && 
	`aubuf_cur_size
Ôx->
aubuf
è< 
num_by‹s
) {

624 ++
rx
->
¡©s
.
aubuf_und”run
;

626 
	`debug
("audio:„x‡ubuf underrun (total %llu)\n",

627 
rx
->
¡©s
.
aubuf_und”run
);

630 
	`aubuf_»ad
(
rx
->
aubuf
, 
§mpv
, 
num_by‹s
);

631 
	}
}

645 
	$au¤c_»ad_hªdËr
(cÚ¡ *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

647 
audio
 *
a
 = 
¬g
;

648 
autx
 *
tx
 = &
a
->tx;

649 
size_t
 
num_by‹s
 = 
§mpc
 * 
	`aufmt_§m¶e_size
(
tx
->
¤c_fmt
);

651 ià(
tx
->
mu‹d
)

652 
	`mem£t
((*)
§mpv
, 0, 
num_by‹s
);

654 ià(
	`aubuf_cur_size
(
tx
->
aubuf
è>ğtx->
aubuf_maxsz
) {

656 ++
tx
->
¡©s
.
aubuf_ov”run
;

658 
	`debug
("audio:x‡ubuf overrun (total %llu)\n",

659 
tx
->
¡©s
.
aubuf_ov”run
);

662 ()
	`aubuf_wr™e
(
tx
->
aubuf
, 
§mpv
, 
num_by‹s
);

664 
tx
->
aubuf_¡¬‹d
 = 
Œue
;

666 ià(
a
->
cfg
.
txmode
 =ğ
AUDIO_MODE_POLL
) {

667 
i
;

669 
i
=0; i<16; i++) {

671 ià(
	`aubuf_cur_size
(
tx
->
aubuf
è<x->
psize
)

674 
	`pŞl_aubuf_tx
(
a
);

679 
	`check_‹Ëv
(
a
, 
tx
);

680 
	}
}

683 
	$au¤c_”rÜ_hªdËr
(
”r
, cÚ¡ *
¡r
, *
¬g
)

685 
audio
 *
a
 = 
¬g
;

686 
	`MAGIC_CHECK
(
a
);

688 ià(
a
->
”rh
)

689 
a
->
	`”rh
(
”r
, 
¡r
,‡->
¬g
);

690 
	}
}

693 
	$±_hªdËr
(
audio
 *
a
, 
ušt8_t
 
±_Şd
, ušt8_ˆ
±_Ãw
)

695 cÚ¡ 
sdp_fÜm©
 *
lc
;

697 
lc
 = 
	`sdp_medŸ_lfÜm©
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
), 
±_Ãw
);

698 ià(!
lc
)

699  
ENOENT
;

701 ià(
±_Şd
 !ğ(
ušt8_t
)-1) {

702 
	`šfo
("Audio decoder changed…ayload %u -> %u\n",

703 
±_Şd
, 
±_Ãw
);

706 
a
->
rx
.
±
 = 
±_Ãw
;

708  
	`audio_decod”_£t
(
a
, 
lc
->
d©a
,†c->
±
,†c->
·¿ms
);

709 
	}
}

712 
	$hªdË_‹Ëv
(
audio
 *
a
, 
mbuf
 *
mb
)

714 
ev’t
, 
dig™
;

715 
boŞ
 
’d
;

717 ià(
	`‹Ëv_»cv
(
a
->
‹Ëv
, 
mb
, &
ev’t
, &
’d
))

720 
dig™
 = 
	`‹Ëv_code2dig™
(
ev’t
);

721 ià(
dig™
 >ğ0 && 
a
->
ev’th
)

722 
a
->
	`ev’th
(
dig™
, 
’d
,‡->
¬g
);

723 
	}
}

726 
	$aurx_¡»am_decode
(
aurx
 *
rx
, 
mbuf
 *
mb
)

728 
size_t
 
§mpc
 = 
AUDIO_SAMPSZ
;

729 
št16_t
 *
§mpv
;

730 
Ë
 *le;

731 
”r
 = 0;

734 ià(!
rx
->
ac
)

737 ià(
	`mbuf_g‘_Ëá
(
mb
)) {

738 
”r
 = 
rx
->
ac
->
	`dech
Ôx->
dec
,„x->
§mpv
, &
§mpc
,

739 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

741 ià(
rx
->
ac
->
¶ch
) {

742 
§mpc
 = 
rx
->
ac
->
¤©e
 *„x->ac->
ch
 *„x->
±ime
 / 1000;

744 
”r
 = 
rx
->
ac
->
	`¶ch
Ôx->
dec
,„x->
§mpv
, &
§mpc
);

748 
§mpc
 = 0;

751 ià(
”r
) {

752 
	`w¬nšg
("audio: %s codec decode %u bytes: %m\n",

753 
rx
->
ac
->
Çme
, 
	`mbuf_g‘_Ëá
(
mb
), 
”r
);

754 
out
;

758 
Ë
 = 
rx
->
f
.

;†e;†ğË->
´ev
) {

759 
auft_dec_¡
 *
¡
 = 
Ë
->
d©a
;

761 ià(
¡
->
af
 && st->af->
dech
)

762 
”r
 |ğ
¡
->
af
->
	`dech
(¡, 
rx
->
§mpv
, &
§mpc
);

765 ià(!
rx
->
aubuf
)

766 
out
;

768 
§mpv
 = 
rx
->sampv;

771 ià(
rx
->
»§mp
.
»§m¶e
) {

772 
size_t
 
§mpc_rs
 = 
AUDIO_SAMPSZ
;

774 
”r
 = 
	`au»§mp
(&
rx
->
»§mp
,

775 
rx
->
§mpv_rs
, &
§mpc_rs
,

776 
rx
->
§mpv
, 
§mpc
);

777 ià(
”r
)

778  
”r
;

780 
§mpv
 = 
rx
->
§mpv_rs
;

781 
§mpc
 = 
§mpc_rs
;

784 ià(
	`aubuf_cur_size
(
rx
->
aubuf
è>ğrx->
aubuf_maxsz
) {

786 ++
rx
->
¡©s
.
aubuf_ov”run
;

788 
	`debug
("audio:„x‡ubuf overrun (total %llu)\n",

789 
rx
->
¡©s
.
aubuf_ov”run
);

792 ià(
rx
->
¶ay_fmt
 =ğ
AUFMT_S16LE
) {

793 
”r
 = 
	`aubuf_wr™e_§mp
(
rx
->
aubuf
, 
§mpv
, 
§mpc
);

794 ià(
”r
)

795 
out
;

801 *
tmp_§mpv
;

802 
size_t
 
num_by‹s
 = 
§mpc
 * 
	`aufmt_§m¶e_size
(
rx
->
¶ay_fmt
);

804 ià(!
rx
->
Ãed_cÚv
) {

805 
	`šfo
("audio: NOTE:…layback sample conversion"

807 
	`aufmt_Çme
(
AUFMT_S16LE
),

808 
	`aufmt_Çme
(
rx
->
¶ay_fmt
));

809 
rx
->
Ãed_cÚv
 = 
Œue
;

812 
tmp_§mpv
 = 
	`mem_z®loc
(
num_by‹s
, 
NULL
);

813 ià(!
tmp_§mpv
)

814  
ENOMEM
;

816 
	`aucÚv_äom_s16
(
rx
->
¶ay_fmt
, 
tmp_§mpv
, 
§mpv
, 
§mpc
);

818 
”r
 = 
	`aubuf_wr™e
(
rx
->
aubuf
, 
tmp_§mpv
, 
num_by‹s
);

820 
	`mem_d”ef
(
tmp_§mpv
);

822 ià(
”r
)

823 
out
;

826 
rx
->
aubuf_¡¬‹d
 = 
Œue
;

828 
out
:

829  
”r
;

830 
	}
}

834 
	$¡»am_»cv_hªdËr
(cÚ¡ 
¹p_h—d”
 *
hdr
,

835 
¹³xt
 *
extv
, 
size_t
 
extc
,

836 
mbuf
 *
mb
, *
¬g
)

838 
audio
 *
a
 = 
¬g
;

839 
aurx
 *
rx
 = &
a
->rx;

840 
boŞ
 
disÿrd
 = 
çl£
;

841 
size_t
 
i
;

842 
w¿p
;

843 
”r
;

845 ià(!
mb
)

846 
out
;

849 ià(
hdr
->
±
 !ğ
rx
->pt) {

850 cÚ¡ 
sdp_fÜm©
 *
fmt
;

852 
fmt
 = 
	`sdp_medŸ_lfÜm©
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
), 
hdr
->
±
);

854 ià(
fmt
 && !
	`¡r_ÿ£cmp
(fmt->
Çme
, "telephone-event")) {

855 
	`hªdË_‹Ëv
(
a
, 
mb
);

861 ià(
PT_CN
 =ğ
hdr
->
±
)

866 ià(
hdr
->
±
 !ğ
rx
->pt) {

868 
”r
 = 
	`±_hªdËr
(
a
, 
rx
->
±
, 
hdr
->pt);

869 ià(
”r
)

874 
i
=0; i<
extc
; i++) {

876 ià(
extv
[
i
].
id
 =ğ
a
->
extm­_auËv–
) {

878 
a
->
rx
.
Ëv–_Ï¡
 = -()(
extv
[
i
].
d©a
[0] & 0x7f);

879 
a
->
rx
.
Ëv–_£t
 = 
Œue
;

882 
	`šfo
("audio:„tp headerƒxt ignored (id=%u)\n",

883 
extv
[
i
].
id
);

889 ià(
rx
->
ts_»cv
.
is_£t
) {

891 
ušt64_t
 
ext_Ï¡
, 
ext_now
;

893 
ext_Ï¡
 = 
	`ÿlc_ex‹nded_time¡amp
(
rx
->
ts_»cv
.
num_w¿ps
,

894 
rx
->
ts_»cv
.
Ï¡
);

896 
ext_now
 = 
	`ÿlc_ex‹nded_time¡amp
(
rx
->
ts_»cv
.
num_w¿ps
,

897 
hdr
->
ts
);

899 ià(
ext_now
 <ğ
ext_Ï¡
) {

900 
ušt64_t
 
d–
;

902 
d–
 = 
ext_Ï¡
 - 
ext_now
;

904 
	`w¬nšg
("audio: [time=%.3f]"

906 
	`aurx_ÿlc_£cÚds
(
rx
),

907 
	`audio_ÿlc_£cÚds
(
d–
, 
rx
->
ac
->
ü©e
));

909 
disÿrd
 = 
Œue
;

913 
rx
->
ts_»cv
.
fœ¡
 = 
hdr
->
ts
;

914 
rx
->
ts_»cv
.
Ï¡
 = 
hdr
->
ts
;

915 
rx
->
ts_»cv
.
is_£t
 = 
Œue
;

918 
w¿p
 = 
	`time¡amp_w¿p
(
hdr
->
ts
, 
rx
->
ts_»cv
.
Ï¡
);

920 
w¿p
) {

923 
	`w¬nšg
("audio:„tpimestamp wraps backwards"

925 (
št32_t
)(
rx
->
ts_»cv
.
Ï¡
 - 
hdr
->
ts
));

926 
disÿrd
 = 
Œue
;

933 ++
rx
->
ts_»cv
.
num_w¿ps
;

940 
rx
->
ts_»cv
.
Ï¡
 = 
hdr
->
ts
;

943 
	`»_´štf
("[time=%.3f] wrap=%d discard=%d\n",

944 
	`aurx_ÿlc_£cÚds
(
rx
), 
w¿p
, 
disÿrd
);

947 ià(
disÿrd
) {

948 ++
a
->
rx
.
n_disÿrd
;

952 
out
:

953 ()
	`aurx_¡»am_decode
(&
a
->
rx
, 
mb
);

954 
	}
}

957 
	$add_‹Ëv_codec
(
audio
 *
a
)

959 
sdp_medŸ
 *
m
 = 
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
a
));

960 
sdp_fÜm©
 *
sf
;

961 
”r
;

964 
”r
 = 
	`sdp_fÜm©_add
(&
sf
, 
m
, 
çl£
,

965 (!
	`sdp_medŸ_lfÜm©
(
m
, 101)è? "101" : 
NULL
,

966 
‹Ëv_¹pfmt
, 
TELEV_SRATE
, 1, 
NULL
,

967 
NULL
, NULL, 
çl£
, "0-15");

968 ià(
”r
)

969  
”r
;

971  
”r
;

972 
	}
}

980 
	$£t_ebuac_·¿ms
(
audio
 *
au
, 
ušt32_t
 
±ime
)

982 
sdp_medŸ
 *
sdp
 = 
	`¡»am_sdpmedŸ
(
au
->
¡rm
);

983 cÚ¡ 
cÚfig_avt
 *
avt
 = &
au
->
¡rm
->
cfg
;

984 
¡r
[64];

985 
jbv®ue
 = 0;

986 
jb_id
 = 0;

987 
”r
 = 0;

990 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
sdp
, 
çl£
, "ebuacip", "version %i", 0);

993 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
sdp
, 
çl£
, "ebuac", "jb %i", 
jb_id
);

996 ià(0 =ğ
	`cÚf_g‘_¡r
(
	`cÚf_cur
(), "ebuac_jb_ty³",
¡r
,(str))) {

998 ià(0 =ğ
	`¡r_cmp
(
¡r
, "auto")) {

1000 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
sdp
, 
çl£
,

1003 
jb_id
,

1004 
avt
->
jbuf_d–
.
mš
 * 
±ime
,

1005 
avt
->
jbuf_d–
.
max
 * 
±ime
);

1007 ià(0 =ğ
	`¡r_cmp
(
¡r
, "fixed")) {

1010 
jbv®ue
 = 
avt
->
jbuf_d–
.
max
 * 
±ime
;

1012 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
sdp
, 
çl£
,

1015 
jb_id
, 
jbv®ue
);

1020 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
sdp
, 
çl£
, "ebuacip", "qosrec %u",

1021 
avt
->
¹p_tos
 / 4);

1025  
”r
;

1026 
	}
}

1029 
	$audio_®loc
(
audio
 **
­
, cÚ¡ 
¡»am_·¿m
 *
¡»am_´m
,

1030 cÚ¡ 
cÚfig
 *
cfg
,

1031 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
, 
Ïb–
,

1032 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

1033 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

1034 
ušt32_t
 
±ime
, cÚ¡ 
li¡
 *
aucodeş
, 
boŞ
 
ofã»r
,

1035 
audio_ev’t_h
 *
ev’th
, 
audio_”r_h
 *
”rh
, *
¬g
)

1037 
audio
 *
a
;

1038 
autx
 *
tx
;

1039 
aurx
 *
rx
;

1040 
Ë
 *le;

1041 
”r
;

1042 ()
ofã»r
;

1044 ià(!
­
 || !
cfg
)

1045  
EINVAL
;

1047 
a
 = 
	`mem_z®loc
((*a), 
audio_de¡ruùÜ
);

1048 ià(!
a
)

1049  
ENOMEM
;

1051 
	`MAGIC_INIT
(
a
);

1053 
a
->
cfg
 = cfg->
audio
;

1054 
tx
 = &
a
->tx;

1055 
rx
 = &
a
->rx;

1057 
tx
->
¤c_fmt
 = 
cfg
->
audio
.src_fmt;

1058 
rx
->
¶ay_fmt
 = 
cfg
->
audio
.play_fmt;

1060 
”r
 = 
	`¡»am_®loc
(&
a
->
¡rm
, 
¡»am_´m
, &
cfg
->
avt
, 
ÿÎ
, 
sdp_£ss
,

1061 "audio", 
Ïb–
,

1062 
mÇt
, 
mÇt_£ss
, 
m’c
, 
m’c_£ss
,

1063 
	`ÿÎ_loÿluri
(
ÿÎ
),

1064 
¡»am_»cv_hªdËr
, 
NULL
, 
a
);

1065 ià(
”r
)

1066 
out
;

1068 ià(
cfg
->
avt
.
¹p_bw
.
max
) {

1069 
	`¡»am_£t_bw
(
a
->
¡rm
, 
AUDIO_BANDWIDTH
);

1072 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
), 
Œue
,

1073 "±ime", "%u", 
±ime
);

1074 ià(
”r
)

1075 
out
;

1077 ià(
cfg
->
audio
.
Ëv–
 && 
ofã»r
) {

1079 
a
->
extm­_auËv–
 = 1;

1081 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
), 
Œue
,

1084 
a
->
extm­_auËv–
, 
uri_auËv–
);

1085 ià(
”r
)

1086 
out
;

1089 ià(
cfg
->
sdp
.
ebuac
) {

1091 
”r
 = 
	`£t_ebuac_·¿ms
(
a
, 
±ime
);

1092 ià(
”r
)

1093 
out
;

1097 
Ë
 = 
	`li¡_h—d
(
aucodeş
);†e;†ğË->
Ãxt
) {

1098 
”r
 = 
	`add_audio_codec
(
a
, 
	`¡»am_sdpmedŸ
×->
¡rm
), 
Ë
->
d©a
);

1099 ià(
”r
)

1100 
out
;

1103 
tx
->
mb
 = 
	`mbuf_®loc
(
STREAM_PRESZ
 + 4096);

1104 
tx
->
§mpv
 = 
	`mem_z®loc
(
AUDIO_SAMPSZ
 * (
št16_t
), 
NULL
);

1105 
rx
->
§mpv
 = 
	`mem_z®loc
(
AUDIO_SAMPSZ
 * (
št16_t
), 
NULL
);

1106 ià(!
tx
->
mb
 || !tx->
§mpv
 || !
rx
->sampv) {

1107 
”r
 = 
ENOMEM
;

1108 
out
;

1111 
”r
 = 
	`‹Ëv_®loc
(&
a
->
‹Ëv
, 
±ime
);

1112 ià(
”r
)

1113 
out
;

1115 
”r
 = 
	`add_‹Ëv_codec
(
a
);

1116 ià(
”r
)

1117 
out
;

1119 
	`au»§mp_š™
(&
tx
->
»§mp
);

1120 
	`¡r_nıy
(
tx
->
deviû
, 
a
->
cfg
.
¤c_dev
, (tx->device));

1121 
tx
->
±ime
 =…time;

1122 
tx
->
ts_ext
 =x->
ts_ba£
 = 
	`¿nd_u16
();

1123 
tx
->
m¬k”
 = 
Œue
;

1125 
	`au»§mp_š™
(&
rx
->
»§mp
);

1126 
	`¡r_nıy
(
rx
->
deviû
, 
a
->
cfg
.
¶ay_dev
, (rx->device));

1127 
rx
->
±
 = -1;

1128 
rx
->
±ime
 =…time;

1130 
a
->
ev’th
 =ƒventh;

1131 
a
->
”rh
 =ƒrrh;

1132 
a
->
¬g
 =‡rg;

1134 
out
:

1135 ià(
”r
)

1136 
	`mem_d”ef
(
a
);

1138 *
­
 = 
a
;

1140  
”r
;

1141 
	}
}

1144 #ifdeà
HAVE_PTHREAD


1145 *
	$tx_th»ad
(*
¬g
)

1147 
audio
 *
a
 = 
¬g
;

1148 
autx
 *
tx
 = &
a
->tx;

1149 
ušt64_t
 
ts
 = 0;

1151 
a
->
tx
.
u
.
thr
.
run
) {

1153 
ušt64_t
 
now
;

1155 
	`sys_m¦“p
(4);

1157 ià(!
tx
->
aubuf_¡¬‹d
)

1160 ià(!
a
->
tx
.
u
.
thr
.
run
)

1163 
now
 = 
	`tmr_jiff›s
();

1164 ià(!
ts
)

1165 
ts
 = 
now
;

1167 ià(
ts
 > 
now
)

1172 ià(
	`aubuf_cur_size
(
tx
->
aubuf
è>ğtx->
psize
) {

1174 
	`pŞl_aubuf_tx
(
a
);

1177 ++
tx
->
¡©s
.
aubuf_und”run
;

1179 
	`debug
("audio:hread:x‡ubuf underrun"

1180 " (tÙ® %Îu)\n", 
tx
->
¡©s
.
aubuf_und”run
);

1183 
ts
 +ğ
tx
->
±ime
;

1186  
NULL
;

1187 
	}
}

1191 
	$auft_·¿m_£t
(
auft_´m
 *
´m
,

1192 cÚ¡ 
aucodec
 *
ac
, 
ušt32_t
 
±ime
)

1194 ià(!
ac
) {

1195 
	`mem£t
(
´m
, 0, (*prm));

1199 
´m
->
¤©e
 = 
	`g‘_¤©e
(
ac
);

1200 
´m
->
ch
 = 
	`g‘_ch
(
ac
);

1201 
´m
->
±ime
 =…time;

1202 
	}
}

1205 
	$autx_´št_p–še
(
»_´štf
 *
pf
, cÚ¡ 
autx
 *autx)

1207 
Ë
 *le;

1208 
”r
;

1210 ià(!
autx
)

1213 
”r
 = 
	`»_h´štf
(
pf
, "audiox…ipeline: %10s",

1214 
autx
->
au¤c
 ?‡utx->au¤c->
as
->
Çme
 : "src");

1216 
Ë
 = 
	`li¡_h—d
(&
autx
->
f
);†e;†ğË->
Ãxt
) {

1217 
auft_’c_¡
 *
¡
 = 
Ë
->
d©a
;

1219 ià(
¡
->
af
->
’ch
)

1220 
”r
 |ğ
	`»_h´štf
(
pf
, " ---> %s", 
¡
->
af
->
Çme
);

1223 
”r
 |ğ
	`»_h´štf
(
pf
, " ---> %s\n",

1224 
autx
->
ac
 ?‡utx->ac->
Çme
 : "encoder");

1226  
”r
;

1227 
	}
}

1230 
	$aurx_´št_p–še
(
»_´štf
 *
pf
, cÚ¡ 
aurx
 *aurx)

1232 
Ë
 *le;

1233 
”r
;

1235 ià(!
aurx
)

1238 
”r
 = 
	`»_h´štf
(
pf
, "audio„x…ipeline: %10s",

1239 
aurx
->
au¶ay
 ?‡urx->au¶ay->
­
->
Çme
 : "play");

1241 
Ë
 = 
	`li¡_h—d
(&
aurx
->
f
);†e;†ğË->
Ãxt
) {

1242 
auft_dec_¡
 *
¡
 = 
Ë
->
d©a
;

1244 ià(
¡
->
af
->
dech
)

1245 
”r
 |ğ
	`»_h´štf
(
pf
, " <--- %s", 
¡
->
af
->
Çme
);

1248 
”r
 |ğ
	`»_h´štf
(
pf
, " <--- %s\n",

1249 
aurx
->
ac
 ?‡urx->ac->
Çme
 : "decoder");

1251  
”r
;

1252 
	}
}

1264 
	$auft_£tup
(
audio
 *
a
)

1266 
auft_´m
 
’ırm
, 
deırm
;

1267 
autx
 *
tx
 = &
a
->tx;

1268 
aurx
 *
rx
 = &
a
->rx;

1269 
Ë
 *le;

1270 
”r
 = 0;

1273 ià(!
tx
->
ac
 || !
rx
->ac)

1276 ià(!
	`li¡_i£m±y
(&
tx
->
f
è|| !li¡_i£m±y(&
rx
->filtl))

1279 
	`auft_·¿m_£t
(&
’ırm
, 
tx
->
ac
,x->
±ime
);

1280 
	`auft_·¿m_£t
(&
deırm
, 
rx
->
ac
,„x->
±ime
);

1283 
Ë
 = 
	`li¡_h—d
(
	`b¬es_auf
());†e;†ğË->
Ãxt
) {

1284 
auft
 *
af
 = 
Ë
->
d©a
;

1285 
auft_’c_¡
 *
’c¡
 = 
NULL
;

1286 
auft_dec_¡
 *
dec¡
 = 
NULL
;

1287 *
ùx
 = 
NULL
;

1289 ià(
af
->
’cupdh
) {

1290 
”r
 |ğ
af
->
	`’cupdh
(&
’c¡
, &
ùx
,‡f, &
’ırm
);

1291 ià(
”r
)

1294 
’c¡
->
af
 =‡f;

1295 
	`li¡_­³nd
(&
tx
->
f
, &
’c¡
->
Ë
,ƒncst);

1298 ià(
af
->
decupdh
) {

1299 
”r
 |ğ
af
->
	`decupdh
(&
dec¡
, &
ùx
,‡f, &
deırm
);

1300 ià(
”r
)

1303 
dec¡
->
af
 =‡f;

1304 
	`li¡_­³nd
(&
rx
->
f
, &
dec¡
->
Ë
, decst);

1307 ià(
”r
) {

1308 
	`w¬nšg
("audio:‡udio-filter '%s'"

1309 " upd©çed (%m)\n", 
af
->
Çme
, 
”r
);

1315 
	}
}

1318 
	$¡¬t_¶ay”
(
aurx
 *
rx
, 
audio
 *
a
)

1320 cÚ¡ 
aucodec
 *
ac
 = 
rx
->ac;

1321 
ušt32_t
 
¤©e_d¥
 = 
	`g‘_¤©e
(
ac
);

1322 
ušt32_t
 
chªÃls_d¥
;

1323 
boŞ
 
»§mp
 = 
çl£
;

1324 
”r
;

1326 ià(!
ac
)

1329 
chªÃls_d¥
 = 
	`g‘_ch
(
ac
);

1331 ià(
a
->
cfg
.
¤©e_¶ay
 &&‡->cfg.¤©e_¶ay !ğ
¤©e_d¥
) {

1332 
»§mp
 = 
Œue
;

1333 
¤©e_d¥
 = 
a
->
cfg
.
¤©e_¶ay
;

1335 ià(
a
->
cfg
.
chªÃls_¶ay
 &&‡->cfg.chªÃls_¶ay !ğ
chªÃls_d¥
) {

1336 
»§mp
 = 
Œue
;

1337 
chªÃls_d¥
 = 
a
->
cfg
.
chªÃls_¶ay
;

1341 ià(
»§mp
 && !
rx
->
§mpv_rs
) {

1343 
	`šfo
("audio:ƒnable‡uplay„esampler:"

1345 
	`g‘_¤©e
(
ac
), 
	`g‘_ch
×c), 
¤©e_d¥
, 
chªÃls_d¥
);

1347 
rx
->
§mpv_rs
 = 
	`mem_z®loc
(
AUDIO_SAMPSZ
 * 2, 
NULL
);

1348 ià(!
rx
->
§mpv_rs
)

1349  
ENOMEM
;

1351 
”r
 = 
	`au»§mp_£tup
(&
rx
->
»§mp
,

1352 
	`g‘_¤©e
(
ac
), 
	`g‘_ch
(ac),

1353 
¤©e_d¥
, 
chªÃls_d¥
);

1354 ià(
”r
) {

1355 
	`w¬nšg
("audio: could‚ot setup‡uplay„esampler"

1356 " (%m)\n", 
”r
);

1357  
”r
;

1362 ià(!
rx
->
au¶ay
 && 
	`au¶ay_fšd
(
	`b¬es_au¶ayl
(), 
NULL
)) {

1364 
au¶ay_´m
 
´m
;

1366 
´m
.
¤©e
 = 
¤©e_d¥
;

1367 
´m
.
ch
 = 
chªÃls_d¥
;

1368 
´m
.
±ime
 = 
rx
->ptime;

1369 
´m
.
fmt
 = 
rx
->
¶ay_fmt
;

1371 ià(!
rx
->
aubuf
) {

1372 
size_t
 
psize
;

1373 
size_t
 
sz
 = 
	`aufmt_§m¶e_size
(
rx
->
¶ay_fmt
);

1375 
psize
 = 
sz
 * 
	`ÿlc_n§mp
(
´m
.
¤©e
,…rm.
ch
,…rm.
±ime
);

1377 
rx
->
aubuf_maxsz
 = 
psize
 * 8;

1379 
”r
 = 
	`aubuf_®loc
(&
rx
->
aubuf
, 
psize
 * 1,

1380 
rx
->
aubuf_maxsz
);

1381 ià(
”r
)

1382  
”r
;

1385 
”r
 = 
	`au¶ay_®loc
(&
rx
->
au¶ay
, 
	`b¬es_au¶ayl
(),

1386 
a
->
cfg
.
¶ay_mod
,

1387 &
´m
, 
rx
->
deviû
,

1388 
au¶ay_wr™e_hªdËr
, 
rx
);

1389 ià(
”r
) {

1390 
	`w¬nšg
("audio: start_player failed (%s.%s): %m\n",

1391 
a
->
cfg
.
¶ay_mod
, 
rx
->
deviû
, 
”r
);

1392  
”r
;

1395 
rx
->
au¶ay_´m
 = 
´m
;

1397 
	`šfo
("audio:…layer started with sample format %s\n",

1398 
	`aufmt_Çme
(
rx
->
¶ay_fmt
));

1402 
	}
}

1405 
	$¡¬t_sourû
(
autx
 *
tx
, 
audio
 *
a
)

1407 cÚ¡ 
aucodec
 *
ac
 = 
tx
->ac;

1408 
ušt32_t
 
¤©e_d¥
 = 
	`g‘_¤©e
(
ac
);

1409 
ušt32_t
 
chªÃls_d¥
;

1410 
boŞ
 
»§mp
 = 
çl£
;

1411 
”r
;

1413 ià(!
ac
)

1416 
chªÃls_d¥
 = 
	`g‘_ch
(
ac
);

1418 ià(
a
->
cfg
.
¤©e_¤c
 &&‡->cfg.¤©e_¤ø!ğ
¤©e_d¥
) {

1419 
»§mp
 = 
Œue
;

1420 
¤©e_d¥
 = 
a
->
cfg
.
¤©e_¤c
;

1422 ià(
a
->
cfg
.
chªÃls_¤c
 &&‡->cfg.chªÃls_¤ø!ğ
chªÃls_d¥
) {

1423 
»§mp
 = 
Œue
;

1424 
chªÃls_d¥
 = 
a
->
cfg
.
chªÃls_¤c
;

1428 ià(
»§mp
 && !
tx
->
§mpv_rs
) {

1430 
	`šfo
("audio:ƒnable‡usrc„esampler:"

1432 
	`g‘_¤©e
(
ac
), 
	`g‘_ch
×c), 
¤©e_d¥
, 
chªÃls_d¥
);

1434 
tx
->
§mpv_rs
 = 
	`mem_z®loc
(
AUDIO_SAMPSZ
 * 2, 
NULL
);

1435 ià(!
tx
->
§mpv_rs
)

1436  
ENOMEM
;

1438 
”r
 = 
	`au»§mp_£tup
(&
tx
->
»§mp
,

1439 
¤©e_d¥
, 
chªÃls_d¥
,

1440 
	`g‘_¤©e
(
ac
), 
	`g‘_ch
(ac));

1441 ià(
”r
) {

1442 
	`w¬nšg
("audio: could‚ot setup‡usrc„esampler"

1443 " (%m)\n", 
”r
);

1444  
”r
;

1449 ià(!
tx
->
au¤c
 && 
	`au¤c_fšd
(
	`b¬es_au¤ş
(), 
NULL
)) {

1451 
au¤c_´m
 
´m
;

1452 
size_t
 
sz
;

1454 
´m
.
¤©e
 = 
¤©e_d¥
;

1455 
´m
.
ch
 = 
chªÃls_d¥
;

1456 
´m
.
±ime
 = 
tx
->ptime;

1457 
´m
.
fmt
 = 
tx
->
¤c_fmt
;

1459 
sz
 = 
	`aufmt_§m¶e_size
(
tx
->
¤c_fmt
);

1461 
tx
->
psize
 = 
sz
 * 
	`ÿlc_n§mp
(
´m
.
¤©e
,…rm.
ch
,…rm.
±ime
);

1463 
tx
->
aubuf_maxsz
 =x->
psize
 * 30;

1465 ià(!
tx
->
aubuf
) {

1466 
”r
 = 
	`aubuf_®loc
(&
tx
->
aubuf
,x->
psize
,

1467 
tx
->
aubuf_maxsz
);

1468 ià(
”r
)

1469  
”r
;

1472 
”r
 = 
	`au¤c_®loc
(&
tx
->
au¤c
, 
	`b¬es_au¤ş
(),

1473 
NULL
, 
a
->
cfg
.
¤c_mod
,

1474 &
´m
, 
tx
->
deviû
,

1475 
au¤c_»ad_hªdËr
, 
au¤c_”rÜ_hªdËr
, 
a
);

1476 ià(
”r
) {

1477 
	`w¬nšg
("audio: start_source failed (%s.%s): %m\n",

1478 
a
->
cfg
.
¤c_mod
, 
tx
->
deviû
, 
”r
);

1479  
”r
;

1482 
a
->
cfg
.
txmode
) {

1483 #ifdeà
HAVE_PTHREAD


1484 
AUDIO_MODE_THREAD
:

1485 ià(!
tx
->
u
.
thr
.
run
) {

1486 
tx
->
u
.
thr
.
run
 = 
Œue
;

1487 
”r
 = 
	`±h»ad_ü—‹
(&
tx
->
u
.
thr
.
tid
, 
NULL
,

1488 
tx_th»ad
, 
a
);

1489 ià(
”r
) {

1490 
tx
->
u
.
thr
.
tid
 = 
çl£
;

1491  
”r
;

1501 
tx
->
au¤c_´m
 = 
´m
;

1503 
	`šfo
("audio: source started with sample format %s\n",

1504 
	`aufmt_Çme
(
tx
->
¤c_fmt
));

1508 
	}
}

1518 
	$audio_¡¬t
(
audio
 *
a
)

1520 
”r
;

1522 ià(!
a
)

1523  
EINVAL
;

1526 ià(!
	`li¡_i£m±y
(
	`b¬es_auf
())) {

1527 
”r
 = 
	`auft_£tup
(
a
);

1528 ià(
”r
)

1529  
”r
;

1533 ià(
a
->
cfg
.
¤c_fœ¡
) {

1534 
”r
 = 
	`¡¬t_sourû
(&
a
->
tx
,‡);

1535 
”r
 |ğ
	`¡¬t_¶ay”
(&
a
->
rx
,‡);

1538 
”r
 = 
	`¡¬t_¶ay”
(&
a
->
rx
,‡);

1539 
”r
 |ğ
	`¡¬t_sourû
(&
a
->
tx
,‡);

1541 ià(
”r
)

1542  
”r
;

1544 ià(
a
->
tx
.
ac
 &&‡->
rx
.ac) {

1546 ià(!
a
->
¡¬‹d
) {

1547 
	`šfo
("%H%H",

1548 
autx_´št_p–še
, &
a
->
tx
,

1549 
aurx_´št_p–še
, &
a
->
rx
);

1552 
a
->
¡¬‹d
 = 
Œue
;

1555  
”r
;

1556 
	}
}

1564 
	$audio_¡İ
(
audio
 *
a
)

1566 ià(!
a
)

1569 
	`¡İ_tx
(&
a
->
tx
,‡);

1570 
	`¡İ_rx
(&
a
->
rx
);

1571 
	}
}

1574 
	$audio_’cod”_£t
(
audio
 *
a
, cÚ¡ 
aucodec
 *
ac
,

1575 
±_tx
, cÚ¡ *
·¿ms
)

1577 
autx
 *
tx
;

1578 
”r
 = 0;

1579 
boŞ
 
»£t
;

1581 ià(!
a
 || !
ac
)

1582  
EINVAL
;

1584 
tx
 = &
a
->tx;

1586 
»£t
 = !
	`aucodec_equ®
(
ac
, 
tx
->ac);

1588 ià(
ac
 !ğ
tx
->ac) {

1589 
	`šfo
("audio: Set‡udioƒncoder: %s %uHz %dch\n",

1590 
ac
->
Çme
, 
	`g‘_¤©e
×c), 
	`g‘_ch
(ac));

1593 ià(
»£t
) {

1594 
tx
->
au¤c
 = 
	`mem_d”ef
(tx->ausrc);

1597 
tx
->
’c
 = 
	`mem_d”ef
(tx->enc);

1598 
tx
->
ac
 =‡c;

1601 ià(
ac
->
’cupdh
) {

1602 
au’c_·¿m
 
´m
;

1604 
´m
.
±ime
 = 
tx
->ptime;

1606 
”r
 = 
ac
->
	`’cupdh
(&
tx
->
’c
,‡c, &
´m
, 
·¿ms
);

1607 ià(
”r
) {

1608 
	`w¬nšg
("audio:‡Îoø’cod”: %m\n", 
”r
);

1609  
”r
;

1613 
	`¡»am_£t_¤©e
(
a
->
¡rm
, 
ac
->
ü©e
,‡c->crate);

1614 
	`¡»am_upd©e_’cod”
(
a
->
¡rm
, 
±_tx
);

1616 
	`‹Ëv_£t_¤©e
(
a
->
‹Ëv
, 
ac
->
ü©e
);

1618 ià(!
tx
->
au¤c
) {

1619 
”r
 |ğ
	`audio_¡¬t
(
a
);

1622  
”r
;

1623 
	}
}

1626 
	$audio_decod”_£t
(
audio
 *
a
, cÚ¡ 
aucodec
 *
ac
,

1627 
±_rx
, cÚ¡ *
·¿ms
)

1629 
aurx
 *
rx
;

1630 
boŞ
 
»£t
 = 
çl£
;

1631 
”r
 = 0;

1633 ià(!
a
 || !
ac
)

1634  
EINVAL
;

1636 
rx
 = &
a
->rx;

1638 
»£t
 = !
	`aucodec_equ®
(
ac
, 
rx
->ac);

1640 ià(
ac
 !ğ
rx
->ac) {

1642 
	`šfo
("audio: Set‡udio decoder: %s %uHz %dch\n",

1643 
ac
->
Çme
, 
	`g‘_¤©e
×c), 
	`g‘_ch
(ac));

1645 
rx
->
±
 = 
±_rx
;

1646 
rx
->
ac
 =‡c;

1647 
rx
->
dec
 = 
	`mem_d”ef
(rx->dec);

1650 ià(
ac
->
decupdh
) {

1651 
”r
 = 
ac
->
	`decupdh
(&
rx
->
dec
,‡c, 
·¿ms
);

1652 ià(
”r
) {

1653 
	`w¬nšg
("audio:‡Îoødecod”: %m\n", 
”r
);

1654  
”r
;

1658 
	`¡»am_£t_¤©e
(
a
->
¡rm
, 
ac
->
ü©e
,‡c->crate);

1660 ià(
»£t
) {

1662 
rx
->
au¶ay
 = 
	`mem_d”ef
(rx->auplay);

1665 
	`li¡_æush
(&
rx
->
f
);

1667 
”r
 |ğ
	`audio_¡¬t
(
a
);

1670  
”r
;

1671 
	}
}

1679 
	$audio_’cod”_cyşe
(
audio
 *audio)

1681 cÚ¡ 
sdp_fÜm©
 *
rc
 = 
NULL
;

1683 ià(!
audio
)

1686 
rc
 = 
	`sdp_medŸ_fÜm©_cyşe
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
audio
)));

1687 ià(!
rc
) {

1688 
	`šfo
("audio:ƒncoder cycle:‚o„emote codec found\n");

1692 ()
	`audio_’cod”_£t
(
audio
, 
rc
->
d©a
,„c->
±
,„c->
·¿ms
);

1693 
	}
}

1696 
¡»am
 *
	$audio_¡rm
(cÚ¡ 
audio
 *
a
)

1698  
a
 ?‡->
¡rm
 : 
NULL
;

1699 
	}
}

1702 
	$audio_£nd_dig™
(
audio
 *
a
, 
key
)

1704 
”r
 = 0;

1706 ià(!
a
)

1707  
EINVAL
;

1709 ià(
key
 !ğ
KEYCODE_REL
) {

1710 
ev’t
 = 
	`‹Ëv_dig™2code
(
key
);

1711 
	`šfo
("audio: s’d DTMF dig™: '%c'\n", 
key
);

1713 ià(
ev’t
 == -1) {

1714 
	`w¬nšg
("audio: inv®id DTMF dig™ (0x%02x)\n", 
key
);

1715  
EINVAL
;

1718 
”r
 = 
	`‹Ëv_£nd
(
a
->
‹Ëv
, 
ev’t
, 
çl£
);

1720 ià(
a
->
tx
.
cur_key
 &&‡->tx.cur_key !ğ
KEYCODE_REL
) {

1722 
	`šfo
("audio: s’d DTMF dig™ƒnd: '%c'\n", 
a
->
tx
.
cur_key
);

1723 
”r
 = 
	`‹Ëv_£nd
(
a
->
‹Ëv
,

1724 
	`‹Ëv_dig™2code
(
a
->
tx
.
cur_key
), 
Œue
);

1727 
a
->
tx
.
cur_key
 = 
key
;

1729  
”r
;

1730 
	}
}

1739 
	$audio_mu‹
(
audio
 *
a
, 
boŞ
 
mu‹d
)

1741 ià(!
a
)

1744 
a
->
tx
.
mu‹d
 = muted;

1745 
	}
}

1755 
boŞ
 
	$audio_ismu‹d
(cÚ¡ 
audio
 *
a
)

1757 ià(!
a
)

1758  
çl£
;

1760  
a
->
tx
.
mu‹d
;

1761 
	}
}

1764 
boŞ
 
	$extm­_hªdËr
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, *
¬g
)

1766 
audio
 *
au
 = 
¬g
;

1767 
sdp_extm­
 
extm­
;

1768 
”r
;

1769 ()
Çme
;

1771 
”r
 = 
	`sdp_extm­_decode
(&
extm­
, 
v®ue
);

1772 ià(
”r
) {

1773 
	`w¬nšg
("audio: sdp_extm­_decod”rÜ (%m)\n", 
”r
);

1774  
çl£
;

1777 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
extm­
.
Çme
, 
uri_auËv–
)) {

1779 ià(
extm­
.
id
 < 
RTPEXT_ID_MIN
 ||ƒxtm­.id > 
RTPEXT_ID_MAX
) {

1780 
	`w¬nšg
("audio:ƒxtmap id out of„ange (%u)\n",

1781 
extm­
.
id
);

1782  
çl£
;

1785 
au
->
extm­_auËv–
 = 
extm­
.
id
;

1787 
”r
 = 
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
au
->
¡rm
), 
Œue
,

1790 
au
->
extm­_auËv–
,

1791 
uri_auËv–
);

1792 ià(
”r
)

1793  
çl£
;

1795 
au
->
Ëv–_’abËd
 = 
Œue
;

1796 
	`šfo
("audio: client-to-mixer‡udio†evelsƒnabled\n");

1799  
çl£
;

1800 
	}
}

1803 
	$audio_sdp_©Œ_decode
(
audio
 *
a
)

1805 cÚ¡ *
©Œ
;

1807 ià(!
a
)

1812 
©Œ
 = 
	`sdp_medŸ_¿‰r
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
), "ptime");

1813 ià(
©Œ
) {

1814 
autx
 *
tx
 = &
a
->tx;

1815 
ušt32_t
 
±ime_tx
 = 
	`©oi
(
©Œ
);

1817 ià(
±ime_tx
 &&…time_tx !ğ
a
->
tx
.
±ime
) {

1819 
	`šfo
("audio:…eer changed…time_tx %ums -> %ums\n",

1820 
a
->
tx
.
±ime
, 
±ime_tx
);

1822 
tx
->
±ime
 = 
±ime_tx
;

1824 ià(
tx
->
ac
) {

1825 
tx
->
psize
 = 2 * 
	`g‘_äamesize
Ñx->
ac
,

1826 
±ime_tx
);

1832 ià(
a
->
cfg
.
Ëv–
) {

1833 
	`sdp_medŸ_¿‰r_­¶y
(
	`¡»am_sdpmedŸ
(
a
->
¡rm
),

1835 
extm­_hªdËr
, 
a
);

1837 
	}
}

1848 
	$audio_Ëv–_g‘
(cÚ¡ 
audio
 *
au
, *
Ëv–p
)

1850 ià(!
au
)

1851  
EINVAL
;

1853 ià(!
au
->
Ëv–_’abËd
)

1854  
ENOTSUP
;

1856 ià(!
au
->
rx
.
Ëv–_£t
)

1857  
ENOENT
;

1859 ià(
Ëv–p
)

1860 *
Ëv–p
 = 
au
->
rx
.
Ëv–_Ï¡
;

1863 
	}
}

1866 
	$aucodec_´št
(
»_´štf
 *
pf
, cÚ¡ 
aucodec
 *
ac
)

1868 ià(!
ac
)

1871  
	`»_h´štf
(
pf
, "%s %uHz/%dch",

1872 
ac
->
Çme
, 
	`g‘_¤©e
×c), 
	`g‘_ch
(ac));

1873 
	}
}

1876 
	$audio_debug
(
»_´štf
 *
pf
, cÚ¡ 
audio
 *
a
)

1878 cÚ¡ 
autx
 *
tx
;

1879 cÚ¡ 
aurx
 *
rx
;

1880 
size_t
 
sztx
, 
szrx
;

1881 
”r
;

1883 ià(!
a
)

1886 
tx
 = &
a
->tx;

1887 
rx
 = &
a
->rx;

1889 
sztx
 = 
	`aufmt_§m¶e_size
(
tx
->
¤c_fmt
);

1890 
szrx
 = 
	`aufmt_§m¶e_size
(
rx
->
¶ay_fmt
);

1892 
”r
 = 
	`»_h´štf
(
pf
, "\n--- Audio stream ---\n");

1894 
”r
 |ğ
	`»_h´štf
(
pf
, "x: %H…time=%ums\n",

1895 
aucodec_´št
, 
tx
->
ac
,

1896 
tx
->
±ime
);

1897 
”r
 |ğ
	`»_h´štf
(
pf
, "‡ubuf: %H"

1899 
aubuf_debug
, 
tx
->
aubuf
,

1900 
	`ÿlc_±ime
(
	`aubuf_cur_size
(
tx
->
aubuf
)/
sztx
,

1901 
tx
->
au¤c_´m
.
¤©e
,

1902 
tx
->
au¤c_´m
.
ch
),

1903 
	`ÿlc_±ime
(
tx
->
aubuf_maxsz
/
sztx
,

1904 
tx
->
au¤c_´m
.
¤©e
,

1905 
tx
->
au¤c_´m
.
ch
),

1906 
tx
->
¡©s
.
aubuf_ov”run
,

1907 
tx
->
¡©s
.
aubuf_und”run
);

1909 
”r
 |ğ
	`»_h´štf
(
pf
, "ime = %.3f sec\n",

1910 
	`autx_ÿlc_£cÚds
(
tx
));

1912 
”r
 |ğ
	`»_h´štf
(
pf
,

1915 
aucodec_´št
, 
rx
->
ac
,

1916 
rx
->
±ime
,„x->
±
);

1917 
”r
 |ğ
	`»_h´štf
(
pf
, "‡ubuf: %H"

1919 
aubuf_debug
, 
rx
->
aubuf
,

1920 
	`ÿlc_±ime
(
	`aubuf_cur_size
(
rx
->
aubuf
)/
szrx
,

1921 
rx
->
au¶ay_´m
.
¤©e
,

1922 
rx
->
au¶ay_´m
.
ch
),

1923 
	`ÿlc_±ime
(
rx
->
aubuf_maxsz
/
szrx
,

1924 
rx
->
au¶ay_´m
.
¤©e
,

1925 
rx
->
au¶ay_´m
.
ch
),

1926 
rx
->
¡©s
.
aubuf_ov”run
,

1927 
rx
->
¡©s
.
aubuf_und”run


1930 
”r
 |ğ
	`»_h´štf
(
pf
, "‚_discard:%llu\n",

1931 
rx
->
n_disÿrd
);

1932 ià(
rx
->
Ëv–_£t
) {

1933 
”r
 |ğ
	`»_h´štf
(
pf
, "†evel %.3f dBov\n",

1934 
rx
->
Ëv–_Ï¡
);

1936 ià(
rx
->
ts_»cv
.
is_£t
) {

1937 
”r
 |ğ
	`»_h´štf
(
pf
, "ime = %.3f sec\n",

1938 
	`aurx_ÿlc_£cÚds
(
rx
));

1941 
”r
 |ğ
	`»_h´štf
(
pf
, "ime = (not started)\n");

1944 
”r
 |ğ
	`»_h´štf
(
pf
,

1947 
autx_´št_p–še
, 
tx
,

1948 
aurx_´št_p–še
, 
rx
);

1950 
”r
 |ğ
	`¡»am_debug
(
pf
, 
a
->
¡rm
);

1952  
”r
;

1953 
	}
}

1956 
	$audio_£t_deviûÇme
(
audio
 *
a
, cÚ¡ *
¤c
, cÚ¡ *
¶ay
)

1958 ià(!
a
)

1961 
	`¡r_nıy
(
a
->
tx
.
deviû
, 
¤c
, (a->tx.device));

1962 
	`¡r_nıy
(
a
->
rx
.
deviû
, 
¶ay
, (a->rx.device));

1963 
	}
}

1966 
	$audio_£t_sourû
(
audio
 *
au
, cÚ¡ *
mod
, cÚ¡ *
deviû
)

1968 
autx
 *
tx
;

1969 
”r
;

1971 ià(!
au
)

1972  
EINVAL
;

1974 
tx
 = &
au
->tx;

1977 
tx
->
au¤c
 = 
	`mem_d”ef
(tx->ausrc);

1979 
”r
 = 
	`au¤c_®loc
(&
tx
->
au¤c
, 
	`b¬es_au¤ş
(),

1980 
NULL
, 
mod
, &
tx
->
au¤c_´m
, 
deviû
,

1981 
au¤c_»ad_hªdËr
, 
au¤c_”rÜ_hªdËr
, 
au
);

1982 ià(
”r
) {

1983 
	`w¬nšg
("audio: set_source failed (%s.%s): %m\n",

1984 
mod
, 
deviû
, 
”r
);

1985  
”r
;

1989 
	}
}

1992 
	$audio_£t_¶ay”
(
audio
 *
au
, cÚ¡ *
mod
, cÚ¡ *
deviû
)

1994 
aurx
 *
rx
;

1995 
”r
;

1997 ià(!
au
)

1998  
EINVAL
;

2000 
rx
 = &
au
->rx;

2003 
rx
->
au¶ay
 = 
	`mem_d”ef
(rx->auplay);

2005 
”r
 = 
	`au¶ay_®loc
(&
rx
->
au¶ay
, 
	`b¬es_au¶ayl
(),

2006 
mod
, &
rx
->
au¶ay_´m
, 
deviû
,

2007 
au¶ay_wr™e_hªdËr
, 
rx
);

2008 ià(
”r
) {

2009 
	`w¬nšg
("audio: set_player failed (%s.%s): %m\n",

2010 
mod
, 
deviû
, 
”r
);

2011  
”r
;

2015 
	}
}

2023 
	$audio_´št_¹p¡©
(
»_´štf
 *
pf
, cÚ¡ 
audio
 *
a
)

2025 cÚ¡ 
¡»am
 *
s
;

2026 cÚ¡ 
¹ı_¡©s
 *
¹ı
;

2027 
¤©e_tx
 = 8000;

2028 
¤©e_rx
 = 8000;

2029 
”r
;

2031 ià(!
a
)

2034 
s
 = 
a
->
¡rm
;

2035 
¹ı
 = &
s
->
¹ı_¡©s
;

2037 ià(!
¹ı
->
tx
.
£Á
)

2040 ià(
a
->
tx
.
ac
)

2041 
¤©e_tx
 = 
	`g‘_¤©e
(
a
->
tx
.
ac
);

2042 ià(
a
->
rx
.
ac
)

2043 
¤©e_rx
 = 
	`g‘_¤©e
(
a
->
rx
.
ac
);

2045 
”r
 = 
	`»_h´štf
(
pf
,

2055 
	`ÿÎ_£tup_du¿tiÚ
(
s
->
ÿÎ
) * 1000,

2056 
	`ÿÎ_du¿tiÚ
(
s
->
ÿÎ
),

2058 
s
->
m‘ric_rx
.
n_·ck‘s
,

2059 
s
->
m‘ric_tx
.
n_·ck‘s
,

2061 
¹ı
->
rx
.
lo¡
,„tı->
tx
.lost,

2063 
s
->
m‘ric_rx
.
n_”r
, s->
m‘ric_tx
.n_err,

2066 1.0 * 
¹ı
->
rx
.
j™
/1000 * (
¤©e_rx
/1000),

2067 1.0 * 
¹ı
->
tx
.
j™
/1000 * (
¤©e_tx
/1000),

2069 
	`sdp_medŸ_Ïddr
(
s
->
sdp
),

2070 
	`sdp_medŸ_¿ddr
(
s
->
sdp
)

2073 ià(
a
->
tx
.
ac
) {

2074 
”r
 |ğ
	`»_h´štf
(
pf
, ";EN=%s/%d", 
a
->
tx
.
ac
->
Çme
, 
¤©e_tx
 );

2076 ià(
a
->
rx
.
ac
) {

2077 
”r
 |ğ
	`»_h´štf
(
pf
, ";DE=%s/%d", 
a
->
rx
.
ac
->
Çme
, 
¤©e_rx
 );

2080  
”r
;

2081 
	}
}

	@baresip/src/aufilt.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

11 
	$auft_»gi¡”
(
li¡
 *
auf
, 
auft
 *
af
)

13 ià(!
auf
 || !
af
)

16 
	`li¡_­³nd
(
auf
, &
af
->
Ë
,‡f);

18 
	`šfo
("auft: %s\n", 
af
->
Çme
);

19 
	}
}

22 
	$auft_uÄegi¡”
(
auft
 *
af
)

24 ià(!
af
)

27 
	`li¡_uÆšk
(&
af
->
Ë
);

28 
	}
}

	@baresip/src/aulevel.c

7 
	~<m©h.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"cÜe.h
"

39 
	$ÿlc_rms
(cÚ¡ 
št16_t
 *
d©a
, 
size_t
 
Ën
)

41 
sum
 = 0;

42 
size_t
 
i
;

44 ià(!
d©a
 || !
Ën
)

47 
i
 = 0; i < 
Ën
; i++) {

48 cÚ¡ 
§m¶e
 = 
d©a
[
i
];

50 
sum
 +ğ
§m¶e
 * sample;

53  
	`sq¹
(
sum
 / ()
Ën
);

54 
	}
}

67 
	$auËv–_ÿlc_dbov
(cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

69 cÚ¡ 
³ak
 = 32767.0;

70 
rms
, 
dbov
;

72 ià(!
§mpv
 || !
§mpc
)

73  
AULEVEL_MIN
;

75 
rms
 = 
	`ÿlc_rms
(
§mpv
, 
§mpc
è/ 
³ak
;

77 
dbov
 = 20 * 
	`log10
(
rms
);

79 ià(
dbov
 < 
AULEVEL_MIN
)

80 
dbov
 = 
AULEVEL_MIN
;

81 ià(
dbov
 > 
AULEVEL_MAX
)

82 
dbov
 = 
AULEVEL_MAX
;

84  
dbov
;

85 
	}
}

	@baresip/src/auplay.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
	$de¡ruùÜ
(*
¬g
)

14 
au¶ay
 *
­
 = 
¬g
;

16 
	`li¡_uÆšk
(&
­
->
Ë
);

17 
	}
}

30 
	$au¶ay_»gi¡”
(
au¶ay
 **
­p
, 
li¡
 *
au¶ayl
,

31 cÚ¡ *
Çme
, 
au¶ay_®loc_h
 *
®loch
)

33 
au¶ay
 *
­
;

35 ià(!
­p
)

36  
EINVAL
;

38 
­
 = 
	`mem_z®loc
((*­), 
de¡ruùÜ
);

39 ià(!
­
)

40  
ENOMEM
;

42 
	`li¡_­³nd
(
au¶ayl
, &
­
->
Ë
,‡p);

44 
­
->
Çme
 =‚ame;

45 
­
->
®loch
 =‡lloch;

47 
	`šfo
("au¶ay: %s\n", 
Çme
);

49 *
­p
 = 
­
;

52 
	}
}

63 cÚ¡ 
au¶ay
 *
	$au¶ay_fšd
(cÚ¡ 
li¡
 *
au¶ayl
, cÚ¡ *
Çme
)

65 
Ë
 *le;

67 
Ë
=
	`li¡_h—d
(
au¶ayl
);†e;†eöe->
Ãxt
) {

69 
au¶ay
 *
­
 = 
Ë
->
d©a
;

71 ià(
	`¡r_is£t
(
Çme
è&& 0 !ğ
	`¡r_ÿ£cmp
Òame, 
­
->name))

74  
­
;

77  
NULL
;

78 
	}
}

94 
	$au¶ay_®loc
(
au¶ay_¡
 **
¡p
, 
li¡
 *
au¶ayl
,

95 cÚ¡ *
Çme
,

96 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

97 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

99 
au¶ay
 *
­
;

101 
­
 = (
au¶ay
 *)
	`au¶ay_fšd
(
au¶ayl
, 
Çme
);

102 ià(!
­
)

103  
ENOENT
;

105 ià(!
´m
->
¤©e
 || !´m->
ch
)

106  
EINVAL
;

108  
­
->
	`®loch
(
¡p
,‡p, 
´m
, 
deviû
, 
wh
, 
¬g
);

109 
	}
}

	@baresip/src/ausrc.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
	$de¡ruùÜ
(*
¬g
)

14 
au¤c
 *
as
 = 
¬g
;

16 
	`li¡_uÆšk
(&
as
->
Ë
);

17 
	}
}

30 
	$au¤c_»gi¡”
(
au¤c
 **
a¥
, 
li¡
 *
au¤ş
,

31 cÚ¡ *
Çme
, 
au¤c_®loc_h
 *
®loch
)

33 
au¤c
 *
as
;

35 ià(!
a¥
)

36  
EINVAL
;

38 
as
 = 
	`mem_z®loc
((*as), 
de¡ruùÜ
);

39 ià(!
as
)

40  
ENOMEM
;

42 
	`li¡_­³nd
(
au¤ş
, &
as
->
Ë
,‡s);

44 
as
->
Çme
 =‚ame;

45 
as
->
®loch
 =‡lloch;

47 
	`šfo
("au¤c: %s\n", 
Çme
);

49 *
a¥
 = 
as
;

52 
	}
}

63 cÚ¡ 
au¤c
 *
	$au¤c_fšd
(cÚ¡ 
li¡
 *
au¤ş
, cÚ¡ *
Çme
)

65 
Ë
 *le;

67 
Ë
=
	`li¡_h—d
(
au¤ş
);†e;†eöe->
Ãxt
) {

69 
au¤c
 *
as
 = 
Ë
->
d©a
;

71 ià(
	`¡r_is£t
(
Çme
è&& 0 !ğ
	`¡r_ÿ£cmp
Òame, 
as
->name))

74  
as
;

77  
NULL
;

78 
	}
}

96 
	$au¤c_®loc
(
au¤c_¡
 **
¡p
, 
li¡
 *
au¤ş
,

97 
medŸ_ùx
 **
ùx
,

98 cÚ¡ *
Çme
, 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

99 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

101 
au¤c
 *
as
;

103 
as
 = (
au¤c
 *)
	`au¤c_fšd
(
au¤ş
, 
Çme
);

104 ià(!
as
)

105  
ENOENT
;

107  
as
->
	`®loch
(
¡p
,‡s, 
ùx
, 
´m
, 
deviû
, 
rh
, 
”rh
, 
¬g
);

108 
	}
}

	@baresip/src/baresip.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

15 
	sb¬es
 {

16 
ÃtwÜk
 *
	mÃt
;

17 
cÚùs
 
	mcÚùs
;

18 
commªds
 *
	mcommªds
;

19 
¶ay”
 *
	m¶ay”
;

20 
mes§ge
 *
	mmes§ge
;

21 
li¡
 
	mmÇ
;

22 
li¡
 
	mm’ş
;

23 
li¡
 
	maucodeş
;

24 
li¡
 
	mau¤ş
;

25 
li¡
 
	mau¶ayl
;

26 
li¡
 
	mauf
;

27 
li¡
 
	mvidcodeş
;

28 
li¡
 
	mvid¤ş
;

29 
li¡
 
	mvidi¥l
;

30 
li¡
 
	mvidf
;

31 
ui_sub
 
	muis
;

32 } 
	gb¬es
;

35 
	$cmd_qu™
(
»_´štf
 *
pf
, *
unu£d
)

37 
”r
;

39 ()
unu£d
;

41 
”r
 = 
	`»_h´štf
(
pf
, "Quit\n");

43 
	`ua_¡İ_®l
(
çl£
);

45  
”r
;

46 
	}
}

49 
	$šsmod_hªdËr
(
»_´štf
 *
pf
, *
¬g
)

51 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

52 
”r
;

54 
”r
 = 
	`moduË_lßd
(
ÿrg
->
´m
);

55 ià(
”r
) {

56  
	`»_h´štf
(
pf
, "insmod: ERROR: could‚ot†oad module"

57 " '%s': %m\n", 
ÿrg
->
´m
, 
”r
);

60  
	`»_h´štf
(
pf
, "lßded moduË %s\n", 
ÿrg
->
´m
);

61 
	}
}

64 
	$rmmod_hªdËr
(
»_´štf
 *
pf
, *
¬g
)

66 cÚ¡ 
cmd_¬g
 *
ÿrg
 = 
¬g
;

67 ()
pf
;

69 
	`moduË_uÆßd
(
ÿrg
->
´m
);

72 
	}
}

75 cÚ¡ 
cmd
 
	gcÜecmdv
[] = {

76 {"qu™", 'q', 0, "Qu™", 
cmd_qu™
 },

77 {"šsmod", 0, 
CMD_PRM
, "Lßd moduË", 
šsmod_hªdËr
 },

78 {"rmmod", 0, 
CMD_PRM
, "UÆßd moduË", 
rmmod_hªdËr
 },

82 
	$b¬es_š™
(
cÚfig
 *
cfg
, 
boŞ
 
´eãr_v6
)

84 
”r
;

86 ià(!
cfg
)

87  
EINVAL
;

89 
b¬es
.
Ãt
 = 
	`mem_d”ef
(baresip.net);

91 
	`li¡_š™
(&
b¬es
.
mÇ
);

92 
	`li¡_š™
(&
b¬es
.
m’ş
);

93 
	`li¡_š™
(&
b¬es
.
aucodeş
);

94 
	`li¡_š™
(&
b¬es
.
au¤ş
);

95 
	`li¡_š™
(&
b¬es
.
au¶ayl
);

96 
	`li¡_š™
(&
b¬es
.
vidcodeş
);

97 
	`li¡_š™
(&
b¬es
.
vid¤ş
);

98 
	`li¡_š™
(&
b¬es
.
vidi¥l
);

99 
	`li¡_š™
(&
b¬es
.
vidf
);

102 
”r
 = 
	`Ãt_®loc
(&
b¬es
.
Ãt
, &
cfg
->net,

103 
´eãr_v6
 ? 
AF_INET6
 : 
AF_INET
);

104 ià(
”r
) {

105 
	`w¬nšg
("ua:‚‘wÜk in™ faed: %m\n", 
”r
);

106  
”r
;

109 
”r
 = 
	`cÚù_š™
(&
b¬es
.
cÚùs
);

110 ià(
”r
)

111  
”r
;

113 
”r
 = 
	`cmd_š™
(&
b¬es
.
commªds
);

114 ià(
”r
)

115  
”r
;

117 
”r
 = 
	`¶ay_š™
(&
b¬es
.
¶ay”
);

118 ià(
”r
)

119  
”r
;

121 
”r
 = 
	`mes§ge_š™
(&
b¬es
.
mes§ge
);

122 ià(
”r
) {

123 
	`w¬nšg
("b¬es: mes§gš™ faed: %m\n", 
”r
);

124  
”r
;

127 
”r
 = 
	`cmd_»gi¡”
(
b¬es
.
commªds
, 
cÜecmdv
, 
	`ARRAY_SIZE
(corecmdv));

128 ià(
”r
)

129  
”r
;

132 
	}
}

135 
	$b¬es_şo£
()

137 
	`cmd_uÄegi¡”
(
b¬es
.
commªds
, 
cÜecmdv
);

139 
b¬es
.
mes§ge
 = 
	`mem_d”ef
(baresip.message);

140 
b¬es
.
¶ay”
 = 
	`mem_d”ef
(baresip.player);

141 
b¬es
.
commªds
 = 
	`mem_d”ef
(baresip.commands);

142 
	`cÚù_şo£
(&
b¬es
.
cÚùs
);

144 
b¬es
.
Ãt
 = 
	`mem_d”ef
(baresip.net);

146 
	`ui_»£t
(&
b¬es
.
uis
);

147 
	}
}

150 
ÃtwÜk
 *
	$b¬es_ÃtwÜk
()

152  
b¬es
.
Ãt
;

153 
	}
}

156 
cÚùs
 *
	$b¬es_cÚùs
()

158  &
b¬es
.
cÚùs
;

159 
	}
}

162 
commªds
 *
	$b¬es_commªds
()

164  
b¬es
.
commªds
;

165 
	}
}

168 
¶ay”
 *
	$b¬es_¶ay”
()

170  
b¬es
.
¶ay”
;

171 
	}
}

174 
li¡
 *
	$b¬es_mÇ
()

176  &
b¬es
.
mÇ
;

177 
	}
}

180 
li¡
 *
	$b¬es_m’ş
()

182  &
b¬es
.
m’ş
;

183 
	}
}

186 
mes§ge
 *
	$b¬es_mes§ge
()

188  
b¬es
.
mes§ge
;

189 
	}
}

197 
li¡
 *
	$b¬es_aucodeş
()

199  &
b¬es
.
aucodeş
;

200 
	}
}

203 
li¡
 *
	$b¬es_au¤ş
()

205  &
b¬es
.
au¤ş
;

206 
	}
}

209 
li¡
 *
	$b¬es_au¶ayl
()

211  &
b¬es
.
au¶ayl
;

212 
	}
}

215 
li¡
 *
	$b¬es_auf
()

217  &
b¬es
.
auf
;

218 
	}
}

221 
li¡
 *
	$b¬es_vidcodeş
()

223  &
b¬es
.
vidcodeş
;

224 
	}
}

227 
li¡
 *
	$b¬es_vid¤ş
()

229  &
b¬es
.
vid¤ş
;

230 
	}
}

233 
li¡
 *
	$b¬es_vidi¥l
()

235  &
b¬es
.
vidi¥l
;

236 
	}
}

239 
li¡
 *
	$b¬es_vidf
()

241  &
b¬es
.
vidf
;

242 
	}
}

245 
ui_sub
 *
	$b¬es_uis
()

247  &
b¬es
.
uis
;

248 
	}
}

	@baresip/src/bfcp.c

6 
	~<¡dlib.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
	sbfı
 {

13 
bfı_cÚn
 *
	mcÚn
;

14 
sdp_medŸ
 *
	msdpm
;

15 
mÇt_medŸ
 *
	mmÇt_¡
;

16 
boŞ
 
	maùive
;

19 
ušt32_t
 
	mlcÚfid
;

20 
ušt16_t
 
	mlu£rid
;

24 
	$de¡ruùÜ
(*
¬g
)

26 
bfı
 *bfı = 
¬g
;

28 
	`mem_d”ef
(
bfı
->
mÇt_¡
);

29 
	`mem_d”ef
(
bfı
->
sdpm
);

30 
	`mem_d”ef
(
bfı
->
cÚn
);

31 
	}
}

34 cÚ¡ *
	$bfı_sdp_Œª¥
(
bfı_Œª¥
 

)

36 

) {

38 
BFCP_UDP
:  "UDP/BFCP";

39 
BFCP_DTLS
:  "UDP/TLS/BFCP";

40 :  
NULL
;

42 
	}
}

45 
bfı_Œª¥
 
	$¡r2
(cÚ¡ *
´Ùo
)

47 ià(0 =ğ
	`¡r_ÿ£cmp
(
´Ùo
, "udp"))

48  
BFCP_UDP
;

49 ià(0 =ğ
	`¡r_ÿ£cmp
(
´Ùo
, "dtls"))

50  
BFCP_DTLS
;

52 
	`w¬nšg
("unsuµÜ‹d BFCP…rÙocŞ: %s\n", 
´Ùo
);

55 
	}
}

58 
	$bfı_»¥_hªdËr
(
”r
, cÚ¡ 
bfı_msg
 *
msg
, *
¬g
)

60 
bfı
 *bfı = 
¬g
;

61 ()
bfı
;

63 ià(
”r
) {

64 
	`w¬nšg
("bfı:ƒ¼Ü„e¥Ú£: %m\n", 
”r
);

68 
	`šfo
("bfcp:„eceived BFCP„esponse: '%s'\n",

69 
	`bfı_´im_Çme
(
msg
->
´im
));

70 
	}
}

73 
	$bfı_msg_hªdËr
(cÚ¡ 
bfı_msg
 *
msg
, *
¬g
)

75 
bfı
 *bfı = 
¬g
;

77 
	`šfo
("bfı:„eûived BFCP mes§g'%s'\n", 
	`bfı_´im_Çme
(
msg
->
´im
));

79 
msg
->
´im
) {

81 
BFCP_HELLO
:

82 ()
	`bfı_»¶y
(
bfı
->
cÚn
, 
msg
, 
BFCP_HELLO_ACK
, 0);

86 ()
	`bfı_”•ly
(
bfı
->
cÚn
, 
msg
, 
BFCP_UNKNOWN_PRIM
);

89 
	}
}

92 
	$bfı_®loc
(
bfı
 **
bfıp
, 
sdp_£ssiÚ
 *
sdp_£ss
,

93 cÚ¡ *
´Ùo
, 
boŞ
 
ofã»r
,

94 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess)

96 
bfı
 *bfcp;

97 
§
 
Ïddr
;

98 
bfı_Œª¥
 
Œª¥
;

99 
”r
;

101 ià(!
bfıp
 || !
sdp_£ss
)

102  
EINVAL
;

104 
Œª¥
 = 
	`¡r2
(
´Ùo
);

106 
bfı
 = 
	`mem_z®loc
((*bfı), 
de¡ruùÜ
);

107 ià(!
bfı
)

108  
ENOMEM
;

110 
bfı
->
aùive
 = 
ofã»r
;

112 
	`§_š™
(&
Ïddr
, 
AF_INET
);

114 
”r
 = 
	`bfı_li¡’
(&
bfı
->
cÚn
, 
Œª¥
, &
Ïddr
, 
	`uag_s
(),

115 
bfı_msg_hªdËr
, 
bfı
);

116 ià(
”r
)

117 
out
;

119 
”r
 = 
	`sdp_medŸ_add
(&
bfı
->
sdpm
, 
sdp_£ss
, "application",

120 
	`§_pÜt
(&
Ïddr
), 
	`bfı_sdp_Œª¥
(
Œª¥
));

121 ià(
”r
)

122 
out
;

124 
”r
 = 
	`sdp_fÜm©_add
(
NULL
, 
bfı
->
sdpm
, 
çl£
, "*", NULL,

125 0, 0, 
NULL
, NULL, NULL, 
çl£
, NULL);

126 ià(
”r
)

127 
out
;

129 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
bfı
->
sdpm
, 
Œue
, "floorctrl", "c-s");

130 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
bfı
->
sdpm
, 
Œue
, "setup",

131 
bfı
->
aùive
 ? "active" : "actpass");

133 ià(
bfı
->
aùive
) {

134 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
bfı
->
sdpm
, 
Œue
,

138 
bfı
->
lcÚfid
 = 1000 + (
	`¿nd_u16
() & 0xf);

139 
bfı
->
lu£rid
 = 1 + (
	`¿nd_u16
() & 0x7);

141 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
bfı
->
sdpm
, 
Œue
, "confid",

142 "%u", 
bfı
->
lcÚfid
);

143 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
bfı
->
sdpm
, 
Œue
, "userid",

144 "%u", 
bfı
->
lu£rid
);

147 ià(
”r
)

148 
out
;

150 ià(
mÇt
) {

151 
	`šfo
("bfı:ƒÇbËd medŸÇˆ'%s' oÀUDP sock‘\n", 
mÇt
->
id
);

153 
”r
 = 
mÇt
->
	`medŸh
(&
bfı
->
mÇt_¡
, 
mÇt_£ss
, 
IPPROTO_UDP
,

154 
	`bfı_sock
(
bfı
->
cÚn
), 
NULL
, bfı->
sdpm
);

155 ià(
”r
)

156 
out
;

159 
	`šfo
("bfcp: %s BFCP‡gent…rotocol '%s' on…ort %d\n",

160 
bfı
->
aùive
 ? "Active" : "Passive",

161 
´Ùo
, 
	`§_pÜt
(&
Ïddr
));

163 
out
:

164 ià(
”r
)

165 
	`mem_d”ef
(
bfı
);

167 *
bfıp
 = 
bfı
;

169  
”r
;

170 
	}
}

173 
	$bfı_¡¬t
(
bfı
 *bfcp)

175 cÚ¡ 
§
 *
·ddr
;

176 
ušt32_t
 
cÚfid
 = 0;

177 
ušt16_t
 
u£rid
 = 0;

178 
”r
 = 0;

180 ià(!
bfı
)

181  
EINVAL
;

183 ià(!
	`sdp_medŸ_½Üt
(
bfı
->
sdpm
)) {

184 
	`šfo
("bfcp channel is disabled\n");

188 ià(
bfı
->
aùive
) {

190 
·ddr
 = 
	`sdp_medŸ_¿ddr
(
bfı
->
sdpm
);

191 
cÚfid
 = 
	`sdp_medŸ_¿‰r_u32
(
bfı
->
sdpm
, "confid");

192 
u£rid
 = 
	`sdp_medŸ_¿‰r_u32
(
bfı
->
sdpm
, "userid");

194 
”r
 = 
	`bfı_»que¡
(
bfı
->
cÚn
, 
·ddr
, 
BFCP_VER2
, 
BFCP_HELLO
,

195 
cÚfid
, 
u£rid
, 
bfı_»¥_hªdËr
, 
bfı
, 0);

198  
”r
;

199 
	}
}

	@baresip/src/call.c

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<ùy³.h
>

10 
	~<time.h
>

11 
	~<».h
>

12 
	~<b¬es.h
>

13 
	~"cÜe.h
"

17 
	#MAGIC
 0xÿ11ÿ11

	)

18 
	~"magic.h
"

21 
	#FOREACH_STREAM
 \

22 
Ë
 = 
ÿÎ
->
¡»aml
.
h—d
;†e;†ğË->
Ãxt
)

	)

26 
	mPTIME
 = 20,

31 
	e¡©e
 {

32 
	mSTATE_IDLE
 = 0,

33 
	mSTATE_INCOMING
,

34 
	mSTATE_OUTGOING
,

35 
	mSTATE_RINGING
,

36 
	mSTATE_EARLY
,

37 
	mSTATE_ESTABLISHED
,

38 
	mSTATE_TERMINATED


42 
	sÿÎ
 {

43 
MAGIC_DECL


44 
Ë
 
	mË
;

45 
ua
 *
	mua
;

46 
accouÁ
 *
	macc
;

47 
s£ss
 *
	m£ss
;

48 
sdp_£ssiÚ
 *
	msdp
;

49 
ssub
 *
	msub
;

50 
snÙ
 *
	mnÙ
;

51 
li¡
 
	m¡»aml
;

52 
audio
 *
	maudio
;

53 #ifdeà
USE_VIDEO


54 
video
 *
	mvideo
;

55 
bfı
 *
	mbfı
;

57 
¡©e
 
	m¡©e
;

58 *
	mloÿl_uri
;

59 *
	mloÿl_Çme
;

60 *
	m³”_uri
;

61 *
	m³”_Çme
;

62 
tmr
 
	mtmr_šv
;

63 
tmr
 
	mtmr_dtmf
;

64 
time_t
 
	mtime_¡¬t
;

65 
time_t
 
	mtime_cÚn
;

66 
time_t
 
	mtime_¡İ
;

67 
boŞ
 
	moutgošg
;

68 
boŞ
 
	mgÙ_ofãr
;

69 
boŞ
 
	mÚ_hŞd
;

70 
mÇt_£ss
 *
	mmÇts
;

71 
boŞ
 
	mmÇt_wa™
;

72 
m’c_£ss
 *
	mm’cs
;

73 
	maf
;

74 
ušt16_t
 
	mscode
;

75 
ÿÎ_ev’t_h
 *
	meh
;

76 
ÿÎ_dtmf_h
 *
	mdtmfh
;

77 *
	m¬g
;

79 
cÚfig_avt
 
	mcÚfig_avt
;

80 
cÚfig_ÿÎ
 
	mcÚfig_ÿÎ
;

82 
ušt32_t
 
	m¹p_timeout_ms
;

83 
ušt32_t
 
	mlš’um
;

87 
£nd_šv™e
(
ÿÎ
 *call);

90 cÚ¡ *
	$¡©e_Çme
(
¡©e
 
¡
)

92 
¡
) {

94 
STATE_IDLE
:  "IDLE";

95 
STATE_INCOMING
:  "INCOMING";

96 
STATE_OUTGOING
:  "OUTGOING";

97 
STATE_RINGING
:  "RINGING";

98 
STATE_EARLY
:  "EARLY";

99 
STATE_ESTABLISHED
:  "ESTABLISHED";

100 
STATE_TERMINATED
:  "TERMINATED";

103 
	}
}

106 
	$£t_¡©e
(
ÿÎ
 *ÿÎ, 
¡©e
 
¡
)

108 
ÿÎ
->
¡©e
 = 
¡
;

109 
	}
}

112 
	$ÿÎ_¡»am_¡¬t
(
ÿÎ
 *ÿÎ, 
boŞ
 
aùive
)

114 cÚ¡ 
sdp_fÜm©
 *
sc
;

115 
”r
;

118 
sc
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
ÿÎ
->
audio
)), 
NULL
);

119 ià(
sc
) {

120 
aucodec
 *
ac
 = 
sc
->
d©a
;

122 ià(
ac
) {

123 
”r
 = 
	`audio_’cod”_£t
(
ÿÎ
->
audio
, 
sc
->
d©a
,

124 
sc
->
±
, sc->
·¿ms
);

125 ià(
”r
) {

126 
	`w¬nšg
("call: start:"

127 "‡udio_’cod”_£ˆ”rÜ: %m\n", 
”r
);

129 
”r
 |ğ
	`audio_decod”_£t
(
ÿÎ
->
audio
, 
sc
->
d©a
,

130 
sc
->
±
, sc->
·¿ms
);

131 ià(
”r
) {

132 
	`w¬nšg
("call: start:"

133 "‡udio_decod”_£ˆ”rÜ: %m\n", 
”r
);

136 ià(!
”r
) {

137 
”r
 = 
	`audio_¡¬t
(
ÿÎ
->
audio
);

138 ià(
”r
) {

139 
	`w¬nšg
("call: start:"

141 
”r
);

146 
	`šfo
("call:‚o common‡udio-codecs..\n");

150 
	`šfo
("call:‡udio stream is disabled..\n");

153 #ifdeà
USE_VIDEO


155 
sc
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`video_¡rm
(
ÿÎ
->
video
)), 
NULL
);

156 ià(
sc
) {

157 
”r
 = 
	`video_’cod”_£t
(
ÿÎ
->
video
, 
sc
->
d©a
, sc->
±
,

158 
sc
->
·¿ms
);

159 
”r
 |ğ
	`video_decod”_£t
(
ÿÎ
->
video
, 
sc
->
d©a
, sc->
±
,

160 
sc
->
½¬ams
);

161 ià(!
”r
 && !
	`video_is_¡¬‹d
(
ÿÎ
->
video
)) {

162 
”r
 = 
	`video_¡¬t
(
ÿÎ
->
video
, c®l->
³”_uri
);

164 ià(
”r
) {

165 
	`w¬nšg
("ÿÎ: videØ¡»amƒ¼Ü: %m\n", 
”r
);

168 ià(
ÿÎ
->
video
) {

169 
	`šfo
("call: video stream is disabled..\n");

172 ià(
ÿÎ
->
bfı
) {

173 
”r
 = 
	`bfı_¡¬t
(
ÿÎ
->
bfı
);

174 ià(
”r
) {

175 
	`w¬nšg
("ÿÎ: could‚Ù s¹ BFCP: %m\n", 
”r
);

180 ià(
aùive
) {

181 
Ë
 *le;

183 
	`tmr_ÿnûl
(&
ÿÎ
->
tmr_šv
);

184 
ÿÎ
->
time_¡¬t
 = 
	`time
(
NULL
);

186 
FOREACH_STREAM
 {

187 
	`¡»am_»£t
(
Ë
->
d©a
);

190 
	}
}

193 
	$ÿÎ_¡»am_¡İ
(
ÿÎ
 *call)

195 ià(!
ÿÎ
)

198 
ÿÎ
->
time_¡İ
 = 
	`time
(
NULL
);

201 
	`audio_¡İ
(
ÿÎ
->
audio
);

204 #ifdeà
USE_VIDEO


205 
	`video_¡İ
(
ÿÎ
->
video
);

208 
	`tmr_ÿnûl
(&
ÿÎ
->
tmr_šv
);

209 
	}
}

212 
	$ÿÎ_ev’t_hªdËr
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t
 
ev
,

213 cÚ¡ *
fmt
, ...)

215 
ÿÎ_ev’t_h
 *
eh
 = 
ÿÎ
->eh;

216 *
eh_¬g
 = 
ÿÎ
->
¬g
;

217 
buf
[256];

218 
va_li¡
 
­
;

220 ià(!
eh
)

223 
	`va_¡¬t
(
­
, 
fmt
);

224 ()
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

225 
	`va_’d
(
­
);

227 
	`eh
(
ÿÎ
, 
ev
, 
buf
, 
eh_¬g
);

228 
	}
}

231 
	$šv™e_timeout
(*
¬g
)

233 
ÿÎ
 *ÿÎ = 
¬g
;

235 
	`šfo
("%s: Localimeout‡fter %u seconds\n",

236 
ÿÎ
->
³”_uri
, c®l->
cÚfig_ÿÎ
.
loÿl_timeout
);

238 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "Localimeout");

239 
	}
}

243 
	$mÇt_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

244 *
¬g
)

246 
ÿÎ
 *ÿÎ = 
¬g
;

247 
	`MAGIC_CHECK
(
ÿÎ
);

249 ià(
”r
) {

250 
	`w¬nšg
("call: medianat '%s' failed: %m\n",

251 
ÿÎ
->
acc
->
mÇtid
, 
”r
);

252 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "%m", 
”r
);

255 ià(
scode
) {

256 
	`w¬nšg
("ÿÎ: medŸÇˆçed: %u %s\n", 
scode
, 
»asÚ
);

257 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "%u %s",

258 
scode
, 
»asÚ
);

262 
	`šfo
("ÿÎ: medŸ-Çˆ`%s'ƒ¡ablished\n", 
ÿÎ
->
acc
->
mÇtid
);

265 ià(!
ÿÎ
->
mÇt_wa™
) {

266 
	`šfo
("call: medianatƒstablished -- sending Re-INVITE\n");

267 ()
	`ÿÎ_modify
(
ÿÎ
);

271 
ÿÎ
->
mÇt_wa™
 = 
çl£
;

273 
ÿÎ
->
¡©e
) {

275 
STATE_OUTGOING
:

276 ()
	`£nd_šv™e
(
ÿÎ
);

279 
STATE_INCOMING
:

280 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_INCOMING
, c®l->
³”_uri
);

286 
	}
}

289 
	$upd©e_medŸ
(
ÿÎ
 *call)

291 cÚ¡ 
sdp_fÜm©
 *
sc
;

292 
Ë
 *le;

293 
”r
 = 0;

295 
	`debug
("call: update media\n");

298 
	`audio_sdp_©Œ_decode
(
ÿÎ
->
audio
);

300 #ifdeà
USE_VIDEO


301 ià(
ÿÎ
->
video
)

302 
	`video_sdp_©Œ_decode
(
ÿÎ
->
video
);

306 
FOREACH_STREAM
 {

307 
	`¡»am_upd©e
(
Ë
->
d©a
);

310 ià(
ÿÎ
->
acc
->
mÇt
 && c®l->acc->mÇt->
upd©eh
 && c®l->
mÇts
)

311 
”r
 = 
ÿÎ
->
acc
->
mÇt
->
	`upd©eh
(ÿÎ->
mÇts
);

313 
sc
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
ÿÎ
->
audio
)), 
NULL
);

314 ià(
sc
) {

315 
aucodec
 *
ac
 = 
sc
->
d©a
;

316 ià(
ac
) {

317 
”r
 = 
	`audio_decod”_£t
(
ÿÎ
->
audio
, 
sc
->
d©a
,

318 
sc
->
±
, sc->
·¿ms
);

319 
”r
 |ğ
	`audio_’cod”_£t
(
ÿÎ
->
audio
, 
sc
->
d©a
,

320 
sc
->
±
, sc->
·¿ms
);

323 
	`šfo
("no common‡udio-codecs..\n");

327 
	`šfo
("audio stream is disabled..\n");

330 #ifdeà
USE_VIDEO


331 
sc
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`video_¡rm
(
ÿÎ
->
video
)), 
NULL
);

332 ià(
sc
) {

333 
”r
 = 
	`video_’cod”_£t
(
ÿÎ
->
video
, 
sc
->
d©a
,

334 
sc
->
±
, sc->
·¿ms
);

335 ià(
”r
) {

336 
	`w¬nšg
("ÿÎ: videØ¡»amƒ¼Ü: %m\n", 
”r
);

337  
”r
;

340 ià(!
	`video_is_¡¬‹d
(
ÿÎ
->
video
)) {

341 
”r
 = 
	`video_¡¬t
(
ÿÎ
->
video
, c®l->
³”_uri
);

342 ià(
”r
) {

343 
	`w¬nšg
("call: update: failedo"

344 " s¹ videØ(%m)\n", 
”r
);

348 ià(
ÿÎ
->
video
) {

349 
	`šfo
("video stream is disabled..\n");

350 
	`video_¡İ
(
ÿÎ
->
video
);

354  
”r
;

355 
	}
}

358 
	$´št_summ¬y
(cÚ¡ 
ÿÎ
 *call)

360 
ušt32_t
 
dur
 = 
	`ÿÎ_du¿tiÚ
(
ÿÎ
);

361 ià(!
dur
)

364 
	`šfo
("%s: Call with %serminated (duration: %H)\n",

365 
ÿÎ
->
loÿl_uri
, c®l->
³”_uri
, 
fmt_humª_time
, &
dur
);

366 
	}
}

369 
	$ÿÎ_de¡ruùÜ
(*
¬g
)

371 
ÿÎ
 *ÿÎ = 
¬g
;

373 ià(
ÿÎ
->
¡©e
 !ğ
STATE_IDLE
)

374 
	`´št_summ¬y
(
ÿÎ
);

376 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

377 
	`li¡_uÆšk
(&
ÿÎ
->
Ë
);

378 
	`tmr_ÿnûl
(&
ÿÎ
->
tmr_dtmf
);

380 
	`mem_d”ef
(
ÿÎ
->
£ss
);

381 
	`mem_d”ef
(
ÿÎ
->
loÿl_uri
);

382 
	`mem_d”ef
(
ÿÎ
->
loÿl_Çme
);

383 
	`mem_d”ef
(
ÿÎ
->
³”_uri
);

384 
	`mem_d”ef
(
ÿÎ
->
³”_Çme
);

385 
	`mem_d”ef
(
ÿÎ
->
audio
);

386 #ifdeà
USE_VIDEO


387 
	`mem_d”ef
(
ÿÎ
->
video
);

388 
	`mem_d”ef
(
ÿÎ
->
bfı
);

390 
	`mem_d”ef
(
ÿÎ
->
sdp
);

391 
	`mem_d”ef
(
ÿÎ
->
mÇts
);

392 
	`mem_d”ef
(
ÿÎ
->
m’cs
);

393 
	`mem_d”ef
(
ÿÎ
->
sub
);

394 
	`mem_d”ef
(
ÿÎ
->
nÙ
);

395 
	`mem_d”ef
(
ÿÎ
->
acc
);

396 
	}
}

399 
	$audio_ev’t_hªdËr
(
key
, 
boŞ
 
’d
, *
¬g
)

401 
ÿÎ
 *ÿÎ = 
¬g
;

402 
	`MAGIC_CHECK
(
ÿÎ
);

404 
	`šfo
("»ûivedƒv’t: '%c' (’d=%d)\n", 
key
, 
’d
);

406 ià(
ÿÎ
->
dtmfh
)

407 
ÿÎ
->
	`dtmfh
(ÿÎ, 
’d
 ? 
KEYCODE_REL
 : 
key
, c®l->
¬g
);

408 
	}
}

411 
	$audio_”rÜ_hªdËr
(
”r
, cÚ¡ *
¡r
, *
¬g
)

413 
ÿÎ
 *ÿÎ = 
¬g
;

414 
	`MAGIC_CHECK
(
ÿÎ
);

416 ià(
”r
) {

417 
	`w¬nšg
("ÿÎ:‡udiØdeviûƒ¼Ü: %m (%s)\n", 
”r
, 
¡r
);

420 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

421 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, 
¡r
);

422 
	}
}

425 #ifdeà
USE_VIDEO


426 
	$video_”rÜ_hªdËr
(
”r
, cÚ¡ *
¡r
, *
¬g
)

428 
ÿÎ
 *ÿÎ = 
¬g
;

429 
	`MAGIC_CHECK
(
ÿÎ
);

431 
	`w¬nšg
("ÿÎ: videØdeviûƒ¼Ü: %m (%s)\n", 
”r
, 
¡r
);

433 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

434 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, 
¡r
);

435 
	}
}

439 
	$m’c_”rÜ_hªdËr
(
”r
, *
¬g
)

441 
ÿÎ
 *ÿÎ = 
¬g
;

442 
	`MAGIC_CHECK
(
ÿÎ
);

444 
	`w¬nšg
("ÿÎ: medŸ’ø'%s'ƒ¼Ü: %m\n", 
ÿÎ
->
acc
->
m’cid
, 
”r
);

446 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

447 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "mediaenc failed");

448 
	}
}

451 
	$¡»am_”rÜ_hªdËr
(
¡»am
 *
¡rm
, 
”r
, *
¬g
)

453 
ÿÎ
 *ÿÎ = 
¬g
;

454 
	`MAGIC_CHECK
(
ÿÎ
);

456 
	`šfo
("call:ƒrror in \"%s\"„tp stream (%m)\n",

457 
	`sdp_medŸ_Çme
(
	`¡»am_sdpmedŸ
(
¡rm
)), 
”r
);

459 
ÿÎ
->
scode
 = 701;

460 
	`£t_¡©e
(
ÿÎ
, 
STATE_TERMINATED
);

462 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

463 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "rtp streamƒrror");

464 
	}
}

467 
	$assign_lš’um
(
ušt32_t
 *
lš’um
, cÚ¡ 
li¡
 *
l¡
)

469 
ušt32_t
 
num
;

471 
num
=
CALL_LINENUM_MIN
;‚um<
CALL_LINENUM_MAX
;‚um++) {

473 ià(!
	`ÿÎ_fšd_lš’um
(
l¡
, 
num
)) {

474 *
lš’um
 = 
num
;

479  
ENOENT
;

480 
	}
}

502 
	$ÿÎ_®loc
(
ÿÎ
 **
ÿÎp
, cÚ¡ 
cÚfig
 *
cfg
, 
li¡
 *
l¡
,

503 cÚ¡ *
loÿl_Çme
, cÚ¡ *
loÿl_uri
,

504 
accouÁ
 *
acc
, 
ua
 *ua, cÚ¡ 
ÿÎ_´m
 *
´m
,

505 cÚ¡ 
s_msg
 *
msg
, 
ÿÎ
 *
xÿÎ
,

506 
dnsc
 *dnsc,

507 
ÿÎ_ev’t_h
 *
eh
, *
¬g
)

509 
ÿÎ
 *call;

510 
Ë
 *le;

511 
¡»am_·¿m
 
¡»am_´m
;

512 
vidmode
 vidmodğ
´m
 ?…rm->vidmod: 
VIDMODE_OFF
;

513 
boŞ
 
u£_video
 = 
Œue
, 
gÙ_ofãr
 = 
çl£
;

514 
Ïb–
 = 0;

515 
”r
 = 0;

517 ià(!
cfg
 || !
loÿl_uri
 || !
acc
 || !
ua
 || !
´m
)

518  
EINVAL
;

520 
	`debug
("call:‡lloc with…arams†addr=%j,‡f=%s, use_rtp=%d\n",

521 &
´m
->
Ïddr
, 
	`Ãt_af2Çme
Õrm->
af
),…rm->
u£_¹p
);

523 
	`mem£t
(&
¡»am_´m
, 0, (stream_prm));

524 
¡»am_´m
.
u£_¹p
 = 
´m
->use_rtp;

526 
ÿÎ
 = 
	`mem_z®loc
((*ÿÎ), 
ÿÎ_de¡ruùÜ
);

527 ià(!
ÿÎ
)

528  
ENOMEM
;

530 
	`MAGIC_INIT
(
ÿÎ
);

532 
ÿÎ
->
cÚfig_avt
 = 
cfg
->
avt
;

533 
ÿÎ
->
cÚfig_ÿÎ
 = 
cfg
->call;

535 
	`tmr_š™
(&
ÿÎ
->
tmr_šv
);

537 
ÿÎ
->
acc
 = 
	`mem_»f
(acc);

538 
ÿÎ
->
ua
 = ua;

539 
ÿÎ
->
¡©e
 = 
STATE_IDLE
;

540 
ÿÎ
->
eh
 =ƒh;

541 
ÿÎ
->
¬g
 =‡rg;

542 
ÿÎ
->
af
 = 
´m
 ?…rm->aà: 
AF_INET
;

544 
”r
 = 
	`¡r_dup
(&
ÿÎ
->
loÿl_uri
,†ocal_uri);

545 ià(
loÿl_Çme
)

546 
”r
 |ğ
	`¡r_dup
(&
ÿÎ
->
loÿl_Çme
,†ocal_name);

547 ià(
”r
)

548 
out
;

551 
”r
 = 
	`sdp_£ssiÚ_®loc
(&
ÿÎ
->
sdp
, &
´m
->
Ïddr
);

552 ià(
”r
)

553 
out
;

555 
”r
 = 
	`sdp_£ssiÚ_£t_Ï‰r
(
ÿÎ
->
sdp
, 
Œue
,

556 "toŞ", "b¬es " 
BARESIP_VERSION
);

557 ià(
”r
)

558 
out
;

561 ià(
msg
 && 
	`mbuf_g‘_Ëá
(msg->
mb
))

562 
gÙ_ofãr
 = 
Œue
;

565 ià(
acc
->
mÇt
) {

566 
”r
 = 
acc
->
mÇt
->
	`£ssh
(&
ÿÎ
->
mÇts
,

567 
dnsc
, 
ÿÎ
->
af
,

568 
acc
->
¡un_ho¡
,‡cc->
¡un_pÜt
,

569 
acc
->
¡un_u£r
,‡cc->
¡un_·ss
,

570 
ÿÎ
->
sdp
, !
gÙ_ofãr
,

571 
mÇt_hªdËr
, 
ÿÎ
);

572 ià(
”r
) {

573 
	`w¬nšg
("ÿÎ: medŸÇˆ£ssiÚ: %m\n", 
”r
);

574 
out
;

577 
ÿÎ
->
mÇt_wa™
 = 
Œue
;

580 ià(
acc
->
m’c
) {

581 ià(
acc
->
m’c
->
£ssh
) {

582 
”r
 = 
acc
->
m’c
->
	`£ssh
(&
ÿÎ
->
m’cs
, c®l->
sdp
,

583 !
gÙ_ofãr
,

584 
m’c_”rÜ_hªdËr
, 
ÿÎ
);

585 ià(
”r
) {

586 
	`w¬nšg
("ÿÎ: medŸ’ø£ssiÚ: %m\n", 
”r
);

587 
out
;

593 
”r
 = 
	`audio_®loc
(&
ÿÎ
->
audio
, &
¡»am_´m
, 
cfg
, call,

594 
ÿÎ
->
sdp
, ++
Ïb–
,

595 
acc
->
mÇt
, 
ÿÎ
->
mÇts
,‡cc->
m’c
, c®l->
m’cs
,

596 
acc
->
±ime
, 
	`accouÁ_aucodeş
(
ÿÎ
->acc), !
gÙ_ofãr
,

597 
audio_ev’t_hªdËr
, 
audio_”rÜ_hªdËr
, 
ÿÎ
);

598 ià(
”r
)

599 
out
;

601 #ifdeà
USE_VIDEO


604 
u£_video
 = (
vidmode
 !ğ
VIDMODE_OFF
)

605 && (
	`li¡_h—d
(
	`accouÁ_vidcodeş
(
ÿÎ
->
acc
)è!ğ
NULL
)

606 && (
NULL
 !ğ
	`vid¤c_fšd
(
	`b¬es_vid¤ş
(), NULL)

607 || 
NULL
 !ğ
	`vidi¥_fšd
(
	`b¬es_vidi¥l
(), NULL));

609 
	`debug
("ÿÎ: u£_video=%d\n", 
u£_video
);

612 ià(
u£_video
) {

613 
”r
 = 
	`video_®loc
(&
ÿÎ
->
video
, &
¡»am_´m
, 
cfg
,

614 
ÿÎ
, c®l->
sdp
, ++
Ïb–
,

615 
acc
->
mÇt
, 
ÿÎ
->
mÇts
,

616 
acc
->
m’c
, 
ÿÎ
->
m’cs
,

618 
	`accouÁ_vidcodeş
(
ÿÎ
->
acc
),

619 
video_”rÜ_hªdËr
, 
ÿÎ
);

620 ià(
”r
)

621 
out
;

624 ià(
	`¡r_is£t
(
cfg
->
bfı
.
´Ùo
)) {

626 
”r
 = 
	`bfı_®loc
(&
ÿÎ
->
bfı
, c®l->
sdp
,

627 
cfg
->
bfı
.
´Ùo
, !
gÙ_ofãr
,

628 
acc
->
mÇt
, 
ÿÎ
->
mÇts
);

629 ià(
”r
)

630 
out
;

633 ()
u£_video
;

634 ()
vidmode
;

638 ià(
xÿÎ
) {

639 
ÿÎ
->
nÙ
 = 
	`mem_»f
(
xÿÎ
->not);

642 
FOREACH_STREAM
 {

643 
¡»am
 *
¡rm
 = 
Ë
->
d©a
;

644 
	`¡»am_£t_”rÜ_hªdËr
(
¡rm
, 
¡»am_”rÜ_hªdËr
, 
ÿÎ
);

647 ià(
cfg
->
avt
.
¹p_timeout
) {

648 
	`ÿÎ_’abË_¹p_timeout
(
ÿÎ
, 
cfg
->
avt
.
¹p_timeout
*1000);

651 
”r
 = 
	`assign_lš’um
(&
ÿÎ
->
lš’um
, 
l¡
);

652 ià(
”r
) {

653 
	`w¬nšg
("call: could‚ot‡ssign†inenumber\n");

654 
out
;

660 
	`li¡_­³nd
(
l¡
, &
ÿÎ
->
Ë
, call);

662 
out
:

663 ià(
”r
)

664 
	`mem_d”ef
(
ÿÎ
);

665 ià(
ÿÎp
)

666 *
ÿÎp
 = 
ÿÎ
;

668  
”r
;

669 
	}
}

672 
	$ÿÎ_cÚÃù
(
ÿÎ
 *ÿÎ, cÚ¡ 
¶
 *
·ddr
)

674 
s_addr
 
addr
;

675 
”r
;

677 ià(!
ÿÎ
 || !
·ddr
)

678  
EINVAL
;

680 
	`šfo
("ÿÎ: cÚÃùšgØ'%r'..\n", 
·ddr
);

682 
ÿÎ
->
outgošg
 = 
Œue
;

687 ià(0 =ğ
	`s_addr_decode
(&
addr
, 
·ddr
è&&‡ddr.
dÇme
.
p
) {

688 
”r
 = 
	`¶_¡rdup
(&
ÿÎ
->
³”_uri
, &
addr
.
auri
);

691 
”r
 = 
	`¶_¡rdup
(&
ÿÎ
->
³”_uri
, 
·ddr
);

693 ià(
”r
)

694  
”r
;

696 
	`£t_¡©e
(
ÿÎ
, 
STATE_OUTGOING
);

700 ià(!
ÿÎ
->
acc
->
mÇt
)

701 
”r
 = 
	`£nd_šv™e
(
ÿÎ
);

703  
”r
;

704 
	}
}

714 
	$ÿÎ_modify
(
ÿÎ
 *call)

716 
mbuf
 *
desc
;

717 
”r
;

719 ià(!
ÿÎ
)

720  
EINVAL
;

722 
”r
 = 
	`ÿÎ_sdp_g‘
(
ÿÎ
, &
desc
, 
Œue
);

723 ià(!
”r
)

724 
”r
 = 
	`s£ss_modify
(
ÿÎ
->
£ss
, 
desc
);

726 
	`mem_d”ef
(
desc
);

728  
”r
;

729 
	}
}

732 
	$ÿÎ_hªgup
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

734 
”r
 = 0;

736 ià(!
ÿÎ
)

737  
EINVAL
;

739 ià(
ÿÎ
->
cÚfig_avt
.
¹p_¡©s
)

740 
	`ÿÎ_£t_x¹p¡©
(
ÿÎ
);

742 
ÿÎ
->
¡©e
) {

744 
STATE_INCOMING
:

745 ià(
scode
 < 400) {

746 
scode
 = 486;

747 
»asÚ
 = "Rejected";

749 
	`šfo
("call:„ejecting incoming call from %s (%u %s)\n",

750 
ÿÎ
->
³”_uri
, 
scode
, 
»asÚ
);

751 ()
	`s£ss_»jeù
(
ÿÎ
->
£ss
, 
scode
, 
»asÚ
, 
NULL
);

755 
	`šfo
("call:erminate call '%s' with %s\n",

756 
	`s_dŸlog_ÿÎid
(
	`s£ss_dŸlog
(
ÿÎ
->
£ss
)),

757 
ÿÎ
->
³”_uri
);

759 
ÿÎ
->
£ss
 = 
	`mem_d”ef
(call->sess);

763 
	`£t_¡©e
(
ÿÎ
, 
STATE_TERMINATED
);

765 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

767  
”r
;

768 
	}
}

771 
	$ÿÎ_´og»ss
(
ÿÎ
 *call)

773 
mbuf
 *
desc
;

774 
”r
;

776 ià(!
ÿÎ
)

777  
EINVAL
;

779 
	`tmr_ÿnûl
(&
ÿÎ
->
tmr_šv
);

781 
”r
 = 
	`ÿÎ_sdp_g‘
(
ÿÎ
, &
desc
, 
çl£
);

782 ià(
”r
)

783  
”r
;

785 
”r
 = 
	`s£ss_´og»ss
(
ÿÎ
->
£ss
, 183, "Session Progress",

786 
desc
, "AÎow: %s\r\n", 
	`uag_®lowed_m‘hods
());

788 ià(!
”r
)

789 
	`ÿÎ_¡»am_¡¬t
(
ÿÎ
, 
çl£
);

791 
	`mem_d”ef
(
desc
);

794 
	}
}

797 
	$ÿÎ_ªsw”
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
)

799 
mbuf
 *
desc
;

800 
”r
;

802 ià(!
ÿÎ
 || !ÿÎ->
£ss
)

803  
EINVAL
;

805 ià(
STATE_INCOMING
 !ğ
ÿÎ
->
¡©e
) {

806 
	`šfo
("call:‡nswer: call is‚ot in incoming state (%s)\n",

807 
	`¡©e_Çme
(
ÿÎ
->
¡©e
));

811 
	`šfo
("ªsw”šg c®Èäom % w™h %u\n", 
ÿÎ
->
³”_uri
, 
scode
);

813 ià(
ÿÎ
->
gÙ_ofãr
) {

815 
”r
 = 
	`upd©e_medŸ
(
ÿÎ
);

816 ià(
”r
)

817  
”r
;

820 
”r
 = 
	`sdp_’code
(&
desc
, 
ÿÎ
->
sdp
, !ÿÎ->
gÙ_ofãr
);

821 ià(
”r
)

822  
”r
;

824 
”r
 = 
	`s£ss_ªsw”
(
ÿÎ
->
£ss
, 
scode
, "Answ”šg", 
desc
,

825 "AÎow: %s\r\n", 
	`uag_®lowed_m‘hods
());

827 
	`mem_d”ef
(
desc
);

829  
”r
;

830 
	}
}

840 
boŞ
 
	$ÿÎ_has_audio
(cÚ¡ 
ÿÎ
 *call)

842 ià(!
ÿÎ
)

843  
çl£
;

845  
	`sdp_medŸ_has_medŸ
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
ÿÎ
->
audio
)));

846 
	}
}

856 
boŞ
 
	$ÿÎ_has_video
(cÚ¡ 
ÿÎ
 *call)

858 ià(!
ÿÎ
)

859  
çl£
;

861 #ifdeà
USE_VIDEO


862  
	`sdp_medŸ_has_medŸ
(
	`¡»am_sdpmedŸ
(
	`video_¡rm
(
ÿÎ
->
video
)));

864  
çl£
;

866 
	}
}

877 
	$ÿÎ_hŞd
(
ÿÎ
 *ÿÎ, 
boŞ
 
hŞd
)

879 
Ë
 *le;

881 ià(!
ÿÎ
 || !ÿÎ->
£ss
)

882  
EINVAL
;

884 ià(
hŞd
 =ğ
ÿÎ
->
Ú_hŞd
)

887 
	`šfo
("ÿÎ: % %s\n", 
hŞd
 ? "hŞd" : "»sume", 
ÿÎ
->
³”_uri
);

889 
ÿÎ
->
Ú_hŞd
 = 
hŞd
;

891 
FOREACH_STREAM


892 
	`¡»am_hŞd
(
Ë
->
d©a
, 
hŞd
);

894  
	`ÿÎ_modify
(
ÿÎ
);

895 
	}
}

898 
	$ÿÎ_sdp_g‘
(cÚ¡ 
ÿÎ
 *ÿÎ, 
mbuf
 **
desı
, 
boŞ
 
ofãr
)

900  
	`sdp_’code
(
desı
, 
ÿÎ
->
sdp
, 
ofãr
);

901 
	}
}

904 cÚ¡ *
	$ÿÎ_³”uri
(cÚ¡ 
ÿÎ
 *call)

906  
ÿÎ
 ? c®l->
³”_uri
 : 
NULL
;

907 
	}
}

910 cÚ¡ *
	$ÿÎ_loÿluri
(cÚ¡ 
ÿÎ
 *call)

912  
ÿÎ
 ? c®l->
loÿl_uri
 : 
NULL
;

913 
	}
}

923 cÚ¡ *
	$ÿÎ_³”Çme
(cÚ¡ 
ÿÎ
 *call)

925  
ÿÎ
 ? c®l->
³”_Çme
 : 
NULL
;

926 
	}
}

929 
	$ÿÎ_debug
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call)

931 
”r
;

933 ià(!
ÿÎ
)

936 
”r
 = 
	`»_h´štf
(
pf
, "===== Call debug (%s) =====\n",

937 
	`¡©e_Çme
(
ÿÎ
->
¡©e
));

940 
”r
 |ğ
	`»_h´štf
(
pf
,

944 
ÿÎ
->
loÿl_Çme
, c®l->
loÿl_uri
,

945 
ÿÎ
->
³”_Çme
, c®l->
³”_uri
,

946 
	`Ãt_af2Çme
(
ÿÎ
->
af
));

947 
”r
 |ğ
	`»_h´štf
(
pf
, " direction: %s\n",

948 
ÿÎ
->
outgošg
 ? "Outgoing" : "Incoming");

951 
”r
 |ğ
	`sdp_£ssiÚ_debug
(
pf
, 
ÿÎ
->
sdp
);

953  
”r
;

954 
	}
}

957 
	$´št_du¿tiÚ
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call)

959 cÚ¡ 
ušt32_t
 
dur
 = 
	`ÿÎ_du¿tiÚ
(
ÿÎ
);

960 cÚ¡ 
ušt32_t
 
£c
 = 
dur
%60%60;

961 cÚ¡ 
ušt32_t
 
mš
 = 
dur
/60%60;

962 cÚ¡ 
ušt32_t
 
hrs
 = 
dur
/60/60;

964  
	`»_h´štf
(
pf
, "%u:%02u:%02u", 
hrs
, 
mš
, 
£c
);

965 
	}
}

968 
	$ÿÎ_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call)

970 
Ë
 *le;

971 
”r
;

973 ià(!
ÿÎ
)

974  
EINVAL
;

976 
ÿÎ
->
¡©e
) {

978 
STATE_EARLY
:

979 
STATE_ESTABLISHED
:

985 
”r
 = 
	`»_h´štf
(
pf
, "\r[%H]", 
´št_du¿tiÚ
, 
ÿÎ
);

987 
FOREACH_STREAM


988 
”r
 |ğ
	`¡»am_´št
(
pf
, 
Ë
->
d©a
);

990 
”r
 |ğ
	`»_h´štf
(
pf
, " (bit/s)");

992 #ifdeà
USE_VIDEO


993 ià(
ÿÎ
->
video
)

994 
”r
 |ğ
	`video_´št
(
pf
, 
ÿÎ
->
video
);

997  
”r
;

998 
	}
}

1001 
	$ÿÎ_jbuf_¡©
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call)

1003 
Ë
 *le;

1004 
”r
 = 0;

1006 ià(!
ÿÎ
)

1007  
EINVAL
;

1009 
FOREACH_STREAM


1010 
”r
 |ğ
	`¡»am_jbuf_¡©
(
pf
, 
Ë
->
d©a
);

1012  
”r
;

1013 
	}
}

1016 
	$ÿÎ_šfo
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call)

1018 ià(!
ÿÎ
)

1021  
	`»_h´štf
(
pf
, "[lš%u] %H %9  %  %s", 
ÿÎ
->
lš’um
,

1022 
´št_du¿tiÚ
, 
ÿÎ
,

1023 
	`¡©e_Çme
(
ÿÎ
->
¡©e
),

1024 
ÿÎ
->
Ú_hŞd
 ? "(on hold)" : " ",

1025 
ÿÎ
->
³”_uri
);

1026 
	}
}

1037 
	$ÿÎ_£nd_dig™
(
ÿÎ
 *ÿÎ, 
key
)

1039 ià(!
ÿÎ
)

1040  
EINVAL
;

1042  
	`audio_£nd_dig™
(
ÿÎ
->
audio
, 
key
);

1043 
	}
}

1046 
ua
 *
	$ÿÎ_g‘_ua
(cÚ¡ 
ÿÎ
 *call)

1048  
ÿÎ
 ? c®l->
ua
 : 
NULL
;

1049 
	}
}

1052 
accouÁ
 *
	$ÿÎ_accouÁ
(cÚ¡ 
ÿÎ
 *call)

1054  
ÿÎ
 ? c®l->
acc
 : 
NULL
;

1055 
	}
}

1058 
	$auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

1059 cÚ¡ *
»®m
, *
¬g
)

1061 
accouÁ
 *
acc
 = 
¬g
;

1062  
	`accouÁ_auth
(
acc
, 
u£ºame
, 
·sswÜd
, 
»®m
);

1063 
	}
}

1066 
	$s£ss_ofãr_hªdËr
(
mbuf
 **
desı
,

1067 cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1069 cÚ¡ 
boŞ
 
gÙ_ofãr
 = 
	`mbuf_g‘_Ëá
(
msg
->
mb
);

1070 
ÿÎ
 *ÿÎ = 
¬g
;

1071 
”r
;

1073 
	`MAGIC_CHECK
(
ÿÎ
);

1075 
	`šfo
("ÿÎ: gÙ„e-INVITE%s\n", 
gÙ_ofãr
 ? " (SDP Offer)" : "");

1077 ià(
gÙ_ofãr
) {

1080 
”r
 = 
	`sdp_decode
(
ÿÎ
->
sdp
, 
msg
->
mb
, 
Œue
);

1081 ià(
”r
) {

1082 
	`w¬nšg
("call:„einvite: could‚ot decode SDP offer:"

1083 " %m\n", 
”r
);

1084  
”r
;

1087 
”r
 = 
	`upd©e_medŸ
(
ÿÎ
);

1088 ià(
”r
)

1089  
”r
;

1093  
	`sdp_’code
(
desı
, 
ÿÎ
->
sdp
, !
gÙ_ofãr
);

1094 
	}
}

1097 
	$s£ss_ªsw”_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1099 
ÿÎ
 *ÿÎ = 
¬g
;

1100 
”r
;

1102 
	`MAGIC_CHECK
(
ÿÎ
);

1104 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
, "multipart", "mixed"))

1105 ()
	`sdp_decode_muÉ¬t
(&
msg
->
ùyp
.
·¿ms
, msg->
mb
);

1107 
”r
 = 
	`sdp_decode
(
ÿÎ
->
sdp
, 
msg
->
mb
, 
çl£
);

1108 ià(
”r
) {

1109 
	`w¬nšg
("ÿÎ: could‚Ù decodSDP‡nsw”: %m\n", 
”r
);

1110  
”r
;

1113 
”r
 = 
	`upd©e_medŸ
(
ÿÎ
);

1114 ià(
”r
)

1115  
”r
;

1118 
	}
}

1121 
	$s£ss_e¡ab_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1123 
ÿÎ
 *ÿÎ = 
¬g
;

1125 
	`MAGIC_CHECK
(
ÿÎ
);

1127 ()
msg
;

1129 ià(
ÿÎ
->
¡©e
 =ğ
STATE_ESTABLISHED
)

1132 
	`£t_¡©e
(
ÿÎ
, 
STATE_ESTABLISHED
);

1134 
	`ÿÎ_¡»am_¡¬t
(
ÿÎ
, 
Œue
);

1136 ià(
ÿÎ
->
¹p_timeout_ms
) {

1138 
Ë
 *le;

1140 
FOREACH_STREAM
 {

1141 
¡»am
 *
¡rm
 = 
Ë
->
d©a
;

1142 
	`¡»am_’abË_¹p_timeout
(
¡rm
, 
ÿÎ
->
¹p_timeout_ms
);

1147 ià(
ÿÎ
->
nÙ
) {

1148 ()
	`ÿÎ_nÙify_säag
(
ÿÎ
, 200, "OK");

1152 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_ESTABLISHED
, c®l->
³”_uri
);

1153 
	}
}

1156 #ifdeà
USE_VIDEO


1157 
	$ÿÎ_hªdË_šfo_»q
(
ÿÎ
 *ÿÎ, cÚ¡ 
s_msg
 *
»q
)

1159 
¶
 
body
;

1160 
boŞ
 
pfu
;

1161 
”r
;

1163 ()
ÿÎ
;

1165 
	`¶_£t_mbuf
(&
body
, 
»q
->
mb
);

1167 
”r
 = 
	`mù¾_hªdË_medŸ_cÚŒŞ
(&
body
, &
pfu
);

1168 ià(
”r
)

1171 ià(
pfu
) {

1172 
	`video_upd©e_piùu»
(
ÿÎ
->
video
);

1174 
	}
}

1178 
	$dtmãnd_hªdËr
(*
¬g
)

1180 
ÿÎ
 *ÿÎ = 
¬g
;

1182 ià(
ÿÎ
->
dtmfh
)

1183 
ÿÎ
->
	`dtmfh
(ÿÎ, 
KEYCODE_REL
, c®l->
¬g
);

1184 
	}
}

1187 
	$s£ss_šfo_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

1188 *
¬g
)

1190 
ÿÎ
 *ÿÎ = 
¬g
;

1192 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
, "application", "dtmf-relay")) {

1194 
¶
 
body
, 
sig
, 
dur
;

1195 
”r
;

1197 
	`¶_£t_mbuf
(&
body
, 
msg
->
mb
);

1199 
”r
 = 
	`»_»gex
(
body
.
p
, body.
l
, "SigÇl=[0-9*#a-d]+", &
sig
);

1200 
”r
 |ğ
	`»_»gex
(
body
.
p
, body.
l
, "Du¿tiÚ=[0-9]+", &
dur
);

1202 ià(
”r
 || !
	`¶_is£t
(&
sig
è|| sig.
l
 == 0) {

1203 ()
	`s_»¶y
(
s
, 
msg
, 400, "Bad Request");

1206 
s
 = 
	`touµ”
(
sig
.
p
[0]);

1207 
ušt32_t
 
du¿tiÚ
 = 
	`¶_u32
(&
dur
);

1209 
	`šfo
("»ûived DTMF: '%c' (du¿tiÚ=%r)\n", 
s
, &
dur
);

1211 ()
	`s_»¶y
(
s
, 
msg
, 200, "OK");

1213 ià(
ÿÎ
->
dtmfh
) {

1214 
	`tmr_¡¬t
(&
ÿÎ
->
tmr_dtmf
, 
du¿tiÚ
,

1215 
dtmãnd_hªdËr
, 
ÿÎ
);

1216 
ÿÎ
->
	`dtmfh
(ÿÎ, 
s
, c®l->
¬g
);

1220 #ifdeà
USE_VIDEO


1221 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
,

1223 
	`ÿÎ_hªdË_šfo_»q
(
ÿÎ
, 
msg
);

1224 ()
	`s_»¶y
(
s
, 
msg
, 200, "OK");

1228 ()
	`s_»¶y
(
s
, 
msg
, 488, "Not Acceptable Here");

1230 
	}
}

1233 
	$snÙ_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

1234 *
¬g
)

1236 
ÿÎ
 *ÿÎ = 
¬g
;

1238 ià(
”r
)

1239 
	`šfo
("ÿÎ:‚ÙifiÿtiÚ clo£d: %m\n", 
”r
);

1240 ià(
msg
)

1241 
	`šfo
("call:‚otification closed: %u %r\n",

1242 
msg
->
scode
, &msg->
»asÚ
);

1244 
ÿÎ
->
nÙ
 = 
	`mem_d”ef
(call->not);

1245 
	}
}

1248 
	$s£ss_»ãr_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

1249 *
¬g
)

1251 
ÿÎ
 *ÿÎ = 
¬g
;

1252 cÚ¡ 
s_hdr
 *
hdr
;

1253 
”r
;

1256 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_REFER_TO
);

1257 ià(!
hdr
) {

1258 
	`w¬nšg
("ÿÎ: bad REFER„eque¡ from %r\n", &
msg
->
äom
.
auri
);

1259 ()
	`s_»¶y
(
s
, 
msg
, 400, "Missing Refer-To header");

1266 
ÿÎ
->
nÙ
 = 
	`mem_d”ef
(call->not);

1267 
”r
 = 
	`sev’t_acû±
(&
ÿÎ
->
nÙ
, 
	`uag_sev’t_sock
(), 
msg
,

1268 
	`s£ss_dŸlog
(
ÿÎ
->
£ss
), 
NULL
,

1270 
	`ua_cu£r
(
ÿÎ
->
ua
), "message/sipfrag",

1271 
auth_hªdËr
, 
ÿÎ
->
acc
, 
Œue
,

1272 
snÙ_şo£_hªdËr
, 
ÿÎ
,

1273 "AÎow: %s\r\n", 
	`uag_®lowed_m‘hods
());

1274 ià(
”r
) {

1275 
	`w¬nšg
("ÿÎ:„eãr: sev’t_acû± faed: %m\n", 
”r
);

1279 ()
	`ÿÎ_nÙify_säag
(
ÿÎ
, 100, "Trying");

1281 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_TRANSFER
, "%r", &
hdr
->
v®
);

1282 
	}
}

1285 
	$s£ss_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

1286 *
¬g
)

1288 
ÿÎ
 *ÿÎ = 
¬g
;

1289 
»asÚ
[128] = "";

1291 
	`MAGIC_CHECK
(
ÿÎ
);

1293 ià(
”r
) {

1294 
	`šfo
("%s: sessiÚ clo£d: %m\n", 
ÿÎ
->
³”_uri
, 
”r
);

1296 ià(
ÿÎ
->
nÙ
) {

1297 ()
	`ÿÎ_nÙify_säag
(
ÿÎ
, 500, "%m", 
”r
);

1300 ià(
msg
) {

1302 
ÿÎ
->
scode
 = 
msg
->scode;

1304 ()
	`»_¢´štf
(
»asÚ
, (reason), "%u %r",

1305 
msg
->
scode
, &msg->
»asÚ
);

1307 
	`šfo
("%s: session closed: %u %r\n",

1308 
ÿÎ
->
³”_uri
, 
msg
->
scode
, &msg->
»asÚ
);

1310 ià(
ÿÎ
->
nÙ
) {

1311 ()
	`ÿÎ_nÙify_säag
(
ÿÎ
, 
msg
->
scode
,

1312 "%r", &
msg
->
»asÚ
);

1316 
	`šfo
("%s: sessiÚ clo£d\n", 
ÿÎ
->
³”_uri
);

1319 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

1320 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, 
»asÚ
);

1321 
	}
}

1324 
boŞ
 
	$have_commÚ_audio_codecs
(cÚ¡ 
ÿÎ
 *call)

1326 cÚ¡ 
sdp_fÜm©
 *
sc
;

1327 
aucodec
 *
ac
;

1329 
sc
 = 
	`sdp_medŸ_rfÜm©
(
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
ÿÎ
->
audio
)), 
NULL
);

1330 ià(!
sc
)

1331  
çl£
;

1333 
ac
 = 
sc
->
d©a
;

1335  
ac
 !ğ
NULL
;

1336 
	}
}

1339 
	$ÿÎ_acû±
(
ÿÎ
 *ÿÎ, 
s£ss_sock
 *
£ss_sock
,

1340 cÚ¡ 
s_msg
 *
msg
)

1342 
boŞ
 
gÙ_ofãr
;

1343 
”r
;

1345 ià(!
ÿÎ
 || !
msg
)

1346  
EINVAL
;

1348 
ÿÎ
->
outgošg
 = 
çl£
;

1350 
gÙ_ofãr
 = (
	`mbuf_g‘_Ëá
(
msg
->
mb
) > 0);

1352 
”r
 = 
	`¶_¡rdup
(&
ÿÎ
->
³”_uri
, &
msg
->
äom
.
auri
);

1353 ià(
”r
)

1354  
”r
;

1356 ià(
	`¶_is£t
(&
msg
->
äom
.
dÇme
)) {

1357 
”r
 = 
	`¶_¡rdup
(&
ÿÎ
->
³”_Çme
, &
msg
->
äom
.
dÇme
);

1358 ià(
”r
)

1359  
”r
;

1362 ià(
gÙ_ofãr
) {

1363 
sdp_medŸ
 *
m
;

1364 cÚ¡ 
§
 *
¿ddr
;

1366 
”r
 = 
	`sdp_decode
(
ÿÎ
->
sdp
, 
msg
->
mb
, 
Œue
);

1367 ià(
”r
)

1368  
”r
;

1370 
ÿÎ
->
gÙ_ofãr
 = 
Œue
;

1379 
m
 = 
	`¡»am_sdpmedŸ
(
	`audio_¡rm
(
ÿÎ
->
audio
));

1380 
¿ddr
 = 
	`sdp_medŸ_¿ddr
(
m
);

1382 ià(
	`§_af
(
¿ddr
è!ğ
ÿÎ
->
af
) {

1383 
	`šfo
("call: incompatible‡ddress-family"

1385 
	`Ãt_af2Çme
(
ÿÎ
->
af
),

1386 
	`Ãt_af2Çme
(
	`§_af
(
¿ddr
)));

1388 
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
,

1391 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
,

1399 ià(!
	`have_commÚ_audio_codecs
(
ÿÎ
)) {

1400 
	`šfo
("call:‚o common‡udio codecs -„ejected\n");

1402 
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
,

1405 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
,

1412 
”r
 = 
	`s£ss_acû±
(&
ÿÎ
->
£ss
, 
£ss_sock
, 
msg
, 180, "Ringing",

1413 
	`ua_cu£r
(
ÿÎ
->
ua
), "­¶iÿtiÚ/sdp", 
NULL
,

1414 
auth_hªdËr
, 
ÿÎ
->
acc
, 
Œue
,

1415 
s£ss_ofãr_hªdËr
, 
s£ss_ªsw”_hªdËr
,

1416 
s£ss_e¡ab_hªdËr
, 
s£ss_šfo_hªdËr
,

1417 
s£ss_»ãr_hªdËr
, 
s£ss_şo£_hªdËr
,

1418 
ÿÎ
, "AÎow: %s\r\n", 
	`uag_®lowed_m‘hods
());

1419 ià(
”r
) {

1420 
	`w¬nšg
("ÿÎ: s£ss_acû±: %m\n", 
”r
);

1421  
”r
;

1424 
	`£t_¡©e
(
ÿÎ
, 
STATE_INCOMING
);

1427 ià(
ÿÎ
->
cÚfig_ÿÎ
.
loÿl_timeout
) {

1428 
	`tmr_¡¬t
(&
ÿÎ
->
tmr_šv
, c®l->
cÚfig_ÿÎ
.
loÿl_timeout
*1000,

1429 
šv™e_timeout
, 
ÿÎ
);

1432 ià(!
ÿÎ
->
acc
->
mÇt
)

1433 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_INCOMING
, c®l->
³”_uri
);

1435  
”r
;

1436 
	}
}

1439 
	$s£ss_´ogr_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1441 
ÿÎ
 *ÿÎ = 
¬g
;

1442 
boŞ
 
medŸ
;

1444 
	`MAGIC_CHECK
(
ÿÎ
);

1446 
	`šfo
("call: SIP Progress: %u %r (%r/%r)\n",

1447 
msg
->
scode
, &msg->
»asÚ
, &msg->
ùyp
.
ty³
, &msg->ùyp.
subty³
);

1449 ià(
msg
->
scode
 <= 100)

1460 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
, "application", "sdp")

1461 && 
	`mbuf_g‘_Ëá
(
msg
->
mb
)

1462 && !
	`sdp_decode
(
ÿÎ
->
sdp
, 
msg
->
mb
, 
çl£
)) {

1463 
medŸ
 = 
Œue
;

1465 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
, "multipart", "mixed") &&

1466 !
	`sdp_decode_muÉ¬t
(&
msg
->
ùyp
.
·¿ms
, msg->
mb
) &&

1467 !
	`sdp_decode
(
ÿÎ
->
sdp
, 
msg
->
mb
, 
çl£
)) {

1468 
medŸ
 = 
Œue
;

1471 
medŸ
 = 
çl£
;

1473 
msg
->
scode
) {

1476 
	`£t_¡©e
(
ÿÎ
, 
STATE_RINGING
);

1480 
	`£t_¡©e
(
ÿÎ
, 
STATE_EARLY
);

1484 
	`ÿÎ_¡»am_¡İ
(
ÿÎ
);

1486 ià(
medŸ
)

1487 
	`ÿÎ_¡»am_¡¬t
(
ÿÎ
, 
çl£
);

1489 ià(
medŸ
)

1490 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_PROGRESS
, c®l->
³”_uri
);

1492 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_RINGING
, c®l->
³”_uri
);

1494 ià(
medŸ
)

1495 
	`upd©e_medŸ
(
ÿÎ
);

1496 
	}
}

1499 
	$£nd_šv™e
(
ÿÎ
 *call)

1501 cÚ¡ *
rou‹v
[1];

1502 
mbuf
 *
desc
;

1503 
”r
;

1505 
rou‹v
[0] = 
	`ua_outbound
(
ÿÎ
->
ua
);

1507 
”r
 = 
	`ÿÎ_sdp_g‘
(
ÿÎ
, &
desc
, 
Œue
);

1508 ià(
”r
)

1509  
”r
;

1511 
”r
 = 
	`s£ss_cÚÃù
(&
ÿÎ
->
£ss
, 
	`uag_s£ss_sock
(),

1512 
ÿÎ
->
³”_uri
,

1513 
ÿÎ
->
loÿl_Çme
,

1514 
ÿÎ
->
loÿl_uri
,

1515 
	`ua_cu£r
(
ÿÎ
->
ua
),

1516 
rou‹v
[0] ?„ou‹v : 
NULL
,

1517 
rou‹v
[0] ? 1 : 0,

1518 "­¶iÿtiÚ/sdp", 
desc
,

1519 
auth_hªdËr
, 
ÿÎ
->
acc
, 
Œue
,

1520 
s£ss_ofãr_hªdËr
, 
s£ss_ªsw”_hªdËr
,

1521 
s£ss_´ogr_hªdËr
, 
s£ss_e¡ab_hªdËr
,

1522 
s£ss_šfo_hªdËr
, 
s£ss_»ãr_hªdËr
,

1523 
s£ss_şo£_hªdËr
, 
ÿÎ
,

1524 "AÎow: %s\r\n%H", 
	`uag_®lowed_m‘hods
(),

1525 
ua_´št_suµÜ‹d
, 
ÿÎ
->
ua
);

1526 ià(
”r
) {

1527 
	`w¬nšg
("ÿÎ: s£ss_cÚÃù: %m\n", 
”r
);

1531 
ÿÎ
->
time_cÚn
 = 
	`time
(
NULL
);

1533 
	`mem_d”ef
(
desc
);

1535  
”r
;

1536 
	}
}

1546 
ušt32_t
 
	$ÿÎ_du¿tiÚ
(cÚ¡ 
ÿÎ
 *call)

1548 ià(!
ÿÎ
 || !ÿÎ->
time_¡¬t
)

1551  (
ušt32_t
)(
	`time
(
NULL
è- 
ÿÎ
->
time_¡¬t
);

1552 
	}
}

1562 
ušt32_t
 
	$ÿÎ_£tup_du¿tiÚ
(cÚ¡ 
ÿÎ
 *call)

1564 ià(!
ÿÎ
 || !ÿÎ->
time_cÚn
 || call->time_conn <= 0 )

1567  (
ušt32_t
)(
ÿÎ
->
time_¡¬t
 - c®l->
time_cÚn
);

1568 
	}
}

1578 
audio
 *
	$ÿÎ_audio
(cÚ¡ 
ÿÎ
 *call)

1580  
ÿÎ
 ? c®l->
audio
 : 
NULL
;

1581 
	}
}

1591 
video
 *
	$ÿÎ_video
(cÚ¡ 
ÿÎ
 *call)

1593 #ifdeà
USE_VIDEO


1594  
ÿÎ
 ? c®l->
video
 : 
NULL
;

1596 ()
ÿÎ
;

1597  
NULL
;

1599 
	}
}

1609 
li¡
 *
	$ÿÎ_¡»aml
(cÚ¡ 
ÿÎ
 *call)

1611  
ÿÎ
 ? (
li¡
 *)&ÿÎ->
¡»aml
 : 
NULL
;

1612 
	}
}

1615 
	$ÿÎ_»£t_Œª¥
(
ÿÎ
 *ÿÎ, cÚ¡ 
§
 *
Ïddr
)

1617 ià(!
ÿÎ
)

1618  
EINVAL
;

1620 
	`sdp_£ssiÚ_£t_Ïddr
(
ÿÎ
->
sdp
, 
Ïddr
);

1622  
	`ÿÎ_modify
(
ÿÎ
);

1623 
	}
}

1626 
	$ÿÎ_nÙify_säag
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
,

1627 cÚ¡ *
»asÚ
, ...)

1629 
mbuf
 *
mb
;

1630 
va_li¡
 
­
;

1631 
”r
;

1633 ià(!
ÿÎ
)

1634  
EINVAL
;

1636 
mb
 = 
	`mbuf_®loc
(512);

1637 ià(!
mb
)

1638  
ENOMEM
;

1640 
	`va_¡¬t
(
­
, 
»asÚ
);

1641 ()
	`mbuf_´štf
(
mb
, "SIP/2.0 %u %v\n", 
scode
, 
»asÚ
, &
­
);

1642 
	`va_’d
(
­
);

1644 
mb
->
pos
 = 0;

1646 ià(
scode
 >= 200) {

1647 
”r
 = 
	`sev’t_nÙify
(
ÿÎ
->
nÙ
, 
mb
, 
SIPEVENT_TERMINATED
,

1648 
SIPEVENT_NORESOURCE
, 0);

1650 
ÿÎ
->
nÙ
 = 
	`mem_d”ef
(call->not);

1653 
”r
 = 
	`sev’t_nÙify
(
ÿÎ
->
nÙ
, 
mb
, 
SIPEVENT_ACTIVE
,

1654 
SIPEVENT_NORESOURCE
, 0);

1657 
	`mem_d”ef
(
mb
);

1659  
”r
;

1660 
	}
}

1663 
	$ssub_nÙify_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

1664 *
¬g
)

1666 
ÿÎ
 *ÿÎ = 
¬g
;

1667 
¶
 
scode
, 
»asÚ
;

1668 
ušt32_t
 
sc
;

1670 ià(
	`»_»gex
((*)
	`mbuf_buf
(
msg
->
mb
), 
	`mbuf_g‘_Ëá
(msg->mb),

1671 "SIP/2.0 [0-9]+ [^\r\n]+", &
scode
, &
»asÚ
)) {

1672 ()
	`s_»¶y
(
s
, 
msg
, 400, "Bad sipfrag");

1676 ()
	`s_»¶y
(
s
, 
msg
, 200, "OK");

1678 
sc
 = 
	`¶_u32
(&
scode
);

1680 ià(
sc
 >= 300) {

1681 
	`w¬nšg
("ÿÎ:¿nsã¸çed: %u %r\n", 
sc
, &
»asÚ
);

1682 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_TRANSFER_FAILED
,

1683 "%u %r", 
sc
, &
»asÚ
);

1685 ià(
sc
 >= 200) {

1686 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_CLOSED
, "Callransfered");

1688 
	}
}

1691 
	$ssub_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

1692 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
,

1693 *
¬g
)

1695 
ÿÎ
 *ÿÎ = 
¬g
;

1697 ()
sub¡©e
;

1699 
ÿÎ
->
sub
 = 
	`mem_d”ef
(call->sub);

1701 ià(
”r
) {

1702 
	`šfo
("ÿÎ: subsütiÚ clo£d: %m\n", 
”r
);

1704 ià(
msg
 && msg->
scode
 >= 300) {

1705 
	`šfo
("call:ransfer failed: %u %r\n",

1706 
msg
->
scode
, &msg->
»asÚ
);

1707 
	`ÿÎ_ev’t_hªdËr
(
ÿÎ
, 
CALL_EVENT_TRANSFER_FAILED
,

1708 "%u %r", 
msg
->
scode
, &msg->
»asÚ
);

1710 
	}
}

1713 
	$nÜm®ize_uri
(**
out
, cÚ¡ *
uri
, cÚ¡ ur˜*
luri
)

1715 
uri
 
uri2
;

1716 
¶
…l;

1717 
”r
;

1719 ià(!
out
 || !
uri
 || !
luri
)

1720  
EINVAL
;

1722 
	`¶_£t_¡r
(&
¶
, 
uri
);

1724 ià(0 =ğ
	`uri_decode
(&
uri2
, &
¶
)) {

1726 
”r
 = 
	`¡r_dup
(
out
, 
uri
);

1729 
uri2
 = *
luri
;

1731 
uri2
.
u£r
 = 
¶
;

1732 
uri2
.
·sswÜd
 = 
¶_nuÎ
;

1733 
uri2
.
·¿ms
 = 
¶_nuÎ
;

1735 
”r
 = 
	`»_sd´štf
(
out
, "%H", 
uri_’code
, &
uri2
);

1738  
”r
;

1739 
	}
}

1750 
	$ÿÎ_Œªsãr
(
ÿÎ
 *ÿÎ, cÚ¡ *
uri
)

1752 *
nuri
;

1753 
”r
;

1755 ià(!
ÿÎ
 || !
uri
)

1756  
EINVAL
;

1758 
”r
 = 
	`nÜm®ize_uri
(&
nuri
, 
uri
, &
ÿÎ
->
acc
->
luri
);

1759 ià(
”r
)

1760  
”r
;

1762 
	`šfo
("Œªsã¼šg c®ÈtØ%s\n", 
nuri
);

1764 
ÿÎ
->
sub
 = 
	`mem_d”ef
(call->sub);

1765 
”r
 = 
	`sev’t_d»ãr
(&
ÿÎ
->
sub
, 
	`uag_sev’t_sock
(),

1766 
	`s£ss_dŸlog
(
ÿÎ
->
£ss
), 
	`ua_cu£r
(ÿÎ->
ua
),

1767 
auth_hªdËr
, 
ÿÎ
->
acc
, 
Œue
,

1768 
ssub_nÙify_hªdËr
, 
ssub_şo£_hªdËr
,

1769 
ÿÎ
,

1770 "Reãr-To: %s\r\n", 
nuri
);

1771 ià(
”r
) {

1772 
	`w¬nšg
("ÿÎ: sev’t_d»ãr: %m\n", 
”r
);

1775 
	`mem_d”ef
(
nuri
);

1777  
”r
;

1778 
	}
}

1781 
	$ÿÎ_af
(cÚ¡ 
ÿÎ
 *call)

1783  
ÿÎ
 ? c®l->
af
 : 
AF_UNSPEC
;

1784 
	}
}

1787 
ušt16_t
 
	$ÿÎ_scode
(cÚ¡ 
ÿÎ
 *call)

1789  
ÿÎ
 ? c®l->
scode
 : 0;

1790 
	}
}

1793 
	$ÿÎ_£t_hªdËrs
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t_h
 *
eh
,

1794 
ÿÎ_dtmf_h
 *
dtmfh
, *
¬g
)

1796 ià(!
ÿÎ
)

1799 ià(
eh
)

1800 
ÿÎ
->
eh
 =ƒh;

1802 ià(
dtmfh
)

1803 
ÿÎ
->
dtmfh
 = dtmfh;

1805 ià(
¬g
)

1806 
ÿÎ
->
¬g
 =‡rg;

1807 
	}
}

1810 
	$ÿÎ_£t_x¹p¡©
(
ÿÎ
 *call)

1812 ià(!
ÿÎ
)

1815 
	`s£ss_£t_şo£_h—d”s
(
ÿÎ
->
£ss
,

1817 
audio_´št_¹p¡©
, 
ÿÎ
->
audio
);

1818 
	}
}

1821 
boŞ
 
	$ÿÎ_is_ÚhŞd
(cÚ¡ 
ÿÎ
 *call)

1823  
ÿÎ
 ? c®l->
Ú_hŞd
 : 
çl£
;

1824 
	}
}

1827 
boŞ
 
	$ÿÎ_is_outgošg
(cÚ¡ 
ÿÎ
 *call)

1829  
ÿÎ
 ? c®l->
outgošg
 : 
çl£
;

1830 
	}
}

1833 
	$ÿÎ_’abË_¹p_timeout
(
ÿÎ
 *ÿÎ, 
ušt32_t
 
timeout_ms
)

1835 ià(!
ÿÎ
)

1838 
ÿÎ
->
¹p_timeout_ms
 = 
timeout_ms
;

1839 
	}
}

1849 
ušt32_t
 
	$ÿÎ_lš’um
(cÚ¡ 
ÿÎ
 *call)

1851  
ÿÎ
 ? c®l->
lš’um
 : 0;

1852 
	}
}

1855 
ÿÎ
 *
	$ÿÎ_fšd_lš’um
(cÚ¡ 
li¡
 *
ÿÎs
, 
ušt32_t
 
lš’um
)

1857 
Ë
 *le;

1859 
Ë
 = 
	`li¡_h—d
(
ÿÎs
);†e;†ğË->
Ãxt
) {

1860 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

1862 ià(
lš’um
 =ğ
ÿÎ
->linenum)

1863  
ÿÎ
;

1866  
NULL
;

1867 
	}
}

1870 
	$ÿÎ_£t_cu¼’t
(
li¡
 *
ÿÎs
, 
ÿÎ
 *call)

1872 ià(!
ÿÎs
 || !
ÿÎ
)

1875 
	`li¡_uÆšk
(&
ÿÎ
->
Ë
);

1876 
	`li¡_­³nd
(
ÿÎs
, &
ÿÎ
->
Ë
, call);

1877 
	}
}

	@baresip/src/cmd.c

6 
	~<ùy³.h
>

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"cÜe.h
"

14 
	mKEYCODE_DEL
 = 0x7f,

15 
	mLONG_PREFIX
 = '/'

19 
	scmds
 {

20 
Ë
 
	mË
;

21 cÚ¡ 
cmd
 *
	mcmdv
;

22 
size_t
 
	mcmdc
;

25 
	scmd_ùx
 {

26 
mbuf
 *
	mmb
;

27 cÚ¡ 
cmd
 *
	mcmd
;

28 
boŞ
 
	mis_lÚg
;

31 
	scommªds
 {

32 
li¡
 
	mcmdl
;

36 
cmd_´št_®l
(
»_´štf
 *
pf
,

37 cÚ¡ 
commªds
 *commands,

38 
boŞ
 
´št_lÚg
, boŞ 
´št_shÜt
,

39 cÚ¡ *
m©ch
, 
size_t
 
m©ch_Ën
);

42 
	$de¡ruùÜ
(*
¬g
)

44 
cmds
 *cmd ğ
¬g
;

46 
	`li¡_uÆšk
(&
cmds
->
Ë
);

47 
	}
}

50 
	$ùx_de¡ruùÜ
(*
¬g
)

52 
cmd_ùx
 *
ùx
 = 
¬g
;

54 
	`mem_d”ef
(
ùx
->
mb
);

55 
	}
}

58 
	$commªds_de¡ruùÜ
(*
d©a
)

60 
commªds
 *commªd ğ
d©a
;

62 
	`li¡_æush
(&
commªds
->
cmdl
);

63 
	}
}

66 
	$ùx_®loc
(
cmd_ùx
 **
ùxp
, cÚ¡ 
cmd
 *cmd)

68 
cmd_ùx
 *
ùx
;

70 
ùx
 = 
	`mem_z®loc
((*ùx), 
ùx_de¡ruùÜ
);

71 ià(!
ùx
)

72  
ENOMEM
;

74 
ùx
->
mb
 = 
	`mbuf_®loc
(32);

75 ià(!
ùx
->
mb
) {

76 
	`mem_d”ef
(
ùx
);

77  
ENOMEM
;

80 
ùx
->
cmd
 = cmd;

82 *
ùxp
 = 
ùx
;

85 
	}
}

96 
cmds
 *
	$cmds_fšd
(cÚ¡ 
commªds
 *commands,

97 cÚ¡ 
cmd
 *
cmdv
)

99 
Ë
 *le;

101 ià(!
commªds
 || !
cmdv
)

102  
NULL
;

104 
Ë
 = 
commªds
->
cmdl
.
h—d
;†e;†ğË->
Ãxt
) {

105 
cmds
 *cmd ğ
Ë
->
d©a
;

107 ià(
cmds
->
cmdv
 == cmdv)

108  
cmds
;

111  
NULL
;

112 
	}
}

115 cÚ¡ 
cmd
 *
	$cmd_fšd_by_key
(cÚ¡ 
commªds
 *commands,

116 
key
)

118 
Ë
 *le;

120 ià(!
commªds
)

121  
NULL
;

123 
Ë
 = 
commªds
->
cmdl
.

;†e;†ğË->
´ev
) {

125 
cmds
 *cmd ğ
Ë
->
d©a
;

126 
size_t
 
i
;

128 
i
=0; i<
cmds
->
cmdc
; i++) {

130 cÚ¡ 
cmd
 *cmd = &
cmds
->
cmdv
[
i
];

132 ià(
cmd
->
key
 =ğkey && cmd->
h
)

133  
cmd
;

137  
NULL
;

138 
	}
}

141 cÚ¡ *
	$cmd_Çme
(*
buf
, 
size_t
 
sz
, cÚ¡ 
cmd
 *cmd)

143 
cmd
->
key
) {

147 
KEYCODE_ESC
:  "ESC";

150 
buf
[0] = 
cmd
->
key
;

151 
buf
[1] = '\0';

153 ià(
cmd
->
æags
 & 
CMD_PRM
)

154 
	`¡ºÿt
(
buf
, " ..", 
sz
-1);

156  
buf
;

157 
	}
}

160 
size_t
 
	$g‘_m©ch_lÚg
(cÚ¡ 
commªds
 *commands,

161 cÚ¡ 
cmd
 **
cmdp
,

162 cÚ¡ *
¡r
, 
size_t
 
Ën
)

164 
Ë
 *le;

165 
size_t
 
nm©ch
 = 0;

167 ià(!
commªds
)

170 
Ë
 = 
commªds
->
cmdl
.
h—d
;†e;†ğË->
Ãxt
) {

172 
cmds
 *cmd ğ
Ë
->
d©a
;

173 
size_t
 
i
;

175 
i
=0; i<
cmds
->
cmdc
; i++) {

177 cÚ¡ 
cmd
 *cmd = &
cmds
->
cmdv
[
i
];

179 ià(!
	`¡r_is£t
(
cmd
->
Çme
))

182 ià(
	`¡r_Ën
(
cmd
->
Çme
è>ğ
Ën
 &&

183 0 =ğ
	`memcmp
(
cmd
->
Çme
, 
¡r
, 
Ën
)) {

185 ++
nm©ch
;

186 *
cmdp
 = 
cmd
;

191  
nm©ch
;

192 
	}
}

195 
	$ed™Ü_šput
(
commªds
 *commªds, 
mbuf
 *
mb
, 
key
,

196 
»_´štf
 *
pf
, 
boŞ
 *
d–
, boŞ 
is_lÚg
)

198 
”r
 = 0;

200 
key
) {

202 
KEYCODE_ESC
:

203 *
d–
 = 
Œue
;

204  
	`»_h´štf
(
pf
, "\nCancel\n");

206 
KEYCODE_NONE
:

207 
KEYCODE_REL
:

211 *
d–
 = 
Œue
;

212  
	`»_h´štf
(
pf
, "\n");

215 
KEYCODE_DEL
:

216 ià(
mb
->
pos
 > 0) {

217 
”r
 |ğ
	`»_h´štf
(
pf
, "\b ");

218 
mb
->
pos
 = mb->
’d
 = (mb->pos - 1);

223 ià(
is_lÚg
) {

224 cÚ¡ 
cmd
 *cmd = 
NULL
;

225 
size_t
 
n
;

227 
”r
 = 
	`»_h´štf
(
pf
,

229 
mb
->
buf
, mb->
’d
);

230 ià(
”r
)

231  
”r
;

240 
”r
 = 
	`cmd_´št_®l
(
pf
, 
commªds
, 
Œue
, 
çl£
,

241 (*)
mb
->
buf
, mb->
’d
);

242 ià(
”r
)

243  
”r
;

245 
n
 = 
	`g‘_m©ch_lÚg
(
commªds
, &
cmd
,

246 (*)
mb
->
buf
, mb->
’d
);

247 ià(
n
 =ğ1 && 
cmd
) {

249 
mb
->
pos
 = 0;

250 
	`mbuf_wr™e_¡r
(
mb
, 
cmd
->
Çme
);

252 ià(
n
 == 0) {

253 
”r
 = 
	`»_h´štf
(
pf
, "(none)\n");

257 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
key
);

262 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
key
);

266 ià(
is_lÚg
) {

267 
”r
 |ğ
	`»_h´štf
(
pf
, "\r/%b",

268 
mb
->
buf
, mb->
’d
);

271 
”r
 |ğ
	`»_h´štf
(
pf
, "\r> %32b", 
mb
->
buf
, mb->
’d
);

273  
”r
;

274 
	}
}

277 
	$cmd_»pÜt
(cÚ¡ 
cmd
 *cmd, 
»_´štf
 *
pf
,

278 
mbuf
 *
mb
, 
boŞ
 
com¶
, *
d©a
)

280 
cmd_¬g
 
¬g
;

281 
”r
;

283 
	`mem£t
(&
¬g
, 0, (arg));

285 
mb
->
pos
 = 0;

286 
”r
 = 
	`mbuf_¡rdup
(
mb
, &
¬g
.
´m
, mb->
’d
);

287 ià(
”r
)

288  
”r
;

290 
¬g
.
key
 = 
cmd
->key;

291 
¬g
.
com¶‘e
 = 
com¶
;

292 
¬g
.
d©a
 = data;

294 
”r
 = 
cmd
->
	`h
(
pf
, &
¬g
);

296 
	`mem_d”ef
(
¬g
.
´m
);

298  
”r
;

299 
	}
}

313 
	$cmd_´oûss_lÚg
(
commªds
 *commªds, cÚ¡ *
¡r
, 
size_t
 
Ën
,

314 
»_´štf
 *
pf_»¥
, *
d©a
)

316 
cmd_¬g
 
¬g
;

317 cÚ¡ 
cmd
 *
cmd_lÚg
;

318 *
Çme
 = 
NULL
, *
´m
 = NULL;

319 
¶
 
¶_Çme
, 
¶_´m
;

320 
”r
;

322 ià(!
¡r
 || !
Ën
)

323  
EINVAL
;

325 
	`mem£t
(&
¬g
, 0, (arg));

327 
”r
 = 
	`»_»gex
(
¡r
, 
Ën
, "[^ ]+[ ]*[~]*", &
¶_Çme
, 
NULL
, &
¶_´m
);

328 ià(
”r
) {

329  
”r
;

332 
”r
 = 
	`¶_¡rdup
(&
Çme
, &
¶_Çme
);

333 ià(
	`¶_is£t
(&
¶_´m
))

334 
”r
 |ğ
	`¶_¡rdup
(&
´m
, &
¶_´m
);

335 ià(
”r
)

336 
out
;

338 
cmd_lÚg
 = 
	`cmd_fšd_lÚg
(
commªds
, 
Çme
);

339 ià(
cmd_lÚg
) {

341 
¬g
.
key
 = 
LONG_PREFIX
;

342 
¬g
.
´m
 =…rm;

343 
¬g
.
com¶‘e
 = 
Œue
;

344 
¬g
.
d©a
 = data;

346 ià(
cmd_lÚg
->
h
)

347 
”r
 = 
cmd_lÚg
->
	`h
(
pf_»¥
, &
¬g
);

350 
”r
 = 
	`»_h´štf
(
pf_»¥
, "commªd‚Ù found (%s)\n", 
Çme
);

353 
out
:

354 
	`mem_d”ef
(
Çme
);

355 
	`mem_d”ef
(
´m
);

357  
”r
;

358 
	}
}

361 
	$cmd_´oûss_ed™
(
commªds
 *commands,

362 
cmd_ùx
 **
ùxp
, 
key
,

363 
»_´štf
 *
pf
, *
d©a
)

365 
cmd_ùx
 *
ùx
;

366 
boŞ
 
com¶
 = (
key
 =ğ'\n'), 
d–
 = 
çl£
;

367 
”r
;

369 ià(!
ùxp
)

370  
EINVAL
;

372 
ùx
 = *
ùxp
;

374 
”r
 = 
	`ed™Ü_šput
(
commªds
, 
ùx
->
mb
, 
key
, 
pf
, &
d–
, ctx->
is_lÚg
);

375 ià(
”r
)

376  
”r
;

378 ià(
ùx
->
is_lÚg
) {

380 ià(
com¶
) {

382 
”r
 = 
	`cmd_´oûss_lÚg
(
commªds
,

383 (*)
ùx
->
mb
->
buf
,

384 
ùx
->
mb
->
’d
,

385 
pf
, 
d©a
);

389 ià(
com¶
 ||

390 (
ùx
->
cmd
 && ctx->cmd->
æags
 & 
CMD_PROG
))

391 
”r
 = 
	`cmd_»pÜt
(
ùx
->
cmd
, 
pf
, ctx->
mb
, 
com¶
, 
d©a
);

394 ià(
d–
)

395 *
ùxp
 = 
	`mem_d”ef
(*ctxp);

397  
”r
;

398 
	}
}

410 
	$cmd_»gi¡”
(
commªds
 *commands,

411 cÚ¡ 
cmd
 *
cmdv
, 
size_t
 
cmdc
)

413 
cmds
 *cmds;

414 
size_t
 
i
;

416 ià(!
commªds
 || !
cmdv
 || !
cmdc
)

417  
EINVAL
;

419 
cmds
 = 
	`cmds_fšd
(
commªds
, 
cmdv
);

420 ià(
cmds
)

421  
EALREADY
;

424 
i
=0; i<
cmdc
; i++) {

425 cÚ¡ 
cmd
 *cmd = &
cmdv
[
i
];

427 ià(
cmd
->
key
) {

428 cÚ¡ 
cmd
 *
x
 = 
	`cmd_fšd_by_key
(
commªds
,

429 
cmd
->
key
);

430 ià(
x
) {

431 
	`w¬nšg
("short command '%c'‡lready"

433 
x
->
key
, x->
desc
);

434  
EALREADY
;

438 ià(
cmd
->
key
 =ğ
LONG_PREFIX
) {

439 
	`w¬nšg
("cmd: cannot„egister command with"

440 " shÜˆkey '%c'\n", 
cmd
->
key
);

441  
EINVAL
;

444 ià(
	`¡r_is£t
(
cmd
->
Çme
) &&

445 
	`cmd_fšd_lÚg
(
commªds
, 
cmd
->
Çme
)) {

446 
	`w¬nšg
("cmd:†ong command '%s'‡lready„egistered\n",

447 
cmd
->
Çme
);

448  
EINVAL
;

452 
cmds
 = 
	`mem_z®loc
((*cmds), 
de¡ruùÜ
);

453 ià(!
cmds
)

454  
ENOMEM
;

456 
cmds
->
cmdv
 = cmdv;

457 
cmds
->
cmdc
 = cmdc;

459 
	`li¡_­³nd
(&
commªds
->
cmdl
, &
cmds
->
Ë
, cmds);

462 
	}
}

471 
	$cmd_uÄegi¡”
(
commªds
 *commªds, cÚ¡ 
cmd
 *
cmdv
)

473 
	`mem_d”ef
(
	`cmds_fšd
(
commªds
, 
cmdv
));

474 
	}
}

485 cÚ¡ 
cmd
 *
	$cmd_fšd_lÚg
(cÚ¡ 
commªds
 *commands,

486 cÚ¡ *
Çme
)

488 
Ë
 *le;

490 ià(!
commªds
 || !
Çme
)

491  
NULL
;

493 
Ë
 = 
commªds
->
cmdl
.

;†e;†ğË->
´ev
) {

495 
cmds
 *cmd ğ
Ë
->
d©a
;

496 
size_t
 
i
;

498 
i
=0; i<
cmds
->
cmdc
; i++) {

500 cÚ¡ 
cmd
 *cmd = &
cmds
->
cmdv
[
i
];

502 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
cmd
->Çmeè&& cmd->
h
)

503  
cmd
;

507  
NULL
;

508 
	}
}

522 
	$cmd_´oûss
(
commªds
 *commªds, 
cmd_ùx
 **
ùxp
, 
key
,

523 
»_´štf
 *
pf
, *
d©a
)

525 cÚ¡ 
cmd
 *cmd;

527 ià(!
commªds
)

528  
EINVAL
;

530 ià(
key
 =ğ
KEYCODE_NONE
) {

531 
	`w¬nšg
("cmd:…rocess: illegal keycode NONE\n");

532  
EINVAL
;

536 ià(
ùxp
 && *ctxp) {

538 ià(
key
 =ğ
KEYCODE_REL
)

541  
	`cmd_´oûss_ed™
(
commªds
, 
ùxp
, 
key
, 
pf
, 
d©a
);

544 
cmd
 = 
	`cmd_fšd_by_key
(
commªds
, 
key
);

545 ià(
cmd
) {

546 
cmd_¬g
 
¬g
;

549 ià(
cmd
->
æags
 & 
CMD_PRM
) {

551 
”r
 = 0;

553 ià(
ùxp
) {

554 
”r
 = 
	`ùx_®loc
(
ùxp
, 
cmd
);

555 ià(
”r
)

556  
”r
;

559 
key
 = 
	`isdig™
(keyè? key : 
KEYCODE_REL
;

561  
	`cmd_´oûss_ed™
(
commªds
, 
ùxp
, 
key
, 
pf
, 
d©a
);

564 
¬g
.
key
 = key;

565 
¬g
.
´m
 = 
NULL
;

566 
¬g
.
com¶‘e
 = 
Œue
;

567 
¬g
.
d©a
 = data;

569  
cmd
->
	`h
(
pf
, &
¬g
);

571 ià(
key
 =ğ
LONG_PREFIX
) {

573 
”r
;

575 
”r
 = 
	`»_h´štf
(
pf
, "%c", 
LONG_PREFIX
);

576 ià(
”r
)

577  
”r
;

579 ià(!
ùxp
) {

580 
	`w¬nšg
("cmd: ctxp is„equired\n");

581  
EINVAL
;

584 
”r
 = 
	`ùx_®loc
(
ùxp
, 
cmd
);

585 ià(
”r
)

586  
”r
;

588 (*
ùxp
)->
is_lÚg
 = 
Œue
;

592 ià(
key
 == '\t') {

593  
	`cmd_´št_®l
(
pf
, 
commªds
, 
çl£
, 
Œue
, 
NULL
, 0);

596 ià(
key
 =ğ
KEYCODE_REL
)

599  
	`cmd_´št
(
pf
, 
commªds
);

600 
	}
}

603 
	scmd_sÜt
 {

604 
Ë
 
	mË
;

605 cÚ¡ 
cmd
 *
	mcmd
;

609 
boŞ
 
	$sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

611 
cmd_sÜt
 *
cs1
 = 
Ë1
->
d©a
;

612 
cmd_sÜt
 *
cs2
 = 
Ë2
->
d©a
;

613 cÚ¡ 
cmd
 *
cmd1
 = 
cs1
->cmd;

614 cÚ¡ 
cmd
 *
cmd2
 = 
cs2
->cmd;

615 
boŞ
 
´št_lÚg
 = *(boŞ *)
¬g
;

617 ià(
´št_lÚg
) {

618  
	`¡r_ÿ£cmp
(
cs2
->
cmd
->
Çme
 ? cs2->cmd->name : "",

619 
cs1
->
cmd
->
Çme
 ? cs1->cmd->name : "") >= 0;

622  
	`tŞow”
(
cmd2
->
key
è>ğtŞow”(
cmd1
->key);

624 
	}
}

627 
	$cmd_´št_®l
(
»_´štf
 *
pf
,

628 cÚ¡ 
commªds
 *commands,

629 
boŞ
 
´št_lÚg
, boŞ 
´št_shÜt
,

630 cÚ¡ *
m©ch
, 
size_t
 
m©ch_Ën
)

632 
li¡
 
sÜ‹dl
 = 
LIST_INIT
;

633 
Ë
 *le;

634 
size_t
 
width_lÚg
 = 1;

635 
size_t
 
width_shÜt
 = 5;

636 
fmt
[64];

637 
buf
[16];

638 
”r
 = 0;

640 ià(!
commªds
)

641  
EINVAL
;

643 
Ë
 = 
commªds
->
cmdl
.
h—d
;†e;†ğË->
Ãxt
) {

645 
cmds
 *cmd ğ
Ë
->
d©a
;

646 
size_t
 
i
;

648 
i
=0; i<
cmds
->
cmdc
; i++) {

650 cÚ¡ 
cmd
 *cmd = &
cmds
->
cmdv
[
i
];

651 
cmd_sÜt
 *
cs
;

653 ià(
m©ch
 && 
m©ch_Ën
) {

655 ià(
	`¡r_Ën
(
cmd
->
Çme
è>ğ
m©ch_Ën
 &&

656 0 =ğ
	`memcmp
(
cmd
->
Çme
, 
m©ch
, 
m©ch_Ën
)) {

664 ià(!
	`¡r_is£t
(
cmd
->
desc
))

667 ià(
´št_shÜt
 && !
´št_lÚg
) {

669 ià(
cmd
->
key
 =ğ
KEYCODE_NONE
)

673 
cs
 = 
	`mem_z®loc
((*cs), 
NULL
);

674 ià(!
cs
) {

675 
”r
 = 
ENOMEM
;

676 
out
;

678 
cs
->
cmd
 = cmd;

680 
	`li¡_­³nd
(&
sÜ‹dl
, &
cs
->
Ë
, cs);

682 
width_lÚg
 = 
	`max
(width_lÚg, 1+
	`¡r_Ën
(
cmd
->
Çme
)+3);

686 
	`li¡_sÜt
(&
sÜ‹dl
, 
sÜt_hªdËr
, &
´št_lÚg
);

688 ià(
	`»_¢´štf
(
fmt
, (fmt),

690 
width_lÚg
, 
width_shÜt
) < 0) {

691 
”r
 = 
ENOMEM
;

692 
out
;

695 
Ë
 = 
sÜ‹dl
.
h—d
;†e;†ğË->
Ãxt
) {

696 
cmd_sÜt
 *
cs
 = 
Ë
->
d©a
;

697 cÚ¡ 
cmd
 *cmd = 
cs
->cmd;

698 
Çm•
[64] = "";

700 ià(
´št_lÚg
 && 
	`¡r_is£t
(
cmd
->
Çme
)) {

701 
	`»_¢´štf
(
Çm•
, (namep), "%c%s%s",

702 
LONG_PREFIX
, 
cmd
->
Çme
,

703 (
cmd
->
æags
 & 
CMD_PRM
) ? " .." : "");

706 
”r
 |ğ
	`»_h´štf
(
pf
, 
fmt
,

707 
Çm•
,

708 (
´št_shÜt
 && 
cmd
->
key
)

709 ? 
	`cmd_Çme
(
buf
, (buf), 
cmd
)

711 
cmd
->
desc
);

714 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

716 
out
:

717 
	`li¡_æush
(&
sÜ‹dl
);

718  
”r
;

719 
	}
}

730 
	$cmd_´št
(
»_´štf
 *
pf
, cÚ¡ 
commªds
 *commands)

732 
”r
 = 0;

734 ià(!
pf
)

735  
EINVAL
;

737 
”r
 |ğ
	`»_h´štf
(
pf
, "--- Help ---\n");

738 
”r
 |ğ
	`cmd_´št_®l
(
pf
, 
commªds
, 
Œue
,rue, 
NULL
, 0);

739 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

741  
”r
;

742 
	}
}

752 
	$cmd_š™
(
commªds
 **
commªd¥
)

754 
commªds
 *commands;

756 ià(!
commªd¥
)

757  
EINVAL
;

759 
commªds
 = 
	`mem_z®loc
((*commªds), 
commªds_de¡ruùÜ
);

760 ià(!
commªds
)

761  
ENOMEM
;

763 
	`li¡_š™
(&
commªds
->
cmdl
);

765 *
commªd¥
 = 
commªds
;

768 
	}
}

	@baresip/src/conf.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#_BSD_SOURCE
 1

	)

8 
	~<fú.h
>

9 #ifdeà
HAVE_UNISTD_H


10 
	~<uni¡d.h
>

12 
	~<¡dio.h
>

13 
	~<sys/¡©.h
>

14 #ifdeà
HAVE_IO_H


15 
	~<io.h
>

17 
	~<».h
>

18 
	~<»m.h
>

19 
	~<b¬es.h
>

20 
	~"cÜe.h
"

23 
	#DEBUG_MODULE
 ""

	)

24 
	#DEBUG_LEVEL
 0

	)

25 
	~<»_dbg.h
>

28 #ifdeà
WIN32


29 
	#İ’
 
_İ’


	)

30 
	#»ad
 
_»ad


	)

31 
	#şo£
 
_şo£


	)

35 #ià
defšed
 (
WIN32
)

36 
	#DIR_SEP
 "\\"

	)

38 
	#DIR_SEP
 "/"

	)

42 cÚ¡ *
	gcÚf_·th
 = 
NULL
;

43 
cÚf
 *
	gcÚf_obj
;

53 
boŞ
 
	$cÚf_f“xi¡
(cÚ¡ *
·th
)

55 
¡©
 
¡
;

57 ià(!
·th
)

58  
çl£
;

60 ià(
	`¡©
(
·th
, &
¡
) < 0)

61  
çl£
;

63 ià((
¡
.
¡_mode
 & 
S_IFMT
è!ğ
S_IFREG
)

64  
çl£
;

66  
¡
.
¡_size
 > 0;

67 
	}
}

70 
	$´št_pİuÏ‹d
(cÚ¡ *
wh©
, 
ušt32_t
 
n
)

72 
	`šfo
("PİuÏ‹d %u %s%s\n", 
n
, 
wh©
, 1==n ? "" : "s");

73 
	}
}

85 
	$cÚf_·r£
(cÚ¡ *
f’ame
, 
cÚæše_h
 *
ch
, *
¬g
)

87 
¶
…l, 
v®
;

88 
mbuf
 *
mb
;

89 
”r
 = 0, 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

90 ià(
fd
 < 0)

91  
”ºo
;

93 
mb
 = 
	`mbuf_®loc
(1024);

94 ià(!
mb
) {

95 
”r
 = 
ENOMEM
;

96 
out
;

100 
ušt8_t
 
buf
[1024];

102 cÚ¡ 
ssize_t
 
n
 = 
	`»ad
(
fd
, (*)
buf
, (buf));

103 ià(
n
 < 0) {

104 
”r
 = 
”ºo
;

107 ià(
n
 == 0)

110 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
buf
, 
n
);

113 
¶
.
p
 = (cÚ¡ *)
mb
->
buf
;

114 
¶
.
l
 = 
mb
->
’d
;

116 
¶
.
p
 < ((cÚ¡ *)
mb
->
buf
 + mb->
’d
è&& !
”r
) {

117 cÚ¡ *
lb
 = 
	`¶_¡rchr
(&
¶
, '\n');

119 
v®
.
p
 = 
¶
.p;

120 
v®
.
l
 = 
lb
 ? (
ušt32_t
)Öb - 
¶
.
p
) :…l.l;

121 
	`¶_advªû
(&
¶
, 
v®
.
l
 + 1);

123 ià(!
v®
.
l
 || v®.
p
[0] == '#')

126 
”r
 = 
	`ch
(&
v®
, 
¬g
);

129 
out
:

130 
	`mem_d”ef
(
mb
);

131 ()
	`şo£
(
fd
);

133  
”r
;

134 
	}
}

142 
	$cÚf_·th_£t
(cÚ¡ *
·th
)

144 
cÚf_·th
 = 
·th
;

145 
	}
}

156 
	$cÚf_·th_g‘
(*
·th
, 
size_t
 
sz
)

158 
buf
[
FS_PATH_MAX
];

159 
”r
;

162 ià(
cÚf_·th
) {

163 ià(
	`»_¢´štf
(
·th
, 
sz
, "%s", 
cÚf_·th
) < 0)

164  
ENOMEM
;

168 #ifdeà
CONFIG_PATH


169 
	`¡r_nıy
(
buf
, 
CONFIG_PATH
, (buf));

170 ()
”r
;

172 
”r
 = 
	`fs_g‘home
(
buf
, (buf));

173 ià(
”r
)

174  
”r
;

177 ià(
	`»_¢´štf
(
·th
, 
sz
, "%s" 
DIR_SEP
 ".b¬es", 
buf
) < 0)

178  
ENOMEM
;

181 
	}
}

184 
	$cÚf_g‘_¿nge
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

185 
¿nge
 *
ºg
)

187 
¶
 
r
, 
mš
, 
max
;

188 
ušt32_t
 
v
;

189 
”r
;

191 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
r
);

192 ià(
”r
)

193  
”r
;

195 
”r
 = 
	`»_»gex
(
r
.
p
,„.
l
, "[0-9]+-[0-9]+", &
mš
, &
max
);

196 ià(
”r
) {

198 
”r
 = 
	`cÚf_g‘_u32
(
cÚf
, 
Çme
, &
v
);

199 ià(
”r
) {

200 
	`w¬nšg
("conf: %s: could‚ot…arse„ange: (%r)\n",

201 
Çme
, &
r
);

202  
”r
;

205 
ºg
->
mš
 =„ng->
max
 = 
v
;

207  
”r
;

210 
ºg
->
mš
 = 
	`¶_u32
(&min);

211 
ºg
->
max
 = 
	`¶_u32
(&max);

213 ià(
ºg
->
mš
 >„ng->
max
) {

214 
	`w¬nšg
("conf: %s: invalid„ange (%u - %u)\n",

215 
Çme
, 
ºg
->
mš
,„ng->
max
);

216  
EINVAL
;

220 
	}
}

223 
	$cÚf_g‘_csv
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

224 *
¡r1
, 
size_t
 
sz1
, *
¡r2
, size_ˆ
sz2
)

226 
¶
 
r
, 
¶1
, 
¶2
 = 
¶_nuÎ
;

227 
”r
;

229 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
r
);

230 ià(
”r
)

231  
”r
;

234 
”r
 = 
	`»_»gex
(
r
.
p
,„.
l
, "[^,]+,[~]*", &
¶1
, &
¶2
);

235 ià(
”r
)

236  
”r
;

238 ()
	`¶_¡rıy
(&
¶1
, 
¡r1
, 
sz1
);

239 ià(
	`¶_is£t
(&
¶2
))

240 ()
	`¶_¡rıy
(&
¶2
, 
¡r2
, 
sz2
);

243 
	}
}

246 
	$cÚf_g‘_vidsz
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
vidsz
 *
sz
)

248 
¶
 
r
, 
w
, 
h
;

249 
”r
;

251 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
r
);

252 ià(
”r
)

253  
”r
;

255 
w
.
l
 = 
h
.l = 0;

256 
”r
 = 
	`»_»gex
(
r
.
p
,„.
l
, "[0-9]+x[0-9]+", &
w
, &
h
);

257 ià(
”r
)

258  
”r
;

260 ià(
	`¶_is£t
(&
w
è&&…l_is£t(&
h
)) {

261 
sz
->
w
 = 
	`¶_u32
(&w);

262 
sz
->
h
 = 
	`¶_u32
(&h);

266 ià(
sz
->
w
 & 0x1 || sz->
h
 & 0x1) {

267 
	`w¬nšg
("conf: %s: should be multiple of 2 (%u x %u)\n",

268 
Çme
, 
sz
->
w
, sz->
h
);

269  
EINVAL
;

273 
	}
}

276 
	$cÚf_g‘_§
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
§
 *sa)

278 
¶
 
İt
;

279 
”r
;

281 ià(!
cÚf
 || !
Çme
 || !
§
)

282  
EINVAL
;

284 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
İt
);

285 ià(
”r
)

286  
”r
;

288  
	`§_decode
(
§
, 
İt
.
p
, o±.
l
);

289 
	}
}

297 
	$cÚf_cÚfigu»
()

299 
·th
[
FS_PATH_MAX
], 
fe
[FS_PATH_MAX];

300 
”r
;

302 #ià
	`defšed
 (
WIN32
)

303 
	`dbg_š™
(
DBG_INFO
, 
DBG_NONE
);

306 
”r
 = 
	`cÚf_·th_g‘
(
·th
, (path));

307 ià(
”r
) {

308 
	`w¬nšg
("cÚf: could‚Ù g‘ cÚfig…©h: %m\n", 
”r
);

309  
”r
;

312 ià(
	`»_¢´štf
(
fe
, (fe), "%s/cÚfig", 
·th
) < 0)

313  
ENOMEM
;

315 ià(!
	`cÚf_f“xi¡
(
fe
)) {

317 ()
	`fs_mkdœ
(
·th
, 0700);

319 
”r
 = 
	`cÚfig_wr™e_‹m¶©e
(
fe
, 
	`cÚf_cÚfig
());

320 ià(
”r
)

321 
out
;

324 
cÚf_obj
 = 
	`mem_d”ef
(conf_obj);

325 
”r
 = 
	`cÚf_®loc
(&
cÚf_obj
, 
fe
);

326 ià(
”r
)

327 
out
;

329 
”r
 = 
	`cÚfig_·r£_cÚf
(
	`cÚf_cÚfig
(), 
cÚf_obj
);

330 ià(
”r
)

331 
out
;

333 
out
:

334  
”r
;

335 
	}
}

345 
	$cÚf_moduËs
()

347 
”r
;

349 
”r
 = 
	`moduË_š™
(
cÚf_obj
);

350 ià(
”r
) {

351 
	`w¬nšg
("cÚf: cÚfigu» moduË…¬£ƒ¼Ü (%m)\n", 
”r
);

352 
out
;

355 
	`´št_pİuÏ‹d
("audiØcodec", 
	`li¡_couÁ
(
	`b¬es_aucodeş
()));

356 
	`´št_pİuÏ‹d
("audiØf‹r", 
	`li¡_couÁ
(
	`b¬es_auf
()));

357 #ifdeà
USE_VIDEO


358 
	`´št_pİuÏ‹d
("videØcodec", 
	`li¡_couÁ
(
	`b¬es_vidcodeş
()));

359 
	`´št_pİuÏ‹d
("videØf‹r", 
	`li¡_couÁ
(
	`b¬es_vidf
()));

362 
out
:

363  
”r
;

364 
	}
}

374 
cÚf
 *
	$cÚf_cur
()

376 ià(!
cÚf_obj
) {

377 
	`w¬nšg
("conf:‚o config object\n");

379  
cÚf_obj
;

380 
	}
}

383 
	$cÚf_şo£
()

385 
cÚf_obj
 = 
	`mem_d”ef
(conf_obj);

386 
	}
}

	@baresip/src/config.c

6 
	~<¡ršg.h
>

7 
	~<dœ’t.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"cÜe.h
"

14 #undeà
MOD_PRE


15 
	#MOD_PRE
 ""

	)

18 #undeà
SA_INIT


19 
	#SA_INIT
 { { {0} }, 0}

	)

22 #iâdeà
PREFIX


23 
	#PREFIX
 "/u¤"

	)

28 
cÚfig
 
	gcÜe_cÚfig
 = {

46 
PREFIX
 "/share/baresip",

56 
çl£
,

57 
AUDIO_MODE_POLL
,

58 
çl£
,

59 
AUFMT_S16LE
,

60 
AUFMT_S16LE
,

63 #ifdeà
USE_VIDEO


71 
Œue
,

80 
Œue
,

81 
çl£
,

83 
çl£
,

94 #ifdeà
USE_VIDEO


103 
çl£


108 
	$¿nge_´št
(
»_´štf
 *
pf
, cÚ¡ 
¿nge
 *
ºg
)

110 ià(!
ºg
)

113  
	`»_h´štf
(
pf
, "%u-%u", 
ºg
->
mš
,„ng->
max
);

114 
	}
}

117 
	$dns_£rv”_hªdËr
(cÚ¡ 
¶
 *¶, *
¬g
)

119 
cÚfig_Ãt
 *
cfg
 = 
¬g
;

120 cÚ¡ 
size_t
 
max_couÁ
 = 
	`ARRAY_SIZE
(
cfg
->
nsv
);

121 
”r
;

123 ià(
cfg
->
nsc
 >ğ
max_couÁ
) {

124 
	`w¬nšg
("config:oo many DNS‚ameservers (max %zu)\n",

125 
max_couÁ
);

126  
EOVERFLOW
;

130 
”r
 = 
	`¶_¡rıy
(
¶
, 
cfg
->
nsv
[cfg->
nsc
].
addr
,

131 (
cfg
->
nsv
[0].
addr
));

132 ià(
”r
) {

133 
	`w¬nšg
("config: dns_server: could‚ot copy string (%r)\n",

134 
¶
);

135  
”r
;

138 ++
cfg
->
nsc
;

141 
	}
}

144 
aufmt
 
	$»sŞve_aufmt
(cÚ¡ 
¶
 *
fmt
)

146 ià(0 =ğ
	`¶_¡rÿ£cmp
(
fmt
, "s16")è 
AUFMT_S16LE
;

147 ià(0 =ğ
	`¶_¡rÿ£cmp
(
fmt
, "æßt")è 
AUFMT_FLOAT
;

148 ià(0 =ğ
	`¶_¡rÿ£cmp
(
fmt
, "s24_3Ë")è 
AUFMT_S24_3LE
;

151 ià(0 =ğ
	`¶_¡rÿ£cmp
(
fmt
, "s16Ë")è 
AUFMT_S16LE
;

153  (
aufmt
)-1;

154 
	}
}

157 
	$cÚf_g‘_aufmt
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

158 *
fm
)

160 
¶
…l;

161 
fmt
;

162 
”r
;

164 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
¶
);

165 ià(
”r
)

166  
”r
;

168 
fmt
 = 
	`»sŞve_aufmt
(&
¶
);

169 ià(
fmt
 == -1) {

170 
	`w¬nšg
("config: %s: sample format‚ot supported"

171 " (%r)\n", 
Çme
, &
¶
);

172  
EINVAL
;

175 *
fm
 = 
fmt
;

178 
	}
}

189 
	$cÚfig_·r£_cÚf
(
cÚfig
 *
cfg
, cÚ¡ 
cÚf
 *conf)

191 
¶
 
pŞlm
, 
as
, 
­
;

192 
pŞl_m‘hod
 
m‘hod
;

193 
vidsz
 
size
 = {0, 0};

194 
¶
 
txmode
;

195 
ušt32_t
 
v
;

196 
”r
 = 0;

198 ià(!
cfg
 || !
cÚf
)

199  
EINVAL
;

202 ià(0 =ğ
	`cÚf_g‘
(
cÚf
, "pŞl_m‘hod", &
pŞlm
)) {

203 ià(0 =ğ
	`pŞl_m‘hod_ty³
(&
m‘hod
, &
pŞlm
)) {

204 
”r
 = 
	`pŞl_m‘hod_£t
(
m‘hod
);

205 ià(
”r
) {

206 
	`w¬nšg
("config:…oll method (%r) set: %m\n",

207 &
pŞlm
, 
”r
);

211 
	`w¬nšg
("cÚfig: unknowÀpŞÈm‘hod (%r)\n", &
pŞlm
);

216 ()
	`cÚf_g‘_u32
(
cÚf
, "s_Œªs_bsize", &
cfg
->
s
.
Œªs_bsize
);

217 ()
	`cÚf_g‘_¡r
(
cÚf
, "s_li¡’", 
cfg
->
s
.
loÿl
,

218 (
cfg
->
s
.
loÿl
));

219 ()
	`cÚf_g‘_¡r
(
cÚf
, "s_û¹ifiÿ‹", 
cfg
->
s
.
û¹
,

220 (
cfg
->
s
.
û¹
));

223 ()
	`cÚf_g‘_u32
(
cÚf
, "call_local_timeout",

224 &
cfg
->
ÿÎ
.
loÿl_timeout
);

225 ()
	`cÚf_g‘_u32
(
cÚf
, "call_max_calls",

226 &
cfg
->
ÿÎ
.
max_ÿÎs
);

229 ()
	`cÚf_g‘_¡r
(
cÚf
, "audio_·th", 
cfg
->
audio
.
audio_·th
,

230 (
cfg
->
audio
.
audio_·th
));

231 ()
	`cÚf_g‘_csv
(
cÚf
, "audio_player",

232 
cfg
->
audio
.
¶ay_mod
,

233 (
cfg
->
audio
.
¶ay_mod
),

234 
cfg
->
audio
.
¶ay_dev
,

235 (
cfg
->
audio
.
¶ay_dev
));

237 ()
	`cÚf_g‘_csv
(
cÚf
, "audio_source",

238 
cfg
->
audio
.
¤c_mod
, (cfg->audio.src_mod),

239 
cfg
->
audio
.
¤c_dev
, (cfg->audio.src_dev));

241 ()
	`cÚf_g‘_csv
(
cÚf
, "audio_alert",

242 
cfg
->
audio
.
®”t_mod
,

243 (
cfg
->
audio
.
®”t_mod
),

244 
cfg
->
audio
.
®”t_dev
,

245 (
cfg
->
audio
.
®”t_dev
));

247 ()
	`cÚf_g‘_¿nge
(
cÚf
, "audio_¤©e", &
cfg
->
audio
.
¤©e
);

248 ()
	`cÚf_g‘_¿nge
(
cÚf
, "audio_chªÃls", &
cfg
->
audio
.
chªÃls
);

249 ()
	`cÚf_g‘_u32
(
cÚf
, "au¤c_¤©e", &
cfg
->
audio
.
¤©e_¤c
);

250 ()
	`cÚf_g‘_u32
(
cÚf
, "au¶ay_¤©e", &
cfg
->
audio
.
¤©e_¶ay
);

251 ()
	`cÚf_g‘_u32
(
cÚf
, "au¤c_chªÃls", &
cfg
->
audio
.
chªÃls_¤c
);

252 ()
	`cÚf_g‘_u32
(
cÚf
, "au¶ay_chªÃls", &
cfg
->
audio
.
chªÃls_¶ay
);

254 ià(0 =ğ
	`cÚf_g‘
(
cÚf
, "audio_sourû", &
as
) &&

255 0 =ğ
	`cÚf_g‘
(
cÚf
, "audio_¶ay”", &
­
))

256 
cfg
->
audio
.
¤c_fœ¡
 = 
as
.
p
 < 
­
.p;

258 ià(0 =ğ
	`cÚf_g‘
(
cÚf
, "audio_txmode", &
txmode
)) {

260 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
txmode
, "poll"))

261 
cfg
->
audio
.
txmode
 = 
AUDIO_MODE_POLL
;

262 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
txmode
, "thread"))

263 
cfg
->
audio
.
txmode
 = 
AUDIO_MODE_THREAD
;

265 
	`w¬nšg
("unsuµÜ‹d‡udiØtxmod(%r)\n", &
txmode
);

269 ()
	`cÚf_g‘_boŞ
(
cÚf
, "audio_Ëv–", &
cfg
->
audio
.
Ëv–
);

271 
	`cÚf_g‘_aufmt
(
cÚf
, "au¤c_fÜm©", &
cfg
->
audio
.
¤c_fmt
);

272 
	`cÚf_g‘_aufmt
(
cÚf
, "au¶ay_fÜm©", &
cfg
->
audio
.
¶ay_fmt
);

274 #ifdeà
USE_VIDEO


276 ()
	`cÚf_g‘_csv
(
cÚf
, "video_source",

277 
cfg
->
video
.
¤c_mod
, (cfg->video.src_mod),

278 
cfg
->
video
.
¤c_dev
, (cfg->video.src_dev));

279 ()
	`cÚf_g‘_csv
(
cÚf
, "video_display",

280 
cfg
->
video
.
di¥_mod
, (cfg->video.disp_mod),

281 
cfg
->
video
.
di¥_dev
, (cfg->video.disp_dev));

282 ià(0 =ğ
	`cÚf_g‘_vidsz
(
cÚf
, "video_size", &
size
)) {

283 
cfg
->
video
.
width
 = 
size
.
w
;

284 
cfg
->
video
.
height
 = 
size
.
h
;

286 ()
	`cÚf_g‘_u32
(
cÚf
, "video_b™¿‹", &
cfg
->
video
.
b™¿‹
);

287 ()
	`cÚf_g‘_u32
(
cÚf
, "video_ås", &
cfg
->
video
.
ås
);

288 ()
	`cÚf_g‘_boŞ
(
cÚf
, "video_fuÎsü“n", &
cfg
->
video
.
fuÎsü“n
);

290 ()
size
;

294 ià(0 =ğ
	`cÚf_g‘_u32
(
cÚf
, "¹p_tos", &
v
))

295 
cfg
->
avt
.
¹p_tos
 = 
v
;

296 ()
	`cÚf_g‘_¿nge
(
cÚf
, "¹p_pÜts", &
cfg
->
avt
.
¹p_pÜts
);

297 ià(0 =ğ
	`cÚf_g‘_¿nge
(
cÚf
, "rtp_bandwidth",

298 &
cfg
->
avt
.
¹p_bw
)) {

299 
cfg
->
avt
.
¹p_bw
.
mš
 *= 1000;

300 
cfg
->
avt
.
¹p_bw
.
max
 *= 1000;

302 ()
	`cÚf_g‘_boŞ
(
cÚf
, "¹ı_’abË", &
cfg
->
avt
.
¹ı_’abË
);

303 ()
	`cÚf_g‘_boŞ
(
cÚf
, "¹ı_mux", &
cfg
->
avt
.
¹ı_mux
);

304 ()
	`cÚf_g‘_¿nge
(
cÚf
, "jitter_buffer_delay",

305 &
cfg
->
avt
.
jbuf_d–
);

306 ()
	`cÚf_g‘_boŞ
(
cÚf
, "¹p_¡©s", &
cfg
->
avt
.
¹p_¡©s
);

307 ()
	`cÚf_g‘_u32
(
cÚf
, "¹p_timeout", &
cfg
->
avt
.
¹p_timeout
);

309 ià(
”r
) {

310 
	`w¬nšg
("cÚfig: cÚfigu»…¬£ƒ¼Ü (%m)\n", 
”r
);

314 ()
	`cÚf_­¶y
(
cÚf
, "dns_£rv”", 
dns_£rv”_hªdËr
, &
cfg
->
Ãt
);

315 ()
	`cÚf_g‘_¡r
(
cÚf
, "net_interface",

316 
cfg
->
Ãt
.
iâame
, (cfg->net.ifname));

318 #ifdeà
USE_VIDEO


320 ()
	`cÚf_g‘_¡r
(
cÚf
, "bfı_´Ùo", 
cfg
->
bfı
.
´Ùo
,

321 (
cfg
->
bfı
.
´Ùo
));

325 ()
	`cÚf_g‘_boŞ
(
cÚf
, "sdp_ebuac", &
cfg
->
sdp
.
ebuac
);

327  
”r
;

328 
	}
}

339 
	$cÚfig_´št
(
»_´štf
 *
pf
, cÚ¡ 
cÚfig
 *
cfg
)

341 
”r
;

343 ià(!
cfg
)

346 
”r
 = 
	`»_h´štf
(
pf
,

370 #ifdeà
USE_VIDEO


392 #ifdeà
USE_VIDEO


399 
cfg
->
s
.
Œªs_bsize
, cfg->s.
loÿl
, cfg->s.
û¹
,

401 
cfg
->
ÿÎ
.
loÿl_timeout
,

402 
cfg
->
ÿÎ
.
max_ÿÎs
,

404 
cfg
->
audio
.
audio_·th
,

405 
cfg
->
audio
.
¶ay_mod
, cfg->audio.
¶ay_dev
,

406 
cfg
->
audio
.
¤c_mod
, cfg->audio.
¤c_dev
,

407 
cfg
->
audio
.
®”t_mod
, cfg->audio.
®”t_dev
,

408 
¿nge_´št
, &
cfg
->
audio
.
¤©e
,

409 
¿nge_´št
, &
cfg
->
audio
.
chªÃls
,

410 
cfg
->
audio
.
¤©e_¶ay
, cfg->audio.
¤©e_¤c
,

411 
cfg
->
audio
.
chªÃls_¶ay
, cfg->audio.
chªÃls_¤c
,

412 
cfg
->
audio
.
Ëv–
 ? "yes" : "no",

414 #ifdeà
USE_VIDEO


415 
cfg
->
video
.
¤c_mod
, cfg->video.
¤c_dev
,

416 
cfg
->
video
.
di¥_mod
, cfg->video.
di¥_dev
,

417 
cfg
->
video
.
width
, cfg->video.
height
,

418 
cfg
->
video
.
b™¿‹
, cfg->video.
ås
,

421 
cfg
->
avt
.
¹p_tos
,

422 
¿nge_´št
, &
cfg
->
avt
.
¹p_pÜts
,

423 
¿nge_´št
, &
cfg
->
avt
.
¹p_bw
,

424 
cfg
->
avt
.
¹ı_’abË
 ? "yes" : "no",

425 
cfg
->
avt
.
¹ı_mux
 ? "yes" : "no",

426 
¿nge_´št
, &
cfg
->
avt
.
jbuf_d–
,

427 
cfg
->
avt
.
¹p_¡©s
 ? "yes" : "no",

428 
cfg
->
avt
.
¹p_timeout
,

430 
cfg
->
Ãt
.
iâame


432 #ifdeà
USE_VIDEO


433 ,
cfg
->
bfı
.
´Ùo


437  
”r
;

438 
	}
}

441 cÚ¡ *
	$deçuÉ_audio_deviû
()

443 #ià
	`defšed
 (
ANDROID
)

445 #–ià
	`defšed
 (
DARWIN
)

447 #–ià
	`defšed
 (
FREEBSD
)

449 #–ià
	`defšed
 (
OPENBSD
)

451 #–ià
	`defšed
 (
WIN32
)

456 
	}
}

459 #ifdeà
USE_VIDEO


460 cÚ¡ *
	$deçuÉ_video_deviû
()

462 #ifdeà
DARWIN


464 #ifdeà
QTCAPTURE_RUNLOOP


473 
	}
}

476 cÚ¡ *
	$deçuÉ_video_di¥Ïy
()

478 #ifdeà
DARWIN


483 
	}
}

487 
	$deçuÉ_š‹rçû_´št
(
»_´štf
 *
pf
, *
unu£d
)

489 
iâame
[64];

490 ()
unu£d
;

492 ià(0 =ğ
	`Ãt_¹_deçuÉ_g‘
(
AF_INET
, 
iâame
, (ifname)))

493  
	`»_h´štf
(
pf
, "%s", 
iâame
);

495  
	`»_h´štf
(
pf
, "eth0");

496 
	}
}

499 
	$cÜe_cÚfig_‹m¶©e
(
»_´štf
 *
pf
, cÚ¡ 
cÚfig
 *
cfg
)

501 
”r
 = 0;

503 ià(!
cfg
)

506 
”r
 |ğ
	`»_h´štf
(
pf
,

509 #ifdeà
HAVE_EPOLL


512 #ifdeà
HAVE_KQUEUE


526 #ià
	`defšed
 (
PREFIX
)

527 "#audio_·th\t\t" 
PREFIX
 "/share/baresip\n"

545 
	`pŞl_m‘hod_Çme
(
	`pŞl_m‘hod_be¡
()),

546 
cfg
->
ÿÎ
.
loÿl_timeout
,

547 
cfg
->
ÿÎ
.
max_ÿÎs
,

548 
	`deçuÉ_audio_deviû
(),

549 
	`deçuÉ_audio_deviû
(),

550 
	`deçuÉ_audio_deviû
(),

551 
cfg
->
audio
.
¤©e
.
mš
, cfg->audio.¤©e.
max
,

552 
cfg
->
audio
.
chªÃls
.
mš
, cfg->audio.chªÃls.
max


555 #ifdeà
USE_VIDEO


556 
”r
 |ğ
	`»_h´štf
(
pf
,

564 
	`deçuÉ_video_deviû
(),

565 
	`deçuÉ_video_di¥Ïy
(),

566 
cfg
->
video
.
width
, cfg->video.
height
,

567 
cfg
->
video
.
b™¿‹
, cfg->video.
ås
);

570 
”r
 |ğ
	`»_h´štf
(
pf
,

583 
cfg
->
avt
.
jbuf_d–
.
mš
, cfg->avt.jbuf_d–.
max
,

584 
deçuÉ_š‹rçû_´št
, 
NULL
);

586 #ifdeà
USE_VIDEO


587 
”r
 |ğ
	`»_h´štf
(
pf
,

592  
”r
;

593 
	}
}

596 
ušt32_t
 
	$couÁ_moduËs
(cÚ¡ *
·th
)

598 
DIR
 *
dœp
;

599 
dœ’t
 *
dp
;

600 
ušt32_t
 
n
 = 0;

602 
dœp
 = 
	`İ’dœ
(
·th
);

603 ià(!
dœp
)

606 (
dp
 = 
	`»addœ
(
dœp
)è!ğ
NULL
) {

608 
size_t
 
Ën
 = 
	`¡¾’
(
dp
->
d_Çme
);

609 cÚ¡ 
size_t
 
x
 = (
MOD_EXT
)-1;

611 ià(
Ën
 <ğ
x
)

614 ià(0==
	`memcmp
(&
dp
->
d_Çme
[
Ën
-
x
], 
MOD_EXT
, x))

615 ++
n
;

618 ()
	`şo£dœ
(
dœp
);

620  
n
;

621 
	}
}

624 cÚ¡ *
	$d‘eù_moduË_·th
(
boŞ
 *
v®id
)

626 cÚ¡ * cÚ¡ 
·thv
[] = {

627 #ià
	`defšed
 (
PREFIX
)

628 "" 
PREFIX
 "/lib/baresip/modules",

634 cÚ¡ *
cu¼’t
 = 
·thv
[0];

635 
ušt32_t
 
nmax
 = 0;

636 
size_t
 
i
;

638 
i
=0; i<
	`ARRAY_SIZE
(
·thv
); i++) {

640 
ušt32_t
 
n
 = 
	`couÁ_moduËs
(
·thv
[
i
]);

642 
	`šfo
("%s: d‘eùed %u moduËs\n", 
·thv
[
i
], 
n
);

644 ià(
n
 > 
nmax
) {

645 
nmax
 = 
n
;

646 
cu¼’t
 = 
·thv
[
i
];

650 ià(
nmax
 > 0)

651 *
v®id
 = 
Œue
;

653  
cu¼’t
;

654 
	}
}

665 
	$cÚfig_wr™e_‹m¶©e
(cÚ¡ *
fe
, cÚ¡ 
cÚfig
 *
cfg
)

667 
FILE
 *
f
 = 
NULL
;

668 
”r
 = 0;

669 cÚ¡ *
mod·th
;

670 
boŞ
 
mod·th_v®id
 = 
çl£
;

672 ià(!
fe
 || !
cfg
)

673  
EINVAL
;

675 
	`šfo
("cÚfig: c»©šg cÚfigem¶©%s\n", 
fe
);

677 
f
 = 
	`fİ’
(
fe
, "w");

678 ià(!
f
) {

679 
	`w¬nšg
("cÚfig: wr™šg %s: %m\n", 
fe
, 
”ºo
);

680  
”ºo
;

683 ()
	`»_årštf
(
f
,

691 ()
	`»_årštf
(
f
, "%H", 
cÜe_cÚfig_‹m¶©e
, 
cfg
);

693 ()
	`»_årštf
(
f
,

699 
mod·th
 = 
	`d‘eù_moduË_·th
(&
mod·th_v®id
);

700 ()
	`»_årštf
(
f
, "%smodule_path\t\t%s\n",

701 
mod·th_v®id
 ? "" : "#", 
mod·th
);

703 ()
	`»_årštf
(
f
, "\n# UI Modules\n");

704 #ià
	`defšed
 (
WIN32
)

705 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "wšcÚs" 
MOD_EXT
 "\n");

707 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "¡dio" 
MOD_EXT
 "\n");

709 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "cÚs" 
MOD_EXT
 "\n");

710 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "evdev" 
MOD_EXT
 "\n");

711 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "h‰pd" 
MOD_EXT
 "\n");

713 ()
	`»_årštf
(
f
, "\n# Audio codec Modules (in order)\n");

714 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "İus" 
MOD_EXT
 "\n");

715 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "sk" 
MOD_EXT
 "\n");

716 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "amr" 
MOD_EXT
 "\n");

717 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "g7221" 
MOD_EXT
 "\n");

718 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "g722" 
MOD_EXT
 "\n");

719 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "g726" 
MOD_EXT
 "\n");

720 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "g711" 
MOD_EXT
 "\n");

721 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "gsm" 
MOD_EXT
 "\n");

722 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "l16" 
MOD_EXT
 "\n");

723 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¥“x" 
MOD_EXT
 "\n");

724 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "bv32" 
MOD_EXT
 "\n");

725 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "m·" 
MOD_EXT
 "\n");

726 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "codec2" 
MOD_EXT
 "\n");

727 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "bc" 
MOD_EXT
 "\n");

728 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "i§c" 
MOD_EXT
 "\n");

730 ()
	`»_årštf
(
f
, "\n# Audio filter Modules (inƒncoding order)\n");

731 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "vum‘”" 
MOD_EXT
 "\n");

732 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¢dfe" 
MOD_EXT
 "\n");

733 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¥“x_«c" 
MOD_EXT
 "\n");

734 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¥“x_µ" 
MOD_EXT
 "\n");

735 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¶c" 
MOD_EXT
 "\n");

737 ()
	`»_årštf
(
f
, "\n# Audio driver Modules\n");

738 #ià
	`defšed
 (
ANDROID
)

739 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "İ’¦es" 
MOD_EXT
 "\n");

740 #–ià
	`defšed
 (
DARWIN
)

741 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "cÜ—udio" 
MOD_EXT
 "\n");

742 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "audioun™" 
MOD_EXT
 "\n");

743 #–ià
	`defšed
 (
FREEBSD
)

744 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "oss" 
MOD_EXT
 "\n");

745 #–ià
	`defšed
 (
OPENBSD
)

746 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "¢dio" 
MOD_EXT
 "\n");

747 #–ià
	`defšed
 (
WIN32
)

748 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "wšwave" 
MOD_EXT
 "\n");

750 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "®§" 
MOD_EXT
 "\n");

751 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "pul£" 
MOD_EXT
 "\n");

753 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "jack" 
MOD_EXT
 "\n");

754 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "pÜudio" 
MOD_EXT
 "\n");

755 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "aubridge" 
MOD_EXT
 "\n");

756 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "aufe" 
MOD_EXT
 "\n");

758 #ifdeà
USE_VIDEO


760 ()
	`»_årštf
(
f
, "\n# Video codec Modules (in order)\n");

761 #ifdeà
USE_AVCODEC


762 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "avcodec" 
MOD_EXT
 "\n");

764 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "avcodec" 
MOD_EXT
 "\n");

766 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "vp8" 
MOD_EXT
 "\n");

767 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "vp9" 
MOD_EXT
 "\n");

768 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "h265" 
MOD_EXT
 "\n");

770 ()
	`»_årštf
(
f
, "\n# Video filter Modules (inƒncoding order)\n");

771 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "£lfv›w" 
MOD_EXT
 "\n");

772 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¢­shÙ" 
MOD_EXT
 "\n");

773 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "swsÿË" 
MOD_EXT
 "\n");

774 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "vidšfo" 
MOD_EXT
 "\n");

776 ()
	`»_årštf
(
f
, "\n# Video source modules\n");

777 #ià
	`defšed
 (
DARWIN
)

779 #ifdeà
QTCAPTURE_RUNLOOP


780 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "qtÿ±u»" 
MOD_EXT
 "\n");

782 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "avÿ±u»" 
MOD_EXT
 "\n");

785 #–ià
	`defšed
 (
WIN32
)

786 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "dshow" 
MOD_EXT
 "\n");

789 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "v4l" 
MOD_EXT
 "\n");

790 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "v4l2" 
MOD_EXT
 "\n");

791 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "v4l2_codec" 
MOD_EXT
 "\n");

793 #ifdeà
USE_AVFORMAT


794 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "avfÜm©" 
MOD_EXT
 "\n");

796 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "x11g¿b" 
MOD_EXT
 "\n");

797 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "ÿœo" 
MOD_EXT
 "\n");

798 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "vidbridge" 
MOD_EXT
 "\n");

800 ()
	`»_årštf
(
f
, "\n# Video display modules\n");

801 #ifdeà
DARWIN


802 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "İ’gl" 
MOD_EXT
 "\n");

804 #ifdeà
LINUX


805 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "dœeùfb" 
MOD_EXT
 "\n");

807 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "x11" 
MOD_EXT
 "\n");

808 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "sdl2" 
MOD_EXT
 "\n");

809 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "çkevideo" 
MOD_EXT
 "\n");

813 ()
	`»_årštf
(
f
, "\n# Audio/Video source modules\n");

814 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "r¡" 
MOD_EXT
 "\n");

815 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "g¡1" 
MOD_EXT
 "\n");

816 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "g¡_video1" 
MOD_EXT
 "\n");

818 ()
	`»_årštf
(
f
, "\n# Media NAT modules\n");

819 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "¡un" 
MOD_EXT
 "\n");

820 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "tuº" 
MOD_EXT
 "\n");

821 ()
	`»_årštf
(
f
, "moduË\t\t\t" 
MOD_PRE
 "iû" 
MOD_EXT
 "\n");

822 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "Çmp" 
MOD_EXT
 "\n");

824 ()
	`»_årštf
(
f
, "\n# Mediaƒncryption modules\n");

825 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "¤" 
MOD_EXT
 "\n");

826 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "ds_¤" 
MOD_EXT
 "\n");

827 ()
	`»_årštf
(
f
, "#moduË\t\t\t" 
MOD_PRE
 "z¹p" 
MOD_EXT
 "\n");

828 ()
	`»_årštf
(
f
, "\n");

830 ()
	`»_årštf
(
f
, "\n#------------------------------------"

832 ()
	`»_årštf
(
f
, "# Temporary Modules (loadedhen unloaded)\n");

833 ()
	`»_årštf
(
f
, "\n");

834 ()
	`»_årštf
(
f
, "moduË_tmp\t\t" 
MOD_PRE
 "uuid" 
MOD_EXT
 "\n");

835 ()
	`»_årštf
(
f
, "moduË_tmp\t\t" 
MOD_PRE
 "accouÁ" 
MOD_EXT
 "\n");

836 ()
	`»_årštf
(
f
, "\n");

838 ()
	`»_årštf
(
f
, "\n#------------------------------------"

840 ()
	`»_årštf
(
f
, "# Application Modules\n");

841 ()
	`»_årštf
(
f
, "\n");

842 ()
	`»_årštf
(
f
, "moduË_­p\t\t" 
MOD_PRE
 "auloİ"
MOD_EXT
"\n");

843 ()
	`»_årštf
(
f
, "moduË_­p\t\t" 
MOD_PRE
 "cÚù"
MOD_EXT
"\n");

844 ()
	`»_årštf
(
f
, "moduË_­p\t\t" 
MOD_PRE
 "debug_cmd"
MOD_EXT
"\n");

845 #ifdeà
LINUX


846 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "dtmfio"
MOD_EXT
"\n");

848 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "echo"
MOD_EXT
"\n");

849 ()
	`»_årštf
(
f
, "#moduË_­p\t\t\t" 
MOD_PRE
 "gtk" 
MOD_EXT
 "\n");

850 ()
	`»_årštf
(
f
, "moduË_­p\t\t" 
MOD_PRE
 "m’u"
MOD_EXT
"\n");

851 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "mwi"
MOD_EXT
"\n");

852 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "Çtbd"
MOD_EXT
"\n");

853 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "´e£nû"
MOD_EXT
"\n");

854 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "sy¦og"
MOD_EXT
"\n");

855 ()
	`»_årštf
(
f
, "#moduË_­p\t\t" 
MOD_PRE
 "mq‰" 
MOD_EXT
 "\n");

856 #ifdeà
USE_VIDEO


857 ()
	`»_årštf
(
f
, "moduË_­p\t\t" 
MOD_PRE
 "vidloİ"
MOD_EXT
"\n");

859 ()
	`»_årštf
(
f
, "\n");

861 ()
	`»_årštf
(
f
, "\n#------------------------------------"

863 ()
	`»_årštf
(
f
, "# Module…arameters\n");

864 ()
	`»_årštf
(
f
, "\n");

866 ()
	`»_årštf
(
f
, "\n");

867 ()
	`»_årštf
(
f
, "cons_listen\t\t0.0.0.0:5555\n");

869 ()
	`»_årštf
(
f
, "\n");

870 ()
	`»_årštf
(
f
, "http_listen\t\t0.0.0.0:8000\n");

872 ()
	`»_årštf
(
f
, "\n");

873 ()
	`»_årštf
(
f
, "evdev_device\t\t/dev/input/event0\n");

875 ()
	`»_årštf
(
f
, "\n# Speex codec…arameters\n");

876 ()
	`»_årštf
(
f
, "speex_quality\t\t7 # 0-10\n");

877 ()
	`»_årštf
(
f
, "speex_complexity\t7 # 0-10\n");

878 ()
	`»_årštf
(
f
, "speex_enhancement\t0 # 0-1\n");

879 ()
	`»_årštf
(
f
, "speex_mode_nb\t\t3 # 1-6\n");

880 ()
	`»_årštf
(
f
, "speex_mode_wb\t\t6 # 1-6\n");

881 ()
	`»_årštf
(
f
, "speex_vbr\t\t0 # Variable Bit Rate 0-1\n");

882 ()
	`»_årštf
(
f
, "speex_vad\t\t0 # Voice Activity Detection 0-1\n");

883 ()
	`»_årštf
(
f
, "speex_agc_level\t\t8000\n");

885 ()
	`»_årštf
(
f
, "\n# Opus codec…arameters\n");

886 ()
	`»_årštf
(
f
, "opus_bitrate\t\t28000 # 6000-510000\n");

888 ()
	`»_årštf
(
f
,

893 ()
	`»_årštf
(
f
,

900 ()
	`»_årštf
(
f
,

905 ()
	`»_årštf
(
f
,

910 ià(
f
)

911 ()
	`fşo£
(
f
);

913  
”r
;

914 
	}
}

922 
cÚfig
 *
	$cÚf_cÚfig
()

924  &
cÜe_cÚfig
;

925 
	}
}

	@baresip/src/contact.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

11 
	eacûss
 {

12 
	mACCESS_UNKNOWN
 = 0,

13 
	mACCESS_BLOCK
,

14 
	mACCESS_ALLOW


17 
	scÚù
 {

18 
Ë
 
	mË
;

19 
Ë
 
	mhe
;

20 
s_addr
 
	maddr
;

21 *
	mbuf
;

22 
´e£nû_¡©us
 
	m¡©us
;

23 
acûss
 
	macûss
;

27 
	$de¡ruùÜ
(*
¬g
)

29 
cÚù
 *
c
 = 
¬g
;

31 
	`hash_uÆšk
(&
c
->
he
);

32 
	`li¡_uÆšk
(&
c
->
Ë
);

33 
	`mem_d”ef
(
c
->
buf
);

34 
	}
}

46 
	$cÚù_add
(
cÚùs
 *contacts,

47 
cÚù
 **
cÚùp
, cÚ¡ 
¶
 *
addr
)

49 
cÚù
 *
c
;

50 
¶
…l;

51 
”r
;

53 ià(!
cÚùs
)

54  
EINVAL
;

56 
c
 = 
	`mem_z®loc
((*c), 
de¡ruùÜ
);

57 ià(!
c
)

58  
ENOMEM
;

60 
”r
 = 
	`¶_¡rdup
(&
c
->
buf
, 
addr
);

61 ià(
”r
)

62 
out
;

64 
	`¶_£t_¡r
(&
¶
, 
c
->
buf
);

66 
”r
 = 
	`s_addr_decode
(&
c
->
addr
, &
¶
);

67 ià(
”r
) {

68 
	`w¬nšg
("cÚù: decod”rÜ '%r'\n", 
addr
);

69 
out
;

72 ià(0 =ğ
	`msg_·¿m_decode
(&
c
->
addr
.
·¿ms
, "acûss", &
¶
)) {

74 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "block")) {

75 
c
->
acûss
 = 
ACCESS_BLOCK
;

77 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶
, "allow")) {

78 
c
->
acûss
 = 
ACCESS_ALLOW
;

81 
	`w¬nšg
("contact: unknown 'access=%r' for '%r'\n",

82 &
¶
, 
addr
);

83 
”r
 = 
EINVAL
;

84 
out
;

88 
c
->
acûss
 = 
ACCESS_UNKNOWN
;

90 
c
->
¡©us
 = 
PRESENCE_UNKNOWN
;

92 
	`li¡_­³nd
(&
cÚùs
->
ş
, &
c
->
Ë
, c);

93 
	`hash_­³nd
(
cÚùs
->
cht
, 
	`hash_jß©_¶
(&
c
->
addr
.
auri
), &c->
he
, c);

95 ià(
cÚùs
->
hªdËr
)

96 
cÚùs
->
	`hªdËr
(
c
, 
çl£
, cÚùs->
hªdËr_¬g
);

98 
out
:

99 ià(
”r
)

100 
	`mem_d”ef
(
c
);

101 ià(
cÚùp
)

102 *
cÚùp
 = 
c
;

104  
”r
;

105 
	}
}

114 
	$cÚù_»move
(
cÚùs
 *cÚùs, 
cÚù
 *contact)

116 ià(!
cÚùs
 || !
cÚù
)

119 ià(
cÚùs
->
hªdËr
)

120 
cÚùs
->
	`hªdËr
(
cÚù
, 
Œue
, cÚùs->
hªdËr_¬g
);

122 
	`hash_uÆšk
(&
cÚù
->
he
);

123 
	`li¡_uÆšk
(&
cÚù
->
Ë
);

125 
	`mem_d”ef
(
cÚù
);

126 
	}
}

129 
	$cÚù_£t_upd©e_hªdËr
(
cÚùs
 *contacts,

130 
cÚù_upd©e_h
 *
upd©eh
, *
¬g
)

132 ià(!
cÚùs
) {

136 
cÚùs
->
hªdËr
 = 
upd©eh
;

137 
cÚùs
->
hªdËr_¬g
 = 
¬g
;

138 
	}
}

148 
s_addr
 *
	$cÚù_addr
(cÚ¡ 
cÚù
 *
c
)

150  
c
 ? (
s_addr
 *)&c->
addr
 : 
NULL
;

151 
	}
}

161 cÚ¡ *
	$cÚù_¡r
(cÚ¡ 
cÚù
 *
c
)

163  
c
 ? c->
buf
 : 
NULL
;

164 
	}
}

174 
li¡
 *
	$cÚù_li¡
(cÚ¡ 
cÚùs
 *contacts)

176 ià(!
cÚùs
)

177  
NULL
;

179  (
li¡
 *)&
cÚùs
->
ş
;

180 
	}
}

183 
	$cÚù_£t_´e£nû
(
cÚù
 *
c
, 
´e£nû_¡©us
 
¡©us
)

185 ià(!
c
)

188 ià(
c
->
¡©us
 !ğ
PRESENCE_UNKNOWN
 && c->status != status) {

190 
	`šfo
("<%r> chªged stu äom % tØ%s\n", &
c
->
addr
.
auri
,

191 
	`cÚù_´e£nû_¡r
(
c
->
¡©us
),

192 
	`cÚù_´e£nû_¡r
(
¡©us
));

195 
c
->
¡©us
 = status;

196 
	}
}

198 
´e£nû_¡©us
 
	$cÚù_´e£nû
(cÚ¡ 
cÚù
 *
c
)

200 ià(!
c
)

201  
PRESENCE_UNKNOWN
;

203  
c
->
¡©us
;

204 
	}
}

206 cÚ¡ *
	$cÚù_´e£nû_¡r
(
´e£nû_¡©us
 
¡©us
)

208 
¡©us
) {

211 
PRESENCE_UNKNOWN
:  "\x1b[32mUnknown\x1b[;m";

212 
PRESENCE_OPEN
:  "\x1b[32mOnline\x1b[;m";

213 
PRESENCE_CLOSED
:  "\x1b[31mOffline\x1b[;m";

214 
PRESENCE_BUSY
:  "\x1b[31mBusy\x1b[;m";

216 
	}
}

219 
	$cÚùs_´št
(
»_´štf
 *
pf
, cÚ¡ 
cÚùs
 *contacts)

221 cÚ¡ 
li¡
 *
l¡
;

222 
Ë
 *le;

223 
”r
;

225 ià(!
cÚùs
)

228 
l¡
 = 
	`cÚù_li¡
(
cÚùs
);

230 
”r
 = 
	`»_h´štf
(
pf
, "\n--- Contacts: (%u) ---\n",

231 
	`li¡_couÁ
(
l¡
));

233 
Ë
 = 
	`li¡_h—d
(
l¡
);†&& !
”r
;†ğË->
Ãxt
) {

234 cÚ¡ 
cÚù
 *
c
 = 
Ë
->
d©a
;

235 cÚ¡ 
s_addr
 *
addr
 = &
c
->addr;

237 
”r
 = 
	`»_h´štf
(
pf
, "%20s %r <%r>\n",

238 
	`cÚù_´e£nû_¡r
(
c
->
¡©us
),

239 &
addr
->
dÇme
, &addr->
auri
);

242 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

244  
”r
;

245 
	}
}

255 
	$cÚù_š™
(
cÚùs
 *contacts)

257 
”r
 = 0;

259 ià(!
cÚùs
)

260  
EINVAL
;

262 
	`mem£t
(
cÚùs
, 0, (*contacts));

264 
	`li¡_š™
(&
cÚùs
->
ş
);

266 
”r
 = 
	`hash_®loc
(&
cÚùs
->
cht
, 32);

268  
”r
;

269 
	}
}

277 
	$cÚù_şo£
(
cÚùs
 *contacts)

279 ià(!
cÚùs
)

282 
	`hash_ş—r
(
cÚùs
->
cht
);

283 
cÚùs
->
cht
 = 
	`mem_d”ef
(contacts->cht);

284 
	`li¡_æush
(&
cÚùs
->
ş
);

285 
	}
}

288 
boŞ
 
	$fšd_hªdËr
(
Ë
 *Ë, *
¬g
)

290 
cÚù
 *
c
 = 
Ë
->
d©a
;

292  0 =ğ
	`¶_¡rcmp
(&
c
->
addr
.
auri
, 
¬g
);

293 
	}
}

304 
cÚù
 *
	$cÚù_fšd
(cÚ¡ 
cÚùs
 *cÚùs, cÚ¡ *
uri
)

306 ià(!
cÚùs
)

307  
NULL
;

309  
	`li¡_Ëd©a
(
	`hash_lookup
(
cÚùs
->
cht
, 
	`hash_jß©_¡r
(
uri
),

310 
fšd_hªdËr
, (*)
uri
));

311 
	}
}

325 
boŞ
 
	$cÚù_block_acûss
(cÚ¡ 
cÚùs
 *cÚùs, cÚ¡ *
uri
)

327 
cÚù
 *
c
;

329 
c
 = 
	`cÚù_fšd
(
cÚùs
, 
uri
);

330 ià(
c
 && c->
acûss
 !ğ
ACCESS_UNKNOWN
)

331  
c
->
acûss
 =ğ
ACCESS_BLOCK
;

333 
c
 = 
	`cÚù_fšd
(
cÚùs
, "sip:*@*");

334 ià(
c
 && c->
acûss
 !ğ
ACCESS_UNKNOWN
)

335  
c
->
acûss
 =ğ
ACCESS_BLOCK
;

337  
çl£
;

338 
	}
}

	@baresip/src/core.h

8 
	~<lim™s.h
>

12 #ià
defšed
 (
PATH_MAX
)

13 
	#FS_PATH_MAX
 
PATH_MAX


	)

14 #–ià
defšed
 (
_POSIX_PATH_MAX
)

15 
	#FS_PATH_MAX
 
_POSIX_PATH_MAX


	)

17 
	#FS_PATH_MAX
 512

	)

28 
	mPT_CN
 = 13,

29 
	mPT_STAT_MIN
 = 0,

30 
	mPT_STAT_MAX
 = 95,

31 
	mPT_DYN_MIN
 = 96,

32 
	mPT_DYN_MAX
 = 127

38 
	mAUDIO_BANDWIDTH
 = 128000,

39 
	mVIDEO_SRATE
 = 90000,

44 
	g¡»am_·¿m
;

52 
	saccouÁ
 {

53 *
	mbuf
;

54 
s_addr
 
	mÏddr
;

55 
uri
 
	mluri
;

56 *
	mdi¥Çme
;

57 *
	maÜ
;

60 
ªsw”mode
 
	mªsw”mode
;

61 
Ë
 
	macv
[8];

62 
li¡
 
	maucodeş
;

63 *
	mauth_u£r
;

64 *
	mauth_·ss
;

65 *
	mmÇtid
;

66 *
	mm’cid
;

67 cÚ¡ 
mÇt
 *
	mmÇt
;

68 cÚ¡ 
m’c
 *
	mm’c
;

69 *
	moutboundv
[2];

70 
ušt32_t
 
	m±ime
;

71 
ušt32_t
 
	m»gšt
;

72 
ušt32_t
 
	mpubšt
;

73 *
	m»gq
;

74 *
	m¹pk“p
;

75 *
	msÇt
;

76 *
	m¡un_u£r
;

77 *
	m¡un_·ss
;

78 *
	m¡un_ho¡
;

79 
ušt16_t
 
	m¡un_pÜt
;

80 
Ë
 
	mvcv
[4];

81 
li¡
 
	mvidcodeş
;

89 
	sau¶ay_¡
 {

90 
au¶ay
 *
	m­
;

93 
	sau¶ay
 {

94 
Ë
 
	mË
;

95 cÚ¡ *
	mÇme
;

96 
au¶ay_®loc_h
 *
	m®loch
;

104 
	sau¤c_¡
 {

105 cÚ¡ 
au¤c
 *
	mas
;

108 
	sau¤c
 {

109 
Ë
 
	mË
;

110 cÚ¡ *
	mÇme
;

111 
au¤c_®loc_h
 *
	m®loch
;

119 
	gaudio
;

121 (
	taudio_ev’t_h
)(
	tkey
, 
	tboŞ
 
	t’d
, *
	t¬g
);

122 (
	taudio_”r_h
)(
	t”r
, cÚ¡ *
	t¡r
, *
	t¬g
);

124 
	`audio_®loc
(
audio
 **
­
, cÚ¡ 
¡»am_·¿m
 *
¡»am_´m
,

125 cÚ¡ 
cÚfig
 *
cfg
,

126 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
, 
Ïb–
,

127 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

128 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

129 
ušt32_t
 
±ime
, cÚ¡ 
li¡
 *
aucodeş
, 
boŞ
 
ofã»r
,

130 
audio_ev’t_h
 *
ev’th
, 
audio_”r_h
 *
”rh
, *
¬g
);

131 
	`audio_¡¬t
(
audio
 *
a
);

132 
	`audio_¡İ
(
audio
 *
a
);

133 
	`audio_’cod”_£t
(
audio
 *
a
, cÚ¡ 
aucodec
 *
ac
,

134 
±_tx
, cÚ¡ *
·¿ms
);

135 
	`audio_decod”_£t
(
audio
 *
a
, cÚ¡ 
aucodec
 *
ac
,

136 
±_rx
, cÚ¡ *
·¿ms
);

137 
	`audio_£nd_dig™
(
audio
 *
a
, 
key
);

138 
	`audio_sdp_©Œ_decode
(
audio
 *
a
);

139 
	`audio_´št_¹p¡©
(
»_´štf
 *
pf
, cÚ¡ 
audio
 *
au
);

146 
bfı
;

147 
	`bfı_®loc
(
bfı
 **
bfıp
, 
sdp_£ssiÚ
 *
sdp_£ss
,

148 cÚ¡ *
´Ùo
, 
boŞ
 
ofã»r
,

149 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess);

150 
	`bfı_¡¬t
(
bfı
 *bfcp);

158 
CALL_LINENUM_MIN
 = 1,

159 
CALL_LINENUM_MAX
 = 256

162 
ÿÎ
;

165 
	sÿÎ_´m
 {

166 
§
 
Ïddr
;

167 
vidmode
 vidmode;

168 
af
;

169 
boŞ
 
u£_¹p
;

172 
	`ÿÎ_®loc
(
ÿÎ
 **
ÿÎp
, cÚ¡ 
cÚfig
 *
cfg
,

173 
li¡
 *
l¡
,

174 cÚ¡ *
loÿl_Çme
, cÚ¡ *
loÿl_uri
,

175 
accouÁ
 *
acc
, 
ua
 *ua, cÚ¡ 
ÿÎ_´m
 *
´m
,

176 cÚ¡ 
s_msg
 *
msg
, 
ÿÎ
 *
xÿÎ
,

177 
dnsc
 *dnsc,

178 
ÿÎ_ev’t_h
 *
eh
, *
¬g
);

179 
	`ÿÎ_cÚÃù
(
ÿÎ
 *ÿÎ, cÚ¡ 
¶
 *
·ddr
);

180 
	`ÿÎ_acû±
(
ÿÎ
 *ÿÎ, 
s£ss_sock
 *
£ss_sock
,

181 cÚ¡ 
s_msg
 *
msg
);

182 
	`ÿÎ_hªgup
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
);

183 
	`ÿÎ_´og»ss
(
ÿÎ
 *call);

184 
	`ÿÎ_ªsw”
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
);

185 
	`ÿÎ_sdp_g‘
(cÚ¡ 
ÿÎ
 *ÿÎ, 
mbuf
 **
desı
, 
boŞ
 
ofãr
);

186 
	`ÿÎ_jbuf_¡©
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call);

187 
	`ÿÎ_šfo
(
»_´štf
 *
pf
, cÚ¡ 
ÿÎ
 *call);

188 
	`ÿÎ_»£t_Œª¥
(
ÿÎ
 *ÿÎ, cÚ¡ 
§
 *
Ïddr
);

189 
	`ÿÎ_nÙify_säag
(
ÿÎ
 *ÿÎ, 
ušt16_t
 
scode
,

190 cÚ¡ *
»asÚ
, ...);

191 
	`ÿÎ_af
(cÚ¡ 
ÿÎ
 *call);

192 
	`ÿÎ_£t_x¹p¡©
(
ÿÎ
 *call);

193 
accouÁ
 *
	`ÿÎ_accouÁ
(cÚ¡ 
ÿÎ
 *call);

200 
	`cÚf_g‘_¿nge
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

201 
¿nge
 *
ºg
);

202 
	`cÚf_g‘_csv
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

203 *
¡r1
, 
size_t
 
sz1
, *
¡r2
, size_ˆ
sz2
);

210 
	`mù¾_hªdË_medŸ_cÚŒŞ
(
¶
 *
body
, 
boŞ
 *
pfu
);

217 
	smÇt
 {

218 
Ë
†e;

219 cÚ¡ *
id
;

220 cÚ¡ *
áag
;

221 
mÇt_£ss_h
 *
£ssh
;

222 
mÇt_medŸ_h
 *
medŸh
;

223 
mÇt_upd©e_h
 *
upd©eh
;

226 cÚ¡ 
mÇt
 *
	`mÇt_fšd
(cÚ¡ 
li¡
 *
mÇ
, cÚ¡ *
id
);

233 
	sm‘ric
 {

235 
tmr
mr;

236 
ušt64_t
 
ts_¡¬t
;

237 
boŞ
 
¡¬‹d
;

240 
ušt32_t
 
n_·ck‘s
;

241 
ušt32_t
 
n_by‹s
;

242 
ušt32_t
 
n_”r
;

245 
ušt32_t
 
cur_b™¿‹
;

246 
ušt64_t
 
ts_Ï¡
;

247 
ušt32_t
 
n_by‹s_Ï¡
;

250 
	`m‘ric_š™
(
m‘ric
 *metric);

251 
	`m‘ric_»£t
(
m‘ric
 *metric);

252 
	`m‘ric_add_·ck‘
(
m‘ric
 *m‘ric, 
size_t
 
·ck‘size
);

253 
ušt32_t
 
	`m‘ric_avg_b™¿‹
(cÚ¡ 
m‘ric
 *metric);

260 
	`moduË_š™
(cÚ¡ 
cÚf
 *conf);

261 
	`moduË_­p_uÆßd
();

268 
»g
;

270 
	`»g_add
(
li¡
 *
l¡
, 
ua
 *ua, 
»gid
);

271 
	`»g_»gi¡”
(
»g
 *»g, cÚ¡ *
»g_uri
,

272 cÚ¡ *
·¿ms
, 
ušt32_t
 
»gšt
, cÚ¡ *
outbound
);

273 
	`»g_uÄegi¡”
(
»g
 *reg);

274 
boŞ
 
	`»g_isok
(cÚ¡ 
»g
 *reg);

275 
	`»g_debug
(
»_´štf
 *
pf
, cÚ¡ 
»g
 *reg);

276 
	`»g_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
»g
 *reg);

283 
	#RTPEXT_HDR_SIZE
 4

	)

284 
	#RTPEXT_TYPE_MAGIC
 0xbede

	)

287 
RTPEXT_ID_MIN
 = 1,

288 
RTPEXT_ID_MAX
 = 14,

292 
RTPEXT_LEN_MIN
 = 1,

293 
RTPEXT_LEN_MAX
 = 16,

296 
	s¹³xt
 {

297 
id
:4;

298 
Ën
:4;

299 
ušt8_t
 
d©a
[
RTPEXT_LEN_MAX
];

303 
	`¹³xt_hdr_’code
(
mbuf
 *
mb
, 
size_t
 
num_by‹s
);

304 
	`¹³xt_’code
(
mbuf
 *
mb
, 
id
, 
Ën
,

305 cÚ¡ 
ušt8_t
 *
d©a
);

306 
	`¹³xt_decode
(
¹³xt
 *
ext
, 
mbuf
 *
mb
);

313 
¹pk“p
;

315 
	`¹pk“p_®loc
(
¹pk“p
 **
rkp
, cÚ¡ *
m‘hod
, 
´Ùo
,

316 
¹p_sock
 *
¹p
, 
sdp_medŸ
 *
sdp
);

317 
	`¹pk“p_»äesh
(
¹pk“p
 *
rk
, 
ušt32_t
 
ts
);

324 
	`sdp_decode_muÉ¬t
(cÚ¡ 
¶
 *
ùy³_´m
, 
mbuf
 *
mb
);

325 cÚ¡ 
sdp_fÜm©
 *
	`sdp_medŸ_fÜm©_cyşe
(
sdp_medŸ
 *
m
);

332 
¹p_h—d”
;

334 ’um {
STREAM_PRESZ
 = 4+12};

336 (
	t¡»am_¹p_h
)(cÚ¡ 
	t¹p_h—d”
 *
	thdr
,

337 
	t¹³xt
 *
	textv
, 
	tsize_t
 
	textc
,

338 
	tmbuf
 *
	tmb
, *
	t¬g
);

339 (
	t¡»am_¹ı_h
)(
	t¹ı_msg
 *
	tmsg
, *
	t¬g
);

341 (
	t¡»am_”rÜ_h
)(
	t¡»am
 *
	t¡rm
, 
	t”r
, *
	t¬g
);

344 
	s¡»am_·¿m
 {

345 
boŞ
 
u£_¹p
;

349 
	s¡»am
 {

350 
Ë
†e;

351 
cÚfig_avt
 
cfg
;

352 
ÿÎ
 *call;

353 
sdp_medŸ
 *
sdp
;

354 
¹p_sock
 *
¹p
;

355 
¹pk“p
 *rtpkeep;

356 
¹ı_¡©s
„tcp_stats;

357 
jbuf
 *jbuf;

358 
mÇt_medŸ
 *
mns
;

359 cÚ¡ 
m’c
 *menc;

360 
m’c_£ss
 *
m’cs
;

361 
m’c_medŸ
 *
mes
;

362 
m‘ric
 
m‘ric_tx
;

363 
m‘ric
 
m‘ric_rx
;

364 *
úame
;

365 
ušt32_t
 
s¤c_rx
;

366 
ušt32_t
 
p£q
;

367 
±_’c
;

368 
boŞ
 
¹ı
;

369 
boŞ
 
¹ı_mux
;

370 
boŞ
 
jbuf_¡¬‹d
;

371 
¡»am_¹p_h
 *
¹ph
;

372 
¡»am_¹ı_h
 *
¹ıh
;

373 *
¬g
;

374 
¡»am_”rÜ_h
 *
”rÜh
;

375 *
”rÜh_¬g
;

376 
tmr
 
tmr_¹p
;

377 
ušt64_t
 
ts_Ï¡
;

378 
boŞ
 
‹rmš©ed
;

379 
ušt32_t
 
¹p_timeout_ms
;

382 
	`¡»am_®loc
(
¡»am
 **
¥
, cÚ¡ 
¡»am_·¿m
 *
´m
,

383 cÚ¡ 
cÚfig_avt
 *
cfg
,

384 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
,

385 cÚ¡ *
Çme
, 
Ïb–
,

386 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

387 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

388 cÚ¡ *
úame
,

389 
¡»am_¹p_h
 *
¹ph
, 
¡»am_¹ı_h
 *
¹ıh
, *
¬g
);

390 
sdp_medŸ
 *
	`¡»am_sdpmedŸ
(cÚ¡ 
¡»am
 *
s
);

391 
	`¡»am_£nd
(
¡»am
 *
s
, 
boŞ
 
ext
, boŞ 
m¬k”
, 
±
, 
ušt32_t
 
ts
,

392 
mbuf
 *
mb
);

393 
	`¡»am_upd©e
(
¡»am
 *
s
);

394 
	`¡»am_upd©e_’cod”
(
¡»am
 *
s
, 
±_’c
);

395 
	`¡»am_jbuf_¡©
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
);

396 
	`¡»am_hŞd
(
¡»am
 *
s
, 
boŞ
 
hŞd
);

397 
	`¡»am_£t_¤©e
(
¡»am
 *
s
, 
ušt32_t
 
¤©e_tx
, ušt32_ˆ
¤©e_rx
);

398 
	`¡»am_£nd_fœ
(
¡»am
 *
s
, 
boŞ
 
¶i
);

399 
	`¡»am_»£t
(
¡»am
 *
s
);

400 
	`¡»am_£t_bw
(
¡»am
 *
s
, 
ušt32_t
 
bps
);

401 
	`¡»am_£t_”rÜ_hªdËr
(
¡»am
 *
¡rm
,

402 
¡»am_”rÜ_h
 *
”rÜh
, *
¬g
);

403 
	`¡»am_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
);

404 
	`¡»am_´št
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
);

405 
	`¡»am_’abË_¹p_timeout
(
¡»am
 *
¡rm
, 
ušt32_t
 
timeout_ms
);

412 
ua
;

414 
	`ua_ev’t
(
ua
 *ua, 
ua_ev’t
 
ev
, 
ÿÎ
 *call,

415 cÚ¡ *
fmt
, ...);

416 
	`ua_´štf
(cÚ¡ 
ua
 *ua, cÚ¡ *
fmt
, ...);

418 
s
 *
	`uag_s
();

419 cÚ¡ *
	`uag_®lowed_m‘hods
();

426 
	svidi¥
 {

427 
Ë
†e;

428 cÚ¡ *
Çme
;

429 
vidi¥_®loc_h
 *
®loch
;

430 
vidi¥_upd©e_h
 *
upd©eh
;

431 
vidi¥_di¥_h
 *
di¥h
;

432 
vidi¥_hide_h
 *
hideh
;

435 
vidi¥
 *
	`vidi¥_g‘
(
vidi¥_¡
 *
¡
);

442 
	svid¤c
 {

443 
Ë
†e;

444 cÚ¡ *
Çme
;

445 
vid¤c_®loc_h
 *
®loch
;

446 
vid¤c_upd©e_h
 *
upd©eh
;

449 
vid¤c
 *
	`vid¤c_g‘
(
vid¤c_¡
 *
¡
);

456 
video
;

458 (
	tvideo_”r_h
)(
	t”r
, cÚ¡ *
	t¡r
, *
	t¬g
);

460 
	`video_®loc
(
video
 **
vp
, cÚ¡ 
¡»am_·¿m
 *
¡»am_´m
,

461 cÚ¡ 
cÚfig
 *
cfg
,

462 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
, 
Ïb–
,

463 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

464 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

465 cÚ¡ *
cÚ‹Á
, cÚ¡ 
li¡
 *
vidcodeş
,

466 
video_”r_h
 *
”rh
, *
¬g
);

467 
	`video_¡¬t
(
video
 *
v
, cÚ¡ *
³”
);

468 
	`video_¡İ
(
video
 *
v
);

469 
boŞ
 
	`video_is_¡¬‹d
(cÚ¡ 
video
 *
v
);

470 
	`video_’cod”_£t
(
video
 *
v
, 
vidcodec
 *
vc
,

471 
±_tx
, cÚ¡ *
·¿ms
);

472 
	`video_decod”_£t
(
video
 *
v
, 
vidcodec
 *
vc
, 
±_rx
,

473 cÚ¡ *
fm
);

474 
	`video_upd©e_piùu»
(
video
 *
v
);

475 
	`video_sdp_©Œ_decode
(
video
 *
v
);

476 
	`video_´št
(
»_´štf
 *
pf
, cÚ¡ 
video
 *
v
);

488 
	stime¡amp_»cv
 {

489 
ušt32_t
 
fœ¡
;

490 
ušt32_t
 
Ï¡
;

491 
boŞ
 
is_£t
;

492 
num_w¿ps
;

496 
šlše
 
ušt64_t
 
	$ÿlc_ex‹nded_time¡amp
(
ušt32_t
 
num_w¿ps
, ušt32_ˆ
ts
)

498 
ušt64_t
 
ext_ts
;

500 
ext_ts
 = (
ušt64_t
)
num_w¿ps
 * 0x100000000ULL;

501 
ext_ts
 +ğ(
ušt64_t
)
ts
;

503  
ext_ts
;

504 
	}
}

507 
šlše
 
ušt64_t
 
	$time¡amp_du¿tiÚ
(cÚ¡ 
time¡amp_»cv
 *
ts
)

509 
ušt64_t
 
Ï¡_ext
;

511 ià(!
ts
 || !ts->
is_£t
)

514 
Ï¡_ext
 = 
	`ÿlc_ex‹nded_time¡amp
(
ts
->
num_w¿ps
,s->
Ï¡
);

516  
Ï¡_ext
 - 
ts
->
fœ¡
;

517 
	}
}

525 
šlše
 
	$time¡amp_w¿p
(
ušt32_t
 
ts_Ãw
, ušt32_ˆ
ts_Şd
)

527 
št32_t
 
d–
;

529 ià(
ts_Ãw
 < 
ts_Şd
) {

531 
d–
 = (
št32_t
)
ts_Ãw
 - (št32_t)
ts_Şd
;

533 ià(
d–
 > 0)

536 ià((
št32_t
)(
ts_Şd
 - 
ts_Ãw
) > 0) {

542 
	}
}

	@baresip/src/event.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 cÚ¡ *
	$ev’t_şass_Çme
(
ua_ev’t
 
ev
)

14 
ev
) {

16 
UA_EVENT_REGISTERING
:

17 
UA_EVENT_REGISTER_OK
:

18 
UA_EVENT_REGISTER_FAIL
:

19 
UA_EVENT_UNREGISTERING
:

22 
UA_EVENT_SHUTDOWN
:

23 
UA_EVENT_EXIT
:

26 
UA_EVENT_CALL_INCOMING
:

27 
UA_EVENT_CALL_RINGING
:

28 
UA_EVENT_CALL_PROGRESS
:

29 
UA_EVENT_CALL_ESTABLISHED
:

30 
UA_EVENT_CALL_CLOSED
:

31 
UA_EVENT_CALL_TRANSFER_FAILED
:

32 
UA_EVENT_CALL_DTMF_START
:

33 
UA_EVENT_CALL_DTMF_END
:

34 
UA_EVENT_CALL_RTCP
:

40 
	}
}

43 
	$add_¹ı_¡©s
(
odiù
 *
od_·»Á
, cÚ¡ 
¹ı_¡©s
 *
rs
)

45 
odiù
 *
od
 = 
NULL
, *
tx
 = NULL, *
rx
 = NULL;

46 
”r
 = 0;

48 ià(!
od_·»Á
 || !
rs
)

49  
EINVAL
;

51 
”r
 = 
	`odiù_®loc
(&
od
, 8);

52 
”r
 |ğ
	`odiù_®loc
(&
tx
, 8);

53 
”r
 |ğ
	`odiù_®loc
(&
rx
, 8);

54 ià(
”r
)

55 
out
;

57 
”r
 = 
	`odiù_’Œy_add
(
tx
, "£Á", 
ODICT_INT
, (
št64_t
)
rs
->tx.
£Á
);

58 
”r
 |ğ
	`odiù_’Œy_add
(
tx
, "lo¡", 
ODICT_INT
, (
št64_t
)
rs
->tx.
lo¡
);

59 
”r
 |ğ
	`odiù_’Œy_add
(
tx
, "j™", 
ODICT_INT
, (
št64_t
)
rs
->tx.
j™
);

60 ià(
”r
)

61 
out
;

63 
”r
 = 
	`odiù_’Œy_add
(
rx
, "£Á", 
ODICT_INT
, (
št64_t
)
rs
->rx.
£Á
);

64 
”r
 |ğ
	`odiù_’Œy_add
(
rx
, "lo¡", 
ODICT_INT
, (
št64_t
)
rs
->rx.
lo¡
);

65 
”r
 |ğ
	`odiù_’Œy_add
(
rx
, "j™", 
ODICT_INT
, (
št64_t
)
rs
->rx.
j™
);

66 ià(
”r
)

67 
out
;

69 
”r
 = 
	`odiù_’Œy_add
(
od
, "tx", 
ODICT_OBJECT
, 
tx
);

70 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "rx", 
ODICT_OBJECT
, 
rx
);

71 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "¹t", 
ODICT_INT
, (
št64_t
)
rs
->
¹t
);

72 ià(
”r
)

73 
out
;

76 
”r
 = 
	`odiù_’Œy_add
(
od_·»Á
, "¹ı_¡©s", 
ODICT_OBJECT
, 
od
);

77 ià(
”r
)

78 
out
;

80 
out
:

81 
	`mem_d”ef
(
od
);

83  
”r
;

84 
	}
}

87 
	$ev’t_’code_diù
(
odiù
 *
od
, 
ua
 *ua, 
ua_ev’t
 
ev
,

88 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
)

90 cÚ¡ *
ev’t_¡r
 = 
	`uag_ev’t_¡r
(
ev
);

91 
”r
 = 0;

93 ià(!
od
)

94  
EINVAL
;

96 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "ty³", 
ODICT_STRING
, 
ev’t_¡r
);

97 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "class",

98 
ODICT_STRING
, 
	`ev’t_şass_Çme
(
ev
));

99 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "accouÁaÜ", 
ODICT_STRING
, 
	`ua_aÜ
(
ua
));

100 ià(
”r
)

101 
out
;

103 ià(
ÿÎ
) {

105 cÚ¡ *
dœ
;

107 
dœ
 = 
	`ÿÎ_is_outgošg
(
ÿÎ
) ? "outgoing" : "incoming";

109 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "dœeùiÚ", 
ODICT_STRING
, 
dœ
);

110 
”r
 |ğ
	`odiù_’Œy_add
(
od
, "peeruri",

111 
ODICT_STRING
, 
	`ÿÎ_³”uri
(
ÿÎ
));

112 ià(
”r
)

113 
out
;

116 ià(
	`¡r_is£t
(
´m
)) {

117 
”r
 = 
	`odiù_’Œy_add
(
od
, "·¿m", 
ODICT_STRING
, 
´m
);

118 ià(
”r
)

119 
out
;

122 ià(
ev
 =ğ
UA_EVENT_CALL_RTCP
) {

123 
¡»am
 *
¡rm
 = 
NULL
;

125 ià(0 =ğ
	`¡r_ÿ£cmp
(
´m
, "audio"))

126 
¡rm
 = 
	`audio_¡rm
(
	`ÿÎ_audio
(
ÿÎ
));

127 #ifdeà
USE_VIDEO


128 ià(0 =ğ
	`¡r_ÿ£cmp
(
´m
, "video"))

129 
¡rm
 = 
	`video_¡rm
(
	`ÿÎ_video
(
ÿÎ
));

132 
”r
 = 
	`add_¹ı_¡©s
(
od
, 
	`¡»am_¹ı_¡©s
(
¡rm
));

133 ià(
”r
)

134 
out
;

137 
out
:

139  
”r
;

140 
	}
}

150 cÚ¡ *
	$uag_ev’t_¡r
(
ua_ev’t
 
ev
)

152 
ev
) {

154 
UA_EVENT_REGISTERING
:  "REGISTERING";

155 
UA_EVENT_REGISTER_OK
:  "REGISTER_OK";

156 
UA_EVENT_REGISTER_FAIL
:  "REGISTER_FAIL";

157 
UA_EVENT_UNREGISTERING
:  "UNREGISTERING";

158 
UA_EVENT_SHUTDOWN
:  "SHUTDOWN";

159 
UA_EVENT_EXIT
:  "EXIT";

160 
UA_EVENT_CALL_INCOMING
:  "CALL_INCOMING";

161 
UA_EVENT_CALL_RINGING
:  "CALL_RINGING";

162 
UA_EVENT_CALL_PROGRESS
:  "CALL_PROGRESS";

163 
UA_EVENT_CALL_ESTABLISHED
:  "CALL_ESTABLISHED";

164 
UA_EVENT_CALL_CLOSED
:  "CALL_CLOSED";

165 
UA_EVENT_CALL_TRANSFER_FAILED
:  "TRANSFER_FAILED";

166 
UA_EVENT_CALL_DTMF_START
:  "CALL_DTMF_START";

167 
UA_EVENT_CALL_DTMF_END
:  "CALL_DTMF_END";

168 
UA_EVENT_CALL_RTCP
:  "CALL_RTCP";

171 
	}
}

	@baresip/src/h264.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

12 
	$h264_hdr_’code
(cÚ¡ 
h264_hdr
 *
hdr
, 
mbuf
 *
mb
)

14 
ušt8_t
 
v
;

16 
v
 = 
hdr
->
f
<<7 | hdr->
Äi
<<5 | hdr->
ty³
<<0;

18  
	`mbuf_wr™e_u8
(
mb
, 
v
);

19 
	}
}

22 
	$h264_hdr_decode
(
h264_hdr
 *
hdr
, 
mbuf
 *
mb
)

24 
ušt8_t
 
v
;

26 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

27  
ENOENT
;

29 
v
 = 
	`mbuf_»ad_u8
(
mb
);

31 
hdr
->
f
 = 
v
>>7 & 0x1;

32 
hdr
->
Äi
 = 
v
>>5 & 0x3;

33 
hdr
->
ty³
 = 
v
>>0 & 0x1f;

36 
	}
}

39 
	$h264_fu_hdr_’code
(cÚ¡ 
h264_fu
 *
fu
, 
mbuf
 *
mb
)

41 
ušt8_t
 
v
 = 
fu
->
s
<<7 | fu->s<<6 | fu->
r
<<5 | fu->
ty³
;

42  
	`mbuf_wr™e_u8
(
mb
, 
v
);

43 
	}
}

46 
	$h264_fu_hdr_decode
(
h264_fu
 *
fu
, 
mbuf
 *
mb
)

48 
ušt8_t
 
v
;

50 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

51  
ENOENT
;

53 
v
 = 
	`mbuf_»ad_u8
(
mb
);

55 
fu
->
s
 = 
v
>>7 & 0x1;

56 
fu
->
e
 = 
v
>>6 & 0x1;

57 
fu
->
r
 = 
v
>>5 & 0x1;

58 
fu
->
ty³
 = 
v
>>0 & 0x1f;

61 
	}
}

69 cÚ¡ 
ušt8_t
 *
	$h264_fšd_¡¬tcode
(cÚ¡ 
ušt8_t
 *
p
, cÚ¡ ušt8_ˆ*
’d
)

71 cÚ¡ 
ušt8_t
 *
a
 = 
p
 + 4 - (()p & 3);

73 
’d
 -ğ3; 
p
 < 
a
 &&… <ƒnd;…++ ) {

74 ià(
p
[0] == 0 &&…[1] == 0 &&…[2] == 1)

75  
p
;

78 
’d
 -ğ3; 
p
 <ƒnd;… += 4) {

79 
ušt32_t
 
x
 = *(cÚ¡ ušt32_t*)(*)
p
;

80 iàĞ(
x
 - 0x01010101) & (~x) & 0x80808080 ) {

81 ià(
p
[1] == 0 ) {

82 iàĞ
p
[0] == 0 &&…[2] == 1 )

83  
p
;

84 iàĞ
p
[2] == 0 &&…[3] == 1 )

85  
p
+1;

87 iàĞ
p
[3] == 0 ) {

88 iàĞ
p
[2] == 0 &&…[4] == 1 )

89  
p
+2;

90 iàĞ
p
[4] == 0 &&…[5] == 1 )

91  
p
+3;

96 
’d
 +ğ3; 
p
 <ƒnd;…++) {

97 ià(
p
[0] == 0 &&…[1] == 0 &&…[2] == 1)

98  
p
;

101  
’d
 + 3;

102 
	}
}

105 
	$¹p_£nd_d©a
(cÚ¡ 
ušt8_t
 *
hdr
, 
size_t
 
hdr_sz
,

106 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
,

107 
boŞ
 
eof
, 
ušt32_t
 
¹p_ts
,

108 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

110  
	`pkth
(
eof
, 
¹p_ts
, 
hdr
, 
hdr_sz
, 
buf
, 
sz
, 
¬g
);

111 
	}
}

114 
	$h264_Çl_£nd
(
boŞ
 
fœ¡
, boŞ 
Ï¡
,

115 
boŞ
 
m¬k”
, 
ušt32_t
 
ihdr
, ušt32_ˆ
¹p_ts
,

116 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
size
, size_ˆ
maxsz
,

117 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

119 
ušt8_t
 
hdr
 = (ušt8_t)
ihdr
;

120 
”r
 = 0;

122 ià(
fœ¡
 && 
Ï¡
 && 
size
 <ğ
maxsz
) {

123 
”r
 = 
	`¹p_£nd_d©a
(&
hdr
, 1, 
buf
, 
size
, 
m¬k”
, 
¹p_ts
,

124 
pkth
, 
¬g
);

127 
ušt8_t
 
fu_hdr
[2];

128 cÚ¡ 
ušt8_t
 
ty³
 = 
hdr
 & 0x1f;

129 cÚ¡ 
ušt8_t
 
Äi
 = 
hdr
 & 0x60;

130 cÚ¡ 
size_t
 
sz
 = 
maxsz
 - 2;

132 
fu_hdr
[0] = 
Äi
 | 
H264_NAL_FU_A
;

133 
fu_hdr
[1] = 
fœ¡
 ? (1<<7 | 
ty³
) :ype;

135 
size
 > 
sz
) {

136 
”r
 |ğ
	`¹p_£nd_d©a
(
fu_hdr
, 2, 
buf
, 
sz
, 
çl£
,

137 
¹p_ts
,

138 
pkth
, 
¬g
);

139 
buf
 +ğ
sz
;

140 
size
 -ğ
sz
;

141 
fu_hdr
[1] &= ~(1 << 7);

144 ià(
Ï¡
)

145 
fu_hdr
[1] |= 1<<6;

147 
”r
 |ğ
	`¹p_£nd_d©a
(
fu_hdr
, 2, 
buf
, 
size
, 
m¬k”
 && 
Ï¡
,

148 
¹p_ts
,

149 
pkth
, 
¬g
);

152  
”r
;

153 
	}
}

156 
	$h264_·ck‘ize
(
ušt32_t
 
¹p_ts
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
,

157 
size_t
 
pktsize
, 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

159 cÚ¡ 
ušt8_t
 *
¡¬t
 = 
buf
;

160 cÚ¡ 
ušt8_t
 *
’d
 = 
buf
 + 
Ën
;

161 cÚ¡ 
ušt8_t
 *
r
;

162 
”r
 = 0;

164 
r
 = 
	`h264_fšd_¡¬tcode
(
¡¬t
, 
’d
);

166 
r
 < 
’d
) {

167 cÚ¡ 
ušt8_t
 *
r1
;

170 !*(
r
++))

173 
r1
 = 
	`h264_fšd_¡¬tcode
(
r
, 
’d
);

175 
”r
 |ğ
	`h264_Çl_£nd
(
Œue
,rue, (
r1
 >ğ
’d
), 
r
[0],

176 
¹p_ts
, 
r
+1, 
r1
-r-1, 
pktsize
,

177 
pkth
, 
¬g
);

178 
r
 = 
r1
;

181  
”r
;

182 
	}
}

	@baresip/src/log.c

7 
	~<».h
>

8 
	~<b¬es.h
>

12 
li¡
 
	mlogl
;

13 
boŞ
 
	mdebug
;

14 
boŞ
 
	mšfo
;

15 
boŞ
 
	m¡d”
;

16 } 
	glg
 = {

17 
LIST_INIT
,

18 
çl£
,

19 
Œue
,

20 
Œue


24 
	$log_»gi¡”_hªdËr
(
log
 *log)

26 ià(!
log
)

29 
	`li¡_­³nd
(&
lg
.
logl
, &
log
->
Ë
,†og);

30 
	}
}

33 
	$log_uÄegi¡”_hªdËr
(
log
 *log)

35 ià(!
log
)

38 
	`li¡_uÆšk
(&
log
->
Ë
);

39 
	}
}

42 
	$log_’abË_debug
(
boŞ
 
’abË
)

44 
lg
.
debug
 = 
’abË
;

45 
	}
}

48 
	$log_’abË_šfo
(
boŞ
 
’abË
)

50 
lg
.
šfo
 = 
’abË
;

51 
	}
}

54 
	$log_’abË_¡d”r
(
boŞ
 
’abË
)

56 
lg
.
¡d”
 = 
’abË
;

57 
	}
}

60 
	$vlog
(
log_Ëv–
 
Ëv–
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

62 
buf
[4096];

63 
Ë
 *le;

65 ià(
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
) < 0)

68 ià(
lg
.
¡d”
) {

70 
boŞ
 
cŞÜ
 = 
Ëv–
 =ğ
LEVEL_WARN
 ||†ev– =ğ
LEVEL_ERROR
;

72 ià(
cŞÜ
)

73 ()
	`»_årštf
(
¡dout
, "\x1b[31m");

75 ()
	`»_årštf
(
¡dout
, "%s", 
buf
);

77 ià(
cŞÜ
)

78 ()
	`»_årštf
(
¡dout
, "\x1b[;m");

81 
Ë
 = 
lg
.
logl
.
h—d
;

83 
Ë
) {

85 
log
 *log = 
Ë
->
d©a
;

86 
Ë
 =†e->
Ãxt
;

88 ià(
log
->
h
)

89 
log
->
	`h
(
Ëv–
, 
buf
);

91 
	}
}

94 
	$loglv
(
log_Ëv–
 
Ëv–
, cÚ¡ *
fmt
, ...)

96 
va_li¡
 
­
;

98 ià((
LEVEL_DEBUG
 =ğ
Ëv–
è&& !
lg
.
debug
)

101 ià((
LEVEL_INFO
 =ğ
Ëv–
è&& !
lg
.
šfo
)

104 
	`va_¡¬t
(
­
, 
fmt
);

105 
	`vlog
(
Ëv–
, 
fmt
, 
­
);

106 
	`va_’d
(
­
);

107 
	}
}

110 
	$debug
(cÚ¡ *
fmt
, ...)

112 
va_li¡
 
­
;

114 ià(!
lg
.
debug
)

117 
	`va_¡¬t
(
­
, 
fmt
);

118 
	`vlog
(
LEVEL_DEBUG
, 
fmt
, 
­
);

119 
	`va_’d
(
­
);

120 
	}
}

123 
	$šfo
(cÚ¡ *
fmt
, ...)

125 
va_li¡
 
­
;

127 ià(!
lg
.
šfo
)

130 
	`va_¡¬t
(
­
, 
fmt
);

131 
	`vlog
(
LEVEL_INFO
, 
fmt
, 
­
);

132 
	`va_’d
(
­
);

133 
	}
}

136 
	$w¬nšg
(cÚ¡ *
fmt
, ...)

138 
va_li¡
 
­
;

140 
	`va_¡¬t
(
­
, 
fmt
);

141 
	`vlog
(
LEVEL_WARN
, 
fmt
, 
­
);

142 
	`va_’d
(
­
);

143 
	}
}

146 
	$”rÜ_msg
(cÚ¡ *
fmt
, ...)

148 
va_li¡
 
­
;

150 
	`va_¡¬t
(
­
, 
fmt
);

151 
	`vlog
(
LEVEL_ERROR
, 
fmt
, 
­
);

152 
	`va_’d
(
­
);

153 
	}
}

	@baresip/src/magic.h

8 #iâdeà
RELEASE


10 #iâdeà
MAGIC


18 #ià
__STDC_VERSION__
 >= 199901L

19 
	#__MAGIC_FUNC__
 (cÚ¡ *)
__func__


	)

21 
	#__MAGIC_FUNC__
 
__FUNCTION__


	)

26 
	#MAGIC_DECL
 
ušt32_t
 
magic
;

	)

27 
	#MAGIC_INIT
(
s
è(s)->
magic
 = 
MAGIC


	)

28 
	#MAGIC_CHECK
(
s
) \

29 ià(
MAGIC
 !ğ
s
->
magic
) { \

30 
	`w¬nšg
("%s: wrong magic struct=%p (magic=0x%08x)\n", \

31 
__MAGIC_FUNC__
, 
s
, s->
magic
); \

32 
BREAKPOINT
; \

33 }

	)

35 
	#MAGIC_DECL


	)

36 
	#MAGIC_INIT
(
s
)

	)

37 
	#MAGIC_CHECK
(
s
èdØ{()(s);} 0);

	)

	@baresip/src/main.c

6 #ifdeà
SOLARIS


7 
	#__EXTENSIONS__
 1

	)

9 
	~<¡dlib.h
>

10 #ifdeà
HAVE_UNISTD_H


11 
	~<uni¡d.h
>

13 #ifdeà
HAVE_GETOPT


14 
	~<g‘İt.h
>

16 
	~<».h
>

17 
	~<b¬es.h
>

20 
	$sigÇl_hªdËr
(
sig
)

22 
boŞ
 
‹rm
 = 
çl£
;

24 ià(
‹rm
) {

25 
	`mod_şo£
();

26 
	`ex™
(0);

29 
‹rm
 = 
Œue
;

31 
	`šfo
("‹rmš©ed by sigÇÈ%d\n", 
sig
);

33 
	`ua_¡İ_®l
(
çl£
);

34 
	}
}

37 
	$ua_ex™_hªdËr
(*
¬g
)

39 ()
¬g
;

40 
	`debug
("uaƒxited -- stopping main„unloop\n");

43 
	`»_ÿnûl
();

44 
	}
}

47 
	$u§ge
()

49 ()
	`»_årštf
(
¡d”r
,

52 #ià
HAVE_INET6


65 
	}
}

68 
	$maš
(
¬gc
, *
¬gv
[])

70 
boŞ
 
´eãr_v6
 = 
çl£
, 
run_d«mÚ
 = f®£, 
‹¡
 = false;

71 cÚ¡ *
ua_•rm
 = 
NULL
;

72 cÚ¡ *
execmdv
[16];

73 cÚ¡ *
audio_·th
 = 
NULL
;

74 cÚ¡ *
modv
[16];

75 
size_t
 
execmdc
 = 0;

76 
size_t
 
modc
 = 0;

77 
size_t
 
i
;

78 
”r
;

80 ()
	`»_årštf
(
¡dout
, "baresip v%s"

83 
BARESIP_VERSION
);

85 ()
	`sys_cÜedump_£t
(
Œue
);

87 
”r
 = 
	`lib»_š™
();

88 ià(
”r
)

89 
out
;

91 #ifdeà
HAVE_GETOPT


93 cÚ¡ 
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "6de:f:p:hu:vtm:");

94 ià(0 > 
c
)

97 
c
) {

101 
	`u§ge
();

104 #ià
HAVE_INET6


106 
´eãr_v6
 = 
Œue
;

111 
run_d«mÚ
 = 
Œue
;

115 ià(
execmdc
 >ğ
	`ARRAY_SIZE
(
execmdv
)) {

116 
	`w¬nšg
("max %zu commands\n",

117 
	`ARRAY_SIZE
(
execmdv
));

118 
”r
 = 
EINVAL
;

119 
out
;

121 
execmdv
[
execmdc
++] = 
İrg
;

125 
	`cÚf_·th_£t
(
İrg
);

129 ià(
modc
 >ğ
	`ARRAY_SIZE
(
modv
)) {

130 
	`w¬nšg
("max %zu modules\n",

131 
	`ARRAY_SIZE
(
modv
));

132 
”r
 = 
EINVAL
;

133 
out
;

135 
modv
[
modc
++] = 
İrg
;

139 
audio_·th
 = 
İrg
;

143 
‹¡
 = 
Œue
;

147 
ua_•rm
 = 
İrg
;

151 
	`log_’abË_debug
(
Œue
);

159 ()
¬gc
;

160 ()
¬gv
;

163 
”r
 = 
	`cÚf_cÚfigu»
();

164 ià(
”r
) {

165 
	`w¬nšg
("maš: cÚfigu» faed: %m\n", 
”r
);

166 
out
;

173 
”r
 = 
	`b¬es_š™
(
	`cÚf_cÚfig
(), 
´eãr_v6
);

174 ià(
”r
) {

175 
	`w¬nšg
("maš: b¬es in™ faed (%m)\n", 
”r
);

176 
out
;

180 ià(
audio_·th
)

181 
	`¶ay_£t_·th
(
	`b¬es_¶ay”
(), 
audio_·th
);

182 ià(
	`¡r_is£t
(
	`cÚf_cÚfig
()->
audio
.
audio_·th
)) {

183 
	`¶ay_£t_·th
(
	`b¬es_¶ay”
(),

184 
	`cÚf_cÚfig
()->
audio
.
audio_·th
);

188 ià(
modc
) {

190 
	`šfo
("´e-lßdšg moduËs: %zu\n", 
modc
);

192 
i
=0; i<
modc
; i++) {

194 
”r
 = 
	`moduË_´–ßd
(
modv
[
i
]);

195 ià(
”r
) {

196 
	`»_årštf
(
¡d”r
,

198 " '%s' (%m)\n", 
modv
[
i
], 
”r
);

204 
”r
 = 
	`ua_š™
("b¬es v" 
BARESIP_VERSION
 " (" 
ARCH
 "/" 
OS
 ")",

205 
Œue
,rue,rue, 
´eãr_v6
);

206 ià(
”r
)

207 
out
;

209 
	`uag_£t_ex™_hªdËr
(
ua_ex™_hªdËr
, 
NULL
);

211 ià(
ua_•rm
) {

212 
”r
 = 
	`uag_£t_exŒa_·¿ms
(
ua_•rm
);

213 ià(
”r
)

214 
out
;

217 ià(
‹¡
)

218 
out
;

221 
”r
 = 
	`cÚf_moduËs
();

222 ià(
”r
)

223 
out
;

225 ià(
run_d«mÚ
) {

226 
”r
 = 
	`sys_d«mÚ
();

227 ià(
”r
)

228 
out
;

230 
	`log_’abË_¡d”r
(
çl£
);

233 
	`šfo
("baresip is„eady.\n");

236 
i
=0; i<
execmdc
; i++) {

237 
	`ui_šput_¡r
(
execmdv
[
i
]);

239 
	`´štf
("will intohe„e_main function \n");

241 
”r
 = 
	`»_maš
(
sigÇl_hªdËr
);

243 
out
:

244 ià(
”r
)

245 
	`ua_¡İ_®l
(
Œue
);

247 
	`ua_şo£
();

248 
	`cÚf_şo£
();

250 
	`b¬es_şo£
();

255 
	`debug
("main: unloading modules..\n");

256 
	`mod_şo£
();

258 
	`lib»_şo£
();

261 
	`tmr_debug
();

262 
	`mem_debug
();

264  
”r
;

265 
	}
}

	@baresip/src/mctrl.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

32 
	$mù¾_hªdË_medŸ_cÚŒŞ
(
¶
 *
body
, 
boŞ
 *
pfu
)

34 ià(!
body
)

35  
EINVAL
;

38 ià(0 =ğ
	`»_»gex
(
body
->
p
, body->
l
, "picture_fast_update")) {

39 ià(
pfu
)

40 *
pfu
 = 
Œue
;

44 
	}
}

	@baresip/src/menc.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

17 
	$m’c_»gi¡”
(
li¡
 *
m’ş
, 
m’c
 *menc)

19 ià(!
m’ş
 || !
m’c
)

22 
	`li¡_­³nd
(
m’ş
, &
m’c
->
Ë
, menc);

24 
	`šfo
("medŸ’c: %s\n", 
m’c
->
id
);

25 
	}
}

33 
	$m’c_uÄegi¡”
(
m’c
 *menc)

35 ià(!
m’c
)

38 
	`li¡_uÆšk
(&
m’c
->
Ë
);

39 
	}
}

50 cÚ¡ 
m’c
 *
	$m’c_fšd
(cÚ¡ 
li¡
 *
m’ş
, cÚ¡ *
id
)

52 
Ë
 *le;

54 ià(!
m’ş
)

55  
NULL
;

57 
Ë
 = 
m’ş
->
h—d
;†e;†ğË->
Ãxt
) {

58 
m’c
 *
me
 = 
Ë
->
d©a
;

60 ià(0 =ğ
	`¡r_ÿ£cmp
(
id
, 
me
->id))

61  
me
;

64  
NULL
;

65 
	}
}

	@baresip/src/message.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

11 
	smes§ge
 {

12 
li¡
 
	ml¢¾
;

13 
s_l¢r
 *
	ms_l¢r
;

16 
	smes§ge_l¢r
 {

17 
Ë
 
	mË
;

18 
mes§ge_»cv_h
 *
	m»cvh
;

19 *
	m¬g
;

23 
	$de¡ruùÜ
(*
d©a
)

25 
mes§ge
 *mes§gğ
d©a
;

27 
	`li¡_æush
(&
mes§ge
->
l¢¾
);

28 
	`mem_d”ef
(
mes§ge
->
s_l¢r
);

29 
	}
}

32 
	$li¡’”_de¡ruùÜ
(*
d©a
)

34 
mes§ge_l¢r
 *
l¢r
 = 
d©a
;

36 
	`li¡_uÆšk
(&
l¢r
->
Ë
);

37 
	}
}

40 
	$hªdË_mes§ge
(
mes§ge_l¢r
 *
l¢r
, 
ua
 *ua,

41 cÚ¡ 
s_msg
 *
msg
)

43 cÚ¡ 
ùy³_‹xt
[] = "text/plain";

44 
¶
 
ùy³_¶
 = {
ùy³_‹xt
, (ctype_text)-1};

45 ()
ua
;

47 ià(
	`msg_ùy³_cmp
(&
msg
->
ùyp
, "‹xt", "¶aš"è&& 
l¢r
->
»cvh
) {

49 
l¢r
->
	`»cvh
(&
msg
->
äom
.
auri
, &
ùy³_¶
,

50 
msg
->
mb
, 
l¢r
->
¬g
);

52 ()
	`s_»¶y
(
	`uag_s
(), 
msg
, 200, "OK");

55 ()
	`s_»¶yf
(
	`uag_s
(), 
msg
, 415, "Unsupported Media Type",

59 
ùy³_‹xt
);

61 
	}
}

64 
boŞ
 
	$»que¡_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

66 
mes§ge
 *mes§gğ
¬g
;

67 
ua
 *ua;

68 
Ë
 *Ë = 
mes§ge
->
l¢¾
.
h—d
;

69 
boŞ
 
hdld
 = 
çl£
;

71 ià(
	`¶_¡rcmp
(&
msg
->
m‘
, "MESSAGE"))

72  
çl£
;

74 
ua
 = 
	`uag_fšd
(&
msg
->
uri
.
u£r
);

75 ià(!
ua
) {

76 ()
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
, 404, "Not Found");

77  
Œue
;

80 
Ë
) {

81 
mes§ge_l¢r
 *
l¢r
 = 
Ë
->
d©a
;

83 
Ë
 =†e->
Ãxt
;

85 
	`hªdË_mes§ge
(
l¢r
, 
ua
, 
msg
);

87 
hdld
 = 
Œue
;

90  
hdld
;

91 
	}
}

94 
	$mes§ge_š™
(
mes§ge
 **
mes§g•
)

96 
mes§ge
 *message;

97 
”r
 = 0;

99 ià(!
mes§g•
)

100  
EINVAL
;

102 
mes§ge
 = 
	`mem_z®loc
((*mes§ge), 
de¡ruùÜ
);

103 ià(!
mes§ge
)

104  
ENOMEM
;

108 ià(
”r
)

109 
	`mem_d”ef
(
mes§ge
);

111 *
mes§g•
 = 
mes§ge
;

113  
”r
;

114 
	}
}

117 
	$mes§ge_li¡’
(
mes§ge_l¢r
 **
l¢½
, 
mes§ge
 *message,

118 
mes§ge_»cv_h
 *
»cvh
, *
¬g
)

120 
mes§ge_l¢r
 *
l¢r
;

121 
”r
 = 0;

123 ià(!
mes§ge
 || !
»cvh
)

124  
EINVAL
;

127 ià(!
mes§ge
->
s_l¢r
) {

129 
”r
 = 
	`s_li¡’
(&
mes§ge
->
s_l¢r
, 
	`uag_s
(), 
Œue
,

130 
»que¡_hªdËr
, 
mes§ge
);

131 ià(
”r
)

132 
out
;

135 
l¢r
 = 
	`mem_z®loc
((*l¢r), 
li¡’”_de¡ruùÜ
);

137 
l¢r
->
»cvh
 =„ecvh;

138 
l¢r
->
¬g
 =‡rg;

140 
	`li¡_­³nd
(&
mes§ge
->
l¢¾
, &
l¢r
->
Ë
,†snr);

142 ià(
l¢½
)

143 *
l¢½
 = 
l¢r
;

145 
out
:

146  
”r
;

147 
	}
}

161 
	$mes§ge_£nd
(
ua
 *ua, cÚ¡ *
³”
, cÚ¡ *
msg
,

162 
s_»¥_h
 *
»¥h
, *
¬g
)

164 
s_addr
 
addr
;

165 
¶
…l;

166 *
uri
 = 
NULL
;

167 
”r
 = 0;

169 ià(!
ua
 || !
³”
 || !
msg
)

170  
EINVAL
;

172 
	`¶_£t_¡r
(&
¶
, 
³”
);

174 
”r
 = 
	`s_addr_decode
(&
addr
, &
¶
);

175 ià(
”r
)

176  
”r
;

178 
”r
 = 
	`¶_¡rdup
(&
uri
, &
addr
.
auri
);

179 ià(
”r
)

180  
”r
;

182 
”r
 = 
	`s_»q_£nd
(
ua
, "MESSAGE", 
uri
, 
»¥h
, 
¬g
,

187 
	`¡r_Ën
(
msg
), msg);

189 
	`mem_d”ef
(
uri
);

191  
”r
;

192 
	}
}

	@baresip/src/metric.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

11 ’um {
	mTMR_INTERVAL
 = 3};

12 
	$tmr_hªdËr
(*
¬g
)

14 
m‘ric
 *m‘riøğ
¬g
;

15 cÚ¡ 
ušt64_t
 
now
 = 
	`tmr_jiff›s
();

16 
ušt32_t
 
diff
;

18 
	`tmr_¡¬t
(&
m‘ric
->
tmr
, 
TMR_INTERVAL
 * 1000, 
tmr_hªdËr
, metric);

20 ià(!
m‘ric
->
¡¬‹d
)

23 ià(
now
 <ğ
m‘ric
->
ts_Ï¡
)

26 ià(
m‘ric
->
ts_Ï¡
) {

27 
ušt32_t
 
by‹s
 = 
m‘ric
->
n_by‹s
 - m‘ric->
n_by‹s_Ï¡
;

28 
diff
 = (
ušt32_t
)(
now
 - 
m‘ric
->
ts_Ï¡
);

29 
m‘ric
->
cur_b™¿‹
 = 1000 * 8 * 
by‹s
 / 
diff
;

33 
m‘ric
->
ts_Ï¡
 = 
now
;

34 
m‘ric
->
n_by‹s_Ï¡
 = m‘ric->
n_by‹s
;

35 
	}
}

38 
	$m‘ric_¡¬t
(
m‘ric
 *metric)

40 ià(
m‘ric
->
¡¬‹d
)

43 
m‘ric
->
ts_¡¬t
 = 
	`tmr_jiff›s
();

45 
m‘ric
->
¡¬‹d
 = 
Œue
;

46 
	}
}

49 
	$m‘ric_š™
(
m‘ric
 *metric)

51 ià(!
m‘ric
)

54 
	`tmr_¡¬t
(&
m‘ric
->
tmr
, 100, 
tmr_hªdËr
, metric);

55 
	}
}

58 
	$m‘ric_»£t
(
m‘ric
 *metric)

60 ià(!
m‘ric
)

63 
	`tmr_ÿnûl
(&
m‘ric
->
tmr
);

64 
	}
}

67 
	$m‘ric_add_·ck‘
(
m‘ric
 *m‘ric, 
size_t
 
·ck‘size
)

69 ià(!
m‘ric
)

72 ià(!
m‘ric
->
¡¬‹d
)

73 
	`m‘ric_¡¬t
(
m‘ric
);

75 
m‘ric
->
n_by‹s
 +ğ(
ušt32_t
)
·ck‘size
;

76 
m‘ric
->
n_·ck‘s
++;

77 
	}
}

80 
ušt32_t
 
	$m‘ric_avg_b™¿‹
(cÚ¡ 
m‘ric
 *metric)

82 
diff
;

84 ià(!
m‘ric
 || !m‘ric->
ts_¡¬t
)

87 
diff
 = ()(
	`tmr_jiff›s
(è- 
m‘ric
->
ts_¡¬t
);

89  1000 * 8 * (
m‘ric
->
n_by‹s
 / 
diff
);

90 
	}
}

	@baresip/src/mnat.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
	$de¡ruùÜ
(*
¬g
)

14 
mÇt
 *mÇˆğ
¬g
;

16 
	`li¡_uÆšk
(&
mÇt
->
Ë
);

17 
	}
}

33 
	$mÇt_»gi¡”
(
mÇt
 **
mÇ
, 
li¡
 *
mÇ
,

34 cÚ¡ *
id
, cÚ¡ *
áag
,

35 
mÇt_£ss_h
 *
£ssh
, 
mÇt_medŸ_h
 *
medŸh
,

36 
mÇt_upd©e_h
 *
upd©eh
)

38 
mÇt
 *mnat;

40 ià(!
mÇ
 || !
id
 || !
£ssh
 || !
medŸh
)

41  
EINVAL
;

43 
mÇt
 = 
	`mem_z®loc
((*mÇt), 
de¡ruùÜ
);

44 ià(!
mÇt
)

45  
ENOMEM
;

47 
	`li¡_­³nd
(
mÇ
, &
mÇt
->
Ë
, mnat);

49 
mÇt
->
id
 = id;

50 
mÇt
->
áag
 = ftag;

51 
mÇt
->
£ssh
 = sessh;

52 
mÇt
->
medŸh
 = mediah;

53 
mÇt
->
upd©eh
 = updateh;

55 
	`šfo
("medŸÇt: %s\n", 
id
);

57 *
mÇ
 = 
mÇt
;

60 
	}
}

71 cÚ¡ 
mÇt
 *
	$mÇt_fšd
(cÚ¡ 
li¡
 *
mÇ
, cÚ¡ *
id
)

73 
mÇt
 *mnat;

74 
Ë
 *le;

76 ià(!
mÇ
)

77  
NULL
;

79 
Ë
=
mÇ
->
h—d
;†e;†eöe->
Ãxt
) {

81 
mÇt
 = 
Ë
->
d©a
;

83 ià(
	`¡r_ÿ£cmp
(
mÇt
->
id
, id))

86  
mÇt
;

89  
NULL
;

90 
	}
}

	@baresip/src/module.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

18 
	$­³nd_ex‹nsiÚ
(*
buf
, 
size_t
 
sz
, cÚ¡ *
Çme
)

20 ià(0 =ğ
	`»_»gex
(
Çme
, 
	`¡r_Ën
Òame), "[^.]+"
MOD_EXT
, 
NULL
)) {

22 
	`¡r_nıy
(
buf
, 
Çme
, 
sz
);

25 
	`»_¢´štf
(
buf
, 
sz
, "%s"
MOD_EXT
, 
Çme
);

27 
	}
}

30 #ifdeà
STATIC


33 cÚ¡ 
mod_expÜt
 *
mod_bË
[];

35 cÚ¡ 
mod_expÜt
 *
	$lookup_¡©ic_moduË
(cÚ¡ 
¶
 *pl)

37 
¶
 
Çme
;

38 
ušt32_t
 
i
;

40 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^.]+.[^]*", &
Çme
, 
NULL
))

41 
Çme
 = *
¶
;

43 
i
=0; ; i++) {

44 cÚ¡ 
mod_expÜt
 *
me
 = 
mod_bË
[
i
];

45 ià(!
me
)

46  
NULL
;

47 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
Çme
, 
me
->name))

48  
me
;

51  
NULL
;

52 
	}
}

56 
	$lßd_moduË
(
mod
 **
modp
, cÚ¡ 
¶
 *
mod·th
,

57 cÚ¡ 
¶
 *
Çme
)

59 
fe
[
FS_PATH_MAX
];

60 
Çme¡r
[256];

61 
mod
 *
m
 = 
NULL
;

62 
”r
 = 0;

64 ià(!
Çme
)

65  
EINVAL
;

67 #ifdeà
STATIC


69 
	`¶_¡rıy
(
Çme
, 
Çme¡r
, (namestr));

71 ià(
	`mod_fšd
(
Çme¡r
)) {

72 
	`šfo
("¡©iømoduË‡Ì—dy†ßded: %r\n", 
Çme
);

73  
EALREADY
;

76 
”r
 = 
	`mod_add
(&
m
, 
	`lookup_¡©ic_moduË
(
Çme
));

77 ià(!
”r
)

78 
out
;

80 ()
Çme¡r
;

84 ià(
	`»_¢´štf
(
fe
, (fe), "%r/%r", 
mod·th
, 
Çme
) < 0) {

85 
”r
 = 
ENOMEM
;

86 
out
;

88 
”r
 = 
	`mod_lßd
(&
m
, 
fe
);

89 ià(
”r
)

90 
out
;

92 
out
:

93 ià(
”r
) {

94 
	`w¬nšg
("moduË %r: %m\n", 
Çme
, 
”r
);

96 ià(
modp
)

97 *
modp
 = 
m
;

99  
”r
;

100 
	}
}

103 
	$moduË_hªdËr
(cÚ¡ 
¶
 *
v®
, *
¬g
)

105 ()
	`lßd_moduË
(
NULL
, 
¬g
, 
v®
);

107 
	}
}

110 
	$moduË_tmp_hªdËr
(cÚ¡ 
¶
 *
v®
, *
¬g
)

112 
mod
 *mod = 
NULL
;

113 ()
	`lßd_moduË
(&
mod
, 
¬g
, 
v®
);

114 
	`mem_d”ef
(
mod
);

116 
	}
}

119 
	$moduË_­p_hªdËr
(cÚ¡ 
¶
 *
v®
, *
¬g
)

121 
mod
 *mod = 
NULL
;

122 cÚ¡ 
mod_expÜt
 *
me
;

124 
	`debug
("moduË:†ßdšg‡µ %r\n", 
v®
);

126 ià(
	`lßd_moduË
(&
mod
, 
¬g
, 
v®
)) {

130 
me
 = 
	`mod_expÜt
(
mod
);

131 ià(0 !ğ
	`¡r_ÿ£cmp
(
me
->
ty³
, "application")) {

132 
	`w¬nšg
("module_app %r should beype‡pplication (%s)\n",

133 
v®
, 
me
->
ty³
);

137 
	}
}

140 
	$moduË_š™
(cÚ¡ 
cÚf
 *conf)

142 
¶
 
·th
;

143 
”r
;

145 ià(!
cÚf
)

146  
EINVAL
;

148 ià(
	`cÚf_g‘
(
cÚf
, "moduË_·th", &
·th
))

149 
	`¶_£t_¡r
(&
·th
, ".");

151 
”r
 = 
	`cÚf_­¶y
(
cÚf
, "moduË", 
moduË_hªdËr
, &
·th
);

152 ià(
”r
)

153  
”r
;

155 
”r
 = 
	`cÚf_­¶y
(
cÚf
, "moduË_tmp", 
moduË_tmp_hªdËr
, &
·th
);

156 ià(
”r
)

157  
”r
;

159 
”r
 = 
	`cÚf_­¶y
(
cÚf
, "moduË_­p", 
moduË_­p_hªdËr
, &
·th
);

160 ià(
”r
)

161  
”r
;

164 
	}
}

167 
	$moduË_­p_uÆßd
()

169 
Ë
 *Ë = 
	`li¡_
(
	`mod_li¡
());

172 
Ë
) {

173 
mod
 *mod = 
Ë
->
d©a
;

174 cÚ¡ 
mod_expÜt
 *
me
 = 
	`mod_expÜt
(
mod
);

176 
Ë
 =†e->
´ev
;

178 ià(
me
 && 0 =ğ
	`¡r_ÿ£cmp
(me->
ty³
, "application")) {

179 
	`debug
("moduË: uÆßdšg‡µ %s\n", 
me
->
Çme
);

180 
	`mem_d”ef
(
mod
);

183 
	}
}

186 
	$moduË_´–ßd
(cÚ¡ *
moduË
)

188 
¶
 
·th
, 
Çme
;

190 ià(!
moduË
)

191  
EINVAL
;

193 
	`¶_£t_¡r
(&
·th
, ".");

194 
	`¶_£t_¡r
(&
Çme
, 
moduË
);

196  
	`lßd_moduË
(
NULL
, &
·th
, &
Çme
);

197 
	}
}

210 
	$moduË_lßd
(cÚ¡ *
Çme
)

212 
f’ame
[256];

213 
¶
 
·th
, 
¶_Çme
;

214 
”r
;

216 ià(!
	`¡r_is£t
(
Çme
))

217  
EINVAL
;

219 
	`­³nd_ex‹nsiÚ
(
f’ame
, (f’ame), 
Çme
);

221 
	`¶_£t_¡r
(&
¶_Çme
, 
f’ame
);

223 ià(
	`cÚf_g‘
(
	`cÚf_cur
(), "moduË_·th", &
·th
))

224 
	`¶_£t_¡r
(&
·th
, ".");

226 
”r
 = 
	`lßd_moduË
(
NULL
, &
·th
, &
¶_Çme
);

228  
”r
;

229 
	}
}

240 
	$moduË_uÆßd
(cÚ¡ *
Çme
)

242 
f’ame
[256];

243 
mod
 *mod;

245 ià(!
	`¡r_is£t
(
Çme
))

248 
	`­³nd_ex‹nsiÚ
(
f’ame
, (f’ame), 
Çme
);

250 
mod
 = 
	`mod_fšd
(
f’ame
);

251 ià(
mod
) {

252 
	`šfo
("uÆßdšg moduË: %s\n", 
f’ame
);

253 
	`mem_d”ef
(
mod
);

257 
	`šfo
("ERROR: ModuË % i nÙ cu¼’y†ßded\n", 
Çme
);

258 
	}
}

	@baresip/src/mos.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

11 
	$rçùÜ_to_mos
(
r
)

13 
mos
;

15 
mos
 = 1 + (0.035è* (
r
) + (0.000007) * (r) * ((r) - 60) * (100 - (r));

17 ià(
mos
 > 5)

18 
mos
 = 5;

20  
mos
;

21 
	}
}

36 
	$mos_ÿlcuÏ‹
(*
r_çùÜ
, 
¹t
,

37 
j™‹r
, 
ušt32_t
 
num_·ck‘s_lo¡
)

39 
efãùive_Ï‹ncy
 = 
¹t
 + (
j™‹r
 * 2) + 10;

40 
mos_v®
;

41 
r
;

43 ià(
efãùive_Ï‹ncy
 < 160) {

44 
r
 = 93.2 - (
efãùive_Ï‹ncy
 / 40);

47 
r
 = 93.2 - (
efãùive_Ï‹ncy
 - 120) / 10;

50 
r
 =„ - (
num_·ck‘s_lo¡
 * 2.5);

52 ià(
r
 > 100)

53 
r
 = 100;

54 ià(
r
 < 0)

55 
r
 = 0;

57 
mos_v®
 = 
	`rçùÜ_to_mos
(
r
);

59 ià(
r_çùÜ
)

60 *
r_çùÜ
 = 
r
;

62  
mos_v®
;

63 
	}
}

	@baresip/src/net.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

11 
	sÃtwÜk
 {

12 
cÚfig_Ãt
 
	mcfg
;

13 
§
 
	mÏddr
;

14 
	miâame
[16];

15 #ifdeà
HAVE_INET6


16 
§
 
	mÏddr6
;

17 
	miâame6
[16];

19 
tmr
 
	mtmr
;

20 
dnsc
 *
	mdnsc
;

21 
§
 
	mnsv
[
NET_MAX_NS
];

22 
ušt32_t
 
	mn¢
;

23 
ušt32_t
 
	mš‹rv®
;

24 
	maf
;

25 
	mdomaš
[64];

26 
Ãt_chªge_h
 *
	mch
;

27 *
	m¬g
;

31 
	$Ãt_dns¤v_add
(
ÃtwÜk
 *
Ãt
, cÚ¡ 
§
 *sa)

33 ià(!
Ãt
)

34  
EINVAL
;

36 ià(
Ãt
->
n¢
 >ğ
	`ARRAY_SIZE
Ò‘->
nsv
))

37  
E2BIG
;

39 
	`§_ıy
(&
Ãt
->
nsv
[Ãt->
n¢
++], 
§
);

42 
	}
}

45 
	$Ãt_dns_¤v_g‘
(cÚ¡ 
ÃtwÜk
 *
Ãt
,

46 
§
 *
¤vv
, 
ušt32_t
 *
n
, 
boŞ
 *
äom_sys
)

48 
§
 
nsv
[
NET_MAX_NS
];

49 
ušt32_t
 
i
, 
n¢
 = 
	`ARRAY_SIZE
(
nsv
);

50 
”r
;

52 
”r
 = 
	`dns_¤v_g‘
(
NULL
, 0, 
nsv
, &
n¢
);

53 ià(
”r
) {

54 
n¢
 = 0;

57 ià(
Ãt
->
n¢
) {

59 ià(
Ãt
->
n¢
 > *
n
)

60  
E2BIG
;

63 
i
=0; i<
Ãt
->
n¢
; i++) {

64 
¤vv
[
i
] = 
Ãt
->
nsv
[i];

67 *
n
 = 
Ãt
->
n¢
;

69 ià(
äom_sys
)

70 *
äom_sys
 = 
çl£
;

73 ià(
n¢
 > *
n
)

74  
E2BIG
;

76 
i
=0; i<
n¢
; i++)

77 
¤vv
[
i
] = 
nsv
[i];

79 *
n
 = 
n¢
;

81 ià(
äom_sys
)

82 *
äom_sys
 = 
Œue
;

86 
	}
}

92 
	$dns_»äesh
(
ÃtwÜk
 *
Ãt
)

94 
§
 
nsv
[
NET_MAX_NS
];

95 
ušt32_t
 
n¢
;

96 
”r
;

98 
n¢
 = 
	`ARRAY_SIZE
(
nsv
);

100 
”r
 = 
	`Ãt_dns_¤v_g‘
(
Ãt
, 
nsv
, &
n¢
, 
NULL
);

101 ià(
”r
)

104 ()
	`dnsc_¤v_£t
(
Ãt
->
dnsc
, 
nsv
, 
n¢
);

105 
	}
}

111 
	$chªge_hªdËr
(*
¬g
)

113 
ÃtwÜk
 *
Ãt
 = 
¬g
;

114 
boŞ
 
chªge
;

116 
	`tmr_¡¬t
(&
Ãt
->
tmr
,‚‘->
š‹rv®
 * 1000, 
chªge_hªdËr
,‚et);

118 
	`dns_»äesh
(
Ãt
);

120 
chªge
 = 
	`Ãt_check
(
Ãt
);

121 ià(
chªge
 && 
Ãt
->
ch
) {

122 
Ãt
->
	`ch
Ò‘->
¬g
);

124 
	}
}

134 
boŞ
 
	$Ãt_check
(
ÃtwÜk
 *
Ãt
)

136 
§
 
Ïddr
 = 
Ãt
->laddr;

137 #ifdeà
HAVE_INET6


138 
§
 
Ïddr6
 = 
Ãt
->laddr6;

140 
boŞ
 
chªge
 = 
çl£
;

142 ià(!
Ãt
)

143  
çl£
;

145 ià(
	`¡r_is£t
(
Ãt
->
cfg
.
iâame
)) {

147 ()
	`Ãt_if_g‘addr
(
Ãt
->
cfg
.
iâame
, 
AF_INET
, &Ãt->
Ïddr
);

149 #ifdeà
HAVE_INET6


150 ()
	`Ãt_if_g‘addr
(
Ãt
->
cfg
.
iâame
, 
AF_INET6
, &Ãt->
Ïddr6
);

154 ()
	`Ãt_deçuÉ_sourû_addr_g‘
(
AF_INET
, &
Ãt
->
Ïddr
);

155 ()
	`Ãt_¹_deçuÉ_g‘
(
AF_INET
, 
Ãt
->
iâame
,

156 (
Ãt
->
iâame
));

158 #ifdeà
HAVE_INET6


159 ()
	`Ãt_deçuÉ_sourû_addr_g‘
(
AF_INET6
, &
Ãt
->
Ïddr6
);

160 ()
	`Ãt_¹_deçuÉ_g‘
(
AF_INET6
, 
Ãt
->
iâame6
,

161 (
Ãt
->
iâame6
));

165 ià(
	`§_is£t
(&
Ãt
->
Ïddr
, 
SA_ADDR
) &&

166 !
	`§_cmp
(&
Ïddr
, &
Ãt
->Ïddr, 
SA_ADDR
)) {

167 
chªge
 = 
Œue
;

168 
	`šfo
("net:†ocal IPv4‡ddress changed: %j -> %j\n",

169 &
Ïddr
, &
Ãt
->laddr);

172 #ifdeà
HAVE_INET6


173 ià(
	`§_is£t
(&
Ãt
->
Ïddr6
, 
SA_ADDR
) &&

174 !
	`§_cmp
(&
Ïddr6
, &
Ãt
->Ïddr6, 
SA_ADDR
)) {

175 
chªge
 = 
Œue
;

176 
	`šfo
("net:†ocal IPv6‡ddress changed: %j -> %j\n",

177 &
Ïddr6
, &
Ãt
->laddr6);

181  
chªge
;

182 
	}
}

185 
	$dns_š™
(
ÃtwÜk
 *
Ãt
)

187 
§
 
nsv
[
NET_MAX_NS
];

188 
ušt32_t
 
n¢
 = 
	`ARRAY_SIZE
(
nsv
);

189 
”r
;

191 
”r
 = 
	`Ãt_dns_¤v_g‘
(
Ãt
, 
nsv
, &
n¢
, 
NULL
);

192 ià(
”r
)

193  
”r
;

195  
	`dnsc_®loc
(&
Ãt
->
dnsc
, 
NULL
, 
nsv
, 
n¢
);

196 
	}
}

202 
boŞ
 
	$check_v6
()

204 
§
 sa;

206  0 =ğ
	`§_£t_¡r
(&
§
, "::1", 2000);

207 
	}
}

210 
	$Ãt_de¡ruùÜ
(*
d©a
)

212 
ÃtwÜk
 *
Ãt
 = 
d©a
;

214 
	`tmr_ÿnûl
(&
Ãt
->
tmr
);

215 
	`mem_d”ef
(
Ãt
->
dnsc
);

216 
	}
}

228 
	$Ãt_®loc
(
ÃtwÜk
 **
Ã
, cÚ¡ 
cÚfig_Ãt
 *
cfg
, 
af
)

230 
ÃtwÜk
 *
Ãt
;

231 
§
 
nsv
[
NET_MAX_NS
];

232 
ušt32_t
 
n¢
 = 
	`ARRAY_SIZE
(
nsv
);

233 
buf4
[128] = "", 
buf6
[128] = "";

234 
”r
;

236 ià(!
Ã
 || !
cfg
)

237  
EINVAL
;

244 #ifdeà
HAVE_INET6


245 ià(!
	`check_v6
()) {

246 
	`”rÜ_msg
("libre was compiled without IPv6-support"

248  
EAFNOSUPPORT
;

251 ià(
	`check_v6
()) {

252 
	`”rÜ_msg
("libre was compiled with IPv6-support"

254  
EAFNOSUPPORT
;

258 
Ãt
 = 
	`mem_z®loc
((*Ãt), 
Ãt_de¡ruùÜ
);

259 ià(!
Ãt
)

260  
ENOMEM
;

262 
Ãt
->
cfg
 = *cfg;

263 
Ãt
->
af
 =‡f;

265 
	`tmr_š™
(&
Ãt
->
tmr
);

267 ià(
cfg
->
nsc
) {

268 
size_t
 
i
;

270 
i
=0; i<
cfg
->
nsc
; i++) {

272 cÚ¡ *
ns
 = 
cfg
->
nsv
[
i
].
addr
;

273 
§
 sa;

275 
”r
 = 
	`§_decode
(&
§
, 
ns
, 
	`¡r_Ën
(ns));

276 ià(
”r
) {

277 
	`w¬nšg
("net: dns_server:"

279 
ns
, 
”r
);

280 
out
;

283 
”r
 = 
	`Ãt_dns¤v_add
(
Ãt
, &
§
);

284 ià(
”r
) {

285 
	`w¬nšg
("net: failedo‡dd‚ameserver: %m\n",

286 
”r
);

287 
out
;

293 
”r
 = 
	`dns_š™
(
Ãt
);

294 ià(
”r
) {

295 
	`w¬nšg
("Ãt: dns_š™: %m\n", 
”r
);

296 
out
;

299 
	`§_š™
(&
Ãt
->
Ïddr
, 
AF_INET
);

300 ()
	`§_£t_¡r
(&
Ãt
->
Ïddr
, "127.0.0.1", 0);

302 ià(
	`¡r_is£t
(
cfg
->
iâame
)) {

304 
boŞ
 
gÙ_™
 = 
çl£
;

306 
	`šfo
("BšdšgØš‹rçû '%s'\n", 
cfg
->
iâame
);

308 
	`¡r_nıy
(
Ãt
->
iâame
, 
cfg
->ifname, (net->ifname));

310 
”r
 = 
	`Ãt_if_g‘addr
(
cfg
->
iâame
,

311 
AF_INET
, &
Ãt
->
Ïddr
);

312 ià(
”r
) {

313 
	`šfo
("net: %s: could‚ot get IPv4‡ddress (%m)\n",

314 
cfg
->
iâame
, 
”r
);

317 
gÙ_™
 = 
Œue
;

319 #ifdeà
HAVE_INET6


320 
	`¡r_nıy
(
Ãt
->
iâame6
, 
cfg
->
iâame
,

321 (
Ãt
->
iâame6
));

323 
”r
 = 
	`Ãt_if_g‘addr
(
cfg
->
iâame
,

324 
AF_INET6
, &
Ãt
->
Ïddr6
);

325 ià(
”r
) {

326 
	`šfo
("net: %s: could‚ot get IPv6‡ddress (%m)\n",

327 
cfg
->
iâame
, 
”r
);

330 
gÙ_™
 = 
Œue
;

332 ià(
gÙ_™
)

333 
”r
 = 0;

335 
	`w¬nšg
("net: %s: could‚ot get‚etwork‡ddress\n",

336 
cfg
->
iâame
);

337 
”r
 = 
EADDRNOTAVAIL
;

338 
out
;

342 ()
	`Ãt_deçuÉ_sourû_addr_g‘
(
AF_INET
, &
Ãt
->
Ïddr
);

343 ()
	`Ãt_¹_deçuÉ_g‘
(
AF_INET
, 
Ãt
->
iâame
,

344 (
Ãt
->
iâame
));

346 #ifdeà
HAVE_INET6


347 
	`§_š™
(&
Ãt
->
Ïddr6
, 
AF_INET6
);

349 ()
	`Ãt_deçuÉ_sourû_addr_g‘
(
AF_INET6
, &
Ãt
->
Ïddr6
);

350 ()
	`Ãt_¹_deçuÉ_g‘
(
AF_INET6
, 
Ãt
->
iâame6
,

351 (
Ãt
->
iâame6
));

355 ià(
	`§_is£t
(&
Ãt
->
Ïddr
, 
SA_ADDR
)) {

356 
	`»_¢´štf
(
buf4
, (buf4), " IPv4=%s:%j",

357 
Ãt
->
iâame
, &Ãt->
Ïddr
);

359 #ifdeà
HAVE_INET6


360 ià(
	`§_is£t
(&
Ãt
->
Ïddr6
, 
SA_ADDR
)) {

361 
	`»_¢´štf
(
buf6
, (buf6), " IPv6=%s:%j",

362 
Ãt
->
iâame6
, &Ãt->
Ïddr6
);

366 ()
	`dns_¤v_g‘
(
Ãt
->
domaš
, Ò‘->domaš), 
nsv
, &
n¢
);

368 
	`šfo
("Local‚etwork‡ddress: %s %s\n",

369 
buf4
, 
buf6
);

371 
out
:

372 ià(
”r
)

373 
	`mem_d”ef
(
Ãt
);

375 *
Ã
 = 
Ãt
;

377  
”r
;

378 
	}
}

389 
	$Ãt_u£_Çme£rv”
(
ÃtwÜk
 *
Ãt
, cÚ¡ 
§
 *
ns
)

391 
dnsc
 *dnsc;

392 
”r
;

394 ià(!
Ãt
 || !
ns
)

395  
EINVAL
;

397 
”r
 = 
	`dnsc_®loc
(&
dnsc
, 
NULL
, 
ns
, 1);

398 ià(
”r
)

399  
”r
;

401 
	`mem_d”ef
(
Ãt
->
dnsc
);

402 
Ãt
->
dnsc
 = dnsc;

405 
	}
}

416 
	$Ãt_chªge
(
ÃtwÜk
 *
Ãt
, 
ušt32_t
 
š‹rv®
,

417 
Ãt_chªge_h
 *
ch
, *
¬g
)

419 ià(!
Ãt
)

422 
Ãt
->
š‹rv®
 = interval;

423 
Ãt
->
ch
 = ch;

424 
Ãt
->
¬g
 =‡rg;

426 ià(
š‹rv®
)

427 
	`tmr_¡¬t
(&
Ãt
->
tmr
, 
š‹rv®
 * 1000, 
chªge_hªdËr
,‚et);

429 
	`tmr_ÿnûl
(&
Ãt
->
tmr
);

430 
	}
}

433 
	$Ãt_fÜû_chªge
(
ÃtwÜk
 *
Ãt
)

435 ià(
Ãt
 &&‚‘->
ch
) {

436 
Ãt
->
	`ch
Ò‘->
¬g
);

438 
	}
}

441 
	$dns_debug
(
»_´štf
 *
pf
, cÚ¡ 
ÃtwÜk
 *
Ãt
)

443 
§
 
nsv
[
NET_MAX_NS
];

444 
ušt32_t
 
i
, 
n¢
 = 
	`ARRAY_SIZE
(
nsv
);

445 
boŞ
 
äom_sys
 = 
çl£
;

446 
”r
;

448 ià(!
Ãt
)

451 
”r
 = 
	`Ãt_dns_¤v_g‘
(
Ãt
, 
nsv
, &
n¢
, &
äom_sys
);

452 ià(
”r
)

453 
n¢
 = 0;

455 
”r
 = 
	`»_h´štf
(
pf
, " DNS Servers from %s: (%u)\n",

456 
äom_sys
 ? "Sy¡em" : "CÚfig", 
n¢
);

457 
i
=0; i<
n¢
; i++)

458 
”r
 |ğ
	`»_h´štf
(
pf
, " %u: %J\n", 
i
, &
nsv
[i]);

460  
”r
;

461 
	}
}

464 
	$Ãt_af
(cÚ¡ 
ÃtwÜk
 *
Ãt
)

466 ià(!
Ãt
)

467  
AF_UNSPEC
;

469  
Ãt
->
af
;

470 
	}
}

481 
	$Ãt_debug
(
»_´štf
 *
pf
, cÚ¡ 
ÃtwÜk
 *
Ãt
)

483 
”r
;

485 ià(!
Ãt
)

488 
”r
 = 
	`»_h´štf
(
pf
, "--- Network debug ---\n");

489 
”r
 |ğ
	`»_h´štf
(
pf
, " P»ã¼ed AF: %s\n", 
	`Ãt_af2Çme
(
Ãt
->
af
));

490 
”r
 |ğ
	`»_h´štf
(
pf
, " Local IPv4: %9s - %j\n",

491 
Ãt
->
iâame
, &Ãt->
Ïddr
);

492 #ifdeà
HAVE_INET6


493 
”r
 |ğ
	`»_h´štf
(
pf
, " Local IPv6: %9s - %j\n",

494 
Ãt
->
iâame6
, &Ãt->
Ïddr6
);

496 
”r
 |ğ
	`»_h´štf
(
pf
, " Domaš: %s\n", 
Ãt
->
domaš
);

498 
”r
 |ğ
	`Ãt_if_debug
(
pf
, 
NULL
);

500 
”r
 |ğ
	`Ãt_¹_debug
(
pf
, 
NULL
);

502 
”r
 |ğ
	`dns_debug
(
pf
, 
Ãt
);

504  
”r
;

505 
	}
}

516 cÚ¡ 
§
 *
	$Ãt_Ïddr_af
(cÚ¡ 
ÃtwÜk
 *
Ãt
, 
af
)

518 ià(!
Ãt
)

519  
NULL
;

521 
af
) {

523 
AF_INET
:  &
Ãt
->
Ïddr
;

524 #ifdeà
HAVE_INET6


525 
AF_INET6
:  &
Ãt
->
Ïddr6
;

527 :  
NULL
;

529 
	}
}

539 
dnsc
 *
	$Ãt_dnsc
(cÚ¡ 
ÃtwÜk
 *
Ãt
)

541 ià(!
Ãt
)

542  
NULL
;

544  
Ãt
->
dnsc
;

545 
	}
}

555 cÚ¡ *
	$Ãt_domaš
(cÚ¡ 
ÃtwÜk
 *
Ãt
)

557 ià(!
Ãt
)

558  
NULL
;

560  
Ãt
->
domaš
[0] ?‚‘->domaš : 
NULL
;

561 
	}
}

	@baresip/src/play.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"cÜe.h
"

14 ’um {
	mPTIME
 = 40};

17 
	s¶ay
 {

18 
Ë
 
	mË
;

19 
¶ay
 **
	m¶ayp
;

20 
lock
 *
	mlock
;

21 
mbuf
 *
	mmb
;

22 
au¶ay_¡
 *
	mau¶ay
;

23 
tmr
 
	mtmr
;

24 
	m»³©
;

25 
boŞ
 
	meof
;

29 #iâdeà
PREFIX


30 
	#PREFIX
 "/u¤"

	)

32 cÚ¡ 
	gdeçuÉ_¶ay_·th
[
FS_PATH_MAX
] = 
PREFIX
 "/share/baresip";

35 
	s¶ay”
 {

36 
li¡
 
	m¶ayl
;

37 
	m¶ay_·th
[
FS_PATH_MAX
];

41 
tmr_pŞlšg
(*
¬g
);

44 
	$tmr_¡İ
(*
¬g
)

46 
¶ay
 *¶ay = 
¬g
;

47 
	`debug
("play:…layer complete.\n");

48 
	`mem_d”ef
(
¶ay
);

49 
	}
}

52 
	$tmr_pŞlšg
(*
¬g
)

54 
¶ay
 *¶ay = 
¬g
;

56 
	`lock_wr™e_g‘
(
¶ay
->
lock
);

58 
	`tmr_¡¬t
(&
¶ay
->
tmr
, 1000, 
tmr_pŞlšg
, 
¬g
);

60 ià(
¶ay
->
eof
) {

61 ià(
¶ay
->
»³©
 == 0)

62 
	`tmr_¡¬t
(&
¶ay
->
tmr
, 1, 
tmr_¡İ
, 
¬g
);

65 
	`lock_»l
(
¶ay
->
lock
);

66 
	}
}

72 
	$wr™e_hªdËr
(*
§mpv
, 
size_t
 
§mpc
, *
¬g
)

74 
¶ay
 *¶ay = 
¬g
;

75 
size_t
 
sz
 = 
§mpc
 * 2;

76 
size_t
 
pos
 = 0;

77 
size_t
 
Ëá
;

78 
size_t
 
couÁ
;

80 
	`lock_wr™e_g‘
(
¶ay
->
lock
);

82 ià(
¶ay
->
eof
)

83 
s’û
;

85 
pos
 < 
sz
) {

86 
Ëá
 = 
	`mbuf_g‘_Ëá
(
¶ay
->
mb
);

87 
couÁ
 = (
Ëá
 > 
sz
 - 
pos
) ? sz -…os :†eft;

89 ()
	`mbuf_»ad_mem
(
¶ay
->
mb
, (
ušt8_t
 *)
§mpv
 + 
pos
, 
couÁ
);

91 
pos
 +ğ
couÁ
;

93 ià(
pos
 < 
sz
) {

94 ià(
¶ay
->
»³©
 > 0)

95 
¶ay
->
»³©
--;

97 ià(
¶ay
->
»³©
 == 0) {

98 
¶ay
->
eof
 = 
Œue
;

99 
s’û
;

102 
¶ay
->
mb
->
pos
 = 0;

106 
s’û
:

107 ià(
¶ay
->
eof
)

108 
	`mem£t
((
ušt8_t
 *)
§mpv
 + 
pos
, 0, 
sz
 -…os);

110 
	`lock_»l
(
¶ay
->
lock
);

111 
	}
}

114 
	$de¡ruùÜ
(*
¬g
)

116 
¶ay
 *¶ay = 
¬g
;

118 
	`li¡_uÆšk
(&
¶ay
->
Ë
);

119 
	`tmr_ÿnûl
(&
¶ay
->
tmr
);

121 
	`lock_wr™e_g‘
(
¶ay
->
lock
);

122 
¶ay
->
eof
 = 
Œue
;

123 
	`lock_»l
(
¶ay
->
lock
);

125 
	`mem_d”ef
(
¶ay
->
au¶ay
);

126 
	`mem_d”ef
(
¶ay
->
mb
);

127 
	`mem_d”ef
(
¶ay
->
lock
);

129 ià(
¶ay
->
¶ayp
)

130 *
¶ay
->
¶ayp
 = 
NULL
;

131 
	}
}

134 
	$aufe_lßd
(
mbuf
 *
mb
, cÚ¡ *
f’ame
,

135 
ušt32_t
 *
¤©e
, 
ušt8_t
 *
chªÃls
)

137 
aufe_´m
 
´m
;

138 
aufe
 *
af
;

139 
”r
;

141 
”r
 = 
	`aufe_İ’
(&
af
, &
´m
, 
f’ame
, 
AUFILE_READ
);

142 ià(
”r
)

143  
”r
;

145 !
”r
) {

146 
ušt8_t
 
buf
[4096];

147 
size_t
 
i
, 
n
;

148 
št16_t
 *
p
 = (*)
buf
;

150 
n
 = (
buf
);

152 
”r
 = 
	`aufe_»ad
(
af
, 
buf
, &
n
);

153 ià(
”r
 || !
n
)

156 
´m
.
fmt
) {

158 
AUFMT_S16LE
:

160 
i
=0; i<
n
/2; i++) {

161 
št16_t
 
s
 = 
	`sys_Éohs
(*
p
++);

162 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
s
);

167 
AUFMT_PCMA
:

168 
i
=0; i<
n
; i++) {

169 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
,

170 
	`g711_®aw2pcm
(
buf
[
i
]));

174 
AUFMT_PCMU
:

175 
i
=0; i<
n
; i++) {

176 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
,

177 
	`g711_uÏw2pcm
(
buf
[
i
]));

182 
”r
 = 
ENOSYS
;

187 
	`mem_d”ef
(
af
);

189 ià(!
”r
) {

190 
mb
->
pos
 = 0;

192 *
¤©e
 = 
´m
.srate;

193 *
chªÃls
 = 
´m
.channels;

196  
”r
;

197 
	}
}

212 
	$¶ay_tÚe
(
¶ay
 **
¶ayp
, 
¶ay”
 *player,

213 
mbuf
 *
tÚe
, 
ušt32_t
 
¤©e
,

214 
ušt8_t
 
ch
, 
»³©
)

216 
au¶ay_´m
 
w´m
;

217 
¶ay
 *play;

218 
cÚfig
 *
cfg
;

219 
”r
;

221 ià(!
¶ay”
)

222  
EINVAL
;

223 ià(
¶ayp
 && *playp)

224  
EALREADY
;

226 
cfg
 = 
	`cÚf_cÚfig
();

227 ià(!
cfg
)

228  
ENOENT
;

230 
¶ay
 = 
	`mem_z®loc
((*¶ay), 
de¡ruùÜ
);

231 ià(!
¶ay
)

232  
ENOMEM
;

234 
	`tmr_š™
(&
¶ay
->
tmr
);

235 
¶ay
->
»³©
 =„epeat;

236 
¶ay
->
mb
 = 
	`mem_»f
(
tÚe
);

238 
”r
 = 
	`lock_®loc
(&
¶ay
->
lock
);

239 ià(
”r
)

240 
out
;

242 
w´m
.
ch
 = ch;

243 
w´m
.
¤©e
 = srate;

244 
w´m
.
±ime
 = 
PTIME
;

245 
w´m
.
fmt
 = 
AUFMT_S16LE
;

247 
”r
 = 
	`au¶ay_®loc
(&
¶ay
->
au¶ay
, 
	`b¬es_au¶ayl
(),

248 
cfg
->
audio
.
®”t_mod
, &
w´m
,

249 
cfg
->
audio
.
®”t_dev
, 
wr™e_hªdËr
, 
¶ay
);

250 ià(
”r
)

251 
out
;

253 
	`li¡_­³nd
(&
¶ay”
->
¶ayl
, &
¶ay
->
Ë
,…lay);

254 
	`tmr_¡¬t
(&
¶ay
->
tmr
, 1000, 
tmr_pŞlšg
,…lay);

256 
out
:

257 ià(
”r
) {

258 
	`mem_d”ef
(
¶ay
);

260 ià(
¶ayp
) {

261 
¶ay
->
¶ayp
 =…layp;

262 *
¶ayp
 = 
¶ay
;

265  
”r
;

266 
	}
}

279 
	$¶ay_fe
(
¶ay
 **
¶ayp
, 
¶ay”
 *player,

280 cÚ¡ *
f’ame
, 
»³©
)

282 
mbuf
 *
mb
;

283 
·th
[
FS_PATH_MAX
];

284 
ušt32_t
 
¤©e
 = 0;

285 
ušt8_t
 
ch
 = 0;

286 
”r
;

288 ià(!
¶ay”
)

289  
EINVAL
;

290 ià(
¶ayp
 && *playp)

291  
EALREADY
;

293 ià(
	`»_¢´štf
(
·th
, (path), "%s/%s",

294 
¶ay”
->
¶ay_·th
, 
f’ame
) < 0)

295  
ENOMEM
;

297 
mb
 = 
	`mbuf_®loc
(1024);

298 ià(!
mb
)

299  
ENOMEM
;

301 
”r
 = 
	`aufe_lßd
(
mb
, 
·th
, &
¤©e
, &
ch
);

302 ià(
”r
) {

303 
	`w¬nšg
("¶ay: %s: %m\n", 
·th
, 
”r
);

304 
out
;

307 
”r
 = 
	`¶ay_tÚe
(
¶ayp
, 
¶ay”
, 
mb
, 
¤©e
, 
ch
, 
»³©
);

309 
out
:

310 
	`mem_d”ef
(
mb
);

312  
”r
;

313 
	}
}

316 
	$¶ay”_de¡ruùÜ
(*
d©a
)

318 
¶ay”
 *¶ay” = 
d©a
;

320 
	`li¡_æush
(&
¶ay”
->
¶ayl
);

321 
	}
}

324 
	$¶ay_š™
(
¶ay”
 **
¶ay”p
)

326 
¶ay”
 *player;

328 ià(!
¶ay”p
)

329  
EINVAL
;

331 
¶ay”
 = 
	`mem_z®loc
((*¶ay”), 
¶ay”_de¡ruùÜ
);

332 ià(!
¶ay”
)

333  
ENOMEM
;

335 
	`li¡_š™
(&
¶ay”
->
¶ayl
);

337 
	`¡r_nıy
(
¶ay”
->
¶ay_·th
, 
deçuÉ_¶ay_·th
,

338 (
¶ay”
->
¶ay_·th
));

340 *
¶ay”p
 = 
¶ay”
;

343 
	}
}

346 
	$¶ay_£t_·th
(
¶ay”
 *¶ay”, cÚ¡ *
·th
)

348 ià(!
¶ay”
)

351 
	`¡r_nıy
(
¶ay”
->
¶ay_·th
, 
·th
, (player->play_path));

352 
	}
}

	@baresip/src/realtime.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 #ifdeà
DARWIN


9 
	~<sys/ty³s.h
>

10 
	~<sys/sysùl.h
>

11 
	~<¡dio.h
>

12 
	~<mach/mach.h
>

13 #ifdeà
__APPLE__


14 
	~"T¬g‘CÚd™iÚ®s.h
"

19 #ifdeà
DARWIN


20 
	$£t_»®time
(
³riod
, 
computiÚ
, 
cÚ¡¿št
)

22 
th»ad_time_cÚ¡¿št_pŞicy
 
‰ıŞicy
;

23 
»t
;

25 
‰ıŞicy
.
³riod
 =…eriod;

26 
‰ıŞicy
.
computiÚ
 = computation;

27 
‰ıŞicy
.
cÚ¡¿št
 = constraint;

28 
‰ıŞicy
.
´“m±ibË
 = 1;

30 
»t
 = 
	`th»ad_pŞicy_£t
(
	`mach_th»ad_£lf
(),

31 
THREAD_TIME_CONSTRAINT_POLICY
,

32 (
th»ad_pŞicy_t
)&
‰ıŞicy
,

33 
THREAD_TIME_CONSTRAINT_POLICY_COUNT
);

34 ià(
»t
 !ğ
KERN_SUCCESS
)

35  
ENOSYS
;

38 
	}
}

50 
	$»®time_’abË
(
boŞ
 
’abË
, 
ås
)

52 #ifdeà
DARWIN


53 ià(
’abË
) {

54 #ià
TARGET_OS_IPHONE


55 
bus_¥“d
 = 100000000;

57 
»t
, 
bus_¥“d
;

58 
mib
[2] = { 
CTL_HW
, 
HW_BUS_FREQ
 };

59 
size_t
 
Ën
;

61 
Ën
 = (
bus_¥“d
);

62 
»t
 = 
	`sysùl
 (
mib
, 2, &
bus_¥“d
, &
Ën
, 
NULL
, 0);

63 ià(
»t
 < 0) {

64  
ENOSYS
;

67 
	`šfo
("»®time: fps=%d bus_¥“d=%d\n", 
ås
, 
bus_¥“d
);

70  
	`£t_»®time
(
bus_¥“d
 / 
ås
,

71 
bus_¥“d
 / 3300, bus_speed / 2200);

74 
k”n_»tuº_t
 
»t
;

75 
th»ad_¡ªd¬d_pŞicy_d©a_t
 
±
;

76 
mach_msg_ty³_numb”_t
 
út
 = 
THREAD_STANDARD_POLICY_COUNT
;

77 
boŞ—n_t
 
g‘_deçuÉ
 = 
TRUE
;

79 
»t
 = 
	`th»ad_pŞicy_g‘
(
	`mach_th»ad_£lf
(),

80 
THREAD_STANDARD_POLICY
,

81 (
th»ad_pŞicy_t
)&
±
,

82 &
út
, &
g‘_deçuÉ
);

83 ià(
KERN_SUCCESS
 !ğ
»t
)

84  
ENOSYS
;

86 
»t
 = 
	`th»ad_pŞicy_£t
(
	`mach_th»ad_£lf
(),

87 
THREAD_STANDARD_POLICY
,

88 (
th»ad_pŞicy_t
)&
±
,

89 
THREAD_STANDARD_POLICY_COUNT
);

90 ià(
KERN_SUCCESS
 !ğ
»t
)

91  
ENOSYS
;

96 ()
’abË
;

97 ()
ås
;

98  
ENOSYS
;

100 
	}
}

	@baresip/src/reg.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

12 
	s»g
 {

13 
Ë
 
	mË
;

14 
ua
 *
	mua
;

15 
s»g
 *
	ms»g
;

16 
	mid
;

19 
ušt16_t
 
	mscode
;

20 *
	m¤v
;

21 
	maf
;

25 
	$de¡ruùÜ
(*
¬g
)

27 
»g
 *»g = 
¬g
;

29 
	`li¡_uÆšk
(&
»g
->
Ë
);

30 
	`mem_d”ef
(
»g
->
s»g
);

31 
	`mem_d”ef
(
»g
->
¤v
);

32 
	}
}

35 
	$smsg_af
(cÚ¡ 
s_msg
 *
msg
)

37 
§
 
Ïddr
;

38 
”r
 = 0;

40 ià(!
msg
)

41  
AF_UNSPEC
;

43 
msg
->

) {

45 
SIP_TRANSP_UDP
:

46 
”r
 = 
	`udp_loÿl_g‘
(
msg
->
sock
, &
Ïddr
);

49 
SIP_TRANSP_TCP
:

50 
SIP_TRANSP_TLS
:

51 
”r
 = 
	`tı_cÚn_loÿl_g‘
(
	`s_msg_tıcÚn
(
msg
), &
Ïddr
);

55  
AF_UNSPEC
;

58  
”r
 ? 
AF_UNSPEC
 : 
	`§_af
(&
Ïddr
);

59 
	}
}

62 cÚ¡ *
	$af_Çme
(
af
)

64 
af
) {

66 
AF_INET
:  "v4";

67 
AF_INET6
:  "v6";

70 
	}
}

73 
	$s_auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

74 cÚ¡ *
»®m
, *
¬g
)

76 
accouÁ
 *
acc
 = 
¬g
;

77  
	`accouÁ_auth
(
acc
, 
u£ºame
, 
·sswÜd
, 
»®m
);

78 
	}
}

81 
boŞ
 
	$cÚù_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
,

82 cÚ¡ 
s_msg
 *
msg
, *
¬g
)

84 
»g
 *»g = 
¬g
;

85 
s_addr
 
addr
;

86 ()
msg
;

88 ià(
	`s_addr_decode
(&
addr
, &
hdr
->
v®
))

89  
çl£
;

92  0 =ğ
	`¶_¡rÿ£cmp
(&
addr
.
uri
.
u£r
, 
	`ua_loÿl_cu£r
(
»g
->
ua
));

93 
	}
}

96 
	$»gi¡”_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

98 
»g
 *»g = 
¬g
;

99 cÚ¡ 
s_hdr
 *
hdr
;

101 ià(
”r
) {

102 
	`w¬nšg
("»g: %s: Regi¡”: %m\n", 
	`ua_aÜ
(
»g
->
ua
), 
”r
);

104 
»g
->
scode
 = 999;

106 
	`ua_ev’t
(
»g
->
ua
, 
UA_EVENT_REGISTER_FAIL
, 
NULL
, "%m", 
”r
);

110 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_SERVER
);

111 ià(
hdr
) {

112 
»g
->
¤v
 = 
	`mem_d”ef
(reg->srv);

113 ()
	`¶_¡rdup
(&
»g
->
¤v
, &
hdr
->
v®
);

116 ià(200 <ğ
msg
->
scode
 && msg->scode <= 299) {

118 
ušt32_t
 
n_bšdšgs
;

120 
n_bšdšgs
 = 
	`s_msg_hdr_couÁ
(
msg
, 
SIP_HDR_CONTACT
);

121 
»g
->
af
 = 
	`smsg_af
(
msg
);

123 ià(
msg
->
scode
 !ğ
»g
->scode) {

124 
	`ua_´štf
(
»g
->
ua
, "{%d/%s/%s} %u %r (%s)"

126 
»g
->
id
, 
	`s_Œª¥_Çme
(
msg
->

),

127 
	`af_Çme
(
»g
->
af
), 
msg
->
scode
, &msg->
»asÚ
,

128 
»g
->
¤v
, 
n_bšdšgs
,

129 1==
n_bšdšgs
?"":"s");

132 
»g
->
scode
 = 
msg
->scode;

134 
hdr
 = 
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_CONTACT
,

135 
cÚù_hªdËr
, 
»g
);

136 ià(
hdr
) {

137 
s_addr
 
addr
;

138 
¶
 
pv®
;

140 ià(0 =ğ
	`s_addr_decode
(&
addr
, &
hdr
->
v®
) &&

141 0 =ğ
	`msg_·¿m_decode
(&
addr
.
·¿ms
, "pub-gruu",

142 &
pv®
)) {

143 
	`ua_pub_gruu_£t
(
»g
->
ua
, &
pv®
);

147 
	`ua_ev’t
(
»g
->
ua
, 
UA_EVENT_REGISTER_OK
, 
NULL
, "%u %r",

148 
msg
->
scode
, &msg->
»asÚ
);

150 ià(
msg
->
scode
 >= 300) {

152 
	`w¬nšg
("»g: %s: %u %¸(%s)\n", 
	`ua_aÜ
(
»g
->
ua
),

153 
msg
->
scode
, &msg->
»asÚ
, 
»g
->
¤v
);

155 
»g
->
scode
 = 
msg
->scode;

157 
	`ua_ev’t
(
»g
->
ua
, 
UA_EVENT_REGISTER_FAIL
, 
NULL
, "%u %r",

158 
msg
->
scode
, &msg->
»asÚ
);

160 
	}
}

163 
	$»g_add
(
li¡
 *
l¡
, 
ua
 *ua, 
»gid
)

165 
»g
 *reg;

167 ià(!
l¡
 || !
ua
)

168  
EINVAL
;

170 
»g
 = 
	`mem_z®loc
((*»g), 
de¡ruùÜ
);

171 ià(!
»g
)

172  
ENOMEM
;

174 
»g
->
ua
 = ua;

175 
»g
->
id
 = 
»gid
;

177 
	`li¡_­³nd
(
l¡
, &
»g
->
Ë
,„eg);

180 
	}
}

183 
	$»g_»gi¡”
(
»g
 *»g, cÚ¡ *
»g_uri
, cÚ¡ *
·¿ms
,

184 
ušt32_t
 
»gšt
, cÚ¡ *
outbound
)

186 cÚ¡ *
rou‹v
[1];

187 
”r
;

189 ià(!
»g
 || !
»g_uri
)

190  
EINVAL
;

192 
»g
->
scode
 = 0;

193 
rou‹v
[0] = 
outbound
;

195 
»g
->
s»g
 = 
	`mem_d”ef
(reg->sipreg);

196 
”r
 = 
	`s»g_»gi¡”
(&
»g
->
s»g
, 
	`uag_s
(), 
»g_uri
,

197 
	`ua_aÜ
(
»g
->
ua
), ua_aor(reg->ua),

198 
»gšt
, 
	`ua_loÿl_cu£r
(
»g
->
ua
),

199 
rou‹v
[0] ?„ou‹v : 
NULL
,

200 
rou‹v
[0] ? 1 : 0,

201 
»g
->
id
,

202 
s_auth_hªdËr
, 
	`ua_accouÁ
(
»g
->
ua
), 
Œue
,

203 
»gi¡”_hªdËr
, 
»g
,

204 
·¿ms
[0] ? &·¿ms[1] : 
NULL
,

205 "AÎow: %s\r\n", 
	`uag_®lowed_m‘hods
());

206 ià(
”r
)

207  
”r
;

210 
	}
}

213 
	$»g_uÄegi¡”
(
»g
 *reg)

215 ià(!
»g
)

218 
»g
->
scode
 = 0;

219 
»g
->
af
 = 0;

221 
»g
->
s»g
 = 
	`mem_d”ef
(reg->sipreg);

222 
	}
}

225 
boŞ
 
	$»g_isok
(cÚ¡ 
»g
 *reg)

227 ià(!
»g
)

228  
çl£
;

230  200 <ğ
»g
->
scode
 &&„eg->scode <= 299;

231 
	}
}

234 cÚ¡ *
	$´št_scode
(
ušt16_t
 
scode
)

236 ià(0 =ğ
scode
)  "\x1b[33m" "zzz" "\x1b[;m";

237 ià(200 =ğ
scode
)  "\x1b[32m" "OK " "\x1b[;m";

239 
	}
}

242 
	$»g_debug
(
»_´štf
 *
pf
, cÚ¡ 
»g
 *reg)

244 
”r
 = 0;

246 ià(!
»g
)

249 
”r
 |ğ
	`»_h´štf
(
pf
, "\nRegister client:\n");

250 
”r
 |ğ
	`»_h´štf
(
pf
, " id: %d\n", 
»g
->
id
);

251 
”r
 |ğ
	`»_h´štf
(
pf
, " scode: %u (%s)\n",

252 
»g
->
scode
, 
	`´št_scode
(reg->scode));

253 
”r
 |ğ
	`»_h´štf
(
pf
, " srv: %s\n", 
»g
->
¤v
);

255  
”r
;

256 
	}
}

259 
	$»g_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
»g
 *reg)

261 ià(!
»g
)

264  
	`»_h´štf
(
pf
, " % %s", 
	`´št_scode
(
»g
->
scode
),„eg->
¤v
);

265 
	}
}

	@baresip/src/rtpext.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"cÜe.h
"

21 
	$¹³xt_hdr_’code
(
mbuf
 *
mb
, 
size_t
 
num_by‹s
)

23 
”r
 = 0;

25 ià(!
mb
 || !
num_by‹s
)

26  
EINVAL
;

28 ià(
num_by‹s
 & 0x3) {

29 
	`w¬nšg
("rtpext: hdr_encode:‚um_bytes (%zu) must be multiple"

30 " oà4\n", 
num_by‹s
);

31  
EINVAL
;

34 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
RTPEXT_TYPE_MAGIC
));

35 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
num_by‹s
 / 4));

37  
”r
;

38 
	}
}

41 
	$¹³xt_’code
(
mbuf
 *
mb
, 
id
, 
Ën
,

42 cÚ¡ 
ušt8_t
 *
d©a
)

44 
size_t
 
¡¬t
;

45 
”r
;

47 ià(!
mb
 || !
d©a
)

48  
EINVAL
;

50 ià(
id
 < 
RTPEXT_ID_MIN
 || id > 
RTPEXT_ID_MAX
)

51  
EINVAL
;

52 ià(
Ën
 < 
RTPEXT_LEN_MIN
 ||†’ > 
RTPEXT_LEN_MAX
)

53  
EINVAL
;

55 
¡¬t
 = 
mb
->
pos
;

57 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
id
 << 4 | (
Ën
-1));

58 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
d©a
, 
Ën
);

59 ià(
”r
)

60  
”r
;

63 (
mb
->
pos
 - 
¡¬t
) & 0x03)

64 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

66  
”r
;

67 
	}
}

70 
	$¹³xt_decode
(
¹³xt
 *
ext
, 
mbuf
 *
mb
)

72 
ušt8_t
 
v
;

73 
”r
;

75 ià(!
ext
 || !
mb
)

76  
EINVAL
;

78 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

79  
EBADMSG
;

81 
	`mem£t
(
ext
, 0, (*ext));

83 
v
 = 
	`mbuf_»ad_u8
(
mb
);

85 
ext
->
id
 = 
v
 >> 4;

86 
ext
->
Ën
 = (
v
 & 0x0f) + 1;

88 ià(
ext
->
id
 < 
RTPEXT_ID_MIN
 ||ƒxt->id > 
RTPEXT_ID_MAX
) {

89 
	`w¬nšg
("¹³xt: inv®id ID %u\n", 
ext
->
id
);

90  
EBADMSG
;

92 ià(
ext
->
Ën
 > 
	`mbuf_g‘_Ëá
(
mb
)) {

93 
	`w¬nšg
("rtpext: short„ead\n");

94  
ENODATA
;

97 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
ext
->
d©a
,ƒxt->
Ën
);

98 ià(
”r
)

99  
”r
;

102 
	`mbuf_g‘_Ëá
(
mb
)) {

103 
ušt8_t
 
·d
 = 
	`mbuf_buf
(
mb
)[0];

105 ià(
·d
 != 0x00)

108 
	`mbuf_advªû
(
mb
, 1);

112 
	}
}

	@baresip/src/rtpkeep.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

22 
	mTr_UDP
 = 15,

23 
	mTr_TCP
 = 7200

27 
	s¹pk“p
 {

28 
¹p_sock
 *
	m¹p
;

29 
sdp_medŸ
 *
	msdp
;

30 
tmr
 
	mtmr
;

31 *
	mm‘hod
;

32 
ušt32_t
 
	mts
;

33 
boŞ
 
	mæag
;

37 
	$de¡ruùÜ
(*
¬g
)

39 
¹pk“p
 *
rk
 = 
¬g
;

41 
	`tmr_ÿnûl
(&
rk
->
tmr
);

42 
	`mem_d”ef
(
rk
->
m‘hod
);

43 
	}
}

46 
	$£nd_k“·live
(
¹pk“p
 *
rk
)

48 
”r
 = 0;

50 ià(!
	`¡r_ÿ£cmp
(
rk
->
m‘hod
, "zero")) {

51 
mbuf
 *
mb
 = 
	`mbuf_®loc
(1);

52 ià(!
mb
)

53  
ENOMEM
;

54 
”r
 = 
	`udp_£nd
(
	`¹p_sock
(
rk
->
¹p
),

55 
	`sdp_medŸ_¿ddr
(
rk
->
sdp
), 
mb
);

56 
	`mem_d”ef
(
mb
);

58 ià(!
	`¡r_ÿ£cmp
(
rk
->
m‘hod
, "stun")) {

59 
”r
 = 
	`¡un_šdiÿtiÚ
(
IPPROTO_UDP
, 
	`¹p_sock
(
rk
->
¹p
),

60 
	`sdp_medŸ_¿ddr
(
rk
->
sdp
), 0,

61 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
, 0);

63 ià(!
	`¡r_ÿ£cmp
(
rk
->
m‘hod
, "dyna")) {

64 
mbuf
 *
mb
 = 
	`mbuf_®loc
(
RTP_HEADER_SIZE
);

65 
±
 = 
	`sdp_medŸ_fšd_unu£d_±
(
rk
->
sdp
);

66 ià(!
mb
)

67  
ENOMEM
;

68 ià(
±
 == -1)

69  
ENOENT
;

70 
mb
->
pos
 = mb->
’d
 = 
RTP_HEADER_SIZE
;

72 
”r
 = 
	`¹p_£nd
(
rk
->
¹p
, 
	`sdp_medŸ_¿ddr
Ôk->
sdp
), 
çl£
,

73 
çl£
, 
±
, 
rk
->
ts
, 
mb
);

75 
	`mem_d”ef
(
mb
);

77 ià(!
	`¡r_ÿ£cmp
(
rk
->
m‘hod
, "rtcp")) {

79 ià(
	`sdp_medŸ_¿‰r
(
rk
->
sdp
, "rtcp-mux")) {

84 
	`w¬nšg
("rtpkeep:„tcp-mux is disabled\n");

88 
	`w¬nšg
("¹pk“p: unknowÀm‘hod: %s\n", 
rk
->
m‘hod
);

89  
ENOSYS
;

92  
”r
;

93 
	}
}

107 
	$timeout
(*
¬g
)

109 
¹pk“p
 *
rk
 = 
¬g
;

110 
”r
;

112 
	`tmr_¡¬t
(&
rk
->
tmr
, 
Tr_UDP
 * 1000, 
timeout
,„k);

114 ià(
rk
->
æag
) {

115 
rk
->
æag
 = 
çl£
;

119 
”r
 = 
	`£nd_k“·live
(
rk
);

120 ià(
”r
) {

121 
	`w¬nšg
("¹pk“p: s’d k“·livçed: %m\n", 
”r
);

123 
	}
}

126 
	$¹pk“p_®loc
(
¹pk“p
 **
rkp
, cÚ¡ *
m‘hod
, 
´Ùo
,

127 
¹p_sock
 *
¹p
, 
sdp_medŸ
 *
sdp
)

129 
¹pk“p
 *
rk
;

130 
”r
;

132 ià(!
rkp
 || !
m‘hod
 || 
´Ùo
 !ğ
IPPROTO_UDP
 || !
¹p
 || !
sdp
)

133  
EINVAL
;

135 
rk
 = 
	`mem_z®loc
((*rk), 
de¡ruùÜ
);

136 ià(!
rk
)

137  
ENOMEM
;

139 
rk
->
¹p
 =„tp;

140 
rk
->
sdp
 = sdp;

142 
”r
 = 
	`¡r_dup
(&
rk
->
m‘hod
, method);

143 ià(
”r
)

144 
out
;

146 
	`tmr_¡¬t
(&
rk
->
tmr
, 20, 
timeout
,„k);

148 
out
:

149 ià(
”r
)

150 
	`mem_d”ef
(
rk
);

152 *
rkp
 = 
rk
;

154  
”r
;

155 
	}
}

158 
	$¹pk“p_»äesh
(
¹pk“p
 *
rk
, 
ušt32_t
 
ts
)

160 ià(!
rk
)

163 
rk
->
ts
 =s;

164 
rk
->
æag
 = 
Œue
;

165 
	}
}

	@baresip/src/sdp.c

6 
	~<¡dlib.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
ušt32_t
 
	$sdp_medŸ_¿‰r_u32
(cÚ¡ 
sdp_medŸ
 *
m
, cÚ¡ *
Çme
)

14 cÚ¡ *
©Œ
 = 
	`sdp_medŸ_¿‰r
(
m
, 
Çme
);

15  
©Œ
 ? 
	`©oi
(attr) : 0;

16 
	}
}

23 cÚ¡ *
	$sdp_¿‰r
(cÚ¡ 
sdp_£ssiÚ
 *
s
, cÚ¡ 
sdp_medŸ
 *
m
,

24 cÚ¡ *
Çme
)

26 cÚ¡ *
x
;

28 
x
 = 
	`sdp_medŸ_¿‰r
(
m
, 
Çme
);

29 ià(
x
)

30  
x
;

32 
x
 = 
	`sdp_£ssiÚ_¿‰r
(
s
, 
Çme
);

33 ià(
x
)

34  
x
;

36  
NULL
;

37 
	}
}

41 
	$sdp_fšg”´št_decode
(cÚ¡ *
©Œ
, 
¶
 *
hash
,

42 
ušt8_t
 *
md
, 
size_t
 *
sz
)

44 
¶
 
f
;

45 cÚ¡ *
p
;

46 
”r
;

48 ià(!
©Œ
 || !
hash
)

49  
EINVAL
;

51 
”r
 = 
	`»_»gex
(
©Œ
, 
	`¡r_Ën
×‰r), "[^ ]+ [0-9A-F:]+", 
hash
, &
f
);

52 ià(
”r
)

53  
”r
;

55 ià(
md
 && 
sz
) {

56 ià(*
sz
 < (
f
.
l
+1)/3)

57  
EOVERFLOW
;

59 
p
 = 
f
.p;… < (f.p+f.
l
);… += 3) {

60 *
md
++ = 
	`ch_hex
(
p
[0]) << 4 | ch_hex(p[1]);

63 *
sz
 = (
f
.
l
+1)/3;

67 
	}
}

70 
boŞ
 
	$sdp_medŸ_has_medŸ
(cÚ¡ 
sdp_medŸ
 *
m
)

72 
boŞ
 
has
;

74 
has
 = 
	`sdp_medŸ_rfÜm©
(
m
, 
NULL
) != NULL;

75 ià(
has
)

76  
	`sdp_medŸ_½Üt
(
m
) != 0;

78  
çl£
;

79 
	}
}

89 
	$sdp_medŸ_fšd_unu£d_±
(cÚ¡ 
sdp_medŸ
 *
m
)

91 
±
;

93 
±
 = 
PT_DYN_MAX
;…t>=
PT_DYN_MIN
;…t--) {

95 ià(!
	`sdp_medŸ_fÜm©
(
m
, 
çl£
, 
NULL
, 
±
, NULL, -1, -1))

96  
±
;

100 
	}
}

103 cÚ¡ 
sdp_fÜm©
 *
	$sdp_medŸ_fÜm©_cyşe
(
sdp_medŸ
 *
m
)

105 
sdp_fÜm©
 *
sf
;

106 
li¡
 *
l¡
;

108 
agaš
:

109 
sf
 = (
sdp_fÜm©
 *)
	`sdp_medŸ_rfÜm©
(
m
, 
NULL
);

110 ià(!
sf
)

111  
NULL
;

113 
l¡
 = 
sf
->
Ë
.
li¡
;

116 
	`li¡_uÆšk
(&
sf
->
Ë
);

117 
	`li¡_­³nd
(
l¡
, &
sf
->
Ë
, sf);

119 
sf
 = (
sdp_fÜm©
 *)
	`sdp_medŸ_rfÜm©
(
m
, 
NULL
);

120 ià(!
	`¡r_ÿ£cmp
(
sf
->
Çme
, 
‹Ëv_¹pfmt
))

121 
agaš
;

123  
sf
;

124 
	}
}

127 
	$decode_·¹
(cÚ¡ 
¶
 *
·¹
, 
mbuf
 *
mb
)

129 
¶
 
hdrs
, 
body
;

131 ià(
	`»_»gex
(
·¹
->
p
,…¬t->
l
, "\r\n\r\n[^]+", &
body
))

134 
hdrs
.
p
 = 
·¹
->p;

135 
hdrs
.
l
 = 
body
.
p
 - 
·¹
->p - 2;

137 ià(0 =ğ
	`»_»gex
(
hdrs
.
p
, hdrs.
l
, "application/sdp")) {

139 
mb
->
pos
 +ğ(
body
.
p
 - (*)
	`mbuf_buf
(mb));

140 
mb
->
’d
 = mb->
pos
 + 
body
.
l
;

142 
	}
}

153 
	$sdp_decode_muÉ¬t
(cÚ¡ 
¶
 *
ùy³_´m
, 
mbuf
 *
mb
)

155 
¶
 
bnd
, 
s
, 
e
, 
p
;

156 
ex´
[64];

157 
”r
;

159 ià(!
ùy³_´m
 || !
mb
)

160  
EINVAL
;

163 
”r
 = 
	`»_»gex
(
ùy³_´m
->
p
, cty³_´m->
l
,

164 "bound¬y=[~]+", &
bnd
);

165 ià(
”r
)

166  
”r
;

168 ià(
	`»_¢´štf
(
ex´
, Óx´), "--%r[^]+", &
bnd
) < 0)

169  
ENOMEM
;

172 
”r
 = 
	`»_»gex
((*)
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb), 
ex´
, &
s
);

173 ià(
”r
)

174  
”r
;

177 
s
.
l
 > 2) {

178 ià(
	`»_»gex
(
s
.
p
, s.
l
, 
ex´
, &
e
))

181 
p
.°ğ
s
.p + 2;

182 
p
.
l
 = 
e
.°-….°- 
bnd
.l - 2;

185 
	`decode_·¹
(&
p
, 
mb
);

187 
s
 = 
e
;

191 
	}
}

	@baresip/src/sipreq.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

12 
	ss_»q
 {

13 
s_loİ¡©e
 
	mls
;

14 
s_dŸlog
 *
	mdlg
;

15 
s_auth
 *
	mauth
;

16 
s_»que¡
 *
	m»q
;

17 *
	mm‘hod
;

18 *
	mfmt
;

19 
s_»¥_h
 *
	m»¥h
;

20 *
	m¬g
;

24 
»que¡
(
s_»q
 *
¤
);

27 
	$de¡ruùÜ
(*
¬g
)

29 
s_»q
 *
¤
 = 
¬g
;

31 
	`mem_d”ef
(
¤
->
»q
);

32 
	`mem_d”ef
(
¤
->
auth
);

33 
	`mem_d”ef
(
¤
->
dlg
);

34 
	`mem_d”ef
(
¤
->
m‘hod
);

35 
	`mem_d”ef
(
¤
->
fmt
);

36 
	}
}

39 
	$»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

41 
s_»q
 *
¤
 = 
¬g
;

43 ià(
”r
 || 
	`s_»que¡_loİs
(&
¤
->
ls
, 
msg
->
scode
))

44 
out
;

46 ià(
msg
->
scode
 < 200) {

49 ià(
msg
->
scode
 < 300) {

53 
msg
->
scode
) {

57 
”r
 = 
	`s_auth_auth’tiÿ‹
(
¤
->
auth
, 
msg
);

58 ià(
”r
) {

59 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

63 
”r
 = 
	`»que¡
(
¤
);

64 ià(
”r
)

70 
	`s_auth_»£t
(
¤
->
auth
);

75 
out
:

76 ià(
¤
->
»¥h
)

77 
¤
->
	`»¥h
(
”r
, 
msg
, sr->
¬g
);

80 
	`mem_d”ef
(
¤
);

81 
	}
}

84 
	$auth_hªdËr
(**
u£ºame
, **
·sswÜd
,

85 cÚ¡ *
»®m
, *
¬g
)

87 
accouÁ
 *
acc
 = 
¬g
;

89  
	`accouÁ_auth
(
acc
, 
u£ºame
, 
·sswÜd
, 
»®m
);

90 
	}
}

93 
	$»que¡
(
s_»q
 *
¤
)

95  
	`s_d»que¡f
(&
¤
->
»q
, 
	`uag_s
(), 
Œue
, sr->
m‘hod
, sr->
dlg
,

96 0, 
¤
->
auth
, 
NULL
, 
»¥_hªdËr
,

97 
¤
, sr->
fmt
 ? "%s" : 
NULL
, sr->fmt);

98 
	}
}

101 
	$s_»q_£nd
(
ua
 *ua, cÚ¡ *
m‘hod
, cÚ¡ *
uri
,

102 
s_»¥_h
 *
»¥h
, *
¬g
, cÚ¡ *
fmt
, ...)

104 cÚ¡ *
rou‹v
[1];

105 
s_»q
 *
¤
;

106 
”r
;

108 ià(!
ua
 || !
m‘hod
 || !
uri
 || !
fmt
)

109  
EINVAL
;

111 
rou‹v
[0] = 
	`ua_outbound
(
ua
);

113 
¤
 = 
	`mem_z®loc
((*¤), 
de¡ruùÜ
);

114 ià(!
¤
)

115  
ENOMEM
;

117 
¤
->
»¥h
 =„esph;

118 
¤
->
¬g
 =‡rg;

120 
”r
 = 
	`¡r_dup
(&
¤
->
m‘hod
, method);

122 ià(
fmt
) {

123 
va_li¡
 
­
;

125 
	`va_¡¬t
(
­
, 
fmt
);

126 
”r
 |ğ
	`»_vsd´štf
(&
¤
->
fmt
, fmt, 
­
);

127 
	`va_’d
(
­
);

130 ià(
”r
)

131 
out
;

133 
”r
 = 
	`s_dŸlog_®loc
(&
¤
->
dlg
, 
uri
, uri, 
NULL
, 
	`ua_aÜ
(
ua
),

134 
rou‹v
[0] ?„ou‹v : 
NULL
,

135 
rou‹v
[0] ? 1 : 0);

136 ià(
”r
)

137 
out
;

139 
”r
 = 
	`s_auth_®loc
(&
¤
->
auth
, 
auth_hªdËr
, 
	`ua_accouÁ
(
ua
), 
Œue
);

140 ià(
”r
)

141 
out
;

143 
”r
 = 
	`»que¡
(
¤
);

145 
out
:

146 ià(
”r
)

147 
	`mem_d”ef
(
¤
);

149  
”r
;

150 
	}
}

	@baresip/src/stream.c

6 
	~<¡ršg.h
>

7 
	~<time.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"cÜe.h
"

14 
	mRTP_RECV_SIZE
 = 8192,

15 
	mRTP_CHECK_INTERVAL
 = 1000

19 
	$¡»am_şo£
(
¡»am
 *
¡rm
, 
”r
)

21 
¡»am_”rÜ_h
 *
”rÜh
 = 
¡rm
->errorh;

23 
¡rm
->
‹rmš©ed
 = 
Œue
;

24 
¡rm
->
”rÜh
 = 
NULL
;

26 ià(
”rÜh
) {

27 
	`”rÜh
(
¡rm
, 
”r
, sŒm->
”rÜh_¬g
);

29 
	}
}

32 
	$check_¹p_hªdËr
(*
¬g
)

34 
¡»am
 *
¡rm
 = 
¬g
;

35 cÚ¡ 
ušt64_t
 
now
 = 
	`tmr_jiff›s
();

36 
diff_ms
;

38 
	`tmr_¡¬t
(&
¡rm
->
tmr_¹p
, 
RTP_CHECK_INTERVAL
,

39 
check_¹p_hªdËr
, 
¡rm
);

42 ià(!
¡rm
->
ts_Ï¡
)

48 ià(
	`sdp_medŸ_dœ
(
¡rm
->
sdp
è=ğ
SDP_SENDRECV
) {

50 
diff_ms
 = ()(
now
 - 
¡rm
->
ts_Ï¡
);

52 
	`debug
("stream:†ast \"%s\" RTP…acket: %d milliseconds\n",

53 
	`sdp_medŸ_Çme
(
¡rm
->
sdp
), 
diff_ms
);

56 ià(
diff_ms
 > (3600 * 1000)) {

57 
¡rm
->
ts_Ï¡
 = 0;

61 ià(
diff_ms
 > ()
¡rm
->
¹p_timeout_ms
) {

63 
	`šfo
("stream:‚o %s RTP…ackets„eceived for"

65 
	`sdp_medŸ_Çme
(
¡rm
->
sdp
), 
diff_ms
);

67 
	`¡»am_şo£
(
¡rm
, 
ETIMEDOUT
);

71 
	`»_´štf
("check_rtp:‚ot checking (dir=%s)\n",

72 
	`sdp_dœ_Çme
(
	`sdp_medŸ_dœ
(
¡rm
->
sdp
)));

74 
	}
}

77 
šlše
 
	$lo¡ÿlc
(
¡»am
 *
s
, 
ušt16_t
 
£q
)

79 cÚ¡ 
ušt16_t
 
d–
 = 
£q
 - 
s
->
p£q
;

80 
lo¡c
;

82 ià(
s
->
p£q
 =ğ(
ušt32_t
)-1)

83 
lo¡c
 = 0;

84 ià(
d–
 == 0)

86 ià(
d–
 < 3000)

87 
lo¡c
 = 
d–
 - 1;

88 ià(
d–
 < 0xff9c)

89 
lo¡c
 = 0;

93 
s
->
p£q
 = 
£q
;

95  
lo¡c
;

96 
	}
}

99 
	$´št_¹p_¡©s
(cÚ¡ 
¡»am
 *
s
)

101 
boŞ
 
¡¬‹d
 = 
s
->
m‘ric_tx
.
n_·ck‘s
>0 || s->
m‘ric_rx
.n_packets>0;

103 ià(!
¡¬‹d
)

106 
	`šfo
("\n%-9s Transmit: Receive:\n"

111 
	`sdp_medŸ_Çme
(
s
->
sdp
),

112 
s
->
m‘ric_tx
.
n_·ck‘s
, s->
m‘ric_rx
.n_packets,

113 1.0*
	`m‘ric_avg_b™¿‹
(&
s
->
m‘ric_tx
)/1000,

114 1.0*
	`m‘ric_avg_b™¿‹
(&
s
->
m‘ric_rx
)/1000,

115 
s
->
m‘ric_tx
.
n_”r
, s->
m‘ric_rx
.n_err

118 ià(
s
->
¹ı_¡©s
.
tx
.
£Á
 || s->¹ı_¡©s.
rx
.sent) {

120 
	`šfo
("pkt.report: %7u %7u\n"

123 
s
->
¹ı_¡©s
.
tx
.
£Á
, s->¹ı_¡©s.
rx
.sent,

124 
s
->
¹ı_¡©s
.
tx
.
lo¡
, s->¹ı_¡©s.
rx
.lost,

125 1.0*
s
->
¹ı_¡©s
.
tx
.
j™
/1000,

126 1.0*
s
->
¹ı_¡©s
.
rx
.
j™
/1000);

128 
	}
}

131 
	$¡»am_de¡ruùÜ
(*
¬g
)

133 
¡»am
 *
s
 = 
¬g
;

135 ià(
s
->
cfg
.
¹p_¡©s
)

136 
	`´št_¹p_¡©s
(
s
);

138 
	`m‘ric_»£t
(&
s
->
m‘ric_tx
);

139 
	`m‘ric_»£t
(&
s
->
m‘ric_rx
);

141 
	`tmr_ÿnûl
(&
s
->
tmr_¹p
);

142 
	`li¡_uÆšk
(&
s
->
Ë
);

143 
	`mem_d”ef
(
s
->
¹pk“p
);

144 
	`mem_d”ef
(
s
->
sdp
);

145 
	`mem_d”ef
(
s
->
mes
);

146 
	`mem_d”ef
(
s
->
m’cs
);

147 
	`mem_d”ef
(
s
->
mns
);

148 
	`mem_d”ef
(
s
->
jbuf
);

149 
	`mem_d”ef
(
s
->
¹p
);

150 
	`mem_d”ef
(
s
->
úame
);

151 
	}
}

154 
	$hªdË_¹p
(
¡»am
 *
s
, cÚ¡ 
¹p_h—d”
 *
hdr
,

155 
mbuf
 *
mb
)

157 
¹³xt
 
extv
[8];

158 
size_t
 
extc
 = 0;

161 ià(
hdr
->
ext
 && hdr->
x
.
Ën
 && 
mb
) {

163 cÚ¡ 
size_t
 
pos
 = 
mb
->pos;

164 cÚ¡ 
size_t
 
’d
 = 
mb
->end;

165 cÚ¡ 
size_t
 
ext_¡İ
 = 
mb
->
pos
;

166 
size_t
 
ext_Ën
;

167 
size_t
 
i
;

168 
”r
;

170 ià(
hdr
->
x
.
ty³
 !ğ
RTPEXT_TYPE_MAGIC
) {

171 
	`šfo
("stream: unknownƒxtype ignored (0x%04x)\n",

172 
hdr
->
x
.
ty³
);

173 
hªdËr
;

176 
ext_Ën
 = 
hdr
->
x
.
Ën
*(
ušt32_t
);

177 ià(
mb
->
pos
 < 
ext_Ën
) {

178 
	`w¬nšg
("stream: corrupt„tp…acket,"

180 
ext_Ën
);

184 
mb
->
pos
 = mb->po - 
ext_Ën
;

185 
mb
->
’d
 = 
ext_¡İ
;

187 
i
=0; i<
	`ARRAY_SIZE
(
extv
è&& 
	`mbuf_g‘_Ëá
(
mb
); i++) {

189 
”r
 = 
	`¹³xt_decode
(&
extv
[
i
], 
mb
);

190 ià(
”r
) {

191 
	`w¬nšg
("stream:„tpext_decode failed (%m)\n",

192 
”r
);

197 
extc
 = 
i
;

199 
mb
->
pos
 =…os;

200 
mb
->
’d
 =ƒnd;

203 
hªdËr
:

204 
s
->
	`¹ph
(
hdr
, 
extv
, 
extc
, 
mb
, s->
¬g
);

206 
	}
}

209 
	$¹p_hªdËr
(cÚ¡ 
§
 *
¤c
, cÚ¡ 
¹p_h—d”
 *
hdr
,

210 
mbuf
 *
mb
, *
¬g
)

212 
¡»am
 *
s
 = 
¬g
;

213 
boŞ
 
æush
 = 
çl£
;

214 
”r
;

216 
s
->
ts_Ï¡
 = 
	`tmr_jiff›s
();

218 ià(!
	`mbuf_g‘_Ëá
(
mb
))

221 ià(!(
	`sdp_medŸ_ldœ
(
s
->
sdp
è& 
SDP_RECVONLY
))

224 
	`m‘ric_add_·ck‘
(&
s
->
m‘ric_rx
, 
	`mbuf_g‘_Ëá
(
mb
));

226 ià(
hdr
->
s¤c
 !ğ
s
->
s¤c_rx
) {

227 ià(
s
->
s¤c_rx
) {

228 
æush
 = 
Œue
;

229 
	`šfo
("stream: %s: SSRC changed %x -> %x"

231 
	`sdp_medŸ_Çme
(
s
->
sdp
), s->
s¤c_rx
, 
hdr
->
s¤c
,

232 
	`mbuf_g‘_Ëá
(
mb
), 
¤c
);

234 
s
->
s¤c_rx
 = 
hdr
->
s¤c
;

237 ià(
s
->
jbuf
) {

239 
¹p_h—d”
 
hdr2
;

240 *
mb2
 = 
NULL
;

243 ià(
æush
)

244 
	`jbuf_æush
(
s
->
jbuf
);

246 
”r
 = 
	`jbuf_put
(
s
->
jbuf
, 
hdr
, 
mb
);

247 ià(
”r
) {

248 
	`šfo
("%s: dropping %u bytes from %J (%m)\n",

249 
	`sdp_medŸ_Çme
(
s
->
sdp
), 
mb
->
’d
,

250 
¤c
, 
”r
);

251 
s
->
m‘ric_rx
.
n_”r
++;

254 ià(
	`jbuf_g‘
(
s
->
jbuf
, &
hdr2
, &
mb2
)) {

256 ià(!
s
->
jbuf_¡¬‹d
)

259 
	`mem£t
(&
hdr2
, 0, (hdr2));

262 
s
->
jbuf_¡¬‹d
 = 
Œue
;

264 ià(
	`lo¡ÿlc
(
s
, 
hdr2
.
£q
) > 0)

265 
	`hªdË_¹p
(
s
, 
hdr
, 
NULL
);

267 
	`hªdË_¹p
(
s
, &
hdr2
, 
mb2
);

269 
	`mem_d”ef
(
mb2
);

272 ià(
	`lo¡ÿlc
(
s
, 
hdr
->
£q
) > 0)

273 
	`hªdË_¹p
(
s
, 
hdr
, 
NULL
);

275 
	`hªdË_¹p
(
s
, 
hdr
, 
mb
);

277 
	}
}

280 
	$¹ı_hªdËr
(cÚ¡ 
§
 *
¤c
, 
¹ı_msg
 *
msg
, *
¬g
)

282 
¡»am
 *
s
 = 
¬g
;

283 ()
¤c
;

285 
s
->
ts_Ï¡
 = 
	`tmr_jiff›s
();

287 ià(
s
->
¹ıh
)

288 
s
->
	`¹ıh
(
msg
, s->
¬g
);

290 
msg
->
hdr
.
±
) {

292 
RTCP_SR
:

293 ()
	`¹ı_¡©s
(
s
->
¹p
, 
msg
->
r
.
¤
.
s¤c
, &s->
¹ı_¡©s
);

295 ià(
s
->
cfg
.
¹p_¡©s
)

296 
	`ÿÎ_£t_x¹p¡©
(
s
->
ÿÎ
);

298 
	`ua_ev’t
(
	`ÿÎ_g‘_ua
(
s
->
ÿÎ
), 
UA_EVENT_CALL_RTCP
, s->call,

299 "%s", 
	`sdp_medŸ_Çme
(
	`¡»am_sdpmedŸ
(
s
)));

302 
	}
}

305 
	$¡»am_sock_®loc
(
¡»am
 *
s
, 
af
)

307 
§
 
Ïddr
;

308 
tos
, 
”r
;

310 ià(!
s
)

311  
EINVAL
;

314 
	`§_š™
(&
Ïddr
, 
af
);

316 
”r
 = 
	`¹p_li¡’
(&
s
->
¹p
, 
IPPROTO_UDP
, &
Ïddr
,

317 
s
->
cfg
.
¹p_pÜts
.
mš
, s->cfg.¹p_pÜts.
max
,

318 
s
->
¹ı
, 
¹p_hªdËr
, 
¹ı_hªdËr
, s);

319 ià(
”r
) {

320 
	`w¬nšg
("stream:„tp_listen failed:‡f=%s…orts=%u-%u"

321 " (%m)\n", 
	`Ãt_af2Çme
(
af
),

322 
s
->
cfg
.
¹p_pÜts
.
mš
, s->cfg.¹p_pÜts.
max
, 
”r
);

323  
”r
;

326 
tos
 = 
s
->
cfg
.
¹p_tos
;

327 ()
	`udp_£tsockİt
(
	`¹p_sock
(
s
->
¹p
), 
IPPROTO_IP
, 
IP_TOS
,

328 &
tos
, (tos));

329 ()
	`udp_£tsockİt
(
	`¹ı_sock
(
s
->
¹p
), 
IPPROTO_IP
, 
IP_TOS
,

330 &
tos
, (tos));

332 
	`udp_rxsz_£t
(
	`¹p_sock
(
s
->
¹p
), 
RTP_RECV_SIZE
);

335 
	}
}

338 
	$¡»am_®loc
(
¡»am
 **
¥
, cÚ¡ 
¡»am_·¿m
 *
´m
,

339 cÚ¡ 
cÚfig_avt
 *
cfg
,

340 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
,

341 cÚ¡ *
Çme
, 
Ïb–
,

342 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

343 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

344 cÚ¡ *
úame
,

345 
¡»am_¹p_h
 *
¹ph
, 
¡»am_¹ı_h
 *
¹ıh
, *
¬g
)

347 
¡»am
 *
s
;

348 
”r
;

350 ià(!
¥
 || !
´m
 || !
cfg
 || !
ÿÎ
 || !
¹ph
)

351  
EINVAL
;

353 
s
 = 
	`mem_z®loc
((*s), 
¡»am_de¡ruùÜ
);

354 ià(!
s
)

355  
ENOMEM
;

357 
s
->
cfg
 = *cfg;

358 
s
->
ÿÎ
 = call;

359 
s
->
¹ph
 =„tph;

360 
s
->
¹ıh
 =„tcph;

361 
s
->
¬g
 =‡rg;

362 
s
->
p£q
 = -1;

363 
s
->
¹ı
 = s->
cfg
.
¹ı_’abË
;

365 ià(
´m
->
u£_¹p
) {

366 
”r
 = 
	`¡»am_sock_®loc
(
s
, 
	`ÿÎ_af
(
ÿÎ
));

367 ià(
”r
) {

368 
	`w¬nšg
("stream: failedo create socket"

369 " fÜ medŸ '%s' (%m)\n", 
Çme
, 
”r
);

370 
out
;

374 
”r
 = 
	`¡r_dup
(&
s
->
úame
, cname);

375 ià(
”r
)

376 
out
;

379 ià(
cfg
->
jbuf_d–
.
mš
 && cfg->jbuf_d–.
max
) {

381 
”r
 = 
	`jbuf_®loc
(&
s
->
jbuf
, 
cfg
->
jbuf_d–
.
mš
,

382 
cfg
->
jbuf_d–
.
max
);

383 ià(
”r
)

384 
out
;

387 
”r
 = 
	`sdp_medŸ_add
(&
s
->
sdp
, 
sdp_£ss
, 
Çme
,

388 
s
->
¹p
 ? 
	`§_pÜt
(
	`¹p_loÿl
(s->rtp)) : 9,

389 (
m’c
 && m’c->
sdp_´Ùo
) ? menc->sdp_proto :

390 
sdp_´Ùo_¹·vp
);

391 ià(
”r
)

392 
out
;

394 ià(
Ïb–
) {

395 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
s
->
sdp
, 
Œue
,

396 "Ïb–", "%d", 
Ïb–
);

400 ià(
s
->
¹ı
)

401 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
s
->
sdp
, 
Œue
, "¹ı-rsize", 
NULL
);

404 ià(
s
->
¹ı
) {

405 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
s
->
sdp
, 
Œue
,

407 
	`¹p_£ss_s¤c
(
s
->
¹p
), 
úame
);

411 ià(
cfg
->
¹ı_mux
)

412 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
s
->
sdp
, 
Œue
, "¹ı-mux", 
NULL
);

414 ià(
”r
)

415 
out
;

417 ià(
mÇt
 && 
s
->
¹p
) {

418 
”r
 = 
mÇt
->
	`medŸh
(&
s
->
mns
, 
mÇt_£ss
, 
IPPROTO_UDP
,

419 
	`¹p_sock
(
s
->
¹p
),

420 
s
->
¹ı
 ? 
	`¹ı_sock
(s->
¹p
è: 
NULL
,

421 
s
->
sdp
);

422 ià(
”r
)

423 
out
;

426 ià(
m’c
 && 
s
->
¹p
) {

427 
s
->
m’c
 = menc;

428 
s
->
m’cs
 = 
	`mem_»f
(
m’c_£ss
);

429 
”r
 = 
m’c
->
	`medŸh
(&
s
->
mes
, 
m’c_£ss
,

430 
s
->
¹p
,

431 
IPPROTO_UDP
,

432 
	`¹p_sock
(
s
->
¹p
),

433 
s
->
¹ı
 ? 
	`¹ı_sock
(s->
¹p
è: 
NULL
,

434 
s
->
sdp
);

435 ià(
”r
)

436 
out
;

439 ià(
”r
)

440 
out
;

442 
s
->
±_’c
 = -1;

444 
	`m‘ric_š™
(&
s
->
m‘ric_tx
);

445 
	`m‘ric_š™
(&
s
->
m‘ric_rx
);

447 
	`li¡_­³nd
(
	`ÿÎ_¡»aml
(
ÿÎ
), &
s
->
Ë
, s);

449 
out
:

450 ià(
”r
)

451 
	`mem_d”ef
(
s
);

453 *
¥
 = 
s
;

455  
”r
;

456 
	}
}

459 
sdp_medŸ
 *
	$¡»am_sdpmedŸ
(cÚ¡ 
¡»am
 *
s
)

461  
s
 ? s->
sdp
 : 
NULL
;

462 
	}
}

465 
	$¡»am_¡¬t_k“·live
(
¡»am
 *
s
)

467 cÚ¡ *
¹pk“p
;

469 ià(!
s
)

472 
¹pk“p
 = 
	`ÿÎ_accouÁ
(
s
->
ÿÎ
)->rtpkeep;

474 
s
->
¹pk“p
 = 
	`mem_d”ef
(s->rtpkeep);

476 ià(
¹pk“p
 && 
	`sdp_medŸ_rfÜm©
(
s
->
sdp
, 
NULL
)) {

477 
”r
;

478 
”r
 = 
	`¹pk“p_®loc
(&
s
->
¹pk“p
,„tpkeep,

479 
IPPROTO_UDP
, 
s
->
¹p
, s->
sdp
);

480 ià(
”r
) {

481 
	`w¬nšg
("¡»am:„k“p_®loøçed: %m\n", 
”r
);

484 
	}
}

487 
	$¡»am_£nd
(
¡»am
 *
s
, 
boŞ
 
ext
, boŞ 
m¬k”
, 
±
, 
ušt32_t
 
ts
,

488 
mbuf
 *
mb
)

490 
”r
 = 0;

492 ià(!
s
)

493  
EINVAL
;

495 ià(!
	`§_is£t
(
	`sdp_medŸ_¿ddr
(
s
->
sdp
), 
SA_ALL
))

497 ià(
	`sdp_medŸ_dœ
(
s
->
sdp
è!ğ
SDP_SENDRECV
)

500 
	`m‘ric_add_·ck‘
(&
s
->
m‘ric_tx
, 
	`mbuf_g‘_Ëá
(
mb
));

502 ià(
±
 < 0)

503 
±
 = 
s
->
±_’c
;

505 ià(
±
 >= 0) {

506 
”r
 = 
	`¹p_£nd
(
s
->
¹p
, 
	`sdp_medŸ_¿ddr
(s->
sdp
), 
ext
,

507 
m¬k”
, 
±
, 
ts
, 
mb
);

508 ià(
”r
)

509 
s
->
m‘ric_tx
.
n_”r
++;

512 
	`¹pk“p_»äesh
(
s
->
¹pk“p
, 
ts
);

514  
”r
;

515 
	}
}

518 
	$¡»am_»mÙe_£t
(
¡»am
 *
s
)

520 
§
 
¹ı
;

522 ià(!
s
)

526 ià(
s
->
cfg
.
¹ı_mux
 && 
	`sdp_medŸ_¿‰r
(s->
sdp
, "rtcp-mux")) {

528 ià(!
s
->
¹ı_mux
)

529 
	`šfo
("%s: RTP/RTCP multiplexingƒnabled\n",

530 
	`sdp_medŸ_Çme
(
s
->
sdp
));

531 
s
->
¹ı_mux
 = 
Œue
;

534 
	`¹ı_’abË_mux
(
s
->
¹p
, s->
¹ı_mux
);

536 
	`sdp_medŸ_¿ddr_¹ı
(
s
->
sdp
, &
¹ı
);

538 
	`¹ı_¡¬t
(
s
->
¹p
, s->
úame
,

539 
s
->
¹ı_mux
 ? 
	`sdp_medŸ_¿ddr
(s->
sdp
): &
¹ı
);

540 
	}
}

543 
	$¡»am_upd©e
(
¡»am
 *
s
)

545 cÚ¡ 
sdp_fÜm©
 *
fmt
;

546 
”r
 = 0;

548 ià(!
s
)

551 
fmt
 = 
	`sdp_medŸ_rfÜm©
(
s
->
sdp
, 
NULL
);

553 
s
->
±_’c
 = 
fmt
 ? fmt->
±
 : -1;

555 ià(
	`sdp_medŸ_has_medŸ
(
s
->
sdp
))

556 
	`¡»am_»mÙe_£t
(
s
);

558 ià(
s
->
m’c
 && s->m’c->
medŸh
) {

559 
”r
 = 
s
->
m’c
->
	`medŸh
(&s->
mes
, s->
m’cs
, s->
¹p
,

560 
IPPROTO_UDP
,

561 
	`¹p_sock
(
s
->
¹p
),

562 
s
->
¹ı
 ? 
	`¹ı_sock
(s->
¹p
è: 
NULL
,

563 
s
->
sdp
);

564 ià(
”r
) {

565 
	`w¬nšg
("¡»am: medŸ’øupd©e: %m\n", 
”r
);

568 
	}
}

571 
	$¡»am_upd©e_’cod”
(
¡»am
 *
s
, 
±_’c
)

573 ià(!
s
)

576 ià(
±_’c
 >= 0)

577 
s
->
±_’c
 =…t_enc;

578 
	}
}

581 
	$¡»am_jbuf_¡©
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
)

583 
jbuf_¡©
 
¡©
;

584 
”r
;

586 ià(!
s
)

587  
EINVAL
;

589 
”r
 = 
	`»_h´štf
(
pf
, " %s:", 
	`sdp_medŸ_Çme
(
s
->
sdp
));

591 
”r
 |ğ
	`jbuf_¡©s
(
s
->
jbuf
, &
¡©
);

592 ià(
”r
) {

593 
”r
 = 
	`»_h´štf
(
pf
, "Jbuf stat: (not‡vailable)");

596 
”r
 = 
	`»_h´štf
(
pf
, "Jbuf stat:…ut=%u get=%u or=%u ur=%u",

597 
¡©
.
n_put
, st.
n_g‘
,

598 
¡©
.
n_ov”æow
, st.
n_und”æow
);

601  
”r
;

602 
	}
}

605 
	$¡»am_hŞd
(
¡»am
 *
s
, 
boŞ
 
hŞd
)

607 ià(!
s
)

610 
	`sdp_medŸ_£t_ldœ
(
s
->
sdp
, 
hŞd
 ? 
SDP_SENDONLY
 : 
SDP_SENDRECV
);

611 
	}
}

614 
	$¡»am_£t_¤©e
(
¡»am
 *
s
, 
ušt32_t
 
¤©e_tx
, ušt32_ˆ
¤©e_rx
)

616 ià(!
s
)

619 
	`¹ı_£t_¤©e
(
s
->
¹p
, 
¤©e_tx
, 
¤©e_rx
);

620 
	}
}

623 
	$¡»am_£nd_fœ
(
¡»am
 *
s
, 
boŞ
 
¶i
)

625 
”r
;

627 ià(!
s
)

630 ià(
¶i
)

631 
”r
 = 
	`¹ı_£nd_¶i
(
s
->
¹p
, s->
s¤c_rx
);

633 
”r
 = 
	`¹ı_£nd_fœ
(
s
->
¹p
, 
	`¹p_£ss_s¤c
(s->rtp));

635 ià(
”r
) {

636 
s
->
m‘ric_tx
.
n_”r
++;

638 
	`w¬nšg
("stream: failedo send RTCP %s: %m\n",

639 
¶i
 ? "PLI" : "FIR", 
”r
);

641 
	}
}

644 
	$¡»am_»£t
(
¡»am
 *
s
)

646 ià(!
s
)

649 
	`jbuf_æush
(
s
->
jbuf
);

651 
	`¡»am_¡¬t_k“·live
(
s
);

652 
	}
}

655 
	$¡»am_£t_bw
(
¡»am
 *
s
, 
ušt32_t
 
bps
)

657 ià(!
s
)

660 
	`sdp_medŸ_£t_lbªdwidth
(
s
->
sdp
, 
SDP_BANDWIDTH_AS
, 
bps
 / 1000);

661 
	}
}

664 
	$¡»am_’abË_¹p_timeout
(
¡»am
 *
¡rm
, 
ušt32_t
 
timeout_ms
)

666 ià(!
¡rm
)

669 
¡rm
->
¹p_timeout_ms
 = 
timeout_ms
;

671 
	`tmr_ÿnûl
(&
¡rm
->
tmr_¹p
);

673 ià(
timeout_ms
) {

675 
	`šfo
("stream: Enable RTPimeout (%u milliseconds)\n",

676 
timeout_ms
);

678 
¡rm
->
ts_Ï¡
 = 
	`tmr_jiff›s
();

679 
	`tmr_¡¬t
(&
¡rm
->
tmr_¹p
, 10, 
check_¹p_hªdËr
, strm);

681 
	}
}

684 
	$¡»am_£t_”rÜ_hªdËr
(
¡»am
 *
¡rm
,

685 
¡»am_”rÜ_h
 *
”rÜh
, *
¬g
)

687 ià(!
¡rm
)

690 
¡rm
->
”rÜh
 =ƒrrorh;

691 
¡rm
->
”rÜh_¬g
 = 
¬g
;

692 
	}
}

695 
	$¡»am_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
)

697 
§
 
¼tı
;

698 
”r
;

700 ià(!
s
)

703 
”r
 = 
	`»_h´štf
(
pf
, " % dœ=% ±_’c=%d\n", 
	`sdp_medŸ_Çme
(
s
->
sdp
),

704 
	`sdp_dœ_Çme
(
	`sdp_medŸ_dœ
(
s
->
sdp
)),

705 
s
->
±_’c
);

707 
	`sdp_medŸ_¿ddr_¹ı
(
s
->
sdp
, &
¼tı
);

708 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal: %J,„emote: %J/%J\n",

709 
	`sdp_medŸ_Ïddr
(
s
->
sdp
),

710 
	`sdp_medŸ_¿ddr
(
s
->
sdp
), &
¼tı
);

712 
”r
 |ğ
	`¹p_debug
(
pf
, 
s
->
¹p
);

713 
”r
 |ğ
	`jbuf_debug
(
pf
, 
s
->
jbuf
);

715  
”r
;

716 
	}
}

719 
	$¡»am_´št
(
»_´štf
 *
pf
, cÚ¡ 
¡»am
 *
s
)

721 ià(!
s
)

724  
	`»_h´štf
(
pf
, " %s=%u/%u", 
	`sdp_medŸ_Çme
(
s
->
sdp
),

725 
s
->
m‘ric_tx
.
cur_b™¿‹
,

726 
s
->
m‘ric_rx
.
cur_b™¿‹
);

727 
	}
}

730 cÚ¡ 
¹ı_¡©s
 *
	$¡»am_¹ı_¡©s
(cÚ¡ 
¡»am
 *
¡rm
)

732  
¡rm
 ? &¡rm->
¹ı_¡©s
 : 
NULL
;

733 
	}
}

	@baresip/src/ua.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

10 
	~<ùy³.h
>

14 
	#MAGIC
 0x0a0a0a0a

	)

15 
	~"magic.h
"

19 
	sua
 {

20 
MAGIC_DECL


21 
ua
 **
	mu­
;

22 
Ë
 
	mË
;

23 
accouÁ
 *
	macc
;

24 
li¡
 
	m»gl
;

25 
li¡
 
	mÿÎs
;

26 
¶
 
	mex‹nsiÚv
[8];

27 
size_t
 
	mex‹nsiÚc
;

28 *
	mcu£r
;

29 *
	mpub_gruu
;

30 
	maf
;

31 
	maf_medŸ
;

32 
´e£nû_¡©us
 
	mmy_¡©us
;

35 
	sua_eh
 {

36 
Ë
 
	mË
;

37 
ua_ev’t_h
 *
	mh
;

38 *
	m¬g
;

42 
cÚfig_s
 *
	mcfg
;

43 
li¡
 
	mu®
;

44 
li¡
 
	mehl
;

45 
s
 *
	ms
;

46 
s_l¢r
 *
	ml¢r
;

47 
s£ss_sock
 *
	msock
;

48 
sev’t_sock
 *
	mevsock
;

49 
ua
 *
	mua_cur
;

50 
boŞ
 
	mu£_udp
;

51 
boŞ
 
	mu£_tı
;

52 
boŞ
 
	mu£_s
;

53 
boŞ
 
	m´eãr_v6
;

54 
s_msg_h
 *
	msubh
;

55 
ua_ex™_h
 *
	mex™h
;

56 *
	m¬g
;

57 *
	m•rm
;

58 #ifdeà
USE_TLS


59 
s
 *
	ms
;

61 } 
	guag
 = {

62 
NULL
,

63 
LIST_INIT
,

64 
LIST_INIT
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NULL
,

70 
Œue
,

71 
Œue
,

72 
Œue
,

73 
çl£
,

74 
NULL
,

75 
NULL
,

76 
NULL
,

77 
NULL
,

78 #ifdeà
USE_TLS


79 
NULL
,

85 
ua_ÿÎ_®loc
(
ÿÎ
 **
ÿÎp
, 
ua
 *ua,

86 
vidmode
 vidmode, cÚ¡ 
s_msg
 *
msg
,

87 
ÿÎ
 *
xÿÎ
, cÚ¡ *
loÿl_uri
,

88 
boŞ
 
u£_¹p
);

92 
	$ex™_hªdËr
(*
¬g
)

94 ()
¬g
;

96 
	`ua_ev’t
(
NULL
, 
UA_EVENT_EXIT
, NULL, NULL);

98 
	`debug
("ua: sip-stackƒxit\n");

100 ià(
uag
.
ex™h
)

101 
uag
.
	`ex™h
(uag.
¬g
);

102 
	}
}

105 
	$ua_´štf
(cÚ¡ 
ua
 *ua, cÚ¡ *
fmt
, ...)

107 
va_li¡
 
­
;

109 ià(!
ua
)

112 
	`va_¡¬t
(
­
, 
fmt
);

113 
	`šfo
("%r@%r: %v", &
ua
->
acc
->
luri
.
u£r
, &ua->acc->luri.
ho¡
, 
fmt
, &
­
);

114 
	`va_’d
(
­
);

115 
	}
}

118 
	$ua_ev’t
(
ua
 *ua, 
ua_ev’t
 
ev
, 
ÿÎ
 *call,

119 cÚ¡ *
fmt
, ...)

121 
Ë
 *le;

122 
buf
[256];

123 
va_li¡
 
­
;

125 
	`va_¡¬t
(
­
, 
fmt
);

126 ()
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

127 
	`va_’d
(
­
);

130 
Ë
 = 
uag
.
ehl
.
h—d
;

131 
Ë
) {

132 
ua_eh
 *
eh
 = 
Ë
->
d©a
;

133 
Ë
 =†e->
Ãxt
;

135 
eh
->
	`h
(
ua
, 
ev
, 
ÿÎ
, 
buf
,ƒh->
¬g
);

137 
	}
}

147 
	$ua_»gi¡”
(
ua
 *ua)

149 
accouÁ
 *
acc
;

150 
Ë
 *le;

151 
uri
 uri;

152 *
»g_uri
 = 
NULL
;

153 
·¿ms
[256] = "";

154 
i
;

155 
”r
;

157 ià(!
ua
)

158  
EINVAL
;

160 
acc
 = 
ua
->acc;

161 
uri
 = 
ua
->
acc
->
luri
;

162 
uri
.
u£r
 = uri.
·sswÜd
 = 
¶_nuÎ
;

164 
”r
 = 
	`»_sd´štf
(&
»g_uri
, "%H", 
uri_’code
, &
uri
);

165 ià(
”r
)

166 
out
;

168 ià(
uag
.
cfg
 && 
	`¡r_is£t
(uag.cfg->
uuid
)) {

169 ià(
	`»_¢´štf
(
·¿ms
, (params),

171 
uag
.
cfg
->
uuid
) < 0) {

172 
”r
 = 
ENOMEM
;

173 
out
;

177 ià(
acc
->
»gq
) {

178 ià(
	`»_¢´štf
(&
·¿ms
[
	`¡¾’
(params)],

179 (
·¿ms
è- 
	`¡¾’
(params),

180 ";q=%s", 
acc
->
»gq
) < 0) {

181 
”r
 = 
ENOMEM
;

182 
out
;

186 ià(
acc
->
mÇt
 &&‡cc->mÇt->
áag
) {

187 ià(
	`»_¢´štf
(&
·¿ms
[
	`¡¾’
(params)],

188 (
·¿ms
è- 
	`¡¾’
(params),

189 ";%s", 
acc
->
mÇt
->
áag
) < 0) {

190 
”r
 = 
ENOMEM
;

191 
out
;

195 
	`ua_ev’t
(
ua
, 
UA_EVENT_REGISTERING
, 
NULL
, NULL);

197 
Ë
 = 
ua
->
»gl
.
h—d
, 
i
=0;†e;†ğË->
Ãxt
, i++) {

198 
»g
 *»g = 
Ë
->
d©a
;

200 
”r
 = 
	`»g_»gi¡”
(
»g
, 
»g_uri
, 
·¿ms
,

201 
acc
->
»gšt
,‡cc->
outboundv
[
i
]);

202 ià(
”r
) {

203 
	`w¬nšg
("ua: SIP„egi¡” faed: %m\n", 
”r
);

204 
out
;

208 
out
:

209 
	`mem_d”ef
(
»g_uri
);

211  
”r
;

212 
	}
}

220 
	$ua_uÄegi¡”
(
ua
 *ua)

222 
Ë
 *le;

224 ià(!
ua
)

227 ià(!
	`li¡_i£m±y
(&
ua
->
»gl
))

228 
	`ua_ev’t
(
ua
, 
UA_EVENT_UNREGISTERING
, 
NULL
, NULL);

230 
Ë
 = 
ua
->
»gl
.
h—d
;†e;†ğË->
Ãxt
) {

231 
»g
 *»g = 
Ë
->
d©a
;

233 
	`»g_uÄegi¡”
(
»g
);

235 
	}
}

238 
boŞ
 
	$ua_i¤egi¡”ed
(cÚ¡ 
ua
 *ua)

240 
Ë
 *le;

242 ià(!
ua
)

243  
çl£
;

245 
Ë
 = 
ua
->
»gl
.
h—d
;†e;†ğË->
Ãxt
) {

247 cÚ¡ 
»g
 *»g = 
Ë
->
d©a
;

250 ià(
	`»g_isok
(
»g
))

251  
Œue
;

254  
çl£
;

255 
	}
}

258 
ÿÎ
 *
	$ua_fšd_ÿÎ_ÚhŞd
(cÚ¡ 
ua
 *ua)

260 
Ë
 *le;

262 ià(!
ua
)

263  
NULL
;

265 
Ë
 = 
ua
->
ÿÎs
.

;†e;†ğË->
´ev
) {

267 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

269 ià(
	`ÿÎ_is_ÚhŞd
(
ÿÎ
))

270  
ÿÎ
;

273  
NULL
;

274 
	}
}

277 
	$»sume_ÿÎ
(
ua
 *ua)

279 
ÿÎ
 *call;

281 
ÿÎ
 = 
	`ua_fšd_ÿÎ_ÚhŞd
(
ua
);

282 ià(
ÿÎ
) {

283 
	`ua_´štf
(
ua
, "resuming…revious call with '%s'\n",

284 
	`ÿÎ_³”uri
(
ÿÎ
));

285 
	`ÿÎ_hŞd
(
ÿÎ
, 
çl£
);

287 
	}
}

290 
	$ÿÎ_ev’t_hªdËr
(
ÿÎ
 *ÿÎ, 
ÿÎ_ev’t
 
ev
,

291 cÚ¡ *
¡r
, *
¬g
)

293 
ua
 *u¨ğ
¬g
;

294 cÚ¡ *
³”uri
;

295 
ÿÎ
 *
ÿÎ2
 = 
NULL
;

296 
”r
;

298 
	`MAGIC_CHECK
(
ua
);

300 
³”uri
 = 
	`ÿÎ_³”uri
(
ÿÎ
);

302 
ev
) {

304 
CALL_EVENT_INCOMING
:

306 ià(
	`cÚù_block_acûss
(
	`b¬es_cÚùs
(),

307 
³”uri
)) {

309 
	`šfo
("ua: blocked‡cûss: \"%s\"\n", 
³”uri
);

311 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_CLOSED
, 
ÿÎ
, 
¡r
);

312 
	`mem_d”ef
(
ÿÎ
);

316 
ua
->
acc
->
ªsw”mode
) {

318 
ANSWERMODE_EARLY
:

319 ()
	`ÿÎ_´og»ss
(
ÿÎ
);

322 
ANSWERMODE_AUTO
:

323 ()
	`ÿÎ_ªsw”
(
ÿÎ
, 200);

326 
ANSWERMODE_MANUAL
:

328 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_INCOMING
, 
ÿÎ
, 
³”uri
);

333 
CALL_EVENT_RINGING
:

334 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_RINGING
, 
ÿÎ
, 
³”uri
);

337 
CALL_EVENT_PROGRESS
:

338 
	`ua_´štf
(
ua
, "C®Èš-´og»ss: %s\n", 
³”uri
);

339 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_PROGRESS
, 
ÿÎ
, 
³”uri
);

342 
CALL_EVENT_ESTABLISHED
:

343 
	`ua_´štf
(
ua
, "C®Èe¡ablished: %s\n", 
³”uri
);

344 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_ESTABLISHED
, 
ÿÎ
, 
³”uri
);

347 
CALL_EVENT_CLOSED
:

348 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_CLOSED
, 
ÿÎ
, 
¡r
);

349 
	`mem_d”ef
(
ÿÎ
);

351 
	`»sume_ÿÎ
(
ua
);

354 
CALL_EVENT_TRANSFER
:

363 
	`ua_´štf
(
ua
, "Œªsã¼šg c®ÈtØ%s\n", 
¡r
);

365 
”r
 = 
	`ua_ÿÎ_®loc
(&
ÿÎ2
, 
ua
, 
VIDMODE_ON
, 
NULL
, 
ÿÎ
,

366 
	`ÿÎ_loÿluri
(
ÿÎ
), 
Œue
);

367 ià(!
”r
) {

368 
¶
…l;

370 
	`¶_£t_¡r
(&
¶
, 
¡r
);

372 
”r
 = 
	`ÿÎ_cÚÃù
(
ÿÎ2
, &
¶
);

373 ià(
”r
) {

374 
	`w¬nšg
("ua:ransfer: connectƒrror: %m\n",

375 
”r
);

379 ià(
”r
) {

380 ()
	`ÿÎ_nÙify_säag
(
ÿÎ
, 500, "Call Error");

381 
	`mem_d”ef
(
ÿÎ2
);

385 
CALL_EVENT_TRANSFER_FAILED
:

386 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_TRANSFER_FAILED
, 
ÿÎ
, 
¡r
);

389 
	}
}

392 
	$ÿÎ_dtmf_hªdËr
(
ÿÎ
 *ÿÎ, 
key
, *
¬g
)

394 
ua
 *u¨ğ
¬g
;

395 
key_¡r
[2];

397 
	`MAGIC_CHECK
(
ua
);

399 ià(
key
 != '\0') {

401 
key_¡r
[0] = 
key
;

402 
key_¡r
[1] = '\0';

404 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_DTMF_START
, 
ÿÎ
, 
key_¡r
);

407 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_DTMF_END
, 
ÿÎ
, 
NULL
);

409 
	}
}

412 
	$ua_ÿÎ_®loc
(
ÿÎ
 **
ÿÎp
, 
ua
 *ua,

413 
vidmode
 vidmode, cÚ¡ 
s_msg
 *
msg
,

414 
ÿÎ
 *
xÿÎ
, cÚ¡ *
loÿl_uri
,

415 
boŞ
 
u£_¹p
)

417 cÚ¡ 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

418 
ÿÎ_´m
 
ırm
;

419 
af
 = 
AF_UNSPEC
;

420 
”r
;

422 ià(*
ÿÎp
) {

423 
	`w¬nšg
("ua: call_alloc: call is‡lready‡llocated\n");

424  
EALREADY
;

430 ià(
ua
->
af_medŸ
) {

431 
af
 = 
ua
->
af_medŸ
;

433 ià(
ua
->
af
) {

434 
af
 = 
ua
->af;

437 
	`mem£t
(&
ırm
, 0, (cprm));

439 
	`§_ıy
(&
ırm
.
Ïddr
, 
	`Ãt_Ïddr_af
(
Ãt
, 
af
));

440 
ırm
.
vidmode
 = vidmode;

441 
ırm
.
af
 =‡f;

442 
ırm
.
u£_¹p
 = use_rtp;

444 
”r
 = 
	`ÿÎ_®loc
(
ÿÎp
, 
	`cÚf_cÚfig
(), &
ua
->
ÿÎs
,

445 
ua
->
acc
->
di¥Çme
,

446 
loÿl_uri
 ?†oÿl_ur˜: 
ua
->
acc
->
aÜ
,

447 
ua
->
acc
, ua, &
ırm
,

448 
msg
, 
xÿÎ
,

449 
	`Ãt_dnsc
(
Ãt
),

450 
ÿÎ_ev’t_hªdËr
, 
ua
);

451 ià(
”r
)

452  
”r
;

454 
	`ÿÎ_£t_hªdËrs
(*
ÿÎp
, 
NULL
, 
ÿÎ_dtmf_hªdËr
, 
ua
);

457 
	}
}

460 
	$hªdË_İtiÚs
(
ua
 *ua, cÚ¡ 
s_msg
 *
msg
)

462 
s_cÚù
 
cÚù
;

463 
ÿÎ
 *ÿÎ = 
NULL
;

464 
mbuf
 *
desc
 = 
NULL
;

465 cÚ¡ 
s_hdr
 *
hdr
;

466 
boŞ
 
acû±_sdp
 = 
Œue
;

467 
”r
;

469 
	`debug
("ua: incoming OPTIONS message from %r (%J)\n",

470 &
msg
->
äom
.
auri
, &msg->
¤c
);

474 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_ACCEPT
);

475 ià(
hdr
) {

476 
acû±_sdp
 = 0==
	`¶_¡rÿ£cmp
(&
hdr
->
v®
, "application/sdp");

479 ià(
acû±_sdp
) {

481 
”r
 = 
	`ua_ÿÎ_®loc
(&
ÿÎ
, 
ua
, 
VIDMODE_ON
, 
NULL
, NULL, NULL,

482 
çl£
);

483 ià(
”r
) {

484 ()
	`s_Œ•ly
(
NULL
, 
uag
.
s
, 
msg
,

489 
”r
 = 
	`ÿÎ_sdp_g‘
(
ÿÎ
, &
desc
, 
Œue
);

490 ià(
”r
)

491 
out
;

494 
	`s_cÚù_£t
(&
cÚù
, 
	`ua_cu£r
(
ua
), &
msg
->
d¡
, msg->

);

496 
”r
 = 
	`s_Œ•lyf
(
NULL
, NULL, 
uag
.
s
,

497 
msg
, 
Œue
, 200, "OK",

505 
	`uag_®lowed_m‘hods
(),

506 
ua_´št_suµÜ‹d
, 
ua
,

507 
s_cÚù_´št
, &
cÚù
,

508 
desc
 ? "Content-Type:‡pplication/sdp\r\n" : "",

509 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0,

510 
desc
 ? 
	`mbuf_buf
(descè: 
NULL
,

511 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0);

512 ià(
”r
) {

513 
	`w¬nšg
("ua: o±iÚs: s_Œ•lyf: %m\n", 
”r
);

516 
out
:

517 
	`mem_d”ef
(
desc
);

518 
	`mem_d”ef
(
ÿÎ
);

519 
	}
}

522 
	$ua_de¡ruùÜ
(*
¬g
)

524 
ua
 *u¨ğ
¬g
;

526 ià(
ua
->
u­
) {

527 *
ua
->
u­
 = 
NULL
;

528 
ua
->
u­
 = 
NULL
;

531 
	`li¡_uÆšk
(&
ua
->
Ë
);

533 ià(!
	`li¡_i£m±y
(&
ua
->
»gl
))

534 
	`ua_ev’t
(
ua
, 
UA_EVENT_UNREGISTERING
, 
NULL
, NULL);

536 
	`li¡_æush
(&
ua
->
ÿÎs
);

537 
	`li¡_æush
(&
ua
->
»gl
);

538 
	`mem_d”ef
(
ua
->
cu£r
);

539 
	`mem_d”ef
(
ua
->
pub_gruu
);

540 
	`mem_d”ef
(
ua
->
acc
);

542 ià(
	`li¡_i£m±y
(&
uag
.
u®
)) {

543 
	`s_şo£
(
uag
.
s
, 
çl£
);

545 
	}
}

548 
boŞ
 
	$»que¡_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

550 
ua
 *ua;

552 ()
¬g
;

554 ià(
	`¶_¡rcmp
(&
msg
->
m‘
, "OPTIONS"))

555  
çl£
;

557 
ua
 = 
	`uag_fšd
(&
msg
->
uri
.
u£r
);

558 ià(!
ua
) {

559 ()
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
, 404, "Not Found");

560  
Œue
;

563 
	`hªdË_İtiÚs
(
ua
, 
msg
);

565  
Œue
;

566 
	}
}

569 
	$add_ex‹nsiÚ
(
ua
 *ua, cÚ¡ *
ex‹nsiÚ
)

571 
¶
 
e
;

573 ià(
ua
->
ex‹nsiÚc
 >ğ
	`ARRAY_SIZE
(ua->
ex‹nsiÚv
)) {

574 
	`w¬nšg
("ua: maximum %u‚umber of SIPƒxtensions\n");

578 
	`¶_£t_¡r
(&
e
, 
ex‹nsiÚ
);

580 
ua
->
ex‹nsiÚv
[ua->
ex‹nsiÚc
++] = 
e
;

581 
	}
}

592 
	$ua_®loc
(
ua
 **
u­
, cÚ¡ *
aÜ
)

594 
ua
 *ua;

595 *
buf
 = 
NULL
;

596 
”r
;

598 ià(!
aÜ
)

599  
EINVAL
;

601 
ua
 = 
	`mem_z®loc
((*ua), 
ua_de¡ruùÜ
);

602 ià(!
ua
)

603  
ENOMEM
;

605 
	`MAGIC_INIT
(
ua
);

607 
	`li¡_š™
(&
ua
->
ÿÎs
);

609 #ià
HAVE_INET6


610 
ua
->
af
 = 
uag
.
´eãr_v6
 ? 
AF_INET6
 : 
AF_INET
;

612 
ua
->
af
 = 
AF_INET
;

616 ià(
uag
.
•rm
) {

617 
”r
 = 
	`»_sd´štf
(&
buf
, "%s;%s", 
aÜ
, 
uag
.
•rm
);

618 ià(
”r
)

619 
out
;

620 
aÜ
 = 
buf
;

623 
”r
 = 
	`accouÁ_®loc
(&
ua
->
acc
, 
aÜ
);

624 ià(
”r
)

625 
out
;

629 
”r
 = 
	`»_sd´štf
(&
ua
->
cu£r
, "%r-%p", &ua->
acc
->
luri
.
u£r
, ua);

630 ià(
”r
)

631 
out
;

633 ià(
ua
->
acc
->
sÇt
) {

634 
	`ua_´štf
(
ua
, "Usšg sÇt: `%s'\n", ua->
acc
->
sÇt
);

637 ià(
ua
->
acc
->
mÇt
) {

638 
	`ua_´štf
(
ua
, "Using medianat `%s'\n",

639 
ua
->
acc
->
mÇt
->
id
);

641 ià(0 =ğ
	`¡r_ÿ£cmp
(
ua
->
acc
->
mÇt
->
id
, "ice"))

642 
	`add_ex‹nsiÚ
(
ua
, "ice");

645 ià(
ua
->
acc
->
m’c
) {

646 
	`ua_´štf
(
ua
, "Using mediaƒncryption `%s'\n",

647 
ua
->
acc
->
m’c
->
id
);

651 ià(
uag
.
cfg
 && 
	`¡r_is£t
(uag.cfg->
uuid
))

652 
	`add_ex‹nsiÚ
(
ua
, "gruu");

654 ià(0 =ğ
	`¡r_ÿ£cmp
(
ua
->
acc
->
sÇt
, "outbound")) {

656 
size_t
 
i
;

658 
	`add_ex‹nsiÚ
(
ua
, "path");

659 
	`add_ex‹nsiÚ
(
ua
, "outbound");

661 ià(!
	`¡r_is£t
(
uag
.
cfg
->
uuid
)) {

663 
	`w¬nšg
("ua: outbound„equires valid UUID!\n");

664 
”r
 = 
ENOSYS
;

665 
out
;

668 
i
=0; i<
	`ARRAY_SIZE
(
ua
->
acc
->
outboundv
); i++) {

670 ià(
ua
->
acc
->
outboundv
[
i
] && ua->acc->
»gšt
) {

671 
”r
 = 
	`»g_add
(&
ua
->
»gl
, ua, ()
i
+1);

672 ià(
”r
)

677 ià(
ua
->
acc
->
»gšt
) {

678 
”r
 = 
	`»g_add
(&
ua
->
»gl
, ua, 0);

680 ià(
”r
)

681 
out
;

683 
	`li¡_­³nd
(&
uag
.
u®
, &
ua
->
Ë
, ua);

685 ià(
ua
->
acc
->
»gšt
) {

686 
”r
 = 
	`ua_»gi¡”
(
ua
);

689 ià(!
	`uag_cu¼’t
())

690 
	`uag_cu¼’t_£t
(
ua
);

692 
out
:

693 
	`mem_d”ef
(
buf
);

694 ià(
”r
)

695 
	`mem_d”ef
(
ua
);

696 ià(
u­
) {

697 *
u­
 = 
ua
;

699 
ua
->
u­
 = uap;

702  
”r
;

703 
	}
}

706 
	$uri_com¶‘e
(
ua
 *ua, 
mbuf
 *
buf
, cÚ¡ *
uri
)

708 
size_t
 
Ën
;

709 
”r
 = 0;

712 
	`is¥aû
(*
uri
))

713 ++
uri
;

715 
Ën
 = 
	`¡r_Ën
(
uri
);

718 ià(0 !ğ
	`»_»gex
(
uri
, 
Ën
, "sip:"))

719 
”r
 |ğ
	`mbuf_´štf
(
buf
, "sip:");

721 
”r
 |ğ
	`mbuf_wr™e_¡r
(
buf
, 
uri
);

724 ià(0 !ğ
	`»_»gex
(
uri
, 
Ën
, "[^@]+@[^]+", 
NULL
, NULL)) {

725 #ià
HAVE_INET6


726 ià(
AF_INET6
 =ğ
ua
->
acc
->
luri
.
af
)

727 
”r
 |ğ
	`mbuf_´štf
(
buf
, "@[%r]",

728 &
ua
->
acc
->
luri
.
ho¡
);

731 
”r
 |ğ
	`mbuf_´štf
(
buf
, "@%r",

732 &
ua
->
acc
->
luri
.
ho¡
);

735 
ua
->
acc
->
luri
.
pÜt
) {

738 
SIP_PORT
:

742 
”r
 |ğ
	`mbuf_´štf
(
buf
, ":%u", 
ua
->
acc
->
luri
.
pÜt
);

747  
”r
;

748 
	}
}

763 
	$ua_cÚÃù
(
ua
 *ua, 
ÿÎ
 **
ÿÎp
,

764 cÚ¡ *
äom_uri
, cÚ¡ *
uri
,

765 cÚ¡ *
·¿ms
, 
vidmode
 
vmode
)

767 
ÿÎ
 *ÿÎ = 
NULL
;

768 
mbuf
 *
dŸlbuf
;

769 
¶
…l;

770 
”r
 = 0;

772 ià(!
ua
 || !
	`¡r_is£t
(
uri
))

773  
EINVAL
;

775 
dŸlbuf
 = 
	`mbuf_®loc
(64);

776 ià(!
dŸlbuf
)

777  
ENOMEM
;

779 ià(
·¿ms
)

780 
”r
 |ğ
	`mbuf_´štf
(
dŸlbuf
, "<");

782 
”r
 |ğ
	`uri_com¶‘e
(
ua
, 
dŸlbuf
, 
uri
);

784 ià(
·¿ms
) {

785 
”r
 |ğ
	`mbuf_´štf
(
dŸlbuf
, ";%s", 
·¿ms
);

789 
”r
 |ğ
	`mbuf_wr™e_¶
(
dŸlbuf
, &
ua
->
acc
->
luri
.
·¿ms
);

791 ià(
·¿ms
)

792 
”r
 |ğ
	`mbuf_´štf
(
dŸlbuf
, ">");

794 ià(
”r
)

795 
out
;

797 
”r
 = 
	`ua_ÿÎ_®loc
(&
ÿÎ
, 
ua
, 
vmode
, 
NULL
, NULL, 
äom_uri
, 
Œue
);

798 ià(
”r
)

799 
out
;

801 
¶
.
p
 = (*)
dŸlbuf
->
buf
;

802 
¶
.
l
 = 
dŸlbuf
->
’d
;

804 
”r
 = 
	`ÿÎ_cÚÃù
(
ÿÎ
, &
¶
);

806 ià(
”r
)

807 
	`mem_d”ef
(
ÿÎ
);

808 ià(
ÿÎp
)

809 *
ÿÎp
 = 
ÿÎ
;

811 
out
:

812 
	`mem_d”ef
(
dŸlbuf
);

814  
”r
;

815 
	}
}

826 
	$ua_hªgup
(
ua
 *ua, 
ÿÎ
 *call,

827 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

829 ià(!
ua
)

832 ià(!
ÿÎ
) {

833 
ÿÎ
 = 
	`ua_ÿÎ
(
ua
);

834 ià(!
ÿÎ
)

838 ()
	`ÿÎ_hªgup
(
ÿÎ
, 
scode
, 
»asÚ
);

840 
	`ua_ev’t
(
ua
, 
UA_EVENT_CALL_CLOSED
, 
ÿÎ
, 
»asÚ
);

842 
	`mem_d”ef
(
ÿÎ
);

844 
	`»sume_ÿÎ
(
ua
);

845 
	}
}

856 
	$ua_ªsw”
(
ua
 *ua, 
ÿÎ
 *call)

858 ià(!
ua
)

859  
EINVAL
;

861 ià(!
ÿÎ
) {

862 
ÿÎ
 = 
	`ua_ÿÎ
(
ua
);

863 ià(!
ÿÎ
)

864  
ENOENT
;

867  
	`ÿÎ_ªsw”
(
ÿÎ
, 200);

868 
	}
}

871 
	$ua_´og»ss
(
ua
 *ua, 
ÿÎ
 *call)

873 ià(!
ua
)

874  
EINVAL
;

876 ià(!
ÿÎ
) {

877 
ÿÎ
 = 
	`ua_ÿÎ
(
ua
);

878 ià(!
ÿÎ
)

879  
ENOENT
;

882  
	`ÿÎ_´og»ss
(
ÿÎ
);

883 
	}
}

894 
	$ua_hŞd_ªsw”
(
ua
 *ua, 
ÿÎ
 *call)

896 
ÿÎ
 *
pÿÎ
;

897 
”r
;

899 ià(!
ua
)

900  
EINVAL
;

902 ià(!
ÿÎ
) {

903 
ÿÎ
 = 
	`ua_ÿÎ
(
ua
);

904 ià(!
ÿÎ
)

905  
ENOENT
;

909 
pÿÎ
 = 
	`ua_´ev_ÿÎ
(
ua
);

910 ià(
pÿÎ
) {

911 
	`ua_´štf
(
ua
, "putting call with '%s' on hold\n",

912 
	`ÿÎ_³”uri
(
pÿÎ
));

914 
”r
 = 
	`ÿÎ_hŞd
(
pÿÎ
, 
Œue
);

915 ià(
”r
)

916  
”r
;

919  
	`ua_ªsw”
(
ua
, 
ÿÎ
);

920 
	}
}

923 
	$ua_´št_¡©us
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua)

925 
Ë
 *le;

926 
”r
;

928 ià(!
ua
)

931 
”r
 = 
	`»_h´štf
(
pf
, "%-42s", 
ua
->
acc
->
aÜ
);

933 
Ë
 = 
ua
->
»gl
.
h—d
;†e;†ğË->
Ãxt
)

934 
”r
 |ğ
	`»g_¡©us
(
pf
, 
Ë
->
d©a
);

936 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

938  
”r
;

939 
	}
}

952 
	$ua_İtiÚs_£nd
(
ua
 *ua, cÚ¡ *
uri
,

953 
İtiÚs_»¥_h
 *
»¥h
, *
¬g
)

955 
mbuf
 *
dŸlbuf
;

956 
”r
 = 0;

958 ià(!
ua
 || !
	`¡r_is£t
(
uri
))

959  
EINVAL
;

961 
dŸlbuf
 = 
	`mbuf_®loc
(64);

962 ià(!
dŸlbuf
)

963  
ENOMEM
;

965 
”r
 = 
	`uri_com¶‘e
(
ua
, 
dŸlbuf
, 
uri
);

966 ià(
”r
)

967 
out
;

969 
dŸlbuf
->
buf
[dŸlbuf->
’d
] = '\0';

971 
”r
 = 
	`s_»q_£nd
(
ua
, "OPTIONS", (*)
dŸlbuf
->
buf
, 
»¥h
, 
¬g
,

975 ià(
”r
) {

976 
	`w¬nšg
("ua: s’d o±iÚs: (%m)\n", 
”r
);

979 
out
:

980 
	`mem_d”ef
(
dŸlbuf
);

982  
”r
;

983 
	}
}

993 cÚ¡ *
	$ua_aÜ
(cÚ¡ 
ua
 *ua)

995  
ua
 ? 
	`accouÁ_aÜ
(ua->
acc
è: 
NULL
;

996 
	}
}

1006 
´e£nû_¡©us
 
	$ua_´e£nû_¡©us
(cÚ¡ 
ua
 *ua)

1008  
ua
 ? ua->
my_¡©us
 : 
PRESENCE_UNKNOWN
;

1009 
	}
}

1018 
	$ua_´e£nû_¡©us_£t
(
ua
 *ua, cÚ¡ 
´e£nû_¡©us
 
¡©us
)

1020 ià(!
ua
)

1023 
ua
->
my_¡©us
 = 
¡©us
;

1024 
	}
}

1034 cÚ¡ *
	$ua_outbound
(cÚ¡ 
ua
 *ua)

1037  
ua
 ? ua->
acc
->
outboundv
[0] : 
NULL
;

1038 
	}
}

1054 
ÿÎ
 *
	$ua_ÿÎ
(cÚ¡ 
ua
 *ua)

1056 ià(!
ua
)

1057  
NULL
;

1059  
	`li¡_Ëd©a
(
	`li¡_
(&
ua
->
ÿÎs
));

1060 
	}
}

1063 
ÿÎ
 *
	$ua_´ev_ÿÎ
(cÚ¡ 
ua
 *ua)

1065 
Ë
 *le;

1066 
´ev
 = 0;

1068 ià(!
ua
)

1069  
NULL
;

1071 
Ë
 = 
ua
->
ÿÎs
.

;†e;†ğË->
´ev
) {

1072 iàĞ
´ev
 == 1) {

1073 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

1074  
ÿÎ
;

1076 iàĞ
´ev
 == 0)

1077 
´ev
 = 1;

1080  
NULL
;

1081 
	}
}

1084 
	$ua_debug
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua)

1086 
Ë
 *le;

1087 
”r
;

1089 ià(!
ua
)

1092 
”r
 = 
	`»_h´štf
(
pf
, "--- % ---\n", 
ua
->
acc
->
aÜ
);

1093 
”r
 |ğ
	`»_h´štf
(
pf
, "‚»fs: %u\n", 
	`mem_Äefs
(
ua
));

1094 
”r
 |ğ
	`»_h´štf
(
pf
, " cu£r: %s\n", 
ua
->
cu£r
);

1095 
”r
 |ğ
	`»_h´štf
(
pf
, "…ub-gruu: %s\n", 
ua
->
pub_gruu
);

1096 
”r
 |ğ
	`»_h´štf
(
pf
, "‡f: %s\n", 
	`Ãt_af2Çme
(
ua
->
af
));

1097 
”r
 |ğ
	`»_h´štf
(
pf
, " %H", 
ua_´št_suµÜ‹d
, 
ua
);

1099 
”r
 |ğ
	`accouÁ_debug
(
pf
, 
ua
->
acc
);

1101 
Ë
 = 
ua
->
»gl
.
h—d
;†e;†ğË->
Ãxt
)

1102 
”r
 |ğ
	`»g_debug
(
pf
, 
Ë
->
d©a
);

1104  
”r
;

1105 
	}
}

1111 
	$add_Œª¥_af
(cÚ¡ 
§
 *
Ïddr
)

1113 
§
 
loÿl
;

1114 
”r
 = 0;

1116 ià(
	`¡r_is£t
(
uag
.
cfg
->
loÿl
)) {

1117 
”r
 = 
	`§_decode
(&
loÿl
, 
uag
.
cfg
->local,

1118 
	`¡r_Ën
(
uag
.
cfg
->
loÿl
));

1119 ià(
”r
) {

1120 
”r
 = 
	`§_£t_¡r
(&
loÿl
, 
uag
.
cfg
->local, 0);

1121 ià(
”r
) {

1122 
	`w¬nšg
("ua: decode failed: '%s'\n",

1123 
uag
.
cfg
->
loÿl
);

1124  
”r
;

1128 ià(!
	`§_is£t
(&
loÿl
, 
SA_ADDR
)) {

1129 
ušt16_t
 
pÜt
 = 
	`§_pÜt
(&
loÿl
);

1130 ()
	`§_£t_§
(&
loÿl
, &
Ïddr
->
u
.
§
);

1131 
	`§_£t_pÜt
(&
loÿl
, 
pÜt
);

1134 ià(
	`§_af
(
Ïddr
è!ğ§_af(&
loÿl
))

1138 
	`§_ıy
(&
loÿl
, 
Ïddr
);

1139 
	`§_£t_pÜt
(&
loÿl
, 0);

1142 ià(
uag
.
u£_udp
)

1143 
”r
 |ğ
	`s_Œª¥_add
(
uag
.
s
, 
SIP_TRANSP_UDP
, &
loÿl
);

1144 ià(
uag
.
u£_tı
)

1145 
”r
 |ğ
	`s_Œª¥_add
(
uag
.
s
, 
SIP_TRANSP_TCP
, &
loÿl
);

1146 ià(
”r
) {

1147 
	`w¬nšg
("ua: SIP T¿n¥Üˆçed: %m\n", 
”r
);

1148  
”r
;

1151 #ifdeà
USE_TLS


1152 ià(
uag
.
u£_s
) {

1154 ià(!
uag
.
s
) {

1155 cÚ¡ *
û¹
 = 
NULL
;

1157 ià(
	`¡r_is£t
(
uag
.
cfg
->
û¹
)) {

1158 
û¹
 = 
uag
.
cfg
->cert;

1159 
	`šfo
("SIP C”tifiÿ‹: %s\n", 
û¹
);

1162 
”r
 = 
	`s_®loc
(&
uag
.
s
, 
TLS_METHOD_SSLV23
,

1163 
û¹
, 
NULL
);

1164 ià(
”r
) {

1165 
	`w¬nšg
("ua:ls_®loc(èçed: %m\n", 
”r
);

1166  
”r
;

1170 ià(
	`§_is£t
(&
loÿl
, 
SA_PORT
))

1171 
	`§_£t_pÜt
(&
loÿl
, 
	`§_pÜt
(&local) + 1);

1173 
”r
 = 
	`s_Œª¥_add
(
uag
.
s
, 
SIP_TRANSP_TLS
, &
loÿl
, uag.
s
);

1174 ià(
”r
) {

1175 
	`w¬nšg
("ua: SIP/TLS¿n¥Üˆçed: %m\n", 
”r
);

1176  
”r
;

1181  
”r
;

1182 
	}
}

1185 
	$ua_add_Œª¥
(
ÃtwÜk
 *
Ãt
)

1187 
”r
 = 0;

1189 ià(!
uag
.
´eãr_v6
) {

1190 ià(
	`§_is£t
(
	`Ãt_Ïddr_af
(
Ãt
, 
AF_INET
), 
SA_ADDR
))

1191 
”r
 |ğ
	`add_Œª¥_af
(
	`Ãt_Ïddr_af
(
Ãt
, 
AF_INET
));

1194 #ià
HAVE_INET6


1195 ià(
	`§_is£t
(
	`Ãt_Ïddr_af
(
Ãt
, 
AF_INET6
), 
SA_ADDR
))

1196 
”r
 |ğ
	`add_Œª¥_af
(
	`Ãt_Ïddr_af
(
Ãt
, 
AF_INET6
));

1199  
”r
;

1200 
	}
}

1203 
boŞ
 
	$»quœe_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
,

1204 cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1206 
ua
 *u¨ğ
¬g
;

1207 
boŞ
 
suµÜ‹d
 = 
çl£
;

1208 
size_t
 
i
;

1209 ()
msg
;

1211 
i
=0; i<
ua
->
ex‹nsiÚc
; i++) {

1213 ià(!
	`¶_ÿ£cmp
(&
hdr
->
v®
, &
ua
->
ex‹nsiÚv
[
i
])) {

1214 
suµÜ‹d
 = 
Œue
;

1219  !
suµÜ‹d
;

1220 
	}
}

1224 
	$s£ss_cÚn_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1226 
cÚfig
 *cÚfig = 
	`cÚf_cÚfig
();

1227 cÚ¡ 
s_hdr
 *
hdr
;

1228 
ua
 *ua;

1229 
ÿÎ
 *ÿÎ = 
NULL
;

1230 
to_uri
[256];

1231 
”r
;

1233 ()
¬g
;

1235 
ua
 = 
	`uag_fšd
(&
msg
->
uri
.
u£r
);

1236 ià(!
ua
) {

1237 
	`w¬nšg
("ua: %r: UA‚ot found: %r\n",

1238 &
msg
->
äom
.
auri
, &msg->
uri
.
u£r
);

1239 ()
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
, 404, "Not Found");

1244 ià(
cÚfig
->
ÿÎ
.
max_ÿÎs
 &&

1245 
	`li¡_couÁ
(&
ua
->
ÿÎs
è+ 1 > 
cÚfig
->
ÿÎ
.
max_ÿÎs
) {

1247 
	`šfo
("ua:„ejected call from %r (maximum %d calls)\n",

1248 &
msg
->
äom
.
auri
, 
cÚfig
->
ÿÎ
.
max_ÿÎs
);

1249 ()
	`s_Œ•ly
(
NULL
, 
uag
.
s
, 
msg
, 486, "Max Calls");

1254 
hdr
 = 
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_REQUIRE
,

1255 
»quœe_hªdËr
, 
ua
);

1256 ià(
hdr
) {

1257 
	`šfo
("ua: call from %r„ejected with 420"

1259 &
msg
->
äom
.
auri
, &
hdr
->
v®
);

1261 ()
	`s_Œ•lyf
(
NULL
, NULL, 
uag
.
s
, 
msg
, 
çl£
,

1265 &
hdr
->
v®
);

1269 ()
	`¶_¡rıy
(&
msg
->
to
.
auri
, 
to_uri
, (to_uri));

1271 
”r
 = 
	`ua_ÿÎ_®loc
(&
ÿÎ
, 
ua
, 
VIDMODE_ON
, 
msg
, 
NULL
, 
to_uri
, 
Œue
);

1272 ià(
”r
) {

1273 
	`w¬nšg
("ua: c®l_®loc: %m\n", 
”r
);

1274 
”rÜ
;

1277 
”r
 = 
	`ÿÎ_acû±
(
ÿÎ
, 
uag
.
sock
, 
msg
);

1278 ià(
”r
)

1279 
”rÜ
;

1283 
”rÜ
:

1284 
	`mem_d”ef
(
ÿÎ
);

1285 ()
	`s_Œ•ly
(
NULL
, 
uag
.
s
, 
msg
, 500, "Call Error");

1286 
	}
}

1289 
	$Ãt_chªge_hªdËr
(*
¬g
)

1291 ()
¬g
;

1293 
	`šfo
("IP-address changed: %j\n",

1294 
	`Ãt_Ïddr_af
(
	`b¬es_ÃtwÜk
(), 
AF_INET
));

1296 ()
	`uag_»£t_Œª¥
(
Œue
,rue);

1297 
	}
}

1300 
boŞ
 
	$sub_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

1302 
ua
 *ua;

1304 ()
¬g
;

1306 
ua
 = 
	`uag_fšd
(&
msg
->
uri
.
u£r
);

1307 ià(!
ua
) {

1308 
	`w¬nšg
("subsüibe:‚ØUA found fÜ %r\n", &
msg
->
uri
.
u£r
);

1309 ()
	`s_Œ•ly
(
NULL
, 
	`uag_s
(), 
msg
, 404, "Not Found");

1310  
Œue
;

1313 ià(
uag
.
subh
)

1314 
uag
.
	`subh
(
msg
, 
ua
);

1316  
Œue
;

1317 
	}
}

1331 
	$ua_š™
(cÚ¡ *
soáw¬e
, 
boŞ
 
udp
, boŞ 
tı
, boŞ 
s
,

1332 
boŞ
 
´eãr_v6
)

1334 
cÚfig
 *
cfg
 = 
	`cÚf_cÚfig
();

1335 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

1336 
ušt32_t
 
bsize
;

1337 
”r
;

1339 ià(!
Ãt
) {

1340 
	`w¬nšg
("ua:‚o‚etwork\n");

1341  
EINVAL
;

1344 
uag
.
cfg
 = &cfg->
s
;

1345 
bsize
 = 
cfg
->
s
.
Œªs_bsize
;

1347 
uag
.
u£_udp
 = 
udp
;

1348 
uag
.
u£_tı
 = 
tı
;

1349 
uag
.
u£_s
 = 
s
;

1350 
uag
.
´eãr_v6
 =…refer_ipv6;

1352 
	`li¡_š™
(&
uag
.
u®
);

1354 
”r
 = 
	`s_®loc
(&
uag
.
s
, 
	`Ãt_dnsc
(
Ãt
), 
bsize
, bsize, bsize,

1355 
soáw¬e
, 
ex™_hªdËr
, 
NULL
);

1356 ià(
”r
) {

1357 
	`w¬nšg
("ua: s sck faed: %m\n", 
”r
);

1358 
out
;

1361 
”r
 = 
	`ua_add_Œª¥
(
Ãt
);

1362 ià(
”r
)

1363 
out
;

1365 
”r
 = 
	`s_li¡’
(&
uag
.
l¢r
, uag.
s
, 
Œue
, 
»que¡_hªdËr
, 
NULL
);

1366 ià(
”r
)

1367 
out
;

1369 
”r
 = 
	`s£ss_li¡’
(&
uag
.
sock
, uag.
s
, 
bsize
,

1370 
s£ss_cÚn_hªdËr
, 
NULL
);

1371 ià(
”r
)

1372 
out
;

1374 
”r
 = 
	`sev’t_li¡’
(&
uag
.
evsock
, uag.
s
, 
bsize
, bsize,

1375 
sub_hªdËr
, 
NULL
);

1376 ià(
”r
)

1377 
out
;

1379 
	`Ãt_chªge
(
Ãt
, 60, 
Ãt_chªge_hªdËr
, 
NULL
);

1381 
out
:

1382 ià(
”r
) {

1383 
	`w¬nšg
("ua: in™ faed (%m)\n", 
”r
);

1384 
	`ua_şo£
();

1386  
”r
;

1387 
	}
}

1393 
	$ua_şo£
()

1395 
uag
.
evsock
 = 
	`mem_d”ef
(uag.evsock);

1396 
uag
.
sock
 = 
	`mem_d”ef
(uag.sock);

1397 
uag
.
l¢r
 = 
	`mem_d”ef
(uag.lsnr);

1398 
uag
.
s
 = 
	`mem_d”ef
(uag.sip);

1399 
uag
.
•rm
 = 
	`mem_d”ef
(uag.eprm);

1401 #ifdeà
USE_TLS


1402 
uag
.
s
 = 
	`mem_d”ef
(uag.tls);

1405 
	`li¡_æush
(&
uag
.
u®
);

1406 
	`li¡_æush
(&
uag
.
ehl
);

1409 
	`moduË_­p_uÆßd
();

1410 
	}
}

1418 
	$ua_¡İ_®l
(
boŞ
 
fÜûd
)

1420 
Ë
 *le;

1421 
boŞ
 
ext_»f
 = 
çl£
;

1423 
	`šfo
("ua: stİ‡Î (fÜûd=%d)\n", 
fÜûd
);

1426 
Ë
 = 
uag
.
u®
.
h—d
;

1427 
Ë
) {

1429 
ua
 *u¨ğ
Ë
->
d©a
;

1430 
Ë
 =†e->
Ãxt
;

1432 ià(
	`mem_Äefs
(
ua
) > 1) {

1434 
	`li¡_uÆšk
(&
ua
->
Ë
);

1435 
	`li¡_æush
(&
ua
->
ÿÎs
);

1436 
	`mem_d”ef
(
ua
);

1438 
ext_»f
 = 
Œue
;

1441 
	`ua_ev’t
(
ua
, 
UA_EVENT_SHUTDOWN
, 
NULL
, NULL);

1444 ià(
ext_»f
) {

1445 
	`šfo
("ua:ƒxt_ref -> cannot unload mods\n");

1449 
	`moduË_­p_uÆßd
();

1452 ià(!
	`li¡_i£m±y
(&
uag
.
u®
)) {

1453 cÚ¡ 
ušt32_t
 
n
 = 
	`li¡_couÁ
(&
uag
.
u®
);

1454 
	`šfo
("Stopping %u useragent%s.. %s\n",

1455 
n
,‚==1 ? "" : "s", 
fÜûd
 ? "(Forced)" : "");

1458 ià(
fÜûd
)

1459 
	`s£ss_şo£_®l
(
uag
.
sock
);

1461 
	`li¡_æush
(&
uag
.
u®
);

1463 
	`s_şo£
(
uag
.
s
, 
fÜûd
);

1464 
	}
}

1474 
	$uag_£t_ex™_hªdËr
(
ua_ex™_h
 *
ex™h
, *
¬g
)

1476 
uag
.
ex™h
 =ƒxith;

1477 
uag
.
¬g
 =‡rg;

1478 
	}
}

1489 
	$uag_»£t_Œª¥
(
boŞ
 
»g
, boŞ 
»šv™e
)

1491 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

1492 
Ë
 *le;

1493 
”r
;

1496 
	`s_Œª¥_æush
(
uag
.
s
);

1498 ()
	`Ãt_check
(
Ãt
);

1499 
”r
 = 
	`ua_add_Œª¥
(
Ãt
);

1500 ià(
”r
)

1501  
”r
;

1504 
Ë
 = 
uag
.
u®
.
h—d
;†e;†ğË->
Ãxt
) {

1505 
ua
 *u¨ğ
Ë
->
d©a
;

1507 ià(
»g
 && 
ua
->
acc
->
»gšt
) {

1508 
”r
 |ğ
	`ua_»gi¡”
(
ua
);

1512 ià(
»šv™e
) {

1513 
Ë
 *
Ëc
;

1515 
Ëc
 = 
ua
->
ÿÎs
.
h—d
;†ec;†eøğËc->
Ãxt
) {

1516 
ÿÎ
 *ÿÎ = 
Ëc
->
d©a
;

1517 cÚ¡ 
§
 *
Ïddr
;

1519 
Ïddr
 = 
	`Ãt_Ïddr_af
(
Ãt
, 
	`ÿÎ_af
(
ÿÎ
));

1521 
”r
 |ğ
	`ÿÎ_»£t_Œª¥
(
ÿÎ
, 
Ïddr
);

1526  
”r
;

1527 
	}
}

1538 
	$ua_´št_s_¡©us
(
»_´štf
 *
pf
, *
unu£d
)

1540 ()
unu£d
;

1541  
	`s_debug
(
pf
, 
uag
.
s
);

1542 
	}
}

1553 
	$ua_´št_ÿÎs
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua)

1555 
ušt32_t
 
n
, 
couÁ
=0;

1556 
ušt32_t
 
lš’um
;

1557 
”r
 = 0;

1559 ià(!
ua
) {

1560 
”r
 |ğ
	`»_h´štf
(
pf
, "\n--- No‡ctive calls ---\n");

1561  
”r
;

1564 
n
 = 
	`li¡_couÁ
(&
ua
->
ÿÎs
);

1566 
”r
 |ğ
	`»_h´štf
(
pf
, "\n--- List of‡ctive calls (%u): ---\n",

1567 
n
);

1569 
lš’um
=
CALL_LINENUM_MIN
;†š’um<
CALL_LINENUM_MAX
;†inenum++) {

1571 cÚ¡ 
ÿÎ
 *call;

1573 
ÿÎ
 = 
	`ÿÎ_fšd_lš’um
(&
ua
->
ÿÎs
, 
lš’um
);

1574 ià(
ÿÎ
) {

1575 ++
couÁ
;

1577 
”r
 |ğ
	`»_h´štf
(
pf
, " %c %H\n",

1578 
ÿÎ
 =ğ
	`ua_ÿÎ
(
ua
) ? '>' : ' ',

1579 
ÿÎ_šfo
, 
ÿÎ
);

1582 ià(
couÁ
 >ğ
n
)

1586 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

1588  
”r
;

1589 
	}
}

1597 
s
 *
	$uag_s
()

1599  
uag
.
s
;

1600 
	}
}

1608 
s£ss_sock
 *
	$uag_s£ss_sock
()

1610  
uag
.
sock
;

1611 
	}
}

1619 
sev’t_sock
 *
	$uag_sev’t_sock
()

1621  
uag
.
evsock
;

1622 
	}
}

1625 
s
 *
	$uag_s
()

1627 #ifdeà
USE_TLS


1628  
uag
.
s
;

1630  
NULL
;

1632 
	}
}

1642 
ua
 *
	$uag_fšd
(cÚ¡ 
¶
 *
cu£r
)

1644 
Ë
 *le;

1646 
Ë
 = 
uag
.
u®
.
h—d
;†e;†ğË->
Ãxt
) {

1647 
ua
 *u¨ğ
Ë
->
d©a
;

1649 ià(0 =ğ
	`¶_¡rÿ£cmp
(
cu£r
, 
ua
->cuser))

1650  
ua
;

1654 
Ë
 = 
uag
.
u®
.
h—d
;†e;†ğË->
Ãxt
) {

1655 
ua
 *u¨ğ
Ë
->
d©a
;

1657 ià(0 =ğ
	`¶_ÿ£cmp
(
cu£r
, &
ua
->
acc
->
luri
.
u£r
))

1658  
ua
;

1661  
NULL
;

1662 
	}
}

1672 
ua
 *
	$uag_fšd_aÜ
(cÚ¡ *
aÜ
)

1674 
Ë
 *le;

1676 
Ë
 = 
uag
.
u®
.
h—d
;†e;†ğË->
Ãxt
) {

1677 
ua
 *u¨ğ
Ë
->
d©a
;

1679 ià(
	`¡r_is£t
(
aÜ
è&& 
	`¡r_cmp
(
ua
->
acc
->aor,‡or))

1682  
ua
;

1685  
NULL
;

1686 
	}
}

1697 
ua
 *
	$uag_fšd_·¿m
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

1699 
Ë
 *le;

1701 
Ë
 = 
uag
.
u®
.
h—d
;†e;†ğË->
Ãxt
) {

1702 
ua
 *u¨ğ
Ë
->
d©a
;

1703 
s_addr
 *
Ïddr
 = 
	`accouÁ_Ïddr
(
ua
->
acc
);

1704 
¶
 
v®
;

1706 ià(
v®ue
) {

1708 ià(0 =ğ
	`msg_·¿m_decode
(&
Ïddr
->
·¿ms
, 
Çme
, &
v®
)

1710 0 =ğ
	`¶_¡rÿ£cmp
(&
v®
, 
v®ue
)) {

1711  
ua
;

1715 ià(0 =ğ
	`msg_·¿m_exi¡s
(&
Ïddr
->
·¿ms
, 
Çme
, &
v®
))

1716  
ua
;

1720  
NULL
;

1721 
	}
}

1734 cÚ¡ *
	$ua_cu£r
(cÚ¡ 
ua
 *ua)

1736 ià(!
ua
)

1737  
NULL
;

1739 ià(
	`¡r_is£t
(
ua
->
pub_gruu
))

1740  
ua
->
pub_gruu
;

1742  
ua
->
cu£r
;

1743 
	}
}

1746 cÚ¡ *
	$ua_loÿl_cu£r
(cÚ¡ 
ua
 *ua)

1748  
ua
 ? ua->
cu£r
 : 
NULL
;

1749 
	}
}

1759 
accouÁ
 *
	$ua_accouÁ
(cÚ¡ 
ua
 *ua)

1761  
ua
 ? ua->
acc
 : 
NULL
;

1762 
	}
}

1771 
	$ua_pub_gruu_£t
(
ua
 *ua, cÚ¡ 
¶
 *
pv®
)

1773 ià(!
ua
)

1776 
ua
->
pub_gruu
 = 
	`mem_d”ef
(ua->pub_gruu);

1777 ()
	`¶_¡rdup
(&
ua
->
pub_gruu
, 
pv®
);

1778 
	}
}

1781 
li¡
 *
	$uag_li¡
()

1783  &
uag
.
u®
;

1784 
	}
}

1792 cÚ¡ *
	$uag_®lowed_m‘hods
()

1796 
	}
}

1799 
	$ua_´št_suµÜ‹d
(
»_´štf
 *
pf
, cÚ¡ 
ua
 *ua)

1801 
size_t
 
i
;

1802 
”r
;

1804 
”r
 = 
	`»_h´štf
(
pf
, "Supported:");

1806 
i
=0; i<
ua
->
ex‹nsiÚc
; i++) {

1807 
”r
 |ğ
	`»_h´štf
(
pf
, "%s%r",

1808 
i
==0 ? " " : ",", &
ua
->
ex‹nsiÚv
[i]);

1811 
”r
 |ğ
	`»_h´štf
(
pf
, "\r\n");

1813  
”r
;

1814 
	}
}

1817 
li¡
 *
	$ua_ÿÎs
(cÚ¡ 
ua
 *ua)

1819  
ua
 ? (
li¡
 *)&ua->
ÿÎs
 : 
NULL
;

1820 
	}
}

1823 
	$eh_de¡ruùÜ
(*
¬g
)

1825 
ua_eh
 *
eh
 = 
¬g
;

1826 
	`li¡_uÆšk
(&
eh
->
Ë
);

1827 
	}
}

1830 
	$uag_ev’t_»gi¡”
(
ua_ev’t_h
 *
h
, *
¬g
)

1832 
ua_eh
 *
eh
;

1834 ià(!
h
)

1835  
EINVAL
;

1837 
	`uag_ev’t_uÄegi¡”
(
h
);

1839 
eh
 = 
	`mem_z®loc
((*eh), 
eh_de¡ruùÜ
);

1840 ià(!
eh
)

1841  
ENOMEM
;

1843 
eh
->
h
 = h;

1844 
eh
->
¬g
 =‡rg;

1846 
	`li¡_­³nd
(&
uag
.
ehl
, &
eh
->
Ë
,ƒh);

1849 
	}
}

1852 
	$uag_ev’t_uÄegi¡”
(
ua_ev’t_h
 *
h
)

1854 
Ë
 *le;

1856 
Ë
 = 
uag
.
ehl
.
h—d
;†e;†ğË->
Ãxt
) {

1858 
ua_eh
 *
eh
 = 
Ë
->
d©a
;

1860 ià(
eh
->
h
 == h) {

1861 
	`mem_d”ef
(
eh
);

1865 
	}
}

1868 
	$uag_£t_sub_hªdËr
(
s_msg_h
 *
subh
)

1870 
uag
.
subh
 = subh;

1871 
	}
}

1874 
	$uag_cu¼’t_£t
(
ua
 *ua)

1876 
uag
.
ua_cur
 = 
ua
;

1877 
	}
}

1880 
ua
 *
	$uag_cu¼’t
()

1882 ià(
	`li¡_i£m±y
(
	`uag_li¡
()))

1883  
NULL
;

1885  
uag
.
ua_cur
;

1886 
	}
}

1889 
	$ua_£t_medŸ_af
(
ua
 *ua, 
af_medŸ
)

1891 ià(!
ua
)

1894 
ua
->
af_medŸ
 =‡f_media;

1895 
	}
}

1898 
	$uag_£t_exŒa_·¿ms
(cÚ¡ *
•rm
)

1900 
uag
.
•rm
 = 
	`mem_d”ef
(uag.eprm);

1902 ià(
•rm
)

1903  
	`¡r_dup
(&
uag
.
•rm
,ƒprm);

1906 
	}
}

	@baresip/src/ui.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

12 
	$¡dout_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

14 ()
¬g
;

16 ià(1 !ğ
	`fwr™e
(
p
, 
size
, 1, 
¡dout
))

17  
ENOMEM
;

20 
	}
}

29 
	$ui_»gi¡”
(
ui_sub
 *
uis
, 
ui
 *ui)

31 ià(!
uis
 || !
ui
)

34 
	`li¡_­³nd
(&
uis
->
u
, &
ui
->
Ë
, ui);

36 
	`debug
("ui: %s\n", 
ui
->
Çme
);

37 
	}
}

45 
	$ui_uÄegi¡”
(
ui
 *ui)

47 ià(!
ui
)

50 
	`li¡_uÆšk
(&
ui
->
Ë
);

51 
	}
}

61 
	$ui_šput_key
(
ui_sub
 *
uis
, 
key
, 
»_´štf
 *
pf
)

63 ià(!
uis
)

66 ()
	`cmd_´oûss
(
	`b¬es_commªds
(), &
uis
->
uiùx
, 
key
, 
pf
, 
NULL
);

67 
	}
}

75 
	$ui_šput_¡r
(cÚ¡ *
¡r
)

77 
»_´štf
 
pf
;

78 
¶
…l;

80 ià(!
¡r
)

83 
pf
.
vph
 = 
¡dout_hªdËr
;

84 
pf
.
¬g
 = 
NULL
;

86 
	`¶_£t_¡r
(&
¶
, 
¡r
);

88 ()
	`ui_šput_¶
(&
pf
, &
¶
);

89 
	}
}

92 
	$ui_šput_¶
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

94 
cmd_ùx
 *
ùx
 = 
NULL
;

95 
commªds
 *commªd ğ
	`b¬es_commªds
();

96 
size_t
 
i
;

97 
”r
 = 0;

99 ià(!
pf
 || !
¶
)

100  
EINVAL
;

102 
i
=0; i<
¶
->
l
; i++) {

103 
”r
 |ğ
	`cmd_´oûss
(
commªds
, &
ùx
, 
¶
->
p
[
i
], 
pf
, 
NULL
);

106 ià(
¶
->
l
 > 1 && 
ùx
)

107 
”r
 |ğ
	`cmd_´oûss
(
commªds
, &
ùx
, '\n', 
pf
, 
NULL
);

109  
”r
;

110 
	}
}

119 
	$ui_ouut
(
ui_sub
 *
uis
, cÚ¡ *
fmt
, ...)

121 
buf
[512];

122 
Ë
 *le;

123 
va_li¡
 
­
;

124 
n
;

126 ià(!
uis
)

129 
	`va_¡¬t
(
­
, 
fmt
);

130 
n
 = 
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

131 
	`va_’d
(
­
);

133 ià(
n
 < 0)

136 
Ë
 = 
uis
->
u
.
h—d
;†e;†ğË->
Ãxt
) {

137 cÚ¡ 
ui
 *u˜ğ
Ë
->
d©a
;

139 ià(
ui
->
ouuth
)

140 
ui
->
	`ouuth
(
buf
);

142 
	}
}

150 
	$ui_»£t
(
ui_sub
 *
uis
)

152 ià(!
uis
)

155 
uis
->
uiùx
 = 
	`mem_d”ef
(uis->uictx);

156 
	}
}

159 
boŞ
 
	$ui_i£d™šg
(cÚ¡ 
ui_sub
 *
uis
)

161 ià(!
uis
)

162  
çl£
;

164  
uis
->
uiùx
 !ğ
NULL
;

165 
	}
}

168 
	$ui_·sswÜd_´om±
(**
·sswÜdp
)

170 
pwd
[64];

171 *
Æ
;

172 
”r
;

174 ià(!
·sswÜdp
)

175  
EINVAL
;

178 
	`fg‘s
(
pwd
, Õwd), 
¡dš
);

179 
pwd
[(pwd) - 1] = '\0';

181 
Æ
 = 
	`¡rchr
(
pwd
, '\n');

182 ià(
Æ
 =ğ
NULL
) {

183 ()
	`»_´štf
("Invalid…assword (0 - 63 characters"

185  
EINVAL
;

188 *
Æ
 = '\0';

190 
”r
 = 
	`¡r_dup
(
·sswÜdp
, 
pwd
);

191 ià(
”r
)

192  
”r
;

195 
	}
}

	@baresip/src/vidcodec.c

7 
	~<».h
>

8 
	~<b¬es.h
>

17 
	$vidcodec_»gi¡”
(
li¡
 *
vidcodeş
, 
vidcodec
 *
vc
)

19 ià(!
vidcodeş
 || !
vc
)

22 
	`li¡_­³nd
(
vidcodeş
, &
vc
->
Ë
, vc);

24 
	`šfo
("vidcodec: %s\n", 
vc
->
Çme
);

25 
	}
}

33 
	$vidcodec_uÄegi¡”
(
vidcodec
 *
vc
)

35 ià(!
vc
)

38 
	`li¡_uÆšk
(&
vc
->
Ë
);

39 
	}
}

51 cÚ¡ 
vidcodec
 *
	$vidcodec_fšd
(cÚ¡ 
li¡
 *
vidcodeş
,

52 cÚ¡ *
Çme
, cÚ¡ *
v¬ŸÁ
)

54 
Ë
 *le;

56 
Ë
=
	`li¡_h—d
(
vidcodeş
);†e;†eöe->
Ãxt
) {

58 
vidcodec
 *
vc
 = 
Ë
->
d©a
;

60 ià(
Çme
 && 0 !ğ
	`¡r_ÿ£cmp
Òame, 
vc
->name))

63 ià(
v¬ŸÁ
 && 0 !ğ
	`¡r_ÿ£cmp
(v¬ŸÁ, 
vc
->variant))

66  
vc
;

69  
NULL
;

70 
	}
}

81 cÚ¡ 
vidcodec
 *
	$vidcodec_fšd_’cod”
(cÚ¡ 
li¡
 *
vidcodeş
,

82 cÚ¡ *
Çme
)

84 
Ë
 *le;

86 
Ë
=
	`li¡_h—d
(
vidcodeş
);†e;†eöe->
Ãxt
) {

88 
vidcodec
 *
vc
 = 
Ë
->
d©a
;

90 ià(
Çme
 && 0 !ğ
	`¡r_ÿ£cmp
Òame, 
vc
->name))

93 ià(
vc
->
’ch
)

94  
vc
;

97  
NULL
;

98 
	}
}

109 cÚ¡ 
vidcodec
 *
	$vidcodec_fšd_decod”
(cÚ¡ 
li¡
 *
vidcodeş
,

110 cÚ¡ *
Çme
)

112 
Ë
 *le;

114 
Ë
=
	`li¡_h—d
(
vidcodeş
);†e;†eöe->
Ãxt
) {

116 
vidcodec
 *
vc
 = 
Ë
->
d©a
;

118 ià(
Çme
 && 0 !ğ
	`¡r_ÿ£cmp
Òame, 
vc
->name))

121 ià(
vc
->
dech
)

122  
vc
;

125  
NULL
;

126 
	}
}

	@baresip/src/video.c

8 
	~<¡ršg.h
>

9 
	~<¡dlib.h
>

10 
	~<».h
>

11 
	~<»m.h
>

12 
	~<b¬es.h
>

13 
	~"cÜe.h
"

17 
	#MAGIC
 0x00070d10

	)

18 
	~"magic.h
"

22 #iâdeà
VIDENC_INTERNAL_FMT


23 
	#VIDENC_INTERNAL_FMT
 (
VID_FMT_YUV420P
)

	)

28 
	mMAX_MUTED_FRAMES
 = 3,

33 
	mMEDIA_POLL_RATE
 = 250,

34 
	mBURST_MAX
 = 8192,

35 
	mRTP_PRESZ
 = 4 + 
RTP_HEADER_SIZE
,

36 
	mRTP_TRAILSZ
 = 12 + 4,

37 
	mPICUP_INTERVAL
 = 500,

84 
	svtx
 {

85 
video
 *
	mvideo
;

86 cÚ¡ 
vidcodec
 *
	mvc
;

87 
vid’c_¡©e
 *
	m’c
;

88 
vid¤c_´m
 
	mv¤c_´m
;

89 
vidsz
 
	mv¤c_size
;

90 
vid¤c_¡
 *
	mv¤c
;

91 
lock
 *
	mlock
;

92 
vidäame
 *
	mäame
;

93 
vidäame
 *
	mmu‹_äame
;

94 
lock
 *
	mlock_tx
;

95 
li¡
 
	m£ndq
;

96 
tmr
 
	mtmr_¹p
;

97 
	mskc
;

98 
li¡
 
	mf
;

99 
	mdeviû
[128];

100 
	mmu‹d_äames
;

101 
ušt32_t
 
	mts_off£t
;

102 
boŞ
 
	mpicup
;

103 
boŞ
 
	mmu‹d
;

104 
	mäames
;

105 
	meås
;

106 
ušt32_t
 
	mts_mš
;

107 
ušt32_t
 
	mts_max
;

127 
	svrx
 {

128 
video
 *
	mvideo
;

129 cÚ¡ 
vidcodec
 *
	mvc
;

130 
viddec_¡©e
 *
	mdec
;

131 
vidi¥_´m
 
	mvidi¥_´m
;

132 
vidi¥_¡
 *
	mvidi¥
;

133 
lock
 *
	mlock
;

134 
li¡
 
	mf
;

135 
tmr
 
	mtmr_picup
;

136 
vidsz
 
	msize
;

137 
vidÜ›Á
 
	mÜ›Á
;

138 
	mdeviû
[128];

139 
	m±_rx
;

140 
	mäames
;

141 
	meås
;

142 
	mn_šŒa
;

143 
	mn_picup
;

144 
ušt32_t
 
	mts_mš
;

145 
ušt32_t
 
	mts_max
;

150 
	svideo
 {

151 
MAGIC_DECL


152 
cÚfig_video
 
	mcfg
;

153 
¡»am
 *
	m¡rm
;

154 
vtx
 
	mvtx
;

155 
vrx
 
	mvrx
;

156 
tmr
 
	mtmr
;

157 
boŞ
 
	m¡¬‹d
;

158 *
	m³”
;

159 
boŞ
 
	mÇck_¶i
;

160 
video_”r_h
 *
	m”rh
;

161 *
	m¬g
;

165 
	svidq’t
 {

166 
Ë
 
	mË
;

167 
§
 
	md¡
;

168 
boŞ
 
	mm¬k”
;

169 
ušt8_t
 
	m±
;

170 
ušt32_t
 
	mts
;

171 
mbuf
 *
	mmb
;

175 
»que¡_piùu»_upd©e
(
vrx
 *vrx);

178 
	$vidq’t_de¡ruùÜ
(*
¬g
)

180 
vidq’t
 *
q’t
 = 
¬g
;

182 
	`li¡_uÆšk
(&
q’t
->
Ë
);

183 
	`mem_d”ef
(
q’t
->
mb
);

184 
	}
}

187 
	$vidq’t_®loc
(
vidq’t
 **
q’
,

188 
boŞ
 
m¬k”
, 
ušt8_t
 
±
, 
ušt32_t
 
ts
,

189 cÚ¡ 
ušt8_t
 *
hdr
, 
size_t
 
hdr_Ën
,

190 cÚ¡ 
ušt8_t
 *
¶d
, 
size_t
 
¶d_Ën
)

192 
vidq’t
 *
q’t
;

193 
”r
 = 0;

195 ià(!
q’
 || !
¶d
)

196  
EINVAL
;

198 
q’t
 = 
	`mem_z®loc
((*q’t), 
vidq’t_de¡ruùÜ
);

199 ià(!
q’t
)

200  
ENOMEM
;

202 
q’t
->
m¬k”
 = marker;

203 
q’t
->
±
 =…t;

204 
q’t
->
ts
 =s;

206 
q’t
->
mb
 = 
	`mbuf_®loc
(
RTP_PRESZ
 + 
hdr_Ën
 + 
¶d_Ën
 + 
RTP_TRAILSZ
);

207 ià(!
q’t
->
mb
) {

208 
”r
 = 
ENOMEM
;

209 
out
;

212 
q’t
->
mb
->
pos
 = q’t->mb->
’d
 = 
RTP_PRESZ
;

214 ià(
hdr
)

215 ()
	`mbuf_wr™e_mem
(
q’t
->
mb
, 
hdr
, 
hdr_Ën
);

217 ()
	`mbuf_wr™e_mem
(
q’t
->
mb
, 
¶d
, 
¶d_Ën
);

219 
q’t
->
mb
->
pos
 = 
RTP_PRESZ
;

221 
out
:

222 ià(
”r
)

223 
	`mem_d”ef
(
q’t
);

225 *
q’
 = 
q’t
;

227  
”r
;

228 
	}
}

231 
	$vidqueue_pŞl
(
vtx
 *vtx, 
ušt64_t
 
jfs
, ušt64_ˆ
´ev_jfs
)

233 
size_t
 
bur¡
, 
£Á
;

234 
ušt64_t
 
bªdwidth_kbps
;

235 
Ë
 *le;

237 ià(!
vtx
)

240 
	`lock_wr™e_g‘
(
vtx
->
lock_tx
);

242 
Ë
 = 
vtx
->
£ndq
.
h—d
;

243 ià(!
Ë
)

244 
out
;

249 
bªdwidth_kbps
 = 
vtx
->
video
->
cfg
.
b™¿‹
 / 1000;

250 
bur¡
 = (1 + 
jfs
 - 
´ev_jfs
è* 
bªdwidth_kbps
 / 4;

252 
bur¡
 = 
	`mš
(bur¡, 
BURST_MAX
);

253 
£Á
 = 0;

255 
Ë
) {

257 
vidq’t
 *
q’t
 = 
Ë
->
d©a
;

259 
£Á
 +ğ
	`mbuf_g‘_Ëá
(
q’t
->
mb
);

261 
	`¡»am_£nd
(
vtx
->
video
->
¡rm
, 
çl£
, 
q’t
->
m¬k”
, q’t->
±
,

262 
q’t
->
ts
, q’t->
mb
);

264 
Ë
 =†e->
Ãxt
;

265 
	`mem_d”ef
(
q’t
);

267 ià(
£Á
 > 
bur¡
) {

272 
out
:

273 
	`lock_»l
(
vtx
->
lock_tx
);

274 
	}
}

277 
	$¹p_tmr_hªdËr
(*
¬g
)

279 
vtx
 *vtx = 
¬g
;

280 
ušt64_t
 
pjfs
;

282 
pjfs
 = 
vtx
->
tmr_¹p
.
jfs
;

284 
	`tmr_¡¬t
(&
vtx
->
tmr_¹p
, 1000/
MEDIA_POLL_RATE
, 
¹p_tmr_hªdËr
, vtx);

286 
	`vidqueue_pŞl
(
vtx
, vtx->
tmr_¹p
.
jfs
, 
pjfs
);

287 
	}
}

290 
	$video_de¡ruùÜ
(*
¬g
)

292 
video
 *
v
 = 
¬g
;

293 
vtx
 *vtx = &
v
->vtx;

294 
vrx
 *vrx = &
v
->vrx;

297 
	`lock_wr™e_g‘
(
vtx
->
lock_tx
);

298 
	`li¡_æush
(&
vtx
->
£ndq
);

299 
	`lock_»l
(
vtx
->
lock_tx
);

300 
	`mem_d”ef
(
vtx
->
lock_tx
);

302 
	`tmr_ÿnûl
(&
vtx
->
tmr_¹p
);

303 
	`mem_d”ef
(
vtx
->
v¤c
);

304 
	`lock_wr™e_g‘
(
vtx
->
lock
);

305 
	`mem_d”ef
(
vtx
->
äame
);

306 
	`mem_d”ef
(
vtx
->
mu‹_äame
);

307 
	`mem_d”ef
(
vtx
->
’c
);

308 
	`li¡_æush
(&
vtx
->
f
);

309 
	`lock_»l
(
vtx
->
lock
);

310 
	`mem_d”ef
(
vtx
->
lock
);

313 
	`tmr_ÿnûl
(&
vrx
->
tmr_picup
);

314 
	`lock_wr™e_g‘
(
vrx
->
lock
);

315 
	`mem_d”ef
(
vrx
->
dec
);

316 
	`mem_d”ef
(
vrx
->
vidi¥
);

317 
	`li¡_æush
(&
vrx
->
f
);

318 
	`lock_»l
(
vrx
->
lock
);

319 
	`mem_d”ef
(
vrx
->
lock
);

321 
	`tmr_ÿnûl
(&
v
->
tmr
);

322 
	`mem_d”ef
(
v
->
¡rm
);

323 
	`mem_d”ef
(
v
->
³”
);

324 
	}
}

327 
	$g‘_ås
(cÚ¡ 
video
 *
v
)

329 cÚ¡ *
©Œ
;

332 
©Œ
 = 
	`sdp_medŸ_¿‰r
(
	`¡»am_sdpmedŸ
(
v
->
¡rm
), "framerate");

333 ià(
©Œ
) {

335 cÚ¡ 
ås
 = 
	`©of
(
©Œ
);

336  ()
ås
;

339  
v
->
cfg
.
ås
;

340 
	}
}

343 
	$·ck‘_hªdËr
(
boŞ
 
m¬k”
, 
ušt32_t
 
ts
,

344 cÚ¡ 
ušt8_t
 *
hdr
, 
size_t
 
hdr_Ën
,

345 cÚ¡ 
ušt8_t
 *
¶d
, 
size_t
 
¶d_Ën
,

346 *
¬g
)

348 
vtx
 *vtx = 
¬g
;

349 
¡»am
 *
¡rm
 = 
vtx
->
video
->strm;

350 
vidq’t
 *
q’t
;

351 
ušt32_t
 
¹p_ts
;

352 
”r
;

355 ià(
ts
 < 
vtx
->
ts_mš
)

356 
vtx
->
ts_mš
 = 
ts
;

357 ià(
ts
 > 
vtx
->
ts_max
)

358 
vtx
->
ts_max
 = 
ts
;

361 
¹p_ts
 = 
vtx
->
ts_off£t
 + 
ts
;

363 
”r
 = 
	`vidq’t_®loc
(&
q’t
, 
m¬k”
, 
¡rm
->
±_’c
, 
¹p_ts
,

364 
hdr
, 
hdr_Ën
, 
¶d
, 
¶d_Ën
);

365 ià(
”r
)

366  
”r
;

368 
	`lock_wr™e_g‘
(
vtx
->
lock_tx
);

369 
q’t
->
d¡
 = *
	`sdp_medŸ_¿ddr
(
¡rm
->
sdp
);

370 
	`li¡_­³nd
(&
vtx
->
£ndq
, &
q’t
->
Ë
, qent);

371 
	`lock_»l
(
vtx
->
lock_tx
);

373  
”r
;

374 
	}
}

385 
	$’code_¹p_£nd
(
vtx
 *vtx, 
vidäame
 *
äame
)

387 
Ë
 *le;

388 
”r
 = 0;

389 
boŞ
 
£ndq_em±y
;

391 ià(!
vtx
->
’c
)

394 
	`lock_wr™e_g‘
(
vtx
->
lock_tx
);

395 
£ndq_em±y
 = (
vtx
->
£ndq
.
h—d
 =ğ
NULL
);

396 
	`lock_»l
(
vtx
->
lock_tx
);

398 ià(!
£ndq_em±y
) {

399 ++
vtx
->
skc
;

403 
	`lock_wr™e_g‘
(
vtx
->
lock
);

406 ià(
äame
->
fmt
 !ğ
VIDENC_INTERNAL_FMT
) {

408 
vtx
->
v¤c_size
 = 
äame
->
size
;

410 ià(!
vtx
->
äame
) {

412 
”r
 = 
	`vidäame_®loc
(&
vtx
->
äame
, 
VIDENC_INTERNAL_FMT
,

413 &
vtx
->
v¤c_size
);

414 ià(
”r
)

415 
uÆock
;

418 
	`vidcÚv
(
vtx
->
äame
, frame, 0);

419 
äame
 = 
vtx
->frame;

423 
Ë
 = 
vtx
->
f
.
h—d
;†e;†ğË->
Ãxt
) {

425 
vidft_’c_¡
 *
¡
 = 
Ë
->
d©a
;

427 ià(
¡
->
vf
 && st->vf->
’ch
)

428 
”r
 |ğ
¡
->
vf
->
	`’ch
(¡, 
äame
);

431 
uÆock
:

432 
	`lock_»l
(
vtx
->
lock
);

434 ià(
”r
)

438 
”r
 = 
vtx
->
vc
->
	`’ch
(vtx->
’c
, vtx->
picup
, 
äame
);

439 ià(
”r
)

442 
vtx
->
picup
 = 
çl£
;

443 
	}
}

454 
	$vid¤c_äame_hªdËr
(
vidäame
 *
äame
, *
¬g
)

456 
vtx
 *vtx = 
¬g
;

458 ++
vtx
->
äames
;

461 ià(
vtx
->
mu‹d
)

462 
äame
 = 
vtx
->
mu‹_äame
;

464 ià(
vtx
->
mu‹d
 && vtx->
mu‹d_äames
 >ğ
MAX_MUTED_FRAMES
)

468 
	`’code_¹p_£nd
(
vtx
, 
äame
);

469 
vtx
->
mu‹d_äames
++;

470 
	}
}

473 
	$vid¤c_”rÜ_hªdËr
(
”r
, *
¬g
)

475 
vtx
 *vtx = 
¬g
;

477 
	`w¬nšg
("video: video-sourûƒ¼Ü: %m\n", 
”r
);

479 
vtx
->
v¤c
 = 
	`mem_d”ef
(vtx->vsrc);

480 
	}
}

483 
	$vtx_®loc
(
vtx
 *vtx, 
video
 *video)

485 
”r
;

487 
”r
 = 
	`lock_®loc
(&
vtx
->
lock
);

488 
”r
 |ğ
	`lock_®loc
(&
vtx
->
lock_tx
);

489 ià(
”r
)

490  
”r
;

492 
	`tmr_š™
(&
vtx
->
tmr_¹p
);

494 
vtx
->
video
 = video;

497 
vtx
->
ts_off£t
 = 
	`¿nd_u16
();

499 
	`¡r_nıy
(
vtx
->
deviû
, 
video
->
cfg
.
¤c_dev
, (vtx->device));

501 
	`tmr_¡¬t
(&
vtx
->
tmr_¹p
, 1, 
¹p_tmr_hªdËr
, vtx);

503 
vtx
->
ts_mš
 = ~0;

505  
”r
;

506 
	}
}

509 
	$vrx_®loc
(
vrx
 *vrx, 
video
 *video)

511 
”r
;

513 
”r
 = 
	`lock_®loc
(&
vrx
->
lock
);

514 ià(
”r
)

515  
”r
;

517 
vrx
->
video
 = video;

518 
vrx
->
±_rx
 = -1;

519 
vrx
->
Ü›Á
 = 
VIDORIENT_PORTRAIT
;

521 
	`¡r_nıy
(
vrx
->
deviû
, 
video
->
cfg
.
di¥_dev
, (vrx->device));

523 
vrx
->
ts_mš
 = ~0;

525  
”r
;

526 
	}
}

529 
	$picup_tmr_hªdËr
(*
¬g
)

531 
vrx
 *vrx = 
¬g
;

533 
	`»que¡_piùu»_upd©e
(
vrx
);

534 
	}
}

537 
	$»que¡_piùu»_upd©e
(
vrx
 *vrx)

539 
video
 *
v
 = 
vrx
->video;

541 ià(
	`tmr_i¤uÂšg
(&
vrx
->
tmr_picup
))

544 
	`tmr_¡¬t
(&
vrx
->
tmr_picup
, 
PICUP_INTERVAL
, 
picup_tmr_hªdËr
, vrx);

547 
	`¡»am_£nd_fœ
(
v
->
¡rm
, v->
Çck_¶i
);

551 ++
vrx
->
n_picup
;

552 
	}
}

566 
	$video_¡»am_decode
(
vrx
 *vrx, cÚ¡ 
¹p_h—d”
 *
hdr
,

567 
mbuf
 *
mb
)

569 
video
 *
v
 = 
vrx
->video;

570 
vidäame
 *
äame_ft
 = 
NULL
;

571 
vidäame
 
äame_¡Üe
, *
äame
 = &frame_store;

572 
Ë
 *le;

573 
boŞ
 
šŒa
;

574 
”r
 = 0;

576 ià(!
hdr
 || !
	`mbuf_g‘_Ëá
(
mb
))

579 
	`lock_wr™e_g‘
(
vrx
->
lock
);

582 ià(!
vrx
->
dec
) {

583 
	`w¬nšg
("video: No video decoder!\n");

584 
out
;

589 ià(
hdr
->
ts
 < 
vrx
->
ts_mš
)

590 
vrx
->
ts_mš
 = 
hdr
->
ts
;

591 ià(
hdr
->
ts
 > 
vrx
->
ts_max
)

592 
vrx
->
ts_max
 = 
hdr
->
ts
;

594 
äame
->
d©a
[0] = 
NULL
;

595 
”r
 = 
vrx
->
vc
->
	`dech
(vrx->
dec
, 
äame
, &
šŒa
, 
hdr
->
m
, hdr->
£q
, 
mb
);

596 ià(
”r
) {

598 ià(
”r
 !ğ
EPROTO
) {

599 
	`w¬nšg
("video: %s decodeƒrror"

601 
vrx
->
vc
->
Çme
, 
hdr
->
£q
,

602 
	`mbuf_g‘_Ëá
(
mb
), 
”r
);

605 
	`»que¡_piùu»_upd©e
(
vrx
);

607 
out
;

610 ià(
šŒa
) {

611 
	`tmr_ÿnûl
(&
vrx
->
tmr_picup
);

612 ++
vrx
->
n_šŒa
;

616 ià(!
	`vidäame_isv®id
(
äame
))

617 
out
;

619 
vrx
->
size
 = 
äame
->size;

621 ià(!
	`li¡_i£m±y
(&
vrx
->
f
)) {

623 
”r
 = 
	`vidäame_®loc
(&
äame_ft
, 
äame
->
fmt
, &äame->
size
);

624 ià(
”r
)

625 
out
;

627 
	`vidäame_cİy
(
äame_ft
, 
äame
);

629 
äame
 = 
äame_ft
;

633 
Ë
 = 
vrx
->
f
.
h—d
;†e;†ğË->
Ãxt
) {

635 
vidft_dec_¡
 *
¡
 = 
Ë
->
d©a
;

637 ià(
¡
->
vf
 && st->vf->
dech
)

638 
”r
 |ğ
¡
->
vf
->
	`dech
(¡, 
äame
);

641 
”r
 = 
	`vidi¥_di¥Ïy
(
vrx
->
vidi¥
, 
v
->
³”
, 
äame
);

642 
äame_ft
 = 
	`mem_d”ef
(frame_filt);

643 ià(
”r
 =ğ
ENODEV
) {

644 
	`w¬nšg
("video: video-display was closed\n");

645 
vrx
->
vidi¥
 = 
	`mem_d”ef
(vrx->vidisp);

647 
	`lock_»l
(
vrx
->
lock
);

649 ià(
v
->
”rh
) {

650 
v
->
	`”rh
(
”r
, "di¥Ïy clo£d", v->
¬g
);

653  
”r
;

656 ++
vrx
->
äames
;

658 
out
:

659 
	`lock_»l
(
vrx
->
lock
);

661  
”r
;

662 
	}
}

665 
	$±_hªdËr
(
video
 *
v
, 
ušt8_t
 
±_Şd
, ušt8_ˆ
±_Ãw
)

667 cÚ¡ 
sdp_fÜm©
 *
lc
;

669 
lc
 = 
	`sdp_medŸ_lfÜm©
(
	`¡»am_sdpmedŸ
(
v
->
¡rm
), 
±_Ãw
);

670 ià(!
lc
)

671  
ENOENT
;

673 ià(
±_Şd
 !ğ(
ušt8_t
)-1) {

674 
	`šfo
("Video decoder changed…ayload %u -> %u\n",

675 
±_Şd
, 
±_Ãw
);

678 
v
->
vrx
.
±_rx
 = 
±_Ãw
;

680  
	`video_decod”_£t
(
v
, 
lc
->
d©a
,†c->
±
,†c->
½¬ams
);

681 
	}
}

685 
	$¡»am_»cv_hªdËr
(cÚ¡ 
¹p_h—d”
 *
hdr
,

686 
¹³xt
 *
extv
, 
size_t
 
extc
,

687 
mbuf
 *
mb
, *
¬g
)

689 
video
 *
v
 = 
¬g
;

690 
”r
;

691 ()
extv
;

692 ()
extc
;

694 ià(!
mb
)

695 
out
;

698 ià(
hdr
->
±
 =ğ
v
->
vrx
.
±_rx
)

699 
out
;

701 
”r
 = 
	`±_hªdËr
(
v
, v->
vrx
.
±_rx
, 
hdr
->
±
);

702 ià(
”r
)

705 
out
:

706 ()
	`video_¡»am_decode
(&
v
->
vrx
, 
hdr
, 
mb
);

707 
	}
}

710 
	$¹ı_hªdËr
(
¹ı_msg
 *
msg
, *
¬g
)

712 
video
 *
v
 = 
¬g
;

714 
msg
->
hdr
.
±
) {

716 
RTCP_FIR
:

717 
v
->
vtx
.
picup
 = 
Œue
;

720 
RTCP_PSFB
:

721 ià(
msg
->
hdr
.
couÁ
 =ğ
RTCP_PSFB_PLI
)

722 
v
->
vtx
.
picup
 = 
Œue
;

725 
RTCP_RTPFB
:

726 ià(
msg
->
hdr
.
couÁ
 =ğ
RTCP_RTPFB_GNACK
)

727 
v
->
vtx
.
picup
 = 
Œue
;

733 
	}
}

736 
	$vtx_´št_p–še
(
»_´štf
 *
pf
, cÚ¡ 
vtx
 *vtx)

738 
Ë
 *le;

739 
vid¤c
 *
vs
;

740 
”r
;

742 ià(!
vtx
)

745 
vs
 = 
	`vid¤c_g‘
(
vtx
->
v¤c
);

747 
”r
 = 
	`»_h´štf
(
pf
, "videox…ipeline: %10s",

748 
vs
 ? vs->
Çme
 : "src");

750 
Ë
 = 
	`li¡_h—d
(&
vtx
->
f
);†e;†ğË->
Ãxt
) {

751 
vidft_’c_¡
 *
¡
 = 
Ë
->
d©a
;

753 ià(
¡
->
vf
->
’ch
)

754 
”r
 |ğ
	`»_h´štf
(
pf
, " ---> %s", 
¡
->
vf
->
Çme
);

757 
”r
 |ğ
	`»_h´štf
(
pf
, " ---> %s\n",

758 
vtx
->
vc
 ? vtx->vc->
Çme
 : "encoder");

760  
”r
;

761 
	}
}

764 
	$vrx_´št_p–še
(
»_´štf
 *
pf
, cÚ¡ 
vrx
 *vrx)

766 
Ë
 *le;

767 
vidi¥
 *
vd
;

768 
”r
;

770 ià(!
vrx
)

773 
vd
 = 
	`vidi¥_g‘
(
vrx
->
vidi¥
);

775 
”r
 = 
	`»_h´štf
(
pf
, "video„x…ipeline: %10s",

776 
vd
 ? vd->
Çme
 : "disp");

778 
Ë
 = 
	`li¡_h—d
(&
vrx
->
f
);†e;†ğË->
Ãxt
) {

779 
vidft_dec_¡
 *
¡
 = 
Ë
->
d©a
;

781 ià(
¡
->
vf
->
dech
)

782 
”r
 |ğ
	`»_h´štf
(
pf
, " <--- %s", 
¡
->
vf
->
Çme
);

785 
”r
 |ğ
	`»_h´štf
(
pf
, " <--- %s\n",

786 
vrx
->
vc
 ? vrx->vc->
Çme
 : "decoder");

788  
”r
;

789 
	}
}

792 
	$video_®loc
(
video
 **
vp
, cÚ¡ 
¡»am_·¿m
 *
¡»am_´m
,

793 cÚ¡ 
cÚfig
 *
cfg
,

794 
ÿÎ
 *ÿÎ, 
sdp_£ssiÚ
 *
sdp_£ss
, 
Ïb–
,

795 cÚ¡ 
mÇt
 *mÇt, 
mÇt_£ss
 *mnat_sess,

796 cÚ¡ 
m’c
 *m’c, 
m’c_£ss
 *menc_sess,

797 cÚ¡ *
cÚ‹Á
, cÚ¡ 
li¡
 *
vidcodeş
,

798 
video_”r_h
 *
”rh
, *
¬g
)

800 
video
 *
v
;

801 
Ë
 *le;

802 
”r
 = 0;

804 ià(!
vp
 || !
cfg
)

805  
EINVAL
;

807 
v
 = 
	`mem_z®loc
((*v), 
video_de¡ruùÜ
);

808 ià(!
v
)

809  
ENOMEM
;

811 
	`MAGIC_INIT
(
v
);

813 
v
->
cfg
 = cfg->
video
;

814 
	`tmr_š™
(&
v
->
tmr
);

816 
”r
 = 
	`¡»am_®loc
(&
v
->
¡rm
, 
¡»am_´m
,

817 &
cfg
->
avt
, 
ÿÎ
, 
sdp_£ss
, "video", 
Ïb–
,

818 
mÇt
, 
mÇt_£ss
, 
m’c
, 
m’c_£ss
,

819 
	`ÿÎ_loÿluri
(
ÿÎ
),

820 
¡»am_»cv_hªdËr
, 
¹ı_hªdËr
, 
v
);

821 ià(
”r
)

822 
out
;

824 ià(
cfg
->
avt
.
¹p_bw
.
max
 >ğ
AUDIO_BANDWIDTH
) {

825 
	`¡»am_£t_bw
(
v
->
¡rm
, 
cfg
->
avt
.
¹p_bw
.
max
 - 
AUDIO_BANDWIDTH
);

828 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
v
->
¡rm
), 
Œue
,

829 "äam”©e", "%d", 
v
->
cfg
.
ås
);

832 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
v
->
¡rm
), 
Œue
,

836 ià(
cÚ‹Á
) {

837 
”r
 |ğ
	`sdp_medŸ_£t_Ï‰r
(
	`¡»am_sdpmedŸ
(
v
->
¡rm
), 
Œue
,

838 "cÚ‹Á", "%s", 
cÚ‹Á
);

841 ià(
”r
)

842 
out
;

844 
v
->
”rh
 =ƒrrh;

845 
v
->
¬g
 =‡rg;

847 
”r
 = 
	`vtx_®loc
(&
v
->
vtx
, v);

848 
”r
 |ğ
	`vrx_®loc
(&
v
->
vrx
, v);

849 ià(
”r
)

850 
out
;

853 
Ë
 = 
	`li¡_h—d
(
vidcodeş
);†e;†ğË->
Ãxt
) {

854 
vidcodec
 *
vc
 = 
Ë
->
d©a
;

855 
”r
 |ğ
	`sdp_fÜm©_add
(
NULL
, 
	`¡»am_sdpmedŸ
(
v
->
¡rm
), 
çl£
,

856 
vc
->
±
, vc->
Çme
, 90000, 1,

857 
vc
->
fm_’ch
, vc->
fm_cmph
, vc, 
çl£
,

858 "%s", 
vc
->
fm
);

862 
Ë
 = 
	`li¡_h—d
(
	`b¬es_vidf
());†e;†ğË->
Ãxt
) {

863 
vidft
 *
vf
 = 
Ë
->
d©a
;

864 *
ùx
 = 
NULL
;

866 
”r
 |ğ
	`vidft_’c_­³nd
(&
v
->
vtx
.
f
, &
ùx
, 
vf
);

867 
”r
 |ğ
	`vidft_dec_­³nd
(&
v
->
vrx
.
f
, &
ùx
, 
vf
);

868 ià(
”r
) {

869 
	`w¬nšg
("video: video-filter '%s' failed (%m)\n",

870 
vf
->
Çme
, 
”r
);

875 
out
:

876 ià(
”r
)

877 
	`mem_d”ef
(
v
);

879 *
vp
 = 
v
;

881  
”r
;

882 
	}
}

885 
	$vidi¥_»size_hªdËr
(cÚ¡ 
vidsz
 *
sz
, *
¬g
)

887 
vrx
 *vrx = 
¬g
;

888 ()
vrx
;

890 
	`šfo
("video: di¥Ïy„esized: %u x %u\n", 
sz
->
w
, sz->
h
);

893 
	}
}

897 
	$£t_vidi¥
(
vrx
 *vrx)

899 
vidi¥
 *
vd
;

901 
vrx
->
vidi¥
 = 
	`mem_d”ef
(vrx->vidisp);

902 
vrx
->
vidi¥_´m
.
v›w
 = 
NULL
;

903 
vrx
->
vidi¥_´m
.
fuÎsü“n
 = vrx->
video
->
cfg
.fullscreen;

905 
vd
 = (
vidi¥
 *)
	`vidi¥_fšd
(
	`b¬es_vidi¥l
(),

906 
vrx
->
video
->
cfg
.
di¥_mod
);

907 ià(!
vd
)

908  
ENOENT
;

910  
vd
->
	`®loch
(&
vrx
->
vidi¥
, vd, &vrx->
vidi¥_´m
, vrx->
deviû
,

911 
vidi¥_»size_hªdËr
, 
vrx
);

912 
	}
}

916 
	$£t_’cod”_fÜm©
(
vtx
 *vtx, cÚ¡ *
¤c
,

917 cÚ¡ *
dev
, 
vidsz
 *
size
)

919 
vid¤c
 *
vs
 = (vid¤ø*)
	`vid¤c_fšd
(
	`b¬es_vid¤ş
(),

920 
¤c
);

921 
”r
;

923 ià(!
vs
)

924  
ENOENT
;

926 
vtx
->
v¤c_size
 = *
size
;

927 
vtx
->
v¤c_´m
.
ås
 = 
	`g‘_ås
(vtx->
video
);

928 
vtx
->
v¤c_´m
.
Ü›Á
 = 
VIDORIENT_PORTRAIT
;

930 
vtx
->
v¤c
 = 
	`mem_d”ef
(vtx->vsrc);

932 
”r
 = 
vs
->
	`®loch
(&
vtx
->
v¤c
, vs, 
NULL
, &vtx->
v¤c_´m
,

933 &
vtx
->
v¤c_size
, 
NULL
, 
dev
, 
vid¤c_äame_hªdËr
,

934 
vid¤c_”rÜ_hªdËr
, 
vtx
);

935 ià(
”r
) {

936 
	`šfo
("video:‚ØvideØsourû '%s': %m\n", 
¤c
, 
”r
);

937  
”r
;

940 
vtx
->
mu‹_äame
 = 
	`mem_d”ef
(vtx->mute_frame);

941 
”r
 = 
	`vidäame_®loc
(&
vtx
->
mu‹_äame
, 
VIDENC_INTERNAL_FMT
, 
size
);

942 ià(
”r
)

943  
”r
;

945 
	`vidäame_fl
(
vtx
->
mu‹_äame
, 0xff, 0xff, 0xff);

947  
”r
;

948 
	}
}

951 ’um {
	mTMR_INTERVAL
 = 5};

952 
	$tmr_hªdËr
(*
¬g
)

954 
video
 *
v
 = 
¬g
;

956 
	`tmr_¡¬t
(&
v
->
tmr
, 
TMR_INTERVAL
 * 1000, 
tmr_hªdËr
, v);

959 
v
->
vtx
.
eås
 = v->vtx.
äames
 / 
TMR_INTERVAL
;

960 
v
->
vrx
.
eås
 = v->vrx.
äames
 / 
TMR_INTERVAL
;

962 
v
->
vtx
.
äames
 = 0;

963 
v
->
vrx
.
äames
 = 0;

964 
	}
}

967 
	$video_¡¬t
(
video
 *
v
, cÚ¡ *
³”
)

969 
vidsz
 
size
;

970 
”r
;

972 ià(!
v
)

973  
EINVAL
;

975 ià(
³”
) {

976 
	`mem_d”ef
(
v
->
³”
);

977 
”r
 = 
	`¡r_dup
(&
v
->
³”
,…eer);

978 ià(
”r
)

979  
”r
;

982 
	`¡»am_£t_¤©e
(
v
->
¡rm
, 
VIDEO_SRATE
, VIDEO_SRATE);

984 ià(
	`vidi¥_fšd
(
	`b¬es_vidi¥l
(), 
NULL
)) {

985 
”r
 = 
	`£t_vidi¥
(&
v
->
vrx
);

986 ià(
”r
) {

987 
	`w¬nšg
("video: could‚ot set vidisp '%s': %m\n",

988 
v
->
vrx
.
deviû
, 
”r
);

992 
	`šfo
("video:‚o video display\n");

995 ià(
	`vid¤c_fšd
(
	`b¬es_vid¤ş
(), 
NULL
)) {

996 
size
.
w
 = 
v
->
cfg
.
width
;

997 
size
.
h
 = 
v
->
cfg
.
height
;

998 
”r
 = 
	`£t_’cod”_fÜm©
(&
v
->
vtx
, v->
cfg
.
¤c_mod
,

999 
v
->
vtx
.
deviû
, &
size
);

1000 ià(
”r
) {

1001 
	`w¬nšg
("video: could‚ot setƒncoder formato"

1003 
size
.
w
, size.
h
, 
”r
);

1007 
	`šfo
("video:‚o video source\n");

1010 
	`tmr_¡¬t
(&
v
->
tmr
, 
TMR_INTERVAL
 * 1000, 
tmr_hªdËr
, v);

1012 ià(
v
->
vtx
.
vc
 && v->
vrx
.vc) {

1013 
	`šfo
("%H%H",

1014 
vtx_´št_p–še
, &
v
->
vtx
,

1015 
vrx_´št_p–še
, &
v
->
vrx
);

1018 
v
->
¡¬‹d
 = 
Œue
;

1021 
	}
}

1024 
	$video_¡İ
(
video
 *
v
)

1026 ià(!
v
)

1029 
	`debug
("video: stopping video source ..\n");

1031 
v
->
¡¬‹d
 = 
çl£
;

1032 
v
->
vtx
.
v¤c
 = 
	`mem_d”ef
(v->vtx.vsrc);

1033 
	}
}

1036 
boŞ
 
	$video_is_¡¬‹d
(cÚ¡ 
video
 *
v
)

1038  
v
 ? v->
¡¬‹d
 : 
çl£
;

1039 
	}
}

1048 
	$video_mu‹
(
video
 *
v
, 
boŞ
 
mu‹d
)

1050 
vtx
 *vtx;

1052 ià(!
v
)

1055 
vtx
 = &
v
->vtx;

1057 
vtx
->
mu‹d
 = muted;

1058 
vtx
->
mu‹d_äames
 = 0;

1059 
vtx
->
picup
 = 
Œue
;

1061 
	`video_upd©e_piùu»
(
v
);

1062 
	}
}

1065 
	$vidi¥_upd©e
(
vrx
 *vrx)

1067 
vidi¥
 *
vd
 = 
	`vidi¥_g‘
(
vrx
->vidisp);

1068 
”r
 = 0;

1070 ià(
vd
->
upd©eh
) {

1071 
”r
 = 
vd
->
	`upd©eh
(
vrx
->
vidi¥
, vrx->
vidi¥_´m
.
fuÎsü“n
,

1072 
vrx
->
Ü›Á
, 
NULL
);

1075  
”r
;

1076 
	}
}

1087 
	$video_£t_fuÎsü“n
(
video
 *
v
, 
boŞ
 
fs
)

1089 ià(!
v
)

1090  
EINVAL
;

1092 
v
->
vrx
.
vidi¥_´m
.
fuÎsü“n
 = 
fs
;

1094  
	`vidi¥_upd©e
(&
v
->
vrx
);

1095 
	}
}

1098 
	$vid¤c_upd©e
(
vtx
 *vtx, cÚ¡ *
dev
)

1100 
vid¤c
 *
vs
 = 
	`vid¤c_g‘
(
vtx
->
v¤c
);

1102 ià(
vs
 && vs->
upd©eh
)

1103 
vs
->
	`upd©eh
(
vtx
->
v¤c
, &vtx->
v¤c_´m
, 
dev
);

1104 
	}
}

1115 
	$video_£t_Ü›Á
(
video
 *
v
, 
Ü›Á
)

1117 ià(!
v
)

1118  
EINVAL
;

1120 
v
->
vtx
.
v¤c_´m
.
Ü›Á
 = v->
vrx
.orient = orient;

1121 
	`vid¤c_upd©e
(&
v
->
vtx
, 
NULL
);

1122  
	`vidi¥_upd©e
(&
v
->
vrx
);

1123 
	}
}

1126 
	$video_’cod”_£t
(
video
 *
v
, 
vidcodec
 *
vc
,

1127 
±_tx
, cÚ¡ *
·¿ms
)

1129 
vtx
 *vtx;

1130 
”r
 = 0;

1132 ià(!
v
)

1133  
EINVAL
;

1135 
vtx
 = &
v
->vtx;

1137 ià(!
vc
->
’cupdh
) {

1138 
	`šfo
("video: vidcodeø'%s' ha nØ’cod”\n", 
vc
->
Çme
);

1139  
ENOENT
;

1142 ià(
vc
 !ğ
vtx
->vc) {

1144 
vid’c_·¿m
 
´m
;

1146 
´m
.
b™¿‹
 = 
v
->
cfg
.bitrate;

1147 
´m
.
pktsize
 = 1024;

1148 
´m
.
ås
 = 
	`g‘_ås
(
v
);

1149 
´m
.
max_fs
 = -1;

1151 
	`šfo
("Set videoƒncoder: %s %s (%u bit/s, %u fps)\n",

1152 
vc
->
Çme
, vc->
v¬ŸÁ
, 
´m
.
b™¿‹
,…rm.
ås
);

1154 
vtx
->
’c
 = 
	`mem_d”ef
(vtx->enc);

1155 
”r
 = 
vc
->
	`’cupdh
(&
vtx
->
’c
, vc, &
´m
, 
·¿ms
,

1156 
·ck‘_hªdËr
, 
vtx
);

1157 ià(
”r
) {

1158 
	`w¬nšg
("video:ƒncod”‡Îoc: %m\n", 
”r
);

1159  
”r
;

1162 
vtx
->
vc
 = vc;

1165 
	`¡»am_upd©e_’cod”
(
v
->
¡rm
, 
±_tx
);

1167  
”r
;

1168 
	}
}

1171 
	$video_decod”_£t
(
video
 *
v
, 
vidcodec
 *
vc
, 
±_rx
,

1172 cÚ¡ *
fm
)

1174 
vrx
 *vrx;

1175 
”r
 = 0;

1177 ià(!
v
)

1178  
EINVAL
;

1181 ià(!
vc
->
decupdh
) {

1182 
li¡
 *
vidcodeş
 = 
	`b¬es_vidcodeş
();

1183 
vidcodec
 *
vcd
;

1185 
	`šfo
("video: vidcodeø'%s' ha nØdecod”\n", 
vc
->
Çme
);

1187 
vcd
 = (
vidcodec
 *)
	`vidcodec_fšd_decod”
(
vidcodeş
,

1188 
vc
->
Çme
);

1189 ià(!
vcd
) {

1190 
	`w¬nšg
("video: could‚ot find decoder (%s)\n",

1191 
vc
->
Çme
);

1192  
ENOENT
;

1195 
vc
 = 
vcd
;

1198 
vrx
 = &
v
->vrx;

1200 
vrx
->
±_rx
 =…t_rx;

1202 ià(
vc
 !ğ
vrx
->vc) {

1204 
	`šfo
("S‘ videØdecod”: % %s\n", 
vc
->
Çme
, vc->
v¬ŸÁ
);

1206 
vrx
->
dec
 = 
	`mem_d”ef
(vrx->dec);

1208 
”r
 = 
vc
->
	`decupdh
(&
vrx
->
dec
, vc, 
fm
);

1209 ià(
”r
) {

1210 
	`w¬nšg
("video: decod”‡Îoc: %m\n", 
”r
);

1211  
”r
;

1214 
vrx
->
vc
 = vc;

1217  
”r
;

1218 
	}
}

1226 
	$video_’cod”_cyşe
(
video
 *video)

1228 cÚ¡ 
sdp_fÜm©
 *
rc
 = 
NULL
;

1230 ià(!
video
)

1233 
rc
 = 
	`sdp_medŸ_fÜm©_cyşe
(
	`¡»am_sdpmedŸ
(
	`video_¡rm
(
video
)));

1234 ià(!
rc
) {

1235 
	`šfo
("cycle video:‚o„emote codec found\n");

1239 ()
	`video_’cod”_£t
(
video
, 
rc
->
d©a
,„c->
±
,„c->
·¿ms
);

1240 
	}
}

1243 
¡»am
 *
	$video_¡rm
(cÚ¡ 
video
 *
v
)

1245  
v
 ? v->
¡rm
 : 
NULL
;

1246 
	}
}

1249 
	$video_upd©e_piùu»
(
video
 *
v
)

1251 ià(!
v
)

1253 
v
->
vtx
.
picup
 = 
Œue
;

1254 
	}
}

1264 *
	$video_v›w
(cÚ¡ 
video
 *
v
)

1266 ià(!
v
)

1267  
NULL
;

1269  
v
->
vrx
.
vidi¥_´m
.
v›w
;

1270 
	}
}

1279 
	$video_vid¤c_£t_deviû
(
video
 *
v
, cÚ¡ *
dev
)

1281 ià(!
v
)

1284 
	`vid¤c_upd©e
(&
v
->
vtx
, 
dev
);

1285 
	}
}

1288 
boŞ
 
	$sd´©Œ_cÚšs
(
¡»am
 *
s
, cÚ¡ *
Çme
,

1289 cÚ¡ *
¡r
)

1291 cÚ¡ *
©Œ
 = 
	`sdp_medŸ_¿‰r
(
	`¡»am_sdpmedŸ
(
s
), 
Çme
);

1292  
©Œ
 ? (
NULL
 !ğ
	`¡r¡r
×‰r, 
¡r
)è: 
çl£
;

1293 
	}
}

1296 
	$video_sdp_©Œ_decode
(
video
 *
v
)

1298 ià(!
v
)

1302 
v
->
Çck_¶i
 = 
	`sd´©Œ_cÚšs
(v->
¡rm
, "rtcp-fb", "nack");

1303 
	}
}

1306 
	$vtx_debug
(
»_´štf
 *
pf
, cÚ¡ 
vtx
 *vtx)

1308 
”r
 = 0;

1310 
”r
 |ğ
	`»_h´štf
(
pf
, "x:ƒncode: %s %s\n",

1311 
vtx
->
vc
 ? vtx->vc->
Çme
 : "none",

1312 
vtx
->
äame
 ? 
	`vidfmt_Çme
(vtx->äame->
fmt
) : "?");

1313 
”r
 |ğ
	`»_h´štf
(
pf
, " source: %s %u x %u, fps=%d\n",

1314 
vtx
->
v¤c
 ? 
	`vid¤c_g‘
(vtx->v¤c)->
Çme
 : "none",

1315 
vtx
->
v¤c_size
.
w
,

1316 
vtx
->
v¤c_size
.
h
, vtx->
v¤c_´m
.
ås
);

1317 
”r
 |ğ
	`»_h´štf
(
pf
, " skc=%u\n", 
vtx
->
skc
);

1318 
”r
 |ğ
	`»_h´štf
(
pf
, "ime = %.3f sec\n",

1319 
	`video_ÿlc_£cÚds
(
vtx
->
ts_max
 - vtx->
ts_mš
));

1321  
”r
;

1322 
	}
}

1325 
	$vrx_debug
(
»_´štf
 *
pf
, cÚ¡ 
vrx
 *vrx)

1327 
”r
 = 0;

1329 
”r
 |ğ
	`»_h´štf
(
pf
, "„x: decode: %s\n",

1330 
vrx
->
vc
 ? vrx->vc->
Çme
 : "none");

1331 
”r
 |ğ
	`»_h´štf
(
pf
, " vidisp: %s %u x %u\n",

1332 
vrx
->
vidi¥
 ? 
	`vidi¥_g‘
(vrx->vidi¥)->
Çme
 : "none",

1333 
vrx
->
size
.
w
, vrx->size.
h
);

1334 
”r
 |ğ
	`»_h´štf
(
pf
, "‚_intra=%u,‚_picup=%u\n",

1335 
vrx
->
n_šŒa
, vrx->
n_picup
);

1336 
”r
 |ğ
	`»_h´štf
(
pf
, "ime = %.3f sec\n",

1337 
	`video_ÿlc_£cÚds
(
vrx
->
ts_max
 - vrx->
ts_mš
));

1339  
”r
;

1340 
	}
}

1343 
	$video_debug
(
»_´štf
 *
pf
, cÚ¡ 
video
 *
v
)

1345 cÚ¡ 
vtx
 *vtx;

1346 cÚ¡ 
vrx
 *vrx;

1347 
”r
;

1349 ià(!
v
)

1352 
vtx
 = &
v
->vtx;

1353 
vrx
 = &
v
->vrx;

1355 
”r
 = 
	`»_h´štf
(
pf
, "\n--- Video stream ---\n");

1356 
”r
 |ğ
	`»_h´štf
(
pf
, " s¹ed: %s\n", 
v
->
¡¬‹d
 ? "yes" : "no");

1358 
”r
 |ğ
	`vtx_debug
(
pf
, 
vtx
);

1359 
”r
 |ğ
	`vrx_debug
(
pf
, 
vrx
);

1360 ià(
”r
)

1361  
”r
;

1363 ià(!
	`li¡_i£m±y
(
	`b¬es_vidf
())) {

1364 
”r
 |ğ
	`vtx_´št_p–še
(
pf
, 
vtx
);

1365 
”r
 |ğ
	`vrx_´št_p–še
(
pf
, 
vrx
);

1368 
”r
 |ğ
	`¡»am_debug
(
pf
, 
v
->
¡rm
);

1370  
”r
;

1371 
	}
}

1374 
	$video_´št
(
»_´štf
 *
pf
, cÚ¡ 
video
 *
v
)

1376 ià(!
v
)

1379  
	`»_h´štf
(
pf
, "ƒås=%d/%d", 
v
->
vtx
.
eås
, v->
vrx
.efps);

1380 
	}
}

1383 
	$video_£t_sourû
(
video
 *
v
, cÚ¡ *
Çme
, cÚ¡ *
dev
)

1385 
vid¤c
 *
vs
 = (vid¤ø*)
	`vid¤c_fšd
(
	`b¬es_vid¤ş
(),

1386 
Çme
);

1387 
vtx
 *vtx;

1389 ià(!
v
)

1390  
EINVAL
;

1392 ià(!
vs
)

1393  
ENOENT
;

1395 
vtx
 = &
v
->vtx;

1397 
vtx
->
v¤c
 = 
	`mem_d”ef
(vtx->vsrc);

1399  
vs
->
	`®loch
(&
vtx
->
v¤c
, vs, 
NULL
, &vtx->
v¤c_´m
,

1400 &
vtx
->
v¤c_size
, 
NULL
, 
dev
,

1401 
vid¤c_äame_hªdËr
, 
vid¤c_”rÜ_hªdËr
, 
vtx
);

1402 
	}
}

1405 
	$video_£t_deviûÇme
(
video
 *
v
, cÚ¡ *
¤c
, cÚ¡ *
di¥
)

1407 ià(!
v
)

1410 
	`¡r_nıy
(
v
->
vtx
.
deviû
, 
¤c
, (v->vtx.device));

1411 
	`¡r_nıy
(
v
->
vrx
.
deviû
, 
di¥
, (v->vrx.device));

1412 
	}
}

	@baresip/src/vidfilt.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

17 
	$vidft_»gi¡”
(
li¡
 *
vidf
, 
vidft
 *
vf
)

19 ià(!
vf
)

22 
	`li¡_­³nd
(
vidf
, &
vf
->
Ë
, vf);

24 
	`šfo
("vidft: %s\n", 
vf
->
Çme
);

25 
	}
}

33 
	$vidft_uÄegi¡”
(
vidft
 *
vf
)

35 ià(!
vf
)

38 
	`li¡_uÆšk
(&
vf
->
Ë
);

39 
	}
}

42 
	$vidft_’c_de¡ruùÜ
(*
¬g
)

44 
vidft_’c_¡
 *
¡
 = 
¬g
;

46 
	`li¡_uÆšk
(&
¡
->
Ë
);

47 
	}
}

50 
	$vidft_’c_­³nd
(
li¡
 *
f
, **
ùx
,

51 cÚ¡ 
vidft
 *
vf
)

53 
vidft_’c_¡
 *
¡
 = 
NULL
;

54 
”r
;

56 ià(
vf
->
’cupdh
) {

57 
”r
 = 
vf
->
	`’cupdh
(&
¡
, 
ùx
, vf);

58 ià(
”r
)

59  
”r
;

62 
¡
 = 
	`mem_z®loc
((*¡), 
vidft_’c_de¡ruùÜ
);

63 ià(!
¡
)

64  
ENOMEM
;

67 
¡
->
vf
 = vf;

68 
	`li¡_­³nd
(
f
, &
¡
->
Ë
, st);

71 
	}
}

74 
	$vidft_dec_de¡ruùÜ
(*
¬g
)

76 
vidft_dec_¡
 *
¡
 = 
¬g
;

78 
	`li¡_uÆšk
(&
¡
->
Ë
);

79 
	}
}

82 
	$vidft_dec_­³nd
(
li¡
 *
f
, **
ùx
,

83 cÚ¡ 
vidft
 *
vf
)

85 
vidft_dec_¡
 *
¡
 = 
NULL
;

86 
”r
;

88 ià(
vf
->
decupdh
) {

89 
”r
 = 
vf
->
	`decupdh
(&
¡
, 
ùx
, vf);

90 ià(
”r
)

91  
”r
;

94 
¡
 = 
	`mem_z®loc
((*¡), 
vidft_dec_de¡ruùÜ
);

95 ià(!
¡
)

96  
ENOMEM
;

99 
¡
->
vf
 = vf;

100 
	`li¡_­³nd
(
f
, &
¡
->
Ë
, st);

103 
	}
}

	@baresip/src/vidisp.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"cÜe.h
"

12 
	svidi¥_¡
 {

13 
vidi¥
 *
	mvd
;

17 
	$de¡ruùÜ
(*
¬g
)

19 
vidi¥
 *
vd
 = 
¬g
;

21 
	`li¡_uÆšk
(&
vd
->
Ë
);

22 
	}
}

38 
	$vidi¥_»gi¡”
(
vidi¥
 **
vp
, 
li¡
 *
vidi¥l
, cÚ¡ *
Çme
,

39 
vidi¥_®loc_h
 *
®loch
, 
vidi¥_upd©e_h
 *
upd©eh
,

40 
vidi¥_di¥_h
 *
di¥h
, 
vidi¥_hide_h
 *
hideh
)

42 
vidi¥
 *
vd
;

44 ià(!
vp
 || !
vidi¥l
)

45  
EINVAL
;

47 
vd
 = 
	`mem_z®loc
((*vd), 
de¡ruùÜ
);

48 ià(!
vd
)

49  
ENOMEM
;

51 
	`li¡_­³nd
(
vidi¥l
, &
vd
->
Ë
, vd);

53 
vd
->
Çme
 =‚ame;

54 
vd
->
®loch
 =‡lloch;

55 
vd
->
upd©eh
 = updateh;

56 
vd
->
di¥h
 = disph;

57 
vd
->
hideh
 = hideh;

59 
	`šfo
("vidi¥: %s\n", 
Çme
);

61 *
vp
 = 
vd
;

63 
	}
}

66 cÚ¡ 
vidi¥
 *
	$vidi¥_fšd
(cÚ¡ 
li¡
 *
vidi¥l
, cÚ¡ *
Çme
)

68 
Ë
 *le;

70 
Ë
 = 
	`li¡_h—d
(
vidi¥l
);†e;†ğË->
Ãxt
) {

71 
vidi¥
 *
vd
 = 
Ë
->
d©a
;

73 ià(
	`¡r_is£t
(
Çme
è&& 0 !ğ
	`¡r_ÿ£cmp
Òame, 
vd
->name))

77  
vd
;

80  
NULL
;

81 
	}
}

97 
	$vidi¥_®loc
(
vidi¥_¡
 **
¡p
, 
li¡
 *
vidi¥l
,

98 cÚ¡ *
Çme
,

99 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

100 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

102 
vidi¥
 *
vd
 = (vidi¥ *)
	`vidi¥_fšd
(
vidi¥l
, 
Çme
);

103 ià(!
vd
)

104  
ENOENT
;

106  
vd
->
	`®loch
(
¡p
, vd, 
´m
, 
dev
, 
»sizeh
, 
¬g
);

107 
	}
}

119 
	$vidi¥_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

120 cÚ¡ 
vidäame
 *
äame
)

122 ià(!
¡
 || !
äame
)

123  
EINVAL
;

125  
¡
->
vd
->
	`di¥h
(¡, 
t™Ë
, 
äame
);

126 
	}
}

129 
vidi¥
 *
	$vidi¥_g‘
(
vidi¥_¡
 *
¡
)

131  
¡
 ? st->
vd
 : 
NULL
;

132 
	}
}

	@baresip/src/vidsrc.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"cÜe.h
"

13 
	svid¤c_¡
 {

14 
vid¤c
 *
	mvs
;

18 
	$de¡ruùÜ
(*
¬g
)

20 
vid¤c
 *
vs
 = 
¬g
;

22 
	`li¡_uÆšk
(&
vs
->
Ë
);

23 
	}
}

37 
	$vid¤c_»gi¡”
(
vid¤c
 **
v¥
, 
li¡
 *
vid¤ş
,

38 cÚ¡ *
Çme
,

39 
vid¤c_®loc_h
 *
®loch
, 
vid¤c_upd©e_h
 *
upd©eh
)

41 
vid¤c
 *
vs
;

43 ià(!
v¥
 || !
vid¤ş
)

44  
EINVAL
;

46 
vs
 = 
	`mem_z®loc
((*vs), 
de¡ruùÜ
);

47 ià(!
vs
)

48  
ENOMEM
;

50 
	`li¡_­³nd
(
vid¤ş
, &
vs
->
Ë
, vs);

52 
vs
->
Çme
 =‚ame;

53 
vs
->
®loch
 =‡lloch;

54 
vs
->
upd©eh
 = updateh;

56 
	`šfo
("vid¤c: %s\n", 
Çme
);

58 *
v¥
 = 
vs
;

61 
	}
}

72 cÚ¡ 
vid¤c
 *
	$vid¤c_fšd
(cÚ¡ 
li¡
 *
vid¤ş
, cÚ¡ *
Çme
)

74 
Ë
 *le;

76 
Ë
=
	`li¡_h—d
(
vid¤ş
);†e;†eöe->
Ãxt
) {

78 
vid¤c
 *
vs
 = 
Ë
->
d©a
;

80 ià(
	`¡r_is£t
(
Çme
è&& 0 !ğ
	`¡r_ÿ£cmp
Òame, 
vs
->name))

83  
vs
;

86  
NULL
;

87 
	}
}

107 
	$vid¤c_®loc
(
vid¤c_¡
 **
¡p
, 
li¡
 *
vid¤ş
,

108 cÚ¡ *
Çme
,

109 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

110 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
, cÚ¡ *
dev
,

111 
vid¤c_äame_h
 *
äameh
, 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

113 
vid¤c
 *
vs
 = (vid¤ø*)
	`vid¤c_fšd
(
vid¤ş
, 
Çme
);

114 ià(!
vs
)

115  
ENOENT
;

117  
vs
->
	`®loch
(
¡p
, vs, 
ùx
, 
´m
, 
size
, 
fmt
, 
dev
,

118 
äameh
, 
”rÜh
, 
¬g
);

119 
	}
}

122 
vid¤c
 *
	$vid¤c_g‘
(
vid¤c_¡
 *
¡
)

124  
¡
 ? st->
vs
 : 
NULL
;

125 
	}
}

	@baresip/src/vidutil.c

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"cÜe.h
"

24 
ušt32_t
 
	$video_ÿlc_¹p_time¡amp
(
št64_t
 
±s
, 
ås
)

26 
ušt64_t
 
¹p_ts
;

28 ià(!
ås
)

31 
¹p_ts
 = ((
ušt64_t
)
VIDEO_SRATE
 * 
±s
è/ 
ås
;

33  (
ušt32_t
)
¹p_ts
;

34 
	}
}

44 
	$video_ÿlc_£cÚds
(
ušt32_t
 
¹p_ts
)

46 
time¡amp
;

49 
time¡amp
 = ()
¹p_ts
 / ()
VIDEO_SRATE
;

51  
time¡amp
;

52 
	}
}

	@baresip/test/account.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	#DEBUG_MODULE
 "accouÁ"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

17 cÚ¡ 
	g¡r
[] =

33 
	$‹¡_accouÁ
()

35 
accouÁ
 *
acc
 = 
NULL
;

36 
s_addr
 *
addr
;

37 
”r
 = 0;

39 
”r
 = 
	`accouÁ_®loc
(&
acc
, 
¡r
);

40 
	`TEST_ERR
(
”r
);

41 
	`ASSERT_TRUE
(
acc
 !ğ
NULL
);

44 
addr
 = 
	`accouÁ_Ïddr
(
acc
);

45 
	`ASSERT_TRUE
(
addr
 !ğ
NULL
);

46 
	`TEST_STRCMP
("M¸U£r", 7, 
addr
->
dÇme
.
p
,‡ddr->dÇme.
l
);

47 
	`TEST_STRCMP
("s", 3, 
addr
->
uri
.
scheme
.
p
,‡ddr->uri.scheme.
l
);

48 
	`TEST_STRCMP
("u£r", 4, 
addr
->
uri
.
u£r
.
p
,‡ddr->uri.u£r.
l
);

49 
	`TEST_STRCMP
("", 0, 
addr
->
uri
.
·sswÜd
.
p
,‡ddr->uri.·sswÜd.
l
);

50 
	`TEST_STRCMP
("domaš.com", 10, 
addr
->
uri
.
ho¡
.
p
,‡ddr->uri.ho¡.
l
);

51 
	`ASSERT_EQ
(0, 
addr
->
uri
.
·¿ms
.
l
);

52 
	`ASSERT_TRUE
(
addr
->
·¿ms
.
l
 > 0);

55 
	`ASSERT_TRUE
(
ANSWERMODE_AUTO
 =ğ
	`accouÁ_ªsw”mode
(
acc
));

56 
	`ASSERT_STREQ
("xu£r", 
	`accouÁ_auth_u£r
(
acc
));

57 
	`ASSERT_STREQ
("·ss", 
	`accouÁ_auth_·ss
(
acc
));

58 
	`ASSERT_STREQ
("s:edge.domaš.com", 
	`accouÁ_outbound
(
acc
, 0));

59 
	`ASSERT_TRUE
(
NULL
 =ğ
	`accouÁ_outbound
(
acc
, 1));

60 
	`ASSERT_TRUE
(
NULL
 =ğ
	`accouÁ_outbound
(
acc
, 333));

61 
	`ASSERT_EQ
(10, 
	`accouÁ_±ime
(
acc
));

62 
	`ASSERT_EQ
(600, 
	`accouÁ_»gšt
(
acc
));

63 
	`ASSERT_EQ
(700, 
	`accouÁ_pubšt
(
acc
));

64 
	`ASSERT_STREQ
("bob@bob.com", 
	`accouÁ_¡un_u£r
(
acc
));

65 
	`ASSERT_STREQ
("j:¯", 
	`accouÁ_¡un_·ss
(
acc
));

66 
	`ASSERT_STREQ
("¡un£rv”.Üg", 
	`accouÁ_¡un_ho¡
(
acc
));

68 
out
:

69 
	`mem_d”ef
(
acc
);

70  
”r
;

71 
	}
}

	@baresip/test/aulevel.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	#DEBUG_MODULE
 "auËv–"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

17 
	#PREC
 .6

	)

20 
	$‹¡_auËv–
()

23 
št16_t
 
§mpv
[2];

24 
Ëv–
;

25 } 
‹¡v
[] = {

46 
size_t
 
i
;

47 
”r
 = 0;

49 
i
=0; i<
	`ARRAY_SIZE
(
‹¡v
); i++) {

51 
Ëv–
;

53 
Ëv–
 = 
	`auËv–_ÿlc_dbov
(
‹¡v
[
i
].
§mpv
,

54 
	`ARRAY_SIZE
(
‹¡v
[
i
].
§mpv
));

56 
	`ASSERT_DOUBLE_EQ
(
‹¡v
[
i
].
Ëv–
,†ev–, 
PREC
);

59 
out
:

60  
”r
;

61 
	}
}

	@baresip/test/call.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m.h
>

9 
	~<b¬es.h
>

10 
	~"‹¡.h
"

13 
	#MAGIC
 0x7004ÿ11

	)

16 
	ebehaviour
 {

17 
	mBEHAVIOUR_ANSWER
 = 0,

18 
	mBEHAVIOUR_PROGRESS
,

19 
	mBEHAVIOUR_REJECT


22 
	eaùiÚ
 {

23 
	mACTION_RECANCEL
 = 0,

24 
	mACTION_HANGUP_A
,

25 
	mACTION_HANGUP_B
,

26 
	mACTION_NOTHING


29 
	sag’t
 {

30 
fixtu»
 *
	mfix
;

31 
ag’t
 *
	m³”
;

32 
ua
 *
	mua
;

33 
ušt16_t
 
	mşo£_scode
;

34 
boŞ
 
	mçed
;

36 
	mn_šcomšg
;

37 
	mn_´og»ss
;

38 
	mn_e¡ablished
;

39 
	mn_şo£d
;

40 
	mn_dtmf_»cv
;

43 
	sfixtu»
 {

44 
ušt32_t
 
	mmagic
;

45 
ag’t
 
	ma
, 
	mb
;

46 
§
 
	mÏddr_s
;

47 
behaviour
 
	mbehaviour
;

48 
aùiÚ
 
	me¡ab_aùiÚ
;

49 
	mburi
[256];

50 
	m”r
;

51 
	mexp_e¡ab
;

52 
	mexp_şo£d
;

56 
	#fixtu»_š™_´m
(
f
, 
´m
) \

57 
	`mem£t
(
f
, 0, (*f)); \

59 
f
->
a
.
fix
 = f; \

60 
f
->
b
.
fix
 = f; \

62 
”r
 = 
	`ua_š™
("‹¡", 
Œue
,rue,rue, 
çl£
); \

63 
	`TEST_ERR
(
”r
); \

65 
f
->
magic
 = 
MAGIC
; \

66 
f
->
exp_e¡ab
 = 1; \

67 
f
->
exp_şo£d
 = 1; \

68 
	`mock_aucodec_»gi¡”
(); \

70 
”r
 = 
	`ua_®loc
(&
f
->
a
.
ua
, \

71 "A <s:a@127.0.0.1>;»gšt=0" 
´m
); \

72 
	`TEST_ERR
(
”r
); \

73 
”r
 = 
	`ua_®loc
(&
f
->
b
.
ua
, \

74 "B <s:b@127.0.0.1>;»gšt=0" 
´m
); \

75 
	`TEST_ERR
(
”r
); \

77 
f
->
a
.
³”
 = &f->
b
; \

78 
f
->
b
.
³”
 = &f->
a
; \

80 
”r
 = 
	`uag_ev’t_»gi¡”
(
ev’t_hªdËr
, 
f
); \

81 
	`TEST_ERR
(
”r
); \

83 
”r
 = 
	`s_Œª¥_Ïddr
(
	`uag_s
(), &
f
->
Ïddr_s
, \

84 
SIP_TRANSP_UDP
, 
NULL
); \

85 
	`TEST_ERR
(
”r
); \

87 
	`»_¢´štf
(
f
->
buri
, (f->buri), "s:b@%J", &f->
Ïddr_s
);

	)

90 
	#fixtu»_š™
(
f
) \

91 
	`fixtu»_š™_´m
((
f
), "");

	)

94 
	#fixtu»_şo£
(
f
) \

95 
	`mem_d”ef
(
f
->
b
.
ua
); \

96 
	`mem_d”ef
(
f
->
a
.
ua
); \

98 
	`mock_aucodec_uÄegi¡”
(); \

100 
	`uag_ev’t_uÄegi¡”
(
ev’t_hªdËr
); \

102 
	`ua_¡İ_®l
(
Œue
); \

103 
	`ua_şo£
();

	)

105 
	#fixtu»_abÜt
(
f
, 
”rÜ
) \

107 (
f
)->
”r
 = (
”rÜ
); \

108 
	`»_ÿnûl
(); \

109 } 0)

	)

112 
	$ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

113 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

115 
fixtu»
 *
f
 = 
¬g
;

116 
ag’t
 *
ag
;

117 
”r
 = 0;

118 ()
´m
;

121 
	`šfo
("test: [ %s ]ƒvent: %s (%s)\n",

122 
	`ua_aÜ
(
ua
), 
	`uag_ev’t_¡r
(
ev
), 
´m
);

125 
	`ASSERT_TRUE
(
f
 !ğ
NULL
);

126 
	`ASSERT_EQ
(
MAGIC
, 
f
->
magic
);

128 ià(
ua
 =ğ
f
->
a
.ua)

129 
ag
 = &
f
->
a
;

130 ià(
ua
 =ğ
f
->
b
.ua)

131 
ag
 = &
f
->
b
;

136 
ev
) {

138 
UA_EVENT_CALL_INCOMING
:

139 ++
ag
->
n_šcomšg
;

141 
f
->
behaviour
) {

143 
BEHAVIOUR_ANSWER
:

144 
”r
 = 
	`ua_ªsw”
(
ua
, 
ÿÎ
);

145 ià(
”r
) {

146 
	`w¬nšg
("ua_ªsw” faed (%m)\n", 
”r
);

147 
out
;

151 
BEHAVIOUR_PROGRESS
:

152 
”r
 = 
	`ua_´og»ss
(
ua
, 
ÿÎ
);

153 ià(
”r
) {

154 
	`w¬nšg
("ua_´og»s çed (%m)\n", 
”r
);

155 
out
;

159 
BEHAVIOUR_REJECT
:

160 
	`ua_hªgup
(
ua
, 
ÿÎ
, 0, 0);

161 
ÿÎ
 = 
NULL
;

162 
ag
->
çed
 = 
Œue
;

170 
UA_EVENT_CALL_PROGRESS
:

171 ++
ag
->
n_´og»ss
;

173 
	`»_ÿnûl
();

176 
UA_EVENT_CALL_ESTABLISHED
:

177 ++
ag
->
n_e¡ablished
;

180 ià(
ag
->
n_e¡ablished
 >ğ
f
->
exp_e¡ab
 &&

181 
ag
->
³”
->
n_e¡ablished
 >ğ
f
->
exp_e¡ab
) {

183 
f
->
e¡ab_aùiÚ
) {

185 
ACTION_RECANCEL
:

186 
	`»_ÿnûl
();

189 
ACTION_HANGUP_A
:

190 
f
->
a
.
çed
 = 
Œue
;

191 
	`ua_hªgup
(
f
->
a
.
ua
, 
NULL
, 0, 0);

194 
ACTION_HANGUP_B
:

195 
f
->
b
.
çed
 = 
Œue
;

196 
	`ua_hªgup
(
f
->
b
.
ua
, 
NULL
, 0, 0);

199 
ACTION_NOTHING
:

206 
UA_EVENT_CALL_CLOSED
:

207 ++
ag
->
n_şo£d
;

209 
ag
->
şo£_scode
 = 
	`ÿÎ_scode
(
ÿÎ
);

211 ià(
ag
->
şo£_scode
)

212 
ag
->
çed
 = 
Œue
;

214 ià(
ag
->
n_şo£d
 >ğ
f
->
exp_şo£d
 &&

215 
ag
->
³”
->
n_şo£d
 >ğ
f
->
exp_şo£d
) {

217 
	`»_ÿnûl
();

225 ià(
ag
->
çed
 &&‡g->
³”
->failed) {

226 
	`šfo
("test:„e_cancel on call failed\n");

227 
	`»_ÿnûl
();

231 
out
:

232 ià(
”r
) {

233 
	`w¬nšg
("”rÜ iÀev’t-hªdË¸(%m)\n", 
”r
);

234 
f
->
”r
 =ƒrr;

235 
	`»_ÿnûl
();

237 
	}
}

240 
	$‹¡_ÿÎ_ªsw”
()

242 
fixtu»
 
fix
, *
f
 = &fix;

243 
”r
 = 0;

245 
	`fixtu»_š™
(
f
);

247 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

250 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

251 
	`TEST_ERR
(
”r
);

254 
”r
 = 
	`»_maš_timeout
(5000);

255 
	`TEST_ERR
(
”r
);

256 
	`TEST_ERR
(
fix
.
”r
);

258 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

259 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

260 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_şo£d
);

261 
	`ASSERT_EQ
(0, 
fix
.
a
.
şo£_scode
);

263 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_šcomšg
);

264 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

265 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_şo£d
);

267 
out
:

268 
	`fixtu»_şo£
(
f
);

270  
”r
;

271 
	}
}

274 
	$‹¡_ÿÎ_»jeù
()

276 
fixtu»
 
fix
, *
f
 = &fix;

277 
”r
 = 0;

279 
	`fixtu»_š™
(
f
);

281 
f
->
behaviour
 = 
BEHAVIOUR_REJECT
;

284 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

285 
	`TEST_ERR
(
”r
);

288 
”r
 = 
	`»_maš_timeout
(5000);

289 
	`TEST_ERR
(
”r
);

290 
	`TEST_ERR
(
fix
.
”r
);

292 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

293 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_e¡ablished
);

294 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

296 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_šcomšg
);

297 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_e¡ablished
);

299 
out
:

300 
	`fixtu»_şo£
(
f
);

302  
”r
;

303 
	}
}

306 
	$‹¡_ÿÎ_af_mism©ch
()

308 
fixtu»
 
fix
, *
f
 = &fix;

309 
”r
 = 0;

311 
	`fixtu»_š™
(
f
);

313 
	`ua_£t_medŸ_af
(
f
->
a
.
ua
, 
AF_INET6
);

314 
	`ua_£t_medŸ_af
(
f
->
b
.
ua
, 
AF_INET
);

317 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

318 
	`TEST_ERR
(
”r
);

321 
”r
 = 
	`»_maš_timeout
(5000);

322 
	`TEST_ERR
(
”r
);

323 
	`TEST_ERR
(
fix
.
”r
);

325 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

326 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_e¡ablished
);

327 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

328 
	`ASSERT_EQ
(488, 
fix
.
a
.
şo£_scode
);

330 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_šcomšg
);

331 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_e¡ablished
);

332 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_şo£d
);

334 
out
:

335 
	`fixtu»_şo£
(
f
);

337  
”r
;

338 
	}
}

341 
	$‹¡_ÿÎ_ªsw”_hªgup_a
()

343 
fixtu»
 
fix
, *
f
 = &fix;

344 
”r
 = 0;

346 
	`fixtu»_š™
(
f
);

348 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

349 
f
->
e¡ab_aùiÚ
 = 
ACTION_HANGUP_A
;

352 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

353 
	`TEST_ERR
(
”r
);

356 
”r
 = 
	`»_maš_timeout
(5000);

357 
	`TEST_ERR
(
”r
);

358 
	`TEST_ERR
(
fix
.
”r
);

360 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

361 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

362 
	`ASSERT_EQ
(0, 
fix
.
a
.
şo£_scode
);

364 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

365 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_şo£d
);

366 
	`ASSERT_EQ
(0, 
fix
.
b
.
şo£_scode
);

368 
out
:

369 
	`fixtu»_şo£
(
f
);

371  
”r
;

372 
	}
}

375 
	$‹¡_ÿÎ_ªsw”_hªgup_b
()

377 
fixtu»
 
fix
, *
f
 = &fix;

378 
”r
 = 0;

380 
	`fixtu»_š™
(
f
);

382 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

383 
f
->
e¡ab_aùiÚ
 = 
ACTION_HANGUP_B
;

386 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

387 
	`TEST_ERR
(
”r
);

390 
”r
 = 
	`»_maš_timeout
(5000);

391 
	`TEST_ERR
(
”r
);

392 
	`TEST_ERR
(
fix
.
”r
);

394 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

395 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

396 
	`ASSERT_EQ
(0, 
fix
.
a
.
şo£_scode
);

398 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

399 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_şo£d
);

400 
	`ASSERT_EQ
(0, 
fix
.
b
.
şo£_scode
);

402 
out
:

403 
	`fixtu»_şo£
(
f
);

405  
”r
;

406 
	}
}

409 
	$‹¡_ÿÎ_¹p_timeout
()

411 
	#RTP_TIMEOUT_MS
 1

	)

412 
fixtu»
 
fix
, *
f
 = &fix;

413 
ÿÎ
 *call;

414 
”r
 = 0;

416 
	`fixtu»_š™
(
f
);

418 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

419 
f
->
e¡ab_aùiÚ
 = 
ACTION_NOTHING
;

422 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

423 
	`TEST_ERR
(
”r
);

425 
ÿÎ
 = 
	`ua_ÿÎ
(
f
->
a
.
ua
);

426 
	`ASSERT_TRUE
(
ÿÎ
 !ğ
NULL
);

428 
	`ÿÎ_’abË_¹p_timeout
(
ÿÎ
, 
RTP_TIMEOUT_MS
);

431 
”r
 = 
	`»_maš_timeout
(5000);

432 
	`TEST_ERR
(
”r
);

433 
	`TEST_ERR
(
fix
.
”r
);

435 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

436 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

437 
	`ASSERT_EQ
(701, 
fix
.
a
.
şo£_scode
);

439 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

440 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_şo£d
);

441 
	`ASSERT_EQ
(0, 
fix
.
b
.
şo£_scode
);

443 
out
:

444 
	`fixtu»_şo£
(
f
);

446  
”r
;

447 
	}
}

451 
boŞ
 
	$lš’um_¬e_£qu’tŸl
(cÚ¡ 
ua
 *ua)

453 
ušt32_t
 
lš’um
 = 0;

454 
Ë
 *le;

456 
Ë
 = 
	`li¡_h—d
(
	`ua_ÿÎs
(
ua
)è;†;†ğË->
Ãxt
) {

457 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

459 ià(
	`ÿÎ_lš’um
(
ÿÎ
è<ğ
lš’um
)

460  
çl£
;

462 
lš’um
 = 
	`ÿÎ_lš’um
(
ÿÎ
);

465  
Œue
;

466 
	}
}

469 
	$‹¡_ÿÎ_muÉË
()

471 
fixtu»
 
fix
, *
f
 = &fix;

472 
Ë
 *le;

473 
i
;

474 
”r
 = 0;

476 
	`fixtu»_š™
(
f
);

478 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

479 
f
->
exp_e¡ab
 = 4;

484 
i
=0; i<4; i++) {

485 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

486 
	`TEST_ERR
(
”r
);

489 
”r
 = 
	`»_maš_timeout
(5000);

490 
	`TEST_ERR
(
”r
);

491 
	`TEST_ERR
(
fix
.
”r
);

493 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

494 
	`ASSERT_EQ
(4, 
fix
.
a
.
n_e¡ablished
);

495 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_şo£d
);

497 
	`ASSERT_EQ
(4, 
fix
.
b
.
n_šcomšg
);

498 
	`ASSERT_EQ
(4, 
fix
.
b
.
n_e¡ablished
);

499 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_şo£d
);

501 
	`ASSERT_EQ
(4, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
a
.
ua
)));

502 
	`ASSERT_EQ
(4, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
b
.
ua
)));

503 
	`ASSERT_TRUE
(
	`lš’um_¬e_£qu’tŸl
(
f
->
a
.
ua
));

504 
	`ASSERT_TRUE
(
	`lš’um_¬e_£qu’tŸl
(
f
->
b
.
ua
));

511 
f
->
exp_şo£d
 = 2;

513 
Ë
 = 
	`li¡_h—d
(
	`ua_ÿÎs
(
f
->
a
.
ua
));

514 
Ë
) {

515 
ÿÎ
 *ÿÎ = 
Ë
->
d©a
;

516 
Ë
 =†e->
Ãxt
;

518 ià(!(
	`ÿÎ_lš’um
(
ÿÎ
) % 2)) {

519 
	`ua_hªgup
(
f
->
a
.
ua
, 
ÿÎ
, 0, 0);

523 
”r
 = 
	`»_maš_timeout
(5000);

524 
	`TEST_ERR
(
”r
);

525 
	`TEST_ERR
(
fix
.
”r
);

527 
	`ASSERT_EQ
(2, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
a
.
ua
)));

528 
	`ASSERT_EQ
(2, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
b
.
ua
)));

529 
	`ASSERT_TRUE
(
	`lš’um_¬e_£qu’tŸl
(
f
->
a
.
ua
));

530 
	`ASSERT_TRUE
(
	`lš’um_¬e_£qu’tŸl
(
f
->
b
.
ua
));

537 
f
->
a
.
n_e¡ablished
 = 0;

538 
f
->
b
.
n_e¡ablished
 = 0;

539 
f
->
exp_e¡ab
 = 2;

540 
i
=0; i<2; i++) {

541 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

542 
	`TEST_ERR
(
”r
);

545 
”r
 = 
	`»_maš_timeout
(5000);

546 
	`TEST_ERR
(
”r
);

547 
	`TEST_ERR
(
fix
.
”r
);

549 
	`ASSERT_EQ
(4, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
a
.
ua
)));

550 
	`ASSERT_EQ
(4, 
	`li¡_couÁ
(
	`ua_ÿÎs
(
f
->
b
.
ua
)));

552 
out
:

553 
	`fixtu»_şo£
(
f
);

555  
”r
;

556 
	}
}

559 
	$‹¡_ÿÎ_max
()

561 
fixtu»
 
fix
, *
f
 = &fix;

562 
i
;

563 
”r
 = 0;

566 
	`cÚf_cÚfig
()->
ÿÎ
.
max_ÿÎs
 = 1;

568 
	`fixtu»_š™
(
f
);

570 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

573 
i
=0; i<2; i++) {

574 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

575 
	`TEST_ERR
(
”r
);

578 
f
->
b
.
çed
 = 
Œue
;

580 
”r
 = 
	`»_maš_timeout
(5000);

581 
	`TEST_ERR
(
”r
);

582 
	`TEST_ERR
(
fix
.
”r
);

584 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

585 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

586 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_şo£d
);

587 
	`ASSERT_EQ
(486, 
fix
.
a
.
şo£_scode
);

589 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_šcomšg
);

590 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_şo£d
);

592 
out
:

593 
	`fixtu»_şo£
(
f
);

595  
”r
;

596 
	}
}

599 cÚ¡ 
	gdtmf_dig™s
[] = "123";

602 
	$dtmf_hªdËr
(
ÿÎ
 *ÿÎ, 
key
, *
¬g
)

604 
ag’t
 *
ag
 = 
¬g
;

605 
”r
 = 0;

606 ()
ÿÎ
;

609 ià(
key
 =ğ
KEYCODE_REL
)

612 
	`ASSERT_EQ
(
dtmf_dig™s
[
ag
->
n_dtmf_»cv
], 
key
);

613 ++
ag
->
n_dtmf_»cv
;

615 ià(
ag
->
n_dtmf_»cv
 >ğ
	`¡r_Ën
(
dtmf_dig™s
)) {

616 
	`»_ÿnûl
();

619 
out
:

620 ià(
”r
) {

621 
	`fixtu»_abÜt
(
ag
->
fix
, 
”r
);

623 
	}
}

626 
	$‹¡_ÿÎ_dtmf
()

628 
fixtu»
 
fix
, *
f
 = &fix;

629 
au¤c
 *au¤øğ
NULL
;

630 
size_t
 
i
, 
n
 = 
	`¡r_Ën
(
dtmf_dig™s
);

631 
”r
 = 0;

634 
	`fixtu»_š™_´m
(
f
, ";ptime=1");

637 
”r
 = 
	`mock_au¤c_»gi¡”
(&
au¤c
);

638 
	`TEST_ERR
(
”r
);

640 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

643 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

644 
	`TEST_ERR
(
”r
);

647 
”r
 = 
	`»_maš_timeout
(5000);

648 
	`TEST_ERR
(
”r
);

649 
	`TEST_ERR
(
fix
.
”r
);

651 
	`ÿÎ_£t_hªdËrs
(
	`ua_ÿÎ
(
f
->
a
.
ua
), 
NULL
, 
dtmf_hªdËr
, &f->a);

652 
	`ÿÎ_£t_hªdËrs
(
	`ua_ÿÎ
(
f
->
b
.
ua
), 
NULL
, 
dtmf_hªdËr
, &f->b);

655 
i
=0; i<
n
; i++) {

656 
”r
 = 
	`ÿÎ_£nd_dig™
(
	`ua_ÿÎ
(
f
->
a
.
ua
), 
dtmf_dig™s
[
i
]);

657 
	`TEST_ERR
(
”r
);

661 
”r
 = 
	`»_maš_timeout
(5000);

662 
	`TEST_ERR
(
”r
);

663 
	`TEST_ERR
(
fix
.
”r
);

665 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_dtmf_»cv
);

666 
	`ASSERT_EQ
(
n
, 
fix
.
b
.
n_dtmf_»cv
);

668 
out
:

669 
	`fixtu»_şo£
(
f
);

670 
	`mem_d”ef
(
au¤c
);

672  
”r
;

673 
	}
}

676 #ifdeà
USE_VIDEO


677 
	$‹¡_ÿÎ_video
()

679 
fixtu»
 
fix
, *
f
 = &fix;

680 
vid¤c
 *vid¤øğ
NULL
;

681 
vidi¥
 *vidi¥ = 
NULL
;

682 
”r
 = 0;

684 
	`cÚf_cÚfig
()->
video
.
ås
 = 100;

686 
	`fixtu»_š™
(
f
);

689 
	`mock_vidcodec_»gi¡”
();

690 
”r
 = 
	`mock_vid¤c_»gi¡”
(&
vid¤c
);

691 
	`TEST_ERR
(
”r
);

692 
”r
 = 
	`mock_vidi¥_»gi¡”
(&
vidi¥
);

693 
	`TEST_ERR
(
”r
);

695 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

696 
f
->
e¡ab_aùiÚ
 = 
ACTION_NOTHING
;

699 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_ON
);

700 
	`TEST_ERR
(
”r
);

703 
”r
 = 
	`»_maš_timeout
(10000);

704 
	`TEST_ERR
(
”r
);

705 
	`TEST_ERR
(
fix
.
”r
);

708 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

709 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

711 
	`ASSERT_TRUE
(
	`ÿÎ_has_video
(
	`ua_ÿÎ
(
f
->
a
.
ua
)));

712 
	`ASSERT_TRUE
(
	`ÿÎ_has_video
(
	`ua_ÿÎ
(
f
->
b
.
ua
)));

714 
out
:

715 
	`fixtu»_şo£
(
f
);

716 
	`mem_d”ef
(
vidi¥
);

717 
	`mem_d”ef
(
vid¤c
);

718 
	`mock_vidcodec_uÄegi¡”
();

720  
”r
;

721 
	}
}

725 
	$mock_§m¶e_hªdËr
(cÚ¡ *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

727 
fixtu»
 *
fix
 = 
¬g
;

728 
boŞ
 
gÙ_auËv–
;

729 ()
§mpv
;

730 ()
§mpc
;

732 
gÙ_auËv–
 =

733 0 =ğ
	`audio_Ëv–_g‘
(
	`ÿÎ_audio
(
	`ua_ÿÎ
(
fix
->
a
.
ua
)), 
NULL
) &&

734 0 =ğ
	`audio_Ëv–_g‘
(
	`ÿÎ_audio
(
	`ua_ÿÎ
(
fix
->
b
.
ua
)), 
NULL
);

736 ià(
gÙ_auËv–
)

737 
	`»_ÿnûl
();

738 
	}
}

741 
	$‹¡_ÿÎ_auËv–
()

743 
fixtu»
 
fix
, *
f
 = &fix;

744 
au¤c
 *au¤øğ
NULL
;

745 
au¶ay
 *au¶ay = 
NULL
;

746 
lvl
;

747 
”r
 = 0;

750 
	`fixtu»_š™_´m
(
f
, ";ptime=1");

752 
	`cÚf_cÚfig
()->
audio
.
Ëv–
 = 
Œue
;

754 
”r
 = 
	`mock_au¤c_»gi¡”
(&
au¤c
);

755 
	`TEST_ERR
(
”r
);

756 
”r
 = 
	`mock_au¶ay_»gi¡”
(&
au¶ay
, 
mock_§m¶e_hªdËr
, 
f
);

757 
	`TEST_ERR
(
”r
);

759 
f
->
e¡ab_aùiÚ
 = 
ACTION_NOTHING
;

762 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

763 
	`TEST_ERR
(
”r
);

766 
”r
 = 
	`»_maš_timeout
(5000);

767 
	`TEST_ERR
(
”r
);

768 
	`TEST_ERR
(
fix
.
”r
);

771 
”r
 = 
	`audio_Ëv–_g‘
(
	`ÿÎ_audio
(
	`ua_ÿÎ
(
f
->
a
.
ua
)), &
lvl
);

772 
	`TEST_ERR
(
”r
);

773 
	`ASSERT_EQ
(-96, 
lvl
);

774 
”r
 = 
	`audio_Ëv–_g‘
(
	`ÿÎ_audio
(
	`ua_ÿÎ
(
f
->
b
.
ua
)), &
lvl
);

775 
	`TEST_ERR
(
”r
);

776 
	`ASSERT_EQ
(-96, 
lvl
);

778 
out
:

779 
	`cÚf_cÚfig
()->
audio
.
Ëv–
 = 
çl£
;

781 
	`fixtu»_şo£
(
f
);

782 
	`mem_d”ef
(
au¶ay
);

783 
	`mem_d”ef
(
au¤c
);

785  
”r
;

786 
	}
}

789 
	$‹¡_ÿÎ_´og»ss
()

791 
fixtu»
 
fix
, *
f
 = &fix;

792 
”r
 = 0;

794 
	`fixtu»_š™
(
f
);

796 
f
->
behaviour
 = 
BEHAVIOUR_PROGRESS
;

799 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

800 
	`TEST_ERR
(
”r
);

803 
”r
 = 
	`»_maš_timeout
(5000);

804 
	`TEST_ERR
(
”r
);

805 
	`TEST_ERR
(
fix
.
”r
);

807 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

808 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_´og»ss
);

809 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_e¡ablished
);

810 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_şo£d
);

811 
	`ASSERT_EQ
(0, 
fix
.
a
.
şo£_scode
);

813 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_šcomšg
);

814 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_´og»ss
);

815 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_e¡ablished
);

816 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_şo£d
);

818 
out
:

819 
	`fixtu»_şo£
(
f
);

821  
”r
;

822 
	}
}

825 
	$æßt_§m¶e_hªdËr
(cÚ¡ *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

827 
fixtu»
 *
fix
 = 
¬g
;

828 ()
§mpv
;

829 ()
§mpc
;

831 ià(
§mpc
 && 
fix
->
a
.
n_e¡ablished
 && fix->
b
.n_established)

832 
	`»_ÿnûl
();

833 
	}
}

836 
	$‹¡_medŸ_ba£
(
audio_mode
 
txmode
)

838 
fixtu»
 
fix
, *
f
 = &fix;

839 
au¤c
 *au¤øğ
NULL
;

840 
au¶ay
 *au¶ay = 
NULL
;

841 
”r
 = 0;

843 
	`fixtu»_š™
(
f
);

845 
	`cÚf_cÚfig
()->
audio
.
txmode
 =xmode;

847 
	`cÚf_cÚfig
()->
audio
.
¤c_fmt
 = 
AUFMT_FLOAT
;

848 
	`cÚf_cÚfig
()->
audio
.
¶ay_fmt
 = 
AUFMT_FLOAT
;

850 
”r
 = 
	`mock_au¤c_»gi¡”
(&
au¤c
);

851 
	`TEST_ERR
(
”r
);

852 
”r
 = 
	`mock_au¶ay_»gi¡”
(&
au¶ay
, 
æßt_§m¶e_hªdËr
, 
f
);

853 
	`TEST_ERR
(
”r
);

855 
f
->
e¡ab_aùiÚ
 = 
ACTION_NOTHING
;

857 
f
->
behaviour
 = 
BEHAVIOUR_ANSWER
;

860 
”r
 = 
	`ua_cÚÃù
(
f
->
a
.
ua
, 0, 
NULL
, f->
buri
, NULL, 
VIDMODE_OFF
);

861 
	`TEST_ERR
(
”r
);

864 
”r
 = 
	`»_maš_timeout
(5000);

865 
	`TEST_ERR
(
”r
);

866 
	`TEST_ERR
(
fix
.
”r
);

868 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_šcomšg
);

869 
	`ASSERT_EQ
(1, 
fix
.
a
.
n_e¡ablished
);

870 
	`ASSERT_EQ
(0, 
fix
.
a
.
n_şo£d
);

871 
	`ASSERT_EQ
(0, 
fix
.
a
.
şo£_scode
);

873 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_šcomšg
);

874 
	`ASSERT_EQ
(1, 
fix
.
b
.
n_e¡ablished
);

875 
	`ASSERT_EQ
(0, 
fix
.
b
.
n_şo£d
);

877 
out
:

878 
	`cÚf_cÚfig
()->
audio
.
¤c_fmt
 = 
AUFMT_S16LE
;

879 
	`cÚf_cÚfig
()->
audio
.
¶ay_fmt
 = 
AUFMT_S16LE
;

881 
	`fixtu»_şo£
(
f
);

882 
	`mem_d”ef
(
au¶ay
);

883 
	`mem_d”ef
(
au¤c
);

885 ià(
fix
.
”r
)

886  
fix
.
”r
;

888  
”r
;

889 
	}
}

892 
	$‹¡_ÿÎ_fÜm©_æßt
()

894 
”r
;

896 
”r
 = 
	`‹¡_medŸ_ba£
(
AUDIO_MODE_POLL
);

897 
	`ASSERT_EQ
(0, 
”r
);

899 
”r
 = 
	`‹¡_medŸ_ba£
(
AUDIO_MODE_THREAD
);

900 
	`ASSERT_EQ
(0, 
”r
);

902 
	`cÚf_cÚfig
()->
audio
.
txmode
 = 
AUDIO_MODE_POLL
;

904 
out
:

905  
”r
;

906 
	}
}

	@baresip/test/cmd.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	s‹¡
 {

13 
	mcmd_ÿÎed
;

16 
	$cmd_‹¡
(
»_´štf
 *
pf
, *
¬g
)

18 
cmd_¬g
 *
ÿrg
 = 
¬g
;

19 
‹¡
 *‹¡ = 
ÿrg
->
d©a
;

20 
”r
 = 0;

21 ()
pf
;

23 
	`ASSERT_EQ
('@', 
ÿrg
->
key
);

24 
	`ASSERT_TRUE
(
NULL
 =ğ
ÿrg
->
´m
);

25 
	`ASSERT_EQ
(
Œue
, 
ÿrg
->
com¶‘e
);

27 ++
‹¡
->
cmd_ÿÎed
;

29 
out
:

30  
”r
;

31 
	}
}

34 cÚ¡ 
cmd
 
	gcmdv
[] = {

35 {
NULL
, '@', 0, "Te¡ commªd", 
cmd_‹¡
},

39 
	$v´štf_nuÎ
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

41 ()
p
;

42 ()
size
;

43 ()
¬g
;

45 
	}
}

48 
»_´štf
 
	gpf_nuÎ
 = {
v´štf_nuÎ
, 0};

51 
	$‹¡_cmd
()

53 
commªds
 *commªd ğ
NULL
;

54 
cmd_ùx
 *
ùx
 = 0;

55 
‹¡
est;

56 
”r
 = 0;

58 
	`mem£t
(&
‹¡
, 0, (test));

60 
”r
 = 
	`cmd_š™
(&
commªds
);

61 
	`ASSERT_EQ
(0, 
”r
);

63 
”r
 = 
	`cmd_»gi¡”
(
commªds
, 
cmdv
, 
	`ARRAY_SIZE
(cmdv));

64 
	`ASSERT_EQ
(0, 
”r
);

67 
	`ASSERT_EQ
(
EALREADY
, 
	`cmd_»gi¡”
(
commªds
, 
cmdv
, 
	`ARRAY_SIZE
(cmdv)));

70 
”r
 = 
	`cmd_´oûss
(
commªds
, &
ùx
, 'h', &
pf_nuÎ
, &
‹¡
);

71 
	`ASSERT_EQ
(0, 
”r
);

72 
	`ASSERT_EQ
(0, 
‹¡
.
cmd_ÿÎed
);

75 
”r
 = 
	`cmd_´oûss
(
commªds
, &
ùx
, '@', &
pf_nuÎ
, &
‹¡
);

76 
	`ASSERT_EQ
(0, 
”r
);

77 
	`ASSERT_EQ
(1, 
‹¡
.
cmd_ÿÎed
);

79 
	`cmd_uÄegi¡”
(
commªds
, 
cmdv
);

82 
	`ASSERT_TRUE
(
NULL
 =ğ
ùx
);

84 
out
:

85 
	`mem_d”ef
(
commªds
);

86  
”r
;

87 
	}
}

90 
	$lÚg_hªdËr
(
»_´štf
 *
pf
, *
¬g
)

92 
cmd_¬g
 *
ÿrg
 = 
¬g
;

93 
‹¡
 *‹¡ = 
ÿrg
->
d©a
;

94 
”r
 = 0;

95 ()
pf
;

97 
	`ASSERT_STREQ
("123", 
ÿrg
->
´m
);

99 ++
‹¡
->
cmd_ÿÎed
;

101 
out
:

102  
”r
;

103 
	}
}

106 cÚ¡ 
cmd
 
	glÚgcmdv
[] = {

107 { "‹¡", 0, 0, "Te¡ Commªd", 
lÚg_hªdËr
},

111 
	$‹¡_cmd_lÚg
()

113 
commªds
 *commªd ğ
NULL
;

114 
‹¡
est;

115 cÚ¡ 
cmd
 *cmd;

116 cÚ¡ *
šput_¡r
 = "/test 123\n";

117 
cmd_ùx
 *
ùx
 = 
NULL
;

118 
size_t
 
i
;

119 
”r
;

121 
	`mem£t
(&
‹¡
, 0, (test));

123 
”r
 = 
	`cmd_š™
(&
commªds
);

124 
	`ASSERT_EQ
(0, 
”r
);

127 
cmd
 = 
	`cmd_fšd_lÚg
(
commªds
, "test");

128 
	`ASSERT_TRUE
(
cmd
 =ğ
NULL
);

131 
”r
 = 
	`cmd_»gi¡”
(
commªds
, 
lÚgcmdv
, 
	`ARRAY_SIZE
(longcmdv));

132 
	`ASSERT_EQ
(0, 
”r
);

134 
cmd
 = 
	`cmd_fšd_lÚg
(
commªds
, "test");

135 
	`ASSERT_TRUE
(
cmd
 !ğ
NULL
);

139 
i
=0; i<
	`¡¾’
(
šput_¡r
); i++) {

141 
”r
 = 
	`cmd_´oûss
(
commªds
, &
ùx
, 
šput_¡r
[
i
],

142 &
pf_nuÎ
, &
‹¡
);

143 
	`ASSERT_EQ
(0, 
”r
);

146 
”r
 = 
	`cmd_´oûss_lÚg
(
commªds
, "‹¡ 123", 8, &
pf_nuÎ
, &
‹¡
);

147 
	`ASSERT_EQ
(0, 
”r
);

149 
	`ASSERT_EQ
(2, 
‹¡
.
cmd_ÿÎed
);

153 
	`cmd_uÄegi¡”
(
commªds
, 
lÚgcmdv
);

155 
cmd
 = 
	`cmd_fšd_lÚg
(
commªds
, "test");

156 
	`ASSERT_TRUE
(
cmd
 =ğ
NULL
);

158 
out
:

159 
	`mem_d”ef
(
commªds
);

160  
”r
;

161 
	}
}

	@baresip/test/contact.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	$‹¡_cÚù
()

14 
cÚùs
 contacts;

15 
cÚù
 *
c
;

16 cÚ¡ *
addr
 = "sip:neil@young.com";

17 
¶
 
¶_addr
;

18 
”r
;

20 
”r
 = 
	`cÚù_š™
(&
cÚùs
);

21 
	`ASSERT_EQ
(0, 
”r
);

25 
	`ASSERT_EQ
(0, 
	`li¡_couÁ
(
	`cÚù_li¡
(&
cÚùs
)));

27 
c
 = 
	`cÚù_fšd
(&
cÚùs
, "sip:null@void.com");

28 
	`ASSERT_TRUE
(
c
 =ğ
NULL
);

33 
	`¶_£t_¡r
(&
¶_addr
, 
addr
);

34 
”r
 = 
	`cÚù_add
(&
cÚùs
, &
c
, &
¶_addr
);

35 
	`ASSERT_EQ
(0, 
”r
);

36 
	`ASSERT_TRUE
(
c
 !ğ
NULL
);

38 
	`ASSERT_EQ
(1, 
	`li¡_couÁ
(
	`cÚù_li¡
(&
cÚùs
)));

40 
c
 = 
	`cÚù_fšd
(&
cÚùs
, 
addr
);

41 
	`ASSERT_TRUE
(
c
 !ğ
NULL
);

43 
	`ASSERT_STREQ
(
addr
, 
	`cÚù_¡r
(
c
));

47 
	`mem_d”ef
(
c
);

49 
	`ASSERT_EQ
(0, 
	`li¡_couÁ
(
	`cÚù_li¡
(&
cÚùs
)));

51 
out
:

52 
	`cÚù_şo£
(&
cÚùs
);

54  
”r
;

55 
	}
}

	@baresip/test/cplusplus.cpp

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	$‹¡_ılu¥lus
()

14 cÚ¡ *
v”siÚ
 = 
	`sys_lib»_v”siÚ_g‘
();

15 
”r
 = 0;

17 
	`ASSERT_TRUE
(
	`¡r_is£t
(
v”siÚ
));

18 
	`šfo
("c++ ok\n");

20 
out
:

21  
”r
;

22 
	}
}

	@baresip/test/main.c

6 #ifdeà
SOLARIS


7 
	#__EXTENSIONS__
 1

	)

9 
	~<g‘İt.h
>

10 
	~<».h
>

11 
	~<b¬es.h
>

12 
	~"‹¡.h
"

15 (
	t‹¡_exec_h
)();

17 
	s‹¡
 {

18 
‹¡_exec_h
 *
exec
;

19 cÚ¡ *
Çme
;

22 
	#TEST
(
a
è{a, #a
	}

	)
}

24 cÚ¡ 
‹¡
 
	g‹¡s
[] = {

25 
TEST
(
‹¡_accouÁ
),

26 
TEST
(
‹¡_auËv–
),

27 
TEST
(
‹¡_ÿÎ_af_mism©ch
),

28 
TEST
(
‹¡_ÿÎ_ªsw”
),

29 
TEST
(
‹¡_ÿÎ_ªsw”_hªgup_a
),

30 
TEST
(
‹¡_ÿÎ_ªsw”_hªgup_b
),

31 
TEST
(
‹¡_ÿÎ_»jeù
),

32 
TEST
(
‹¡_ÿÎ_¹p_timeout
),

33 
TEST
(
‹¡_ÿÎ_muÉË
),

34 
TEST
(
‹¡_ÿÎ_max
),

35 
TEST
(
‹¡_ÿÎ_dtmf
),

36 
TEST
(
‹¡_ÿÎ_auËv–
),

37 
TEST
(
‹¡_ÿÎ_´og»ss
),

38 
TEST
(
‹¡_ÿÎ_fÜm©_æßt
),

39 #ifdeà
USE_VIDEO


40 
TEST
(
‹¡_ÿÎ_video
),

41 
TEST
(
‹¡_video
),

43 
TEST
(
‹¡_cmd
),

44 
TEST
(
‹¡_cmd_lÚg
),

45 
TEST
(
‹¡_cÚù
),

46 
TEST
(
‹¡_ılu¥lus
),

47 
TEST
(
‹¡_mes§ge
),

48 
TEST
(
‹¡_mos
),

49 
TEST
(
‹¡_ÃtwÜk
),

50 
TEST
(
‹¡_¶ay
),

51 
TEST
(
‹¡_ua_®loc
),

52 
TEST
(
‹¡_ua_İtiÚs
),

53 
TEST
(
‹¡_ua_»gi¡”
),

54 
TEST
(
‹¡_ua_»gi¡”_dns
),

55 
TEST
(
‹¡_ua_»gi¡”_auth
),

56 
TEST
(
‹¡_ua_»gi¡”_auth_dns
),

57 
TEST
(
‹¡_uag_fšd_·¿m
),

61 
	$run_Úe_‹¡
(cÚ¡ 
‹¡
 *test)

63 
”r
;

65 
	`»_´štf
("[ RUN ] %s\n", 
‹¡
->
Çme
);

67 
”r
 = 
‹¡
->
	`exec
();

68 ià(
”r
) {

69 
	`w¬nšg
("%s:est failed (%m)\n",

70 
‹¡
->
Çme
, 
”r
);

71  
”r
;

74 
	`»_´štf
("[ OK ]\n");

77 
	}
}

80 
	$run_‹¡s
()

82 
size_t
 
i
;

83 
”r
;

85 
i
=0; i<
	`ARRAY_SIZE
(
‹¡s
); i++) {

87 
	`»_´štf
("[ RUN ] %s\n", 
‹¡s
[
i
].
Çme
);

89 
”r
 = 
‹¡s
[
i
].
	`exec
();

90 ià(
”r
) {

91 
	`w¬nšg
("%s:est failed (%m)\n",

92 
‹¡s
[
i
].
Çme
, 
”r
);

93  
”r
;

96 
	`»_´štf
("[ OK ]\n");

100 
	}
}

103 
	$‹¡_li¡ÿ£s
()

105 
size_t
 
i
, 
n
;

107 
n
 = 
	`ARRAY_SIZE
(
‹¡s
);

109 ()
	`»_´štf
("\n%zue¡ ca£s:\n", 
n
);

111 
i
=0; i<(
n
+1)/2; i++) {

113 ()
	`»_´štf
(" %-32s %s\n",

114 
‹¡s
[
i
].
Çme
,

115 (
i
+(
n
+1)/2è<‚ ? 
‹¡s
[i+Ò+1)/2].
Çme
 : "");

118 ()
	`»_´štf
("\n");

119 
	}
}

122 cÚ¡ 
‹¡
 *
	$fšd_‹¡
(cÚ¡ *
Çme
)

124 
size_t
 
i
;

126 
i
=0; i<
	`ARRAY_SIZE
(
‹¡s
); i++) {

128 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
‹¡s
[
i
].name))

129  &
‹¡s
[
i
];

132  
NULL
;

133 
	}
}

136 
	$ua_ex™_hªdËr
(*
¬g
)

138 ()
¬g
;

140 
	`debug
("uaƒxited -- stopping main„unloop\n");

141 
	`»_ÿnûl
();

142 
	}
}

145 
	$u§ge
()

147 ()
	`»_årštf
(
¡d”r
,

153 
	}
}

156 
	$maš
(
¬gc
, *
¬gv
[])

158 
cÚfig
 *config;

159 
size_t
 
i
, 
Áe¡s
;

160 
boŞ
 
v”bo£
 = 
çl£
;

161 
”r
;

163 
”r
 = 
	`lib»_š™
();

164 ià(
”r
)

165  
”r
;

167 
	`log_’abË_šfo
(
çl£
);

170 cÚ¡ 
c
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "hlv");

171 ià(0 > 
c
)

174 
c
) {

178 
	`u§ge
();

182 
	`‹¡_li¡ÿ£s
();

186 ià(
v”bo£
)

187 
	`log_’abË_debug
(
Œue
);

189 
	`log_’abË_šfo
(
Œue
);

190 
v”bo£
 = 
Œue
;

198 ià(
¬gc
 >ğ(
İtšd
 + 1))

199 
Áe¡s
 = 
¬gc
 - 
İtšd
;

201 
Áe¡s
 = 
	`ARRAY_SIZE
(
‹¡s
);

203 
	`»_´štf
("running baresip selftest version %s with %zuests\n",

204 
BARESIP_VERSION
, 
Áe¡s
);

207 
cÚfig
 = 
	`cÚf_cÚfig
();

208 ià(!
cÚfig
) {

209 
”r
 = 
ENOENT
;

210 
out
;

213 
”r
 = 
	`b¬es_š™
(
cÚfig
, 
çl£
);

214 ià(
”r
)

215 
out
;

217 
	`¡r_nıy
(
cÚfig
->
s
.
loÿl
, "127.0.0.1:0", (config->sip.local));

219 
	`uag_£t_ex™_hªdËr
(
ua_ex™_hªdËr
, 
NULL
);

221 ià(
¬gc
 >ğ(
İtšd
 + 1)) {

223 
i
=0; i<
Áe¡s
; i++) {

224 cÚ¡ *
Çme
 = 
¬gv
[
İtšd
 + 
i
];

225 cÚ¡ 
‹¡
 *test;

227 
‹¡
 = 
	`fšd_‹¡
(
Çme
);

228 ià(
‹¡
) {

229 
”r
 = 
	`run_Úe_‹¡
(
‹¡
);

230 ià(
”r
)

231 
out
;

234 
	`»_årštf
(
¡d”r
,

236 
Çme
);

237 
”r
 = 
ENOENT
;

238 
out
;

243 
”r
 = 
	`run_‹¡s
();

244 ià(
”r
)

245 
out
;

249 
	`ua_¡İ_®l
(
Œue
);

252 
	`»_´štf
("\x1b[32mOK. %zuests…assed successfully\x1b[;m\n",

253 
Áe¡s
);

255 
out
:

256 ià(
”r
) {

257 
	`w¬nšg
("‹¡ faed (%m)\n", 
”r
);

258 
	`»_´štf
("%H\n", 
»_debug
, 0);

260 
	`ua_¡İ_®l
(
Œue
);

261 
	`ua_şo£
();

263 
	`b¬es_şo£
();

265 
	`lib»_şo£
();

267 
	`tmr_debug
();

268 
	`mem_debug
();

270  
”r
;

271 
	}
}

	@baresip/test/message.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	s‹¡
 {

13 
s_Œª¥
 
	mŒª¥
;

14 
	m”r
;

17 
	s’dpošt
 {

18 
‹¡
 *
	m‹¡
;

19 
’dpošt
 *
	mÙh”
;

20 
mes§ge
 *
	mmes§ge
;

21 
ua
 *
	mua
;

22 
	muri
[256];

23 
	mn_msg
;

24 
	mn_»¥
;

28 cÚ¡ 
	gdummy_msg
[] = "hei…aa deg";

29 cÚ¡ 
	g‹xt_¶aš
[] = "text/plain";

32 
boŞ
 
	$’dpošt_is_com¶‘e
(cÚ¡ 
’dpošt
 *
•
)

34  
•
->
n_msg
 >ğ1 ||ƒp->
n_»¥
 >= 1;

35 
	}
}

38 
boŞ
 
	$‹¡_is_com¶‘e
(
’dpošt
 *
•
)

40  
	`’dpošt_is_com¶‘e
(
•
) &&

41 
	`’dpošt_is_com¶‘e
(
•
->
Ùh”
);

42 
	}
}

45 
	$mes§ge_»cv_hªdËr
(cÚ¡ 
¶
 *
³”
, cÚ¡ ¶ *
ùy³
,

46 
mbuf
 *
body
, *
¬g
)

48 
’dpošt
 *
•
 = 
¬g
;

49 
”r
 = 0;

51 
	`šfo
("[ % ]„ecv msg from %r: \"%b\"\n", 
•
->
uri
, 
³”
,

52 
	`mbuf_buf
(
body
), 
	`mbuf_g‘_Ëá
(body));

54 
	`TEST_STRCMP
(
‹xt_¶aš
, 
	`¡¾’
(text_plain),

55 
ùy³
->
p
, cty³->
l
);

57 
	`TEST_STRCMP
(
dummy_msg
, 
	`¡r_Ën
(dummy_msg),

58 
	`mbuf_buf
(
body
), 
	`mbuf_g‘_Ëá
(body));

60 ++
•
->
n_msg
;

62 ià(
	`‹¡_is_com¶‘e
(
•
)) {

63 
	`»_ÿnûl
();

67 
out
:

68 ià(
”r
) {

69 
•
->
‹¡
->
”r
 =ƒrr;

70 
	`»_ÿnûl
();

72 
	}
}

75 
	$£nd_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

77 
’dpošt
 *
•
 = 
¬g
;

79 ++
•
->
n_»¥
;

81 ià(
”r
) {

82 
	`w¬nšg
("£ndšg faed: %m\n", 
”r
);

83 
out
;

86 ià(
msg
->
scode
 >= 300) {

87 
	`w¬nšg
("£ndšg faed: %u %r\n", 
msg
->
scode
, &msg->
»asÚ
);

88 
”r
 = 
EPROTO
;

89 
out
;

92 
	`šfo
("[ % ] mes§g£Á OK\n", 
•
->
uri
);

94 
	`ASSERT_EQ
(
•
->
‹¡
->
Œª¥
, 
msg
->

);

95 
	`ASSERT_EQ
(200, 
msg
->
scode
);

97 ià(
	`‹¡_is_com¶‘e
(
•
)) {

98 
	`»_ÿnûl
();

102 
out
:

103 ià(
”r
) {

104 
•
->
‹¡
->
”r
 =ƒrr;

105 
	`»_ÿnûl
();

107 
	}
}

110 
	$’dpošt_de¡ruùÜ
(*
d©a
)

112 
’dpošt
 *
•
 = 
d©a
;

114 
	`mem_d”ef
(
•
->
mes§ge
);

115 
	`mem_d”ef
(
•
->
ua
);

116 
	}
}

119 
	$’dpošt_®loc
(
’dpošt
 **
•p
, 
‹¡
 *test,

120 cÚ¡ *
Çme
, 
s_Œª¥
 
Œª¥
)

122 
’dpošt
 *
•
 = 
NULL
;

123 
§
 
Ïddr
;

124 
aÜ
[256];

125 
”r
 = 0;

127 
”r
 = 
	`s_Œª¥_Ïddr
(
	`uag_s
(), &
Ïddr
, 
Œª¥
, 
NULL
);

128 
	`TEST_ERR
(
”r
);

130 
•
 = 
	`mem_z®loc
((*•), 
’dpošt_de¡ruùÜ
);

131 ià(!
•
)

132  
ENOMEM
;

134 
•
->
‹¡
 =est;

136 ià(
	`»_¢´štf
(
aÜ
, (aor),

138 
Çme
,‚ame,

139 
	`s_Œª¥_Çme
(
Œª¥
)) < 0) {

140 
”r
 = 
ENOMEM
;

141 
out
;

144 ià(
	`»_¢´štf
(
•
->
uri
, (ep->uri), "sip:%s@%J;transport=%s",

145 
Çme
,

146 &
Ïddr
, 
	`s_Œª¥_Çme
(
Œª¥
)) < 0) {

147 
”r
 = 
ENOMEM
;

148 
out
;

151 
”r
 = 
	`ua_®loc
(&
•
->
ua
, 
aÜ
);

152 ià(
”r
)

153 
out
;

155 
”r
 = 
	`mes§ge_š™
(&
•
->
mes§ge
);

156 
	`TEST_ERR
(
”r
);

158 
out
:

159 ià(
”r
)

160 
	`mem_d”ef
(
•
);

162 *
•p
 = 
•
;

164  
”r
;

165 
	}
}

168 
	$‹¡_mes§ge_Œª¥
(
s_Œª¥
 
Œª¥
)

170 
‹¡
est;

171 
’dpošt
 *
a
 = 
NULL
, *
b
 = NULL;

172 
boŞ
 
’abË_udp
, 
’abË_tı
;

173 
”r
 = 0;

175 
’abË_udp
 = 
Œª¥
 =ğ
SIP_TRANSP_UDP
;

176 
’abË_tı
 = 
Œª¥
 =ğ
SIP_TRANSP_TCP
;

178 
	`mem£t
(&
‹¡
, 0, (test));

180 
‹¡
.
Œª¥
 =ransp;

182 
”r
 = 
	`ua_š™
("‹¡", 
’abË_udp
, 
’abË_tı
, 
çl£
, false);

183 
	`TEST_ERR
(
”r
);

185 
”r
 = 
	`’dpošt_®loc
(&
a
, &
‹¡
, "a", 
Œª¥
);

186 
	`TEST_ERR
(
”r
);

188 
”r
 = 
	`’dpošt_®loc
(&
b
, &
‹¡
, "b", 
Œª¥
);

189 
	`TEST_ERR
(
”r
);

191 
a
->
Ùh”
 = 
b
;

192 
b
->
Ùh”
 = 
a
;

195 
”r
 = 
	`mes§ge_li¡’
(
NULL
, 
b
->
mes§ge
, 
mes§ge_»cv_hªdËr
, b);

196 
	`TEST_ERR
(
”r
);

199 
”r
 = 
	`mes§ge_£nd
(
a
->
ua
, 
b
->
uri
, 
dummy_msg
, 
£nd_»¥_hªdËr
,‡);

200 
	`TEST_ERR
(
”r
);

202 
”r
 = 
	`»_maš_timeout
(1000);

203 
	`TEST_ERR
(
”r
);

205 
	`TEST_ERR
(
‹¡
.
”r
);

206 
	`ASSERT_EQ
(0, 
a
->
n_msg
);

207 
	`ASSERT_EQ
(1, 
a
->
n_»¥
);

208 
	`ASSERT_EQ
(1, 
b
->
n_msg
);

209 
	`ASSERT_EQ
(0, 
b
->
n_»¥
);

211 
out
:

212 
	`mem_d”ef
(
b
);

213 
	`mem_d”ef
(
a
);

214 
	`ua_şo£
();

216  
”r
;

217 
	}
}

220 
	$‹¡_mes§ge
()

222 
”r
 = 0;

224 
”r
 = 
	`‹¡_mes§ge_Œª¥
(
SIP_TRANSP_UDP
);

225 
	`TEST_ERR
(
”r
);

227 
”r
 |ğ
	`‹¡_mes§ge_Œª¥
(
SIP_TRANSP_TCP
);

228 
	`TEST_ERR
(
”r
);

230 
out
:

231  
”r
;

232 
	}
}

	@baresip/test/mock/cert.c

6 
	~<».h
>

7 
	~"../‹¡.h
"

29 cÚ¡ 
	g‹¡_û¹ifiÿ‹
[] =

	@baresip/test/mock/dnssrv.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~"../‹¡.h
"

11 
	#DEBUG_MODULE
 "mock/dns¤v"

	)

12 
	#DEBUG_LEVEL
 5

	)

13 
	~<»_dbg.h
>

16 
	#LOCAL_PORT
 0

	)

19 
	$dns_£rv”_m©ch
(
dns_£rv”
 *
¤v
, 
li¡
 *
¼l
,

20 cÚ¡ *
Çme
, 
ušt16_t
 
ty³
)

22 
dn¤r
 *
¼0
 = 
NULL
;

23 
Ë
 *le;

25 
Ë
 = 
¤v
->
¼l
.
h—d
;

26 
Ë
) {

28 
dn¤r
 *
¼
 = 
Ë
->
d©a
;

29 
Ë
 =†e->
Ãxt
;

31 ià(
ty³
 =ğ
¼
->ty³ && 0==
	`¡r_ÿ£cmp
(
Çme
,„r->name)) {

33 ià(!
¼0
)

34 
¼0
 = 
¼
;

35 
	`li¡_­³nd
(
¼l
, &
¼
->
Ë_´iv
,„r);

41 ià(
¤v
->
rÙ©e
 && 
¼0
) {

42 
	`li¡_uÆšk
(&
¼0
->
Ë
);

43 
	`li¡_­³nd
(&
¤v
->
¼l
, &
¼0
->
Ë
,„r0);

45 
	}
}

48 
	$decode_dns_qu”y
(
dns_£rv”
 *
¤v
,

49 cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
)

51 
li¡
 
¼l
 = 
LIST_INIT
;

52 
dnshdr
 
hdr
;

53 
Ë
 *le;

54 *
qÇme
 = 
NULL
;

55 
size_t
 
¡¬t
, 
’d
;

56 
ušt16_t
 
ty³
, 
dnsşass
;

57 
”r
 = 0;

59 
¡¬t
 = 
mb
->
pos
;

60 
’d
 = 
mb
->end;

62 ià(
	`dns_hdr_decode
(
mb
, &
hdr
è|| hdr.
qr
 || hdr.
nq
 != 1) {

63 
	`DEBUG_WARNING
("unableo decode query header\n");

67 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
qÇme
, 
¡¬t
);

68 ià(
”r
) {

69 
	`DEBUG_WARNING
("unableo decode query‚ame\n");

70 
out
;

73 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4) {

74 
”r
 = 
EBADMSG
;

75 
	`DEBUG_WARNING
("unableo decode queryype/class\n");

76 
out
;

79 
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

80 
dnsşass
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

82 
	`DEBUG_INFO
("dnssrv:ype=%s query-name='%s'\n",

83 
	`dns_¼_ty³Çme
(
ty³
), 
qÇme
);

85 ià(
dnsşass
 =ğ
DNS_CLASS_IN
) {

86 
	`dns_£rv”_m©ch
(
¤v
, &
¼l
, 
qÇme
, 
ty³
);

89 
hdr
.
qr
 = 
Œue
;

90 
hdr
.
tc
 = 
çl£
;

91 
hdr
.
rcode
 = 
DNS_RCODE_OK
;

92 
hdr
.
nq
 = 1;

93 
hdr
.
Çns
 = 
	`li¡_couÁ
(&
¼l
);

95 
mb
->
pos
 = 
¡¬t
;

97 
”r
 = 
	`dns_hdr_’code
(
mb
, &
hdr
);

98 ià(
”r
)

99 
out
;

101 
mb
->
pos
 = 
’d
;

103 
	`DEBUG_INFO
("dnssrv: @@ found %u‡nswers for %s\n",

104 
	`li¡_couÁ
(&
¼l
), 
qÇme
);

106 
Ë
 = 
¼l
.
h—d
;†e;†ğË->
Ãxt
) {

107 
dn¤r
 *
¼
 = 
Ë
->
d©a
;

109 
”r
 = 
	`dns_¼_’code
(
mb
, 
¼
, 0, 
NULL
, 
¡¬t
);

110 ià(
”r
)

111 
out
;

114 
mb
->
pos
 = 
¡¬t
;

116 ()
	`udp_£nd
(
¤v
->
us
, 
¤c
, 
mb
);

118 
out
:

119 
	`li¡_ş—r
(&
¼l
);

120 
	`mem_d”ef
(
qÇme
);

121 
	}
}

124 
	$udp_»cv
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

126 
dns_£rv”
 *
¤v
 = 
¬g
;

128 
	`decode_dns_qu”y
(
¤v
, 
¤c
, 
mb
);

129 
	}
}

132 
	$de¡ruùÜ
(*
¬g
)

134 
dns_£rv”
 *
¤v
 = 
¬g
;

136 
	`li¡_æush
(&
¤v
->
¼l
);

137 
	`mem_d”ef
(
¤v
->
us
);

138 
	}
}

141 
	$dns_£rv”_®loc
(
dns_£rv”
 **
¤vp
, 
boŞ
 
rÙ©e
)

143 
dns_£rv”
 *
¤v
;

144 
”r
;

146 ià(!
¤vp
)

147  
EINVAL
;

149 
¤v
 = 
	`mem_z®loc
((*¤v), 
de¡ruùÜ
);

150 ià(!
¤v
)

151  
ENOMEM
;

153 
”r
 = 
	`§_£t_¡r
(&
¤v
->
addr
, "127.0.0.1", 
LOCAL_PORT
);

154 ià(
”r
)

155 
out
;

157 
”r
 = 
	`udp_li¡’
(&
¤v
->
us
, &¤v->
addr
, 
udp_»cv
, srv);

158 ià(
”r
)

159 
out
;

161 
”r
 = 
	`udp_loÿl_g‘
(
¤v
->
us
, &¤v->
addr
);

162 ià(
”r
)

163 
out
;

165 
¤v
->
rÙ©e
 =„otate;

167 
out
:

168 ià(
”r
)

169 
	`mem_d”ef
(
¤v
);

171 *
¤vp
 = 
¤v
;

173  
”r
;

174 
	}
}

177 
	$dns_£rv”_add_a
(
dns_£rv”
 *
¤v
, cÚ¡ *
Çme
, 
ušt32_t
 
addr
)

179 
dn¤r
 *
¼
;

180 
”r
;

182 ià(!
¤v
 || !
Çme
)

183  
EINVAL
;

185 
¼
 = 
	`dns_¼_®loc
();

186 ià(!
¼
)

187  
ENOMEM
;

189 
”r
 = 
	`¡r_dup
(&
¼
->
Çme
,‚ame);

190 ià(
”r
)

191 
out
;

193 
¼
->
ty³
 = 
DNS_TYPE_A
;

194 
¼
->
dnsşass
 = 
DNS_CLASS_IN
;

195 
¼
->
‰l
 = 3600;

196 
¼
->
rdËn
 = 0;

198 
¼
->
rd©a
.
a
.
addr
 =‡ddr;

200 
	`li¡_­³nd
(&
¤v
->
¼l
, &
¼
->
Ë
,„r);

202 
out
:

203 ià(
”r
)

204 
	`mem_d”ef
(
¼
);

206  
”r
;

207 
	}
}

210 
	$dns_£rv”_add_¤v
(
dns_£rv”
 *
¤v
, cÚ¡ *
Çme
,

211 
ušt16_t
 
´i
, ušt16_ˆ
weight
, ušt16_ˆ
pÜt
,

212 cÚ¡ *
rg‘
)

214 
dn¤r
 *
¼
;

215 
”r
;

217 ià(!
¤v
 || !
Çme
 || !
pÜt
 || !
rg‘
)

218  
EINVAL
;

220 
¼
 = 
	`dns_¼_®loc
();

221 ià(!
¼
)

222  
ENOMEM
;

224 
”r
 = 
	`¡r_dup
(&
¼
->
Çme
,‚ame);

225 ià(
”r
)

226 
out
;

228 
¼
->
ty³
 = 
DNS_TYPE_SRV
;

229 
¼
->
dnsşass
 = 
DNS_CLASS_IN
;

230 
¼
->
‰l
 = 3600;

231 
¼
->
rdËn
 = 0;

233 
¼
->
rd©a
.
¤v
.
´i
 =…ri;

234 
¼
->
rd©a
.
¤v
.
weight
 = weight;

235 
¼
->
rd©a
.
¤v
.
pÜt
 =…ort;

236 
	`¡r_dup
(&
¼
->
rd©a
.
¤v
.
rg‘
,arget);

238 
	`li¡_­³nd
(&
¤v
->
¼l
, &
¼
->
Ë
,„r);

240 
out
:

241 ià(
”r
)

242 
	`mem_d”ef
(
¼
);

244  
”r
;

245 
	}
}

	@baresip/test/mock/mock_aucodec.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"../‹¡.h
"

15 
	#L16_HEADER
 0x1616

	)

18 
	$mock_l16_’code
(
au’c_¡©e
 *
¡
, 
ušt8_t
 *
buf
, 
size_t
 *
Ën
,

19 cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

21 
št16_t
 *
p
 = (*)
buf
;

22 ()
¡
;

24 ià(!
buf
 || !
Ën
 || !
§mpv
)

25  
EINVAL
;

27 ià(*
Ën
 < 
§mpc
*2)

28  
ENOMEM
;

30 *
Ën
 = 2 + 
§mpc
*2;

32 *
p
++ = 
L16_HEADER
;

34 
§mpc
--)

35 *
p
++ = 
	`htÚs
(*
§mpv
++);

38 
	}
}

41 
	$mock_l16_decode
(
audec_¡©e
 *
¡
,

42 
št16_t
 *
§mpv
, 
size_t
 *
§mpc
,

43 cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

45 
št16_t
 *
p
 = (*)
buf
;

46 
ušt16_t
 
hdr
;

47 ()
¡
;

49 ià(!
buf
 || !
Ën
 || !
§mpv
)

50  
EINVAL
;

52 ià(
Ën
 < 2)

53  
EINVAL
;

55 ià(*
§mpc
 < 
Ën
/2)

56  
ENOMEM
;

58 *
§mpc
 = (
Ën
 - 2)/2;

60 
hdr
 = *
p
++;

61 ià(
L16_HEADER
 !ğ
hdr
) {

62 
	`w¬nšg
("mock_aucodec: invalid L16 header"

63 " 0x%04x (Ën=%zu)\n", 
hdr
, 
Ën
);

64  
EPROTO
;

67 
Ën
 =†en/2 - 2;

68 
Ën
--)

69 *
§mpv
++ = 
	`Áohs
(*
p
++);

72 
	}
}

75 
aucodec
 
	gac_dummy
 = {

76 .
Çme
 = "FOO16",

77 .
	g¤©e
 = 8000,

78 .
	gü©e
 = 8000,

79 .
	gch
 = 1,

80 .
	g’ch
 = 
mock_l16_’code
,

81 .
	gdech
 = 
mock_l16_decode
,

85 
	$mock_aucodec_»gi¡”
()

87 
	`aucodec_»gi¡”
(
	`b¬es_aucodeş
(), &
ac_dummy
);

88 
	}
}

91 
	$mock_aucodec_uÄegi¡”
()

93 
	`aucodec_uÄegi¡”
(&
ac_dummy
);

94 
	}
}

	@baresip/test/mock/mock_auplay.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"../‹¡.h
"

12 
	sau¶ay_¡
 {

13 cÚ¡ 
au¶ay
 *
	m­
;

15 
tmr
 
	mtmr
;

16 
au¶ay_´m
 
	m´m
;

17 *
	m§mpv
;

18 
size_t
 
	m§mpc
;

19 
au¶ay_wr™e_h
 *
	mwh
;

20 *
	m¬g
;

25 
mock_§m¶e_h
 *
	m§m¶eh
;

26 *
	m¬g
;

27 } 
	gmock
;

30 
	$tmr_hªdËr
(*
¬g
)

32 
au¶ay_¡
 *
¡
 = 
¬g
;

34 
	`tmr_¡¬t
(&
¡
->
tmr
, st->
´m
.
±ime
, 
tmr_hªdËr
, st);

36 ià(
¡
->
wh
)

37 
¡
->
	`wh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

40 ià(
mock
.
§m¶eh
)

41 
mock
.
	`§m¶eh
(
¡
->
§mpv
, st->
§mpc
, mock.
¬g
);

42 
	}
}

45 
	$au¶ay_de¡ruùÜ
(*
¬g
)

47 
au¶ay_¡
 *
¡
 = 
¬g
;

49 
	`tmr_ÿnûl
(&
¡
->
tmr
);

50 
	`mem_d”ef
(
¡
->
§mpv
);

51 
	}
}

54 
	$mock_au¶ay_®loc
(
au¶ay_¡
 **
¡p
, cÚ¡ 
au¶ay
 *
­
,

55 
au¶ay_´m
 *
´m
, cÚ¡ *
deviû
,

56 
au¶ay_wr™e_h
 *
wh
, *
¬g
)

58 
au¶ay_¡
 *
¡
;

59 
”r
 = 0;

60 ()
deviû
;

62 ià(!
¡p
 || !
­
 || !
´m
)

63  
EINVAL
;

65 
¡
 = 
	`mem_z®loc
((*¡), 
au¶ay_de¡ruùÜ
);

66 ià(!
¡
)

67  
ENOMEM
;

69 
¡
->
­
 =‡p;

70 
¡
->
´m
 = *prm;

71 
¡
->
wh
 = wh;

72 
¡
->
¬g
 =‡rg;

74 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

76 
¡
->
§mpv
 = 
	`mem_z®loc
(
	`aufmt_§m¶e_size
(
´m
->
fmt
è* st->
§mpc
, 
NULL
);

77 ià(!
¡
->
§mpv
) {

78 
”r
 = 
ENOMEM
;

79 
out
;

82 
	`tmr_¡¬t
(&
¡
->
tmr
, 0, 
tmr_hªdËr
, st);

84 
out
:

85 ià(
”r
)

86 
	`mem_d”ef
(
¡
);

88 *
¡p
 = 
¡
;

90  
”r
;

91 
	}
}

94 
	$mock_au¶ay_»gi¡”
(
au¶ay
 **
au¶ayp
,

95 
mock_§m¶e_h
 *
§m¶eh
, *
¬g
)

97 
mock
.
§m¶eh
 = sampleh;

98 
mock
.
¬g
 =‡rg;

100  
	`au¶ay_»gi¡”
(
au¶ayp
, 
	`b¬es_au¶ayl
(),

101 "mock-au¶ay", 
mock_au¶ay_®loc
);

102 
	}
}

	@baresip/test/mock/mock_ausrc.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"../‹¡.h
"

12 
	sau¤c_¡
 {

13 cÚ¡ 
au¤c
 *
	mas
;

15 
tmr
 
	mtmr
;

16 
au¤c_´m
 
	m´m
;

17 *
	m§mpv
;

18 
size_t
 
	m§mpc
;

19 
au¤c_»ad_h
 *
	mrh
;

20 *
	m¬g
;

24 
	$tmr_hªdËr
(*
¬g
)

26 
au¤c_¡
 *
¡
 = 
¬g
;

28 
	`tmr_¡¬t
(&
¡
->
tmr
, st->
´m
.
±ime
, 
tmr_hªdËr
, st);

30 ià(
¡
->
rh
)

31 
¡
->
	`rh
(¡->
§mpv
, st->
§mpc
, st->
¬g
);

32 
	}
}

35 
	$au¤c_de¡ruùÜ
(*
¬g
)

37 
au¤c_¡
 *
¡
 = 
¬g
;

39 
	`tmr_ÿnûl
(&
¡
->
tmr
);

40 
	`mem_d”ef
(
¡
->
§mpv
);

41 
	}
}

44 
	$mock_au¤c_®loc
(
au¤c_¡
 **
¡p
, cÚ¡ 
au¤c
 *
as
,

45 
medŸ_ùx
 **
ùx
,

46 
au¤c_´m
 *
´m
, cÚ¡ *
deviû
,

47 
au¤c_»ad_h
 *
rh
, 
au¤c_”rÜ_h
 *
”rh
, *
¬g
)

49 
au¤c_¡
 *
¡
;

50 
”r
 = 0;

51 ()
ùx
;

52 ()
deviû
;

53 ()
”rh
;

55 ià(!
¡p
 || !
as
 || !
´m
)

56  
EINVAL
;

58 
¡
 = 
	`mem_z®loc
((*¡), 
au¤c_de¡ruùÜ
);

59 ià(!
¡
)

60  
ENOMEM
;

62 
¡
->
as
 =‡s;

63 
¡
->
´m
 = *prm;

64 
¡
->
rh
 =„h;

65 
¡
->
¬g
 =‡rg;

67 
¡
->
§mpc
 = 
´m
->
¤©e
 *…rm->
ch
 *…rm->
±ime
 / 1000;

69 
¡
->
§mpv
 = 
	`mem_z®loc
(
	`aufmt_§m¶e_size
(
´m
->
fmt
è* st->
§mpc
, 
NULL
);

70 ià(!
¡
->
§mpv
) {

71 
”r
 = 
ENOMEM
;

72 
out
;

75 
	`tmr_¡¬t
(&
¡
->
tmr
, 0, 
tmr_hªdËr
, st);

77 
out
:

78 ià(
”r
)

79 
	`mem_d”ef
(
¡
);

81 *
¡p
 = 
¡
;

83  
”r
;

84 
	}
}

87 
	$mock_au¤c_»gi¡”
(
au¤c
 **
au¤ı
)

89  
	`au¤c_»gi¡”
(
au¤ı
, 
	`b¬es_au¤ş
(),

90 "mock-au¤c", 
mock_au¤c_®loc
);

91 
	}
}

	@baresip/test/mock/mock_vidcodec.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m.h
>

10 
	~<b¬es.h
>

11 
	~"../‹¡.h
"

14 
	#HDR_SIZE
 12

	)

17 
	shdr
 {

18 
vidfmt
 
	mfmt
;

19 
	mwidth
;

20 
	mheight
;

23 
	svid’c_¡©e
 {

24 
št64_t
 
	m±s
;

25 
	mås
;

26 
vid’c_·ck‘_h
 *
	mpkth
;

27 *
	m¬g
;

30 
	sviddec_¡©e
 {

31 
vidäame
 *
	mäame
;

35 
	$hdr_decode
(
hdr
 *hdr, 
mbuf
 *
mb
)

37 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
HDR_SIZE
)

38  
EBADMSG
;

40 
hdr
->
fmt
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

41 
hdr
->
width
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

42 
hdr
->
height
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

45 
	}
}

48 
	$decode_de¡ruùÜ
(*
¬g
)

50 
viddec_¡©e
 *
vds
 = 
¬g
;

52 
	`mem_d”ef
(
vds
->
äame
);

53 
	}
}

56 
	$mock_’code_upd©e
(
vid’c_¡©e
 **
ve¥
,

57 cÚ¡ 
vidcodec
 *
vc
,

58 
vid’c_·¿m
 *
´m
, cÚ¡ *
fm
,

59 
vid’c_·ck‘_h
 *
pkth
, *
¬g
)

61 
vid’c_¡©e
 *
ves
;

62 ()
fm
;

64 ià(!
ve¥
 || !
vc
 || !
´m
 ||…rm->
pktsize
 < (
HDR_SIZE
 + 1))

65  
EINVAL
;

67 
ves
 = *
ve¥
;

69 ià(!
ves
) {

71 
ves
 = 
	`mem_z®loc
((*ves), 
NULL
);

72 ià(!
ves
)

73  
ENOMEM
;

75 *
ve¥
 = 
ves
;

78 
ves
->
ås
 = 
´m
->fps;

79 
ves
->
pkth
 =…kth;

80 
ves
->
¬g
 =‡rg;

83 
	}
}

86 
	$mock_’code
(
vid’c_¡©e
 *
ves
, 
boŞ
 
upd©e
,

87 cÚ¡ 
vidäame
 *
äame
)

89 
mbuf
 *
hdr
;

90 
ušt8_t
 
·ylßd
[2] = {0,0};

91 
ušt32_t
 
¹p_ts
;

92 
”r
;

93 ()
upd©e
;

95 ià(!
ves
 || !
äame
)

96  
EINVAL
;

98 
hdr
 = 
	`mbuf_®loc
(16);

100 
”r
 = 
	`mbuf_wr™e_u32
(
hdr
, 
	`htÚl
(
äame
->
fmt
));

101 
”r
 |ğ
	`mbuf_wr™e_u32
(
hdr
, 
	`htÚl
(
äame
->
size
.
w
));

102 
”r
 |ğ
	`mbuf_wr™e_u32
(
hdr
, 
	`htÚl
(
äame
->
size
.
h
));

103 ià(
”r
)

104 
out
;

106 
¹p_ts
 = 
	`video_ÿlc_¹p_time¡amp
(++
ves
->
±s
, ves->
ås
);

108 
”r
 = 
ves
->
	`pkth
(
Œue
, 
¹p_ts
, 
hdr
->
buf
, hdr->
’d
,

109 
·ylßd
, Õaylßd), 
ves
->
¬g
);

110 ià(
”r
)

111 
out
;

113 
out
:

114 
	`mem_d”ef
(
hdr
);

116  
”r
;

117 
	}
}

120 
	$mock_decode_upd©e
(
viddec_¡©e
 **
vd¥
,

121 cÚ¡ 
vidcodec
 *
vc
, cÚ¡ *
fm
)

123 
viddec_¡©e
 *
vds
;

124 
”r
 = 0;

125 ()
vc
;

126 ()
fm
;

128 ià(!
vd¥
)

129  
EINVAL
;

131 
vds
 = *
vd¥
;

133 ià(
vds
)

136 
vds
 = 
	`mem_z®loc
((*vds), 
decode_de¡ruùÜ
);

137 ià(!
vds
)

138  
ENOMEM
;

140 ià(
”r
)

141 
	`mem_d”ef
(
vds
);

143 *
vd¥
 = 
vds
;

145  
”r
;

146 
	}
}

149 
	$mock_decode
(
viddec_¡©e
 *
vds
, 
vidäame
 *
äame
,

150 
boŞ
 *
šŒa
, boŞ 
m¬k”
, 
ušt16_t
 
£q
, 
mbuf
 *
mb
)

152 
vidsz
 
size
;

153 
hdr
 hdr;

154 
”r
, 
i
;

155 ()
m¬k”
;

156 ()
£q
;

158 ià(!
vds
 || !
äame
 || !
šŒa
 || !
mb
)

159  
EINVAL
;

161 *
šŒa
 = 
çl£
;

163 
”r
 = 
	`hdr_decode
(&
hdr
, 
mb
);

164 ià(
”r
) {

165 
	`w¬nšg
("mock_vidcodec: could‚Ù decodh—d” (%m)\n", 
”r
);

166  
”r
;

169 
size
.
w
 = 
hdr
.
width
;

170 
size
.
h
 = 
hdr
.
height
;

172 ià(!
vds
->
äame
) {

173 
”r
 = 
	`vidäame_®loc
(&
vds
->
äame
, 
hdr
.
fmt
, &
size
);

174 ià(
”r
)

175 
out
;

178 
i
=0; i<4; i++) {

179 
äame
->
d©a
[
i
] = 
vds
->frame->data[i];

180 
äame
->
lšesize
[
i
] = 
vds
->frame->linesize[i];

183 
äame
->
size
.
w
 = 
vds
->frame->size.w;

184 
äame
->
size
.
h
 = 
vds
->frame->size.h;

185 
äame
->
fmt
 = 
vds
->frame->fmt;

187 
out
:

188  
”r
;

189 
	}
}

192 
vidcodec
 
	gvc_dummy
 = {

193 .
Çme
 = "H266",

194 .
	g’cupdh
 = 
mock_’code_upd©e
,

195 .
	g’ch
 = 
mock_’code
,

196 .
	gdecupdh
 = 
mock_decode_upd©e
,

197 .
	gdech
 = 
mock_decode
,

201 
	$mock_vidcodec_»gi¡”
()

203 
	`vidcodec_»gi¡”
(
	`b¬es_vidcodeş
(), &
vc_dummy
);

204 
	}
}

207 
	$mock_vidcodec_uÄegi¡”
()

209 
	`vidcodec_uÄegi¡”
(&
vc_dummy
);

210 
	}
}

	@baresip/test/mock/mock_vidisp.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"../‹¡.h
"

12 
	#MAX_WIDTH
 65536

	)

13 
	#MAX_HEIGHT
 65536

	)

16 
	svidi¥_¡
 {

17 cÚ¡ 
vidi¥
 *
	mvd
;

18 
	mn_äame
;

22 
	$di¥_de¡ruùÜ
(*
¬g
)

24 
vidi¥_¡
 *
¡
 = 
¬g
;

25 ()
¡
;

26 
	}
}

29 
	$mock_di¥_®loc
(
vidi¥_¡
 **
¡p
, cÚ¡ 
vidi¥
 *
vd
,

30 
vidi¥_´m
 *
´m
, cÚ¡ *
dev
,

31 
vidi¥_»size_h
 *
»sizeh
, *
¬g
)

33 
vidi¥_¡
 *
¡
;

34 ()
´m
;

35 ()
dev
;

36 ()
»sizeh
;

37 ()
¬g
;

39 ià(!
¡p
 || !
vd
)

40  
EINVAL
;

42 
¡
 = 
	`mem_z®loc
((*¡), 
di¥_de¡ruùÜ
);

43 ià(!
¡
)

44  
ENOMEM
;

46 
¡
->
vd
 = vd;

48 *
¡p
 = 
¡
;

51 
	}
}

54 
	$mock_di¥Ïy
(
vidi¥_¡
 *
¡
, cÚ¡ *
t™Ë
,

55 cÚ¡ 
vidäame
 *
äame
)

57 
width
, 
height
;

58 ()
t™Ë
;

60 ià(!
¡
 || !
äame
)

61  
EINVAL
;

63 
width
 = 
äame
->
size
.
w
;

64 
height
 = 
äame
->
size
.
h
;

66 ià(!
	`vidäame_isv®id
(
äame
)) {

67 
	`w¬nšg
("mock_vidisp: got invalid frame\n");

68  
EPROTO
;

72 ià(
äame
->
fmt
 >ğ
VID_FMT_N
)

73  
EPROTO
;

74 ià(
width
 =ğ0 || width > 
MAX_WIDTH
)

75  
EPROTO
;

76 ià(
height
 =ğ0 || heighˆ> 
MAX_HEIGHT
)

77  
EPROTO
;

78 ià(
äame
->
lšesize
[0] == 0)

79  
EPROTO
;

81 ++
¡
->
n_äame
;

83 ià(
¡
->
n_äame
 >= 10) {

84 
	`šfo
("mock_vidisp: got %u frames -- stopping„e_main\n",

85 
¡
->
n_äame
);

86 
	`»_ÿnûl
();

90 
	}
}

93 
	$mock_vidi¥_»gi¡”
(
vidi¥
 **
vidi¥p
)

95  
	`vidi¥_»gi¡”
(
vidi¥p
, 
	`b¬es_vidi¥l
(), "mock-vidisp",

96 
mock_di¥_®loc
, 
NULL
, 
mock_di¥Ïy
, NULL);

97 
	}
}

	@baresip/test/mock/mock_vidsrc.c

6 
	~<».h
>

7 
	~<»m.h
>

8 
	~<b¬es.h
>

9 
	~"../‹¡.h
"

12 
	svid¤c_¡
 {

13 cÚ¡ 
vid¤c
 *
	mvs
;

15 
vidäame
 *
	mäame
;

16 
tmr
 
	mtmr
;

17 
	mås
;

18 
vid¤c_äame_h
 *
	mäameh
;

19 *
	m¬g
;

23 
	$tmr_hªdËr
(*
¬g
)

25 
vid¤c_¡
 *
¡
 = 
¬g
;

27 
	`tmr_¡¬t
(&
¡
->
tmr
, 1000/¡->
ås
, 
tmr_hªdËr
, st);

29 ià(
¡
->
äameh
)

30 
¡
->
	`äameh
(¡->
äame
, st->
¬g
);

31 
	}
}

34 
	$vid¤c_de¡ruùÜ
(*
¬g
)

36 
vid¤c_¡
 *
¡
 = 
¬g
;

38 
	`tmr_ÿnûl
(&
¡
->
tmr
);

39 
	`mem_d”ef
(
¡
->
äame
);

40 
	}
}

43 
	$mock_vid¤c_®loc
(
vid¤c_¡
 **
¡p
, cÚ¡ 
vid¤c
 *
vs
,

44 
medŸ_ùx
 **
ùx
, 
vid¤c_´m
 *
´m
,

45 cÚ¡ 
vidsz
 *
size
, cÚ¡ *
fmt
,

46 cÚ¡ *
dev
, 
vid¤c_äame_h
 *
äameh
,

47 
vid¤c_”rÜ_h
 *
”rÜh
, *
¬g
)

49 
vid¤c_¡
 *
¡
;

50 
”r
 = 0;

51 ()
ùx
;

52 ()
fmt
;

53 ()
dev
;

54 ()
”rÜh
;

56 ià(!
¡p
 || !
´m
 || !
size
 || !
äameh
)

57  
EINVAL
;

59 
¡
 = 
	`mem_z®loc
((*¡), 
vid¤c_de¡ruùÜ
);

60 ià(!
¡
)

61  
ENOMEM
;

63 
¡
->
vs
 = vs;

64 
¡
->
ås
 = 
´m
->fps;

65 
¡
->
äameh
 = frameh;

66 
¡
->
¬g
 =‡rg;

68 
”r
 = 
	`vidäame_®loc
(&
¡
->
äame
, 
VID_FMT_YUV420P
, 
size
);

69 ià(
”r
)

70 
out
;

72 
	`tmr_¡¬t
(&
¡
->
tmr
, 0, 
tmr_hªdËr
, st);

74 
	`šfo
("mock_vidsrc:‚ew instance with size %u x %u (%d fps)\n",

75 
size
->
w
, size->
h
, 
´m
->
ås
);

77 
out
:

78 ià(
”r
)

79 
	`mem_d”ef
(
¡
);

81 *
¡p
 = 
¡
;

83  
”r
;

84 
	}
}

87 
	$mock_vid¤c_»gi¡”
(
vid¤c
 **
vid¤ı
)

89  
	`vid¤c_»gi¡”
(
vid¤ı
, 
	`b¬es_vid¤ş
(), "mock-vidsrc",

90 
mock_vid¤c_®loc
, 
NULL
);

91 
	}
}

	@baresip/test/mos.c

6 
	~<».h
>

7 
	~<b¬es.h
>

8 
	~"‹¡.h
"

11 
	#DEBUG_MODULE
 "mos"

	)

12 
	#DEBUG_LEVEL
 5

	)

13 
	~<»_dbg.h
>

16 
	$‹¡_mos
()

18 
	#PRECISION
 0.001

	)

21 
¹t
;

22 
j™‹r
;

23 
ušt32_t
 
·ck‘_loss
;

26 
r_çùÜ
;

27 
mos
;

28 } 
‹¡v
[] = {

38 
size_t
 
i
;

39 
”r
 = 0;

41 
i
=0; i<
	`ARRAY_SIZE
(
‹¡v
); i++) {

42 
r_çùÜ
, 
mos
;

44 
mos
 = 
	`mos_ÿlcuÏ‹
(&
r_çùÜ
, 
‹¡v
[
i
].
¹t
,e¡v[i].
j™‹r
,

45 
‹¡v
[
i
].
·ck‘_loss
);

47 
	`ASSERT_DOUBLE_EQ
(
‹¡v
[
i
].
r_çùÜ
,„_çùÜ, 
PRECISION
);

48 
	`ASSERT_DOUBLE_EQ
(
‹¡v
[
i
].
mos
, mos, 
PRECISION
);

51 
out
:

52  
”r
;

53 
	}
}

	@baresip/test/net.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
cÚfig_Ãt
 
	gdeçuÉ_cÚfig
;

15 
	$Ãt_chªge_hªdËr
(*
¬g
)

17 *
couÁ
 = 
¬g
;

18 ++*
couÁ
;

19 
	`šfo
("network changed\n");

20 
	}
}

23 
	$‹¡_ÃtwÜk
()

25 
ÃtwÜk
 *
Ãt
 = 
NULL
;

26 
chªge_couÁ
 = 0;

27 
”r
;

29 
”r
 = 
	`Ãt_®loc
(&
Ãt
, &
deçuÉ_cÚfig
, 
AF_INET
);

30 
	`TEST_ERR
(
”r
);

31 
	`ASSERT_TRUE
(
Ãt
 !ğ
NULL
);

33 
	`ASSERT_EQ
(
AF_INET
, 
	`Ãt_af
(
Ãt
));

35 
	`Ãt_chªge
(
Ãt
, 1, 
Ãt_chªge_hªdËr
, &
chªge_couÁ
);

37 
	`ASSERT_EQ
(0, 
chªge_couÁ
);

39 
	`Ãt_fÜû_chªge
(
Ãt
);

41 
	`ASSERT_EQ
(1, 
chªge_couÁ
);

43 
out
:

44 
	`mem_d”ef
(
Ãt
);

45  
”r
;

46 
	}
}

	@baresip/test/play.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	#NUM_SAMPLES
 320

	)

15 
	s‹¡
 {

16 
mbuf
 *
	mmb_§mp
;

20 
mbuf
 *
	$g’”©e_tÚe
()

22 
mbuf
 *
mb
;

23 
i
;

24 
”r
 = 0;

26 
mb
 = 
	`mbuf_®loc
(
NUM_SAMPLES
 * 2);

27 ià(!
mb
)

28  
NULL
;

30 
i
=0; i<
NUM_SAMPLES
; i++)

31 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
i
);

33 
mb
->
pos
 = 0;

35 ià(
”r
)

36  
	`mem_d”ef
(
mb
);

38  
mb
;

39 
	}
}

42 
	$§m¶e_hªdËr
(cÚ¡ *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

44 
‹¡
 *‹¡ = 
¬g
;

45 
size_t
 
by‹c
 = 
§mpc
 * 2;

46 
”r
 = 0;

48 ià(!
‹¡
->
mb_§mp
) {

49 
‹¡
->
mb_§mp
 = 
	`mbuf_®loc
(
by‹c
);

50 
	`ASSERT_TRUE
(
‹¡
->
mb_§mp
 !ğ
NULL
);

54 
”r
 = 
	`mbuf_wr™e_mem
(
‹¡
->
mb_§mp
, (*)
§mpv
, 
by‹c
);

56 
out
:

58 ià(
”r
 || 
‹¡
->
mb_§mp
->
’d
 >ğ(
NUM_SAMPLES
*2))

59 
	`»_ÿnûl
();

60 
	}
}

63 
	$‹¡_¶ay
()

65 
au¶ay
 *au¶ay = 
NULL
;

66 
¶ay”
 *¶ay” = 
NULL
;

67 
¶ay
 *¶ay = 
NULL
;

68 
mbuf
 *
mb_tÚe
 = 
NULL
;

69 
‹¡
est = {0};

70 
”r
;

73 
”r
 = 
	`mock_au¶ay_»gi¡”
(&
au¶ay
, 
§m¶e_hªdËr
, &
‹¡
);

74 
	`ASSERT_EQ
(0, 
”r
);

76 
”r
 = 
	`¶ay_š™
(&
¶ay”
);

77 
	`ASSERT_EQ
(0, 
”r
);

79 
mb_tÚe
 = 
	`g’”©e_tÚe
();

80 
	`ASSERT_TRUE
(
mb_tÚe
 !ğ
NULL
);

82 
”r
 = 
	`¶ay_tÚe
(&
¶ay
, 
¶ay”
, 
mb_tÚe
, 8000, 1, 0);

83 
	`ASSERT_EQ
(0, 
”r
);

85 
”r
 = 
	`»_maš_timeout
(10000);

86 
	`ASSERT_EQ
(0, 
”r
);

89 
	`TEST_MEMCMP
(
mb_tÚe
->
buf
, 
NUM_SAMPLES
*2,

90 
‹¡
.
mb_§mp
->
buf
,e¡.mb_§mp->
’d
);

92 
out
:

93 
	`mem_d”ef
(
‹¡
.
mb_§mp
);

94 
	`mem_d”ef
(
mb_tÚe
);

95 
	`mem_d”ef
(
¶ay
);

96 
	`mem_d”ef
(
¶ay”
);

97 
	`mem_d”ef
(
au¶ay
);

98  
”r
;

99 
	}
}

	@baresip/test/sip/aor.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~"s¤v.h
"

11 
	$de¡ruùÜ
(*
¬g
)

13 
aÜ
 *aÜ = 
¬g
;

15 
	`li¡_æush
(&
aÜ
->
loş
);

16 
	`hash_uÆšk
(&
aÜ
->
he
);

17 
	`mem_d”ef
(
aÜ
->
uri
);

18 
	}
}

21 
	$uri_ÿnÚ
(**
cur
, cÚ¡ 
uri
 *uri)

23 ià(
	`¶_is£t
(&
uri
->
u£r
))

24  
	`»_sd´štf
(
cur
, "%r:%H@%r",

25 &
uri
->
scheme
,

26 
uri_u£r_uÃsÿ³
, &
uri
->
u£r
,

27 &
uri
->
ho¡
);

29  
	`»_sd´štf
(
cur
, "%r:%r",

30 &
uri
->
scheme
,

31 &
uri
->
ho¡
);

32 
	}
}

35 
	$aÜ_ü—‹
(
s_£rv”
 *
¤v
, 
aÜ
 **
aÜp
,

36 cÚ¡ 
uri
 *uri)

38 
aÜ
 *aor;

39 
”r
;

41 ià(!
aÜp
 || !
uri
)

42  
EINVAL
;

44 
aÜ
 = 
	`mem_z®loc
((*aÜ), 
de¡ruùÜ
);

45 ià(!
aÜ
)

46  
ENOMEM
;

48 
”r
 = 
	`uri_ÿnÚ
(&
aÜ
->
uri
, uri);

49 ià(
”r
)

50 
out
;

52 
	`hash_­³nd
(
¤v
->
ht_aÜ
, 
	`hash_jß©_¡r_ci
(
aÜ
->
uri
), &aÜ->
he
,‡or);

54 
out
:

55 ià(
”r
)

56 
	`mem_d”ef
(
aÜ
);

58 *
aÜp
 = 
aÜ
;

60  
”r
;

61 
	}
}

64 
	$aÜ_fšd
(
s_£rv”
 *
¤v
, 
aÜ
 **
aÜp
, cÚ¡ 
uri
 *uri)

66 
li¡
 *
l¡
;

67 
aÜ
 *aÜ = 
NULL
;

68 
Ë
 *le;

69 *
curi
;

70 
”r
;

72 ià(!
uri
)

73  
EINVAL
;

75 
”r
 = 
	`uri_ÿnÚ
(&
curi
, 
uri
);

76 ià(
”r
)

77  
”r
;

79 
l¡
 = 
	`hash_li¡
(
¤v
->
ht_aÜ
, 
	`hash_jß©_¡r_ci
(
curi
));

81 
Ë
=
	`li¡_h—d
(
l¡
);†e;†eöe->
Ãxt
) {

83 
aÜ
 = 
Ë
->
d©a
;

85 ià(!
	`¡r_ÿ£cmp
(
curi
, 
aÜ
->
uri
))

89 
	`mem_d”ef
(
curi
);

91 ià(!
Ë
)

92  
ENOENT
;

94 ià(
aÜp
)

95 *
aÜp
 = 
aÜ
;

98 
	}
}

	@baresip/test/sip/auth.c

6 
	~<¡ršg.h
>

7 
	~<time.h
>

8 
	~<».h
>

9 
	~"s¤v.h
"

13 
	mNONCE_MIN_SIZE
 = 33,

17 
	$auth_´št
(
»_´štf
 *
pf
, cÚ¡ 
auth
 *auth)

19 
ušt8_t
 
key
[
MD5_SIZE
];

20 
ušt64_t
 
nv
[2];

22 ià(!
auth
)

23  
EINVAL
;

25 
nv
[0] = 
	`time
(
NULL
);

26 
nv
[1] = 
auth
->
¤v
->
£ü‘
;

28 
	`md5
((
ušt8_t
 *)
nv
, Òv), 
key
);

30  
	`»_h´štf
(
pf
,

33 
auth
->
»®m
,

34 
key
, (key), 
nv
[0],

35 
auth
->
¡®e
 ? ", stale=true" : "");

36 
	}
}

39 
	$auth_chk_nÚû
(
s_£rv”
 *
¤v
,

40 cÚ¡ 
¶
 *
nÚû
, 
ušt32_t
 
expœes
)

42 
ušt8_t
 
nkey
[
MD5_SIZE
], 
ckey
[MD5_SIZE];

43 
ušt64_t
 
nv
[2];

44 
¶
…l;

45 
št64_t
 
age
;

46 
i
;

48 ià(!
nÚû
 || !nÚû->
p
 ||‚Úû->
l
 < 
NONCE_MIN_SIZE
)

49  
EINVAL
;

51 
¶
 = *
nÚû
;

53 
i
=0; i<(
nkey
); i++) {

54 
nkey
[
i
] = 
	`ch_hex
(*
¶
.
p
++) << 4;

55 
nkey
[
i
] +ğ
	`ch_hex
(*
¶
.
p
++);

56 
¶
.
l
 -= 2;

59 
nv
[0] = 
	`¶_x64
(&
¶
);

60 
nv
[1] = 
¤v
->
£ü‘
;

62 
	`md5
((
ušt8_t
 *)
nv
, Òv), 
ckey
);

64 ià(
	`memcmp
(
nkey
, 
ckey
, 
MD5_SIZE
))

65  
EAUTH
;

67 
age
 = 
	`time
(
NULL
è- 
nv
[0];

69 ià(
age
 < 0 ||‡g> 
expœes
)

70  
ETIMEDOUT
;

73 
	}
}

76 
	$auth_£t_»®m
(
auth
 *auth, cÚ¡ *
»®m
)

78 
size_t
 
Ën
;

80 ià(!
auth
 || !
»®m
)

81  
EINVAL
;

83 
Ën
 = 
	`¡¾’
(
»®m
);

84 ià(
Ën
 >ğ(
auth
->
»®m
))

85  
ENOMEM
;

87 
	`memıy
(
auth
->
»®m
,„—lm, 
Ën
);

88 
auth
->
»®m
[
Ën
] = '\0';

91 
	}
}

	@baresip/test/sip/domain.c

6 
	~<».h
>

7 
	~"s¤v.h
"

10 
	#DEBUG_MODULE
 "mock/s¤v"

	)

11 
	#DEBUG_LEVEL
 5

	)

12 
	~<»_dbg.h
>

16 
	mNONCE_EXPIRES
 = 300,

20 
	$de¡ruùÜ
(*
¬g
)

22 
domaš
 *
dom
 = 
¬g
;

24 
	`hash_uÆšk
(&
dom
->
he
);

25 
	`hash_æush
(
dom
->
ht_u¤
);

26 
	`mem_d”ef
(
dom
->
ht_u¤
);

27 
	`mem_d”ef
(
dom
->
Çme
);

28 
	}
}

31 
domaš
 *
	$lookup
(
s_£rv”
 *
¤v
, cÚ¡ 
¶
 *
Çme
)

33 
li¡
 *
l¡
;

34 
Ë
 *le;

36 
l¡
 = 
	`hash_li¡
(
¤v
->
ht_dom
, 
	`hash_jß©_ci
(
Çme
->
p
,‚ame->
l
));

38 
Ë
=
	`li¡_h—d
(
l¡
);†e;†eöe->
Ãxt
) {

40 
domaš
 *
dom
 = 
Ë
->
d©a
;

42 ià(
	`¶_¡rÿ£cmp
(
Çme
, 
dom
->name))

45  
dom
;

48  
NULL
;

49 
	}
}

52 
	$domaš_add
(
s_£rv”
 *
¤v
, cÚ¡ *
Çme
)

54 
domaš
 *
dom
;

55 
”r
;

57 
dom
 = 
	`mem_z®loc
((*dom), 
de¡ruùÜ
);

58 ià(!
dom
)

59  
ENOMEM
;

61 
”r
 = 
	`¡r_dup
(&
dom
->
Çme
,‚ame);

62 ià(
”r
)

63 
out
;

65 
”r
 = 
	`hash_®loc
(&
dom
->
ht_u¤
, 32);

66 ià(
”r
)

67  
”r
;

69 
	`hash_­³nd
(
¤v
->
ht_dom
, 
	`hash_jß©_¡r_ci
(
Çme
), &
dom
->
he
, dom);

71 
out
:

72 ià(
”r
)

73 
	`mem_d”ef
(
dom
);

75  
”r
;

76 
	}
}

79 
	$domaš_fšd
(
s_£rv”
 *
¤v
, cÚ¡ 
uri
 *uri)

81 
”r
 = 
ENOENT
;

82 
§
 
addr
;

84 ià(!
uri
)

85  
EINVAL
;

87 ià(!
	`§_£t
(&
addr
, &
uri
->
ho¡
, uri->
pÜt
)) {

89 ià(!
uri
->
pÜt
) {

91 
ušt16_t
 
pÜt
 = 
SIP_PORT
;

93 ià(!
	`¶_¡rÿ£cmp
(&
uri
->
scheme
, "sips"))

94 
pÜt
 = 
SIP_PORT_TLS
;

96 
	`§_£t_pÜt
(&
addr
, 
pÜt
);

99 ià(
	`s_Œª¥_i¦addr
(
¤v
->
s
, 
SIP_TRANSP_NONE
, &
addr
))

102  
ENOENT
;

105 
”r
 = 
	`lookup
(
¤v
, &
uri
->
ho¡
è? 0 : 
ENOENT
;

107  
”r
;

108 
	}
}

111 
	$domaš_auth
(
s_£rv”
 *
¤v
,

112 cÚ¡ 
uri
 *uri, 
boŞ
 
u£r_m©ch
,

113 cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
hdrid
,

114 
auth
 *auth)

116 
domaš
 *
dom
;

117 
li¡
 *
l¡
;

118 
Ë
 *le;

119 
”r
 = 
ENOENT
;

121 ià(!
uri
 || !
msg
 || !
auth
)

122  
EINVAL
;

124 
dom
 = 
	`lookup
(
¤v
, &
uri
->
ho¡
);

125 ià(!
dom
) {

126 
	`DEBUG_WARNING
("domaš‚Ù found (%r)\n", &
uri
->
ho¡
);

127  
ENOENT
;

130 
”r
 = 
	`auth_£t_»®m
(
auth
, 
dom
->
Çme
);

131 ià(
”r
)

132  
”r
;

134 
auth
->
¡®e
 = 
çl£
;

136 
l¡
 = 
	`hash_li¡
(
msg
->
hdrht
, 
hdrid
);

138 
Ë
=
	`li¡_h—d
(
l¡
);†e;†eöe->
Ãxt
) {

140 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

141 
h‰·uth_dige¡_»¥
 
»¥
;

142 cÚ¡ 
u£r
 *
u¤
;

144 ià(
hdr
->
id
 !ğ
hdrid
)

147 ià(
	`h‰·uth_dige¡_»¥Ú£_decode
(&
»¥
, &
hdr
->
v®
))

150 ià(
	`¶_¡rÿ£cmp
(&
»¥
.
»®m
, 
dom
->
Çme
))

153 ià(
	`auth_chk_nÚû
(
¤v
, &
»¥
.
nÚû
, 
NONCE_EXPIRES
)) {

154 
auth
->
¡®e
 = 
Œue
;

158 
auth
->
¡®e
 = 
çl£
;

160 
u¤
 = 
	`u£r_fšd
(
dom
->
ht_u¤
, &
»¥
.
u£ºame
);

161 ià(!
u¤
) {

162 
	`DEBUG_WARNING
("u£¸nÙ found (%r)\n", &
»¥
.
u£ºame
);

166 
”r
 = 
	`h‰·uth_dige¡_»¥Ú£_auth
(&
»¥
, &
msg
->
m‘
,
u¤
->
ha1
);

167 ià(
”r
)

168  
”r
;

170 ià(
u£r_m©ch
 && 
	`¶_cmp
(&
»¥
.
u£ºame
, &
uri
->
u£r
))

171  
EPERM
;

176  
EAUTH
;

177 
	}
}

180 
domaš
 *
	$domaš_lookup
(
s_£rv”
 *
¤v
, cÚ¡ *
Çme
)

182 
¶
…l;

184 
	`¶_£t_¡r
(&
¶
, 
Çme
);

186  
	`lookup
(
¤v
, &
¶
);

187 
	}
}

	@baresip/test/sip/location.c

6 
	~<time.h
>

7 
	~<».h
>

8 
	~"s¤v.h
"

11 
	sloùmp
 {

12 
§
 
	m¤c
;

13 
uri
 
	mduri
;

14 *
	muri
;

15 *
	mÿÎid
;

16 
ušt32_t
 
	mexpœes
;

17 
ušt32_t
 
	mc£q
;

18 
	mq
;

22 
	$de¡ruùÜ_loùmp
(*
¬g
)

24 
loùmp
 *
tmp
 = 
¬g
;

26 
	`mem_d”ef
(
tmp
->
uri
);

27 
	`mem_d”ef
(
tmp
->
ÿÎid
);

28 
	}
}

31 
	$de¡ruùÜ_loÿtiÚ
(*
¬g
)

33 
loÿtiÚ
 *
loc
 = 
¬g
;

35 
	`li¡_uÆšk
(&
loc
->
Ë
);

36 
	`mem_d”ef
(
loc
->
uri
);

37 
	`mem_d”ef
(
loc
->
ÿÎid
);

38 
	`mem_d”ef
(
loc
->
tmp
);

39 
	}
}

42 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

44 
loÿtiÚ
 *
loc
 = 
Ë
->
d©a
;

46  
	`uri_cmp
(&
loc
->
duri
, 
¬g
);

47 
	}
}

50 
	$loÿtiÚ_upd©e
(
li¡
 *
loş
, cÚ¡ 
s_msg
 *
msg
,

51 cÚ¡ 
s_addr
 *
cÚù
, 
ušt32_t
 
expœes
)

53 
loÿtiÚ
 *
loc
, *
loc_Ãw
 = 
NULL
;

54 
loùmp
 *
tmp
;

55 
¶
…l;

56 
”r
;

58 ià(!
loş
 || !
msg
 || !
cÚù
)

59  
EINVAL
;

61 
loc
 = 
	`li¡_Ëd©a
(
	`li¡_­¶y
(
loş
, 
Œue
, 
cmp_hªdËr
,

62 (*)&
cÚù
->
uri
));

63 ià(!
loc
) {

64 ià(
expœes
 == 0)

67 
loc
 = 
loc_Ãw
 = 
	`mem_z®loc
((*loc), 
de¡ruùÜ_loÿtiÚ
);

68 ià(!
loc
)

69  
ENOMEM
;

71 
	`li¡_­³nd
(
loş
, &
loc
->
Ë
,†oc);

74 ià(!
	`¶_¡rcmp
(&
msg
->
ÿÎid
, 
loc
->callid) &&

75 
msg
->
c£q
.
num
 <ğ
loc
->cseq)

76  
EPROTO
;

78 ià(
expœes
 == 0) {

79 
loc
->
rm
 = 
Œue
;

84 
tmp
 = 
	`mem_z®loc
((*tmp), 
de¡ruùÜ_loùmp
);

85 ià(!
tmp
) {

86 
”r
 = 
ENOMEM
;

87 
out
;

90 
”r
 = 
	`¶_¡rdup
(&
tmp
->
uri
, &
cÚù
->
auri
);

91 ià(
”r
)

92 
out
;

94 
	`¶_£t_¡r
(&
¶
, 
tmp
->
uri
);

96 ià(
	`uri_decode
(&
tmp
->
duri
, &
¶
)) {

97 
”r
 = 
EBADMSG
;

98 
out
;

101 
”r
 = 
	`¶_¡rdup
(&
tmp
->
ÿÎid
, &
msg
->callid);

102 ià(
”r
)

103 
out
;

106 ià(!
	`msg_·¿m_decode
(&
cÚù
->
·¿ms
, "q", &
¶
))

107 
tmp
->
q
 = 
	`¶_æßt
(&
¶
);

109 
tmp
->
q
 = 1;

111 
tmp
->
c£q
 = 
msg
->c£q.
num
;

112 
tmp
->
expœes
 =ƒxpires;

113 
tmp
->
¤c
 = 
msg
->src;

115 
out
:

116 ià(
”r
) {

117 
	`mem_d”ef
(
loc_Ãw
);

118 
	`mem_d”ef
(
tmp
);

121 
	`mem_d”ef
(
loc
->
tmp
);

122 
loc
->
tmp
 =mp;

125  
”r
;

126 
	}
}

129 
	$loÿtiÚ_comm™
(
li¡
 *
loş
)

131 
time_t
 
now
 = 
	`time
(
NULL
);

132 
Ë
 *le;

134 ià(!
loş
)

137 
Ë
=
loş
->
h—d
;†e; ) {

139 
loÿtiÚ
 *
loc
 = 
Ë
->
d©a
;

141 
Ë
 =†e->
Ãxt
;

143 ià(
loc
->
rm
) {

144 
	`li¡_uÆšk
(&
loc
->
Ë
);

145 
	`mem_d”ef
(
loc
);

147 ià(
loc
->
tmp
) {

149 
	`mem_d”ef
(
loc
->
uri
);

150 
	`mem_d”ef
(
loc
->
ÿÎid
);

152 
loc
->
uri
 = 
	`mem_»f
Öoc->
tmp
->uri);

153 
loc
->
ÿÎid
 = 
	`mem_»f
Öoc->
tmp
->callid);

154 
loc
->
duri
 =†oc->
tmp
->duri;

155 
loc
->
c£q
 =†oc->
tmp
->cseq;

156 
loc
->
expœes
 =†oc->
tmp
->expœe + 
now
;

157 
loc
->
¤c
 =†oc->
tmp
->src;

158 
loc
->
q
 =†oc->
tmp
->q;

160 
loc
->
tmp
 = 
	`mem_d”ef
(loc->tmp);

163 
	}
}

166 
	$loÿtiÚ_rŞlback
(
li¡
 *
loş
)

168 
Ë
 *le;

170 ià(!
loş
)

173 
Ë
=
loş
->
h—d
;†e; ) {

175 
loÿtiÚ
 *
loc
 = 
Ë
->
d©a
;

177 
Ë
 =†e->
Ãxt
;

179 ià(!
loc
->
uri
) {

180 
	`li¡_uÆšk
(&
loc
->
Ë
);

181 
	`mem_d”ef
(
loc
);

184 
loc
->
tmp
 = 
	`mem_d”ef
(loc->tmp);

185 
loc
->
rm
 = 
çl£
;

188 
	}
}

	@baresip/test/sip/sipsrv.c

6 
	~<¡ršg.h
>

7 
	~<time.h
>

8 
	~<».h
>

9 
	~<b¬es.h
>

10 
	~"../‹¡.h
"

11 
	~"s¤v.h
"

14 
	#DEBUG_MODULE
 "mock/s¤v"

	)

15 
	#DEBUG_LEVEL
 5

	)

16 
	~<»_dbg.h
>

19 
	#LOCAL_PORT
 0

	)

20 
	#LOCAL_SECURE_PORT
 0

	)

21 
	#EXPIRES_MIN
 60

	)

22 
	#EXPIRES_MAX
 3600

	)

25 
	$´št_cÚù
(
»_´štf
 *
pf
, cÚ¡ 
aÜ
 *aor)

27 cÚ¡ 
ušt64_t
 
now
 = (ušt64_t)
	`time
(
NULL
);

28 
Ë
 *le;

29 
”r
 = 0;

31 
Ë
=
aÜ
->
loş
.
h—d
;†e;†eöe->
Ãxt
) {

33 cÚ¡ 
loÿtiÚ
 *
loc
 = 
Ë
->
d©a
;

35 ià(
loc
->
expœes
 < 
now
)

38 
”r
 |ğ
	`»_h´štf
(
pf
, "Contact: <%s>;expires=%lli\r\n",

39 
loc
->
uri
,†oc->
expœes
 - 
now
);

42  
”r
;

43 
	}
}

46 
boŞ
 
	$hªdË_»gi¡”
(
s_£rv”
 *
¤v
, cÚ¡ 
s_msg
 *
msg
)

48 
auth
‡uth = { 
¤v
, "", 
çl£
 };

49 
s
 *s = 
¤v
->sip;

50 
li¡
 *
l¡
;

51 
aÜ
 *aor;

52 
Ë
 *le;

53 
”r
;

56 
”r
 = 
	`domaš_fšd
(
¤v
, &
msg
->
uri
);

57 ià(
”r
) {

58 ià(
”r
 =ğ
ENOENT
) {

59 
	`w¬nšg
("domain‚ot found\n");

60  
çl£
;

63 
	`s_»¶y
(
s
, 
msg
, 500, 
	`¡»¼Ü
(
”r
));

64 
	`w¬nšg
("domaš fšdƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”r
));

65  
Œue
;

69 ià(
¤v
->
auth_’abËd
)

70 
”r
 = 
	`domaš_auth
(
¤v
, &
msg
->
to
.
uri
, 
Œue
,

71 
msg
, 
SIP_HDR_AUTHORIZATION
, &
auth
);

73 
”r
 = 
	`domaš_fšd
(
¤v
, &
msg
->
to
.
uri
);

75 ià(
”r
 &&ƒ¼ !ğ
EAUTH
) {

76 
	`DEBUG_NOTICE
("domaš‡uth/fšdƒ¼Ü: %m\n", 
”r
);

79 
”r
) {

84 
EAUTH
:

85 
	`s_»¶yf
(
s
, 
msg
, 401, "Unauthorized",

88 
auth_´št
, &
auth
);

89  
Œue
;

91 
EPERM
:

92 
	`s_»¶y
(
s
, 
msg
, 403, "Forbidden");

93  
Œue
;

95 
ENOENT
:

96 
	`s_»¶y
(
s
, 
msg
, 404, "Not Found");

97  
Œue
;

100 
	`s_»¶y
(
s
, 
msg
, 500, 
	`¡»¼Ü
(
”r
));

101 
	`w¬nšg
("domašƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”r
));

102  
Œue
;

106 
”r
 = 
	`aÜ_fšd
(
¤v
, &
aÜ
, &
msg
->
to
.
uri
);

107 ià(
”r
) {

108 ià(
”r
 !ğ
ENOENT
) {

109 
	`s_»¶y
(
s
, 
msg
, 500, 
	`¡»¼Ü
(
”r
));

110 
	`w¬nšg
("aÜ fšdƒ¼Ü: %s\n", 
	`¡»¼Ü
(
”r
));

111  
Œue
;

114 
”r
 = 
	`aÜ_ü—‹
(
¤v
, &
aÜ
, &
msg
->
to
.
uri
);

115 ià(
”r
) {

116 
	`s_»¶y
(
s
, 
msg
, 500, 
	`¡»¼Ü
(
”r
));

117 
	`w¬nšg
("aÜ c»©”rÜ: %s\n", 
	`¡»¼Ü
(
”r
));

118  
Œue
;

123 
l¡
 = 
	`hash_li¡
(
msg
->
hdrht
, 
SIP_HDR_CONTACT
);

125 
Ë
=
	`li¡_h—d
(
l¡
);†e;†eöe->
Ãxt
) {

127 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

128 
s_addr
 
cÚù
;

129 
ušt32_t
 
expœes
;

130 
¶
…l;

132 ià(
hdr
->
id
 !ğ
SIP_HDR_CONTACT
)

135 
”r
 = 
	`s_addr_decode
(&
cÚù
, &
hdr
->
v®
);

136 ià(
”r
) {

137 
	`s_»¶y
(
s
, 
msg
, 400, "Bad Contact");

138 
ç
;

141 ià(!
	`msg_·¿m_decode
(&
cÚù
.
·¿ms
, "expœes", &
¶
))

142 
expœes
 = 
	`¶_u32
(&
¶
);

143 ià(
	`¶_is£t
(&
msg
->
expœes
))

144 
expœes
 = 
	`¶_u32
(&
msg
->expires);

146 
expœes
 = 3600;

148 ià(
expœes
 > 0 &&ƒxpœe < 
EXPIRES_MIN
) {

149 
	`s_»¶yf
(
s
, 
msg
, 423, "Interval Too Brief",

152 
EXPIRES_MIN
);

153 
ç
;

156 
expœes
 = 
	`mš
Óxpœes, 
EXPIRES_MAX
);

158 
”r
 = 
	`loÿtiÚ_upd©e
(&
aÜ
->
loş
, 
msg
, &
cÚù
, 
expœes
);

159 ià(
”r
) {

160 
	`s_»¶y
(
s
, 
msg
, 500, 
	`¡»¼Ü
(
”r
));

161 ià(
”r
 !ğ
EPROTO
)

162 
	`w¬nšg
("location updateƒrror: %s\n",

163 
	`¡»¼Ü
(
”r
));

164 
ç
;

168 
	`loÿtiÚ_comm™
(&
aÜ
->
loş
);

170 
	`s_Œ•lyf
(
NULL
, NULL, 
s
, 
msg
, 
çl£
, 200, "OK",

174 
´št_cÚù
, 
aÜ
,

175 
fmt_gmtime
, 
NULL
);

177  
Œue
;

179 
ç
:

180 
	`loÿtiÚ_rŞlback
(&
aÜ
->
loş
);

182  
Œue
;

183 
	}
}

186 
boŞ
 
	$s_msg_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

188 
s_£rv”
 *
¤v
 = 
¬g
;

189 
”r
 = 0;

192 
	`DEBUG_NOTICE
("[%u]„ecv %¸vŸ %s\n", 
¤v
->
š¡ªû
,

193 &
msg
->
m‘
, 
	`s_Œª¥_Çme
(msg->

));

196 
¤v
->
_Ï¡
 = 
msg
->

;

198 ià(0 =ğ
	`¶_¡rcmp
(&
msg
->
m‘
, "REGISTER")) {

199 ++
¤v
->
n_»gi¡”_»q
;

200 ià(
	`hªdË_»gi¡”
(
¤v
, 
msg
))

201 
out
;

203 
	`s_»¶y
(
¤v
->
s
, 
msg
, 503, "Server Error");

206 
	`DEBUG_NOTICE
("m‘hod‚Ù hªdËd (%r)\n", &
msg
->
m‘
);

207  
çl£
;

210 ià(
¤v
->
‹rmš©e
)

211 
”r
 = 
	`s_»¶y
(
¤v
->
s
, 
msg
, 503, "Server Error");

213 ià(
”r
) {

214 
	`DEBUG_WARNING
("could‚Ù„•ly: %m\n", 
”r
);

217 
out
:

218 ià(
¤v
->
‹rmš©e
)

219 
	`»_ÿnûl
();

221  
Œue
;

222 
	}
}

225 
	$de¡ruùÜ
(*
¬g
)

227 
s_£rv”
 *
¤v
 = 
¬g
;

229 
¤v
->
‹rmš©e
 = 
Œue
;

231 
	`s_şo£
(
¤v
->
s
, 
çl£
);

232 
	`mem_d”ef
(
¤v
->
s
);

234 
	`hash_æush
(
¤v
->
ht_aÜ
);

235 
	`mem_d”ef
(
¤v
->
ht_aÜ
);

237 
	`hash_æush
(
¤v
->
ht_dom
);

238 
	`mem_d”ef
(
¤v
->
ht_dom
);

239 
	}
}

242 
	$s_£rv”_®loc
(
s_£rv”
 **
¤vp
)

244 
s_£rv”
 *
¤v
;

245 
§
 
Ïddr
, 
Ïddrs
;

246 
s
 * ğ
NULL
;

247 
”r
;

249 ià(!
¤vp
)

250  
EINVAL
;

252 
¤v
 = 
	`mem_z®loc
( *¤v, 
de¡ruùÜ
);

253 ià(!
¤v
)

254  
ENOMEM
;

256 
”r
 = 
	`§_£t_¡r
(&
Ïddr
, "127.0.0.1", 
LOCAL_PORT
);

257 
”r
 |ğ
	`§_£t_¡r
(&
Ïddrs
, "127.0.0.1", 
LOCAL_SECURE_PORT
);

258 ià(
”r
)

259 
out
;

261 
”r
 = 
	`s_®loc
(&
¤v
->
s
, 
NULL
, 16, 16, 16,

262 "mock SIP s”v”", 
NULL
, NULL);

263 ià(
”r
)

264 
out
;

266 
”r
 |ğ
	`s_Œª¥_add
(
¤v
->
s
, 
SIP_TRANSP_UDP
, &
Ïddr
);

267 
”r
 |ğ
	`s_Œª¥_add
(
¤v
->
s
, 
SIP_TRANSP_TCP
, &
Ïddr
);

268 ià(
”r
)

269 
out
;

271 #ifdeà
USE_TLS


272 
”r
 = 
	`s_®loc
(&
s
, 
TLS_METHOD_SSLV23
, 
NULL
, NULL);

273 ià(
”r
)

274 
out
;

276 
”r
 = 
	`s_£t_û¹ifiÿ‹
(
s
, 
‹¡_û¹ifiÿ‹
,

277 
	`¡¾’
(
‹¡_û¹ifiÿ‹
));

278 ià(
”r
)

279 
out
;

281 
”r
 |ğ
	`s_Œª¥_add
(
¤v
->
s
, 
SIP_TRANSP_TLS
, &
Ïddrs
, 
s
);

283 ià(
”r
)

284 
out
;

286 
”r
 = 
	`s_li¡’
(&
¤v
->
l¢r
, srv->
s
, 
Œue
, 
s_msg_hªdËr
, srv);

287 ià(
”r
)

288 
out
;

290 
¤v
->
£ü‘
 = 
	`¿nd_u64
();

292 
”r
 = 
	`hash_®loc
(&
¤v
->
ht_dom
, 32);

293 ià(
”r
)

294 
out
;

296 
”r
 = 
	`hash_®loc
(&
¤v
->
ht_aÜ
, 32);

297 ià(
”r
)

298 
out
;

300 
out
:

301 
	`mem_d”ef
(
s
);

302 ià(
”r
)

303 
	`mem_d”ef
(
¤v
);

305 *
¤vp
 = 
¤v
;

307  
”r
;

308 
	}
}

311 
	$s_£rv”_uri
(
s_£rv”
 *
¤v
, *
uri
, 
size_t
 
sz
,

312 
s_Œª¥
 

)

314 
§
 
Ïddr
;

315 
”r
;

317 ià(!
¤v
 || !
uri
 || !
sz
)

318  
EINVAL
;

320 
”r
 = 
	`s_Œª¥_Ïddr
(
¤v
->
s
, &
Ïddr
, 

, 
NULL
);

321 ià(
”r
)

322  
”r
;

325 ià(
	`»_¢´štf
(
uri
, 
sz
, "<sip:x@%J%s>",

326 &
Ïddr
, 
	`s_Œª¥_·¿m
(

)) < 0)

327  
ENOMEM
;

330 
	}
}

	@baresip/test/sip/sipsrv.h

8 
	gauth
;

15 
	ss_£rv”
 {

16 
s
 *
	ms
;

17 
s_l¢r
 *
	ml¢r
;

18 
boŞ
 
	mauth_’abËd
;

19 
boŞ
 
	m‹rmš©e
;

20 
	mš¡ªû
;

22 
	mn_»gi¡”_»q
;

23 
s_Œª¥
 
	m_Ï¡
;

25 
ušt64_t
 
	m£ü‘
;

26 
hash
 *
	mht_dom
;

27 
hash
 *
	mht_aÜ
;

30 
s_£rv”_®loc
(
s_£rv”
 **
¤vp
);

31 
s_£rv”_uri
(
s_£rv”
 *
¤v
, *
uri
, 
size_t
 
sz
,

32 
s_Œª¥
 

);

39 
	saÜ
 {

40 
Ë
 
	mhe
;

41 
li¡
 
	mloş
;

42 *
	muri
;

45 
aÜ_ü—‹
(
s_£rv”
 *
¤v
, 
aÜ
 **
aÜp
,

46 cÚ¡ 
uri
 *uri);

47 
aÜ_fšd
(
s_£rv”
 *
¤v
, 
aÜ
 **
aÜp
,

48 cÚ¡ 
uri
 *uri);

55 
	sauth
 {

56 cÚ¡ 
s_£rv”
 *
	m¤v
;

57 
	m»®m
[256];

58 
boŞ
 
	m¡®e
;

61 
auth_´št
(
»_´štf
 *
pf
, cÚ¡ 
auth
 *auth);

62 
auth_chk_nÚû
(
s_£rv”
 *
¤v
,

63 cÚ¡ 
¶
 *
nÚû
, 
ušt32_t
 
expœes
);

64 
auth_£t_»®m
(
auth
 *auth, cÚ¡ *
»®m
);

71 
	sdomaš
 {

72 
Ë
 
	mhe
;

73 
hash
 *
	mht_u¤
;

74 *
	mÇme
;

78 
domaš_add
(
s_£rv”
 *
¤v
, cÚ¡ *
Çme
);

79 
domaš_fšd
(
s_£rv”
 *
¤v
, cÚ¡ 
uri
 *uri);

80 
domaš_auth
(
s_£rv”
 *
¤v
,

81 cÚ¡ 
uri
 *uri, 
boŞ
 
u£r_m©ch
,

82 cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
hdrid
,

83 
auth
 *auth);

84 
domaš
 *
domaš_lookup
(
s_£rv”
 *
¤v
, cÚ¡ *
Çme
);

91 
	sloÿtiÚ
 {

92 
Ë
 
	mË
;

93 
§
 
	m¤c
;

94 
uri
 
	mduri
;

95 *
	muri
;

96 *
	mÿÎid
;

97 
loùmp
 *
	mtmp
;

98 
ušt64_t
 
	mexpœes
;

99 
ušt32_t
 
	mc£q
;

100 
	mq
;

101 
boŞ
 
	mrm
;

104 
loÿtiÚ_upd©e
(
li¡
 *
loş
, cÚ¡ 
s_msg
 *
msg
,

105 cÚ¡ 
s_addr
 *
cÚù
, 
ušt32_t
 
expœes
);

106 
loÿtiÚ_comm™
(
li¡
 *
loş
);

107 
loÿtiÚ_rŞlback
(
li¡
 *
loş
);

114 
	su£r
 {

115 
Ë
 
	mhe
;

116 
ušt8_t
 
	mha1
[
MD5_SIZE
];

117 *
	mÇme
;

120 
u£r_add
(
hash
 *
ht
, cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
,

121 cÚ¡ *
»®m
);

122 
u£r
 *
u£r_fšd
(
hash
 *
ht
, cÚ¡ 
¶
 *
Çme
);

	@baresip/test/sip/user.c

6 
	~<».h
>

7 
	~"s¤v.h
"

10 
	$de¡ruùÜ
(*
¬g
)

12 
u£r
 *
u¤
 = 
¬g
;

14 
	`hash_uÆšk
(&
u¤
->
he
);

15 
	`mem_d”ef
(
u¤
->
Çme
);

16 
	}
}

19 
	$u£r_add
(
hash
 *
ht
, cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
,

20 cÚ¡ *
»®m
)

22 
u£r
 *
u¤
;

23 
”r
;

25 
u¤
 = 
	`mem_z®loc
((*u¤), 
de¡ruùÜ
);

26 ià(!
u¤
) {

27 
”r
 = 
ENOMEM
;

28 
out
;

31 
”r
 = 
	`¡r_dup
(&
u¤
->
Çme
, 
u£ºame
);

32 ià(
”r
) {

33 
out
;

36 
”r
 = 
	`md5_´štf
(
u¤
->
ha1
, "%s:%s:%s", 
u£ºame
, 
»®m
, 
·sswÜd
);

37 ià(
”r
) {

38 
out
;

41 
	`hash_­³nd
(
ht
, 
	`hash_jß©_¡r
(
u£ºame
), &
u¤
->
he
, usr);

43 
out
:

44 ià(
”r
) {

45 
	`mem_d”ef
(
u¤
);

48  
”r
;

49 
	}
}

52 
u£r
 *
	$u£r_fšd
(
hash
 *
ht
, cÚ¡ 
¶
 *
Çme
)

54 
li¡
 *
l¡
;

55 
Ë
 *le;

57 ià(!
ht
 || !
Çme
)

58  
NULL
;

60 
l¡
 = 
	`hash_li¡
(
ht
, 
	`hash_jß©
((
ušt8_t
 *)
Çme
->
p
,‚ame->
l
));

62 
Ë
=
	`li¡_h—d
(
l¡
);†e;†eöe->
Ãxt
) {

64 
u£r
 *
u¤
 = 
Ë
->
d©a
;

66 ià(
	`¶_¡rcmp
(
Çme
, 
u¤
->name))

69  
u¤
;

72  
NULL
;

73 
	}
}

	@baresip/test/test.c

1 
	~<m©h.h
>

2 
	~<».h
>

3 
	~<b¬es.h
>

4 
	~"‹¡.h
"

7 
	$timeout_hªdËr
(*
¬g
)

9 *
”r
 = 
¬g
;

11 
	`w¬nšg
("selftest:„e_main()†oopimed out --est hung..\n");

13 *
”r
 = 
ETIMEDOUT
;

15 
	`»_ÿnûl
();

16 
	}
}

19 
	$sigÇl_hªdËr
(
sig
)

21 
	`»_årštf
(
¡d”r
, "‹¡ iÁ”ru±ed by sigÇÈ%d\n", 
sig
);

22 
	`»_ÿnûl
();

23 
	}
}

26 
	$»_maš_timeout
(
ušt32_t
 
timeout_ms
)

28 
tmr
mr;

29 
”r
 = 0;

31 
	`tmr_š™
(&
tmr
);

33 
	`tmr_¡¬t
(&
tmr
, 
timeout_ms
, 
timeout_hªdËr
, &
”r
);

34 
	`»_maš
(
sigÇl_hªdËr
);

36 
	`tmr_ÿnûl
(&
tmr
);

37  
”r
;

38 
	}
}

41 
boŞ
 
	$‹¡_cmp_doubË
(
a
, 
b
, 
´ecisiÚ
)

43  
	`çbs
(
a
 - 
b
è< 
´ecisiÚ
;

44 
	}
}

47 
	$‹¡_hexdump_du®
(
FILE
 *
f
,

48 cÚ¡ *
•
, 
size_t
 
–’
,

49 cÚ¡ *
­
, 
size_t
 
®’
)

51 cÚ¡ 
ušt8_t
 *
ebuf
 = 
•
;

52 cÚ¡ 
ušt8_t
 *
abuf
 = 
­
;

53 
size_t
 
i
, 
j
, 
Ën
;

54 
	#WIDTH
 8

	)

56 ià(!
f
 || !
•
 || !
­
)

59 
Ën
 = 
	`max
(
–’
, 
®’
);

61 ()
	`»_årštf
(
f
, "\nOffset: Expected (%zu bytes): "

62 " Aùu® (%zu by‹s):\n", 
–’
, 
®’
);

64 
i
=0; i < 
Ën
; i +ğ
WIDTH
) {

66 ()
	`»_årštf
(
f
, "0x%04zx ", 
i
);

68 
j
=0; j<
WIDTH
; j++) {

69 cÚ¡ 
size_t
 
pos
 = 
i
+
j
;

70 ià(
pos
 < 
–’
) {

71 
boŞ
 
wrÚg
 = 
pos
 >ğ
®’
;

73 ià(
wrÚg
)

74 ()
	`»_årštf
(
f
, "\x1b[35m");

75 ()
	`»_årštf
(
f
, " %02x", 
ebuf
[
pos
]);

76 ià(
wrÚg
)

77 ()
	`»_årštf
(
f
, "\x1b[;m");

80 ()
	`»_årštf
(
f
, " ");

83 ()
	`»_årštf
(
f
, " ");

85 
j
=0; j<
WIDTH
; j++) {

86 cÚ¡ 
size_t
 
pos
 = 
i
+
j
;

87 ià(
pos
 < 
®’
) {

88 
boŞ
 
wrÚg
;

90 ià(
pos
 < 
–’
)

91 
wrÚg
 = 
ebuf
[
pos
] !ğ
abuf
[pos];

93 
wrÚg
 = 
Œue
;

95 ià(
wrÚg
)

96 ()
	`»_årštf
(
f
, "\x1b[33m");

97 ()
	`»_årštf
(
f
, " %02x", 
abuf
[
pos
]);

98 ià(
wrÚg
)

99 ()
	`»_årštf
(
f
, "\x1b[;m");

102 ()
	`»_årštf
(
f
, " ");

105 ()
	`»_årštf
(
f
, "\n");

108 ()
	`»_årštf
(
f
, "\n");

109 
	}
}

	@baresip/test/test.h

8 
	#ASSERT_TRUE
(
cÚd
) \

9 ià(!(
cÚd
)) { \

10 
	`w¬nšg
("selftest: ASSERT_TRUE: %s:%u:\n", \

11 
__FILE__
, 
__LINE__
); \

12 
”r
 = 
EINVAL
; \

13 
out
; \

14 }

	)

16 
	#ASSERT_EQ
(
ex³ùed
, 
aùu®
) \

17 ià((
ex³ùed
è!ğ(
aùu®
)) { \

18 
	`w¬nšg
("selftest: ASSERT_EQ: %s:%u:" \

20 
__FILE__
, 
__LINE__
, \

21 ()(
ex³ùed
), ()(
aùu®
)); \

22 
”r
 = 
EINVAL
; \

23 
out
; \

24 }

	)

26 
	#ASSERT_DOUBLE_EQ
(
ex³ùed
, 
aùu®
, 
´ec
) \

27 ià(!
	`‹¡_cmp_doubË
((
ex³ùed
), (
aùu®
), (
´ec
))) { \

28 
	`w¬nšg
("selftest: ASSERT_DOUBLE_EQ: %s:%u:" \

30 
__FILE__
, 
__LINE__
, \

31 ()(
ex³ùed
), ()(
aùu®
)); \

32 
”r
 = 
EINVAL
; \

33 
out
; \

34 }

	)

36 
	#ASSERT_STREQ
(
ex³ùed
, 
aùu®
) \

37 ià(0 !ğ
	`¡r_cmp
((
ex³ùed
), (
aùu®
))) { \

38 
	`w¬nšg
("selftest: ASSERT_STREQ: %s:%u:" \

40 
__FILE__
, 
__LINE__
, \

41 (
ex³ùed
), (
aùu®
)); \

42 
”r
 = 
EBADMSG
; \

43 
out
; \

44 }

	)

46 
	#TEST_ERR
(
”r
) \

47 ià((
”r
)) { \

48 ()
	`»_årštf
(
¡d”r
, "\n"); \

49 
	`w¬nšg
("TEST_ERR: %s:%u:" \

51 
__FILE__
, 
__LINE__
, \

52 (
”r
)); \

53 
out
; \

54 }

	)

56 
	#TEST_MEMCMP
(
ex³ùed
, 
ex²
, 
aùu®
, 
aùn
) \

57 ià(
ex²
 !ğ
aùn
 || \

58 0 !ğ
	`memcmp
((
ex³ùed
), (
aùu®
), (
ex²
))) { \

59 ()
	`»_årštf
(
¡d”r
, "\n"); \

60 
	`w¬nšg
("TEST_MEMCMP: %s:%u:" \

62 
__FILE__
, 
__LINE__
, 
__func__
); \

63 
	`‹¡_hexdump_du®
(
¡d”r
, \

64 
ex³ùed
, 
ex²
, \

65 
aùu®
, 
aùn
); \

66 
”r
 = 
EINVAL
; \

67 
out
; \

68 }

	)

70 
	#TEST_STRCMP
(
ex³ùed
, 
ex²
, 
aùu®
, 
aùn
) \

71 ià(
ex²
 !ğ
aùn
 || \

72 0 !ğ
	`memcmp
((
ex³ùed
), (
aùu®
), (
ex²
))) { \

73 ()
	`»_årštf
(
¡d”r
, "\n"); \

74 
	`w¬nšg
("TEST_STRCMP: %s:%u:" \

76 
__FILE__
, 
__LINE__
); \

77 ()
	`»_årštf
(
¡d”r
, \

80 (
size_t
)(
ex²
), \

81 (
ex³ùed
), (
size_t
)(
ex²
)); \

82 ()
	`»_årštf
(
¡d”r
, \

85 (
size_t
)(
aùn
), \

86 (
aùu®
), (
size_t
)(
aùn
)); \

87 
”r
 = 
EINVAL
; \

88 
out
; \

89 }

	)

94 
»_maš_timeout
(
ušt32_t
 
timeout_ms
);

95 
boŞ
 
‹¡_cmp_doubË
(
a
, 
b
, 
´ecisiÚ
);

96 
‹¡_hexdump_du®
(
FILE
 *
f
,

97 cÚ¡ *
•
, 
size_t
 
–’
,

98 cÚ¡ *
­
, 
size_t
 
®’
);

101 #ifdeà
USE_TLS


102 cÚ¡ 
‹¡_û¹ifiÿ‹
[];

110 
	sdns_£rv”
 {

111 
udp_sock
 *
	mus
;

112 
§
 
	maddr
;

113 
li¡
 
	m¼l
;

114 
boŞ
 
	mrÙ©e
;

117 
dns_£rv”_®loc
(
dns_£rv”
 **
¤vp
, 
boŞ
 
rÙ©e
);

118 
dns_£rv”_add_a
(
dns_£rv”
 *
¤v
,

119 cÚ¡ *
Çme
, 
ušt32_t
 
addr
);

120 
dns_£rv”_add_¤v
(
dns_£rv”
 *
¤v
, cÚ¡ *
Çme
,

121 
ušt16_t
 
´i
, ušt16_ˆ
weight
, ušt16_ˆ
pÜt
,

122 cÚ¡ *
rg‘
);

128 
mock_aucodec_»gi¡”
();

129 
mock_aucodec_uÄegi¡”
();

135 
	gau¤c
;

137 
mock_au¤c_»gi¡”
(
au¤c
 **
au¤ı
);

144 
	gau¶ay
;

146 (
	tmock_§m¶e_h
)(cÚ¡ *
	t§mpv
, 
	tsize_t
 
	t§mpc
, *
	t¬g
);

148 
	`mock_au¶ay_»gi¡”
(
au¶ay
 **
au¶ayp
,

149 
mock_§m¶e_h
 *
§m¶eh
, *
¬g
);

156 
vid¤c
;

158 
	`mock_vid¤c_»gi¡”
(
vid¤c
 **
vid¤ı
);

165 
	`mock_vidcodec_»gi¡”
();

166 
	`mock_vidcodec_uÄegi¡”
();

173 
vidi¥
;

175 
	`mock_vidi¥_»gi¡”
(
vidi¥
 **
vidi¥p
);

180 
	`‹¡_accouÁ
();

181 
	`‹¡_auËv–
();

182 
	`‹¡_cmd
();

183 
	`‹¡_cmd_lÚg
();

184 
	`‹¡_cÚù
();

185 
	`‹¡_ua_®loc
();

186 
	`‹¡_uag_fšd_·¿m
();

187 
	`‹¡_ua_»gi¡”
();

188 
	`‹¡_ua_»gi¡”_dns
();

189 
	`‹¡_ua_»gi¡”_auth
();

190 
	`‹¡_ua_»gi¡”_auth_dns
();

191 
	`‹¡_ua_İtiÚs
();

192 
	`‹¡_mes§ge
();

193 
	`‹¡_mos
();

194 
	`‹¡_ÃtwÜk
();

195 
	`‹¡_¶ay
();

197 
	`‹¡_ÿÎ_ªsw”
();

198 
	`‹¡_ÿÎ_»jeù
();

199 
	`‹¡_ÿÎ_af_mism©ch
();

200 
	`‹¡_ÿÎ_ªsw”_hªgup_a
();

201 
	`‹¡_ÿÎ_ªsw”_hªgup_b
();

202 
	`‹¡_ÿÎ_¹p_timeout
();

203 
	`‹¡_ÿÎ_muÉË
();

204 
	`‹¡_ÿÎ_max
();

205 
	`‹¡_ÿÎ_dtmf
();

206 
	`‹¡_ÿÎ_video
();

207 
	`‹¡_ÿÎ_auËv–
();

208 
	`‹¡_ÿÎ_´og»ss
();

209 
	`‹¡_ÿÎ_fÜm©_æßt
();

211 #ifdeà
USE_VIDEO


212 
	`‹¡_video
();

216 #ifdeà
__ılu¥lus


220 
	`‹¡_ılu¥lus
();

222 #ifdeà
__ılu¥lus


223 
	}
}

	@baresip/test/ua.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

10 
	~"s/s¤v.h
"

13 
	#MAGIC
 0x9044bbfc

	)

16 
	s‹¡
 {

17 
s_£rv”
 *
	m¤vv
[16];

18 
size_t
 
	m¤vc
;

19 
ua
 *
	mua
;

20 
	m”r
;

21 
	mgÙ_»gi¡”_ok
;

22 
	mn_»¥
;

23 
ušt32_t
 
	mmagic
;

27 
	$‹¡_š™
(
‹¡
 *
t
)

29 
	`mem£t
(
t
, 0, (*t));

30 
t
->
magic
 = 
MAGIC
;

31 
	}
}

34 
	$‹¡_»£t
(
‹¡
 *
t
)

36 
size_t
 
i
;

38 
i
=0; i<
	`ARRAY_SIZE
(
t
->
¤vv
); i++)

39 
	`mem_d”ef
(
t
->
¤vv
[
i
]);

40 
	`mem_d”ef
(
t
->
ua
);

42 
	`mem£t
(
t
, 0, (*t));

43 
	}
}

46 
	$‹¡_abÜt
(
‹¡
 *
t
, 
”r
)

48 
t
->
”r
 =ƒrr;

49 
	`»_ÿnûl
();

50 
	}
}

53 
	$ua_ev’t_hªdËr
(
ua
 *ua, 
ua_ev’t
 
ev
,

54 
ÿÎ
 *ÿÎ, cÚ¡ *
´m
, *
¬g
)

56 
‹¡
 *
t
 = 
¬g
;

57 
size_t
 
i
;

58 
”r
 = 0;

59 ()
ÿÎ
;

60 ()
´m
;

62 
	`ASSERT_TRUE
(
t
 !ğ
NULL
);

64 ià(
ua
 !ğ
t
->ua)

67 ià(
ev
 =ğ
UA_EVENT_REGISTER_OK
) {

69 
	`šfo
("event: Register OK!\n");

71 ++
t
->
gÙ_»gi¡”_ok
;

74 
	`ASSERT_TRUE
(
	`ua_i¤egi¡”ed
(
t
->
ua
));

77 
i
=0; i<
t
->
¤vc
; i++)

78 
t
->
¤vv
[
i
]->
‹rmš©e
 = 
Œue
;

80 
t
->
ua
 = 
	`mem_d”ef
(t->ua);

82 ià(
ev
 =ğ
UA_EVENT_REGISTER_FAIL
) {

84 
”r
 = 
EAUTH
;

85 
	`»_ÿnûl
();

88 
out
:

89 ià(
”r
) {

90 
	`w¬nšg
("£láe¡:ƒv’ˆhªdË¸”rÜ: %m\n", 
”r
);

91 
t
->
”r
 =ƒrr;

93 
	}
}

96 
	$»g
(
s_Œª¥
 

)

98 
‹¡
 
t
;

99 
aÜ
[256];

100 
”r
;

102 
	`mem£t
(&
t
, 0, );

104 
”r
 = 
	`s_£rv”_®loc
(&
t
.
¤vv
[0]);

105 ià(
”r
) {

106 
	`w¬nšg
("çedØü—‹ s s”v” (%d/%m)\n", 
”r
,ƒrr);

107 
out
;

110 
”r
 = 
	`s_£rv”_uri
(
t
.
¤vv
[0], 
aÜ
, ×Ü), 

);

111 
	`TEST_ERR
(
”r
);

113 
”r
 = 
	`ua_®loc
(&
t
.
ua
, 
aÜ
);

114 
	`TEST_ERR
(
”r
);

116 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, &
t
);

117 ià(
”r
)

118 
out
;

121 
”r
 = 
	`»_maš_timeout
(5000);

122 ià(
”r
)

123 
out
;

125 ià(
t
.
”r
)

126 
”r
 = 
t
.err;

128 
	`ASSERT_TRUE
(
t
.
¤vv
[0]->
n_»gi¡”_»q
 > 0);

129 
	`ASSERT_EQ
(

, 
t
.
¤vv
[0]->
_Ï¡
);

130 
	`ASSERT_TRUE
(
t
.
gÙ_»gi¡”_ok
 > 0);

132 
out
:

133 ià(
”r
) {

134 
	`w¬nšg
("£láe¡: ua_»gi¡”e¡ faed (%m)\n", 
”r
);

136 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

137 
	`‹¡_»£t
(&
t
);

139  
”r
;

140 
	}
}

143 
	$‹¡_ua_»gi¡”
()

145 
”r
 = 0;

147 
”r
 = 
	`ua_š™
("‹¡", 
Œue
,rue,rue, 
çl£
);

148 
	`TEST_ERR
(
”r
);

150 
”r
 |ğ
	`»g
(
SIP_TRANSP_UDP
);

151 
”r
 |ğ
	`»g
(
SIP_TRANSP_TCP
);

152 #ifdeà
USE_TLS


153 
”r
 |ğ
	`»g
(
SIP_TRANSP_TLS
);

156 
	`ua_şo£
();

158 
out
:

159  
”r
;

160 
	}
}

163 
	$‹¡_ua_®loc
()

165 
ua
 *ua;

166 
ušt32_t
 
n_uas
 = 
	`li¡_couÁ
(
	`uag_li¡
());

167 
”r
 = 0;

170 
	`ASSERT_TRUE
(
NULL
 =ğ
	`uag_fšd_aÜ
("sip:user@127.0.0.1"));

172 
”r
 = 
	`ua_®loc
(&
ua
, "Foo <sip:user@127.0.0.1>;regint=0");

173 ià(
”r
)

174  
”r
;

177 
	`ASSERT_TRUE
(!
	`ua_i¤egi¡”ed
(
ua
));

178 
	`ASSERT_STREQ
("s:u£r@127.0.0.1", 
	`ua_aÜ
(
ua
));

179 
	`ASSERT_TRUE
(
NULL
 =ğ
	`ua_ÿÎ
(
ua
));

182 
	`ASSERT_EQ
((
n_uas
 + 1), 
	`li¡_couÁ
(
	`uag_li¡
()));

183 
	`ASSERT_TRUE
(
ua
 =ğ
	`uag_fšd_aÜ
("sip:user@127.0.0.1"));

185 
	`mem_d”ef
(
ua
);

187 
	`ASSERT_EQ
((
n_uas
), 
	`li¡_couÁ
(
	`uag_li¡
()));

189 
out
:

190  
”r
;

191 
	}
}

194 
	$‹¡_uag_fšd_·¿m
()

196 
ua
 *
ua1
 = 
NULL
, *
ua2
 = NULL;

197 
”r
 = 0;

199 
	`ASSERT_TRUE
(
NULL
 =ğ
	`uag_fšd_·¿m
("not", "found"));

201 
”r
 = 
	`ua_®loc
(&
ua1
, "<sip:x@127.0.0.1>;regint=0;abc");

202 
”r
 |ğ
	`ua_®loc
(&
ua2
, "<sip:x@127.0.0.1>;regint=0;def=123");

203 ià(
”r
)

204 
out
;

206 
	`ASSERT_TRUE
(
ua1
 =ğ
	`uag_fšd_·¿m
("abc", 
NULL
));

207 
	`ASSERT_TRUE
(
NULL
 =ğ
	`uag_fšd_·¿m
("abc", "123"));

208 
	`ASSERT_TRUE
(
ua2
 =ğ
	`uag_fšd_·¿m
("def", 
NULL
));

209 
	`ASSERT_TRUE
(
ua2
 =ğ
	`uag_fšd_·¿m
("def", "123"));

211 
	`ASSERT_TRUE
(
NULL
 =ğ
	`uag_fšd_·¿m
("not", "found"));

213 
out
:

214 
	`mem_d”ef
(
ua2
);

215 
	`mem_d”ef
(
ua1
);

217  
”r
;

218 
	}
}

221 cÚ¡ *
	$_s_Œª¥_¤vid
(
s_Œª¥
 

)

223 

) {

225 
SIP_TRANSP_UDP
:  "_sip._udp";

226 
SIP_TRANSP_TCP
:  "_sip._tcp";

227 
SIP_TRANSP_TLS
:  "_sips._tcp";

230 
	}
}

233 
	$»g_dns
(
s_Œª¥
 

)

235 
dns_£rv”
 *
dns¤v
 = 
NULL
;

236 
‹¡
 
t
;

237 cÚ¡ *
domaš
 = "test.invalid";

238 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

239 
£rv”_couÁ
 = 1;

240 
aÜ
[256];

241 
¤v
[256];

242 
size_t
 
i
;

243 
”r
;

245 
	`mem£t
(&
t
, 0, );

251 
”r
 = 
	`dns_£rv”_®loc
(&
dns¤v
, 
Œue
);

252 
	`TEST_ERR
(
”r
);

254 
	`šfo
("| DNS-£rv” oÀ%J\n", &
dns¤v
->
addr
);

257 
”r
 = 
	`Ãt_u£_Çme£rv”
(
Ãt
, &
dns¤v
->
addr
);

258 
	`TEST_ERR
(
”r
);

260 
i
=0; i<
£rv”_couÁ
; i++) {

261 
§
 
s_addr
;

262 
¬ec
[256];

264 
”r
 = 
	`s_£rv”_®loc
(&
t
.
¤vv
[
i
]);

265 ià(
”r
) {

266 
	`w¬nšg
("failedo create sip server (%d/%m)\n",

267 
”r
,ƒrr);

268 
out
;

271 
”r
 = 
	`domaš_add
(
t
.
¤vv
[0], 
domaš
);

272 ià(
”r
)

273 
out
;

275 
”r
 = 
	`s_Œª¥_Ïddr
(
t
.
¤vv
[
i
]->
s
, &
s_addr
, 

, 
NULL
);

276 
	`TEST_ERR
(
”r
);

278 
	`šfo
("| SIP-£rv” oÀ%J\n", &
s_addr
);

280 
	`»_¢´štf
(
¬ec
, (arec),

281 "®pha%u.%s", 
i
+1, 
domaš
);

283 
	`»_¢´štf
(
¤v
, (srv),

284 "%s.%s", 
	`_s_Œª¥_¤vid
(

), 
domaš
);

285 
”r
 = 
	`dns_£rv”_add_¤v
(
dns¤v
, 
¤v
,

286 20, 0, 
	`§_pÜt
(&
s_addr
),

287 
¬ec
);

288 
	`TEST_ERR
(
”r
);

290 
”r
 = 
	`dns_£rv”_add_a
(
dns¤v
, 
¬ec
, 
	`§_š
(&
s_addr
));

291 
	`TEST_ERR
(
”r
);

293 
t
.
¤vc
 = 
£rv”_couÁ
;

296 ià(
	`»_¢´štf
(
aÜ
, (aor), "<sip:x@%s;transport=%s>",

297 
domaš
, 
	`s_Œª¥_Çme
(

)) < 0)

298  
ENOMEM
;

304 
”r
 = 
	`ua_š™
("‹¡", 
Œue
,rue,rue, 
çl£
);

305 
	`TEST_ERR
(
”r
);

307 
”r
 = 
	`ua_®loc
(&
t
.
ua
, 
aÜ
);

308 
	`TEST_ERR
(
”r
);

310 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, &
t
);

311 ià(
”r
)

312 
out
;

315 
”r
 = 
	`»_maš_timeout
(5000);

316 ià(
”r
)

317 
out
;

319 ià(
t
.
”r
)

320 
”r
 = 
t
.err;

325 
	`ASSERT_TRUE
(
t
.
¤vv
[0]->
n_»gi¡”_»q
 > 0);

326 
	`ASSERT_EQ
(

, 
t
.
¤vv
[0]->
_Ï¡
);

327 
	`ASSERT_TRUE
(
t
.
gÙ_»gi¡”_ok
 > 0);

329 
out
:

330 ià(
”r
) {

331 
	`w¬nšg
("£láe¡: ua_»gi¡”e¡ faed (%m)\n", 
”r
);

333 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

335 
	`‹¡_»£t
(&
t
);

337 
	`ua_¡İ_®l
(
Œue
);

338 
	`ua_şo£
();

340 
	`mem_d”ef
(
dns¤v
);

342  
”r
;

343 
	}
}

346 
	$‹¡_ua_»gi¡”_dns
()

348 
”r
 = 0;

350 
”r
 |ğ
	`»g_dns
(
SIP_TRANSP_UDP
);

351 
	`TEST_ERR
(
”r
);

352 
”r
 |ğ
	`»g_dns
(
SIP_TRANSP_TCP
);

353 
	`TEST_ERR
(
”r
);

354 #ifdeà
USE_TLS


355 
”r
 |ğ
	`»g_dns
(
SIP_TRANSP_TLS
);

356 
	`TEST_ERR
(
”r
);

359 
out
:

360  
”r
;

361 
	}
}

364 
	#USER
 "®äedh"

	)

365 
	#PASS
 "·ss@wÜd"

	)

366 
	#DOMAIN
 "loÿlho¡"

	)

368 
	$»g_auth
(
s_Œª¥
 

)

370 
§
 
Ïddr
;

371 
‹¡
 
t
;

372 
aÜ
[256];

373 
”r
;

375 
	`mem£t
(&
t
, 0, );

377 
”r
 = 
	`s_£rv”_®loc
(&
t
.
¤vv
[0]);

378 ià(
”r
) {

379 
	`w¬nšg
("çedØü—‹ s s”v” (%d/%m)\n", 
”r
,ƒrr);

380 
out
;

383 
”r
 = 
	`domaš_add
(
t
.
¤vv
[0], 
DOMAIN
);

384 
	`TEST_ERR
(
”r
);

386 
”r
 = 
	`u£r_add
(
	`domaš_lookup
(
t
.
¤vv
[0], 
DOMAIN
)->
ht_u¤
,

387 
USER
, 
PASS
, 
DOMAIN
);

388 
	`TEST_ERR
(
”r
);

390 
t
.
¤vv
[0]->
auth_’abËd
 = 
Œue
;

392 
”r
 = 
	`s_Œª¥_Ïddr
(
t
.
¤vv
[0]->
s
, &
Ïddr
, 

, 
NULL
);

393 ià(
”r
)

394  
”r
;

397 ià(
	`»_¢´štf
(
aÜ
, (aor),

401 
USER
,

402 
DOMAIN
,

403 
PASS
,

404 &
Ïddr
,

405 
	`s_Œª¥_Çme
(

)) < 0)

406  
ENOMEM
;

408 
”r
 = 
	`ua_®loc
(&
t
.
ua
, 
aÜ
);

409 
	`TEST_ERR
(
”r
);

411 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, &
t
);

412 ià(
”r
)

413 
out
;

416 
”r
 = 
	`»_maš_timeout
(5000);

417 ià(
”r
)

418 
out
;

420 ià(
t
.
”r
) {

421 
”r
 = 
t
.err;

422 
out
;

425 
	`ASSERT_TRUE
(
t
.
¤vv
[0]->
n_»gi¡”_»q
 > 0);

426 
	`ASSERT_EQ
(

, 
t
.
¤vv
[0]->
_Ï¡
);

427 
	`ASSERT_TRUE
(
t
.
gÙ_»gi¡”_ok
 > 0);

429 
out
:

430 ià(
”r
) {

431 
	`w¬nšg
("£láe¡: ua_»gi¡”e¡ faed (%m)\n", 
”r
);

433 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

434 
	`‹¡_»£t
(&
t
);

437  
”r
;

438 
	}
}

441 
	$‹¡_ua_»gi¡”_auth
()

443 
”r
;

445 
”r
 = 
	`ua_š™
("‹¡", 
Œue
,rue,rue, 
çl£
);

446 
	`TEST_ERR
(
”r
);

448 
”r
 |ğ
	`»g_auth
(
SIP_TRANSP_UDP
);

449 
	`TEST_ERR
(
”r
);

450 
”r
 |ğ
	`»g_auth
(
SIP_TRANSP_TCP
);

451 
	`TEST_ERR
(
”r
);

452 #ifdeà
USE_TLS


453 
”r
 |ğ
	`»g_auth
(
SIP_TRANSP_TLS
);

454 
	`TEST_ERR
(
”r
);

457 
out
:

458 
	`ua_¡İ_®l
(
Œue
);

459 
	`ua_şo£
();

461  
”r
;

462 
	}
}

465 
	$»g_auth_dns
(
s_Œª¥
 

)

467 
ÃtwÜk
 *
Ãt
 = 
	`b¬es_ÃtwÜk
();

468 
dns_£rv”
 *
dns¤v
 = 
NULL
;

469 
‹¡
 
t
;

470 cÚ¡ *
u£ºame
 = "alfredh";

471 cÚ¡ *
·sswÜd
 = "password";

472 cÚ¡ *
domaš
 = "test.invalid";

473 
£rv”_couÁ
 = 2;

474 
aÜ
[256];

475 
¤v
[256];

476 
i
;

477 
tÙ®_»q
 = 0;

478 
”r
;

480 
	`mem£t
(&
t
, 0, );

486 
”r
 = 
	`dns_£rv”_®loc
(&
dns¤v
, 
Œue
);

487 
	`TEST_ERR
(
”r
);

489 
	`šfo
("| DNS-£rv” oÀ%J\n", &
dns¤v
->
addr
);

492 
”r
 = 
	`Ãt_u£_Çme£rv”
(
Ãt
, &
dns¤v
->
addr
);

493 
	`TEST_ERR
(
”r
);

495 
i
=0; i<
£rv”_couÁ
; i++) {

496 
§
 
s_addr
;

497 
¬ec
[256];

499 
”r
 = 
	`s_£rv”_®loc
(&
t
.
¤vv
[
i
]);

500 ià(
”r
) {

501 
	`w¬nšg
("failedo create sip server (%d/%m)\n",

502 
”r
,ƒrr);

503 
out
;

506 
t
.
¤vv
[
i
]->
š¡ªû
 = i;

511 
t
.
¤vv
[
i
]->
£ü‘
 = 42;

514 
”r
 = 
	`domaš_add
(
t
.
¤vv
[
i
], 
domaš
);

515 ià(
”r
)

516 
out
;

518 
”r
 = 
	`u£r_add
(
	`domaš_lookup
(
t
.
¤vv
[
i
], 
domaš
)->
ht_u¤
,

519 
u£ºame
, 
·sswÜd
, 
domaš
);

520 
	`TEST_ERR
(
”r
);

522 
t
.
¤vv
[
i
]->
auth_’abËd
 = 
Œue
;

524 
”r
 = 
	`s_Œª¥_Ïddr
(
t
.
¤vv
[
i
]->
s
, &
s_addr
, 

, 
NULL
);

525 
	`TEST_ERR
(
”r
);

527 
	`šfo
("| SIP-£rv” oÀ%J\n", &
s_addr
);

529 
	`»_¢´štf
(
¬ec
, (arec),

530 "®pha%u.%s", 
i
+1, 
domaš
);

532 
	`»_¢´štf
(
¤v
, (srv),

533 "%s.%s", 
	`_s_Œª¥_¤vid
(

), 
domaš
);

534 
”r
 = 
	`dns_£rv”_add_¤v
(
dns¤v
, 
¤v
,

535 20, 0, 
	`§_pÜt
(&
s_addr
),

536 
¬ec
);

537 
	`TEST_ERR
(
”r
);

539 
”r
 = 
	`dns_£rv”_add_a
(
dns¤v
, 
¬ec
, 
	`§_š
(&
s_addr
));

540 
	`TEST_ERR
(
”r
);

542 
t
.
¤vc
 = 
£rv”_couÁ
;

545 ià(
	`»_¢´štf
(
aÜ
, (aor),

547 
u£ºame
, 
domaš
, 
	`s_Œª¥_Çme
(

),

548 
·sswÜd
) < 0)

549  
ENOMEM
;

555 
”r
 = 
	`ua_š™
("‹¡", 
Œue
,rue,rue, 
çl£
);

556 
	`TEST_ERR
(
”r
);

558 
”r
 = 
	`ua_®loc
(&
t
.
ua
, 
aÜ
);

559 
	`TEST_ERR
(
”r
);

561 
”r
 = 
	`uag_ev’t_»gi¡”
(
ua_ev’t_hªdËr
, &
t
);

562 ià(
”r
)

563 
out
;

566 
”r
 = 
	`»_maš_timeout
(5000);

567 ià(
”r
)

568 
out
;

570 ià(
t
.
”r
) {

571 
”r
 = 
t
.err;

572 
out
;

578 
i
=0; i<
£rv”_couÁ
; i++) {

580 
tÙ®_»q
 +ğ
t
.
¤vv
[
i
]->
n_»gi¡”_»q
;

582 ià(
t
.
¤vv
[
i
]->
n_»gi¡”_»q
) {

583 
	`ASSERT_EQ
(

, 
t
.
¤vv
[
i
]->
_Ï¡
);

586 
	`ASSERT_TRUE
(
tÙ®_»q
 >= 2);

587 
	`ASSERT_TRUE
(
t
.
gÙ_»gi¡”_ok
 > 0);

589 
out
:

590 ià(
”r
) {

591 
	`w¬nšg
("£láe¡: ua_»gi¡”e¡ faed (%m)\n", 
”r
);

593 
	`uag_ev’t_uÄegi¡”
(
ua_ev’t_hªdËr
);

595 
	`‹¡_»£t
(&
t
);

597 
	`ua_¡İ_®l
(
Œue
);

598 
	`ua_şo£
();

600 
	`mem_d”ef
(
dns¤v
);

602  
”r
;

603 
	}
}

606 
	$‹¡_ua_»gi¡”_auth_dns
()

608 
”r
 = 0;

610 
”r
 |ğ
	`»g_auth_dns
(
SIP_TRANSP_UDP
);

611 
	`TEST_ERR
(
”r
);

612 
”r
 |ğ
	`»g_auth_dns
(
SIP_TRANSP_TCP
);

613 
	`TEST_ERR
(
”r
);

614 #ifdeà
USE_TLS


615 
”r
 |ğ
	`»g_auth_dns
(
SIP_TRANSP_TLS
);

616 
	`TEST_ERR
(
”r
);

619 
out
:

620  
”r
;

621 
	}
}

624 
	$İtiÚs_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

626 
‹¡
 *
t
 = 
¬g
;

627 cÚ¡ 
s_hdr
 *
hdr
;

628 
¶
 
cÚ‹Á
;

629 
ušt32_t
 
ş’
;

631 
	`ASSERT_EQ
(
MAGIC
, 
t
->
magic
);

633 ià(
”r
) {

634 
	`‹¡_abÜt
(
t
, 
”r
);

637 ià(
msg
->
scode
 != 200) {

638 
	`‹¡_abÜt
(
t
, 
EPROTO
);

642 ++
t
->
n_»¥
;

646 
	`ASSERT_TRUE
(
	`s_msg_hdr_has_v®ue
(
msg
, 
SIP_HDR_ALLOW
, "INVITE"));

647 
	`ASSERT_TRUE
(
	`s_msg_hdr_has_v®ue
(
msg
, 
SIP_HDR_ALLOW
, "ACK"));

648 
	`ASSERT_TRUE
(
	`s_msg_hdr_has_v®ue
(
msg
, 
SIP_HDR_ALLOW
, "BYE"));

649 
	`ASSERT_TRUE
(
	`s_msg_hdr_has_v®ue
(
msg
, 
SIP_HDR_ALLOW
, "CANCEL"));

651 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTACT
);

652 
	`ASSERT_TRUE
(
hdr
 !ğ
NULL
);

653 
	`ASSERT_TRUE
(
hdr
->
v®
.
l
 != 0);

655 
	`ASSERT_EQ
(0, 
	`¶_¡rÿ£cmp
(&
msg
->
ùyp
.
ty³
, "application"));

656 
	`ASSERT_EQ
(0, 
	`¶_¡rÿ£cmp
(&
msg
->
ùyp
.
subty³
, "sdp"));

658 
ş’
 = 
	`¶_u32
(&
msg
->clen);

659 
	`ASSERT_TRUE
(
ş’
 > 0);

663 
	`¶_£t_mbuf
(&
cÚ‹Á
, 
msg
->
mb
);

665 
	`ASSERT_EQ
(0, 
	`»_»gex
(
cÚ‹Á
.
p
, cÚ‹Á.
l
, "v=0"));

666 
	`ASSERT_EQ
(0, 
	`»_»gex
(
cÚ‹Á
.
p
, cÚ‹Á.
l
, "a=tool:baresip"));

667 
	`ASSERT_EQ
(0, 
	`»_»gex
(
cÚ‹Á
.
p
, cÚ‹Á.
l
, "m=audio"));

669 
out
:

670 ià(
”r
)

671 
t
->
”r
 =ƒrr;

672 
	`»_ÿnûl
();

673 
	}
}

676 
	$‹¡_ua_İtiÚs
()

678 
‹¡
 
t
;

679 
§
 
Ïddr
;

680 
uri
[256];

681 
n
, 
”r
 = 0;

683 
	`‹¡_š™
(&
t
);

685 
”r
 = 
	`ua_š™
("‹¡", 
Œue
, 
çl£
, false, false);

686 
	`TEST_ERR
(
”r
);

688 
”r
 = 
	`s_Œª¥_Ïddr
(
	`uag_s
(), &
Ïddr
, 
SIP_TRANSP_UDP
, 
NULL
);

689 
	`TEST_ERR
(
”r
);

691 
”r
 = 
	`ua_®loc
(&
t
.
ua
, "Foo <sip:user@127.0.0.1>;regint=0");

692 
	`TEST_ERR
(
”r
);

694 
n
 = 
	`»_¢´štf
(
uri
, (uri),

695 "s:u£r@127.0.0.1:%u", 
	`§_pÜt
(&
Ïddr
));

696 
	`ASSERT_TRUE
(
n
 > 0);

698 
”r
 = 
	`ua_İtiÚs_£nd
(
t
.
ua
, 
uri
, 
İtiÚs_»¥_hªdËr
, &t);

699 
	`TEST_ERR
(
”r
);

702 
”r
 = 
	`»_maš_timeout
(5000);

703 ià(
”r
)

704 
out
;

706 
	`TEST_ERR
(
t
.
”r
);

709 
	`ASSERT_EQ
(1, 
t
.
n_»¥
);

711 
out
:

712 
	`‹¡_»£t
(&
t
);

714 
	`ua_¡İ_®l
(
Œue
);

715 
	`ua_şo£
();

717  
”r
;

718 
	}
}

	@baresip/test/video.c

7 
	~<».h
>

8 
	~<b¬es.h
>

9 
	~"‹¡.h
"

12 
	#DEBUG_MODULE
 "video"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

17 
	$‹¡_video
()

19 
”r
 = 0;

22 
	`ASSERT_EQ
(0, 
	`video_ÿlc_¹p_time¡amp
(1, 0));

24 
	`ASSERT_EQ
Ğ0, 
	`video_ÿlc_¹p_time¡amp
( 0, 30));

25 
	`ASSERT_EQ
Ğ3000, 
	`video_ÿlc_¹p_time¡amp
( 1, 30));

26 
	`ASSERT_EQ
Ğ30000, 
	`video_ÿlc_¹p_time¡amp
( 10, 30));

27 
	`ASSERT_EQ
Ğ300000, 
	`video_ÿlc_¹p_time¡amp
( 100, 30));

28 
	`ASSERT_EQ
Ğ3000000, 
	`video_ÿlc_¹p_time¡amp
( 1000, 30));

29 
	`ASSERT_EQ
Ğ30000000, 
	`video_ÿlc_¹p_time¡amp
( 10000, 30));

30 
	`ASSERT_EQ
Ğ300000000, 
	`video_ÿlc_¹p_time¡amp
( 100000, 30));

31 
	`ASSERT_EQ
(3000000000, 
	`video_ÿlc_¹p_time¡amp
(1000000, 30));

33 
	`ASSERT_EQ
(4294965000, 
	`video_ÿlc_¹p_time¡amp
(1431655, 30));

34 
	`ASSERT_EQ
Ğ704, 
	`video_ÿlc_¹p_time¡amp
(1431656, 30));

36 
out
:

37  
”r
;

38 
	}
}

	@re-0.5.6/include/re.h

7 #iâdeà
RE_H__


8 
	#RE_H__


	)

10 #ifdeà
__ılu¥lus


15 
	~"»_ty³s.h
"

16 
	~"»_fmt.h
"

17 
	~"»_mbuf.h
"

18 
	~"»_msg.h
"

19 
	~"»_li¡.h
"

20 
	~"»_§.h
"

23 
	~"»_«s.h
"

24 
	~"»_ba£64.h
"

25 
	~"»_bfı.h
"

26 
	~"»_cÚf.h
"

27 
	~"»_üc32.h
"

28 
	~"»_dns.h
"

29 
	~"»_hash.h
"

30 
	~"»_hmac.h
"

31 
	~"»_h‰p.h
"

32 
	~"»_h‰·uth.h
"

33 
	~"»_iû.h
"

34 
	~"»_jbuf.h
"

35 
	~"»_lock.h
"

36 
	~"»_maš.h
"

37 
	~"»_md5.h
"

38 
	~"»_mem.h
"

39 
	~"»_mod.h
"

40 
	~"»_mqueue.h
"

41 
	~"»_Ãt.h
"

42 
	~"»_odiù.h
"

43 
	~"»_jsÚ.h
"

44 
	~"»_¹p.h
"

45 
	~"»_sdp.h
"

46 
	~"»_uri.h
"

47 
	~"»_s.h
"

48 
	~"»_sev’t.h
"

49 
	~"»_s»g.h
"

50 
	~"»_s£ss.h
"

51 
	~"»_¡un.h
"

52 
	~"»_Çtbd.h
"

53 
	~"»_¤.h
"

54 
	~"»_sys.h
"

55 
	~"»_tı.h
"

56 
	~"»_‹Ëv.h
"

57 
	~"»_tmr.h
"

58 
	~"»_s.h
"

59 
	~"»_tuº.h
"

60 
	~"»_udp.h
"

61 
	~"»_websock.h
"

63 #ifdeà
__ılu¥lus


	@re-0.5.6/include/re_aes.h

8 #iâdeà
AES_BLOCK_SIZE


9 
	#AES_BLOCK_SIZE
 16

	)

13 
	e«s_mode
 {

14 
	mAES_MODE_CTR


17 
	g«s
;

19 
«s_®loc
(
«s
 **
¡p
, 
«s_mode
 
mode
,

20 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b™s
,

21 cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
]);

22 
«s_£t_iv
(
«s
 *«s, cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
]);

23 
«s_’ü
(
«s
 *«s, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
);

24 
«s_deü
(
«s
 *«s, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
);

	@re-0.5.6/include/re_base64.h

8 
ba£64_’code
(cÚ¡ 
ušt8_t
 *
š
, 
size_t
 
’
, *
out
, size_ˆ*
Ş’
);

9 
ba£64_´št
(
»_´štf
 *
pf
, cÚ¡ 
ušt8_t
 *
±r
, 
size_t
 
Ën
);

10 
ba£64_decode
(cÚ¡ *
š
, 
size_t
 
’
, 
ušt8_t
 *
out
, size_ˆ*
Ş’
);

	@re-0.5.6/include/re_bfcp.h

10 
	mBFCP_VER1
 = 1,

11 
	mBFCP_VER2
 = 2,

15 
	ebfı_´im
 {

16 
	mBFCP_FLOOR_REQUEST
 = 1,

17 
	mBFCP_FLOOR_RELEASE
 = 2,

18 
	mBFCP_FLOOR_REQUEST_QUERY
 = 3,

19 
	mBFCP_FLOOR_REQUEST_STATUS
 = 4,

20 
	mBFCP_USER_QUERY
 = 5,

21 
	mBFCP_USER_STATUS
 = 6,

22 
	mBFCP_FLOOR_QUERY
 = 7,

23 
	mBFCP_FLOOR_STATUS
 = 8,

24 
	mBFCP_CHAIR_ACTION
 = 9,

25 
	mBFCP_CHAIR_ACTION_ACK
 = 10,

26 
	mBFCP_HELLO
 = 11,

27 
	mBFCP_HELLO_ACK
 = 12,

28 
	mBFCP_ERROR
 = 13,

29 
	mBFCP_FLOOR_REQ_STATUS_ACK
 = 14,

30 
	mBFCP_FLOOR_STATUS_ACK
 = 15,

31 
	mBFCP_GOODBYE
 = 16,

32 
	mBFCP_GOODBYE_ACK
 = 17,

36 
	ebfı_©Œib
 {

37 
	mBFCP_BENEFICIARY_ID
 = 1,

38 
	mBFCP_FLOOR_ID
 = 2,

39 
	mBFCP_FLOOR_REQUEST_ID
 = 3,

40 
	mBFCP_PRIORITY
 = 4,

41 
	mBFCP_REQUEST_STATUS
 = 5,

42 
	mBFCP_ERROR_CODE
 = 6,

43 
	mBFCP_ERROR_INFO
 = 7,

44 
	mBFCP_PART_PROV_INFO
 = 8,

45 
	mBFCP_STATUS_INFO
 = 9,

46 
	mBFCP_SUPPORTED_ATTRS
 = 10,

47 
	mBFCP_SUPPORTED_PRIMS
 = 11,

48 
	mBFCP_USER_DISP_NAME
 = 12,

49 
	mBFCP_USER_URI
 = 13,

51 
	mBFCP_BENEFICIARY_INFO
 = 14,

52 
	mBFCP_FLOOR_REQ_INFO
 = 15,

53 
	mBFCP_REQUESTED_BY_INFO
 = 16,

54 
	mBFCP_FLOOR_REQ_STATUS
 = 17,

55 
	mBFCP_OVERALL_REQ_STATUS
 = 18,

58 
	mBFCP_MANDATORY
 = 1<<7,

60 
	mBFCP_ENCODE_HANDLER
 = 1<<8,

64 
	ebfı_»q¡©
 {

65 
	mBFCP_PENDING
 = 1,

66 
	mBFCP_ACCEPTED
 = 2,

67 
	mBFCP_GRANTED
 = 3,

68 
	mBFCP_DENIED
 = 4,

69 
	mBFCP_CANCELLED
 = 5,

70 
	mBFCP_RELEASED
 = 6,

71 
	mBFCP_REVOKED
 = 7

75 
	ebfı_”r
 {

76 
	mBFCP_CONF_NOT_EXIST
 = 1,

77 
	mBFCP_USER_NOT_EXIST
 = 2,

78 
	mBFCP_UNKNOWN_PRIM
 = 3,

79 
	mBFCP_UNKNOWN_MAND_ATTR
 = 4,

80 
	mBFCP_UNAUTH_OPERATION
 = 5,

81 
	mBFCP_INVALID_FLOOR_ID
 = 6,

82 
	mBFCP_FLOOR_REQ_ID_NOT_EXIST
 = 7,

83 
	mBFCP_MAX_FLOOR_REQ_REACHED
 = 8,

84 
	mBFCP_USE_TLS
 = 9,

85 
	mBFCP_PARSE_ERROR
 = 10,

86 
	mBFCP_USE_DTLS
 = 11,

87 
	mBFCP_UNSUPPORTED_VERSION
 = 12,

88 
	mBFCP_BAD_LENGTH
 = 13,

89 
	mBFCP_GENERIC_ERROR
 = 14,

93 
	ebfı_´iÜ™y
 {

94 
	mBFCP_PRIO_LOWEST
 = 0,

95 
	mBFCP_PRIO_LOW
 = 1,

96 
	mBFCP_PRIO_NORMAL
 = 2,

97 
	mBFCP_PRIO_HIGH
 = 3,

98 
	mBFCP_PRIO_HIGHEST
 = 4

102 
	ebfı_Œª¥
 {

103 
	mBFCP_UDP
,

104 
	mBFCP_DTLS
,

108 
	sbfı_»q¡©us
 {

109 
bfı_»q¡©
 
	m¡©us
;

110 
ušt8_t
 
	mqpos
;

114 
	sbfı_”rcode
 {

115 
bfı_”r
 
	mcode
;

116 
ušt8_t
 *
	md‘as
;

117 
size_t
 
	mËn
;

121 
	sbfı_su·‰r
 {

122 
bfı_©Œib
 *
	m©Œv
;

123 
size_t
 
	m©Œc
;

127 
	sbfı_suµrim
 {

128 
bfı_´im
 *
	m´imv
;

129 
size_t
 
	m´imc
;

133 
	sbfı_©Œ
 {

134 
Ë
 
	mË
;

135 
li¡
 
	m©Œl
;

136 
bfı_©Œib
 
	mty³
;

137 
boŞ
 
	mmªd
;

138 
	ubfı_uniÚ
 {

140 *
	m¡r
;

141 
ušt16_t
 
	mu16
;

144 
ušt16_t
 
	mb’eficŸryid
;

145 
ušt16_t
 
	mæoÜid
;

146 
ušt16_t
 
	mæoÜ»qid
;

147 
bfı_´iÜ™y
 
	m´iÜ™y
;

148 
bfı_»q¡©us
 
	m»q¡©us
;

149 
bfı_”rcode
 
	m”rcode
;

150 *
	m”ršfo
;

151 *
	m·¹´ovšfo
;

152 *
	m¡©usšfo
;

153 
bfı_su·‰r
 
	msu·‰r
;

154 
bfı_suµrim
 
	msuµrim
;

155 *
	mu£rdÇme
;

156 *
	mu£ruri
;

157 
ušt16_t
 
	m»qbyid
;

158 } 
	mv
;

162 
	sbfı_unknown_©Œ
 {

163 
ušt8_t
 
	mty³v
[16];

164 
size_t
 
	mty³c
;

168 
	sbfı_msg
 {

169 
bfı_unknown_©Œ
 
	muma
;

170 
§
 
	m¤c
;

171 
ušt8_t
 
	mv”
;

172 
	mr
:1;

173 
	mf
:1;

174 
bfı_´im
 
	m´im
;

175 
ušt16_t
 
	mËn
;

176 
ušt32_t
 
	mcÚfid
;

177 
ušt16_t
 
	mtid
;

178 
ušt16_t
 
	mu£rid
;

179 
li¡
 
	m©Œl
;

182 
	gs
;

183 
	gbfı_cÚn
;

194 (
	tbfı_’code_h
)(
	tmbuf
 *
	tmb
, *
	t¬g
);

197 
	sbfı_’code
 {

198 
bfı_’code_h
 *
’ch
;

199 *
¬g
;

211 
	$boŞ
 (
	tbfı_©Œ_h
)(cÚ¡ 
	tbfı_©Œ
 *
	t©Œ
, *
	t¬g
);

220 (
	tbfı_»cv_h
)(cÚ¡ 
	tbfı_msg
 *
	tmsg
, *
	t¬g
);

230 (
	tbfı_»¥_h
)(
	t”r
, cÚ¡ 
	tbfı_msg
 *
	tmsg
, *
	t¬g
);

234 
	`bfı_©Œs_v’code
(
mbuf
 *
mb
, 
©Œc
, 
va_li¡
 *
­
);

235 
	`bfı_©Œs_’code
(
mbuf
 *
mb
, 
©Œc
, ...);

236 
bfı_©Œ
 *
	`bfı_©Œ_sub©Œ
(cÚ¡ bfı_©Œ *
©Œ
,

237 
bfı_©Œib
 
ty³
);

238 
bfı_©Œ
 *
	`bfı_©Œ_sub©Œ_­¶y
(cÚ¡ bfı_©Œ *
©Œ
,

239 
bfı_©Œ_h
 *
h
, *
¬g
);

240 
	`bfı_©Œ_´št
(
»_´štf
 *
pf
, cÚ¡ 
bfı_©Œ
 *
©Œ
);

241 cÚ¡ *
	`bfı_©Œ_Çme
(
bfı_©Œib
 
ty³
);

242 cÚ¡ *
	`bfı_»q¡©us_Çme
(
bfı_»q¡©
 
¡©us
);

243 cÚ¡ *
	`bfı_”rcode_Çme
(
bfı_”r
 
code
);

247 
	`bfı_msg_v’code
(
mbuf
 *
mb
, 
ušt8_t
 
v”
, 
boŞ
 
r
, 
bfı_´im
 
´im
,

248 
ušt32_t
 
cÚfid
, 
ušt16_t
 
tid
, ušt16_ˆ
u£rid
,

249 
©Œc
, 
va_li¡
 *
­
);

250 
	`bfı_msg_’code
(
mbuf
 *
mb
, 
ušt8_t
 
v”
, 
boŞ
 
r
, 
bfı_´im
 
´im
,

251 
ušt32_t
 
cÚfid
, 
ušt16_t
 
tid
, ušt16_ˆ
u£rid
,

252 
©Œc
, ...);

253 
	`bfı_msg_decode
(
bfı_msg
 **
msgp
, 
mbuf
 *
mb
);

254 
bfı_©Œ
 *
	`bfı_msg_©Œ
(cÚ¡ 
bfı_msg
 *
msg
,

255 
bfı_©Œib
 
ty³
);

256 
bfı_©Œ
 *
	`bfı_msg_©Œ_­¶y
(cÚ¡ 
bfı_msg
 *
msg
,

257 
bfı_©Œ_h
 *
h
, *
¬g
);

258 
	`bfı_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
bfı_msg
 *
msg
);

259 cÚ¡ *
	`bfı_´im_Çme
(
bfı_´im
 
´im
);

263 
	`bfı_li¡’
(
bfı_cÚn
 **
bı
, 
bfı_Œª¥
 

, 
§
 *
Ïddr
,

264 
s
 *s, 
bfı_»cv_h
 *
»cvh
, *
¬g
);

265 *
	`bfı_sock
(cÚ¡ 
bfı_cÚn
 *
bc
);

269 
	`bfı_»que¡
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

270 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

271 
bfı_»¥_h
 *
»¥h
, *
¬g
, 
©Œc
, ...);

275 
	`bfı_nÙify
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

276 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

277 
©Œc
, ...);

281 
	`bfı_»¶y
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

282 
bfı_´im
 
´im
, 
©Œc
, ...);

283 
	`bfı_ed»¶y
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

284 
bfı_”r
 
code
, cÚ¡ 
ušt8_t
 *
d‘as
, 
size_t
 
Ën
);

285 
	`bfı_”•ly
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

286 
bfı_”r
 
code
);

	@re-0.5.6/include/re_bitv.h

8 
	tb™v_t
;

11 
	mBITS_SZ
 = (8*(
b™v_t
)),

12 
	mBITS_MASK
 = (
BITS_SZ
-1)

15 
	#BITV_NELEM
(
nb™s
è((Òb™sè+ (
BITS_SZ
è- 1è/ (BITS_SZ))

	)

16 
	#BITV_DECL
(
Çme
, 
nb™s
è
	`b™v_t
 (Çme)[
	`BITV_NELEM
Òb™s)]

	)

19 
šlše
 
ušt32_t
 
	$šdex2off£t
(
ušt32_t
 
i
)

21  
i
/
BITS_SZ
;

22 
	}
}

24 
šlše
 
b™v_t
 
	$šdex2b™
(
ušt32_t
 
i
)

26  (
b™v_t
)1<<(
i
 & 
BITS_MASK
);

27 
	}
}

35 
šlše
 
	$b™v_š™
(
b™v_t
 *
bv
, 
ušt32_t
 
nb™s
, 
boŞ
 
v®
)

37 
	`mem£t
(
bv
, 
v®
?0xff:0x00, 
	`BITV_NELEM
(
nb™s
)*(
b™v_t
));

38 
	}
}

40 
šlše
 
	$b™v_£t
(
b™v_t
 *
bv
, 
ušt32_t
 
i
)

42 
bv
[
	`šdex2off£t
(
i
)] |ğ
	`šdex2b™
(i);

43 
	}
}

45 
šlše
 
	$b™v_şr
(
b™v_t
 *
bv
, 
ušt32_t
 
i
)

47 
bv
[
	`šdex2off£t
(
i
)] &ğ~
	`šdex2b™
(i);

48 
	}
}

50 
šlše
 
	$b™v_assign
(
b™v_t
 *
bv
, 
ušt32_t
 
i
, 
boŞ
 
v®
)

52 ià(
v®
)

53 
	`b™v_£t
(
bv
, 
i
);

55 
	`b™v_şr
(
bv
, 
i
);

56 
	}
}

58 
šlše
 
boŞ
 
	$b™v_v®
(cÚ¡ 
b™v_t
 *
bv
, 
ušt32_t
 
i
)

60  0 !ğ(
bv
[
	`šdex2off£t
(
i
)] & 
	`šdex2b™
(i));

61 
	}
}

63 
šlše
 
	$b™v_toggË
(
b™v_t
 *
bv
, 
ušt32_t
 
i
)

65 
bv
[
	`šdex2off£t
(
i
)] ^ğ
	`šdex2b™
(i);

66 
	}
}

68 
šlše
 
	$b™v_assign_¿nge
(
b™v_t
 *
bv
, 
ušt32_t
 
i
, ušt32_ˆ
n
,

69 
boŞ
 
v®
)

71 
n
--)

72 
	`b™v_assign
(
bv
, 
i
+
n
, 
v®
);

73 
	}
}

	@re-0.5.6/include/re_conf.h

8 
	gcÚf
;

10 (
	tcÚf_h
)(cÚ¡ 
	t¶
 *
	tv®
, *
	t¬g
);

12 
	`cÚf_®loc
(
cÚf
 **
cÚå
, cÚ¡ *
f’ame
);

13 
	`cÚf_®loc_buf
(
cÚf
 **
cÚå
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
);

14 
	`cÚf_g‘
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
¶
 *pl);

15 
	`cÚf_g‘_¡r
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, *
¡r
,

16 
size_t
 
size
);

17 
	`cÚf_g‘_u32
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
ušt32_t
 *
num
);

18 
	`cÚf_g‘_boŞ
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
boŞ
 *
v®
);

19 
	`cÚf_­¶y
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

20 
cÚf_h
 *
ch
, *
¬g
);

	@re-0.5.6/include/re_crc32.h

8 #ifdeà
USE_ZLIB


9 
	~<zlib.h
>

11 
ušt32_t
 
üc32
(ušt32_ˆ
üc
, cÚ¡ *
buf
, ušt32_ˆ
size
);

	@re-0.5.6/include/re_dbg.h

7 #ifdeà
__ılu¥lus


13 
DBG_EMERG
 = 0,

14 
DBG_ALERT
 = 1,

15 
DBG_CRIT
 = 2,

16 
DBG_ERR
 = 3,

17 
DBG_WARNING
 = 4,

18 
DBG_NOTICE
 = 5,

19 
DBG_INFO
 = 6,

20 
DBG_DEBUG
 = 7

36 #iâdeà
DEBUG_MODULE


38 
	#DEBUG_MODULE
 "?"

	)

41 #iâdeà
DEBUG_LEVEL


43 
	#DEBUG_LEVEL
 7

	)

72 #ià(
defšed
(
__STDC_VERSION__
) && __STDC_VERSION__ >= 199901L) \

73 || (
__GNUC__
 >= 3)

75 #ià(
DEBUG_LEVEL
 >= 4)

76 
	#DEBUG_WARNING
(...) \

77 
	`dbg_´štf
(
DBG_WARNING
, 
DEBUG_MODULE
 ": " 
__VA_ARGS__
)

	)

79 
	#DEBUG_WARNING
(...)

	)

82 #ià(
DEBUG_LEVEL
 >= 5)

83 
	#DEBUG_NOTICE
(...) \

84 
	`dbg_´štf
(
DBG_NOTICE
, 
DEBUG_MODULE
 ": " 
__VA_ARGS__
)

	)

86 
	#DEBUG_NOTICE
(...)

	)

89 #ià(
DEBUG_LEVEL
 >= 6)

90 
	#DEBUG_INFO
(...) \

91 
	`dbg_´štf
(
DBG_INFO
, 
DEBUG_MODULE
 ": " 
__VA_ARGS__
)

	)

93 
	#DEBUG_INFO
(...)

	)

96 #ià(
DEBUG_LEVEL
 >= 7)

97 
	#DEBUG_PRINTF
(...) \

98 
	`dbg_´štf
(
DBG_DEBUG
, 
DEBUG_MODULE
 ": " 
__VA_ARGS__
)

	)

100 
	#DEBUG_PRINTF
(...)

	)

104 #–ià
defšed
(
__GNUC__
)

106 #ià(
DEBUG_LEVEL
 >= 4)

107 
	#DEBUG_WARNING
(
a
...è
	`dbg_´štf
(
DBG_WARNING
, 
DEBUG_MODULE
 ": "‡)

	)

109 
	#DEBUG_WARNING
(
a
...)

	)

112 #ià(
DEBUG_LEVEL
 >= 5)

113 
	#DEBUG_NOTICE
(
a
...è
	`dbg_´štf
(
DBG_NOTICE
, 
DEBUG_MODULE
 ": "‡)

	)

115 
	#DEBUG_NOTICE
(
a
...)

	)

118 #ià(
DEBUG_LEVEL
 >= 6)

119 
	#DEBUG_INFO
(
a
...è
	`dbg_´štf
(
DBG_INFO
, 
DEBUG_MODULE
 ": "‡)

	)

121 
	#DEBUG_INFO
(
a
...)

	)

124 #ià(
DEBUG_LEVEL
 >= 7)

125 
	#DEBUG_PRINTF
(
a
...è
	`dbg_´štf
(
DBG_DEBUG
, 
DEBUG_MODULE
 ": "‡)

	)

127 
	#DEBUG_PRINTF
(
a
...)

	)

133 #ià(
DEBUG_LEVEL
 >= 4)

134 
	#DEBUG_WARNING
 
dbg_w¬nšg


	)

136 
	#DEBUG_WARNING
 
dbg_nİrštf


	)

139 #ià(
DEBUG_LEVEL
 >= 5)

140 
	#DEBUG_NOTICE
 
dbg_nÙiû


	)

142 
	#DEBUG_NOTICE
 
dbg_nİrštf


	)

145 #ià(
DEBUG_LEVEL
 >= 6)

146 
	#DEBUG_INFO
 
dbg_šfo


	)

148 
	#DEBUG_INFO
 
dbg_nİrštf


	)

151 #ià(
DEBUG_LEVEL
 >= 7)

152 
	#DEBUG_PRINTF
 
dbg_nİrštf


	)

154 
	#DEBUG_PRINTF
 
dbg_nİrštf


	)

161 
	edbg_æags
 {

162 
DBG_NONE
 = 0,

163 
DBG_TIME
 = 1<<0,

164 
DBG_ANSI
 = 1<<1,

165 
DBG_ALL
 = 
DBG_TIME
|
DBG_ANSI


177 (
dbg_´št_h
)(
	tËv–
, cÚ¡ *
	tp
, 
	tsize_t
 
	tËn
, *
	t¬g
);

179 
dbg_š™
(
Ëv–
, 
dbg_æags
 
æags
);

180 
dbg_şo£
();

181 
dbg_logfe_£t
(cÚ¡ *
Çme
);

182 
dbg_hªdËr_£t
(
dbg_´št_h
 *
ph
, *
¬g
);

183 
dbg_´štf
(
Ëv–
, cÚ¡ *
fmt
, ...);

184 
dbg_nİrštf
(cÚ¡ *
fmt
, ...);

185 
dbg_w¬nšg
(cÚ¡ *
fmt
, ...);

186 
dbg_nÙiû
(cÚ¡ *
fmt
, ...);

187 
dbg_šfo
(cÚ¡ *
fmt
, ...);

188 cÚ¡ *
dbg_Ëv–_¡r
(
Ëv–
);

190 #ifdeà
__ılu¥lus


	@re-0.5.6/include/re_dns.h

9 
	mDNS_PORT
 = 53,

10 
	mDNS_HEADER_SIZE
 = 12

16 
	mDNS_OPCODE_QUERY
 = 0,

17 
	mDNS_OPCODE_IQUERY
 = 1,

18 
	mDNS_OPCODE_STATUS
 = 2,

19 
	mDNS_OPCODE_NOTIFY
 = 4

25 
	mDNS_RCODE_OK
 = 0,

26 
	mDNS_RCODE_FMT_ERR
 = 1,

27 
	mDNS_RCODE_SRV_FAIL
 = 2,

28 
	mDNS_RCODE_NAME_ERR
 = 3,

29 
	mDNS_RCODE_NOT_IMPL
 = 4,

30 
	mDNS_RCODE_REFUSED
 = 5,

31 
	mDNS_RCODE_NOT_AUTH
 = 9

37 
	mDNS_TYPE_A
 = 0x0001,

38 
	mDNS_TYPE_NS
 = 0x0002,

39 
	mDNS_TYPE_CNAME
 = 0x0005,

40 
	mDNS_TYPE_SOA
 = 0x0006,

41 
	mDNS_TYPE_PTR
 = 0x000c,

42 
	mDNS_TYPE_MX
 = 0x000f,

43 
	mDNS_TYPE_AAAA
 = 0x001c,

44 
	mDNS_TYPE_SRV
 = 0x0021,

45 
	mDNS_TYPE_NAPTR
 = 0x0023,

46 
	mDNS_QTYPE_IXFR
 = 0x00fb,

47 
	mDNS_QTYPE_AXFR
 = 0x00fc,

48 
	mDNS_QTYPE_ANY
 = 0x00ff

54 
	mDNS_CLASS_IN
 = 0x0001,

55 
	mDNS_QCLASS_ANY
 = 0x00ff

60 
	sdnshdr
 {

61 
ušt16_t
 
	mid
;

62 
boŞ
 
	mqr
;

63 
ušt8_t
 
	mİcode
;

64 
boŞ
 
	m¯
;

65 
boŞ
 
	mtc
;

66 
boŞ
 
	mrd
;

67 
boŞ
 
	m¿
;

68 
ušt8_t
 
	mz
;

69 
ušt8_t
 
	mrcode
;

70 
ušt16_t
 
	mnq
;

71 
ušt16_t
 
	mÇns
;

72 
ušt16_t
 
	mÇuth
;

73 
ušt16_t
 
	mÇdd
;

78 
	sdn¤r
 {

79 
Ë
 
	mË
;

80 
Ë
 
	mË_´iv
;

81 *
	mÇme
;

82 
ušt16_t
 
	mty³
;

83 
ušt16_t
 
	mdnsşass
;

84 
št64_t
 
	m‰l
;

85 
ušt16_t
 
	mrdËn
;

88 
ušt32_t
 
	maddr
;

89 } 
	ma
;

91 *
	mnsdÇme
;

92 } 
	mns
;

94 *
	múame
;

95 } 
	múame
;

97 *
	mmÇme
;

98 *
	mºame
;

99 
ušt32_t
 
	m£rŸl
;

100 
ušt32_t
 
	m»äesh
;

101 
ušt32_t
 
	m»Œy
;

102 
ušt32_t
 
	mexpœe
;

103 
ušt32_t
 
	m‰lmš
;

104 } 
	msß
;

106 *
	m±rdÇme
;

107 } 
	m±r
;

109 
ušt16_t
 
	m´ef
;

110 *
	mexchªge
;

111 } 
	mmx
;

113 
ušt8_t
 
	maddr
[16];

114 } 
	m¯¯
;

116 
ušt16_t
 
	m´i
;

117 
ušt16_t
 
	mweight
;

118 
ušt16_t
 
	mpÜt
;

119 *
	mrg‘
;

120 } 
	m¤v
;

122 
ušt16_t
 
	mÜd”
;

123 
ušt16_t
 
	m´ef
;

124 *
	mæags
;

125 *
	m£rviûs
;

126 *
	m»gexp
;

127 *
	m»¶aû
;

128 } 
	mÇ±r
;

129 } 
	mrd©a
;

132 
	ghash
;

144 (
	tdns_qu”y_h
)(
	t”r
, cÚ¡ 
	tdnshdr
 *
	thdr
,

145 
	tli¡
 *
	tª¦
, li¡ *
	tauthl
,

146 
	tli¡
 *
	taddl
, *
	t¬g
);

156 
	$boŞ
(
	tdns_¼li¡_h
)(
	tdn¤r
 *
	t¼
, *
	t¬g
);

158 
	`dns_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
dnshdr
 *
hdr
);

159 
	`dns_hdr_decode
(
mbuf
 *
mb
, 
dnshdr
 *
hdr
);

160 cÚ¡ *
	`dns_hdr_İcod’ame
(
ušt8_t
 
İcode
);

161 cÚ¡ *
	`dns_hdr_rcod’ame
(
ušt8_t
 
rcode
);

162 
dn¤r
 *
	`dns_¼_®loc
();

163 
	`dns_¼_’code
(
mbuf
 *
mb
, cÚ¡ 
dn¤r
 *
¼
, 
št64_t
 
‰l_offs
,

164 
hash
 *
ht_dÇme
, 
size_t
 
¡¬t
);

165 
	`dns_¼_decode
(
mbuf
 *
mb
, 
dn¤r
 **
¼
, 
size_t
 
¡¬t
);

166 
boŞ
 
	`dns_¼_cmp
(cÚ¡ 
dn¤r
 *
¼1
, cÚ¡ dn¤¸*
¼2
, boŞ 
rd©a
);

167 cÚ¡ *
	`dns_¼_ty³Çme
(
ušt16_t
 
ty³
);

168 cÚ¡ *
	`dns_¼_şas¢ame
(
ušt16_t
 
dnsşass
);

169 
	`dns_¼_´št
(
»_´štf
 *
pf
, cÚ¡ 
dn¤r
 *
¼
);

170 
	`dns_dÇme_’code
(
mbuf
 *
mb
, cÚ¡ *
Çme
,

171 
hash
 *
ht_dÇme
, 
size_t
 
¡¬t
, 
boŞ
 
comp
);

172 
	`dns_dÇme_decode
(
mbuf
 *
mb
, **
Çme
, 
size_t
 
¡¬t
);

173 
	`dns_c¡r_’code
(
mbuf
 *
mb
, cÚ¡ *
¡r
);

174 
	`dns_c¡r_decode
(
mbuf
 *
mb
, **
¡r
);

175 
	`dns_¼li¡_sÜt
(
li¡
 *
¼l
, 
ušt16_t
 
ty³
, 
size_t
 
key
);

176 
	`dns_¼li¡_sÜt_addr
(
li¡
 *
¼l
, 
size_t
 
key
);

177 
dn¤r
 *
	`dns_¼li¡_­¶y
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

178 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
,

179 
boŞ
 
»cur£
, 
dns_¼li¡_h
 *
¼lh
, *
¬g
);

180 
dn¤r
 *
	`dns_¼li¡_­¶y2
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

181 
ušt16_t
 
ty³1
, ušt16_ˆ
ty³2
,

182 
ušt16_t
 
dnsşass
, 
boŞ
 
»cur£
,

183 
dns_¼li¡_h
 *
¼lh
, *
¬g
);

184 
dn¤r
 *
	`dns_¼li¡_fšd
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

185 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, 
boŞ
 
»cur£
);

189 
§
;

190 
dnsc
;

191 
dns_qu”y
;

194 
	sdnsc_cÚf
 {

195 
ušt32_t
 
qu”y_hash_size
;

196 
ušt32_t
 
tı_hash_size
;

197 
ušt32_t
 
cÚn_timeout
;

198 
ušt32_t
 
idË_timeout
;

201 
	`dnsc_®loc
(
dnsc
 **
dıp
, cÚ¡ 
dnsc_cÚf
 *
cÚf
,

202 cÚ¡ 
§
 *
¤vv
, 
ušt32_t
 
¤vc
);

203 
	`dnsc_¤v_£t
(
dnsc
 *dnsc, cÚ¡ 
§
 *
¤vv
, 
ušt32_t
 
¤vc
);

204 
	`dnsc_qu”y
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

205 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
,

206 
boŞ
 
rd
, 
dns_qu”y_h
 *
qh
, *
¬g
);

207 
	`dnsc_qu”y_¤v
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

208 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, 
´Ùo
,

209 cÚ¡ 
§
 *
¤vv
, cÚ¡ 
ušt32_t
 *
¤vc
,

210 
boŞ
 
rd
, 
dns_qu”y_h
 *
qh
, *
¬g
);

211 
	`dnsc_nÙify
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

212 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, cÚ¡ 
dn¤r
 *
ªs_¼
,

213 
´Ùo
, cÚ¡ 
§
 *
¤vv
, cÚ¡ 
ušt32_t
 *
¤vc
,

214 
dns_qu”y_h
 *
qh
, *
¬g
);

218 
	`dns_¤v_g‘
(*
domaš
, 
size_t
 
dsize
, 
§
 *
¤vv
, 
ušt32_t
 *
n
);

	@re-0.5.6/include/re_fmt.h

8 
	~<¡d¬g.h
>

9 
	~<¡dio.h
>

12 
	gmbuf
;

16 
	s¶
 {

17 cÚ¡ *
	mp
;

18 
size_t
 
	ml
;

22 
	#PL
(
s
è{(s), ((s))-1}

	)

25 
	#PL_INIT
 {
NULL
, 0}

	)

27 cÚ¡ 
¶
 
¶_nuÎ
;

29 
¶_£t_¡r
(
¶
 *¶, cÚ¡ *
¡r
);

30 
¶_£t_mbuf
(
¶
 *¶, cÚ¡ 
mbuf
 *
mb
);

31 
ušt32_t
 
¶_u32
(cÚ¡ 
¶
 *pl);

32 
ušt32_t
 
¶_x32
(cÚ¡ 
¶
 *pl);

33 
ušt64_t
 
¶_u64
(cÚ¡ 
¶
 *pl);

34 
ušt64_t
 
¶_x64
(cÚ¡ 
¶
 *pl);

35 
¶_æßt
(cÚ¡ 
¶
 *pl);

36 
boŞ
 
¶_is£t
(cÚ¡ 
¶
 *pl);

37 
¶_¡rıy
(cÚ¡ 
¶
 *¶, *
¡r
, 
size_t
 
size
);

38 
¶_¡rdup
(**
d¡
, cÚ¡ 
¶
 *
¤c
);

39 
¶_dup
(
¶
 *
d¡
, cÚ¡ ¶ *
¤c
);

40 
¶_¡rcmp
(cÚ¡ 
¶
 *¶, cÚ¡ *
¡r
);

41 
¶_¡rÿ£cmp
(cÚ¡ 
¶
 *¶, cÚ¡ *
¡r
);

42 
¶_cmp
(cÚ¡ 
¶
 *
¶1
, cÚ¡ ¶ *
¶2
);

43 
¶_ÿ£cmp
(cÚ¡ 
¶
 *
¶1
, cÚ¡ ¶ *
¶2
);

44 cÚ¡ *
¶_¡rchr
(cÚ¡ 
¶
 *¶, 
c
);

47 
šlše
 
	$¶_advªû
(
¶
 *¶, 
ssize_t
 
n
)

49 
¶
->
p
 +ğ
n
;

50 
¶
->
l
 -ğ
n
;

51 
	}
}

65 (
	t»_v´štf_h
)(cÚ¡ *
	tp
, 
	tsize_t
 
	tsize
, *
	t¬g
);

68 
	s»_´štf
 {

69 
»_v´štf_h
 *
vph
;

70 *
¬g
;

81 (
	t»_´štf_h
)(
	t»_´štf
 *
	tpf
, *
	t¬g
);

83 
	`»_vh´štf
(cÚ¡ *
fmt
, 
va_li¡
 
­
, 
»_v´štf_h
 *
vph
, *
¬g
);

84 
	`»_vårštf
(
FILE
 *
¡»am
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

85 
	`»_v´štf
(cÚ¡ *
fmt
, 
va_li¡
 
­
);

86 
	`»_v¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

87 
	`»_vsd´štf
(**
¡½
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

89 
	`»_h´štf
(
»_´štf
 *
pf
, cÚ¡ *
fmt
, ...);

90 
	`»_årštf
(
FILE
 *
¡»am
, cÚ¡ *
fmt
, ...);

91 
	`»_´štf
(cÚ¡ *
fmt
, ...);

92 
	`»_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fmt
, ...);

93 
	`»_sd´štf
(**
¡½
, cÚ¡ *
fmt
, ...);

97 
	`»_»gex
(cÚ¡ *
±r
, 
size_t
 
Ën
, cÚ¡ *
ex´
, ...);

101 
ušt8_t
 
	`ch_hex
(
ch
);

105 
	`¡r_hex
(
ušt8_t
 *
hex
, 
size_t
 
Ën
, cÚ¡ *
¡r
);

106 
	`¡r_nıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
);

107 
	`¡r_dup
(**
d¡
, cÚ¡ *
¤c
);

108 
	`¡r_cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
);

109 
	`¡r_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
);

110 
size_t
 
	`¡r_Ën
(cÚ¡ *
s
);

111 cÚ¡ *
	`¡r_”rÜ
(
”ºum
, *
buf
, 
size_t
 
sz
);

121 
šlše
 
boŞ
 
	$¡r_is£t
(cÚ¡ *
s
)

123  
s
 && s[0] != '\0';

124 
	}
}

128 
fmt_gmtime
(
»_´štf
 *
pf
, *
ts
);

129 
fmt_humª_time
(
»_´štf
 *
pf
, cÚ¡ 
ušt32_t
 *
£cÚds
);

132 
hexdump
(
FILE
 *
f
, cÚ¡ *
p
, 
size_t
 
Ën
);

136 (
	tfmt_·¿m_h
)(cÚ¡ 
	t¶
 *
	tÇme
, cÚ¡ ¶ *
	tv®
,

137 *
	t¬g
);

139 
boŞ
 
	`fmt_·¿m_exi¡s
(cÚ¡ 
¶
 *¶, cÚ¡ *
²ame
);

140 
boŞ
 
	`fmt_·¿m_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ *
²ame
, ¶ *
v®
);

141 
	`fmt_·¿m_­¶y
(cÚ¡ 
¶
 *¶, 
fmt_·¿m_h
 *
ph
, *
¬g
);

145 
	`utf8_’code
(
»_´štf
 *
pf
, cÚ¡ *
¡r
);

146 
	`utf8_decode
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

	@re-0.5.6/include/re_hash.h

8 
	ghash
;

9 
	g¶
;

12 
hash_®loc
(
hash
 **
hp
, 
ušt32_t
 
bsize
);

13 
hash_­³nd
(
hash
 *
h
, 
ušt32_t
 
key
, 
Ë
 *Ë, *
d©a
);

14 
hash_uÆšk
(
Ë
 *le);

15 
Ë
 *
hash_lookup
(cÚ¡ 
hash
 *
h
, 
ušt32_t
 
key
, 
li¡_­¶y_h
 *
ah
,

16 *
¬g
);

17 
Ë
 *
hash_­¶y
(cÚ¡ 
hash
 *
h
, 
li¡_­¶y_h
 *
ah
, *
¬g
);

18 
li¡
 *
hash_li¡
(cÚ¡ 
hash
 *
h
, 
ušt32_t
 
key
);

19 
ušt32_t
 
hash_bsize
(cÚ¡ 
hash
 *
h
);

20 
hash_æush
(
hash
 *
h
);

21 
hash_ş—r
(
hash
 *
h
);

22 
ušt32_t
 
hash_v®id_size
(ušt32_ˆ
size
);

26 
ušt32_t
 
hash_jß©
(cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
Ën
);

27 
ušt32_t
 
hash_jß©_ci
(cÚ¡ *
¡r
, 
size_t
 
Ën
);

28 
ušt32_t
 
hash_jß©_¡r
(cÚ¡ *
¡r
);

29 
ušt32_t
 
hash_jß©_¡r_ci
(cÚ¡ *
¡r
);

30 
ušt32_t
 
hash_jß©_¶
(cÚ¡ 
¶
 *pl);

31 
ušt32_t
 
hash_jß©_¶_ci
(cÚ¡ 
¶
 *pl);

32 
ušt32_t
 
hash_ç¡
(cÚ¡ *
k
, 
size_t
 
Ën
);

33 
ušt32_t
 
hash_ç¡_¡r
(cÚ¡ *
¡r
);

	@re-0.5.6/include/re_hmac.h

8 
hmac_sha1
(cÚ¡ 
ušt8_t
 *
k
,

9 
size_t
 
lk
,

10 cÚ¡ 
ušt8_t
 *
d
,

11 
size_t
 
ld
,

12 
ušt8_t
* 
out
,

13 
size_t
 
t
);

16 
	ehmac_hash
 {

17 
	mHMAC_HASH_SHA1
,

18 
	mHMAC_HASH_SHA256


21 
	ghmac
;

23 
hmac_ü—‹
(
hmac
 **
hmaı
, 
hmac_hash
 
hash
,

24 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_Ën
);

25 
hmac_dige¡
(
hmac
 *hmac, 
ušt8_t
 *
md
, 
size_t
 
md_Ën
,

26 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©a_Ën
);

	@re-0.5.6/include/re_http.h

9 
	eh‰p_hdrid
 {

10 
	mHTTP_HDR_ACCEPT
 = 3186,

11 
	mHTTP_HDR_ACCEPT_CHARSET
 = 24,

12 
	mHTTP_HDR_ACCEPT_ENCODING
 = 708,

13 
	mHTTP_HDR_ACCEPT_LANGUAGE
 = 2867,

14 
	mHTTP_HDR_ACCEPT_RANGES
 = 3027,

15 
	mHTTP_HDR_AGE
 = 742,

16 
	mHTTP_HDR_ALLOW
 = 2429,

17 
	mHTTP_HDR_AUTHORIZATION
 = 2503,

18 
	mHTTP_HDR_CACHE_CONTROL
 = 2530,

19 
	mHTTP_HDR_CONNECTION
 = 865,

20 
	mHTTP_HDR_CONTENT_ENCODING
 = 580,

21 
	mHTTP_HDR_CONTENT_LANGUAGE
 = 3371,

22 
	mHTTP_HDR_CONTENT_LENGTH
 = 3861,

23 
	mHTTP_HDR_CONTENT_LOCATION
 = 3927,

24 
	mHTTP_HDR_CONTENT_MD5
 = 406,

25 
	mHTTP_HDR_CONTENT_RANGE
 = 2846,

26 
	mHTTP_HDR_CONTENT_TYPE
 = 809,

27 
	mHTTP_HDR_DATE
 = 1027,

28 
	mHTTP_HDR_ETAG
 = 2392,

29 
	mHTTP_HDR_EXPECT
 = 1550,

30 
	mHTTP_HDR_EXPIRES
 = 1983,

31 
	mHTTP_HDR_FROM
 = 1963,

32 
	mHTTP_HDR_HOST
 = 3191,

33 
	mHTTP_HDR_IF_MATCH
 = 2684,

34 
	mHTTP_HDR_IF_MODIFIED_SINCE
 = 2187,

35 
	mHTTP_HDR_IF_NONE_MATCH
 = 4030,

36 
	mHTTP_HDR_IF_RANGE
 = 2220,

37 
	mHTTP_HDR_IF_UNMODIFIED_SINCE
 = 962,

38 
	mHTTP_HDR_LAST_MODIFIED
 = 2946,

39 
	mHTTP_HDR_LOCATION
 = 2514,

40 
	mHTTP_HDR_MAX_FORWARDS
 = 3549,

41 
	mHTTP_HDR_PRAGMA
 = 1673,

42 
	mHTTP_HDR_PROXY_AUTHENTICATE
 = 116,

43 
	mHTTP_HDR_PROXY_AUTHORIZATION
 = 2363,

44 
	mHTTP_HDR_RANGE
 = 4004,

45 
	mHTTP_HDR_REFERER
 = 2991,

46 
	mHTTP_HDR_RETRY_AFTER
 = 409,

47 
	mHTTP_HDR_SEC_WEBSOCKET_ACCEPT
 = 2959,

48 
	mHTTP_HDR_SEC_WEBSOCKET_EXTENSIONS
 = 2937,

49 
	mHTTP_HDR_SEC_WEBSOCKET_KEY
 = 746,

50 
	mHTTP_HDR_SEC_WEBSOCKET_PROTOCOL
 = 2076,

51 
	mHTTP_HDR_SEC_WEBSOCKET_VERSION
 = 3158,

52 
	mHTTP_HDR_SERVER
 = 973,

53 
	mHTTP_HDR_TE
 = 2035,

54 
	mHTTP_HDR_TRAILER
 = 2577,

55 
	mHTTP_HDR_TRANSFER_ENCODING
 = 2115,

56 
	mHTTP_HDR_UPGRADE
 = 717,

57 
	mHTTP_HDR_USER_AGENT
 = 4064,

58 
	mHTTP_HDR_VARY
 = 3076,

59 
	mHTTP_HDR_VIA
 = 3961,

60 
	mHTTP_HDR_WARNING
 = 2108,

61 
	mHTTP_HDR_WWW_AUTHENTICATE
 = 2763,

63 
	mHTTP_HDR_NONE
 = -1

68 
	sh‰p_hdr
 {

69 
Ë
 
	mË
;

70 
¶
 
	mÇme
;

71 
¶
 
	mv®
;

72 
h‰p_hdrid
 
	mid
;

76 
	sh‰p_msg
 {

77 
¶
 
	mv”
;

78 
¶
 
	mm‘
;

79 
¶
 
	m·th
;

80 
¶
 
	m´m
;

81 
ušt16_t
 
	mscode
;

82 
¶
 
	m»asÚ
;

83 
li¡
 
	mhd¾
;

84 
msg_ùy³
 
	mùyp
;

85 
mbuf
 *
	m_mb
;

86 
mbuf
 *
	mmb
;

87 
ušt32_t
 
	mş’
;

90 
	$boŞ
(
	th‰p_hdr_h
)(cÚ¡ 
	th‰p_hdr
 *
	thdr
, *
	t¬g
);

92 
	`h‰p_msg_decode
(
h‰p_msg
 **
msgp
, 
mbuf
 *
mb
, 
boŞ
 
»q
);

95 cÚ¡ 
h‰p_hdr
 *
	`h‰p_msg_hdr
(cÚ¡ 
h‰p_msg
 *
msg
,

96 
h‰p_hdrid
 
id
);

97 cÚ¡ 
h‰p_hdr
 *
	`h‰p_msg_hdr_­¶y
(cÚ¡ 
h‰p_msg
 *
msg
,

98 
boŞ
 
fwd
, 
h‰p_hdrid
 
id
,

99 
h‰p_hdr_h
 *
h
, *
¬g
);

100 cÚ¡ 
h‰p_hdr
 *
	`h‰p_msg_xhdr
(cÚ¡ 
h‰p_msg
 *
msg
,

101 cÚ¡ *
Çme
);

102 cÚ¡ 
h‰p_hdr
 *
	`h‰p_msg_xhdr_­¶y
(cÚ¡ 
h‰p_msg
 *
msg
,

103 
boŞ
 
fwd
, cÚ¡ *
Çme
,

104 
h‰p_hdr_h
 *
h
, *
¬g
);

105 
ušt32_t
 
	`h‰p_msg_hdr_couÁ
(cÚ¡ 
h‰p_msg
 *
msg
, 
h‰p_hdrid
 
id
);

106 
ušt32_t
 
	`h‰p_msg_xhdr_couÁ
(cÚ¡ 
h‰p_msg
 *
msg
, cÚ¡ *
Çme
);

107 
boŞ
 
	`h‰p_msg_hdr_has_v®ue
(cÚ¡ 
h‰p_msg
 *
msg
, 
h‰p_hdrid
 
id
,

108 cÚ¡ *
v®ue
);

109 
boŞ
 
	`h‰p_msg_xhdr_has_v®ue
(cÚ¡ 
h‰p_msg
 *
msg
, cÚ¡ *
Çme
,

110 cÚ¡ *
v®ue
);

111 
	`h‰p_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
h‰p_msg
 *
msg
);

115 
h‰p_şi
;

116 
h‰p_»q
;

117 
dnsc
;

118 
tı_cÚn
;

119 
s_cÚn
;

121 (
	th‰p_»¥_h
)(
	t”r
, cÚ¡ 
	th‰p_msg
 *
	tmsg
, *
	t¬g
);

122 (
	th‰p_d©a_h
)(cÚ¡ 
	tušt8_t
 *
	tbuf
, 
	tsize_t
 
	tsize
,

123 cÚ¡ 
	th‰p_msg
 *
	tmsg
, *
	t¬g
);

124 (
	th‰p_cÚn_h
)(
	ttı_cÚn
 *
	ttc
, 
	ts_cÚn
 *
	tsc
,

125 *
	t¬g
);

127 
	`h‰p_ş›Á_®loc
(
h‰p_şi
 **
ş
, 
dnsc
 *dnsc);

128 
	`h‰p_»que¡
(
h‰p_»q
 **
»qp
, 
h‰p_şi
 *
şi
, cÚ¡ *
m‘
,

129 cÚ¡ *
uri
, 
h‰p_»¥_h
 *
»¥h
, 
h‰p_d©a_h
 *
d©ah
,

130 *
¬g
, cÚ¡ *
fmt
, ...);

131 
	`h‰p_»q_£t_cÚn_hªdËr
(
h‰p_»q
 *
»q
, 
h‰p_cÚn_h
 *
cÚnh
);

135 
h‰p_sock
;

136 
h‰p_cÚn
;

138 (
	th‰p_»q_h
)(
	th‰p_cÚn
 *
	tcÚn
, cÚ¡ 
	th‰p_msg
 *
	tmsg
,

139 *
	t¬g
);

141 
	`h‰p_li¡’
(
h‰p_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

142 
h‰p_»q_h
 *
»qh
, *
¬g
);

143 
	`h‰ps_li¡’
(
h‰p_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

144 cÚ¡ *
û¹
, 
h‰p_»q_h
 *
»qh
, *
¬g
);

145 
tı_sock
 *
	`h‰p_sock_tı
(
h‰p_sock
 *
sock
);

146 cÚ¡ 
§
 *
	`h‰p_cÚn_³”
(cÚ¡ 
h‰p_cÚn
 *
cÚn
);

147 
tı_cÚn
 *
	`h‰p_cÚn_tı
(
h‰p_cÚn
 *
cÚn
);

148 
s_cÚn
 *
	`h‰p_cÚn_s
(
h‰p_cÚn
 *
cÚn
);

149 
	`h‰p_cÚn_şo£
(
h‰p_cÚn
 *
cÚn
);

150 
	`h‰p_»¶y
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

151 cÚ¡ *
fmt
, ...);

152 
	`h‰p_ü•ly
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

153 cÚ¡ *
ùy³
, cÚ¡ *
fmt
, ...);

154 
	`h‰p_”•ly
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
);

158 
	sh‰p_auth
 {

159 cÚ¡ *
»®m
;

160 
boŞ
 
¡®e
;

163 (
	th‰p_auth_h
)(cÚ¡ 
	t¶
 *
	tu£ºame
, 
	tušt8_t
 *
	tha1
, *
	t¬g
);

165 
	`h‰p_auth_´št_ch®Ënge
(
»_´štf
 *
pf
,

166 cÚ¡ 
h‰p_auth
 *
auth
);

167 
boŞ
 
	`h‰p_auth_check
(cÚ¡ 
¶
 *
hv®
, cÚ¡ ¶ *
m‘hod
,

168 
h‰p_auth
 *
auth
, 
h‰p_auth_h
 *
authh
, *
¬g
);

169 
boŞ
 
	`h‰p_auth_check_»que¡
(cÚ¡ 
h‰p_msg
 *
msg
,

170 
h‰p_auth
 *
auth
,

171 
h‰p_auth_h
 *
authh
, *
¬g
);

	@re-0.5.6/include/re_httpauth.h

9 
	sh‰·uth_dige¡_ch®l
 {

10 
¶
 
	m»®m
;

11 
¶
 
	mnÚû
;

14 
¶
 
	mİaque
;

15 
¶
 
	m¡®e
;

16 
¶
 
	m®gÜ™hm
;

17 
¶
 
	mqİ
;

21 
	sh‰·uth_dige¡_»¥
 {

22 
¶
 
	m»®m
;

23 
¶
 
	mnÚû
;

24 
¶
 
	m»¥Ú£
;

25 
¶
 
	mu£ºame
;

26 
¶
 
	muri
;

29 
¶
 
	mnc
;

30 
¶
 
	múÚû
;

31 
¶
 
	mqİ
;

35 
h‰·uth_dige¡_ch®Ënge_decode
(
h‰·uth_dige¡_ch®l
 *
ch®l
,

36 cÚ¡ 
¶
 *
hv®
);

37 
h‰·uth_dige¡_»¥Ú£_decode
(
h‰·uth_dige¡_»¥
 *
»¥
,

38 cÚ¡ 
¶
 *
hv®
);

39 
h‰·uth_dige¡_»¥Ú£_auth
(cÚ¡ 
h‰·uth_dige¡_»¥
 *
»¥
,

40 cÚ¡ 
¶
 *
m‘hod
, cÚ¡ 
ušt8_t
 *
ha1
);

	@re-0.5.6/include/re_ice.h

9 
	eiû_mode
 {

10 
	mICE_MODE_FULL
,

11 
	mICE_MODE_LITE


15 
	eiû_rŞe
 {

16 
	mICE_ROLE_UNKNOWN
 = 0,

17 
	mICE_ROLE_CONTROLLING
,

18 
	mICE_ROLE_CONTROLLED


22 
	eiû_compid
 {

23 
	mICE_COMPID_RTP
 = 1,

24 
	mICE_COMPID_RTCP
 = 2

28 
	eiû_nomš©iÚ
 {

29 
	mICE_NOMINATION_REGULAR
 = 0,

30 
	mICE_NOMINATION_AGGRESSIVE


34 
	eiû_ÿnd_ty³
 {

35 
	mICE_CAND_TYPE_HOST
,

36 
	mICE_CAND_TYPE_SRFLX
,

37 
	mICE_CAND_TYPE_PRFLX
,

38 
	mICE_CAND_TYPE_RELAY


42 
	eiû_tıty³
 {

43 
	mICE_TCP_ACTIVE
,

44 
	mICE_TCP_PASSIVE
,

45 
	mICE_TCP_SO


49 
	eiû_ÿnd·œ_¡©e
 {

50 
	mICE_CANDPAIR_FROZEN
 = 0,

51 
	mICE_CANDPAIR_WAITING
,

52 
	mICE_CANDPAIR_INPROGRESS
,

53 
	mICE_CANDPAIR_SUCCEEDED
,

54 
	mICE_CANDPAIR_FAILED


57 
	giû
;

58 
	giû_ÿnd
;

59 
	giûm
;

60 
	gtuºc
;

63 
	siû_cÚf
 {

64 
iû_nomš©iÚ
 
	mnom
;

65 
ušt32_t
 
	m¹o
;

66 
ušt32_t
 
	mrc
;

67 
boŞ
 
	mdebug
;

70 (
	tiû_cÚnchk_h
)(
	t”r
, 
	tboŞ
 
	tupd©e
, *
	t¬g
);

74 
	`iûm_®loc
(
iûm
 **
iûmp
, 
iû_mode
 
mode
,

75 
iû_rŞe
 
rŞe
, 
´Ùo
, 
Ïy”
,

76 
ušt64_t
 
t›brk
, cÚ¡ *
luäag
, cÚ¡ *
Íwd
,

77 
iû_cÚnchk_h
 *
chkh
, *
¬g
);

78 
iû_cÚf
 *
	`iûm_cÚf
(
iûm
 *icem);

79 
iû_rŞe
 
	`iûm_loÿl_rŞe
(cÚ¡ 
iûm
 *icem);

80 
	`iûm_£t_cÚf
(
iûm
 *iûm, cÚ¡ 
iû_cÚf
 *
cÚf
);

81 
	`iûm_£t_rŞe
(
iûm
 *iûm, 
iû_rŞe
 
rŞe
);

82 
	`iûm_£t_Çme
(
iûm
 *iûm, cÚ¡ *
Çme
);

83 
	`iûm_comp_add
(
iûm
 *iûm, 
compid
, *
sock
);

84 
	`iûm_ÿnd_add
(
iûm
 *iûm, 
compid
, 
ušt16_t
 
Írio
,

85 cÚ¡ *
iâame
, cÚ¡ 
§
 *
addr
);

87 
	`iûm_l™e_£t_deçuÉ_ÿndid©es
(
iûm
 *icem);

88 
boŞ
 
	`iûm_v”ify_suµÜt
(
iûm
 *iûm, 
compid
,

89 cÚ¡ 
§
 *
¿ddr
);

90 
	`iûm_cÚncheck_¡¬t
(
iûm
 *icem);

91 
	`iûm_cÚncheck_¡İ
(
iûm
 *iûm, 
”r
);

92 
	`iûm_add_chª
(
iûm
 *iûm, 
compid
, cÚ¡ 
§
 *
¿ddr
);

93 
boŞ
 
	`iûm_mism©ch
(cÚ¡ 
iûm
 *icem);

94 
	`iûm_upd©e
(
iûm
 *icem);

95 
	`iû_sdp_decode
(
iûm
 *
iû
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

96 
	`iûm_sdp_decode
(
iûm
 *iûm, cÚ¡ *
Çme
, cÚ¡ *
v®ue
);

97 
	`iûm_debug
(
»_´štf
 *
pf
, cÚ¡ 
iûm
 *icem);

98 
li¡
 *
	`iûm_lÿndl
(cÚ¡ 
iûm
 *icem);

99 
li¡
 *
	`iûm_rÿndl
(cÚ¡ 
iûm
 *icem);

100 
li¡
 *
	`iûm_checkl
(cÚ¡ 
iûm
 *icem);

101 
li¡
 *
	`iûm_v®idl
(cÚ¡ 
iûm
 *icem);

102 cÚ¡ 
§
 *
	`iûm_ÿnd_deçuÉ
(
iûm
 *iûm, 
compid
);

103 cÚ¡ 
§
 *
	`iûm_£Ëùed_Ïddr
(cÚ¡ 
iûm
 *iûm, 
compid
);

104 cÚ¡ 
iû_ÿnd
 *
	`iûm_£Ëùed_lÿnd
(cÚ¡ 
iûm
 *icem,

105 
compid
);

106 cÚ¡ 
iû_ÿnd
 *
	`iûm_£Ëùed_rÿnd
(cÚ¡ 
iûm
 *icem,

107 
compid
);

108 
	`iû_ÿnd·œ_£t_¡©es
(
iûm
 *icem);

109 
	`iûm_ÿnd_»dund_–im
(
iûm
 *icem);

110 
	`iûm_comps_£t_deçuÉ_ÿnd
(
iûm
 *icem);

111 
¡un
 *
	`iûm_¡un
(
iûm
 *icem);

112 
	`iûm_£t_tuº_ş›Á
(
iûm
 *iûm, 
compid
,

113 
tuºc
 *turnc);

116 
boŞ
 
	`iû_»mÙeÿnds_ava
(cÚ¡ 
iûm
 *icem);

117 
	`iû_ÿnd_’code
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd
 *
ÿnd
);

118 
	`iû_»mÙeÿnds_’code
(
»_´štf
 *
pf
, cÚ¡ 
iûm
 *icem);

119 
iû_ÿnd
 *
	`iûm_ÿnd_fšd
(cÚ¡ 
li¡
 *
l¡
, 
compid
,

120 cÚ¡ 
§
 *
addr
);

121 
	`iûm_lÿnd_add
(
iûm
 *iûm, 
iû_ÿnd
 *
ba£
,

122 
iû_ÿnd_ty³
 
ty³
,

123 cÚ¡ 
§
 *
addr
);

124 
iû_ÿnd
 *
	`iûm_lÿnd_ba£
(iû_ÿnd *
lÿnd
);

125 cÚ¡ 
§
 *
	`iûm_lÿnd_addr
(cÚ¡ 
iû_ÿnd
 *
ÿnd
);

126 
iû_ÿnd_ty³
 
	`iûm_ÿnd_ty³
(cÚ¡ 
iû_ÿnd
 *
ÿnd
);

129 cÚ¡ 
iû_©Œ_ÿnd
[];

130 cÚ¡ 
iû_©Œ_l™e
[];

131 cÚ¡ 
iû_©Œ_mism©ch
[];

132 cÚ¡ 
iû_©Œ_pwd
[];

133 cÚ¡ 
iû_©Œ_»mÙe_ÿnd
[];

134 cÚ¡ 
iû_©Œ_uäag
[];

137 cÚ¡ *
	`iû_ÿnd_ty³2Çme
(
iû_ÿnd_ty³
 
ty³
);

138 
iû_ÿnd_ty³
 
	`iû_ÿnd_Çme2ty³
(cÚ¡ *
Çme
);

139 cÚ¡ *
	`iû_rŞe2Çme
(
iû_rŞe
 
rŞe
);

140 cÚ¡ *
	`iû_ÿnd·œ_¡©e2Çme
(
iû_ÿnd·œ_¡©e
 
¡
);

143 
ušt32_t
 
	`iû_ÿnd_ÿlc_´io
(
iû_ÿnd_ty³
 
ty³
, 
ušt16_t
 
loÿl
,

144 
compid
);

148 
	siû_ÿnd_©Œ
 {

149 
found©iÚ
[32];

150 
compid
;

151 
´Ùo
;

152 
ušt32_t
 
´io
;

153 
§
 
addr
;

154 
iû_ÿnd_ty³
 
ty³
;

155 
§
 
»l_addr
;

156 
iû_tıty³
 
tıty³
;

159 
	`iû_ÿnd_©Œ_’code
(
»_´štf
 *
pf
,

160 cÚ¡ 
iû_ÿnd_©Œ
 *
ÿnd
);

161 
	`iû_ÿnd_©Œ_decode
(
iû_ÿnd_©Œ
 *
ÿnd
, cÚ¡ *
v®
);

	@re-0.5.6/include/re_jbuf.h

6 
	gjbuf
;

7 
	g¹p_h—d”
;

10 
	sjbuf_¡©
 {

11 
ušt32_t
 
	mn_put
;

12 
ušt32_t
 
	mn_g‘
;

13 
ušt32_t
 
	mn_oos
;

14 
ušt32_t
 
	mn_dups
;

15 
ušt32_t
 
	mn_Ï‹
;

16 
ušt32_t
 
	mn_lo¡
;

17 
ušt32_t
 
	mn_ov”æow
;

18 
ušt32_t
 
	mn_und”æow
;

19 
ušt32_t
 
	mn_æush
;

23 
jbuf_®loc
(
jbuf
 **
jbp
, 
ušt32_t
 
mš
, ušt32_ˆ
max
);

24 
jbuf_put
(
jbuf
 *
jb
, cÚ¡ 
¹p_h—d”
 *
hdr
, *
mem
);

25 
jbuf_g‘
(
jbuf
 *
jb
, 
¹p_h—d”
 *
hdr
, **
mem
);

26 
jbuf_æush
(
jbuf
 *
jb
);

27 
jbuf_¡©s
(cÚ¡ 
jbuf
 *
jb
, 
jbuf_¡©
 *
j¡©
);

28 
jbuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
jbuf
 *
jb
);

	@re-0.5.6/include/re_json.h

7 
	ejsÚ_typ
 {

8 
	mJSON_STRING
,

9 
	mJSON_INT
,

10 
	mJSON_DOUBLE
,

11 
	mJSON_BOOL
,

12 
	mJSON_NULL
,

15 
	sjsÚ_v®ue
 {

17 *
	m¡r
;

18 
št64_t
 
	mš‹g”
;

19 
	mdbl
;

20 
boŞ
 
	mboŞ—n
;

21 } 
	mv
;

22 
jsÚ_typ
 
	mty³
;

25 
	gjsÚ_hªdËrs
;

27 (
	tjsÚ_objeù_’Œy_h
)(cÚ¡ *
	tÇme
,

28 cÚ¡ 
	tjsÚ_v®ue
 *
	tv®ue
, *
	t¬g
);

29 (
	tjsÚ_¬¿y_’Œy_h
)(
	tidx
,

30 cÚ¡ 
	tjsÚ_v®ue
 *
	tv®ue
, *
	t¬g
);

31 (
	tjsÚ_objeù_h
)(cÚ¡ *
	tÇme
, 
	tidx
,

32 
	tjsÚ_hªdËrs
 *
	th
);

33 (
	tjsÚ_¬¿y_h
)(cÚ¡ *
	tÇme
, 
	tidx
,

34 
	tjsÚ_hªdËrs
 *
	th
);

36 
	sjsÚ_hªdËrs
 {

37 
jsÚ_objeù_h
 *
oh
;

38 
jsÚ_¬¿y_h
 *
ah
;

39 
jsÚ_objeù_’Œy_h
 *
Ûh
;

40 
jsÚ_¬¿y_’Œy_h
 *
«h
;

41 *
¬g
;

44 
	`jsÚ_decode
(cÚ¡ *
¡r
, 
size_t
 
Ën
, 
maxd•th
,

45 
jsÚ_objeù_h
 *
oh
, 
jsÚ_¬¿y_h
 *
ah
,

46 
jsÚ_objeù_’Œy_h
 *
Ûh
, 
jsÚ_¬¿y_’Œy_h
 *
«h
, *
¬g
);

48 
	`jsÚ_decode_odiù
(
odiù
 **
İ
, 
ušt32_t
 
hash_size
, cÚ¡ *
¡r
,

49 
size_t
 
Ën
, 
maxd•th
);

50 
	`jsÚ_’code_odiù
(
»_´štf
 *
pf
, cÚ¡ 
odiù
 *
o
);

	@re-0.5.6/include/re_list.h

9 
	sË
 {

10 
Ë
 *
	m´ev
;

11 
Ë
 *
	mÃxt
;

12 
li¡
 *
	mli¡
;

13 *
	md©a
;

17 
	#LE_INIT
 {
NULL
, NULL, NULL, NULL}

	)

21 
	sli¡
 {

22 
Ë
 *
	mh—d
;

23 
Ë
 *
	m
;

27 
	#LIST_INIT
 {
NULL
, NULL}

	)

38 
	$boŞ
 (
	tli¡_­¶y_h
)(
	tË
 *Ë, *
	t¬g
);

49 
	$boŞ
 (
	tli¡_sÜt_h
)(
	tË
 *
	tË1
, Ë *
	tË2
, *
	t¬g
);

52 
	`li¡_š™
(
li¡
 *list);

53 
	`li¡_æush
(
li¡
 *list);

54 
	`li¡_ş—r
(
li¡
 *list);

55 
	`li¡_­³nd
(
li¡
 *li¡, 
Ë
 *Ë, *
d©a
);

56 
	`li¡_´•’d
(
li¡
 *li¡, 
Ë
 *Ë, *
d©a
);

57 
	`li¡_š£¹_befÜe
(
li¡
 *li¡, 
Ë
 *Ë, Ë *
e
,

58 *
d©a
);

59 
	`li¡_š£¹_aá”
(
li¡
 *li¡, 
Ë
 *Ë, Ë *
e
,

60 *
d©a
);

61 
	`li¡_uÆšk
(
Ë
 *le);

62 
	`li¡_sÜt
(
li¡
 *li¡, 
li¡_sÜt_h
 *
sh
, *
¬g
);

63 
Ë
 *
	`li¡_­¶y
(cÚ¡ 
li¡
 *li¡, 
boŞ
 
fwd
, 
li¡_­¶y_h
 *
ah
,

64 *
¬g
);

65 
Ë
 *
	`li¡_h—d
(cÚ¡ 
li¡
 *list);

66 
Ë
 *
	`li¡_
(cÚ¡ 
li¡
 *list);

67 
ušt32_t
 
	`li¡_couÁ
(cÚ¡ 
li¡
 *list);

77 
šlše
 *
	$li¡_Ëd©a
(cÚ¡ 
Ë
 *le)

79  
Ë
 ?†e->
d©a
 : 
NULL
;

80 
	}
}

83 
šlše
 
boŞ
 
	$li¡_cÚšs
(cÚ¡ 
li¡
 *li¡, cÚ¡ 
Ë
 *le)

85  
Ë
 ?†e->
li¡
 =ğli¡ : 
çl£
;

86 
	}
}

89 
šlše
 
boŞ
 
	$li¡_i£m±y
(cÚ¡ 
li¡
 *list)

91  
li¡
 ?†i¡->
h—d
 =ğ
NULL
 : 
Œue
;

92 
	}
}

95 
	#LIST_FOREACH
(
li¡
, 
Ë
) \

96 (
Ë
èğ
	`li¡_h—d
((
li¡
)); (Ë); (ËèğÖe)->
Ãxt
)

	)

	@re-0.5.6/include/re_lock.h

8 
	glock
;

10 
lock_®loc
(
lock
 **
Í
);

12 
lock_»ad_g‘
(
lock
 *
l
);

13 
lock_wr™e_g‘
(
lock
 *
l
);

15 
lock_»ad_Œy
(
lock
 *
l
);

16 
lock_wr™e_Œy
(
lock
 *
l
);

18 
lock_»l
(
lock
 *
l
);

	@re-0.5.6/include/re_main.h

9 #iâdeà
FD_READ


10 
	mFD_READ
 = 1<<0,

12 #iâdeà
FD_WRITE


13 
	mFD_WRITE
 = 1<<1,

15 
	mFD_EXCEPT
 = 1<<2

25 (
	tfd_h
)(
	tæags
, *
	t¬g
);

32 (
	t»_sigÇl_h
)(
	tsig
);

35 
	`fd_li¡’
(
fd
, 
æags
, 
fd_h
 *
fh
, *
¬g
);

36 
	`fd_şo£
(
fd
);

37 
	`fd_£tsize
(
maxfds
);

38 
	`fd_debug
();

40 
	`lib»_š™
();

41 
	`lib»_şo£
();

43 
	`»_maš
(
»_sigÇl_h
 *
sigÇlh
);

44 
	`»_ÿnûl
();

45 
	`»_debug
(
»_´štf
 *
pf
, *
unu£d
);

47 
	`»_th»ad_š™
();

48 
	`»_th»ad_şo£
();

49 
	`»_th»ad_’‹r
();

50 
	`»_th»ad_Ëave
();

52 
	`»_£t_mu‹x
(*
mu‹xp
);

56 
	epŞl_m‘hod
 {

57 
METHOD_NULL
 = 0,

58 
METHOD_POLL
,

59 
METHOD_SELECT
,

60 
METHOD_EPOLL
,

61 
METHOD_KQUEUE
,

63 
METHOD_MAX


66 
	`pŞl_m‘hod_£t
(
pŞl_m‘hod
 
m‘hod
);

67 
pŞl_m‘hod
 
	`pŞl_m‘hod_be¡
();

68 cÚ¡ *
	`pŞl_m‘hod_Çme
(
pŞl_m‘hod
 
m‘hod
);

69 
	`pŞl_m‘hod_ty³
(
pŞl_m‘hod
 *
m‘hod
, cÚ¡ 
¶
 *
Çme
);

	@re-0.5.6/include/re_mbuf.h

8 
	~<¡d¬g.h
>

11 #iâdeà
RELEASE


12 
	#MBUF_DEBUG
 1

	)

15 #ià
MBUF_DEBUG


17 
	#MBUF_CHECK_POS
(
mb
) \

18 ià((
mb
è&& (mb)->
pos
 > (mb)->
’d
) { \

19 
BREAKPOINT
; \

20 }

	)

22 
	#MBUF_CHECK_END
(
mb
) \

23 ià((
mb
è&& (mb)->
’d
 > (mb)->
size
) { \

24 
BREAKPOINT
; \

25 }

	)

27 
	#MBUF_CHECK_POS
(
mb
)

	)

28 
	#MBUF_CHECK_END
(
mb
)

	)

32 
	smbuf
 {

33 
ušt8_t
 *
	mbuf
;

34 
size_t
 
	msize
;

35 
size_t
 
	mpos
;

36 
size_t
 
	m’d
;

40 
	g¶
;

41 
	g»_´štf
;

43 
mbuf
 *
mbuf_®loc
(
size_t
 
size
);

44 
mbuf
 *
mbuf_®loc_»f
(mbuà*
mbr
);

45 
mbuf_š™
(
mbuf
 *
mb
);

46 
mbuf_»£t
(
mbuf
 *
mb
);

47 
mbuf_»size
(
mbuf
 *
mb
, 
size_t
 
size
);

48 
mbuf_Œim
(
mbuf
 *
mb
);

49 
mbuf_shiá
(
mbuf
 *
mb
, 
ssize_t
 
shiá
);

50 
mbuf_wr™e_mem
(
mbuf
 *
mb
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
size
);

51 
mbuf_wr™e_u8
(
mbuf
 *
mb
, 
ušt8_t
 
v
);

52 
mbuf_wr™e_u16
(
mbuf
 *
mb
, 
ušt16_t
 
v
);

53 
mbuf_wr™e_u32
(
mbuf
 *
mb
, 
ušt32_t
 
v
);

54 
mbuf_wr™e_u64
(
mbuf
 *
mb
, 
ušt64_t
 
v
);

55 
mbuf_wr™e_¡r
(
mbuf
 *
mb
, cÚ¡ *
¡r
);

56 
mbuf_wr™e_¶
(
mbuf
 *
mb
, cÚ¡ 
¶
 *pl);

57 
mbuf_»ad_mem
(
mbuf
 *
mb
, 
ušt8_t
 *
buf
, 
size_t
 
size
);

58 
ušt8_t
 
mbuf_»ad_u8
(
mbuf
 *
mb
);

59 
ušt16_t
 
mbuf_»ad_u16
(
mbuf
 *
mb
);

60 
ušt32_t
 
mbuf_»ad_u32
(
mbuf
 *
mb
);

61 
ušt64_t
 
mbuf_»ad_u64
(
mbuf
 *
mb
);

62 
mbuf_»ad_¡r
(
mbuf
 *
mb
, *
¡r
, 
size_t
 
size
);

63 
mbuf_¡rdup
(
mbuf
 *
mb
, **
¡½
, 
size_t
 
Ën
);

64 
mbuf_v´štf
(
mbuf
 *
mb
, cÚ¡ *
fmt
, 
va_li¡
 
­
);

65 
mbuf_´štf
(
mbuf
 *
mb
, cÚ¡ *
fmt
, ...);

66 
mbuf_wr™e_¶_sk
(
mbuf
 *
mb
, cÚ¡ 
¶
 *pl,

67 cÚ¡ 
¶
 *
sk
);

68 
mbuf_fl
(
mbuf
 *
mb
, 
ušt8_t
 
c
, 
size_t
 
n
);

69 
mbuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
mbuf
 *
mb
);

79 
šlše
 
ušt8_t
 *
	$mbuf_buf
(cÚ¡ 
mbuf
 *
mb
)

81  
mb
 ? mb->
buf
 + mb->
pos
 : (
ušt8_t
 *)
NULL
;

82 
	}
}

92 
šlše
 
size_t
 
	$mbuf_g‘_Ëá
(cÚ¡ 
mbuf
 *
mb
)

94  (
mb
 && (mb->
’d
 > mb->
pos
)) ? (mb->end - mb->pos) : 0;

95 
	}
}

105 
šlše
 
size_t
 
	$mbuf_g‘_¥aû
(cÚ¡ 
mbuf
 *
mb
)

107  (
mb
 && (mb->
size
 > mb->
pos
)) ? (mb->size - mb->pos) : 0;

108 
	}
}

117 
šlše
 
	$mbuf_£t_pos
(
mbuf
 *
mb
, 
size_t
 
pos
)

119 
mb
->
pos
 =…os;

120 
	`MBUF_CHECK_POS
(
mb
);

121 
	}
}

130 
šlše
 
	$mbuf_£t_’d
(
mbuf
 *
mb
, 
size_t
 
’d
)

132 
mb
->
’d
 =ƒnd;

133 
	`MBUF_CHECK_END
(
mb
);

134 
	}
}

143 
šlše
 
	$mbuf_advªû
(
mbuf
 *
mb
, 
ssize_t
 
n
)

145 
mb
->
pos
 +ğ
n
;

146 
	`MBUF_CHECK_POS
(
mb
);

147 
	}
}

155 
šlše
 
	$mbuf_»wšd
(
mbuf
 *
mb
)

157 
mb
->
pos
 = mb->
’d
 = 0;

158 
	}
}

166 
šlše
 
	$mbuf_sk_to_’d
(
mbuf
 *
mb
)

168 
mb
->
pos
 = mb->
’d
;

169 
	}
}

	@re-0.5.6/include/re_md5.h

10 
	mMD5_SIZE
 = 16,

11 
	mMD5_STR_SIZE
 = 2*
MD5_SIZE
 + 1

14 
md5
(cÚ¡ 
ušt8_t
 *
d
, 
size_t
 
n
, ušt8_ˆ*
md
);

15 
md5_´štf
(
ušt8_t
 *
md
, cÚ¡ *
fmt
, ...);

	@re-0.5.6/include/re_mem.h

14 (
	tmem_de¡roy_h
)(*
	td©a
);

17 
	smem¡©
 {

18 
size_t
 
by‹s_cur
;

19 
size_t
 
by‹s_³ak
;

20 
size_t
 
blocks_cur
;

21 
size_t
 
blocks_³ak
;

22 
size_t
 
size_mš
;

23 
size_t
 
size_max
;

26 *
	`mem_®loc
(
size_t
 
size
, 
mem_de¡roy_h
 *
dh
);

27 *
	`mem_z®loc
(
size_t
 
size
, 
mem_de¡roy_h
 *
dh
);

28 *
	`mem_»®loc
(*
d©a
, 
size_t
 
size
);

29 *
	`mem_»®loÿ¼ay
(*
±r
, 
size_t
 
nmemb
,

30 
size_t
 
membsize
, 
mem_de¡roy_h
 *
dh
);

31 *
	`mem_»f
(*
d©a
);

32 *
	`mem_d”ef
(*
d©a
);

33 
ušt32_t
 
	`mem_Äefs
(cÚ¡ *
d©a
);

35 
	`mem_debug
();

36 
	`mem_th»shŞd_£t
(
ssize_t
 
n
);

37 
»_´štf
;

38 
	`mem_¡©us
(
»_´štf
 *
pf
, *
unu£d
);

39 
	`mem_g‘_¡©
(
mem¡©
 *
m¡©
);

	@re-0.5.6/include/re_mod.h

17 #ià
defšed
 (
WIN32
)

18 
	#MOD_PRE
 ""

	)

19 
	#MOD_EXT
 ".dÎ"

	)

21 
	#MOD_PRE
 ""

	)

22 
	#MOD_EXT
 ".so"

	)

27 #ifdeà
WIN32


28 
	#EXPORT_SYM
 
	`__deş¥ec
(
dÎexpÜt
)

	)

30 
	#EXPORT_SYM


	)

42 (
	tmod_š™_h
)();

49 (
	tmod_şo£_h
)();

52 
mod
;

53 
»_´štf
;

57 
	smod_expÜt
 {

58 cÚ¡ *
Çme
;

59 cÚ¡ *
ty³
;

60 
mod_š™_h
 *
š™
;

61 
mod_şo£_h
 *
şo£
;

67 
	`mod_š™
();

68 
	`mod_şo£
();

70 
	`mod_lßd
(
mod
 **
mp
, cÚ¡ *
Çme
);

71 
	`mod_add
(
mod
 **
mp
, cÚ¡ 
mod_expÜt
 *
me
);

72 
mod
 *
	`mod_fšd
(cÚ¡ *
Çme
);

73 cÚ¡ 
mod_expÜt
 *
	`mod_expÜt
(cÚ¡ 
mod
 *
m
);

74 
li¡
 *
	`mod_li¡
();

75 
	`mod_debug
(
»_´štf
 *
pf
, *
unu£d
);

	@re-0.5.6/include/re_mqueue.h

7 
	gmqueue
;

9 (
	tmqueue_h
)(
	tid
, *
	td©a
, *
	t¬g
);

11 
	`mqueue_®loc
(
mqueue
 **
mqp
, 
mqueue_h
 *
h
, *
¬g
);

12 
	`mqueue_push
(
mqueue
 *
mq
, 
id
, *
d©a
);

	@re-0.5.6/include/re_msg.h

9 
	smsg_ùy³
 {

10 
¶
 
	mty³
;

11 
¶
 
	msubty³
;

12 
¶
 
	m·¿ms
;

16 
msg_ùy³_decode
(
msg_ùy³
 *
ùy³
, cÚ¡ 
¶
 *pl);

17 
boŞ
 
msg_ùy³_cmp
(cÚ¡ 
msg_ùy³
 *
ùy³
,

18 cÚ¡ *
ty³
, cÚ¡ *
subty³
);

20 
msg_·¿m_decode
(cÚ¡ 
¶
 *¶, cÚ¡ *
Çme
, ¶ *
v®
);

21 
msg_·¿m_exi¡s
(cÚ¡ 
¶
 *¶, cÚ¡ *
Çme
, ¶ *
’d
);

	@re-0.5.6/include/re_natbd.h

9 
	eÇt_ty³
 {

10 
	mNAT_TYPE_UNKNOWN
 = 0,

11 
	mNAT_TYPE_ENDP_INDEP
 = 1,

12 
	mNAT_TYPE_ADDR_DEP
 = 2,

13 
	mNAT_TYPE_ADDR_PORT_DEP
 = 3

18 cÚ¡ *
Çt_ty³_¡r
(
Çt_ty³
 
ty³
);

24 
	gÇt_haœpšnšg
;

28 (
	tÇt_haœpšnšg_h
)(
	t”r
, 
	tboŞ
 
	tsuµÜ‹d
, *
	t¬g
);

30 
	`Çt_haœpšnšg_®loc
(
Çt_haœpšnšg
 **
nhp
,

31 cÚ¡ 
§
 *
¤v
, 
´Ùo
,

32 cÚ¡ 
¡un_cÚf
 *
cÚf
,

33 
Çt_haœpšnšg_h
 *
hph
, *
¬g
);

34 
	`Çt_haœpšnšg_¡¬t
(
Çt_haœpšnšg
 *
nh
);

40 
Çt_m­pšg
;

49 (
	tÇt_m­pšg_h
)(
	t”r
, 
	tÇt_ty³
 
	tm­
, *
	t¬g
);

51 
	`Çt_m­pšg_®loc
(
Çt_m­pšg
 **
nmp
, cÚ¡ 
§
 *
Ïddr
,

52 cÚ¡ 
§
 *
¤v
, 
´Ùo
,

53 cÚ¡ 
¡un_cÚf
 *
cÚf
,

54 
Çt_m­pšg_h
 *
mh
, *
¬g
);

55 
	`Çt_m­pšg_¡¬t
(
Çt_m­pšg
 *
nm
);

61 
Çt_f‹ršg
;

70 (
	tÇt_f‹ršg_h
)(
	t”r
, 
	tÇt_ty³
 
	tft
, *
	t¬g
);

72 
	`Çt_f‹ršg_®loc
(
Çt_f‹ršg
 **
nå
, cÚ¡ 
§
 *
¤v
,

73 cÚ¡ 
¡un_cÚf
 *
cÚf
,

74 
Çt_f‹ršg_h
 *
fh
, *
¬g
);

75 
	`Çt_f‹ršg_¡¬t
(
Çt_f‹ršg
 *
nf
);

82 
Çt_liãtime
;

85 
	sÇt_liãtime_š‹rv®
 {

86 
ušt32_t
 
mš
;

87 
ušt32_t
 
cur
;

88 
ušt32_t
 
max
;

99 (
	tÇt_liãtime_h
)(
	t”r
, cÚ¡ 
	tÇt_liãtime_š‹rv®
 *
	ti
,

100 *
	t¬g
);

102 
	`Çt_liãtime_®loc
(
Çt_liãtime
 **
Æp
, cÚ¡ 
§
 *
¤v
,

103 
ušt32_t
 
š‹rv®
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

104 
Çt_liãtime_h
 *
lh
, *
¬g
);

105 
	`Çt_liãtime_¡¬t
(
Çt_liãtime
 *
Æ
);

111 
Çt_g’®g
;

122 (
	tÇt_g’®g_h
)(
	t”r
, 
	tušt16_t
 
	tscode
, cÚ¡ *
	t»asÚ
,

123 
	t¡©us
, cÚ¡ 
	t§
 *
	tm­
, *
	t¬g
);

125 
	`Çt_g’®g_®loc
(
Çt_g’®g
 **
ngp
, cÚ¡ 
§
 *
¤v
, 
´Ùo
,

126 cÚ¡ 
¡un_cÚf
 *
cÚf
,

127 
Çt_g’®g_h
 *
gh
, *
¬g
);

128 
	`Çt_g’®g_¡¬t
(
Çt_g’®g
 *
ng
);

	@re-0.5.6/include/re_net.h

6 #ifdeà
CYGWIN


7 
	~<ws2tı.h
>

8 
	~<wšsock2.h
>

9 #–ià
defšed
(
WIN32
)

10 
	~<wšsock2.h
>

11 
	~<ws2tı.h
>

13 
	~<sys/ty³s.h
>

14 #iâdeà
_BSD_SOCKLEN_T_


15 
	#_BSD_SOCKLEN_T_
 

	)

17 
	~<sys/sock‘.h
>

18 
	~<Ãtš‘/š.h
>

19 
	~<¬·/š‘.h
>

23 #iâdeà
HAVE_GAI_STRERROR


25 #iâdeà
gai_¡»¼Ü


26 
	#gai_¡»¼Ü
(
”r
è"?"

	)

31 #iâdeà
INET_ADDRSTRLEN


32 
	#INET_ADDRSTRLEN
 16

	)

36 #iâdeà
INET6_ADDRSTRLEN


37 
	#INET6_ADDRSTRLEN
 46

	)

41 #ifdeà
HAVE_INET6


42 
	#NET_ADDRSTRLEN
 
INET6_ADDRSTRLEN


	)

44 
	#NET_ADDRSTRLEN
 
INET_ADDRSTRLEN


	)

48 
	g§
;

52 
Ãt_ho¡addr
(
af
, 
§
 *

);

53 
Ãt_deçuÉ_sourû_addr_g‘
(
af
, 
§
 *

);

54 
Ãt_deçuÉ_g©eway_g‘
(
af
, 
§
 *
gw
);

58 
Ãt_sock_š™
();

59 
Ãt_sock_şo£
();

63 
Ãt_sockİt_blockšg_£t
(
fd
, 
boŞ
 
blockšg
);

64 
Ãt_sockİt_»u£_£t
(
fd
, 
boŞ
 
»u£
);

78 
	$boŞ
 (
	tÃt_içddr_h
)(cÚ¡ *
	tiâame
, cÚ¡ 
	t§
 *sa,

79 *
	t¬g
);

81 
	`Ãt_if_g‘Çme
(*
iâame
, 
size_t
 
sz
, 
af
, cÚ¡ 
§
 *

);

82 
	`Ãt_if_g‘addr
(cÚ¡ *
iâame
, 
af
, 
§
 *

);

83 
	`Ãt_if_g‘addr4
(cÚ¡ *
iâame
, 
af
, 
§
 *

);

84 
	`Ãt_if_li¡
(
Ãt_içddr_h
 *
ifh
, *
¬g
);

85 
	`Ãt_if_­¶y
(
Ãt_içddr_h
 *
ifh
, *
¬g
);

86 
	`Ãt_if_debug
(
»_´štf
 *
pf
, *
unu£d
);

87 
	`Ãt_if_g‘lškloÿl
(cÚ¡ *
iâame
, 
af
, 
§
 *

);

91 
	`Ãt_g‘içddrs
(
Ãt_içddr_h
 *
ifh
, *
¬g
);

107 
	$boŞ
 (
	tÃt_¹_h
)(cÚ¡ *
	tiâame
, cÚ¡ 
	t§
 *
	td¡
,

108 
	td¡Ën
, cÚ¡ 
	t§
 *
	tgw
, *
	t¬g
);

110 
	`Ãt_¹_li¡
(
Ãt_¹_h
 *
¹h
, *
¬g
);

111 
	`Ãt_¹_deçuÉ_g‘
(
af
, *
iâame
, 
size_t
 
size
);

112 
	`Ãt_¹_debug
(
»_´štf
 *
pf
, *
unu£d
);

123 (
	tÃt_cÚn_h
)(
	t”r
, 
	tušt32_t
 
	tid
);

125 
	`Ãt_cÚn_¡¬t
(
Ãt_cÚn_h
 *
ch
, 
ušt32_t
 
id
, 
boŞ
 
´om±
);

126 
	`Ãt_cÚn_¡İ
();

130 cÚ¡ *
	`Ãt_´Ùo2Çme
(
´Ùo
);

131 cÚ¡ *
	`Ãt_af2Çme
(
af
);

	@re-0.5.6/include/re_odict.h

7 
	eodiù_ty³
 {

8 
	mODICT_OBJECT
,

9 
	mODICT_ARRAY
,

10 
	mODICT_STRING
,

11 
	mODICT_INT
,

12 
	mODICT_DOUBLE
,

13 
	mODICT_BOOL
,

14 
	mODICT_NULL
,

17 
	sodiù
 {

18 
li¡
 
	ml¡
;

19 
hash
 *
	mht
;

22 
	sodiù_’Œy
 {

23 
Ë
 
	mË
, 
	mhe
;

24 *
	mkey
;

26 
odiù
 *
	modiù
;

27 *
	m¡r
;

28 
št64_t
 
	mš‹g”
;

29 
	mdbl
;

30 
boŞ
 
	mboŞ—n
;

31 } 
	mu
;

32 
odiù_ty³
 
	mty³
;

35 
odiù_®loc
(
odiù
 **
İ
, 
ušt32_t
 
hash_size
);

36 cÚ¡ 
odiù_’Œy
 *
odiù_lookup
(cÚ¡ 
odiù
 *
o
, cÚ¡ *
key
);

37 
size_t
 
odiù_couÁ
(cÚ¡ 
odiù
 *
o
, 
boŞ
 
Ã¡ed
);

38 
odiù_debug
(
»_´štf
 *
pf
, cÚ¡ 
odiù
 *
o
);

40 
odiù_’Œy_add
(
odiù
 *
o
, cÚ¡ *
key
,

41 
ty³
, ...);

42 
odiù_’Œy_d–
(
odiù
 *
o
, cÚ¡ *
key
);

43 
odiù_’Œy_debug
(
»_´štf
 *
pf
, cÚ¡ 
odiù_’Œy
 *
e
);

45 
boŞ
 
odiù_ty³_iscÚš”
(
odiù_ty³
 
ty³
);

46 
boŞ
 
odiù_ty³_i¤—l
(
odiù_ty³
 
ty³
);

47 cÚ¡ *
odiù_ty³_Çme
(
odiù_ty³
 
ty³
);

	@re-0.5.6/include/re_rtp.h

10 
	mRTP_VERSION
 = 2,

11 
	mRTCP_VERSION
 = 2,

12 
	mRTP_HEADER_SIZE
 = 12

17 
	s¹p_h—d”
 {

18 
ušt8_t
 
	mv”
;

19 
boŞ
 
	m·d
;

20 
boŞ
 
	mext
;

21 
ušt8_t
 
	mcc
;

22 
boŞ
 
	mm
;

23 
ušt8_t
 
	m±
;

24 
ušt16_t
 
	m£q
;

25 
ušt32_t
 
	mts
;

26 
ušt32_t
 
	ms¤c
;

27 
ušt32_t
 
	mc¤c
[16];

29 
ušt16_t
 
	mty³
;

30 
ušt16_t
 
	mËn
;

31 } 
	mx
;

35 
	e¹ı_ty³
 {

36 
	mRTCP_FIR
 = 192,

37 
	mRTCP_NACK
 = 193,

38 
	mRTCP_SR
 = 200,

39 
	mRTCP_RR
 = 201,

40 
	mRTCP_SDES
 = 202,

41 
	mRTCP_BYE
 = 203,

42 
	mRTCP_APP
 = 204,

43 
	mRTCP_RTPFB
 = 205,

44 
	mRTCP_PSFB
 = 206,

45 
	mRTCP_XR
 = 207,

46 
	mRTCP_AVB
 = 208,

50 
	e¹ı_sdes_ty³
 {

51 
	mRTCP_SDES_END
 = 0,

52 
	mRTCP_SDES_CNAME
 = 1,

53 
	mRTCP_SDES_NAME
 = 2,

54 
	mRTCP_SDES_EMAIL
 = 3,

55 
	mRTCP_SDES_PHONE
 = 4,

56 
	mRTCP_SDES_LOC
 = 5,

57 
	mRTCP_SDES_TOOL
 = 6,

58 
	mRTCP_SDES_NOTE
 = 7,

59 
	mRTCP_SDES_PRIV
 = 8

63 
	e¹ı_¹pfb
 {

64 
	mRTCP_RTPFB_GNACK
 = 1

68 
	e¹ı_psfb
 {

69 
	mRTCP_PSFB_PLI
 = 1,

70 
	mRTCP_PSFB_SLI
 = 2,

71 
	mRTCP_PSFB_AFB
 = 15,

75 
	s¹ı_¼
 {

76 
ušt32_t
 
	ms¤c
;

77 
	mäaùiÚ
:8;

78 
	mlo¡
:24;

79 
ušt32_t
 
	mÏ¡_£q
;

80 
ušt32_t
 
	mj™‹r
;

81 
ušt32_t
 
	ml¤
;

82 
ušt32_t
 
	mdl¤
;

86 
	s¹ı_sdes_™em
 {

87 
¹ı_sdes_ty³
 
	mty³
;

88 
ušt8_t
 
	mËngth
;

89 *
	md©a
;

93 
	s¹ı_msg
 {

95 
	s¹ı_hdr
 {

96 
	mv”siÚ
:2;

97 
	mp
:1;

98 
	mcouÁ
:5;

99 
	m±
:8;

100 
ušt16_t
 
	mËngth
;

101 } 
	mhdr
;

105 
ušt32_t
 
	ms¤c
;

106 
ušt32_t
 
	mÁp_£c
;

107 
ušt32_t
 
	mÁp_äac
;

108 
ušt32_t
 
	m¹p_ts
;

109 
ušt32_t
 
	mp£Á
;

110 
ušt32_t
 
	mo£Á
;

111 
¹ı_¼
 *
	m¼v
;

112 } 
	m¤
;

116 
ušt32_t
 
	ms¤c
;

117 
¹ı_¼
 *
	m¼v
;

118 } 
	m¼
;

121 
	s¹ı_sdes
 {

122 
ušt32_t
 
	m¤c
;

123 
¹ı_sdes_™em
 *
	m™emv
;

124 
ušt32_t
 
	mn
;

125 } *
	msdesv
;

129 
ušt32_t
 *
	m¤cv
;

130 *
	m»asÚ
;

131 } 
	mbye
;

135 
ušt32_t
 
	m¤c
;

136 
	mÇme
[4];

137 
ušt8_t
 *
	md©a
;

138 
size_t
 
	md©a_Ën
;

139 } 
	m­p
;

143 
ušt32_t
 
	ms¤c
;

144 } 
	mfœ
;

148 
ušt32_t
 
	ms¤c
;

149 
ušt16_t
 
	mf¢
;

150 
ušt16_t
 
	mbÍ
;

151 } 
	mÇck
;

155 
ušt32_t
 
	ms¤c_·ck‘
;

156 
ušt32_t
 
	ms¤c_medŸ
;

157 
ušt32_t
 
	mn
;

160 
	sgÇck
 {

161 
ušt16_t
 
	mpid
;

162 
ušt16_t
 
	mbÍ
;

163 } *
	mgÇckv
;

164 
	s¦i
 {

165 
ušt16_t
 
	mfœ¡
;

166 
ušt16_t
 
	mnumb”
;

167 
ušt8_t
 
	mpicid
;

168 } *
	m¦iv
;

169 
mbuf
 *
	mafb
;

170 *
	mp
;

171 } 
	mfci
;

172 } 
	mfb
;

173 } 
	mr
;

177 
	s¹ı_¡©s
 {

179 
ušt32_t
 
	m£Á
;

180 
	mlo¡
;

181 
ušt32_t
 
	mj™
;

182 } 
	mtx
;

184 
ušt32_t
 
	m£Á
;

185 
	mlo¡
;

186 
ušt32_t
 
	mj™
;

187 } 
	mrx
;

188 
ušt32_t
 
	m¹t
;

191 
	g§
;

192 
	g»_´štf
;

193 
	g¹p_sock
;

195 (
	t¹p_»cv_h
)(cÚ¡ 
	t§
 *
	t¤c
, cÚ¡ 
	t¹p_h—d”
 *
	thdr
,

196 
	tmbuf
 *
	tmb
, *
	t¬g
);

197 (
	t¹ı_»cv_h
)(cÚ¡ 
	t§
 *
	t¤c
, 
	t¹ı_msg
 *
	tmsg
,

198 *
	t¬g
);

201 
	`¹p_®loc
(
¹p_sock
 **
r¥
);

202 
	`¹p_li¡’
(
¹p_sock
 **
r¥
, 
´Ùo
, cÚ¡ 
§
 *

,

203 
ušt16_t
 
mš_pÜt
, ušt16_ˆ
max_pÜt
, 
boŞ
 
’abË_¹ı
,

204 
¹p_»cv_h
 *
»cvh
, 
¹ı_»cv_h
 *
¹ıh
, *
¬g
);

205 
	`¹p_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
¹p_h—d”
 *
hdr
);

206 
	`¹p_hdr_decode
(
¹p_h—d”
 *
hdr
, 
mbuf
 *
mb
);

207 
	`¹p_’code
(
¹p_sock
 *
rs
, 
boŞ
 
ext
, boŞ 
m¬k”
, 
ušt8_t
 
±
,

208 
ušt32_t
 
ts
, 
mbuf
 *
mb
);

209 
	`¹p_decode
(
¹p_sock
 *
rs
, 
mbuf
 *
mb
, 
¹p_h—d”
 *
hdr
);

210 
	`¹p_£nd
(
¹p_sock
 *
rs
, cÚ¡ 
§
 *
d¡
, 
boŞ
 
ext
,

211 
boŞ
 
m¬k”
, 
ušt8_t
 
±
, 
ušt32_t
 
ts
, 
mbuf
 *
mb
);

212 
	`¹p_debug
(
»_´štf
 *
pf
, cÚ¡ 
¹p_sock
 *
rs
);

213 *
	`¹p_sock
(cÚ¡ 
¹p_sock
 *
rs
);

214 
ušt32_t
 
	`¹p_£ss_s¤c
(cÚ¡ 
¹p_sock
 *
rs
);

215 cÚ¡ 
§
 *
	`¹p_loÿl
(cÚ¡ 
¹p_sock
 *
rs
);

218 
	`¹ı_¡¬t
(
¹p_sock
 *
rs
, cÚ¡ *
úame
,

219 cÚ¡ 
§
 *
³”
);

220 
	`¹ı_’abË_mux
(
¹p_sock
 *
rs
, 
boŞ
 
’abËd
);

221 
	`¹ı_£t_¤©e
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤_tx
, ušt32_ˆ
¤_rx
);

222 
	`¹ı_£t_¤©e_tx
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤©e_tx
);

223 
	`¹ı_£t_¤©e_rx
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤©e_rx
);

224 
	`¹ı_£nd_­p
(
¹p_sock
 *
rs
, cÚ¡ 
Çme
[4],

225 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
);

226 
	`¹ı_£nd_fœ
(
¹p_sock
 *
rs
, 
ušt32_t
 
s¤c
);

227 
	`¹ı_£nd_Çck
(
¹p_sock
 *
rs
, 
ušt16_t
 
f¢
, ušt16_ˆ
bÍ
);

228 
	`¹ı_£nd_¶i
(
¹p_sock
 *
rs
, 
ušt32_t
 
fb_s¤c
);

229 
	`¹ı_debug
(
»_´štf
 *
pf
, cÚ¡ 
¹p_sock
 *
rs
);

230 *
	`¹ı_sock
(cÚ¡ 
¹p_sock
 *
rs
);

231 
	`¹ı_¡©s
(
¹p_sock
 *
rs
, 
ušt32_t
 
s¤c
, 
¹ı_¡©s
 *
¡©s
);

234 
	`¹ı_’code
(
mbuf
 *
mb
, 
¹ı_ty³
 
ty³
, 
ušt32_t
 
couÁ
, ...);

235 
	`¹ı_decode
(
¹ı_msg
 **
msgp
, 
mbuf
 *
mb
);

236 
	`¹ı_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
¹ı_msg
 *
msg
);

237 
	`¹ı_sdes_’code
(
mbuf
 *
mb
, 
ušt32_t
 
¤c
, ušt32_ˆ
™emc
, ...);

238 cÚ¡ *
	`¹ı_ty³_Çme
(
¹ı_ty³
 
ty³
);

239 cÚ¡ *
	`¹ı_sdes_Çme
(
¹ı_sdes_ty³
 
sdes
);

	@re-0.5.6/include/re_sa.h

6 #ià
defšed
(
WIN32
)

7 
	~<wšsock2.h
>

8 
	~<ws2tı.h
>

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<Ãtš‘/š.h
>

16 
	g¶
;

19 
	e§_æag
 {

20 
	mSA_ADDR
 = 1<<0,

21 
	mSA_PORT
 = 1<<1,

22 
	mSA_ALL
 = 
SA_ADDR
 | 
SA_PORT


26 
	s§
 {

28 
sockaddr
 
	m§
;

29 
sockaddr_š
 
	mš
;

30 #ifdeà
HAVE_INET6


31 
sockaddr_š6
 
	mš6
;

33 
ušt8_t
 
	m·ddšg
[28];

34 } 
	mu
;

35 
sockËn_t
 
	mËn
;

38 
§_š™
(
§
 *§, 
af
);

39 
§_£t
(
§
 *§, cÚ¡ 
¶
 *
addr
, 
ušt16_t
 
pÜt
);

40 
§_£t_¡r
(
§
 *§, cÚ¡ *
addr
, 
ušt16_t
 
pÜt
);

41 
§_£t_š
(
§
 *§, 
ušt32_t
 
addr
, 
ušt16_t
 
pÜt
);

42 
§_£t_š6
(
§
 *§, cÚ¡ 
ušt8_t
 *
addr
, 
ušt16_t
 
pÜt
);

43 
§_£t_§
(
§
 *§, cÚ¡ 
sockaddr
 *
s
);

44 
§_£t_pÜt
(
§
 *§, 
ušt16_t
 
pÜt
);

45 
§_decode
(
§
 *§, cÚ¡ *
¡r
, 
size_t
 
Ën
);

47 
§_af
(cÚ¡ 
§
 *sa);

48 
ušt32_t
 
§_š
(cÚ¡ 
§
 *sa);

49 
§_š6
(cÚ¡ 
§
 *§, 
ušt8_t
 *
addr
);

50 
§_Áİ
(cÚ¡ 
§
 *§, *
buf
, 
size
);

51 
ušt16_t
 
§_pÜt
(cÚ¡ 
§
 *sa);

52 
boŞ
 
§_is£t
(cÚ¡ 
§
 *§, 
æag
);

53 
ušt32_t
 
§_hash
(cÚ¡ 
§
 *§, 
æag
);

55 
§_ıy
(
§
 *
d¡
, cÚ¡ § *
¤c
);

56 
boŞ
 
§_cmp
(cÚ¡ 
§
 *
l
, cÚ¡ § *
r
, 
æag
);

58 
boŞ
 
§_is_lškloÿl
(cÚ¡ 
§
 *sa);

59 
boŞ
 
§_is_loİback
(cÚ¡ 
§
 *sa);

60 
boŞ
 
§_is_ªy
(cÚ¡ 
§
 *sa);

62 
	g»_´štf
;

63 
§_´št_addr
(
»_´štf
 *
pf
, cÚ¡ 
§
 *sa);

	@re-0.5.6/include/re_sdp.h

9 
	mSDP_VERSION
 = 0

13 
	esdp_dœ
 {

14 
	mSDP_INACTIVE
 = 0,

15 
	mSDP_RECVONLY
 = 1,

16 
	mSDP_SENDONLY
 = 2,

17 
	mSDP_SENDRECV
 = 3,

21 
	esdp_bªdwidth
 {

22 
	mSDP_BANDWIDTH_MIN
 = 0,

23 
	mSDP_BANDWIDTH_CT
 = 0,

24 
	mSDP_BANDWIDTH_AS
,

25 
	mSDP_BANDWIDTH_RS
,

26 
	mSDP_BANDWIDTH_RR
,

27 
	mSDP_BANDWIDTH_TIAS
,

29 
	mSDP_BANDWIDTH_MAX
,

33 
	gsdp_fÜm©
;

35 (
	tsdp_medŸ_’c_h
)(
	tmbuf
 *
	tmb
, 
	tboŞ
 
	tofãr
, *
	t¬g
);

36 (
	tsdp_fm_’c_h
)(
	tmbuf
 *
	tmb
, cÚ¡ 
	tsdp_fÜm©
 *
	tfmt
,

37 
	tboŞ
 
	tofãr
, *
	td©a
);

38 
	$boŞ
(
	tsdp_fm_cmp_h
)(cÚ¡ *
	t·¿ms1
, cÚ¡ *
	t·¿ms2
,

39 *
	td©a
);

40 
	$boŞ
(
	tsdp_fÜm©_h
)(
	tsdp_fÜm©
 *
	tfmt
, *
	t¬g
);

41 
	$boŞ
(
	tsdp_©Œ_h
)(cÚ¡ *
	tÇme
, cÚ¡ *
	tv®ue
, *
	t¬g
);

44 
	ssdp_fÜm©
 {

45 
Ë
†e;

46 *
id
;

47 *
·¿ms
;

48 *
½¬ams
;

49 *
Çme
;

50 
sdp_fm_’c_h
 *
’ch
;

51 
sdp_fm_cmp_h
 *
cmph
;

52 *
d©a
;

53 
boŞ
 
»f
;

54 
boŞ
 
sup
;

55 
±
;

56 
ušt32_t
 
¤©e
;

57 
ušt8_t
 
ch
;

62 
sdp_£ssiÚ
;

64 
	`sdp_£ssiÚ_®loc
(
sdp_£ssiÚ
 **
£s¥
, cÚ¡ 
§
 *
Ïddr
);

65 
	`sdp_£ssiÚ_£t_Ïddr
(
sdp_£ssiÚ
 *
£ss
, cÚ¡ 
§
 *
Ïddr
);

66 
	`sdp_£ssiÚ_£t_lbªdwidth
(
sdp_£ssiÚ
 *
£ss
,

67 
sdp_bªdwidth
 
ty³
, 
št32_t
 
bw
);

68 
	`sdp_£ssiÚ_£t_Ï‰r
(
sdp_£ssiÚ
 *
£ss
, 
boŞ
 
»¶aû
,

69 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, ...);

70 
	`sdp_£ssiÚ_d–_Ï‰r
(
sdp_£ssiÚ
 *
£ss
, cÚ¡ *
Çme
);

71 
št32_t
 
	`sdp_£ssiÚ_lbªdwidth
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

72 
sdp_bªdwidth
 
ty³
);

73 
št32_t
 
	`sdp_£ssiÚ_rbªdwidth
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

74 
sdp_bªdwidth
 
ty³
);

75 cÚ¡ *
	`sdp_£ssiÚ_¿‰r
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

76 cÚ¡ *
Çme
);

77 cÚ¡ *
	`sdp_£ssiÚ_¿‰r_­¶y
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

78 cÚ¡ *
Çme
,

79 
sdp_©Œ_h
 *
©Œh
, *
¬g
);

80 cÚ¡ 
li¡
 *
	`sdp_£ssiÚ_medŸl
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

81 
boŞ
 
loÿl
);

82 
	`sdp_£ssiÚ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_£ssiÚ
 *
£ss
);

86 
sdp_medŸ
;

88 
	`sdp_medŸ_add
(
sdp_medŸ
 **
mp
, 
sdp_£ssiÚ
 *
£ss
,

89 cÚ¡ *
Çme
, 
ušt16_t
 
pÜt
, cÚ¡ *
´Ùo
);

90 
	`sdp_medŸ_£t_®t_´Ùos
(
sdp_medŸ
 *
m
, 
´Ùoc
, ...);

91 
	`sdp_medŸ_£t_’code_hªdËr
(
sdp_medŸ
 *
m
, 
sdp_medŸ_’c_h
 *
’ch
,

92 *
¬g
);

93 
	`sdp_medŸ_£t_fmt_ignÜe
(
sdp_medŸ
 *
m
, 
boŞ
 
fmt_ignÜe
);

94 
	`sdp_medŸ_£t_di§bËd
(
sdp_medŸ
 *
m
, 
boŞ
 
di§bËd
);

95 
	`sdp_medŸ_£t_ÍÜt
(
sdp_medŸ
 *
m
, 
ušt16_t
 
pÜt
);

96 
	`sdp_medŸ_£t_Ïddr
(
sdp_medŸ
 *
m
, cÚ¡ 
§
 *
Ïddr
);

97 
	`sdp_medŸ_£t_lbªdwidth
(
sdp_medŸ
 *
m
, 
sdp_bªdwidth
 
ty³
,

98 
št32_t
 
bw
);

99 
	`sdp_medŸ_£t_ÍÜt_¹ı
(
sdp_medŸ
 *
m
, 
ušt16_t
 
pÜt
);

100 
	`sdp_medŸ_£t_Ïddr_¹ı
(
sdp_medŸ
 *
m
, cÚ¡ 
§
 *
Ïddr
);

101 
	`sdp_medŸ_£t_ldœ
(
sdp_medŸ
 *
m
, 
sdp_dœ
 
dœ
);

102 
	`sdp_medŸ_£t_Ï‰r
(
sdp_medŸ
 *
m
, 
boŞ
 
»¶aû
,

103 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, ...);

104 
	`sdp_medŸ_d–_Ï‰r
(
sdp_medŸ
 *
m
, cÚ¡ *
Çme
);

105 cÚ¡ *
	`sdp_medŸ_´Ùo
(cÚ¡ 
sdp_medŸ
 *
m
);

106 
ušt16_t
 
	`sdp_medŸ_½Üt
(cÚ¡ 
sdp_medŸ
 *
m
);

107 cÚ¡ 
§
 *
	`sdp_medŸ_¿ddr
(cÚ¡ 
sdp_medŸ
 *
m
);

108 cÚ¡ 
§
 *
	`sdp_medŸ_Ïddr
(cÚ¡ 
sdp_medŸ
 *
m
);

109 
	`sdp_medŸ_¿ddr_¹ı
(cÚ¡ 
sdp_medŸ
 *
m
, 
§
 *
¿ddr
);

110 
št32_t
 
	`sdp_medŸ_rbªdwidth
(cÚ¡ 
sdp_medŸ
 *
m
,

111 
sdp_bªdwidth
 
ty³
);

112 
sdp_dœ
 
	`sdp_medŸ_ldœ
(cÚ¡ 
sdp_medŸ
 *
m
);

113 
sdp_dœ
 
	`sdp_medŸ_rdœ
(cÚ¡ 
sdp_medŸ
 *
m
);

114 
sdp_dœ
 
	`sdp_medŸ_dœ
(cÚ¡ 
sdp_medŸ
 *
m
);

115 cÚ¡ 
sdp_fÜm©
 *
	`sdp_medŸ_lfÜm©
(cÚ¡ 
sdp_medŸ
 *
m
, 
±
);

116 cÚ¡ 
sdp_fÜm©
 *
	`sdp_medŸ_rfÜm©
(cÚ¡ 
sdp_medŸ
 *
m
,

117 cÚ¡ *
Çme
);

118 
sdp_fÜm©
 *
	`sdp_medŸ_fÜm©
(cÚ¡ 
sdp_medŸ
 *
m
,

119 
boŞ
 
loÿl
, cÚ¡ *
id
,

120 
±
, cÚ¡ *
Çme
,

121 
št32_t
 
¤©e
, 
št8_t
 
ch
);

122 
sdp_fÜm©
 *
	`sdp_medŸ_fÜm©_­¶y
(cÚ¡ 
sdp_medŸ
 *
m
,

123 
boŞ
 
loÿl
, cÚ¡ *
id
,

124 
±
, cÚ¡ *
Çme
,

125 
št32_t
 
¤©e
, 
št8_t
 
ch
,

126 
sdp_fÜm©_h
 *
fmth
, *
¬g
);

127 cÚ¡ 
li¡
 *
	`sdp_medŸ_fÜm©_l¡
(cÚ¡ 
sdp_medŸ
 *
m
, 
boŞ
 
loÿl
);

128 cÚ¡ *
	`sdp_medŸ_¿‰r
(cÚ¡ 
sdp_medŸ
 *
m
, cÚ¡ *
Çme
);

129 cÚ¡ *
	`sdp_medŸ_£ssiÚ_¿‰r
(cÚ¡ 
sdp_medŸ
 *
m
,

130 cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

131 cÚ¡ *
Çme
);

132 cÚ¡ *
	`sdp_medŸ_¿‰r_­¶y
(cÚ¡ 
sdp_medŸ
 *
m
, cÚ¡ *
Çme
,

133 
sdp_©Œ_h
 *
©Œh
, *
¬g
);

134 cÚ¡ *
	`sdp_medŸ_Çme
(cÚ¡ 
sdp_medŸ
 *
m
);

135 
	`sdp_medŸ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_medŸ
 *
m
);

139 
	`sdp_fÜm©_add
(
sdp_fÜm©
 **
fm
, 
sdp_medŸ
 *
m
,

140 
boŞ
 
´•’d
, cÚ¡ *
id
, cÚ¡ *
Çme
,

141 
ušt32_t
 
¤©e
, 
ušt8_t
 
ch
, 
sdp_fm_’c_h
 *
’ch
,

142 
sdp_fm_cmp_h
 *
cmph
, *
d©a
, 
boŞ
 
»f
,

143 cÚ¡ *
·¿ms
, ...);

144 
	`sdp_fÜm©_£t_·¿ms
(
sdp_fÜm©
 *
fmt
, cÚ¡ *
·¿ms
, ...);

145 
boŞ
 
	`sdp_fÜm©_cmp
(cÚ¡ 
sdp_fÜm©
 *
fmt1
,

146 cÚ¡ 
sdp_fÜm©
 *
fmt2
);

147 
	`sdp_fÜm©_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_fÜm©
 *
fmt
);

151 
	`sdp_’code
(
mbuf
 **
mbp
, 
sdp_£ssiÚ
 *
£ss
, 
boŞ
 
ofãr
);

152 
	`sdp_decode
(
sdp_£ssiÚ
 *
£ss
, 
mbuf
 *
mb
, 
boŞ
 
ofãr
);

156 cÚ¡ *
	`sdp_dœ_Çme
(
sdp_dœ
 
dœ
);

157 cÚ¡ *
	`sdp_bªdwidth_Çme
(
sdp_bªdwidth
 
ty³
);

160 cÚ¡ 
sdp_©Œ_fm
[];

161 cÚ¡ 
sdp_©Œ_max±ime
[];

162 cÚ¡ 
sdp_©Œ_±ime
[];

163 cÚ¡ 
sdp_©Œ_¹ı
[];

164 cÚ¡ 
sdp_©Œ_¹pm­
[];

166 cÚ¡ 
sdp_medŸ_audio
[];

167 cÚ¡ 
sdp_medŸ_video
[];

168 cÚ¡ 
sdp_medŸ_‹xt
[];

170 cÚ¡ 
sdp_´Ùo_¹·vp
[];

171 cÚ¡ 
sdp_´Ùo_¹p§vp
[];

177 
	ssdp_extm­
 {

178 
¶
 
Çme
;

179 
¶
 
©Œs
;

180 
sdp_dœ
 
dœ
;

181 
boŞ
 
dœ_£t
;

182 
ušt32_t
 
id
;

185 
	`sdp_extm­_decode
(
sdp_extm­
 *
ext
, cÚ¡ *
v®
);

	@re-0.5.6/include/re_sha.h

8 #ifdeà
USE_OPENSSL


9 
	~<İ’s¦/sha.h
>

17 
ušt32_t
 
	m¡©e
[5];

18 
ušt32_t
 
	mcouÁ
[2];

19 
ušt8_t
 
	mbufãr
[64];

20 } 
	tSHA1_CTX
;

23 
SHA1_CTX
 
	tSHA_CTX
;

26 
	#SHA1_DIGEST_SIZE
 20

	)

28 
	#SHA_DIGEST_LENGTH
 
SHA1_DIGEST_SIZE


	)

30 
SHA1_In™
(
SHA1_CTX
* 
cÚ‹xt
);

31 
SHA1_Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ *
p
, 
size_t
 
Ën
);

32 
SHA1_Fš®
(
ušt8_t
 
dige¡
[
SHA1_DIGEST_SIZE
], 
SHA1_CTX
* 
cÚ‹xt
);

	@re-0.5.6/include/re_sip.h

9 
	mSIP_PORT
 = 5060,

10 
	mSIP_PORT_TLS
 = 5061,

14 
	es_Œª¥
 {

15 
	mSIP_TRANSP_NONE
 = -1,

16 
	mSIP_TRANSP_UDP
 = 0,

17 
	mSIP_TRANSP_TCP
,

18 
	mSIP_TRANSP_TLS
,

19 
	mSIP_TRANSPC
,

24 
	es_hdrid
 {

25 
	mSIP_HDR_ACCEPT
 = 3186,

26 
	mSIP_HDR_ACCEPT_CONTACT
 = 232,

27 
	mSIP_HDR_ACCEPT_ENCODING
 = 708,

28 
	mSIP_HDR_ACCEPT_LANGUAGE
 = 2867,

29 
	mSIP_HDR_ACCEPT_RESOURCE_PRIORITY
 = 1848,

30 
	mSIP_HDR_ALERT_INFO
 = 274,

31 
	mSIP_HDR_ALLOW
 = 2429,

32 
	mSIP_HDR_ALLOW_EVENTS
 = 66,

33 
	mSIP_HDR_ANSWER_MODE
 = 2905,

34 
	mSIP_HDR_AUTHENTICATION_INFO
 = 3144,

35 
	mSIP_HDR_AUTHORIZATION
 = 2503,

36 
	mSIP_HDR_CALL_ID
 = 3095,

37 
	mSIP_HDR_CALL_INFO
 = 586,

38 
	mSIP_HDR_CONTACT
 = 229,

39 
	mSIP_HDR_CONTENT_DISPOSITION
 = 1425,

40 
	mSIP_HDR_CONTENT_ENCODING
 = 580,

41 
	mSIP_HDR_CONTENT_LANGUAGE
 = 3371,

42 
	mSIP_HDR_CONTENT_LENGTH
 = 3861,

43 
	mSIP_HDR_CONTENT_TYPE
 = 809,

44 
	mSIP_HDR_CSEQ
 = 746,

45 
	mSIP_HDR_DATE
 = 1027,

46 
	mSIP_HDR_ENCRYPTION
 = 3125,

47 
	mSIP_HDR_ERROR_INFO
 = 21,

48 
	mSIP_HDR_EVENT
 = 3286,

49 
	mSIP_HDR_EXPIRES
 = 1983,

50 
	mSIP_HDR_FLOW_TIMER
 = 584,

51 
	mSIP_HDR_FROM
 = 1963,

52 
	mSIP_HDR_HIDE
 = 283,

53 
	mSIP_HDR_HISTORY_INFO
 = 2582,

54 
	mSIP_HDR_IDENTITY
 = 2362,

55 
	mSIP_HDR_IDENTITY_INFO
 = 980,

56 
	mSIP_HDR_IN_REPLY_TO
 = 1577,

57 
	mSIP_HDR_JOIN
 = 3479,

58 
	mSIP_HDR_MAX_BREADTH
 = 3701,

59 
	mSIP_HDR_MAX_FORWARDS
 = 3549,

60 
	mSIP_HDR_MIME_VERSION
 = 3659,

61 
	mSIP_HDR_MIN_EXPIRES
 = 1121,

62 
	mSIP_HDR_MIN_SE
 = 2847,

63 
	mSIP_HDR_ORGANIZATION
 = 3247,

64 
	mSIP_HDR_P_ACCESS_NETWORK_INFO
 = 1662,

65 
	mSIP_HDR_P_ANSWER_STATE
 = 42,

66 
	mSIP_HDR_P_ASSERTED_IDENTITY
 = 1233,

67 
	mSIP_HDR_P_ASSOCIATED_URI
 = 900,

68 
	mSIP_HDR_P_CALLED_PARTY_ID
 = 3347,

69 
	mSIP_HDR_P_CHARGING_FUNCTION_ADDRESSES
 = 2171,

70 
	mSIP_HDR_P_CHARGING_VECTOR
 = 25,

71 
	mSIP_HDR_P_DCS_TRACE_PARTY_ID
 = 3027,

72 
	mSIP_HDR_P_DCS_OSPS
 = 1788,

73 
	mSIP_HDR_P_DCS_BILLING_INFO
 = 2017,

74 
	mSIP_HDR_P_DCS_LAES
 = 693,

75 
	mSIP_HDR_P_DCS_REDIRECT
 = 1872,

76 
	mSIP_HDR_P_EARLY_MEDIA
 = 2622,

77 
	mSIP_HDR_P_MEDIA_AUTHORIZATION
 = 1035,

78 
	mSIP_HDR_P_PREFERRED_IDENTITY
 = 1263,

79 
	mSIP_HDR_P_PROFILE_KEY
 = 1904,

80 
	mSIP_HDR_P_REFUSED_URI_LIST
 = 1047,

81 
	mSIP_HDR_P_SERVED_USER
 = 1588,

82 
	mSIP_HDR_P_USER_DATABASE
 = 2827,

83 
	mSIP_HDR_P_VISITED_NETWORK_ID
 = 3867,

84 
	mSIP_HDR_PATH
 = 2741,

85 
	mSIP_HDR_PERMISSION_MISSING
 = 1409,

86 
	mSIP_HDR_PRIORITY
 = 3520,

87 
	mSIP_HDR_PRIV_ANSWER_MODE
 = 2476,

88 
	mSIP_HDR_PRIVACY
 = 3150,

89 
	mSIP_HDR_PROXY_AUTHENTICATE
 = 116,

90 
	mSIP_HDR_PROXY_AUTHORIZATION
 = 2363,

91 
	mSIP_HDR_PROXY_REQUIRE
 = 3562,

92 
	mSIP_HDR_RACK
 = 2523,

93 
	mSIP_HDR_REASON
 = 3732,

94 
	mSIP_HDR_RECORD_ROUTE
 = 278,

95 
	mSIP_HDR_REFER_SUB
 = 2458,

96 
	mSIP_HDR_REFER_TO
 = 1521,

97 
	mSIP_HDR_REFERRED_BY
 = 3456,

98 
	mSIP_HDR_REJECT_CONTACT
 = 285,

99 
	mSIP_HDR_REPLACES
 = 2534,

100 
	mSIP_HDR_REPLY_TO
 = 2404,

101 
	mSIP_HDR_REQUEST_DISPOSITION
 = 3715,

102 
	mSIP_HDR_REQUIRE
 = 3905,

103 
	mSIP_HDR_RESOURCE_PRIORITY
 = 1643,

104 
	mSIP_HDR_RESPONSE_KEY
 = 1548,

105 
	mSIP_HDR_RETRY_AFTER
 = 409,

106 
	mSIP_HDR_ROUTE
 = 661,

107 
	mSIP_HDR_RSEQ
 = 445,

108 
	mSIP_HDR_SECURITY_CLIENT
 = 1358,

109 
	mSIP_HDR_SECURITY_SERVER
 = 811,

110 
	mSIP_HDR_SECURITY_VERIFY
 = 519,

111 
	mSIP_HDR_SERVER
 = 973,

112 
	mSIP_HDR_SERVICE_ROUTE
 = 1655,

113 
	mSIP_HDR_SESSION_EXPIRES
 = 1979,

114 
	mSIP_HDR_SIP_ETAG
 = 1997,

115 
	mSIP_HDR_SIP_IF_MATCH
 = 3056,

116 
	mSIP_HDR_SUBJECT
 = 1043,

117 
	mSIP_HDR_SUBSCRIPTION_STATE
 = 2884,

118 
	mSIP_HDR_SUPPORTED
 = 119,

119 
	mSIP_HDR_TARGET_DIALOG
 = 3450,

120 
	mSIP_HDR_TIMESTAMP
 = 938,

121 
	mSIP_HDR_TO
 = 1449,

122 
	mSIP_HDR_TRIGGER_CONSENT
 = 3180,

123 
	mSIP_HDR_UNSUPPORTED
 = 982,

124 
	mSIP_HDR_USER_AGENT
 = 4064,

125 
	mSIP_HDR_VIA
 = 3961,

126 
	mSIP_HDR_WARNING
 = 2108,

127 
	mSIP_HDR_WWW_AUTHENTICATE
 = 2763,

129 
	mSIP_HDR_NONE
 = -1

134 
	mSIP_T1
 = 500,

135 
	mSIP_T2
 = 4000,

136 
	mSIP_T4
 = 5000,

141 
	ss_vŸ
 {

142 
¶
 
	m£Áby
;

143 
§
 
	maddr
;

144 
¶
 
	m·¿ms
;

145 
¶
 
	mb¿nch
;

146 
¶
 
	mv®
;

147 
s_Œª¥
 
	m
;

151 
	ss_addr
 {

152 
¶
 
	mdÇme
;

153 
¶
 
	mauri
;

154 
uri
 
	muri
;

155 
¶
 
	m·¿ms
;

159 
	ss_ddr
 {

160 
¶
 
	mdÇme
;

161 
¶
 
	mauri
;

162 
uri
 
	muri
;

163 
¶
 
	m·¿ms
;

164 
¶
 
	mg
;

165 
¶
 
	mv®
;

169 
	ss_c£q
 {

170 
¶
 
	mm‘
;

171 
ušt32_t
 
	mnum
;

175 
	ss_hdr
 {

176 
Ë
 
	mË
;

177 
Ë
 
	mhe
;

178 
¶
 
	mÇme
;

179 
¶
 
	mv®
;

180 
s_hdrid
 
	mid
;

184 
	ss_msg
 {

185 
§
 
	m¤c
;

186 
§
 
	md¡
;

187 
¶
 
	mv”
;

188 
¶
 
	mm‘
;

189 
¶
 
	mruri
;

190 
uri
 
	muri
;

191 
ušt16_t
 
	mscode
;

192 
¶
 
	m»asÚ
;

193 
li¡
 
	mhd¾
;

194 
s_vŸ
 
	mvŸ
;

195 
s_ddr
 
	mto
;

196 
s_ddr
 
	mäom
;

197 
s_c£q
 
	mc£q
;

198 
msg_ùy³
 
	mùyp
;

199 
¶
 
	mÿÎid
;

200 
¶
 
	mmaxfwd
;

201 
¶
 
	mexpœes
;

202 
¶
 
	mş’
;

203 
hash
 *
	mhdrht
;

204 
mbuf
 *
	mmb
;

205 *
	msock
;

206 
ušt64_t
 
	mg
;

207 
s_Œª¥
 
	m
;

208 
boŞ
 
	m»q
;

212 
	ss_loİ¡©e
 {

213 
ušt32_t
 
	mçc
;

214 
ušt16_t
 
	mÏ¡_scode
;

218 
	ss_cÚù
 {

219 cÚ¡ *
	muri
;

220 cÚ¡ 
§
 *
	maddr
;

221 
s_Œª¥
 
	m
;

224 
	gs
;

225 
	gs_l¢r
;

226 
	gs_»que¡
;

227 
	gs_¡¿ns
;

228 
	gs_auth
;

229 
	gs_dŸlog
;

230 
	gs_k“·live
;

231 
	gdnsc
;

233 
	$boŞ
(
	ts_msg_h
)(cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

234 (
	ts_£nd_h
)(
	ts_Œª¥
 
	t
, cÚ¡ 
	t§
 *
	t¤c
,

235 cÚ¡ 
	t§
 *
	td¡
, 
	tmbuf
 *
	tmb
, *
	t¬g
);

236 (
	ts_»¥_h
)(
	t”r
, cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

237 (
	ts_ÿnûl_h
)(*
	t¬g
);

238 (
	ts_ex™_h
)(*
	t¬g
);

239 (
	ts_auth_h
)(**
	tu£ºame
, **
	t·sswÜd
, cÚ¡ *
	t»®m
,

240 *
	t¬g
);

241 
	$boŞ
(
	ts_hdr_h
)(cÚ¡ 
	ts_hdr
 *
	thdr
, cÚ¡ 
	ts_msg
 *
	tmsg
,

242 *
	t¬g
);

243 (
	ts_k“·live_h
)(
	t”r
, *
	t¬g
);

247 
	`s_®loc
(
s
 **
sp
, 
dnsc
 *dnsc, 
ušt32_t
 
ùsz
,

248 
ušt32_t
 
¡sz
, ušt32_ˆ
tcsz
, cÚ¡ *
soáw¬e
,

249 
s_ex™_h
 *
ex™h
, *
¬g
);

250 
	`s_şo£
(
s
 *s, 
boŞ
 
fÜû
);

251 
	`s_li¡’
(
s_l¢r
 **
l¢½
, 
s
 *s, 
boŞ
 
»q
,

252 
s_msg_h
 *
msgh
, *
¬g
);

253 
	`s_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip);

254 
	`s_£nd
(
s
 *s, *
sock
, 
s_Œª¥
 

,

255 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

259 
	`s_Œª¥_add
(
s
 *s, 
s_Œª¥
 

,

260 cÚ¡ 
§
 *
Ïddr
, ...);

261 
	`s_Œª¥_æush
(
s
 *sip);

262 
boŞ
 
	`s_Œª¥_i¦addr
(cÚ¡ 
s
 *s, 
s_Œª¥
 

,

263 cÚ¡ 
§
 *
Ïddr
);

264 cÚ¡ *
	`s_Œª¥_Çme
(
s_Œª¥
 

);

265 cÚ¡ *
	`s_Œª¥_·¿m
(
s_Œª¥
 

);

266 
ušt16_t
 
	`s_Œª¥_pÜt
(
s_Œª¥
 

, ušt16_ˆ
pÜt
);

267 
	`s_Œª¥_Ïddr
(
s
 *s, 
§
 *
Ïddr
, 
s_Œª¥
 

,

268 cÚ¡ 
§
 *
d¡
);

272 
	`s_»que¡
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

273 cÚ¡ *
m‘
, 
m‘l
, cÚ¡ *
uri
, 
ur
,

274 cÚ¡ 
uri
 *
rou‹
, 
mbuf
 *
mb
, 
size_t
 
sÜtkey
,

275 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
, *
¬g
);

276 
	`s_»que¡f
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

277 cÚ¡ *
m‘
, cÚ¡ *
uri
, cÚ¡ ur˜*
rou‹
,

278 
s_auth
 *
auth
, 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
,

279 *
¬g
, cÚ¡ *
fmt
, ...);

280 
	`s_d»que¡f
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

281 cÚ¡ *
m‘
, 
s_dŸlog
 *
dlg
, 
ušt32_t
 
c£q
,

282 
s_auth
 *
auth
, 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
,

283 *
¬g
, cÚ¡ *
fmt
, ...);

284 
	`s_»que¡_ÿnûl
(
s_»que¡
 *
»q
);

285 
boŞ
 
	`s_»que¡_loİs
(
s_loİ¡©e
 *
ls
, 
ušt16_t
 
scode
);

286 
	`s_loİ¡©e_»£t
(
s_loİ¡©e
 *
ls
);

290 
	`s_¡¿ns_®loc
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

291 cÚ¡ 
s_msg
 *
msg
, 
s_ÿnûl_h
 *
ÿnûlh
,

292 *
¬g
);

293 
	`s_¡¿ns_»¶y
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

294 cÚ¡ 
s_msg
 *
msg
, cÚ¡ 
§
 *
d¡
,

295 
ušt16_t
 
scode
, 
mbuf
 *
mb
);

296 
	`s_Œ•lyf
(
s_¡¿ns
 **
¡p
, 
mbuf
 **
mbp
, 
s
 *sip,

297 cÚ¡ 
s_msg
 *
msg
, 
boŞ
 
»c_rou‹
, 
ušt16_t
 
scode
,

298 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, ...);

299 
	`s_Œ•ly
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

300 cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
);

301 
	`s_»¶yf
(
s
 *s, cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

302 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, ...);

303 
	`s_»¶y
(
s
 *s, cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

304 cÚ¡ *
»asÚ
);

305 
	`s_»¶y_addr
(
§
 *
addr
, cÚ¡ 
s_msg
 *
msg
, 
boŞ
 
½Üt
);

309 
	`s_auth_auth’tiÿ‹
(
s_auth
 *
auth
, cÚ¡ 
s_msg
 *
msg
);

310 
	`s_auth_®loc
(
s_auth
 **
authp
, 
s_auth_h
 *
authh
,

311 *
¬g
, 
boŞ
 
»f
);

312 
	`s_auth_»£t
(
s_auth
 *
auth
);

316 
	`s_cÚù_£t
(
s_cÚù
 *
cÚù
, cÚ¡ *
uri
,

317 cÚ¡ 
§
 *
addr
, 
s_Œª¥
 

);

318 
	`s_cÚù_´št
(
»_´štf
 *
pf
,

319 cÚ¡ 
s_cÚù
 *
cÚù
);

323 
	`s_dŸlog_®loc
(
s_dŸlog
 **
dlgp
,

324 cÚ¡ *
uri
, cÚ¡ *
to_uri
,

325 cÚ¡ *
äom_Çme
, cÚ¡ *
äom_uri
,

326 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
);

327 
	`s_dŸlog_acû±
(
s_dŸlog
 **
dlgp
, cÚ¡ 
s_msg
 *
msg
);

328 
	`s_dŸlog_ü—‹
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
);

329 
	`s_dŸlog_fÜk
(
s_dŸlog
 **
dlgp
, s_dŸlog *
odlg
,

330 cÚ¡ 
s_msg
 *
msg
);

331 
	`s_dŸlog_upd©e
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
);

332 
boŞ
 
	`s_dŸlog_r£q_v®id
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
);

333 cÚ¡ *
	`s_dŸlog_ÿÎid
(cÚ¡ 
s_dŸlog
 *
dlg
);

334 
ušt32_t
 
	`s_dŸlog_l£q
(cÚ¡ 
s_dŸlog
 *
dlg
);

335 
boŞ
 
	`s_dŸlog_e¡ablished
(cÚ¡ 
s_dŸlog
 *
dlg
);

336 
boŞ
 
	`s_dŸlog_cmp
(cÚ¡ 
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
);

337 
boŞ
 
	`s_dŸlog_cmp_h®f
(cÚ¡ 
s_dŸlog
 *
dlg
,

338 cÚ¡ 
s_msg
 *
msg
);

342 
	`s_msg_decode
(
s_msg
 **
msgp
, 
mbuf
 *
mb
);

343 cÚ¡ 
s_hdr
 *
	`s_msg_hdr
(cÚ¡ 
s_msg
 *
msg
,

344 
s_hdrid
 
id
);

345 cÚ¡ 
s_hdr
 *
	`s_msg_hdr_­¶y
(cÚ¡ 
s_msg
 *
msg
,

346 
boŞ
 
fwd
, 
s_hdrid
 
id
,

347 
s_hdr_h
 *
h
, *
¬g
);

348 cÚ¡ 
s_hdr
 *
	`s_msg_xhdr
(cÚ¡ 
s_msg
 *
msg
,

349 cÚ¡ *
Çme
);

350 cÚ¡ 
s_hdr
 *
	`s_msg_xhdr_­¶y
(cÚ¡ 
s_msg
 *
msg
,

351 
boŞ
 
fwd
, cÚ¡ *
Çme
,

352 
s_hdr_h
 *
h
, *
¬g
);

353 
ušt32_t
 
	`s_msg_hdr_couÁ
(cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
id
);

354 
ušt32_t
 
	`s_msg_xhdr_couÁ
(cÚ¡ 
s_msg
 *
msg
, cÚ¡ *
Çme
);

355 
boŞ
 
	`s_msg_hdr_has_v®ue
(cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
id
,

356 cÚ¡ *
v®ue
);

357 
boŞ
 
	`s_msg_xhdr_has_v®ue
(cÚ¡ 
s_msg
 *
msg
, cÚ¡ *
Çme
,

358 cÚ¡ *
v®ue
);

359 
tı_cÚn
 *
	`s_msg_tıcÚn
(cÚ¡ 
s_msg
 *
msg
);

360 
	`s_msg_dump
(cÚ¡ 
s_msg
 *
msg
);

362 
	`s_addr_decode
(
s_addr
 *
addr
, cÚ¡ 
¶
 *pl);

363 
	`s_vŸ_decode
(
s_vŸ
 *
vŸ
, cÚ¡ 
¶
 *pl);

364 
	`s_c£q_decode
(
s_c£q
 *
c£q
, cÚ¡ 
¶
 *pl);

368 
	`s_k“·live_¡¬t
(
s_k“·live
 **
k­
, 
s
 *sip,

369 cÚ¡ 
s_msg
 *
msg
, 
ušt32_t
 
š‹rv®
,

370 
s_k“·live_h
 *
kah
, *
¬g
);

	@re-0.5.6/include/re_sipevent.h

10 
	ssev’t_ev’t
 {

11 
¶
 
	mev’t
;

12 
¶
 
	m·¿ms
;

13 
¶
 
	mid
;

16 
	esev’t_sub¡
 {

17 
	mSIPEVENT_ACTIVE
 = 0,

18 
	mSIPEVENT_PENDING
,

19 
	mSIPEVENT_TERMINATED
,

22 
	esev’t_»asÚ
 {

23 
	mSIPEVENT_DEACTIVATED
 = 0,

24 
	mSIPEVENT_PROBATION
,

25 
	mSIPEVENT_REJECTED
,

26 
	mSIPEVENT_TIMEOUT
,

27 
	mSIPEVENT_GIVEUP
,

28 
	mSIPEVENT_NORESOURCE
,

31 
	ssev’t_sub¡©e
 {

32 
sev’t_sub¡
 
	m¡©e
;

33 
sev’t_»asÚ
 
	m»asÚ
;

34 
¶
 
	mexpœes
;

35 
¶
 
	m»Œy_aá”
;

36 
¶
 
	m·¿ms
;

39 
sev’t_ev’t_decode
(
sev’t_ev’t
 *
£
, cÚ¡ 
¶
 *pl);

40 
sev’t_sub¡©e_decode
(
sev’t_sub¡©e
 *
ss
,

41 cÚ¡ 
¶
 *pl);

42 cÚ¡ *
sev’t_sub¡©e_Çme
(
sev’t_sub¡
 
¡©e
);

43 cÚ¡ *
sev’t_»asÚ_Çme
(
sev’t_»asÚ
 
»asÚ
);

48 
	gsev’t_sock
;

50 
sev’t_li¡’
(
sev’t_sock
 **
sockp
, 
s
 *sip,

51 
ušt32_t
 
htsize_nÙ
, ušt32_ˆ
htsize_sub
,

52 
s_msg_h
 *
subh
, *
¬g
);

57 
	gsnÙ
;

59 (
	tsnÙ_şo£_h
)(
	t”r
, cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

61 
	`sev’t_acû±
(
snÙ
 **
nÙp
, 
sev’t_sock
 *
sock
,

62 cÚ¡ 
s_msg
 *
msg
, 
s_dŸlog
 *
dlg
,

63 cÚ¡ 
sev’t_ev’t
 *
ev’t
,

64 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
, 
ušt32_t
 
expœes_mš
,

65 
ušt32_t
 
expœes_dæ
, ušt32_ˆ
expœes_max
,

66 cÚ¡ *
cu£r
, cÚ¡ *
ùy³
,

67 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

68 
snÙ_şo£_h
 *
şo£h
, *
¬g
, cÚ¡ *
fmt
, ...);

69 
	`sev’t_nÙify
(
snÙ
 *snÙ, 
mbuf
 *
mb
,

70 
sev’t_sub¡
 
¡©e
, 
sev’t_»asÚ
 
»asÚ
,

71 
ušt32_t
 
»Œy_aá”
);

72 
	`sev’t_nÙifyf
(
snÙ
 *snÙ, 
mbuf
 **
mbp
,

73 
sev’t_sub¡
 
¡©e
, 
sev’t_»asÚ
 
»asÚ
,

74 
ušt32_t
 
»Œy_aá”
, cÚ¡ *
fmt
, ...);

79 
ssub
;

81 (
	tssub_fÜk_h
)(
	tssub
 **
	tsubp
, ssub *
	tosub
,

82 cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

83 (
	tssub_nÙify_h
)(
	ts
 *s, cÚ¡ 
	ts_msg
 *
	tmsg
,

84 *
	t¬g
);

85 (
	tssub_şo£_h
)(
	t”r
, cÚ¡ 
	ts_msg
 *
	tmsg
,

86 cÚ¡ 
	tsev’t_sub¡©e
 *
	tsub¡©e
,

87 *
	t¬g
);

89 
	`sev’t_subsüibe
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

90 cÚ¡ *
uri
, cÚ¡ *
äom_Çme
,

91 cÚ¡ *
äom_uri
, cÚ¡ *
ev’t
, cÚ¡ *
id
,

92 
ušt32_t
 
expœes
, cÚ¡ *
cu£r
,

93 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

94 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

95 
ssub_fÜk_h
 *
fÜkh
, 
ssub_nÙify_h
 *
nÙifyh
,

96 
ssub_şo£_h
 *
şo£h
, *
¬g
,

97 cÚ¡ *
fmt
, ...);

98 
	`sev’t_dsubsüibe
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

99 
s_dŸlog
 *
dlg
, cÚ¡ *
ev’t
,

100 cÚ¡ *
id
, 
ušt32_t
 
expœes
, cÚ¡ *
cu£r
,

101 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

102 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

103 *
¬g
, cÚ¡ *
fmt
, ...);

105 
	`sev’t_»ãr
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

106 cÚ¡ *
uri
, cÚ¡ *
äom_Çme
,

107 cÚ¡ *
äom_uri
, cÚ¡ *
cu£r
,

108 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

109 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

110 
ssub_fÜk_h
 *
fÜkh
, 
ssub_nÙify_h
 *
nÙifyh
,

111 
ssub_şo£_h
 *
şo£h
, *
¬g
,

112 cÚ¡ *
fmt
, ...);

113 
	`sev’t_d»ãr
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

114 
s_dŸlog
 *
dlg
, cÚ¡ *
cu£r
,

115 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

116 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

117 *
¬g
, cÚ¡ *
fmt
, ...);

119 
	`sev’t_fÜk
(
ssub
 **
subp
, ssub *
osub
,

120 cÚ¡ 
s_msg
 *
msg
,

121 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

122 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

123 *
¬g
);

	@re-0.5.6/include/re_sipreg.h

7 
	gs»g
;

10 
s»g_»gi¡”
(
s»g
 **
»gp
, 
s
 *s, cÚ¡ *
»g_uri
,

11 cÚ¡ *
to_uri
, cÚ¡ *
äom_uri
, 
ušt32_t
 
expœes
,

12 cÚ¡ *
cu£r
, cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

13 
»gid
, 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

14 
s_»¥_h
 *
»¥h
, *
¬g
,

15 cÚ¡ *
·¿ms
, cÚ¡ *
fmt
, ...);

17 cÚ¡ 
§
 *
s»g_Ïddr
(cÚ¡ 
s»g
 *
»g
);

	@re-0.5.6/include/re_sipsess.h

7 
	gs£ss_sock
;

8 
	gs£ss
;

11 (
	ts£ss_cÚn_h
)(cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

12 (
	ts£ss_ofãr_h
)(
	tmbuf
 **
	tdesı
, cÚ¡ 
	ts_msg
 *
	tmsg
,

13 *
	t¬g
);

14 (
	ts£ss_ªsw”_h
)(cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

15 (
	ts£ss_´ogr_h
)(cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

16 (
	ts£ss_e¡ab_h
)(cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

17 (
	ts£ss_šfo_h
)(
	ts
 *s, cÚ¡ 
	ts_msg
 *
	tmsg
,

18 *
	t¬g
);

19 (
	ts£ss_»ãr_h
)(
	ts
 *s, cÚ¡ 
	ts_msg
 *
	tmsg
,

20 *
	t¬g
);

21 (
	ts£ss_şo£_h
)(
	t”r
, cÚ¡ 
	ts_msg
 *
	tmsg
, *
	t¬g
);

24 
	`s£ss_li¡’
(
s£ss_sock
 **
sockp
, 
s
 *sip,

25 
htsize
, 
s£ss_cÚn_h
 *
cÚnh
, *
¬g
);

27 
	`s£ss_cÚÃù
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

28 cÚ¡ *
to_uri
, cÚ¡ *
äom_Çme
,

29 cÚ¡ *
äom_uri
, cÚ¡ *
cu£r
,

30 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

31 cÚ¡ *
ùy³
, 
mbuf
 *
desc
,

32 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

33 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

34 
s£ss_´ogr_h
 *
´ogrh
, 
s£ss_e¡ab_h
 *
e¡abh
,

35 
s£ss_šfo_h
 *
šfoh
, 
s£ss_»ãr_h
 *
»ãrh
,

36 
s£ss_şo£_h
 *
şo£h
, *
¬g
, cÚ¡ *
fmt
, ...);

38 
	`s£ss_acû±
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

39 cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

40 cÚ¡ *
»asÚ
, cÚ¡ *
cu£r
, cÚ¡ *
ùy³
,

41 
mbuf
 *
desc
,

42 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

43 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

44 
s£ss_e¡ab_h
 *
e¡abh
, 
s£ss_šfo_h
 *
šfoh
,

45 
s£ss_»ãr_h
 *
»ãrh
, 
s£ss_şo£_h
 *
şo£h
,

46 *
¬g
, cÚ¡ *
fmt
, ...);

48 
	`s£ss_´og»ss
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
,

49 cÚ¡ *
»asÚ
, 
mbuf
 *
desc
,

50 cÚ¡ *
fmt
, ...);

51 
	`s£ss_ªsw”
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

52 
mbuf
 *
desc
, cÚ¡ *
fmt
, ...);

53 
	`s£ss_»jeù
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

54 cÚ¡ *
fmt
, ...);

55 
	`s£ss_modify
(
s£ss
 *
£ss
, 
mbuf
 *
desc
);

56 
	`s£ss_šfo
(
s£ss
 *
£ss
, cÚ¡ *
ùy³
, 
mbuf
 *
body
,

57 
s_»¥_h
 *
»¥h
, *
¬g
);

58 
	`s£ss_£t_şo£_h—d”s
(
s£ss
 *
£ss
, cÚ¡ *
hdrs
, ...);

59 
	`s£ss_şo£_®l
(
s£ss_sock
 *
sock
);

60 
s_dŸlog
 *
	`s£ss_dŸlog
(cÚ¡ 
s£ss
 *
£ss
);

	@re-0.5.6/include/re_srtp.h

8 
	e¤_su™e
 {

9 
	mSRTP_AES_CM_128_HMAC_SHA1_32
,

10 
	mSRTP_AES_CM_128_HMAC_SHA1_80
,

11 
	mSRTP_AES_256_CM_HMAC_SHA1_32
,

12 
	mSRTP_AES_256_CM_HMAC_SHA1_80
,

15 
	e¤_æags
 {

16 
	mSRTP_UNENCRYPTED_SRTCP
 = 1<<1,

19 
	g¤
;

21 
¤_®loc
(
¤
 **
¤p
, 
¤_su™e
 
su™e
,

22 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_by‹s
, 
æags
);

23 
¤_’üy±
(
¤
 *¤, 
mbuf
 *
mb
);

24 
¤_deüy±
(
¤
 *¤, 
mbuf
 *
mb
);

25 
¤tı_’üy±
(
¤
 *¤, 
mbuf
 *
mb
);

26 
¤tı_deüy±
(
¤
 *¤, 
mbuf
 *
mb
);

28 cÚ¡ *
¤_su™e_Çme
(
¤_su™e
 
su™e
);

	@re-0.5.6/include/re_stun.h

10 
	mSTUN_PORT
 = 3478,

11 
	mSTUNS_PORT
 = 5349,

12 
	mSTUN_HEADER_SIZE
 = 20,

13 
	mSTUN_ATTR_HEADER_SIZE
 = 4,

14 
	mSTUN_TID_SIZE
 = 12,

15 
	mSTUN_DEFAULT_RTO
 = 500,

16 
	mSTUN_DEFAULT_RC
 = 7,

17 
	mSTUN_DEFAULT_RM
 = 16,

18 
	mSTUN_DEFAULT_TI
 = 39500

22 
	e¡un_af
 {

23 
	mSTUN_AF_IPv4
 = 0x01,

24 
	mSTUN_AF_IPv6
 = 0x02

28 
	e¡un_Œª¥
 {

29 
	mSTUN_TRANSP_UDP
 = 
IPPROTO_UDP
,

30 
	mSTUN_TRANSP_TCP
 = 
IPPROTO_TCP
,

31 
	mSTUN_TRANSP_DTLS
,

35 
	e¡un_m‘hod
 {

36 
	mSTUN_METHOD_BINDING
 = 0x001,

37 
	mSTUN_METHOD_ALLOCATE
 = 0x003,

38 
	mSTUN_METHOD_REFRESH
 = 0x004,

39 
	mSTUN_METHOD_SEND
 = 0x006,

40 
	mSTUN_METHOD_DATA
 = 0x007,

41 
	mSTUN_METHOD_CREATEPERM
 = 0x008,

42 
	mSTUN_METHOD_CHANBIND
 = 0x009,

46 
	e¡un_msg_şass
 {

47 
	mSTUN_CLASS_REQUEST
 = 0x0,

48 
	mSTUN_CLASS_INDICATION
 = 0x1,

49 
	mSTUN_CLASS_SUCCESS_RESP
 = 0x2,

50 
	mSTUN_CLASS_ERROR_RESP
 = 0x3

54 
	e¡un_©Œib
 {

56 
	mSTUN_ATTR_MAPPED_ADDR
 = 0x0001,

57 
	mSTUN_ATTR_CHANGE_REQ
 = 0x0003,

58 
	mSTUN_ATTR_USERNAME
 = 0x0006,

59 
	mSTUN_ATTR_MSG_INTEGRITY
 = 0x0008,

60 
	mSTUN_ATTR_ERR_CODE
 = 0x0009,

61 
	mSTUN_ATTR_UNKNOWN_ATTR
 = 0x000a,

62 
	mSTUN_ATTR_CHANNEL_NUMBER
 = 0x000c,

63 
	mSTUN_ATTR_LIFETIME
 = 0x000d,

64 
	mSTUN_ATTR_XOR_PEER_ADDR
 = 0x0012,

65 
	mSTUN_ATTR_DATA
 = 0x0013,

66 
	mSTUN_ATTR_REALM
 = 0x0014,

67 
	mSTUN_ATTR_NONCE
 = 0x0015,

68 
	mSTUN_ATTR_XOR_RELAY_ADDR
 = 0x0016,

69 
	mSTUN_ATTR_REQ_ADDR_FAMILY
 = 0x0017,

70 
	mSTUN_ATTR_EVEN_PORT
 = 0x0018,

71 
	mSTUN_ATTR_REQ_TRANSPORT
 = 0x0019,

72 
	mSTUN_ATTR_DONT_FRAGMENT
 = 0x001a,

73 
	mSTUN_ATTR_XOR_MAPPED_ADDR
 = 0x0020,

74 
	mSTUN_ATTR_RSV_TOKEN
 = 0x0022,

75 
	mSTUN_ATTR_PRIORITY
 = 0x0024,

76 
	mSTUN_ATTR_USE_CAND
 = 0x0025,

77 
	mSTUN_ATTR_PADDING
 = 0x0026,

78 
	mSTUN_ATTR_RESP_PORT
 = 0x0027,

81 
	mSTUN_ATTR_SOFTWARE
 = 0x8022,

82 
	mSTUN_ATTR_ALT_SERVER
 = 0x8023,

83 
	mSTUN_ATTR_FINGERPRINT
 = 0x8028,

84 
	mSTUN_ATTR_CONTROLLED
 = 0x8029,

85 
	mSTUN_ATTR_CONTROLLING
 = 0x802a,

86 
	mSTUN_ATTR_RESP_ORIGIN
 = 0x802b,

87 
	mSTUN_ATTR_OTHER_ADDR
 = 0x802c,

91 
	s¡un_chªge_»q
 {

92 
boŞ
 
	m
;

93 
boŞ
 
	mpÜt
;

96 
	s¡un_”rcode
 {

97 
ušt16_t
 
	mcode
;

98 *
	m»asÚ
;

101 
	s¡un_unknown_©Œ
 {

102 
ušt16_t
 
	mty³v
[8];

103 
ušt32_t
 
	mty³c
;

106 
	s¡un_ev’_pÜt
 {

107 
boŞ
 
	mr
;

111 
	s¡un_©Œ
 {

112 
Ë
 
	mË
;

113 
ušt16_t
 
	mty³
;

116 
§
 
	m§
;

117 *
	m¡r
;

118 
ušt64_t
 
	mušt64
;

119 
ušt32_t
 
	mušt32
;

120 
ušt16_t
 
	mušt16
;

121 
ušt8_t
 
	mušt8
;

122 
mbuf
 
	mmb
;

125 
§
 
	mm­³d_addr
;

126 
¡un_chªge_»q
 
	mchªge_»q
;

127 *
	mu£ºame
;

128 
ušt8_t
 
	mmsg_š‹gr™y
[20];

129 
¡un_”rcode
 
	m”r_code
;

130 
¡un_unknown_©Œ
 
	munknown_©Œ
;

131 
ušt16_t
 
	mchªÃl_numb”
;

132 
ušt32_t
 
	mliãtime
;

133 
§
 
	mxÜ_³”_addr
;

134 
mbuf
 
	md©a
;

135 *
	m»®m
;

136 *
	mnÚû
;

137 
§
 
	mxÜ_»Ïy_addr
;

138 
ušt8_t
 
	m»q_addr_çmy
;

139 
¡un_ev’_pÜt
 
	mev’_pÜt
;

140 
ušt8_t
 
	m»q_Œª¥Üt
;

141 
§
 
	mxÜ_m­³d_addr
;

142 
ušt64_t
 
	mrsv_tok’
;

143 
ušt32_t
 
	m´iÜ™y
;

144 
mbuf
 
	m·ddšg
;

145 
ušt16_t
 
	m»¥_pÜt
;

146 *
	msoáw¬e
;

147 
§
 
	m®t_£rv”
;

148 
ušt32_t
 
	mfšg”´št
;

149 
ušt64_t
 
	mcÚŒŞËd
;

150 
ušt64_t
 
	mcÚŒŞlšg
;

151 
§
 
	m»¥_Üigš
;

152 
§
 
	mÙh”_addr
;

153 } 
	mv
;

158 
	s¡un_cÚf
 {

159 
ušt32_t
 
	m¹o
;

160 
ušt32_t
 
	mrc
;

161 
ušt32_t
 
	mrm
;

162 
ušt32_t
 
	mti
;

163 
ušt8_t
 
	mtos
;

167 cÚ¡ *
¡un_soáw¬e
;

168 
	g¡un
;

169 
	g¡un_msg
;

170 
	g¡un_ù¿ns
;

172 (
	t¡un_»¥_h
)(
	t”r
, 
	tušt16_t
 
	tscode
, cÚ¡ *
	t»asÚ
,

173 cÚ¡ 
	t¡un_msg
 *
	tmsg
, *
	t¬g
);

174 (
	t¡un_šd_h
)(
	t¡un_msg
 *
	tmsg
, *
	t¬g
);

175 
	$boŞ
(
	t¡un_©Œ_h
)(cÚ¡ 
	t¡un_©Œ
 *
	t©Œ
, *
	t¬g
);

177 
	`¡un_®loc
(
¡un
 **
¡uÅ
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

178 
¡un_šd_h
 *
šdh
, *
¬g
);

179 
¡un_cÚf
 *
	`¡un_cÚf
(
¡un
 *stun);

180 
	`¡un_£nd
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

181 
	`¡un_»cv
(
¡un
 *¡un, 
mbuf
 *
mb
);

182 
	`¡un_ù¿ns_»cv
(
¡un
 *¡un, cÚ¡ 
¡un_msg
 *
msg
,

183 cÚ¡ 
¡un_unknown_©Œ
 *
ua
);

184 
»_´štf
;

185 
	`¡un_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡un
 *stun);

187 
	`¡un_»que¡
(
¡un_ù¿ns
 **
ùp
, 
¡un
 *¡un, 
´Ùo
,

188 *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

189 
ušt16_t
 
m‘hod
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

190 
¡un_»¥_h
 *
»¥h
, *
¬g
, 
ušt32_t
 
©Œc
, ...);

191 
	`¡un_»¶y
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

192 cÚ¡ 
¡un_msg
 *
»q
, cÚ¡ 
ušt8_t
 *
key
,

193 
size_t
 
keyËn
, 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...);

194 
	`¡un_”•ly
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

195 cÚ¡ 
¡un_msg
 *
»q
, 
ušt16_t
 
scode
,

196 cÚ¡ *
»asÚ
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

197 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...);

198 
	`¡un_šdiÿtiÚ
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

199 
ušt16_t
 
m‘hod
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

200 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...);

202 
	`¡un_msg_v’code
(
mbuf
 *
mb
, 
ušt16_t
 
m‘hod
, 
ušt8_t
 
şs
,

203 cÚ¡ 
ušt8_t
 *
tid
, cÚ¡ 
¡un_”rcode
 *
ec
,

204 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

205 
ušt8_t
 
·ddšg
, 
ušt32_t
 
©Œc
, 
va_li¡
 
­
);

206 
	`¡un_msg_’code
(
mbuf
 *
mb
, 
ušt16_t
 
m‘hod
, 
ušt8_t
 
şs
,

207 cÚ¡ 
ušt8_t
 *
tid
, cÚ¡ 
¡un_”rcode
 *
ec
,

208 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

209 
ušt8_t
 
·ddšg
, 
ušt32_t
 
©Œc
, ...);

210 
	`¡un_msg_decode
(
¡un_msg
 **
msgµ
, 
mbuf
 *
mb
,

211 
¡un_unknown_©Œ
 *
ua
);

212 
ušt16_t
 
	`¡un_msg_ty³
(cÚ¡ 
¡un_msg
 *
msg
);

213 
ušt16_t
 
	`¡un_msg_şass
(cÚ¡ 
¡un_msg
 *
msg
);

214 
ušt16_t
 
	`¡un_msg_m‘hod
(cÚ¡ 
¡un_msg
 *
msg
);

215 
boŞ
 
	`¡un_msg_mcook›
(cÚ¡ 
¡un_msg
 *
msg
);

216 cÚ¡ 
ušt8_t
 *
	`¡un_msg_tid
(cÚ¡ 
¡un_msg
 *
msg
);

217 
¡un_©Œ
 *
	`¡un_msg_©Œ
(cÚ¡ 
¡un_msg
 *
msg
, 
ušt16_t
 
ty³
);

218 
¡un_©Œ
 *
	`¡un_msg_©Œ_­¶y
(cÚ¡ 
¡un_msg
 *
msg
,

219 
¡un_©Œ_h
 *
h
, *
¬g
);

220 
	`¡un_msg_chk_mi
(cÚ¡ 
¡un_msg
 *
msg
, cÚ¡ 
ušt8_t
 *
key
,

221 
size_t
 
keyËn
);

222 
	`¡un_msg_chk_fšg”´št
(cÚ¡ 
¡un_msg
 *
msg
);

223 
	`¡un_msg_dump
(cÚ¡ 
¡un_msg
 *
msg
);

225 cÚ¡ *
	`¡un_şass_Çme
(
ušt16_t
 
şs
);

226 cÚ¡ *
	`¡un_m‘hod_Çme
(
ušt16_t
 
m‘hod
);

227 cÚ¡ *
	`¡un_©Œ_Çme
(
ušt16_t
 
ty³
);

228 cÚ¡ *
	`¡un_Œª¥_Çme
(
¡un_Œª¥
 

);

232 cÚ¡ *
¡un_´Ùo_udp
;

233 cÚ¡ *
¡un_´Ùo_tı
;

235 cÚ¡ *
¡un_u§ge_bšdšg
;

236 cÚ¡ *
¡uns_u§ge_bšdšg
;

237 cÚ¡ *
¡un_u§ge_»Ïy
;

238 cÚ¡ *
¡uns_u§ge_»Ïy
;

239 cÚ¡ *
¡un_u§ge_behaviÜ
;

240 cÚ¡ *
¡uns_u§ge_behaviÜ
;

250 (
	t¡un_dns_h
)(
	t”r
, cÚ¡ 
	t§
 *
	t¤v
, *
	t¬g
);

252 
¡un_dns
;

253 
dnsc
;

254 
	`¡un_£rv”_discov”
(
¡un_dns
 **
dn¥
, 
dnsc
 *dnsc,

255 cÚ¡ *
£rviû
, cÚ¡ *
´Ùo
,

256 
af
, cÚ¡ *
domaš
, 
ušt16_t
 
pÜt
,

257 
¡un_dns_h
 *
dnsh
, *
¬g
);

261 
¡un_k“·live
;

270 (
	t¡un_m­³d_addr_h
)(
	t”r
, cÚ¡ 
	t§
 *
	tm­
, *
	t¬g
);

273 
	`¡un_k“·live_®loc
(
¡un_k“·live
 **
sk­
,

274 
´Ùo
, *
sock
, 
Ïy”
,

275 cÚ¡ 
§
 *
d¡
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

276 
¡un_m­³d_addr_h
 *
mah
, *
¬g
);

277 
	`¡un_k“·live_’abË
(
¡un_k“·live
 *
ska
, 
ušt32_t
 
š‹rv®
);

281 cÚ¡ *
¡un_»asÚ_300
;

282 cÚ¡ *
¡un_»asÚ_400
;

283 cÚ¡ *
¡un_»asÚ_401
;

284 cÚ¡ *
¡un_»asÚ_403
;

285 cÚ¡ *
¡un_»asÚ_420
;

286 cÚ¡ *
¡un_»asÚ_437
;

287 cÚ¡ *
¡un_»asÚ_438
;

288 cÚ¡ *
¡un_»asÚ_440
;

289 cÚ¡ *
¡un_»asÚ_441
;

290 cÚ¡ *
¡un_»asÚ_442
;

291 cÚ¡ *
¡un_»asÚ_443
;

292 cÚ¡ *
¡un_»asÚ_486
;

293 cÚ¡ *
¡un_»asÚ_500
;

294 cÚ¡ *
¡un_»asÚ_508
;

	@re-0.5.6/include/re_sys.h

8 #iâdeà
VERSION


9 
	#VERSION
 "?"

	)

17 #iâdeà
ARCH


18 
	#ARCH
 "?"

	)

26 #iâdeà
OS


27 #ifdeà
WIN32


28 
	#OS
 "wš32"

	)

30 
	#OS
 "?"

	)

34 
	g»_´štf
;

35 
sys_»l_g‘
(
ušt32_t
 *
»l
, ušt32_ˆ*
maj
, ušt32_ˆ*
mš
,

36 
ušt32_t
 *
·tch
);

37 
sys_k”Ãl_g‘
(
»_´štf
 *
pf
, *
unu£d
);

38 
sys_bud_g‘
(
»_´štf
 *
pf
, *
unu£d
);

39 cÚ¡ *
sys_¬ch_g‘
();

40 cÚ¡ *
sys_os_g‘
();

41 cÚ¡ *
sys_lib»_v”siÚ_g‘
();

42 cÚ¡ *
sys_u£ºame
();

43 
sys_cÜedump_£t
(
boŞ
 
’abË
);

44 
sys_d«mÚ
();

45 
sys_u¦“p
(
us
);

47 
šlše
 
	$sys_m¦“p
(
ms
)

49 
	`sys_u¦“p
(
ms
 * 1000);

50 
	}
}

53 
ušt16_t
 
sys_htŞs
(ušt16_ˆ
v
);

54 
ušt32_t
 
sys_htŞl
(ušt32_ˆ
v
);

55 
ušt16_t
 
sys_Éohs
(ušt16_ˆ
v
);

56 
ušt32_t
 
sys_Éohl
(ušt32_ˆ
v
);

57 
ušt64_t
 
sys_htÚÎ
(ušt64_ˆ
v
);

58 
ušt64_t
 
sys_ÁohÎ
(ušt64_ˆ
v
);

62 
¿nd_š™
();

63 
ušt16_t
 
¿nd_u16
();

64 
ušt32_t
 
¿nd_u32
();

65 
ušt64_t
 
¿nd_u64
();

66 
¿nd_ch¬
();

67 
¿nd_¡r
(*
¡r
, 
size_t
 
size
);

68 
¿nd_by‹s
(
ušt8_t
 *
p
, 
size_t
 
size
);

72 
fs_mkdœ
(cÚ¡ *
·th
, 
ušt16_t
 
mode
);

73 
fs_g‘home
(*
·th
, 
size_t
 
sz
);

	@re-0.5.6/include/re_tcp.h

6 
	g§
;

7 
	gtı_sock
;

8 
	gtı_cÚn
;

17 (
	ttı_cÚn_h
)(cÚ¡ 
	t§
 *
	t³”
, *
	t¬g
);

24 (
	ttı_e¡ab_h
)(*
	t¬g
);

31 (
	ttı_£nd_h
)(*
	t¬g
);

39 (
	ttı_»cv_h
)(
	tmbuf
 *
	tmb
, *
	t¬g
);

47 (
	ttı_şo£_h
)(
	t”r
, *
	t¬g
);

51 
	`tı_sock_®loc
(
tı_sock
 **
t¥
, cÚ¡ 
§
 *
loÿl
,

52 
tı_cÚn_h
 *
ch
, *
¬g
);

53 
	`tı_sock_bšd
(
tı_sock
 *
ts
, cÚ¡ 
§
 *
loÿl
);

54 
	`tı_sock_li¡’
(
tı_sock
 *
ts
, 
backlog
);

55 
	`tı_acû±
(
tı_cÚn
 **
tı
, 
tı_sock
 *
ts
, 
tı_e¡ab_h
 *
eh
,

56 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
, *
¬g
);

57 
	`tı_»jeù
(
tı_sock
 *
ts
);

58 
	`tı_sock_loÿl_g‘
(cÚ¡ 
tı_sock
 *
ts
, 
§
 *
loÿl
);

62 
	`tı_cÚn_®loc
(
tı_cÚn
 **
tı
, cÚ¡ 
§
 *
³”
,

63 
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
,

64 *
¬g
);

65 
	`tı_cÚn_bšd
(
tı_cÚn
 *
tc
, cÚ¡ 
§
 *
loÿl
);

66 
	`tı_cÚn_cÚÃù
(
tı_cÚn
 *
tc
, cÚ¡ 
§
 *
³”
);

67 
	`tı_£nd
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
);

68 
	`tı_£t_£nd
(
tı_cÚn
 *
tc
, 
tı_£nd_h
 *
£ndh
);

69 
	`tı_£t_hªdËrs
(
tı_cÚn
 *
tc
, 
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
,

70 
tı_şo£_h
 *
ch
, *
¬g
);

71 
	`tı_cÚn_rxsz_£t
(
tı_cÚn
 *
tc
, 
size_t
 
rxsz
);

72 
	`tı_cÚn_txqsz_£t
(
tı_cÚn
 *
tc
, 
size_t
 
txqsz
);

73 
	`tı_cÚn_loÿl_g‘
(cÚ¡ 
tı_cÚn
 *
tc
, 
§
 *
loÿl
);

74 
	`tı_cÚn_³”_g‘
(cÚ¡ 
tı_cÚn
 *
tc
, 
§
 *
³”
);

75 
	`tı_cÚn_fd
(cÚ¡ 
tı_cÚn
 *
tc
);

76 
size_t
 
	`tı_cÚn_txqsz
(cÚ¡ 
tı_cÚn
 *
tc
);

80 
	`tı_li¡’
(
tı_sock
 **
t¥
, cÚ¡ 
§
 *
loÿl
,

81 
tı_cÚn_h
 *
ch
, *
¬g
);

82 
	`tı_cÚÃù
(
tı_cÚn
 **
tı
, cÚ¡ 
§
 *
³”
,

83 
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
, *
¬g
);

84 
	`tı_loÿl_g‘
(cÚ¡ 
tı_sock
 *
ts
, 
§
 *
loÿl
);

88 
	$boŞ
 (
	ttı_h–³r_e¡ab_h
)(*
	t”r
, 
	tboŞ
 
	taùive
, *
	t¬g
);

89 
	$boŞ
 (
	ttı_h–³r_£nd_h
)(*
	t”r
, 
	tmbuf
 *
	tmb
, *
	t¬g
);

90 
	$boŞ
 (
	ttı_h–³r_»cv_h
)(*
	t”r
, 
	tmbuf
 *
	tmb
, 
	tboŞ
 *
	te¡ab
,

91 *
	t¬g
);

93 
tı_h–³r
;

96 
	`tı_»gi¡”_h–³r
(
tı_h–³r
 **
thp
, 
tı_cÚn
 *
tc
,

97 
Ïy”
,

98 
tı_h–³r_e¡ab_h
 *
eh
, 
tı_h–³r_£nd_h
 *
sh
,

99 
tı_h–³r_»cv_h
 *
rh
, *
¬g
);

100 
	`tı_£nd_h–³r
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
,

101 
tı_h–³r
 *
th
);

	@re-0.5.6/include/re_telev.h

8 
	mTELEV_PTIME
 = 50,

9 
	mTELEV_SRATE
 = 8000

12 
	g‹Ëv
;

14 cÚ¡ 
‹Ëv_¹pfmt
[];

16 
‹Ëv_®loc
(
‹Ëv
 **

, 
ušt32_t
 
±ime
);

17 
‹Ëv_£t_¤©e
(
‹Ëv
 *
‹l
, 
ušt32_t
 
¤©e
);

18 
‹Ëv_£nd
(
‹Ëv
 *
‹l
, 
ev’t
, 
boŞ
 
’d
);

19 
‹Ëv_»cv
(
‹Ëv
 *
‹l
, 
mbuf
 *
mb
, *
ev’t
, 
boŞ
 *
’d
);

20 
‹Ëv_pŞl
(
‹Ëv
 *
‹l
, 
boŞ
 *
m¬k”
, 
mbuf
 *
mb
);

22 
‹Ëv_dig™2code
(
dig™
);

23 
‹Ëv_code2dig™
(
code
);

	@re-0.5.6/include/re_tls.h

8 
	gs
;

9 
	gs_cÚn
;

10 
	gtı_cÚn
;

11 
	gudp_sock
;

15 
	es_m‘hod
 {

16 
	mTLS_METHOD_SSLV23
,

17 
	mTLS_METHOD_DTLSV1
,

18 
	mTLS_METHOD_DTLS
,

19 
	mTLS_METHOD_DTLSV1_2
,

22 
	es_fšg”´št
 {

23 
	mTLS_FINGERPRINT_SHA1
,

24 
	mTLS_FINGERPRINT_SHA256
,

27 
	es_keyty³
 {

28 
	mTLS_KEYTYPE_RSA
,

29 
	mTLS_KEYTYPE_EC
,

33 
s_®loc
(
s
 **
¥
, 
s_m‘hod
 
m‘hod
, cÚ¡ *
keyfe
,

34 cÚ¡ *
pwd
);

35 
s_add_ÿ
(
s
 *s, cÚ¡ *
ÿ·th
);

36 
s_£t_£lfsigÃd
(
s
 *s, cÚ¡ *
ú
);

37 
s_£t_û¹ifiÿ‹_³m
(
s
 *s, cÚ¡ *
û¹
, 
size_t
 
Ën_û¹
,

38 cÚ¡ *
key
, 
size_t
 
Ën_key
);

39 
s_£t_û¹ifiÿ‹_d”
(
s
 *s, 
s_keyty³
 
keyty³
,

40 cÚ¡ 
ušt8_t
 *
û¹
, 
size_t
 
Ën_û¹
,

41 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
Ën_key
);

42 
s_£t_û¹ifiÿ‹
(
s
 *s, cÚ¡ *
û¹
, 
size_t
 
Ën
);

43 
s_£t_v”ify_ş›Á
(
s
 *tls);

44 
s_£t_¤
(
s
 *s, cÚ¡ *
su™es
);

45 
s_fšg”´št
(cÚ¡ 
s
 *s, s_fšg”´šˆ
ty³
,

46 
ušt8_t
 *
md
, 
size_t
 
size
);

48 
s_³”_fšg”´št
(cÚ¡ 
s_cÚn
 *
tc
, 
s_fšg”´št
 
ty³
,

49 
ušt8_t
 *
md
, 
size_t
 
size
);

50 
s_³”_commÚ_Çme
(cÚ¡ 
s_cÚn
 *
tc
, *
ú
, 
size_t
 
size
);

51 
s_³”_v”ify
(cÚ¡ 
s_cÚn
 *
tc
);

52 
s_¤_keyšfo
(cÚ¡ 
s_cÚn
 *
tc
, 
¤_su™e
 *
su™e
,

53 
ušt8_t
 *
şi_key
, 
size_t
 
şi_key_size
,

54 
ušt8_t
 *
¤v_key
, 
size_t
 
¤v_key_size
);

55 cÚ¡ *
s_ch”_Çme
(cÚ¡ 
s_cÚn
 *
tc
);

56 
s_£t_ch”s
(
s
 *s, cÚ¡ *
ch”v
[], 
size_t
 
couÁ
);

57 
s_£t_£rv”Çme
(
s_cÚn
 *
tc
, cÚ¡ *
£rv”Çme
);

62 
s_¡¬t_tı
(
s_cÚn
 **
±c
, 
s
 *tls,

63 
tı_cÚn
 *
tı
, 
Ïy”
);

68 (
	tds_cÚn_h
)(cÚ¡ 
	t§
 *
	t³”
, *
	t¬g
);

69 (
	tds_e¡ab_h
)(*
	t¬g
);

70 (
	tds_»cv_h
)(
	tmbuf
 *
	tmb
, *
	t¬g
);

71 (
	tds_şo£_h
)(
	t”r
, *
	t¬g
);

73 
ds_sock
;

75 
	`ds_li¡’
(
ds_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

76 
udp_sock
 *
us
, 
ušt32_t
 
htsize
, 
Ïy”
,

77 
ds_cÚn_h
 *
cÚnh
, *
¬g
);

78 
udp_sock
 *
	`ds_udp_sock
(
ds_sock
 *
sock
);

79 
	`ds_£t_mtu
(
ds_sock
 *
sock
, 
size_t
 
mtu
);

80 
	`ds_cÚÃù
(
s_cÚn
 **
±c
, 
s
 *tls,

81 
ds_sock
 *
sock
, cÚ¡ 
§
 *
³”
,

82 
ds_e¡ab_h
 *
e¡abh
, 
ds_»cv_h
 *
»cvh
,

83 
ds_şo£_h
 *
şo£h
, *
¬g
);

84 
	`ds_acû±
(
s_cÚn
 **
±c
, 
s
 *tls,

85 
ds_sock
 *
sock
,

86 
ds_e¡ab_h
 *
e¡abh
, 
ds_»cv_h
 *
»cvh
,

87 
ds_şo£_h
 *
şo£h
, *
¬g
);

88 
	`ds_£nd
(
s_cÚn
 *
tc
, 
mbuf
 *
mb
);

89 
	`ds_£t_hªdËrs
(
s_cÚn
 *
tc
, 
ds_e¡ab_h
 *
e¡abh
,

90 
ds_»cv_h
 *
»cvh
, 
ds_şo£_h
 *
şo£h
, *
¬g
);

91 cÚ¡ 
§
 *
	`ds_³”
(cÚ¡ 
s_cÚn
 *
tc
);

92 
	`ds_£t_³”
(
s_cÚn
 *
tc
, cÚ¡ 
§
 *
³”
);

93 
	`ds_»cv_·ck‘
(
ds_sock
 *
sock
, cÚ¡ 
§
 *
¤c
,

94 
mbuf
 *
mb
);

97 #ifdeà
USE_OPENSSL


98 
s¦_ùx_¡
;

100 
s¦_ùx_¡
 *
	`s_İ’s¦_cÚ‹xt
(cÚ¡ 
s
 *tls);

	@re-0.5.6/include/re_tmr.h

13 (
	ttmr_h
)(*
	t¬g
);

16 
	stmr
 {

17 
Ë
†e;

18 
tmr_h
 *
th
;

19 *
¬g
;

20 
ušt64_t
 
jfs
;

24 
	`tmr_pŞl
(
li¡
 *
tm¾
);

25 
ušt64_t
 
	`tmr_jiff›s
();

26 
ušt64_t
 
	`tmr_Ãxt_timeout
(
li¡
 *
tm¾
);

27 
	`tmr_debug
();

28 
	`tmr_¡©us
(
»_´štf
 *
pf
, *
unu£d
);

30 
	`tmr_š™
(
tmr
 *tmr);

31 
	`tmr_¡¬t
(
tmr
 *tmr, 
ušt64_t
 
d–ay
, 
tmr_h
 *
th
, *
¬g
);

32 
	`tmr_ÿnûl
(
tmr
 *tmr);

33 
ušt64_t
 
	`tmr_g‘_expœe
(cÚ¡ 
tmr
 *tmr);

43 
šlše
 
boŞ
 
	$tmr_i¤uÂšg
(cÚ¡ 
tmr
 *tmr)

45  
tmr
 ? 
NULL
 !ğtmr->
th
 : 
çl£
;

46 
	}
}

	@re-0.5.6/include/re_turn.h

10 
	mTURN_DEFAULT_LIFETIME
 = 600,

11 
	mTURN_MAX_LIFETIME
 = 3600

14 (
	ttuºc_h
)(
	t”r
, 
	tušt16_t
 
	tscode
, cÚ¡ *
	t»asÚ
,

15 cÚ¡ 
	t§
 *
	t»Ïy_addr
,

16 cÚ¡ 
	t§
 *
	tm­³d_addr
,

17 cÚ¡ 
	t¡un_msg
 *
	tmsg
,

18 *
	t¬g
);

19 (
	ttuºc_³rm_h
)(*
	t¬g
);

20 (
	ttuºc_chª_h
)(*
	t¬g
);

22 
tuºc
;

24 
	`tuºc_®loc
(
tuºc
 **
tuºı
, cÚ¡ 
¡un_cÚf
 *
cÚf
, 
´Ùo
,

25 *
sock
, 
Ïy”
, cÚ¡ 
§
 *
¤v
,

26 cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
,

27 
ušt32_t
 
liãtime
, 
tuºc_h
 *
th
, *
¬g
);

28 
	`tuºc_£nd
(
tuºc
 *tuºc, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

29 
	`tuºc_»cv
(
tuºc
 *tuºc, 
§
 *
¤c
, 
mbuf
 *
mb
);

30 
	`tuºc_add_³rm
(
tuºc
 *tuºc, cÚ¡ 
§
 *
³”
,

31 
tuºc_³rm_h
 *
ph
, *
¬g
);

32 
	`tuºc_add_chª
(
tuºc
 *tuºc, cÚ¡ 
§
 *
³”
,

33 
tuºc_chª_h
 *
ch
, *
¬g
);

	@re-0.5.6/include/re_types.h

7 
	~<sys/ty³s.h
>

9 #ifdeà
_MSC_VER


10 
	~<¡dlib.h
>

17 #ifdeà
HAVE_INTTYPES_H


18 
	~<š‰y³s.h
>

21 #iâdeà
__št8_t_defšed


22 
	#__št8_t_defšed


	)

25 #iâdeà
__BIT_TYPES_DEFINED__


27 #ià
defšed
(
_CHAR_IS_SIGNED
)

28 
	tšt8_t
;

29 #–ià
defšed
(
__STDC__
)

30 sigÃd 
	tšt8_t
;

32 
	tšt8_t
;

35 sigÃd 
	tšt16_t
;

36 sigÃd 
	tšt32_t
;

37 sigÃd 
	tšt64_t
;

39 #iâdeà
__ušt32_t_defšed


40 
	#__ušt32_t_defšed


	)

41 
	tušt8_t
;

42 
	tušt16_t
;

43 
	tušt32_t
;

44 
	tušt64_t
;

50 #iâdeà
__ssize_t_defšed


51 
	tssize_t
;

52 
	#__ssize_t_defšed


	)

56 #iâdeà
WIN32


57 
ušt32_t
 
	tsockËn_t
;

65 #ifdeà
SOLARIS


66 #ià!(
__STDC__
 - 0 =ğ0 && !
defšed
(
_NO_LONGLONG
))

67 sigÃd 
	tšt64_t
;

68 
	tušt64_t
;

78 #ifdeà
HAVE_STDBOOL_H


79 
	~<¡dboŞ.h
>

81 #iâdeà
HAVE__BOOL


82 #ifdeà
__ılu¥lus


83 
boŞ
 
	t_BoŞ
;

85 
	#_BoŞ
 sigÃd 

	)

88 
	#boŞ
 
_BoŞ


	)

89 
	#çl£
 0

	)

90 
	#Œue
 1

	)

91 
	#__boŞ_Œue_çl£_¬e_defšed
 1

	)

95 #ifdeà
_MSC_VER


96 
	#šlše
 
_šlše


	)

105 #iâdeà
NULL


106 
	#NULL
 ((*)0)

	)

110 #undeà
ARRAY_SIZE


111 
	#ARRAY_SIZE
(
a
è((×))/((×)[0])))

	)

114 
	#ALIGN_MASK
(
x
, 
mask
è(((x)+(mask))&~(mask))

	)

118 #undeà
MIN


119 
	#MIN
(
a
,
b
è((×)<(b)è? (aè: (b))

	)

122 #undeà
MAX


123 
	#MAX
(
a
,
b
è((×)>(b)è? (aè: (b))

	)

125 #iâdeà
__ılu¥lus


128 #undeà
mš


129 
	#mš
(
x
,
y
è
	`MIN
(x, y)

	)

132 #undeà
max


133 
	#max
(
x
,
y
è
	`MAX
(x, y)

	)

138 #ià(
defšed
(
__i386__
è|| defšed(
__x86_64__
))

139 
	#BREAKPOINT
 
	`__asm__
("šˆ$0x03")

	)

141 
	#BREAKPOINT


	)

146 
	~<”ºo.h
>

151 #iâdeà
ENODATA


152 
	#ENODATA
 200

	)

156 #iâdeà
EPROTO


157 
	#EPROTO
 201

	)

161 #iâdeà
EBADMSG


162 
	#EBADMSG
 202

	)

166 #iâdeà
EOVERFLOW


167 
	#EOVERFLOW
 203

	)

171 #iâdeà
ELIBBAD


172 
	#ELIBBAD
 204

	)

176 #iâdeà
EDESTADDRREQ


177 
	#EDESTADDRREQ
 205

	)

181 #iâdeà
EPROTONOSUPPORT


182 
	#EPROTONOSUPPORT
 206

	)

186 #iâdeà
ENOTSUP


187 
	#ENOTSUP
 207

	)

191 #iâdeà
EAFNOSUPPORT


192 
	#EAFNOSUPPORT
 208

	)

196 #iâdeà
EADDRNOTAVAIL


197 
	#EADDRNOTAVAIL
 209

	)

201 #iâdeà
ECONNABORTED


202 
	#ECONNABORTED
 210

	)

206 #iâdeà
ECONNRESET


207 
	#ECONNRESET
 211

	)

211 #iâdeà
ENOTCONN


212 
	#ENOTCONN
 212

	)

216 #iâdeà
ETIMEDOUT


217 
	#ETIMEDOUT
 213

	)

221 #iâdeà
ECONNREFUSED


222 
	#ECONNREFUSED
 214

	)

226 #iâdeà
EALREADY


227 
	#EALREADY
 215

	)

231 #iâdeà
EINPROGRESS


232 
	#EINPROGRESS
 216

	)

236 #iâdeà
EAUTH


237 
	#EAUTH
 217

	)

241 #iâdeà
ENOSR


242 
	#ENOSR
 218

	)

249 #ià
__STDC_VERSION__
 >= 199901L

250 
	#__REFUNC__
 (cÚ¡ *)
__func__


	)

252 
	#__REFUNC__
 
__FUNCTION__


	)

	@re-0.5.6/include/re_udp.h

8 
	g§
;

9 
	gudp_sock
;

19 (
	tudp_»cv_h
)(cÚ¡ 
	t§
 *
	t¤c
, 
	tmbuf
 *
	tmb
, *
	t¬g
);

20 (
	tudp_”rÜ_h
)(
	t”r
, *
	t¬g
);

23 
	`udp_li¡’
(
udp_sock
 **
u¥
, cÚ¡ 
§
 *
loÿl
,

24 
udp_»cv_h
 *
rh
, *
¬g
);

25 
	`udp_cÚÃù
(
udp_sock
 *
us
, cÚ¡ 
§
 *
³”
);

26 
	`udp_£nd
(
udp_sock
 *
us
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

27 
	`udp_£nd_ªÚ
(cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

28 
	`udp_loÿl_g‘
(cÚ¡ 
udp_sock
 *
us
, 
§
 *
loÿl
);

29 
	`udp_£tsockİt
(
udp_sock
 *
us
, 
Ëv–
, 
İŠame
,

30 cÚ¡ *
İtv®
, 
ušt32_t
 
İ’
);

31 
	`udp_sockbuf_£t
(
udp_sock
 *
us
, 
size
);

32 
	`udp_rxsz_£t
(
udp_sock
 *
us
, 
size_t
 
rxsz
);

33 
	`udp_rxbuf_´esz_£t
(
udp_sock
 *
us
, 
size_t
 
rx_´esz
);

34 
	`udp_hªdËr_£t
(
udp_sock
 *
us
, 
udp_»cv_h
 *
rh
, *
¬g
);

35 
	`udp_”rÜ_hªdËr_£t
(
udp_sock
 *
us
, 
udp_”rÜ_h
 *
eh
);

36 
	`udp_th»ad_©ch
(
udp_sock
 *
us
);

37 
	`udp_th»ad_d‘ach
(
udp_sock
 *
us
);

38 
	`udp_sock_fd
(cÚ¡ 
udp_sock
 *
us
, 
af
);

40 
	`udp_muÉiÿ¡_još
(
udp_sock
 *
us
, cÚ¡ 
§
 *
group
);

41 
	`udp_muÉiÿ¡_Ëave
(
udp_sock
 *
us
, cÚ¡ 
§
 *
group
);

45 
	$boŞ
 (
	tudp_h–³r_£nd_h
)(*
	t”r
, 
	t§
 *
	td¡
,

46 
	tmbuf
 *
	tmb
, *
	t¬g
);

47 
	$boŞ
 (
	tudp_h–³r_»cv_h
)(
	t§
 *
	t¤c
,

48 
	tmbuf
 *
	tmb
, *
	t¬g
);

50 
udp_h–³r
;

53 
	`udp_»gi¡”_h–³r
(
udp_h–³r
 **
uhp
, 
udp_sock
 *
us
,

54 
Ïy”
,

55 
udp_h–³r_£nd_h
 *
sh
, 
udp_h–³r_»cv_h
 *
rh
,

56 *
¬g
);

57 
	`udp_£nd_h–³r
(
udp_sock
 *
us
, cÚ¡ 
§
 *
d¡
,

58 
mbuf
 *
mb
, 
udp_h–³r
 *
uh
);

59 
udp_h–³r
 *
	`udp_h–³r_fšd
(cÚ¡ 
udp_sock
 *
us
, 
Ïy”
);

	@re-0.5.6/include/re_uri.h

9 
	suri
 {

10 
¶
 
	mscheme
;

11 
¶
 
	mu£r
;

12 
¶
 
	m·sswÜd
;

13 
¶
 
	mho¡
;

14 
	maf
;

15 
ušt16_t
 
	mpÜt
;

16 
¶
 
	m·¿ms
;

17 
¶
 
	mh—d”s
;

20 (
	turi_­¶y_h
)(cÚ¡ 
	t¶
 *
	tÇme
, cÚ¡ ¶ *
	tv®
,

21 *
	t¬g
);

23 
»_´štf
;

24 
	`uri_’code
(
»_´štf
 *
pf
, cÚ¡ 
uri
 *uri);

25 
	`uri_decode
(
uri
 *uri, cÚ¡ 
¶
 *pl);

26 
	`uri_·¿m_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ ¶ *
²ame
,

27 
¶
 *
pv®ue
);

28 
	`uri_·¿ms_­¶y
(cÚ¡ 
¶
 *¶, 
uri_­¶y_h
 *
ah
, *
¬g
);

29 
	`uri_h—d”_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ ¶ *
hÇme
,

30 
¶
 *
hv®ue
);

31 
	`uri_h—d”s_­¶y
(cÚ¡ 
¶
 *¶, 
uri_­¶y_h
 *
ah
, *
¬g
);

32 
boŞ
 
	`uri_cmp
(cÚ¡ 
uri
 *
l
, cÚ¡ ur˜*
r
);

36 
	`uri_u£r_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

37 
	`uri_u£r_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

38 
	`uri_·sswÜd_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

39 
	`uri_·sswÜd_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

40 
	`uri_·¿m_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

41 
	`uri_·¿m_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

42 
	`uri_h—d”_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

43 
	`uri_h—d”_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl);

	@re-0.5.6/include/re_websock.h

9 
	mWEBSOCK_VERSION
 = 13,

12 
	ewebsock_İcode
 {

14 
	mWEBSOCK_CONT
 = 0x0,

15 
	mWEBSOCK_TEXT
 = 0x1,

16 
	mWEBSOCK_BIN
 = 0x2,

18 
	mWEBSOCK_CLOSE
 = 0x8,

19 
	mWEBSOCK_PING
 = 0x9,

20 
	mWEBSOCK_PONG
 = 0xa,

23 
	ewebsock_scode
 {

24 
	mWEBSOCK_NORMAL_CLOSURE
 = 1000,

25 
	mWEBSOCK_GOING_AWAY
 = 1001,

26 
	mWEBSOCK_PROTOCOL_ERROR
 = 1002,

27 
	mWEBSOCK_UNSUPPORTED_DATA
 = 1003,

28 
	mWEBSOCK_INVALID_PAYLOAD
 = 1007,

29 
	mWEBSOCK_POLICY_VIOLATION
 = 1008,

30 
	mWEBSOCK_MESSAGE_TOO_BIG
 = 1009,

31 
	mWEBSOCK_EXTENSION_ERROR
 = 1010,

32 
	mWEBSOCK_INTERNAL_ERROR
 = 1011,

35 
	swebsock_hdr
 {

36 
	mfš
:1;

37 
	mrsv1
:1;

38 
	mrsv2
:1;

39 
	mrsv3
:1;

40 
	mİcode
:4;

41 
	mmask
:1;

42 
ušt64_t
 
	mËn
;

43 
ušt8_t
 
	mmkey
[4];

46 
	gwebsock
;

47 
	gwebsock_cÚn
;

49 (
	twebsock_e¡ab_h
)(*
	t¬g
);

50 (
	twebsock_»cv_h
)(cÚ¡ 
	twebsock_hdr
 *
	thdr
, 
	tmbuf
 *
	tmb
,

51 *
	t¬g
);

52 (
	twebsock_şo£_h
)(
	t”r
, *
	t¬g
);

55 
	`websock_cÚÃù
(
websock_cÚn
 **
cÚÅ
, 
websock
 *
sock
,

56 
h‰p_şi
 *
şi
, cÚ¡ *
uri
, 
kašt
,

57 
websock_e¡ab_h
 *
e¡abh
, 
websock_»cv_h
 *
»cvh
,

58 
websock_şo£_h
 *
şo£h
, *
¬g
,

59 cÚ¡ *
fmt
, ...);

60 
	`websock_acû±
(
websock_cÚn
 **
cÚÅ
, 
websock
 *
sock
,

61 
h‰p_cÚn
 *
htcÚn
, cÚ¡ 
h‰p_msg
 *
msg
,

62 
kašt
, 
websock_»cv_h
 *
»cvh
,

63 
websock_şo£_h
 *
şo£h
, *
¬g
);

64 
	`websock_£nd
(
websock_cÚn
 *
cÚn
, 
websock_İcode
 
İcode
,

65 cÚ¡ *
fmt
, ...);

66 
	`websock_şo£
(
websock_cÚn
 *
cÚn
, 
websock_scode
 
scode
,

67 cÚ¡ *
fmt
, ...);

68 cÚ¡ 
§
 *
	`websock_³”
(cÚ¡ 
websock_cÚn
 *
cÚn
);

70 (
	twebsock_shutdown_h
)(*
	t¬g
);

72 
	`websock_®loc
(
websock
 **
sockp
, 
websock_shutdown_h
 *
shuth
,

73 *
¬g
);

74 
	`websock_shutdown
(
websock
 *
sock
);

	@re-0.5.6/src/aes/apple/aes.c

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_mem.h
>

10 
	~<»_fmt.h
>

11 
	~<»_«s.h
>

12 
	~<CommÚCry±o/CommÚCry±Ü.h
>

15 
	s«s
 {

16 
CCCry±ÜRef
 
	müy±Ü
;

17 
ušt8_t
 
	mkey
[64];

18 
size_t
 
	mkey_by‹s
;

22 
	$de¡ruùÜ
(*
¬g
)

24 
«s
 *
¡
 = 
¬g
;

26 ià(
¡
->
üy±Ü
)

27 
	`CCCry±ÜR–—£
(
¡
->
üy±Ü
);

28 
	}
}

31 
	$«s_®loc
(
«s
 **
¡p
, 
«s_mode
 
mode
,

32 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b™s
,

33 cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

35 
«s
 *
¡
;

36 
size_t
 
key_by‹s
 = 
key_b™s
 / 8;

37 
CCCry±ÜStus
 
¡©us
;

38 
”r
 = 0;

40 ià(!
¡p
 || !
key
)

41  
EINVAL
;

43 ià(
mode
 !ğ
AES_MODE_CTR
)

44  
ENOTSUP
;

46 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

47 ià(!
¡
)

48  
ENOMEM
;

50 ià(
key_by‹s
 > (
¡
->
key
)) {

51 
”r
 = 
EINVAL
;

52 
out
;

55 
¡
->
key_by‹s
 = key_bytes;

56 
	`memıy
(
¡
->
key
, key, st->
key_by‹s
);

59 
¡©us
 = 
	`CCCry±ÜC»©eW™hMode
(
kCCEnüy±
, 
kCCModeCTR
,

60 
kCCAlgÜ™hmAES
, 
ccNoPaddšg
,

61 
iv
, 
key
, 
key_by‹s
, 
NULL
, 0, 0,

62 
kCCModeO±iÚCTR_BE
, &
¡
->
üy±Ü
);

63 ià(
¡©us
 !ğ
kCCSucûss
) {

64 
”r
 = 
EPROTO
;

65 
out
;

68 
out
:

69 ià(
”r
)

70 
	`mem_d”ef
(
¡
);

72 *
¡p
 = 
¡
;

74  
”r
;

75 
	}
}

78 
	$«s_£t_iv
(
«s
 *
¡
, cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

80 
CCCry±ÜStus
 
¡©us
;

82 ià(!
¡
)

86 ià(
¡
->
üy±Ü
) {

87 
	`CCCry±ÜR–—£
(
¡
->
üy±Ü
);

88 
¡
->
üy±Ü
 = 
NULL
;

91 
¡©us
 = 
	`CCCry±ÜC»©eW™hMode
(
kCCEnüy±
, 
kCCModeCTR
,

92 
kCCAlgÜ™hmAES
, 
ccNoPaddšg
,

93 
iv
, 
¡
->
key
, st->
key_by‹s
,

94 
NULL
, 0, 0, 
kCCModeO±iÚCTR_BE
,

95 &
¡
->
üy±Ü
);

96 ià(
¡©us
 !ğ
kCCSucûss
) {

97 
	`»_årštf
(
¡d”r
, "aes: CCCryptorCreateWithModeƒrror (%d)\n",

98 
¡©us
);

100 
	}
}

103 
	$«s_’ü
(
«s
 *
¡
, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

105 
CCCry±ÜStus
 
¡©us
;

106 
size_t
 
moved
;

108 ià(!
¡
 || !
out
 || !
š
)

109  
EINVAL
;

111 
¡©us
 = 
	`CCCry±ÜUpd©e
(
¡
->
üy±Ü
, 
š
, 
Ën
, 
out
,†’, &
moved
);

112 ià(
¡©us
 !ğ
kCCSucûss
) {

113 
	`»_årštf
(
¡d”r
, "aes: CCCryptorUpdateƒrror (%d)\n",

114 
¡©us
);

115  
EPROTO
;

119 
	}
}

122 
	$«s_deü
(
«s
 *
¡
, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

124  
	`«s_’ü
(
¡
, 
out
, 
š
, 
Ën
);

125 
	}
}

	@re-0.5.6/src/aes/openssl/aes.c

6 
	~<¡ršg.h
>

7 
	~<İ’s¦/«s.h
>

8 
	~<İ’s¦/evp.h
>

9 
	~<İ’s¦/”r.h
>

10 
	~<»_ty³s.h
>

11 
	~<»_fmt.h
>

12 
	~<»_mem.h
>

13 
	~<»_«s.h
>

16 #ifdeà
EVP_CIPH_CTR_MODE


19 
	s«s
 {

20 
EVP_CIPHER_CTX
 *
	mùx
;

24 
	$de¡ruùÜ
(*
¬g
)

26 
«s
 *
¡
 = 
¬g
;

28 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L

29 ià(
¡
->
ùx
)

30 
	`EVP_CIPHER_CTX_ä“
(
¡
->
ùx
);

32 ià(
¡
->
ùx
)

33 
	`EVP_CIPHER_CTX_ş—nup
(
¡
->
ùx
);

34 
	`mem_d”ef
(
¡
->
ùx
);

36 
	}
}

39 
	$«s_®loc
(
«s
 **
«¥
, 
«s_mode
 
mode
,

40 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b™s
,

41 cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

43 cÚ¡ 
EVP_CIPHER
 *
ch”
;

44 
«s
 *
¡
;

45 
”r
 = 0, 
r
;

47 ià(!
«¥
 || !
key
)

48  
EINVAL
;

50 ià(
mode
 !ğ
AES_MODE_CTR
)

51  
ENOTSUP
;

53 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

54 ià(!
¡
)

55  
ENOMEM
;

57 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L

58 
¡
->
ùx
 = 
	`EVP_CIPHER_CTX_Ãw
();

59 ià(!
¡
->
ùx
) {

60 
	`ERR_ş—r_”rÜ
();

61 
”r
 = 
ENOMEM
;

62 
out
;

66 
¡
->
ùx
 = 
	`mem_z®loc
((*¡->ùx), 
NULL
);

67 ià(!
¡
->
ùx
) {

68 
”r
 = 
ENOMEM
;

69 
out
;

72 
	`EVP_CIPHER_CTX_š™
(
¡
->
ùx
);

75 
key_b™s
) {

77 128: 
ch”
 = 
	`EVP_«s_128_ùr
(); ;

78 192: 
ch”
 = 
	`EVP_«s_192_ùr
(); ;

79 256: 
ch”
 = 
	`EVP_«s_256_ùr
(); ;

81 
	`»_årštf
(
¡d”r
, "«s: unknowÀkey: %zu b™s\n", 
key_b™s
);

82 
”r
 = 
EINVAL
;

83 
out
;

86 
r
 = 
	`EVP_Enüy±In™_ex
(
¡
->
ùx
, 
ch”
, 
NULL
, 
key
, 
iv
);

87 ià(!
r
) {

88 
	`ERR_ş—r_”rÜ
();

89 
”r
 = 
EPROTO
;

92 
out
:

93 ià(
”r
)

94 
	`mem_d”ef
(
¡
);

96 *
«¥
 = 
¡
;

98  
”r
;

99 
	}
}

102 
	$«s_£t_iv
(
«s
 *«s, cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

104 
r
;

106 ià(!
«s
 || !
iv
)

109 
r
 = 
	`EVP_Enüy±In™_ex
(
«s
->
ùx
, 
NULL
, NULL, NULL, 
iv
);

110 ià(!
r
)

111 
	`ERR_ş—r_”rÜ
();

112 
	}
}

115 
	$«s_’ü
(
«s
 *«s, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

117 
c_Ën
 = ()
Ën
;

119 ià(!
«s
 || !
out
 || !
š
)

120  
EINVAL
;

122 ià(!
	`EVP_Enüy±Upd©e
(
«s
->
ùx
, 
out
, &
c_Ën
, 
š
, ()
Ën
)) {

123 
	`ERR_ş—r_”rÜ
();

124  
EPROTO
;

128 
	}
}

134 
	s«s
 {

135 
AES_KEY
 
	mkey
;

136 
ušt8_t
 
	miv
[
AES_BLOCK_SIZE
];

140 
	$de¡ruùÜ
(*
¬g
)

142 
«s
 *
¡
 = 
¬g
;

144 
	`mem£t
(&
¡
->
key
, 0, (st->key));

145 
	}
}

148 
	$«s_®loc
(
«s
 **
«¥
, 
«s_mode
 
mode
,

149 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b™s
,

150 cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

152 
«s
 *
¡
;

153 
”r
 = 0, 
r
;

155 ià(!
«¥
 || !
key
)

156  
EINVAL
;

158 ià(
mode
 !ğ
AES_MODE_CTR
)

159  
ENOTSUP
;

161 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

162 ià(!
¡
)

163  
ENOMEM
;

165 
r
 = 
	`AES_£t_’üy±_key
(
key
, ()
key_b™s
, &
¡
->key);

166 ià(
r
 != 0) {

167 
”r
 = 
EPROTO
;

168 
out
;

170 ià(
iv
)

171 
	`memıy
(
¡
->
iv
, iv, (st->iv));

173 
out
:

174 ià(
”r
)

175 
	`mem_d”ef
(
¡
);

177 *
«¥
 = 
¡
;

179  
”r
;

180 
	}
}

183 
	$«s_£t_iv
(
«s
 *«s, cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

185 ià(!
«s
)

188 ià(
iv
)

189 
	`memıy
(
«s
->
iv
, iv, (aes->iv));

190 
	}
}

193 
	$«s_’ü
(
«s
 *«s, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

195 
ec
[
AES_BLOCK_SIZE
] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

196 
num
 = 0;

198 ià(!
«s
 || !
out
 || !
š
)

199  
EINVAL
;

201 
	`AES_ùr128_’üy±
(
š
, 
out
, 
Ën
, &
«s
->
key
,‡es->
iv
, 
ec
, &
num
);

204 
	}
}

215 
	$«s_deü
(
«s
 *«s, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

217  
	`«s_’ü
(
«s
, 
out
, 
š
, 
Ën
);

218 
	}
}

	@re-0.5.6/src/aes/stub.c

6 
	~<»_ty³s.h
>

7 
	~<»_«s.h
>

10 
	$«s_®loc
(
«s
 **
¡p
, 
«s_mode
 
mode
,

11 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b™s
,

12 cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

14 ()
¡p
;

15 ()
mode
;

16 ()
key
;

17 ()
key_b™s
;

18 ()
iv
;

19  
ENOSYS
;

20 
	}
}

23 
	$«s_£t_iv
(
«s
 *
¡
, cÚ¡ 
ušt8_t
 
iv
[
AES_BLOCK_SIZE
])

25 ()
¡
;

26 ()
iv
;

27 
	}
}

30 
	$«s_’ü
(
«s
 *
¡
, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

32 ()
¡
;

33 ()
out
;

34 ()
š
;

35 ()
Ën
;

36  
ENOSYS
;

37 
	}
}

40 
	$«s_deü
(
«s
 *
¡
, 
ušt8_t
 *
out
, cÚ¡ ušt8_ˆ*
š
, 
size_t
 
Ën
)

42 ()
¡
;

43 ()
out
;

44 ()
š
;

45 ()
Ën
;

46  
ENOSYS
;

47 
	}
}

	@re-0.5.6/src/base64/b64.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_ba£64.h
>

11 cÚ¡ 
	gb64_bË
[65] =

27 
	$ba£64_’code
(cÚ¡ 
ušt8_t
 *
š
, 
size_t
 
’
, *
out
, size_ˆ*
Ş’
)

29 cÚ¡ 
ušt8_t
 *
š_’d
 = 
š
 + 
’
;

30 cÚ¡ *
o
 = 
out
;

32 ià(!
š
 || !
out
 || !
Ş’
)

33  
EINVAL
;

35 ià(*
Ş’
 < 4 * ((
’
+2)/3))

36  
EOVERFLOW
;

38 ; 
š
 < 
š_’d
; ) {

39 
ušt32_t
 
v
;

40 
·d
 = 0;

42 
v
 = *
š
++ << 16;

43 ià(
š
 < 
š_’d
) {

44 
v
 |ğ*
š
++ << 8;

47 ++
·d
;

49 ià(
š
 < 
š_’d
) {

50 
v
 |ğ*
š
++ << 0;

53 ++
·d
;

56 *
out
++ = 
b64_bË
[
v
>>18 & 0x3f];

57 *
out
++ = 
b64_bË
[
v
>>12 & 0x3f];

58 *
out
++ = (
·d
 >ğ2è? '=' : 
b64_bË
[
v
>>6 & 0x3f];

59 *
out
++ = (
·d
 >ğ1è? '=' : 
b64_bË
[
v
>>0 & 0x3f];

62 *
Ş’
 = 
out
 - 
o
;

65 
	}
}

68 
	$ba£64_´št
(
»_´štf
 *
pf
, cÚ¡ 
ušt8_t
 *
±r
, 
size_t
 
Ën
)

70 
buf
[256];

72 ià(!
pf
 || !
±r
)

73  
EINVAL
;

75 
Ën
 > 0) {

76 
size_t
 
l
, 
sz
 = (
buf
);

77 
”r
;

79 
l
 = 
	`mš
(
Ën
, 3 * ((
buf
)/4));

81 
”r
 = 
	`ba£64_’code
(
±r
, 
l
, 
buf
, &
sz
);

82 ià(
”r
)

83  
”r
;

85 
”r
 = 
pf
->
	`vph
(
buf
, 
sz
,…f->
¬g
);

86 ià(
”r
)

87  
”r
;

89 
±r
 +ğ
l
;

90 
Ën
 -ğ
l
;

94 
	}
}

98 
šlše
 
ušt32_t
 
	$b64v®
(
c
)

100 ià('A' <ğ
c
 && c <= 'Z')

101  
c
 - 'A' + 0;

102 ià('a' <ğ
c
 && c <= 'z')

103  
c
 - 'a' + 26;

104 ià('0' <ğ
c
 && c <= '9')

105  
c
 - '0' + 52;

106 ià('+' =ğ
c
)

108 ià('/' =ğ
c
)

110 ià('=' =ğ
c
)

114 
	}
}

127 
	$ba£64_decode
(cÚ¡ *
š
, 
size_t
 
’
, 
ušt8_t
 *
out
, size_ˆ*
Ş’
)

129 cÚ¡ *
š_’d
 = 
š
 + 
’
;

130 cÚ¡ 
ušt8_t
 *
o
 = 
out
;

132 ià(!
š
 || !
out
 || !
Ş’
)

133  
EINVAL
;

135 ià(*
Ş’
 < 3 * (
’
/4))

136  
EOVERFLOW
;

138 ;
š
+3 < 
š_’d
; ) {

139 
ušt32_t
 
v
;

141 
v
 = 
	`b64v®
(*
š
++) << 18;

142 
v
 |ğ
	`b64v®
(*
š
++) << 12;

143 
v
 |ğ
	`b64v®
(*
š
++) << 6;

144 
v
 |ğ
	`b64v®
(*
š
++) << 0;

146 *
out
++ = 
v
>>16;

147 ià(!(
v
 & (1<<30)))

148 *
out
++ = (
v
>>8) & 0xff;

149 ià(!(
v
 & (1<<24)))

150 *
out
++ = (
v
>>0) & 0xff;

153 *
Ş’
 = 
out
 - 
o
;

156 
	}
}

	@re-0.5.6/src/bfcp/attr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_li¡.h
>

13 
	~<»_tmr.h
>

14 
	~<»_bfı.h
>

15 
	~"bfı.h
"

19 
	mBFCP_ATTR_HDR_SIZE
 = 2,

23 
	$de¡ruùÜ
(*
¬g
)

25 
bfı_©Œ
 *
©Œ
 = 
¬g
;

27 
©Œ
->
ty³
) {

29 
BFCP_ERROR_CODE
:

30 
	`mem_d”ef
(
©Œ
->
v
.
”rcode
.
d‘as
);

33 
BFCP_ERROR_INFO
:

34 
BFCP_PART_PROV_INFO
:

35 
BFCP_STATUS_INFO
:

36 
BFCP_USER_DISP_NAME
:

37 
BFCP_USER_URI
:

38 
	`mem_d”ef
(
©Œ
->
v
.
¡r
);

41 
BFCP_SUPPORTED_ATTRS
:

42 
	`mem_d”ef
(
©Œ
->
v
.
su·‰r
.
©Œv
);

45 
BFCP_SUPPORTED_PRIMS
:

46 
	`mem_d”ef
(
©Œ
->
v
.
suµrim
.
´imv
);

53 
	`li¡_æush
(&
©Œ
->
©Œl
);

54 
	`li¡_uÆšk
(&
©Œ
->
Ë
);

55 
	}
}

58 
	$©Œ_’code
(
mbuf
 *
mb
, 
boŞ
 
mªd
, 
bfı_©Œib
 
ty³
,

59 cÚ¡ *
v
)

61 cÚ¡ 
bfı_»q¡©us
 *
»q¡©us
 = 
v
;

62 cÚ¡ 
bfı_”rcode
 *
”rcode
 = 
v
;

63 cÚ¡ 
bfı_su·‰r
 *
su·‰r
 = 
v
;

64 cÚ¡ 
bfı_suµrim
 *
suµrim
 = 
v
;

65 cÚ¡ 
bfı_´iÜ™y
 *
´iÜ™y
 = 
v
;

66 cÚ¡ 
ušt16_t
 *
u16
 = 
v
;

67 
size_t
 
¡¬t
, 
Ën
, 
i
;

68 
”r
;

70 
¡¬t
 = 
mb
->
pos
;

71 
mb
->
pos
 +ğ
BFCP_ATTR_HDR_SIZE
;

73 
ty³
) {

75 
BFCP_BENEFICIARY_ID
:

76 
BFCP_FLOOR_ID
:

77 
BFCP_FLOOR_REQUEST_ID
:

78 
BFCP_BENEFICIARY_INFO
:

79 
BFCP_FLOOR_REQ_INFO
:

80 
BFCP_REQUESTED_BY_INFO
:

81 
BFCP_FLOOR_REQ_STATUS
:

82 
BFCP_OVERALL_REQ_STATUS
:

83 
”r
 = 
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(*
u16
));

86 
BFCP_PRIORITY
:

87 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, *
´iÜ™y
 << 5);

88 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

91 
BFCP_REQUEST_STATUS
:

92 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
»q¡©us
->
¡©us
);

93 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
»q¡©us
->
qpos
);

96 
BFCP_ERROR_CODE
:

97 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
”rcode
->
code
);

98 ià(
”rcode
->
d‘as
 &&ƒ¼code->
Ën
)

99 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
”rcode
->
d‘as
,

100 
”rcode
->
Ën
);

103 
BFCP_ERROR_INFO
:

104 
BFCP_PART_PROV_INFO
:

105 
BFCP_STATUS_INFO
:

106 
BFCP_USER_DISP_NAME
:

107 
BFCP_USER_URI
:

108 
”r
 = 
	`mbuf_wr™e_¡r
(
mb
, 
v
);

111 
BFCP_SUPPORTED_ATTRS
:

112 
i
=0, 
”r
=0; i<
su·‰r
->
©Œc
; i++)

113 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
su·‰r
->
©Œv
[
i
] << 1);

116 
BFCP_SUPPORTED_PRIMS
:

117 
i
=0, 
”r
=0; i<
suµrim
->
´imc
; i++)

118 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
suµrim
->
´imv
[
i
]);

122 
”r
 = 
EINVAL
;

127 
Ën
 = 
mb
->
pos
 - 
¡¬t
;

129 
mb
->
pos
 = 
¡¬t
;

130 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, (
ty³
<<1è| (
mªd
 ? 1 : 0));

131 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
Ën
);

132 
mb
->
pos
 +ğ(
Ën
 - 
BFCP_ATTR_HDR_SIZE
);

135 (
mb
->
pos
 - 
¡¬t
) & 0x03)

136 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

138  
”r
;

139 
	}
}

151 
	$bfı_©Œs_v’code
(
mbuf
 *
mb
, 
©Œc
, 
va_li¡
 *
­
)

153 
i
;

155 ià(!
mb
)

156  
EINVAL
;

158 
i
=0; i<
©Œc
; i++) {

160 
ty³
 = 
	`va_¬g
(*
­
, );

161 
subc
 = 
	`va_¬g
(*
­
, );

162 cÚ¡ *
v
 = 
	`va_¬g
(*
­
, const *);

163 
size_t
 
¡¬t
, 
Ën
;

164 
”r
;

166 ià(!
v
)

169 
¡¬t
 = 
mb
->
pos
;

171 ià(
ty³
 =ğ
BFCP_ENCODE_HANDLER
) {

173 cÚ¡ 
bfı_’code
 *
’c
 = 
v
;

175 ià(
’c
->
’ch
) {

176 
”r
 = 
’c
->
	`’ch
(
mb
,ƒnc->
¬g
);

177 ià(
”r
)

178  
”r
;

184 
”r
 = 
	`©Œ_’code
(
mb
, 
ty³
>>7,y³ & 0x7f, 
v
);

185 ià(
”r
)

186  
”r
;

188 ià(
subc
 == 0)

191 
”r
 = 
	`bfı_©Œs_v’code
(
mb
, 
subc
, 
­
);

192 ià(
”r
)

193  
”r
;

196 
Ën
 = 
mb
->
pos
 - 
¡¬t
;

198 
mb
->
pos
 = 
¡¬t
 + 1;

199 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, (
ušt8_t
)
Ën
);

200 ià(
”r
)

201  
”r
;

203 
mb
->
pos
 +ğ(
Ën
 - 
BFCP_ATTR_HDR_SIZE
);

207 
	}
}

218 
	$bfı_©Œs_’code
(
mbuf
 *
mb
, 
©Œc
, ...)

220 
va_li¡
 
­
;

221 
”r
;

223 
	`va_¡¬t
(
­
, 
©Œc
);

224 
”r
 = 
	`bfı_©Œs_v’code
(
mb
, 
©Œc
, &
­
);

225 
	`va_’d
(
­
);

227  
”r
;

228 
	}
}

231 
	$©Œ_decode
(
bfı_©Œ
 **
©Œp
, 
mbuf
 *
mb
,

232 
bfı_unknown_©Œ
 *
uma
)

234 
bfı_©Œ
 *
©Œ
;

235 
bfı_uniÚ
 *
v
;

236 
size_t
 
i
, 
¡¬t
, 
Ën
;

237 
”r
 = 0;

238 
ušt8_t
 
b
;

240 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
BFCP_ATTR_HDR_SIZE
)

241  
EBADMSG
;

243 
©Œ
 = 
	`mem_z®loc
((*©Œ), 
de¡ruùÜ
);

244 ià(!
©Œ
)

245  
ENOMEM
;

247 
¡¬t
 = 
mb
->
pos
;

249 
b
 = 
	`mbuf_»ad_u8
(
mb
);

250 
©Œ
->
ty³
 = 
b
 >> 1;

251 
©Œ
->
mªd
 = 
b
 & 1;

252 
Ën
 = 
	`mbuf_»ad_u8
(
mb
);

254 ià(
Ën
 < 
BFCP_ATTR_HDR_SIZE
)

255 
badmsg
;

257 
Ën
 -ğ
BFCP_ATTR_HDR_SIZE
;

259 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ën
)

260 
badmsg
;

262 
v
 = &
©Œ
->v;

264 
©Œ
->
ty³
) {

266 
BFCP_BENEFICIARY_ID
:

267 
BFCP_FLOOR_ID
:

268 
BFCP_FLOOR_REQUEST_ID
:

269 ià(
Ën
 < 2)

270 
badmsg
;

272 
v
->
u16
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

275 
BFCP_PRIORITY
:

276 ià(
Ën
 < 2)

277 
badmsg
;

279 
v
->
´iÜ™y
 = 
	`mbuf_»ad_u8
(
mb
) >> 5;

280 ()
	`mbuf_»ad_u8
(
mb
);

283 
BFCP_REQUEST_STATUS
:

284 ià(
Ën
 < 2)

285 
badmsg
;

287 
v
->
»q¡©us
.
¡©us
 = 
	`mbuf_»ad_u8
(
mb
);

288 
v
->
»q¡©us
.
qpos
 = 
	`mbuf_»ad_u8
(
mb
);

291 
BFCP_ERROR_CODE
:

292 ià(
Ën
 < 1)

293 
badmsg
;

295 
v
->
”rcode
.
code
 = 
	`mbuf_»ad_u8
(
mb
);

296 
v
->
”rcode
.
Ën
 =†en - 1;

298 ià(
v
->
”rcode
.
Ën
 == 0)

301 
v
->
”rcode
.
d‘as
 = 
	`mem_®loc
(v->”rcode.
Ën
, 
NULL
);

302 ià(!
v
->
”rcode
.
d‘as
) {

303 
”r
 = 
ENOMEM
;

304 
”rÜ
;

307 ()
	`mbuf_»ad_mem
(
mb
, 
v
->
”rcode
.
d‘as
,

308 
v
->
”rcode
.
Ën
);

311 
BFCP_ERROR_INFO
:

312 
BFCP_PART_PROV_INFO
:

313 
BFCP_STATUS_INFO
:

314 
BFCP_USER_DISP_NAME
:

315 
BFCP_USER_URI
:

316 
”r
 = 
	`mbuf_¡rdup
(
mb
, &
v
->
¡r
, 
Ën
);

319 
BFCP_SUPPORTED_ATTRS
:

320 
v
->
su·‰r
.
©Œc
 = 
Ën
;

321 
v
->
su·‰r
.
©Œv
 = 
	`mem_®loc
(
Ën
*(*v->supattr.attrv),

322 
NULL
);

323 ià(!
v
->
su·‰r
.
©Œv
) {

324 
”r
 = 
ENOMEM
;

325 
”rÜ
;

328 
i
=0; i<
Ën
; i++)

329 
v
->
su·‰r
.
©Œv
[
i
] = 
	`mbuf_»ad_u8
(
mb
) >> 1;

332 
BFCP_SUPPORTED_PRIMS
:

333 
v
->
suµrim
.
´imc
 = 
Ën
;

334 
v
->
suµrim
.
´imv
 = 
	`mem_®loc
(
Ën
 * (*v->supprim.primv),

335 
NULL
);

336 ià(!
v
->
suµrim
.
´imv
) {

337 
”r
 = 
ENOMEM
;

338 
”rÜ
;

341 
i
=0; i<
Ën
; i++)

342 
v
->
suµrim
.
´imv
[
i
] = 
	`mbuf_»ad_u8
(
mb
);

347 
BFCP_BENEFICIARY_INFO
:

348 
BFCP_FLOOR_REQ_INFO
:

349 
BFCP_REQUESTED_BY_INFO
:

350 
BFCP_FLOOR_REQ_STATUS
:

351 
BFCP_OVERALL_REQ_STATUS
:

352 ià(
Ën
 < 2)

353 
badmsg
;

355 
v
->
u16
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

356 
”r
 = 
	`bfı_©Œs_decode
(&
©Œ
->
©Œl
, 
mb
, 
Ën
 - 2, 
uma
);

360 
mb
->
pos
 +ğ
Ën
;

362 ià(!
©Œ
->
mªd
)

365 ià(
uma
 && uma->
ty³c
 < 
	`ARRAY_SIZE
(uma->
ty³v
))

366 
uma
->
ty³v
[uma->
ty³c
++] = 
©Œ
->
ty³
<<1;

370 ià(
”r
)

371 
”rÜ
;

374 ((
mb
->
pos
 - 
¡¬t
è& 0x03è&& 
	`mbuf_g‘_Ëá
(mb))

375 ++
mb
->
pos
;

377 *
©Œp
 = 
©Œ
;

381 
badmsg
:

382 
”r
 = 
EBADMSG
;

383 
”rÜ
:

384 
	`mem_d”ef
(
©Œ
);

386  
”r
;

387 
	}
}

390 
	$bfı_©Œs_decode
(
li¡
 *
©Œl
, 
mbuf
 *
mb
, 
size_t
 
Ën
,

391 
bfı_unknown_©Œ
 *
uma
)

393 
”r
 = 0;

394 
size_t
 
’d
;

396 ià(!
©Œl
 || !
mb
 || 
	`mbuf_g‘_Ëá
(mbè< 
Ën
)

397  
EINVAL
;

399 
’d
 = 
mb
->end;

400 
mb
->
’d
 = mb->
pos
 + 
Ën
;

402 
	`mbuf_g‘_Ëá
(
mb
è>ğ
BFCP_ATTR_HDR_SIZE
) {

404 
bfı_©Œ
 *
©Œ
;

406 
”r
 = 
	`©Œ_decode
(&
©Œ
, 
mb
, 
uma
);

407 ià(
”r
)

410 
	`li¡_­³nd
(
©Œl
, &
©Œ
->
Ë
,‡ttr);

413 
mb
->
’d
 =ƒnd;

415  
”r
;

416 
	}
}

419 
bfı_©Œ
 *
	$bfı_©Œs_fšd
(cÚ¡ 
li¡
 *
©Œl
,

420 
bfı_©Œib
 
ty³
)

422 
Ë
 *Ë = 
	`li¡_h—d
(
©Œl
);

424 
Ë
) {

425 
bfı_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

427 
Ë
 =†e->
Ãxt
;

429 ià(
©Œ
->
ty³
 ==ype)

430  
©Œ
;

433  
NULL
;

434 
	}
}

437 
bfı_©Œ
 *
	$bfı_©Œs_­¶y
(cÚ¡ 
li¡
 *
©Œl
,

438 
bfı_©Œ_h
 *
h
, *
¬g
)

440 
Ë
 *Ë = 
	`li¡_h—d
(
©Œl
);

442 
Ë
) {

443 
bfı_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

445 
Ë
 =†e->
Ãxt
;

447 ià(
h
 && 
	`h
(
©Œ
, 
¬g
))

448  
©Œ
;

451  
NULL
;

452 
	}
}

463 
bfı_©Œ
 *
	$bfı_©Œ_sub©Œ
(cÚ¡ 
bfı_©Œ
 *
©Œ
,

464 
bfı_©Œib
 
ty³
)

466 ià(!
©Œ
)

467  
NULL
;

469  
	`bfı_©Œs_fšd
(&
©Œ
->
©Œl
, 
ty³
);

470 
	}
}

482 
bfı_©Œ
 *
	$bfı_©Œ_sub©Œ_­¶y
(cÚ¡ 
bfı_©Œ
 *
©Œ
,

483 
bfı_©Œ_h
 *
h
, *
¬g
)

485 ià(!
©Œ
)

486  
NULL
;

488  
	`bfı_©Œs_­¶y
(&
©Œ
->
©Œl
, 
h
, 
¬g
);

489 
	}
}

500 
	$bfı_©Œ_´št
(
»_´štf
 *
pf
, cÚ¡ 
bfı_©Œ
 *
©Œ
)

502 cÚ¡ 
bfı_uniÚ
 *
v
;

503 
size_t
 
i
;

504 
”r
;

506 ià(!
©Œ
)

509 
”r
 = 
	`»_h´štf
(
pf
, "%c%-28s", 
©Œ
->
mªd
 ? '*' : ' ',

510 
	`bfı_©Œ_Çme
(
©Œ
->
ty³
));

512 
v
 = &
©Œ
->v;

514 
©Œ
->
ty³
) {

516 
BFCP_BENEFICIARY_ID
:

517 
BFCP_FLOOR_ID
:

518 
BFCP_FLOOR_REQUEST_ID
:

519 
”r
 |ğ
	`»_h´štf
(
pf
, "%u", 
v
->
u16
);

522 
BFCP_PRIORITY
:

523 
”r
 |ğ
	`»_h´štf
(
pf
, "%d", 
v
->
´iÜ™y
);

526 
BFCP_REQUEST_STATUS
:

527 
”r
 |ğ
	`»_h´štf
(
pf
, "%s (%d), qpos=%u",

528 
	`bfı_»q¡©us_Çme
(
v
->
»q¡©us
.
¡©us
),

529 
v
->
»q¡©us
.
¡©us
,

530 
v
->
»q¡©us
.
qpos
);

533 
BFCP_ERROR_CODE
:

534 
”r
 |ğ
	`»_h´štf
(
pf
, "%d (%s)", 
v
->
”rcode
.
code
,

535 
	`bfı_”rcode_Çme
(
v
->
”rcode
.
code
));

537 ià(
v
->
”rcode
.
code
 =ğ
BFCP_UNKNOWN_MAND_ATTR
) {

539 
i
=0; i<
v
->
”rcode
.
Ën
; i++) {

541 
ušt8_t
 
ty³
 = 
v
->
”rcode
.
d‘as
[
i
] >> 1;

543 
”r
 |ğ
	`»_h´štf
(
pf
, " %s",

544 
	`bfı_©Œ_Çme
(
ty³
));

549 
BFCP_ERROR_INFO
:

550 
BFCP_PART_PROV_INFO
:

551 
BFCP_STATUS_INFO
:

552 
BFCP_USER_DISP_NAME
:

553 
BFCP_USER_URI
:

554 
”r
 |ğ
	`»_h´štf
(
pf
, "\"%s\"", 
v
->
¡r
);

557 
BFCP_SUPPORTED_ATTRS
:

558 
”r
 |ğ
	`»_h´štf
(
pf
, "%zu:", 
v
->
su·‰r
.
©Œc
);

560 
i
=0; i<
v
->
su·‰r
.
©Œc
; i++) {

562 cÚ¡ 
bfı_©Œib
 
ty³
 = 
v
->
su·‰r
.
©Œv
[
i
];

564 
”r
 |ğ
	`»_h´štf
(
pf
, " %s", 
	`bfı_©Œ_Çme
(
ty³
));

568 
BFCP_SUPPORTED_PRIMS
:

569 
”r
 |ğ
	`»_h´štf
(
pf
, "%zu:", 
v
->
suµrim
.
´imc
);

571 
i
=0; i<
v
->
suµrim
.
´imc
; i++) {

573 cÚ¡ 
bfı_´im
 
´im
 = 
v
->
suµrim
.
´imv
[
i
];

575 
”r
 |ğ
	`»_h´štf
(
pf
, " %s", 
	`bfı_´im_Çme
(
´im
));

581 
BFCP_BENEFICIARY_INFO
:

582 
”r
 |ğ
	`»_h´štf
(
pf
, "b’eficŸry-id=%u", 
v
->
b’eficŸryid
);

585 
BFCP_FLOOR_REQ_INFO
:

586 
”r
 |ğ
	`»_h´štf
(
pf
, "æoÜ-»que¡-id=%u", 
v
->
æoÜ»qid
);

589 
BFCP_REQUESTED_BY_INFO
:

590 
”r
 |ğ
	`»_h´štf
(
pf
, "»que¡ed-by-id=%u", 
v
->
»qbyid
);

593 
BFCP_FLOOR_REQ_STATUS
:

594 
”r
 |ğ
	`»_h´štf
(
pf
, "æoÜ-id=%u", 
v
->
æoÜid
);

597 
BFCP_OVERALL_REQ_STATUS
:

598 
”r
 |ğ
	`»_h´štf
(
pf
, "æoÜ-»que¡-id=%u", 
v
->
æoÜ»qid
);

602 
”r
 |ğ
	`»_h´štf
(
pf
, "???");

606  
”r
;

607 
	}
}

610 
	$bfı_©Œs_´št
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *
©Œl
,

611 
Ëv–
)

613 
Ë
 *le;

614 
”r
 = 0;

616 
Ë
=
	`li¡_h—d
(
©Œl
);†e;†eöe->
Ãxt
) {

618 cÚ¡ 
bfı_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

619 
i
;

621 
i
=0; i<
Ëv–
; i++)

622 
”r
 |ğ
	`»_h´štf
(
pf
, " ");

624 
”r
 |ğ
	`»_h´štf
(
pf
, "%H\n", 
bfı_©Œ_´št
, 
©Œ
);

625 
”r
 |ğ
	`bfı_©Œs_´št
(
pf
, &
©Œ
->
©Œl
, 
Ëv–
 + 1);

628  
”r
;

629 
	}
}

639 cÚ¡ *
	$bfı_©Œ_Çme
(
bfı_©Œib
 
ty³
)

641 
ty³
) {

643 
BFCP_BENEFICIARY_ID
:  "BENEFICIARY-ID";

644 
BFCP_FLOOR_ID
:  "FLOOR-ID";

645 
BFCP_FLOOR_REQUEST_ID
:  "FLOOR-REQUEST-ID";

646 
BFCP_PRIORITY
:  "PRIORITY";

647 
BFCP_REQUEST_STATUS
:  "REQUEST-STATUS";

648 
BFCP_ERROR_CODE
:  "ERROR-CODE";

649 
BFCP_ERROR_INFO
:  "ERROR-INFO";

650 
BFCP_PART_PROV_INFO
:  "PARTICIPANT-PROVIDED-INFO";

651 
BFCP_STATUS_INFO
:  "STATUS-INFO";

652 
BFCP_SUPPORTED_ATTRS
:  "SUPPORTED-ATTRIBUTES";

653 
BFCP_SUPPORTED_PRIMS
:  "SUPPORTED-PRIMITIVES";

654 
BFCP_USER_DISP_NAME
:  "USER-DISPLAY-NAME";

655 
BFCP_USER_URI
:  "USER-URI";

656 
BFCP_BENEFICIARY_INFO
:  "BENEFICIARY-INFORMATION";

657 
BFCP_FLOOR_REQ_INFO
:  "FLOOR-REQUEST-INFORMATION";

658 
BFCP_REQUESTED_BY_INFO
:  "REQUESTED-BY-INFORMATION";

659 
BFCP_FLOOR_REQ_STATUS
:  "FLOOR-REQUEST-STATUS";

660 
BFCP_OVERALL_REQ_STATUS
:  "OVERALL-REQUEST-STATUS";

663 
	}
}

673 cÚ¡ *
	$bfı_»q¡©us_Çme
(
bfı_»q¡©
 
¡©us
)

675 
¡©us
) {

677 
BFCP_PENDING
:  "Pending";

678 
BFCP_ACCEPTED
:  "Accepted";

679 
BFCP_GRANTED
:  "Granted";

680 
BFCP_DENIED
:  "Denied";

681 
BFCP_CANCELLED
:  "Cancelled";

682 
BFCP_RELEASED
:  "Released";

683 
BFCP_REVOKED
:  "Revoked";

686 
	}
}

696 cÚ¡ *
	$bfı_”rcode_Çme
(
bfı_”r
 
code
)

698 
code
) {

700 
BFCP_CONF_NOT_EXIST
:

703 
BFCP_USER_NOT_EXIST
:

706 
BFCP_UNKNOWN_PRIM
:

709 
BFCP_UNKNOWN_MAND_ATTR
:

712 
BFCP_UNAUTH_OPERATION
:

715 
BFCP_INVALID_FLOOR_ID
:

718 
BFCP_FLOOR_REQ_ID_NOT_EXIST
:

721 
BFCP_MAX_FLOOR_REQ_REACHED
:

725 
BFCP_USE_TLS
:

728 
BFCP_PARSE_ERROR
:

731 
BFCP_USE_DTLS
:

734 
BFCP_UNSUPPORTED_VERSION
:

737 
BFCP_BAD_LENGTH
:

740 
BFCP_GENERIC_ERROR
:

746 
	}
}

	@re-0.5.6/src/bfcp/bfcp.h

7 
	sbfı_¡¿ns
 {

8 
bfı_´im
 
	m´im
;

9 
ušt32_t
 
	mcÚfid
;

10 
ušt16_t
 
	mtid
;

11 
ušt16_t
 
	mu£rid
;

14 
	sbfı_cÚn
 {

15 
bfı_¡¿ns
 
	m¡
;

16 
li¡
 
	mù¿n¦
;

17 
tmr
 
	mtmr1
;

18 
tmr
 
	mtmr2
;

19 
udp_sock
 *
	mus
;

20 
mbuf
 *
	mmb
;

21 
bfı_»cv_h
 *
	m»cvh
;

22 *
	m¬g
;

23 
bfı_Œª¥
 
	m
;

24 
	mtxc
;

25 
ušt16_t
 
	mtid
;

30 
bfı_©Œs_decode
(
li¡
 *
©Œl
, 
mbuf
 *
mb
, 
size_t
 
Ën
,

31 
bfı_unknown_©Œ
 *
uma
);

32 
bfı_©Œ
 *
bfı_©Œs_fšd
(cÚ¡ 
li¡
 *
©Œl
,

33 
bfı_©Œib
 
ty³
);

34 
bfı_©Œ
 *
bfı_©Œs_­¶y
(cÚ¡ 
li¡
 *
©Œl
,

35 
bfı_©Œ_h
 *
h
, *
¬g
);

36 
bfı_©Œs_´št
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *
©Œl
,

37 
Ëv–
);

41 
bfı_£nd
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
);

45 
boŞ
 
bfı_hªdË_»¥Ú£
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
msg
);

46 
bfı_v»que¡
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

47 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

48 
bfı_»¥_h
 *
»¥h
, *
¬g
, 
©Œc
, 
va_li¡
 *
­
);

	@re-0.5.6/src/bfcp/conn.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_udp.h
>

14 
	~<»_tmr.h
>

15 
	~<»_bfı.h
>

16 
	~"bfı.h
"

19 
	$de¡ruùÜ
(*
¬g
)

21 
bfı_cÚn
 *
bc
 = 
¬g
;

23 
	`li¡_æush
(&
bc
->
ù¿n¦
);

24 
	`tmr_ÿnûl
(&
bc
->
tmr1
);

25 
	`tmr_ÿnûl
(&
bc
->
tmr2
);

26 
	`mem_d”ef
(
bc
->
us
);

27 
	`mem_d”ef
(
bc
->
mb
);

28 
	}
}

31 
boŞ
 
	$¡¿ns_cmp
(cÚ¡ 
bfı_¡¿ns
 *
¡
,

32 cÚ¡ 
bfı_msg
 *
msg
)

34 ià(
¡
->
tid
 !ğ
msg
->tid)

35  
çl£
;

37 ià(
¡
->
´im
 !ğ
msg
->prim)

38  
çl£
;

40 ià(
¡
->
cÚfid
 !ğ
msg
->confid)

41  
çl£
;

43 ià(
¡
->
u£rid
 !ğ
msg
->userid)

44  
çl£
;

46  
Œue
;

47 
	}
}

50 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

52 
bfı_cÚn
 *
bc
 = 
¬g
;

53 
bfı_msg
 *
msg
;

54 
”r
;

56 
”r
 = 
	`bfı_msg_decode
(&
msg
, 
mb
);

57 ià(
”r
)

60 
msg
->
¤c
 = *src;

62 ià(
	`bfı_hªdË_»¥Ú£
(
bc
, 
msg
))

63 
out
;

65 ià(
bc
->
mb
 && 
	`¡¿ns_cmp
(&bc->
¡
, 
msg
)) {

66 ()
	`bfı_£nd
(
bc
, &
msg
->
¤c
, bc->
mb
);

67 
out
;

70 ià(
bc
->
»cvh
)

71 
bc
->
	`»cvh
(
msg
, bc->
¬g
);

73 
out
:

74 
	`mem_d”ef
(
msg
);

75 
	}
}

90 
	$bfı_li¡’
(
bfı_cÚn
 **
bı
, 
bfı_Œª¥
 

, 
§
 *
Ïddr
,

91 
s
 *s, 
bfı_»cv_h
 *
»cvh
, *
¬g
)

93 
bfı_cÚn
 *
bc
;

94 
”r
;

95 ()
s
;

97 ià(!
bı
)

98  
EINVAL
;

100 
bc
 = 
	`mem_z®loc
((*bc), 
de¡ruùÜ
);

101 ià(!
bc
)

102  
ENOMEM
;

104 
bc
->

 =p;

105 
bc
->
»cvh
 =„ecvh;

106 
bc
->
¬g
 =‡rg;

108 
bc
->

) {

110 
BFCP_UDP
:

111 
”r
 = 
	`udp_li¡’
(&
bc
->
us
, 
Ïddr
, 
udp_»cv_hªdËr
, bc);

112 ià(
”r
)

113 
out
;

115 ià(
Ïddr
) {

116 
”r
 = 
	`udp_loÿl_g‘
(
bc
->
us
, 
Ïddr
);

117 ià(
”r
)

118 
out
;

123 
”r
 = 
ENOSYS
;

124 
out
;

127 
out
:

128 ià(
”r
)

129 
	`mem_d”ef
(
bc
);

131 *
bı
 = 
bc
;

133  
”r
;

134 
	}
}

137 
	$bfı_£nd
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

139 ià(!
bc
 || !
d¡
 || !
mb
)

140  
EINVAL
;

142 
bc
->

) {

144 
BFCP_UDP
:

145  
	`udp_£nd
(
bc
->
us
, 
d¡
, 
mb
);

148  
ENOSYS
;

150 
	}
}

153 *
	$bfı_sock
(cÚ¡ 
bfı_cÚn
 *
bc
)

155  
bc
 ? bc->
us
 : 
NULL
;

156 
	}
}

	@re-0.5.6/src/bfcp/msg.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_tmr.h
>

14 
	~<»_bfı.h
>

15 
	~"bfı.h
"

19 
	mBFCP_HDR_SIZE
 = 12,

23 
	$de¡ruùÜ
(*
¬g
)

25 
bfı_msg
 *
msg
 = 
¬g
;

27 
	`li¡_æush
(&
msg
->
©Œl
);

28 
	}
}

31 
	$hdr_’code
(
mbuf
 *
mb
, 
ušt8_t
 
v”
, 
boŞ
 
r
,

32 
bfı_´im
 
´im
, 
ušt16_t
 
Ën
, 
ušt32_t
 
cÚfid
,

33 
ušt16_t
 
tid
, ušt16_ˆ
u£rid
)

35 
”r
;

37 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, (
v”
 << 5è| ((
r
 ? 1 : 0) << 4));

38 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
´im
);

39 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
Ën
));

40 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
cÚfid
));

41 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
tid
));

42 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
u£rid
));

44  
”r
;

45 
	}
}

48 
	$hdr_decode
(
bfı_msg
 *
msg
, 
mbuf
 *
mb
)

50 
ušt8_t
 
b
;

52 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
BFCP_HDR_SIZE
)

53  
ENODATA
;

55 
b
 = 
	`mbuf_»ad_u8
(
mb
);

57 
msg
->
v”
 = 
b
 >> 5;

58 
msg
->
r
 = (
b
 >> 4) & 1;

59 
msg
->
f
 = (
b
 >> 3) & 1;

60 
msg
->
´im
 = 
	`mbuf_»ad_u8
(
mb
);

61 
msg
->
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

62 
msg
->
cÚfid
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

63 
msg
->
tid
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

64 
msg
->
u£rid
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

66 ià(
msg
->
v”
 !ğ
BFCP_VER1
 && msg->v” !ğ
BFCP_VER2
)

67  
EBADMSG
;

70 ià(
msg
->
f
)

71  
ENOSYS
;

73 ià(
	`mbuf_g‘_Ëá
(
mb
è< (
size_t
)(4*
msg
->
Ën
))

74  
ENODATA
;

77 
	}
}

95 
	$bfı_msg_v’code
(
mbuf
 *
mb
, 
ušt8_t
 
v”
, 
boŞ
 
r
, 
bfı_´im
 
´im
,

96 
ušt32_t
 
cÚfid
, 
ušt16_t
 
tid
, ušt16_ˆ
u£rid
,

97 
©Œc
, 
va_li¡
 *
­
)

99 
size_t
 
¡¬t
, 
Ën
;

100 
”r
;

102 ià(!
mb
)

103  
EINVAL
;

105 
¡¬t
 = 
mb
->
pos
;

106 
mb
->
pos
 +ğ
BFCP_HDR_SIZE
;

108 
”r
 = 
	`bfı_©Œs_v’code
(
mb
, 
©Œc
, 
­
);

109 ià(
”r
)

110  
”r
;

113 
Ën
 = 
mb
->
pos
 - 
¡¬t
 - 
BFCP_HDR_SIZE
;

114 
mb
->
pos
 = 
¡¬t
;

115 
”r
 = 
	`hdr_’code
(
mb
, 
v”
, 
r
, 
´im
, (
ušt16_t
)(
Ën
/4), 
cÚfid
, 
tid
,

116 
u£rid
);

117 
mb
->
pos
 +ğ
Ën
;

119  
”r
;

120 
	}
}

137 
	$bfı_msg_’code
(
mbuf
 *
mb
, 
ušt8_t
 
v”
, 
boŞ
 
r
, 
bfı_´im
 
´im
,

138 
ušt32_t
 
cÚfid
, 
ušt16_t
 
tid
, ušt16_ˆ
u£rid
,

139 
©Œc
, ...)

141 
va_li¡
 
­
;

142 
”r
;

144 
	`va_¡¬t
(
­
, 
©Œc
);

145 
”r
 = 
	`bfı_msg_v’code
(
mb
, 
v”
, 
r
, 
´im
, 
cÚfid
, 
tid
, 
u£rid
,

146 
©Œc
, &
­
);

147 
	`va_’d
(
­
);

149  
”r
;

150 
	}
}

161 
	$bfı_msg_decode
(
bfı_msg
 **
msgp
, 
mbuf
 *
mb
)

163 
bfı_msg
 *
msg
;

164 
size_t
 
¡¬t
;

165 
”r
;

167 ià(!
msgp
 || !
mb
)

168  
EINVAL
;

170 
msg
 = 
	`mem_z®loc
((*msg), 
de¡ruùÜ
);

171 ià(!
msg
)

172  
ENOMEM
;

174 
¡¬t
 = 
mb
->
pos
;

176 
”r
 = 
	`hdr_decode
(
msg
, 
mb
);

177 ià(
”r
) {

178 
mb
->
pos
 = 
¡¬t
;

179 
out
;

182 
”r
 = 
	`bfı_©Œs_decode
(&
msg
->
©Œl
, 
mb
, 4*msg->
Ën
, &msg->
uma
);

183 ià(
”r
)

184 
out
;

186 
out
:

187 ià(
”r
)

188 
	`mem_d”ef
(
msg
);

190 *
msgp
 = 
msg
;

192  
”r
;

193 
	}
}

204 
bfı_©Œ
 *
	$bfı_msg_©Œ
(cÚ¡ 
bfı_msg
 *
msg
,

205 
bfı_©Œib
 
ty³
)

207 ià(!
msg
)

208  
NULL
;

210  
	`bfı_©Œs_fšd
(&
msg
->
©Œl
, 
ty³
);

211 
	}
}

223 
bfı_©Œ
 *
	$bfı_msg_©Œ_­¶y
(cÚ¡ 
bfı_msg
 *
msg
,

224 
bfı_©Œ_h
 *
h
, *
¬g
)

226 ià(!
msg
)

227  
NULL
;

229  
	`bfı_©Œs_­¶y
(&
msg
->
©Œl
, 
h
, 
¬g
);

230 
	}
}

241 
	$bfı_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
bfı_msg
 *
msg
)

243 
”r
;

245 ià(!
msg
)

248 
”r
 = 
	`»_h´štf
(
pf
, "%s (confid=%uid=%u userid=%u)\n",

249 
	`bfı_´im_Çme
(
msg
->
´im
), msg->
cÚfid
,

250 
msg
->
tid
, msg->
u£rid
);

252 
”r
 |ğ
	`bfı_©Œs_´št
(
pf
, &
msg
->
©Œl
, 0);

254  
”r
;

255 
	}
}

265 cÚ¡ *
	$bfı_´im_Çme
(
bfı_´im
 
´im
)

267 
´im
) {

269 
BFCP_FLOOR_REQUEST
:  "FloorRequest";

270 
BFCP_FLOOR_RELEASE
:  "FloorRelease";

271 
BFCP_FLOOR_REQUEST_QUERY
:  "FloorRequestQuery";

272 
BFCP_FLOOR_REQUEST_STATUS
:  "FloorRequestStatus";

273 
BFCP_USER_QUERY
:  "UserQuery";

274 
BFCP_USER_STATUS
:  "UserStatus";

275 
BFCP_FLOOR_QUERY
:  "FloorQuery";

276 
BFCP_FLOOR_STATUS
:  "FloorStatus";

277 
BFCP_CHAIR_ACTION
:  "ChairAction";

278 
BFCP_CHAIR_ACTION_ACK
:  "ChairActionAck";

279 
BFCP_HELLO
:  "Hello";

280 
BFCP_HELLO_ACK
:  "HelloAck";

281 
BFCP_ERROR
:  "Error";

282 
BFCP_FLOOR_REQ_STATUS_ACK
:  "FloorRequestStatusAck";

283 
BFCP_FLOOR_STATUS_ACK
:  "FloorStatusAck";

284 
BFCP_GOODBYE
:  "Goodbye";

285 
BFCP_GOODBYE_ACK
:  "GoodbyeAck";

288 
	}
}

	@re-0.5.6/src/bfcp/reply.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_tmr.h
>

14 
	~<»_bfı.h
>

15 
	~"bfı.h
"

19 
	mBFCP_T2
 = 10000,

23 
	$tmr_hªdËr
(*
¬g
)

25 
bfı_cÚn
 *
bc
 = 
¬g
;

27 
bc
->
mb
 = 
	`mem_d”ef
(bc->mb);

28 
	}
}

41 
	$bfı_»¶y
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

42 
bfı_´im
 
´im
, 
©Œc
, ...)

44 
va_li¡
 
­
;

45 
”r
;

47 ià(!
bc
 || !
»q
)

48  
EINVAL
;

50 
bc
->
mb
 = 
	`mem_d”ef
(bc->mb);

51 
	`tmr_ÿnûl
(&
bc
->
tmr2
);

53 
bc
->
mb
 = 
	`mbuf_®loc
(64);

54 ià(!
bc
->
mb
)

55  
ENOMEM
;

57 
	`va_¡¬t
(
­
, 
©Œc
);

58 
”r
 = 
	`bfı_msg_v’code
(
bc
->
mb
, 
»q
->
v”
, 
Œue
, 
´im
,„eq->
cÚfid
,

59 
»q
->
tid
,„eq->
u£rid
, 
©Œc
, &
­
);

60 
	`va_’d
(
­
);

62 ià(
”r
)

63 
out
;

65 
bc
->
mb
->
pos
 = 0;

67 
”r
 = 
	`bfı_£nd
(
bc
, &
»q
->
¤c
, bc->
mb
);

68 ià(
”r
)

69 
out
;

71 
bc
->
¡
.
´im
 = 
»q
->prim;

72 
bc
->
¡
.
cÚfid
 = 
»q
->confid;

73 
bc
->
¡
.
tid
 = 
»q
->tid;

74 
bc
->
¡
.
u£rid
 = 
»q
->userid;

76 
	`tmr_¡¬t
(&
bc
->
tmr2
, 
BFCP_T2
, 
tmr_hªdËr
, bc);

78 
out
:

79 ià(
”r
)

80 
bc
->
mb
 = 
	`mem_d”ef
(bc->mb);

82  
”r
;

83 
	}
}

97 
	$bfı_ed»¶y
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

98 
bfı_”r
 
code
, cÚ¡ 
ušt8_t
 *
d‘as
, 
size_t
 
Ën
)

100 
bfı_”rcode
 
”rcode
;

102 
”rcode
.
code
 = code;

103 
”rcode
.
d‘as
 = (
ušt8_t
 *)details;

104 
”rcode
.
Ën
 =†en;

106  
	`bfı_»¶y
(
bc
, 
»q
, 
BFCP_ERROR
, 1,

107 
BFCP_ERROR_CODE
, 0, &
”rcode
);

108 
	}
}

120 
	$bfı_”•ly
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
»q
,

121 
bfı_”r
 
code
)

123  
	`bfı_ed»¶y
(
bc
, 
»q
, 
code
, 
NULL
, 0);

124 
	}
}

	@re-0.5.6/src/bfcp/request.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_tmr.h
>

14 
	~<»_bfı.h
>

15 
	~"bfı.h
"

19 
	mBFCP_T1
 = 500,

20 
	mBFCP_TXC
 = 4,

24 
	sbfı_ù¿ns
 {

25 
Ë
 
	mË
;

26 
§
 
	md¡
;

27 
mbuf
 *
	mmb
;

28 
bfı_»¥_h
 *
	m»¥h
;

29 *
	m¬g
;

30 
ušt32_t
 
	mcÚfid
;

31 
ušt16_t
 
	mu£rid
;

32 
ušt16_t
 
	mtid
;

36 
tmr_hªdËr
(*
¬g
);

39 
	$dummy_»¥_hªdËr
(
”r
, cÚ¡ 
bfı_msg
 *
msg
, *
¬g
)

41 ()
”r
;

42 ()
msg
;

43 ()
¬g
;

44 
	}
}

47 
	$de¡ruùÜ
(*
¬g
)

49 
bfı_ù¿ns
 *
ù
 = 
¬g
;

51 
	`li¡_uÆšk
(&
ù
->
Ë
);

52 
	`mem_d”ef
(
ù
->
mb
);

53 
	}
}

56 
	$di¥©ch
(
bfı_cÚn
 *
bc
)

58 
Ë
 *Ë = 
bc
->
ù¿n¦
.
h—d
;

60 
Ë
) {

61 
bfı_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

62 
”r
;

64 
Ë
 =†e->
Ãxt
;

66 
”r
 = 
	`bfı_£nd
(
bc
, &
ù
->
d¡
, ct->
mb
);

67 ià(
”r
) {

68 
ù
->
	`»¥h
(
”r
, 
NULL
, ct->
¬g
);

69 
	`mem_d”ef
(
ù
);

73 
	`tmr_¡¬t
(&
bc
->
tmr1
, 
BFCP_T1
, 
tmr_hªdËr
, bc);

74 
bc
->
txc
 = 1;

77 
	}
}

80 
	$tmr_hªdËr
(*
¬g
)

82 
bfı_cÚn
 *
bc
 = 
¬g
;

83 
bfı_ù¿ns
 *
ù
;

84 
ušt32_t
 
timeout
;

85 
”r
;

87 
ù
 = 
	`li¡_Ëd©a
(
bc
->
ù¿n¦
.
h—d
);

88 ià(!
ù
)

91 
timeout
 = 
BFCP_T1
<<
bc
->
txc
;

93 ià(++
bc
->
txc
 > 
BFCP_TXC
) {

94 
”r
 = 
ETIMEDOUT
;

95 
out
;

98 
”r
 = 
	`bfı_£nd
(
bc
, &
ù
->
d¡
, ct->
mb
);

99 ià(
”r
)

100 
out
;

102 
	`tmr_¡¬t
(&
bc
->
tmr1
, 
timeout
, 
tmr_hªdËr
, bc);

105 
out
:

106 
ù
->
	`»¥h
(
”r
, 
NULL
, ct->
¬g
);

107 
	`mem_d”ef
(
ù
);

108 
	`di¥©ch
(
bc
);

109 
	}
}

112 
boŞ
 
	$bfı_hªdË_»¥Ú£
(
bfı_cÚn
 *
bc
, cÚ¡ 
bfı_msg
 *
msg
)

114 
bfı_ù¿ns
 *
ù
;

116 ià(!
bc
 || !
msg
)

117  
çl£
;

119 
ù
 = 
	`li¡_Ëd©a
(
bc
->
ù¿n¦
.
h—d
);

120 ià(!
ù
)

121  
çl£
;

123 ià(
msg
->
tid
 !ğ
ù
->tid)

124  
çl£
;

126 ià(
msg
->
cÚfid
 !ğ
ù
->confid)

127  
çl£
;

129 ià(
msg
->
u£rid
 !ğ
ù
->userid)

130  
çl£
;

132 
	`tmr_ÿnûl
(&
bc
->
tmr1
);

134 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

135 
	`mem_d”ef
(
ù
);

137 
	`di¥©ch
(
bc
);

139  
Œue
;

140 
	}
}

143 
	$bfı_v»que¡
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

144 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

145 
bfı_»¥_h
 *
»¥h
, *
¬g
, 
©Œc
, 
va_li¡
 *
­
)

147 
bfı_ù¿ns
 *
ù
;

148 
”r
;

150 ià(!
bc
 || !
d¡
)

151  
EINVAL
;

153 
ù
 = 
	`mem_z®loc
((*ù), 
de¡ruùÜ
);

154 ià(!
ù
)

155  
ENOMEM
;

157 ià(
bc
->
tid
 == 0)

158 
bc
->
tid
 = 1;

160 
ù
->
d¡
 = *dst;

161 
ù
->
cÚfid
 = confid;

162 
ù
->
u£rid
 = userid;

163 
ù
->
tid
 = 
bc
->tid++;

164 
ù
->
»¥h
 =„e¥h ?„e¥h : 
dummy_»¥_hªdËr
;

165 
ù
->
¬g
 =‡rg;

167 
ù
->
mb
 = 
	`mbuf_®loc
(128);

168 ià(!
ù
->
mb
) {

169 
”r
 = 
ENOMEM
;

170 
out
;

173 
”r
 = 
	`bfı_msg_v’code
(
ù
->
mb
, 
v”
, 
çl£
, 
´im
, 
cÚfid
, ct->
tid
,

174 
u£rid
, 
©Œc
, 
­
);

175 ià(
”r
)

176 
out
;

178 
ù
->
mb
->
pos
 = 0;

180 ià(!
bc
->
ù¿n¦
.
h—d
) {

182 
”r
 = 
	`bfı_£nd
(
bc
, &
ù
->
d¡
, ct->
mb
);

183 ià(
”r
)

184 
out
;

186 
	`tmr_¡¬t
(&
bc
->
tmr1
, 
BFCP_T1
, 
tmr_hªdËr
, bc);

187 
bc
->
txc
 = 1;

190 
	`li¡_­³nd
(&
bc
->
ù¿n¦
, &
ù
->
Ë
, ct);

192 
out
:

193 ià(
”r
)

194 
	`mem_d”ef
(
ù
);

196  
”r
;

197 
	}
}

215 
	$bfı_»que¡
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

216 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

217 
bfı_»¥_h
 *
»¥h
, *
¬g
, 
©Œc
, ...)

219 
va_li¡
 
­
;

220 
”r
;

222 
	`va_¡¬t
(
­
, 
©Œc
);

223 
”r
 = 
	`bfı_v»que¡
(
bc
, 
d¡
, 
v”
, 
´im
, 
cÚfid
, 
u£rid
, 
»¥h
, 
¬g
,

224 
©Œc
, &
­
);

225 
	`va_’d
(
­
);

227  
”r
;

228 
	}
}

244 
	$bfı_nÙify
(
bfı_cÚn
 *
bc
, cÚ¡ 
§
 *
d¡
, 
ušt8_t
 
v”
,

245 
bfı_´im
 
´im
, 
ušt32_t
 
cÚfid
, 
ušt16_t
 
u£rid
,

246 
©Œc
, ...)

248 
va_li¡
 
­
;

249 
”r
;

251 
	`va_¡¬t
(
­
, 
©Œc
);

252 
”r
 = 
	`bfı_v»que¡
(
bc
, 
d¡
, 
v”
, 
´im
, 
cÚfid
, 
u£rid
, 
NULL
, NULL,

253 
©Œc
, &
­
);

254 
	`va_’d
(
­
);

256  
”r
;

257 
	}
}

	@re-0.5.6/src/conf/conf.c

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 
	~<fú.h
>

9 #ifdeà
HAVE_UNISTD_H


10 
	~<uni¡d.h
>

12 #ifdeà
HAVE_IO_H


13 
	~<io.h
>

15 
	~<»_ty³s.h
>

16 
	~<»_fmt.h
>

17 
	~<»_mem.h
>

18 
	~<»_mbuf.h
>

19 
	~<»_cÚf.h
>

22 #ifdeà
WIN32


23 
	#İ’
 
_İ’


	)

24 
	#»ad
 
_»ad


	)

25 
	#şo£
 
_şo£


	)

34 
	scÚf
 {

35 
mbuf
 *
	mmb
;

39 
	$lßd_fe
(
mbuf
 *
mb
, cÚ¡ *
f’ame
)

41 
”r
 = 0, 
fd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
);

42 ià(
fd
 < 0)

43  
”ºo
;

46 
ušt8_t
 
buf
[1024];

48 cÚ¡ 
ssize_t
 
n
 = 
	`»ad
(
fd
, (*)
buf
, (buf));

49 ià(
n
 < 0) {

50 
”r
 = 
”ºo
;

53 ià(
n
 == 0)

56 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
buf
, 
n
);

59 ()
	`şo£
(
fd
);

61  
”r
;

62 
	}
}

65 
	$cÚf_de¡ruùÜ
(*
d©a
)

67 
cÚf
 *cÚàğ
d©a
;

69 
	`mem_d”ef
(
cÚf
->
mb
);

70 
	}
}

81 
	$cÚf_®loc
(
cÚf
 **
cÚå
, cÚ¡ *
f’ame
)

83 
cÚf
 *conf;

84 
”r
 = 0;

86 ià(!
cÚå
)

87  
EINVAL
;

89 
cÚf
 = 
	`mem_z®loc
((*cÚf), 
cÚf_de¡ruùÜ
);

90 ià(!
cÚf
)

91  
ENOMEM
;

93 
cÚf
->
mb
 = 
	`mbuf_®loc
(1024);

94 ià(!
cÚf
->
mb
) {

95 
”r
 = 
ENOMEM
;

96 
out
;

99 
”r
 |ğ
	`mbuf_wr™e_u8
(
cÚf
->
mb
, '\n');

100 ià(
f’ame
)

101 
”r
 |ğ
	`lßd_fe
(
cÚf
->
mb
, 
f’ame
);

103 
out
:

104 ià(
”r
)

105 
	`mem_d”ef
(
cÚf
);

107 *
cÚå
 = 
cÚf
;

109  
”r
;

110 
	}
}

122 
	$cÚf_®loc_buf
(
cÚf
 **
cÚå
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
)

124 
cÚf
 *conf;

125 
”r
;

127 
”r
 = 
	`cÚf_®loc
(&
cÚf
, 
NULL
);

128 ià(
”r
)

129  
”r
;

131 
”r
 = 
	`mbuf_wr™e_mem
(
cÚf
->
mb
, 
buf
, 
sz
);

133 ià(
”r
)

134 
	`mem_d”ef
(
cÚf
);

136 *
cÚå
 = 
cÚf
;

138  
”r
;

139 
	}
}

151 
	$cÚf_g‘
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
¶
 *pl)

153 
ex´
[512];

154 
¶
 
¥l
;

156 ià(!
cÚf
 || !
Çme
 || !
¶
)

157  
EINVAL
;

159 
¥l
.
p
 = (cÚ¡ *)
cÚf
->
mb
->
buf
;

160 
¥l
.
l
 = 
cÚf
->
mb
->
’d
;

162 ()
	`»_¢´štf
(
ex´
, (expr),

163 "[\r\n]+[ \t]*%s[ \t]+[~ \t\r\n]+", 
Çme
);

165  
	`»_»gex
(
¥l
.
p
, s¶.
l
, 
ex´
, 
NULL
, NULL, NULL, 
¶
);

166 
	}
}

179 
	$cÚf_g‘_¡r
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, *
¡r
,

180 
size_t
 
size
)

182 
¶
…l;

183 
”r
;

185 ià(!
cÚf
 || !
Çme
 || !
¡r
 || !
size
)

186  
EINVAL
;

188 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
¶
);

189 ià(
”r
)

190  
”r
;

192  
	`¶_¡rıy
(&
¶
, 
¡r
, 
size
);

193 
	}
}

205 
	$cÚf_g‘_u32
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
ušt32_t
 *
num
)

207 
¶
…l;

208 
”r
;

210 ià(!
cÚf
 || !
Çme
 || !
num
)

211  
EINVAL
;

213 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
¶
);

214 ià(
”r
)

215  
”r
;

217 *
num
 = 
	`¶_u32
(&
¶
);

220 
	}
}

232 
	$cÚf_g‘_boŞ
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
, 
boŞ
 *
v®
)

234 
¶
…l;

235 
”r
;

237 ià(!
cÚf
 || !
Çme
 || !
v®
)

238  
EINVAL
;

240 
”r
 = 
	`cÚf_g‘
(
cÚf
, 
Çme
, &
¶
);

241 ià(
”r
)

242  
”r
;

244 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "true"))

245 *
v®
 = 
Œue
;

246 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "yes"))

247 *
v®
 = 
Œue
;

248 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "1"))

249 *
v®
 = 
Œue
;

251 *
v®
 = 
çl£
;

254 
	}
}

267 
	$cÚf_­¶y
(cÚ¡ 
cÚf
 *cÚf, cÚ¡ *
Çme
,

268 
cÚf_h
 *
ch
, *
¬g
)

270 
ex´
[512];

271 
¶
…l, 
v®
;

272 
”r
 = 0;

274 ià(!
cÚf
 || !
Çme
 || !
ch
)

275  
EINVAL
;

277 
¶
.
p
 = (cÚ¡ *)
cÚf
->
mb
->
buf
;

278 
¶
.
l
 = 
cÚf
->
mb
->
’d
;

280 ()
	`»_¢´štf
(
ex´
, (expr),

281 "[\r\n]+[ \t]*%s[ \t]+[~ \t\r\n]+", 
Çme
);

283 !
	`»_»gex
(
¶
.
p
,…l.
l
, 
ex´
, 
NULL
, NULL, NULL, &
v®
)) {

285 
”r
 = 
	`ch
(&
v®
, 
¬g
);

286 ià(
”r
)

289 
¶
.
l
 -ğ
v®
.
p
 + val.l -…l.p;

290 
¶
.
p
 = 
v®
.°+ v®.
l
;

293  
”r
;

294 
	}
}

	@re-0.5.6/src/crc32/crc32.c

46 
	~<»_ty³s.h
>

47 
	~<»_üc32.h
>

50 cÚ¡ 
ušt32_t
 
	güc32_b
[] = {

109 
ušt32_t
 
	$üc32
(
ušt32_t
 
üc
, cÚ¡ *
buf
, ušt32_ˆ
size
)

111 cÚ¡ 
ušt8_t
 *
p
 = 
buf
;

113 
üc
 = ~crc;

114 
size
--)

115 
üc
 = 
üc32_b
[(üø^ *
p
++) & 0xff] ^ (crc >> 8);

116  
üc
 ^ ~0U;

117 
	}
}

	@re-0.5.6/src/dbg/dbg.c

6 
	~<¡dio.h
>

7 #ifdeà
HAVE_UNISTD_H


8 
	~<uni¡d.h
>

10 #ifdeà
HAVE_PTHREAD


11 
	~<¡dlib.h
>

12 
	~<±h»ad.h
>

14 
	~<time.h
>

15 
	~<»_ty³s.h
>

16 
	~<»_fmt.h
>

17 
	~<»_li¡.h
>

18 
	~<»_tmr.h
>

21 
	#DEBUG_MODULE
 "dbg"

	)

22 
	#DEBUG_LEVEL
 0

	)

23 
	~<»_dbg.h
>

28 
ušt64_t
 
	mtick
;

29 
	mËv–
;

30 
dbg_æags
 
	mæags
;

31 
dbg_´št_h
 *
	mph
;

32 *
	m¬g
;

33 
FILE
 *
	mf
;

34 #ifdeà
HAVE_PTHREAD


35 
±h»ad_mu‹x_t
 
	mmu‹x
;

37 } 
	gdbg
 = {

39 
DBG_INFO
,

40 
DBG_ANSI
,

41 
NULL
,

42 
NULL
,

43 
NULL
,

44 #ifdeà
HAVE_PTHREAD


45 
PTHREAD_MUTEX_INITIALIZER
,

50 #ifdeà
HAVE_PTHREAD


51 
šlše
 
	$dbg_lock
()

53 
	`±h»ad_mu‹x_lock
(&
dbg
.
mu‹x
);

54 
	}
}

57 
šlše
 
	$dbg_uÆock
()

59 
	`±h»ad_mu‹x_uÆock
(&
dbg
.
mu‹x
);

60 
	}
}

62 
	#dbg_lock
(è

	)

63 
	#dbg_uÆock
(è

	)

73 
	$dbg_š™
(
Ëv–
, 
dbg_æags
 
æags
)

75 
dbg
.
tick
 = 
	`tmr_jiff›s
();

76 
dbg
.
Ëv–
 =†evel;

77 
dbg
.
æags
 = flags;

78 
	}
}

84 
	$dbg_şo£
()

86 ià(
dbg
.
f
) {

87 ()
	`fşo£
(
dbg
.
f
);

88 
dbg
.
f
 = 
NULL
;

90 
	}
}

100 
	$dbg_logfe_£t
(cÚ¡ *
Çme
)

102 
time_t
 
t
;

104 
	`dbg_şo£
();

106 ià(!
Çme
)

109 
dbg
.
f
 = 
	`fİ’
(
Çme
, "a+");

110 ià(!
dbg
.
f
)

111  
”ºo
;

113 ()
	`time
(&
t
);

114 ()
	`»_årštf
(
dbg
.
f
, "\n====ğLog S¹ed: %s", 
	`ùime
(&
t
));

115 ()
	`fæush
(
dbg
.
f
);

118 
	}
}

127 
	$dbg_hªdËr_£t
(
dbg_´št_h
 *
ph
, *
¬g
)

129 
dbg
.
ph
 =…h;

130 
dbg
.
¬g
 =‡rg;

131 
	}
}

135 
	$dbg_v´štf
(
Ëv–
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

137 ià(
Ëv–
 > 
dbg
.level)

141 ià(
dbg
.
ph
)

144 
	`dbg_lock
();

146 ià(
dbg
.
æags
 & 
DBG_ANSI
) {

148 
Ëv–
) {

150 
DBG_WARNING
:

151 ()
	`»_årštf
(
¡d”r
, "\x1b[31m");

154 
DBG_NOTICE
:

155 ()
	`»_årštf
(
¡d”r
, "\x1b[33m");

158 
DBG_INFO
:

159 ()
	`»_årštf
(
¡d”r
, "\x1b[32m");

167 ià(
dbg
.
æags
 & 
DBG_TIME
) {

168 cÚ¡ 
ušt64_t
 
ticks
 = 
	`tmr_jiff›s
();

170 ià(0 =ğ
dbg
.
tick
)

171 
dbg
.
tick
 = 
	`tmr_jiff›s
();

173 ()
	`»_årštf
(
¡d”r
, "[%09Îu] ", 
ticks
 - 
dbg
.
tick
);

176 ()
	`»_vårštf
(
¡d”r
, 
fmt
, 
­
);

178 ià(
dbg
.
æags
 & 
DBG_ANSI
 && 
Ëv–
 < 
DBG_DEBUG
)

179 ()
	`»_årštf
(
¡d”r
, "\x1b[;m");

181 
	`dbg_uÆock
();

182 
	}
}

186 
	$dbg_fmt_v´štf
(
Ëv–
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

188 
buf
[256];

189 
Ën
;

191 ià(
Ëv–
 > 
dbg
.level)

194 ià(!
dbg
.
ph
 && !dbg.
f
)

197 
	`dbg_lock
();

199 
Ën
 = 
	`»_v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

200 ià(
Ën
 <= 0)

201 
out
;

204 ià(
dbg
.
ph
) {

205 
dbg
.
	`ph
(
Ëv–
, 
buf
, 
Ën
, dbg.
¬g
);

209 ià(
dbg
.
f
) {

210 ià(
	`fwr™e
(
buf
, 1, 
Ën
, 
dbg
.
f
) > 0)

211 ()
	`fæush
(
dbg
.
f
);

214 
out
:

215 
	`dbg_uÆock
();

216 
	}
}

225 
	$dbg_´štf
(
Ëv–
, cÚ¡ *
fmt
, ...)

227 
va_li¡
 
­
;

229 
	`va_¡¬t
(
­
, 
fmt
);

230 
	`dbg_v´štf
(
Ëv–
, 
fmt
, 
­
);

231 
	`va_’d
(
­
);

233 
	`va_¡¬t
(
­
, 
fmt
);

234 
	`dbg_fmt_v´štf
(
Ëv–
, 
fmt
, 
­
);

235 
	`va_’d
(
­
);

236 
	}
}

244 
	$dbg_nİrštf
(cÚ¡ *
fmt
, ...)

246 ()
fmt
;

247 
	}
}

255 
	$dbg_w¬nšg
(cÚ¡ *
fmt
, ...)

257 
va_li¡
 
­
;

259 
	`va_¡¬t
(
­
, 
fmt
);

260 
	`dbg_v´štf
(
DBG_WARNING
, 
fmt
, 
­
);

261 
	`va_’d
(
­
);

263 
	`va_¡¬t
(
­
, 
fmt
);

264 
	`dbg_fmt_v´štf
(
DBG_WARNING
, 
fmt
, 
­
);

265 
	`va_’d
(
­
);

266 
	}
}

274 
	$dbg_nÙiû
(cÚ¡ *
fmt
, ...)

276 
va_li¡
 
­
;

278 
	`va_¡¬t
(
­
, 
fmt
);

279 
	`dbg_v´štf
(
DBG_NOTICE
, 
fmt
, 
­
);

280 
	`va_’d
(
­
);

282 
	`va_¡¬t
(
­
, 
fmt
);

283 
	`dbg_fmt_v´štf
(
DBG_NOTICE
, 
fmt
, 
­
);

284 
	`va_’d
(
­
);

285 
	}
}

293 
	$dbg_šfo
(cÚ¡ *
fmt
, ...)

295 
va_li¡
 
­
;

297 
	`va_¡¬t
(
­
, 
fmt
);

298 
	`dbg_v´štf
(
DBG_INFO
, 
fmt
, 
­
);

299 
	`va_’d
(
­
);

301 
	`va_¡¬t
(
­
, 
fmt
);

302 
	`dbg_fmt_v´štf
(
DBG_INFO
, 
fmt
, 
­
);

303 
	`va_’d
(
­
);

304 
	}
}

314 cÚ¡ *
	$dbg_Ëv–_¡r
(
Ëv–
)

316 
Ëv–
) {

318 
DBG_EMERG
:  "EMERGENCY";

319 
DBG_ALERT
:  "ALERT";

320 
DBG_CRIT
:  "CRITICAL";

321 
DBG_ERR
:  "ERROR";

322 
DBG_WARNING
:  "WARNING";

323 
DBG_NOTICE
:  "NOTICE";

324 
DBG_INFO
:  "INFO";

325 
DBG_DEBUG
:  "DEBUG";

328 
	}
}

	@re-0.5.6/src/dns/client.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_tmr.h
>

14 
	~<»_§.h
>

15 
	~<»_udp.h
>

16 
	~<»_tı.h
>

17 
	~<»_sys.h
>

18 
	~<»_dns.h
>

21 
	#DEBUG_MODULE
 "dnsc"

	)

22 
	#DEBUG_LEVEL
 5

	)

23 
	~<»_dbg.h
>

27 
	mNTX_MAX
 = 20,

28 
	mQUERY_HASH_SIZE
 = 16,

29 
	mTCP_HASH_SIZE
 = 2,

30 
	mCONN_TIMEOUT
 = 10 * 1000,

31 
	mIDLE_TIMEOUT
 = 30 * 1000,

32 
	mSRVC_MAX
 = 32,

36 
	stıcÚn
 {

37 
Ë
 
	mË
;

38 
li¡
 
	mql
;

39 
tmr
 
	mtmr
;

40 
§
 
	m¤v
;

41 
tı_cÚn
 *
	mcÚn
;

42 
mbuf
 *
	mmb
;

43 
boŞ
 
	mcÚÃùed
;

44 
ušt16_t
 
	mæ’
;

45 
dnsc
 *
	mdnsc
;

49 
	sdns_qu”y
 {

50 
Ë
 
	mË
;

51 
Ë
 
	mË_tc
;

52 
tmr
 
	mtmr
;

53 
mbuf
 
	mmb
;

54 
li¡
 
	m¼lv
[3];

55 *
	mÇme
;

56 cÚ¡ 
§
 *
	m¤vv
;

57 cÚ¡ 
ušt32_t
 *
	m¤vc
;

58 
tıcÚn
 *
	mtc
;

59 
dnsc
 *
	mdnsc
;

60 
dns_qu”y
 **
	mqp
;

61 
ušt32_t
 
	mÁx
;

62 
ušt16_t
 
	mid
;

63 
ušt16_t
 
	mty³
;

64 
ušt16_t
 
	mdnsşass
;

65 
ušt8_t
 
	mİcode
;

66 
dns_qu”y_h
 *
	mqh
;

67 *
	m¬g
;

71 
	sdnsqu”y
 {

72 
dnshdr
 
	mhdr
;

73 *
	mÇme
;

74 
ušt16_t
 
	mty³
;

75 
ušt16_t
 
	mdnsşass
;

79 
	sdnsc
 {

80 
dnsc_cÚf
 
	mcÚf
;

81 
hash
 *
	mht_qu”y
;

82 
hash
 *
	mht_tıcÚn
;

83 
udp_sock
 *
	mus
;

84 
§
 
	m¤vv
[
SRVC_MAX
];

85 
ušt32_t
 
	m¤vc
;

89 cÚ¡ 
dnsc_cÚf
 
	gdeçuÉ_cÚf
 = {

90 
QUERY_HASH_SIZE
,

91 
TCP_HASH_SIZE
,

92 
CONN_TIMEOUT
,

93 
IDLE_TIMEOUT
,

97 
tıcÚn_şo£
(
tıcÚn
 *
tc
, 
”r
);

98 
£nd_tı
(
dns_qu”y
 *
q
);

99 
udp_timeout_hªdËr
(*
¬g
);

102 
boŞ
 
	$¼_uÆšk_hªdËr
(
Ë
 *Ë, *
¬g
)

104 
dn¤r
 *
¼
 = 
Ë
->
d©a
;

105 ()
¬g
;

107 
	`li¡_uÆšk
(&
¼
->
Ë_´iv
);

108 
	`mem_d”ef
(
¼
);

110  
çl£
;

111 
	}
}

114 
	$qu”y_abÜt
(
dns_qu”y
 *
q
)

116 ià(
q
->
tc
) {

117 
	`li¡_uÆšk
(&
q
->
Ë_tc
);

118 
q
->
tc
 = 
	`mem_d”ef
(q->tc);

121 
	`tmr_ÿnûl
(&
q
->
tmr
);

122 
	`hash_uÆšk
(&
q
->
Ë
);

123 
	}
}

126 
	$qu”y_de¡ruùÜ
(*
d©a
)

128 
dns_qu”y
 *
q
 = 
d©a
;

129 
ušt32_t
 
i
;

131 
	`qu”y_abÜt
(
q
);

132 
	`mbuf_»£t
(&
q
->
mb
);

133 
	`mem_d”ef
(
q
->
Çme
);

135 
i
=0; i<
	`ARRAY_SIZE
(
q
->
¼lv
); i++)

136 ()
	`li¡_­¶y
(&
q
->
¼lv
[
i
], 
Œue
, 
¼_uÆšk_hªdËr
, 
NULL
);

137 
	}
}

140 
	$qu”y_hªdËr
(
dns_qu”y
 *
q
, 
”r
,

141 cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

142 
li¡
 *
authl
, li¡ *
addl
)

145 ià(
q
->
qp
)

146 *
q
->
qp
 = 
NULL
;

149 ià(
q
->
qh
) {

150 
q
->
	`qh
(
”r
, 
hdr
, 
ª¦
, 
authl
, 
addl
, q->
¬g
);

151 
q
->
qh
 = 
NULL
;

155 
	`qu”y_abÜt
(
q
);

156 
	}
}

159 
boŞ
 
	$qu”y_şo£_hªdËr
(
Ë
 *Ë, *
¬g
)

161 
dns_qu”y
 *
q
 = 
Ë
->
d©a
;

162 ()
¬g
;

164 
	`qu”y_hªdËr
(
q
, 
ECONNABORTED
, 
NULL
, NULL, NULL, NULL);

165 
	`mem_d”ef
(
q
);

167  
çl£
;

168 
	}
}

171 
boŞ
 
	$qu”y_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

173 
dns_qu”y
 *
q
 = 
Ë
->
d©a
;

174 
dnsqu”y
 *
dq
 = 
¬g
;

176 ià(
q
->
id
 !ğ
dq
->
hdr
.id)

177  
çl£
;

179 ià(
q
->
İcode
 !ğ
dq
->
hdr
.opcode)

180  
çl£
;

182 ià(
q
->
ty³
 !ğ
dq
->type)

183  
çl£
;

185 ià(
q
->
dnsşass
 !ğ
dq
->dnsclass)

186  
çl£
;

188 ià(
	`¡r_ÿ£cmp
(
q
->
Çme
, 
dq
->name))

189  
çl£
;

191  
Œue
;

192 
	}
}

195 
	$»¶y_»cv
(
dnsc
 *dnsc, 
mbuf
 *
mb
)

197 
dns_qu”y
 *
q
 = 
NULL
;

198 
ušt32_t
 
i
, 
j
, 
nv
[3];

199 
dnsqu”y
 
dq
;

200 
”r
 = 0;

202 ià(!
dnsc
 || !
mb
)

203  
EINVAL
;

205 
dq
.
Çme
 = 
NULL
;

207 ià(
	`dns_hdr_decode
(
mb
, &
dq
.
hdr
è|| !dq.hdr.
qr
) {

208 
”r
 = 
EBADMSG
;

209 
out
;

212 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
dq
.
Çme
, 0);

213 ià(
”r
)

214 
out
;

216 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4) {

217 
”r
 = 
EBADMSG
;

218 
out
;

221 
dq
.
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

222 
dq
.
dnsşass
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

224 
q
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
dnsc
->
ht_qu”y
, 
	`hash_jß©_¡r_ci
(
dq
.
Çme
),

225 
qu”y_cmp_hªdËr
, &
dq
));

226 ià(!
q
) {

227 
”r
 = 
ENOENT
;

228 
out
;

232 ià(
dq
.
hdr
.
rcode
 =ğ
DNS_RCODE_SRV_FAIL
 && 
q
->
Áx
 < *q->
¤vc
) {

234 ià(!
q
->
tc
)

235 
	`tmr_¡¬t
(&
q
->
tmr
, 0, 
udp_timeout_hªdËr
, q);

237 
”r
 = 
EPROTO
;

238 
out
;

241 
nv
[0] = 
dq
.
hdr
.
Çns
;

242 
nv
[1] = 
dq
.
hdr
.
Çuth
;

243 
nv
[2] = 
dq
.
hdr
.
Çdd
;

245 
i
=0; i<
	`ARRAY_SIZE
(
nv
); i++) {

247 
j
=0; j<
nv
[
i
]; j++) {

249 
dn¤r
 *
¼
 = 
NULL
;

251 
”r
 = 
	`dns_¼_decode
(
mb
, &
¼
, 0);

252 ià(
”r
) {

253 
	`qu”y_hªdËr
(
q
, 
”r
, 
NULL
, NULL, NULL, NULL);

254 
	`mem_d”ef
(
q
);

255 
out
;

258 
	`li¡_­³nd
(&
q
->
¼lv
[
i
], &
¼
->
Ë_´iv
,„r);

262 ià(
q
->
ty³
 =ğ
DNS_QTYPE_AXFR
) {

264 
dn¤r
 *
¼h
, *
¼t
;

266 
¼h
 = 
	`li¡_Ëd©a
(
	`li¡_h—d
(&
q
->
¼lv
[0]));

267 
¼t
 = 
	`li¡_Ëd©a
(
	`li¡_
(&
q
->
¼lv
[0]));

270 ià(
dq
.
hdr
.
rcode
 =ğ
DNS_RCODE_OK
 && dq.hdr.
Çns
 > 0 &&

271 (!
¼t
 ||„¹->
ty³
 !ğ
DNS_TYPE_SOA
 || 
¼h
 ==„rt)) {

272 
	`DEBUG_INFO
("waiting for†ast SOA„ecord in„eply\n");

273 
out
;

277 
	`qu”y_hªdËr
(
q
, 0, &
dq
.
hdr
, &q->
¼lv
[0], &q->rrlv[1], &q->rrlv[2]);

278 
	`mem_d”ef
(
q
);

280 
out
:

281 
	`mem_d”ef
(
dq
.
Çme
);

283  
”r
;

284 
	}
}

287 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

289 ()
¤c
;

290 ()
	`»¶y_»cv
(
¬g
, 
mb
);

291 
	}
}

294 
	$tı_»cv_hªdËr
(
mbuf
 *
mbrx
, *
¬g
)

296 
tıcÚn
 *
tc
 = 
¬g
;

297 
mbuf
 *
mb
 = 
tc
->mb;

298 
”r
 = 0;

299 
size_t
 
n
;

301 
Ãxt
:

303 ià(!
tc
->
æ’
) {

305 
n
 = 
	`mš
(2 - 
mb
->
’d
, 
	`mbuf_g‘_Ëá
(
mbrx
));

307 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, 
	`mbuf_buf
(
mbrx
), 
n
);

308 ià(
”r
)

309 
”rÜ
;

311 
mbrx
->
pos
 +ğ
n
;

313 ià(
mb
->
’d
 < 2)

316 
mb
->
pos
 = 0;

317 
tc
->
æ’
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

318 
mb
->
pos
 = 0;

319 
mb
->
’d
 = 0;

323 
n
 = 
	`mš
(
tc
->
æ’
 - 
mb
->
’d
, 
	`mbuf_g‘_Ëá
(
mbrx
));

325 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, 
	`mbuf_buf
(
mbrx
), 
n
);

326 ià(
”r
)

327 
”rÜ
;

329 
mbrx
->
pos
 +ğ
n
;

331 ià(
mb
->
’d
 < 
tc
->
æ’
)

334 
mb
->
pos
 = 0;

336 
”r
 = 
	`»¶y_»cv
(
tc
->
dnsc
, 
mb
);

337 ià(
”r
)

338 
”rÜ
;

341 
tc
->
æ’
 = 0;

342 
mb
->
pos
 = 0;

343 
mb
->
’d
 = 0;

346 ià(
	`mbuf_g‘_Ëá
(
mbrx
) > 0) {

347 
	`DEBUG_INFO
("%u by‹ oàtı d©¨Ëá\n", 
	`mbuf_g‘_Ëá
(
mbrx
));

348 
Ãxt
;

353 
”rÜ
:

354 
	`tıcÚn_şo£
(
tc
, 
”r
);

355 
	}
}

358 
	$tıcÚn_timeout_hªdËr
(*
¬g
)

360 
tıcÚn
 *
tc
 = 
¬g
;

362 
	`DEBUG_NOTICE
("tı (%Jè% timeouˆ\n", &
tc
->
¤v
,

363 
tc
->
cÚÃùed
 ? "idle" : "connect");

365 
	`tıcÚn_şo£
(
tc
, 
ETIMEDOUT
);

366 
	}
}

369 
	$tı_e¡ab_hªdËr
(*
¬g
)

371 
tıcÚn
 *
tc
 = 
¬g
;

372 
Ë
 *Ë = 
	`li¡_h—d
(&
tc
->
ql
);

373 
”r
 = 0;

375 
	`DEBUG_INFO
("cÚÃùiÚ (%Jèe¡ablished\n", &
tc
->
¤v
);

377 
Ë
) {

378 
dns_qu”y
 *
q
 = 
Ë
->
d©a
;

380 
Ë
 =†e->
Ãxt
;

382 
q
->
mb
.
pos
 = 0;

383 
”r
 = 
	`tı_£nd
(
tc
->
cÚn
, &
q
->
mb
);

384 ià(
”r
)

387 
	`DEBUG_INFO
("tı s’d %J\n", &
tc
->
¤v
);

390 ià(
”r
) {

391 
	`tıcÚn_şo£
(
tc
, 
”r
);

395 
	`tmr_¡¬t
(&
tc
->
tmr
,c->
dnsc
->
cÚf
.
idË_timeout
,

396 
tıcÚn_timeout_hªdËr
, 
tc
);

397 
tc
->
cÚÃùed
 = 
Œue
;

398 
	}
}

401 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

403 
tıcÚn
 *
tc
 = 
¬g
;

405 
	`DEBUG_NOTICE
("cÚÃùiÚ (%Jèşo£d: %m\n", &
tc
->
¤v
, 
”r
);

406 
	`tıcÚn_şo£
(
tc
, 
”r
);

407 
	}
}

410 
boŞ
 
	$tıcÚn_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

412 cÚ¡ 
tıcÚn
 *
tc
 = 
Ë
->
d©a
;

415 ià(!
tc
->
cÚn
)

416  
çl£
;

418  
	`§_cmp
(&
tc
->
¤v
, 
¬g
, 
SA_ALL
);

419 
	}
}

422 
boŞ
 
	$tıcÚn_ç_hªdËr
(
Ë
 *Ë, *
¬g
)

424 
dns_qu”y
 *
q
 = 
Ë
->
d©a
;

425 
”r
 = *((*)
¬g
);

427 
	`li¡_uÆšk
(&
q
->
Ë_tc
);

428 
q
->
tc
 = 
	`mem_d”ef
(q->tc);

430 ià(
q
->
Áx
 >ğ*q->
¤vc
) {

431 
	`DEBUG_WARNING
("all servers failed, giving up!!\n");

432 
”r
 =ƒ¼ ?ƒ¼ : 
ECONNREFUSED
;

433 
out
;

437 
”r
 = 
	`£nd_tı
(
q
);

438 ià(
”r
) {

439 
	`DEBUG_WARNING
("all servers failed, giving up\n");

440 
out
;

443 
out
:

444 ià(
”r
) {

445 
	`qu”y_hªdËr
(
q
, 
”r
, 
NULL
, NULL, NULL, NULL);

446 
	`mem_d”ef
(
q
);

449  
çl£
;

450 
	}
}

453 
	$tıcÚn_şo£
(
tıcÚn
 *
tc
, 
”r
)

455 ià(!
tc
)

459 
tc
->
cÚn
 = 
	`mem_d”ef
(tc->conn);

460 ()
	`li¡_­¶y
(&
tc
->
ql
, 
Œue
, 
tıcÚn_ç_hªdËr
, &
”r
);

461 
	`mem_d”ef
(
tc
);

462 
	}
}

465 
	$tıcÚn_de¡ruùÜ
(*
¬g
)

467 
tıcÚn
 *
tc
 = 
¬g
;

469 
	`hash_uÆšk
(&
tc
->
Ë
);

470 
	`tmr_ÿnûl
(&
tc
->
tmr
);

471 
	`mem_d”ef
(
tc
->
cÚn
);

472 
	`mem_d”ef
(
tc
->
mb
);

473 
	}
}

476 
	$tıcÚn_®loc
(
tıcÚn
 **
tıp
, 
dnsc
 *dnsc,

477 cÚ¡ 
§
 *
¤v
)

479 
tıcÚn
 *
tc
;

480 
”r
 = 
ENOMEM
;

482 ià(!
tıp
 || !
dnsc
 || !
¤v
)

483  
EINVAL
;

485 
tc
 = 
	`mem_z®loc
((
tıcÚn
), 
tıcÚn_de¡ruùÜ
);

486 ià(!
tc
)

487 
out
;

489 
	`hash_­³nd
(
dnsc
->
ht_tıcÚn
, 
	`§_hash
(
¤v
, 
SA_ALL
), &
tc
->
Ë
,c);

490 
tc
->
¤v
 = *srv;

491 
tc
->
dnsc
 = dnsc;

493 
tc
->
mb
 = 
	`mbuf_®loc
(1500);

494 ià(!
tc
->
mb
)

495 
out
;

497 
”r
 = 
	`tı_cÚÃù
(&
tc
->
cÚn
, 
¤v
, 
tı_e¡ab_hªdËr
,

498 
tı_»cv_hªdËr
, 
tı_şo£_hªdËr
, 
tc
);

499 ià(
”r
)

500 
out
;

502 
	`tmr_¡¬t
(&
tc
->
tmr
,c->
dnsc
->
cÚf
.
cÚn_timeout
,

503 
tıcÚn_timeout_hªdËr
, 
tc
);

504 
out
:

505 ià(
”r
)

506 
	`mem_d”ef
(
tc
);

508 *
tıp
 = 
tc
;

510  
”r
;

511 
	}
}

514 
	$£nd_tı
(
dns_qu”y
 *
q
)

516 cÚ¡ 
§
 *
¤v
;

517 
tıcÚn
 *
tc
;

518 
”r
 = 0;

520 ià(!
q
)

521  
EINVAL
;

523 
q
->
Áx
 < *q->
¤vc
) {

525 
¤v
 = &
q
->
¤vv
[q->
Áx
++];

527 
	`DEBUG_NOTICE
("Œyšgı s”v”#%u: %J\n", 
q
->
Áx
-1, 
¤v
);

529 
tc
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
q
->
dnsc
->
ht_tıcÚn
,

530 
	`§_hash
(
¤v
, 
SA_ALL
),

531 
tıcÚn_cmp_hªdËr
,

532 (*)
¤v
));

533 ià(!
tc
) {

534 
”r
 = 
	`tıcÚn_®loc
(&
tc
, 
q
->
dnsc
, 
¤v
);

535 ià(
”r
)

539 ià(
tc
->
cÚÃùed
) {

540 
q
->
mb
.
pos
 = 0;

541 
”r
 = 
	`tı_£nd
(
tc
->
cÚn
, &
q
->
mb
);

542 ià(
”r
) {

543 
	`tıcÚn_şo£
(
tc
, 
”r
);

547 
	`tmr_¡¬t
(&
tc
->
tmr
,c->
dnsc
->
cÚf
.
idË_timeout
,

548 
tıcÚn_timeout_hªdËr
, 
tc
);

549 
	`DEBUG_NOTICE
("tı s’d %J\n", 
¤v
);

552 
	`li¡_­³nd
(&
tc
->
ql
, &
q
->
Ë_tc
, q);

553 
q
->
tc
 = 
	`mem_»f
(tc);

557  
”r
;

558 
	}
}

561 
	$tı_timeout_hªdËr
(*
¬g
)

563 
dns_qu”y
 *
q
 = 
¬g
;

565 
	`qu”y_hªdËr
(
q
, 
ETIMEDOUT
, 
NULL
, NULL, NULL, NULL);

566 
	`mem_d”ef
(
q
);

567 
	}
}

570 
	$£nd_udp
(
dns_qu”y
 *
q
)

572 cÚ¡ 
§
 *
¤v
;

573 
”r
 = 
ETIMEDOUT
;

574 
ušt32_t
 
i
;

576 ià(!
q
)

577  
EINVAL
;

579 
i
=0; i<*
q
->
¤vc
; i++) {

581 
¤v
 = &
q
->
¤vv
[q->
Áx
++%*q->
¤vc
];

583 
	`DEBUG_INFO
("Œyšg ud°£rv”#%u: %J\n", 
i
, 
¤v
);

585 
q
->
mb
.
pos
 = 0;

586 
”r
 = 
	`udp_£nd
(
q
->
dnsc
->
us
, 
¤v
, &q->
mb
);

587 ià(!
”r
)

591  
”r
;

592 
	}
}

595 
	$udp_timeout_hªdËr
(*
¬g
)

597 
dns_qu”y
 *
q
 = 
¬g
;

598 
”r
 = 
ETIMEDOUT
;

600 ià(
q
->
Áx
 >ğ
NTX_MAX
)

601 
out
;

603 
”r
 = 
	`£nd_udp
(
q
);

604 ià(
”r
)

605 
out
;

607 
	`tmr_¡¬t
(&
q
->
tmr
, 1000<<
	`MIN
(2, q->
Áx
 - 2),

608 
udp_timeout_hªdËr
, 
q
);

610 
out
:

611 ià(
”r
) {

612 
	`qu”y_hªdËr
(
q
, 
”r
, 
NULL
, NULL, NULL, NULL);

613 
	`mem_d”ef
(
q
);

615 
	}
}

618 
	$qu”y
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, 
ušt8_t
 
İcode
,

619 cÚ¡ *
Çme
, 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
,

620 cÚ¡ 
dn¤r
 *
ªs_¼
, 
´Ùo
,

621 cÚ¡ 
§
 *
¤vv
, cÚ¡ 
ušt32_t
 *
¤vc
,

622 
boŞ
 
¯
, boŞ 
rd
, 
dns_qu”y_h
 *
qh
, *
¬g
)

624 
dns_qu”y
 *
q
 = 
NULL
;

625 
dnshdr
 
hdr
;

626 
”r
 = 0;

627 
ušt32_t
 
i
;

629 ià(!
dnsc
 || !
Çme
 || !
¤vv
 || !
¤vc
 || !(*srvc))

630  
EINVAL
;

632 ià(
DNS_QTYPE_AXFR
 =ğ
ty³
)

633 
´Ùo
 = 
IPPROTO_TCP
;

635 
q
 = 
	`mem_z®loc
((*q), 
qu”y_de¡ruùÜ
);

636 ià(!
q
)

637 
nm”r
;

639 
	`hash_­³nd
(
dnsc
->
ht_qu”y
, 
	`hash_jß©_¡r_ci
(
Çme
), &
q
->
Ë
, q);

640 
	`tmr_š™
(&
q
->
tmr
);

641 
	`mbuf_š™
(&
q
->
mb
);

643 
i
=0; i<
	`ARRAY_SIZE
(
q
->
¼lv
); i++)

644 
	`li¡_š™
(&
q
->
¼lv
[
i
]);

646 
”r
 = 
	`¡r_dup
(&
q
->
Çme
,‚ame);

647 ià(
”r
)

648 
”rÜ
;

650 
q
->
¤vv
 = srvv;

651 
q
->
¤vc
 = srvc;

652 
q
->
id
 = 
	`¿nd_u16
();

653 
q
->
ty³
 =ype;

654 
q
->
İcode
 = opcode;

655 
q
->
dnsşass
 = dnsclass;

656 
q
->
dnsc
 = dnsc;

658 
	`mem£t
(&
hdr
, 0, (hdr));

660 
hdr
.
id
 = 
q
->id;

661 
hdr
.
İcode
 = 
q
->opcode;

662 
hdr
.
¯
 =‡a;

663 
hdr
.
rd
 =„d;

664 
hdr
.
nq
 = 1;

665 
hdr
.
Çns
 = 
ªs_¼
 ? 1 : 0;

667 ià(
´Ùo
 =ğ
IPPROTO_TCP
)

668 
q
->
mb
.
pos
 += 2;

670 
”r
 = 
	`dns_hdr_’code
(&
q
->
mb
, &
hdr
);

671 ià(
”r
)

672 
”rÜ
;

674 
”r
 = 
	`dns_dÇme_’code
(&
q
->
mb
, 
Çme
, 
NULL
, 0, 
çl£
);

675 ià(
”r
)

676 
”rÜ
;

678 
”r
 |ğ
	`mbuf_wr™e_u16
(&
q
->
mb
, 
	`htÚs
(
ty³
));

679 
”r
 |ğ
	`mbuf_wr™e_u16
(&
q
->
mb
, 
	`htÚs
(
dnsşass
));

680 ià(
”r
)

681 
”rÜ
;

683 ià(
ªs_¼
) {

684 
”r
 = 
	`dns_¼_’code
(&
q
->
mb
, 
ªs_¼
, 0, 
NULL
, 0);

685 ià(
”r
)

686 
”rÜ
;

689 
q
->
qh
 = qh;

690 
q
->
¬g
 =‡rg;

692 
´Ùo
) {

694 
IPPROTO_TCP
:

695 
q
->
mb
.
pos
 = 0;

696 ()
	`mbuf_wr™e_u16
(&
q
->
mb
, 
	`htÚs
(q->mb.
’d
 - 2));

698 
”r
 = 
	`£nd_tı
(
q
);

699 ià(
”r
)

700 
”rÜ
;

702 
	`tmr_¡¬t
(&
q
->
tmr
, 60 * 1000, 
tı_timeout_hªdËr
, q);

705 
IPPROTO_UDP
:

706 
”r
 = 
	`£nd_udp
(
q
);

707 ià(
”r
)

708 
”rÜ
;

710 
	`tmr_¡¬t
(&
q
->
tmr
, 500, 
udp_timeout_hªdËr
, q);

714 
”r
 = 
EPROTONOSUPPORT
;

715 
”rÜ
;

718 ià(
qp
) {

719 
q
->
qp
 = qp;

720 *
qp
 = 
q
;

725 
nm”r
:

726 
”r
 = 
ENOMEM
;

727 
”rÜ
:

728 
	`mem_d”ef
(
q
);

730  
”r
;

731 
	}
}

748 
	$dnsc_qu”y
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

749 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
,

750 
boŞ
 
rd
, 
dns_qu”y_h
 *
qh
, *
¬g
)

752 ià(!
dnsc
)

753  
EINVAL
;

755  
	`qu”y
(
qp
, 
dnsc
, 
DNS_OPCODE_QUERY
, 
Çme
, 
ty³
, 
dnsşass
, 
NULL
,

756 
IPPROTO_UDP
, 
dnsc
->
¤vv
, &dnsc->
¤vc
, 
çl£
, 
rd
, 
qh
, 
¬g
);

757 
	}
}

777 
	$dnsc_qu”y_¤v
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

778 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, 
´Ùo
,

779 cÚ¡ 
§
 *
¤vv
, cÚ¡ 
ušt32_t
 *
¤vc
,

780 
boŞ
 
rd
, 
dns_qu”y_h
 *
qh
, *
¬g
)

782  
	`qu”y
(
qp
, 
dnsc
, 
DNS_OPCODE_QUERY
, 
Çme
, 
ty³
, 
dnsşass
,

783 
NULL
, 
´Ùo
, 
¤vv
, 
¤vc
, 
çl£
, 
rd
, 
qh
, 
¬g
);

784 
	}
}

804 
	$dnsc_nÙify
(
dns_qu”y
 **
qp
, 
dnsc
 *dnsc, cÚ¡ *
Çme
,

805 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, cÚ¡ 
dn¤r
 *
ªs_¼
,

806 
´Ùo
, cÚ¡ 
§
 *
¤vv
, cÚ¡ 
ušt32_t
 *
¤vc
,

807 
dns_qu”y_h
 *
qh
, *
¬g
)

809  
	`qu”y
(
qp
, 
dnsc
, 
DNS_OPCODE_NOTIFY
, 
Çme
, 
ty³
, 
dnsşass
,

810 
ªs_¼
, 
´Ùo
, 
¤vv
, 
¤vc
, 
Œue
, 
çl£
, 
qh
, 
¬g
);

811 
	}
}

814 
	$dnsc_de¡ruùÜ
(*
d©a
)

816 
dnsc
 *dnsøğ
d©a
;

818 ()
	`hash_­¶y
(
dnsc
->
ht_qu”y
, 
qu”y_şo£_hªdËr
, 
NULL
);

819 
	`hash_æush
(
dnsc
->
ht_tıcÚn
);

821 
	`mem_d”ef
(
dnsc
->
ht_tıcÚn
);

822 
	`mem_d”ef
(
dnsc
->
ht_qu”y
);

823 
	`mem_d”ef
(
dnsc
->
us
);

824 
	}
}

837 
	$dnsc_®loc
(
dnsc
 **
dıp
, cÚ¡ 
dnsc_cÚf
 *
cÚf
,

838 cÚ¡ 
§
 *
¤vv
, 
ušt32_t
 
¤vc
)

840 
dnsc
 *dnsc;

841 
”r
;

843 ià(!
dıp
)

844  
EINVAL
;

846 
dnsc
 = 
	`mem_z®loc
((*dnsc), 
dnsc_de¡ruùÜ
);

847 ià(!
dnsc
)

848  
ENOMEM
;

850 ià(
cÚf
)

851 
dnsc
->
cÚf
 = *conf;

853 
dnsc
->
cÚf
 = 
deçuÉ_cÚf
;

855 
”r
 = 
	`dnsc_¤v_£t
(
dnsc
, 
¤vv
, 
¤vc
);

856 ià(
”r
)

857 
out
;

859 
”r
 = 
	`udp_li¡’
(&
dnsc
->
us
, 
NULL
, 
udp_»cv_hªdËr
, dnsc);

860 ià(
”r
)

861 
out
;

863 
”r
 = 
	`hash_®loc
(&
dnsc
->
ht_qu”y
, dnsc->
cÚf
.
qu”y_hash_size
);

864 ià(
”r
)

865 
out
;

867 
”r
 = 
	`hash_®loc
(&
dnsc
->
ht_tıcÚn
, dnsc->
cÚf
.
tı_hash_size
);

868 ià(
”r
)

869 
out
;

871 
out
:

872 ià(
”r
)

873 
	`mem_d”ef
(
dnsc
);

875 *
dıp
 = 
dnsc
;

877  
”r
;

878 
	}
}

890 
	$dnsc_¤v_£t
(
dnsc
 *dnsc, cÚ¡ 
§
 *
¤vv
, 
ušt32_t
 
¤vc
)

892 
ušt32_t
 
i
;

894 ià(!
dnsc
)

895  
EINVAL
;

897 
dnsc
->
¤vc
 = 
	`mš
((
ušt32_t
)
	`ARRAY_SIZE
(dnsc->
¤vv
), srvc);

899 ià(
¤vv
) {

900 
i
=0; i<
dnsc
->
¤vc
; i++)

901 
dnsc
->
¤vv
[
i
] = srvv[i];

905 
	}
}

	@re-0.5.6/src/dns/cstr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_li¡.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_dns.h
>

23 
	$dns_c¡r_’code
(
mbuf
 *
mb
, cÚ¡ *
¡r
)

25 
ušt8_t
 
Ën
;

26 
”r
 = 0;

28 ià(!
mb
 || !
¡r
)

29  
EINVAL
;

31 
Ën
 = (
ušt8_t
)
	`¡¾’
(
¡r
);

33 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
Ën
);

34 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
¡r
, 
Ën
);

36  
”r
;

37 
	}
}

48 
	$dns_c¡r_decode
(
mbuf
 *
mb
, **
¡r
)

50 
ušt8_t
 
Ën
;

52 ià(!
mb
 || !
¡r
 || (
	`mbuf_g‘_Ëá
(mb) < 1))

53  
EINVAL
;

55 
Ën
 = 
	`mbuf_»ad_u8
(
mb
);

57 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ën
)

58  
EBADMSG
;

60  
	`mbuf_¡rdup
(
mb
, 
¡r
, 
Ën
);

61 
	}
}

	@re-0.5.6/src/dns/darwin/srv.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_§.h
>

11 
	~<»_dns.h
>

12 
	~"../dns.h
"

13 
	#__CF_USE_FRAMEWORK_INCLUDES__


	)

14 
	~<Sy¡emCÚfigu¿tiÚ/Sy¡emCÚfigu¿tiÚ.h
>

17 
	$g‘_d¬wš_dns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
nsv
, 
ušt32_t
 *
n
)

19 #ià
TARGET_OS_IPHONE


20 ()
domaš
;

21 ()
dsize
;

22 ()
nsv
;

23 ()
n
;

24  
ENOSYS
;

26 
SCDyÇmicStÜeCÚ‹xt
 
cÚ‹xt
 = {0, 
NULL
, NULL, NULL, NULL};

27 
CFA¼ayRef
 
add»s£s
, 
domašs
;

28 
SCDyÇmicStÜeRef
 
¡Üe
;

29 
CFSŒšgRef
 
key
, 
dom
;

30 
CFDiùiÚ¬yRef
 
diù
;

31 
ušt32_t
 
c
, 
i
;

32 
”r
 = 
ENOENT
;

34 ià(!
nsv
 || !
n
)

35  
EINVAL
;

37 
¡Üe
 = 
	`SCDyÇmicStÜeC»©e
(
NULL
, 
	`CFSTR
("get_darwin_dns"),

38 
NULL
, &
cÚ‹xt
);

39 ià(!
¡Üe
)

40  
ENOENT
;

42 
key
 = 
	`CFSTR
("State:/Network/Global/DNS");

43 
diù
 = 
	`SCDyÇmicStÜeCİyV®ue
(
¡Üe
, 
key
);

44 ià(!
diù
)

45 
out1
;

47 
add»s£s
 = 
	`CFDiùiÚ¬yG‘V®ue
(
diù
, 
kSCPrİN‘DNSS”v”Add»s£s
);

48 ià(!
add»s£s
)

49 
out
;

51 
c
 = (
ušt32_t
)
	`CFA¼ayG‘CouÁ
(
add»s£s
);

52 *
n
 = 
	`mš
(*n, 
c
);

54 
i
=0; i<*
n
; i++) {

55 
CFSŒšgRef
 
add»ss
 = 
	`CFA¼ayG‘V®ueAtIndex
(
add»s£s
, 
i
);

56 
¡r
[64];

58 
	`CFSŒšgG‘CSŒšg
(
add»ss
, 
¡r
, (str),

59 
kCFSŒšgEncodšgUTF8
);

61 
”r
 = 
	`§_£t_¡r
(&
nsv
[
i
], 
¡r
, 
DNS_PORT
);

62 ià(
”r
)

66 
domašs
 = 
	`CFDiùiÚ¬yG‘V®ue
(
diù
, 
kSCPrİN‘DNSS—rchDomašs
);

67 ià(!
domašs
)

68 
out
;

70 ià(
	`CFA¼ayG‘CouÁ
(
domašs
) < 1)

71 
out
;

73 
dom
 = 
	`CFA¼ayG‘V®ueAtIndex
(
domašs
, 0);

74 
	`CFSŒšgG‘CSŒšg
(
dom
, 
domaš
, 
dsize
, 
kCFSŒšgEncodšgUTF8
);

76 
out
:

77 
	`CFR–—£
(
diù
);

78 
out1
:

79 
	`CFR–—£
(
¡Üe
);

81  
”r
;

83 
	}
}

	@re-0.5.6/src/dns/dname.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_hash.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_Ãt.h
>

13 
	~<»_dns.h
>

16 
	#COMP_MASK
 0xc0

	)

17 
	#OFFSET_MASK
 0x3fff

	)

18 
	#COMP_LOOP
 255

	)

21 
	sdÇme
 {

22 
Ë
 
	mhe
;

23 
size_t
 
	mpos
;

24 *
	mÇme
;

28 
	$de¡ruùÜ
(*
¬g
)

30 
dÇme
 *
dn
 = 
¬g
;

32 
	`hash_uÆšk
(&
dn
->
he
);

33 
	`mem_d”ef
(
dn
->
Çme
);

34 
	}
}

37 
	$dÇme_­³nd
(
hash
 *
ht_dÇme
, cÚ¡ *
Çme
, 
size_t
 
pos
)

39 
dÇme
 *
dn
;

41 ià(!
ht_dÇme
 || 
pos
 > 
OFFSET_MASK
 || !*
Çme
)

44 
dn
 = 
	`mem_z®loc
((*dn), 
de¡ruùÜ
);

45 ià(!
dn
)

48 ià(
	`¡r_dup
(&
dn
->
Çme
,‚ame)) {

49 
	`mem_d”ef
(
dn
);

53 
	`hash_­³nd
(
ht_dÇme
, 
	`hash_jß©_¡r_ci
(
Çme
), &
dn
->
he
, dn);

54 
dn
->
pos
 =…os;

55 
	}
}

58 
boŞ
 
	$lookup_hªdËr
(
Ë
 *Ë, *
¬g
)

60 
dÇme
 *
dn
 = 
Ë
->
d©a
;

62  0 =ğ
	`¡r_ÿ£cmp
(
dn
->
Çme
, 
¬g
);

63 
	}
}

66 
šlše
 
dÇme
 *
	$dÇme_lookup
(
hash
 *
ht_dÇme
,

67 cÚ¡ *
Çme
)

69  
	`li¡_Ëd©a
(
	`hash_lookup
(
ht_dÇme
, 
	`hash_jß©_¡r_ci
(
Çme
),

70 
lookup_hªdËr
, (*)
Çme
));

71 
	}
}

74 
šlše
 
	$dÇme_’code_poš‹r
(
mbuf
 *
mb
, 
size_t
 
pos
)

76  
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
pos
 | (
COMP_MASK
<<8)));

77 
	}
}

91 
	$dns_dÇme_’code
(
mbuf
 *
mb
, cÚ¡ *
Çme
,

92 
hash
 *
ht_dÇme
, 
size_t
 
¡¬t
, 
boŞ
 
comp
)

94 
dÇme
 *
dn
;

95 
size_t
 
pos
;

96 
”r
;

98 ià(!
mb
 || !
Çme
)

99  
EINVAL
;

101 
dn
 = 
	`dÇme_lookup
(
ht_dÇme
, 
Çme
);

102 ià(
dn
 && 
comp
)

103  
	`dÇme_’code_poš‹r
(
mb
, 
dn
->
pos
);

105 
pos
 = 
mb
->pos;

106 ià(!
dn
)

107 
	`dÇme_­³nd
(
ht_dÇme
, 
Çme
, 
pos
 - 
¡¬t
);

108 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 0);

110 ià('.' =ğ
Çme
[0] && '\0' ==‚ame[1])

111  
”r
;

113 
”r
 == 0) {

115 cÚ¡ 
size_t
 
ÏbËn
 = 
mb
->
pos
 -…os - 1;

117 ià('\0' =ğ*
Çme
) {

118 ià(!
ÏbËn
)

121 
mb
->
buf
[
pos
] = 
ÏbËn
;

122 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0);

125 ià('.' =ğ*
Çme
) {

126 ià(!
ÏbËn
)

127  
EINVAL
;

129 
mb
->
buf
[
pos
] = 
ÏbËn
;

131 
dn
 = 
	`dÇme_lookup
(
ht_dÇme
, 
Çme
 + 1);

132 ià(
dn
 && 
comp
) {

133 
”r
 |ğ
	`dÇme_’code_poš‹r
(
mb
, 
dn
->
pos
);

137 
pos
 = 
mb
->pos;

138 ià(!
dn
)

139 
	`dÇme_­³nd
(
ht_dÇme
, 
Çme
 + 1, 
pos
 - 
¡¬t
);

140 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0);

143 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, *
Çme
);

146 ++
Çme
;

149  
”r
;

150 
	}
}

162 
	$dns_dÇme_decode
(
mbuf
 *
mb
, **
Çme
, 
size_t
 
¡¬t
)

164 
ušt32_t
 
i
 = 0, 
loİc
 = 0;

165 
boŞ
 
comp
 = 
çl£
;

166 
size_t
 
pos
 = 0;

167 
buf
[256];

169 ià(!
mb
 || !
Çme
)

170  
EINVAL
;

172 
mb
->
pos
 < mb->
’d
) {

174 
ušt8_t
 
Ën
 = 
mb
->
buf
[mb->
pos
++];

175 ià(!
Ën
) {

176 ià(
comp
)

177 
mb
->
pos
 =…os;

179 
buf
[
i
++] = '\0';

181 *
Çme
 = 
	`mem_®loc
(
i
, 
NULL
);

182 ià(!*
Çme
)

183  
ENOMEM
;

185 
	`¡r_nıy
(*
Çme
, 
buf
, 
i
);

189 ià((
Ën
 & 
COMP_MASK
) == COMP_MASK) {

190 
ušt16_t
 
off£t
;

192 ià(
loİc
++ > 
COMP_LOOP
)

195 --
mb
->
pos
;

197 
off£t
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
)è& 
OFFSET_MASK
;

198 ià(!
comp
) {

199 
pos
 = 
mb
->pos;

200 
comp
 = 
Œue
;

203 
mb
->
pos
 = 
off£t
 + 
¡¬t
;

206 ià(
Ën
 > 
	`mbuf_g‘_Ëá
(
mb
))

208 ià(
Ën
 > (
buf
è- 
i
 - 2)

211 ià(
i
 > 0)

212 
buf
[
i
++] = '.';

214 
Ën
--)

215 
buf
[
i
++] = 
mb
->buf[mb->
pos
++];

218  
EINVAL
;

219 
	}
}

	@re-0.5.6/src/dns/dns.h

8 #ifdeà
HAVE_RESOLV


9 
g‘_»sŞv_dns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
nsv
, 
ušt32_t
 *
n
);

11 #ifdeà
WIN32


12 
g‘_wšdns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
Çv
, 
ušt32_t
 *
n
);

14 #ifdeà
DARWIN


15 
g‘_d¬wš_dns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
nsv
, 
ušt32_t
 *
n
);

	@re-0.5.6/src/dns/hdr.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_Ãt.h
>

11 
	~<»_dns.h
>

15 
	mQUERY_RESPONSE
 = 15,

16 
	mOPCODE
 = 11,

17 
	mAUTH_ANSWER
 = 10,

18 
	mTRUNCATED
 = 9,

19 
	mRECURSION_DESIRED
 = 8,

20 
	mRECURSION_AVAILABLE
 = 7,

21 
	mZERO
 = 4

33 
	$dns_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
dnshdr
 *
hdr
)

35 
ušt16_t
 
æags
 = 0;

36 
”r
 = 0;

38 ià(!
mb
 || !
hdr
)

39  
EINVAL
;

41 
æags
 |ğ
hdr
->
qr
 <<
QUERY_RESPONSE
;

42 
æags
 |ğ
hdr
->
İcode
 <<
OPCODE
;

43 
æags
 |ğ
hdr
->
¯
 <<
AUTH_ANSWER
;

44 
æags
 |ğ
hdr
->
tc
 <<
TRUNCATED
;

45 
æags
 |ğ
hdr
->
rd
 <<
RECURSION_DESIRED
;

46 
æags
 |ğ
hdr
->
¿
 <<
RECURSION_AVAILABLE
;

47 
æags
 |ğ
hdr
->
z
 <<
ZERO
;

48 
æags
 |ğ
hdr
->
rcode
;

50 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
id
));

51 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
æags
));

52 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
nq
));

53 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Çns
));

54 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Çuth
));

55 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Çdd
));

57  
”r
;

58 
	}
}

69 
	$dns_hdr_decode
(
mbuf
 *
mb
, 
dnshdr
 *
hdr
)

71 
ušt16_t
 
æags
 = 0;

73 ià(!
mb
 || !
hdr
 || (
	`mbuf_g‘_Ëá
(mbè< 
DNS_HEADER_SIZE
))

74  
EINVAL
;

76 
hdr
->
id
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

77 
æags
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

79 
hdr
->
qr
 = 0x1 & (
æags
 >> 
QUERY_RESPONSE
);

80 
hdr
->
İcode
 = 0xà& (
æags
 >> 
OPCODE
);

81 
hdr
->
¯
 = 0x1 & (
æags
 >> 
AUTH_ANSWER
);

82 
hdr
->
tc
 = 0x1 & (
æags
 >> 
TRUNCATED
);

83 
hdr
->
rd
 = 0x1 & (
æags
 >> 
RECURSION_DESIRED
);

84 
hdr
->
¿
 = 0x1 & (
æags
 >> 
RECURSION_AVAILABLE
);

85 
hdr
->
z
 = 0x7 & (
æags
 >> 
ZERO
);

86 
hdr
->
rcode
 = 0xà& (
æags
 >> 0);

88 
hdr
->
nq
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

89 
hdr
->
Çns
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

90 
hdr
->
Çuth
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

91 
hdr
->
Çdd
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

94 
	}
}

104 cÚ¡ *
	$dns_hdr_İcod’ame
(
ušt8_t
 
İcode
)

106 
İcode
) {

108 
DNS_OPCODE_QUERY
:  "QUERY";

109 
DNS_OPCODE_IQUERY
:  "IQUERY";

110 
DNS_OPCODE_STATUS
:  "STATUS";

111 
DNS_OPCODE_NOTIFY
:  "NOTIFY";

114 
	}
}

124 cÚ¡ *
	$dns_hdr_rcod’ame
(
ušt8_t
 
rcode
)

126 
rcode
) {

128 
DNS_RCODE_OK
:  "OK";

129 
DNS_RCODE_FMT_ERR
:  "Format Error";

130 
DNS_RCODE_SRV_FAIL
:  "Server Failure";

131 
DNS_RCODE_NAME_ERR
:  "Name Error";

132 
DNS_RCODE_NOT_IMPL
:  "Not Implemented";

133 
DNS_RCODE_REFUSED
:  "Refused";

134 
DNS_RCODE_NOT_AUTH
:  "Server Not Authoritative for zone";

137 
	}
}

	@re-0.5.6/src/dns/ns.c

6 
	~<¡dio.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_dns.h
>

13 
	~"dns.h
"

14 #ifdeà
__ANDROID__


15 
	~<sys/sy¡em_´İ”t›s.h
>

19 
	#DEBUG_MODULE
 "ns"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

24 
	$·r£_»sŞv_cÚf
(*
domaš
, 
size_t
 
dsize
,

25 
§
 *
¤vv
, 
ušt32_t
 *
n
)

27 
FILE
 *
f
;

28 
¶
 
dom
 = 
¶_nuÎ
;

29 
ušt32_t
 
i
 = 0;

30 
”r
 = 0;

32 ià(!
¤vv
 || !
n
 || !*n)

33  
EINVAL
;

35 
f
 = 
	`fİ’
("/etc/resolv.conf", "r");

36 ià(!
f
)

37  
”ºo
;

40 
lše
[128];

41 
¶
 
¤v
;

42 
size_t
 
Ën
;

44 ià(1 !ğ
	`fsÿnf
(
f
, "%127[^\n]\n", 
lše
))

47 ià('#' =ğ
lše
[0])

50 
Ën
 = 
	`¡r_Ën
(
lše
);

53 ià(!
	`¶_is£t
(&
dom
)) {

54 ià(0 =ğ
	`»_»gex
(
lše
, 
Ën
, "domaš [^ ]+", &
dom
)) {

55 ()
	`¶_¡rıy
(&
dom
, 
domaš
, 
dsize
);

58 ià(0 =ğ
	`»_»gex
(
lše
, 
Ën
, "£¬ch [^ ]+", &
dom
)) {

59 ()
	`¶_¡rıy
(&
dom
, 
domaš
, 
dsize
);

64 ià(
i
 < *
n
 && 0 =ğ
	`»_»gex
(
lše
, 
Ën
, "nameserver [^\n]+",

65 &
¤v
)) {

66 
”r
 = 
	`§_£t
(&
¤vv
[
i
], &
¤v
, 
DNS_PORT
);

67 ià(
”r
) {

68 
	`DEBUG_WARNING
("§_£t: %¸(%m)\n", &
¤v
, 
”r
);

70 ++
i
;

74 *
n
 = 
i
;

76 ()
	`fşo£
(
f
);

78  
”r
;

79 
	}
}

82 #ifdeà
__ANDROID__


83 
	$g‘_ªdroid_dns
(
§
 *
nsv
, 
ušt32_t
 *
n
)

85 
´İ
[
PROP_NAME_MAX
] = {0}, 
v®ue
[
PROP_VALUE_MAX
] = {0};

86 
ušt32_t
 
i
, 
couÁ
 = 0;

87 
”r
;

89 
i
=0; i<*
n
; i++) {

90 
	`»_¢´štf
(
´İ
, Õrİ), "Ãt.dns%u", 1+
i
);

92 ià(
	`__sy¡em_´İ”ty_g‘
(
´İ
, 
v®ue
)) {

94 
”r
 = 
	`§_£t_¡r
(&
nsv
[
couÁ
], 
v®ue
, 
DNS_PORT
);

95 ià(!
”r
)

96 ++
couÁ
;

99 ià(
couÁ
 == 0)

100  
ENOENT
;

102 *
n
 = 
couÁ
;

105 
	}
}

119 
	$dns_¤v_g‘
(*
domaš
, 
size_t
 
dsize
, 
§
 *
¤vv
, 
ušt32_t
 *
n
)

121 
”r
;

125 #ifdeà
HAVE_RESOLV


126 
”r
 = 
	`g‘_»sŞv_dns
(
domaš
, 
dsize
, 
¤vv
, 
n
);

127 ià(!
”r
)

131 #ifdeà
DARWIN


132 
”r
 = 
	`g‘_d¬wš_dns
(
domaš
, 
dsize
, 
¤vv
, 
n
);

133 ià(!
”r
)

137 
”r
 = 
	`·r£_»sŞv_cÚf
(
domaš
, 
dsize
, 
¤vv
, 
n
);

138 ià(!
”r
)

141 #ifdeà
WIN32


142 
”r
 = 
	`g‘_wšdns
(
domaš
, 
dsize
, 
¤vv
, 
n
);

145 #ifdeà
__ANDROID__


146 
”r
 = 
	`g‘_ªdroid_dns
(
¤vv
, 
n
);

149  
”r
;

150 
	}
}

	@re-0.5.6/src/dns/res.c

6 
	#_BSD_SOURCE
 1

	)

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	~<sys/ty³s.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/Çme£r.h
>

11 
	~<»sŞv.h
>

12 
	~<¡ršg.h
>

13 
	~<»_ty³s.h
>

14 
	~<»_fmt.h
>

15 
	~<»_mbuf.h
>

16 
	~<»_li¡.h
>

17 
	~<»_§.h
>

18 
	~<»_dns.h
>

19 
	~"dns.h
"

22 
	$g‘_»sŞv_dns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
nsv
, 
ušt32_t
 *
n
)

24 
__»s_¡©e
 
¡©e
;

25 
ušt32_t
 
i
;

26 
»t
, 
”r
;

28 #ifdeà
OPENBSD


29 
»t
 = 
	`»s_š™
();

30 
¡©e
 = 
_»s
;

32 
	`mem£t
(&
¡©e
, 0, (state));

33 
»t
 = 
	`»s_nš™
(&
¡©e
);

35 ià(0 !ğ
»t
)

36  
ENOENT
;

38 ià(
¡©e
.
dn¤ch
[0])

39 
	`¡r_nıy
(
domaš
, 
¡©e
.
dn¤ch
[0], 
dsize
);

40 ià((*)
¡©e
.
defdÇme
)

41 
	`¡r_nıy
(
domaš
, 
¡©e
.
defdÇme
, 
dsize
);

43 ià(!
¡©e
.
nscouÁ
) {

44 
”r
 = 
ENOENT
;

45 
out
;

48 
”r
 = 0;

49 
i
=0; i<
	`mš
(*
n
, (
ušt32_t
)
¡©e
.
nscouÁ
è&& !
”r
; i++) {

50 
sockaddr_š
 *
addr
 = &
¡©e
.
n§ddr_li¡
[
i
];

51 
”r
 |ğ
	`§_£t_§
(&
nsv
[
i
], (
sockaddr
 *)
addr
);

53 ià(
”r
)

54 
out
;

56 *
n
 = 
i
;

58 
out
:

59 #ifdeà
OPENBSD


61 
	`»s_nşo£
(&
¡©e
);

64  
”r
;

65 
	}
}

	@re-0.5.6/src/dns/rr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_li¡.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_Ãt.h
>

13 
	~<»_§.h
>

14 
	~<»_dns.h
>

17 
	$¼_de¡ruùÜ
(*
d©a
)

19 
dn¤r
 *
¼
 = 
d©a
;

21 
	`mem_d”ef
(
¼
->
Çme
);

23 
¼
->
ty³
) {

25 
DNS_TYPE_NS
:

26 
	`mem_d”ef
(
¼
->
rd©a
.
ns
.
nsdÇme
);

29 
DNS_TYPE_CNAME
:

30 
	`mem_d”ef
(
¼
->
rd©a
.
úame
.cname);

33 
DNS_TYPE_SOA
:

34 
	`mem_d”ef
(
¼
->
rd©a
.
sß
.
mÇme
);

35 
	`mem_d”ef
(
¼
->
rd©a
.
sß
.
ºame
);

38 
DNS_TYPE_PTR
:

39 
	`mem_d”ef
(
¼
->
rd©a
.
±r
.
±rdÇme
);

42 
DNS_TYPE_MX
:

43 
	`mem_d”ef
(
¼
->
rd©a
.
mx
.
exchªge
);

46 
DNS_TYPE_SRV
:

47 
	`mem_d”ef
(
¼
->
rd©a
.
¤v
.
rg‘
);

50 
DNS_TYPE_NAPTR
:

51 
	`mem_d”ef
(
¼
->
rd©a
.
Ç±r
.
æags
);

52 
	`mem_d”ef
(
¼
->
rd©a
.
Ç±r
.
£rviûs
);

53 
	`mem_d”ef
(
¼
->
rd©a
.
Ç±r
.
»gexp
);

54 
	`mem_d”ef
(
¼
->
rd©a
.
Ç±r
.
»¶aû
);

57 
	}
}

65 
dn¤r
 *
	$dns_¼_®loc
()

67  
	`mem_z®loc
((
dn¤r
), 
¼_de¡ruùÜ
);

68 
	}
}

82 
	$dns_¼_’code
(
mbuf
 *
mb
, cÚ¡ 
dn¤r
 *
¼
, 
št64_t
 
‰l_offs
,

83 
hash
 *
ht_dÇme
, 
size_t
 
¡¬t
)

85 
ušt32_t
 
‰l
;

86 
ušt16_t
 
Ën
;

87 
size_t
 
¡¬t_rd©a
;

88 
”r
 = 0;

90 ià(!
mb
 || !
¼
)

91  
EINVAL
;

93 
‰l
 = (
ušt32_t
)((
¼
->‰È> 
‰l_offs
) ? (rr->ttl -tl_offs) : 0);

95 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
Çme
, 
ht_dÇme
, 
¡¬t
, 
Œue
);

96 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
ty³
));

97 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
dnsşass
));

98 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
‰l
));

99 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rdËn
));

101 
¡¬t_rd©a
 = 
mb
->
pos
;

103 
¼
->
ty³
) {

105 
DNS_TYPE_A
:

106 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
a
.
addr
));

109 
DNS_TYPE_NS
:

110 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
ns
.
nsdÇme
,

111 
ht_dÇme
, 
¡¬t
, 
Œue
);

114 
DNS_TYPE_CNAME
:

115 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
úame
.cname,

116 
ht_dÇme
, 
¡¬t
, 
Œue
);

119 
DNS_TYPE_SOA
:

120 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
sß
.
mÇme
,

121 
ht_dÇme
, 
¡¬t
, 
Œue
);

122 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
sß
.
ºame
,

123 
ht_dÇme
, 
¡¬t
, 
Œue
);

124 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
sß
.
£rŸl
));

125 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
sß
.
»äesh
));

126 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
sß
.
»Œy
));

127 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
sß
.
expœe
));

128 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
rd©a
.
sß
.
‰lmš
));

131 
DNS_TYPE_PTR
:

132 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
±r
.
±rdÇme
,

133 
ht_dÇme
, 
¡¬t
, 
Œue
);

136 
DNS_TYPE_MX
:

137 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
mx
.
´ef
));

138 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
mx
.
exchªge
,

139 
ht_dÇme
, 
¡¬t
, 
Œue
);

142 
DNS_TYPE_AAAA
:

143 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
¼
->
rd©a
.
¯¯
.
addr
, 16);

146 
DNS_TYPE_SRV
:

147 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
¤v
.
´i
));

148 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
¤v
.
weight
));

149 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
¤v
.
pÜt
));

150 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
¤v
.
rg‘
,

151 
ht_dÇme
, 
¡¬t
, 
çl£
);

154 
DNS_TYPE_NAPTR
:

155 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
Ç±r
.
Üd”
));

156 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
¼
->
rd©a
.
Ç±r
.
´ef
));

157 
”r
 |ğ
	`dns_c¡r_’code
(
mb
, 
¼
->
rd©a
.
Ç±r
.
æags
);

158 
”r
 |ğ
	`dns_c¡r_’code
(
mb
, 
¼
->
rd©a
.
Ç±r
.
£rviûs
);

159 
”r
 |ğ
	`dns_c¡r_’code
(
mb
, 
¼
->
rd©a
.
Ç±r
.
»gexp
);

160 
”r
 |ğ
	`dns_dÇme_’code
(
mb
, 
¼
->
rd©a
.
Ç±r
.
»¶aû
,

161 
ht_dÇme
, 
¡¬t
, 
çl£
);

165 
”r
 = 
EINVAL
;

169 
Ën
 = 
mb
->
pos
 - 
¡¬t_rd©a
;

170 
mb
->
pos
 = 
¡¬t_rd©a
 - 2;

171 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
Ën
));

172 
mb
->
pos
 +ğ
Ën
;

174  
”r
;

175 
	}
}

187 
	$dns_¼_decode
(
mbuf
 *
mb
, 
dn¤r
 **
¼
, 
size_t
 
¡¬t
)

189 
”r
 = 0;

190 
dn¤r
 *
Ìr
;

192 ià(!
mb
 || !
¼
)

193  
EINVAL
;

195 
Ìr
 = 
	`dns_¼_®loc
();

196 ià(!
Ìr
)

197  
ENOMEM
;

199 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
Çme
, 
¡¬t
);

200 ià(
”r
)

201 
”rÜ
;

203 ià(
	`mbuf_g‘_Ëá
(
mb
) < 10)

204 
fm”r
;

206 
Ìr
->
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

207 
Ìr
->
dnsşass
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

208 
Ìr
->
‰l
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

209 
Ìr
->
rdËn
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

211 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ìr
->
rdËn
)

212 
fm”r
;

214 
Ìr
->
ty³
) {

216 
DNS_TYPE_A
:

217 ià(
Ìr
->
rdËn
 != 4)

218 
fm”r
;

220 
Ìr
->
rd©a
.
a
.
addr
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

223 
DNS_TYPE_NS
:

224 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
ns
.
nsdÇme
, 
¡¬t
);

225 ià(
”r
)

226 
”rÜ
;

230 
DNS_TYPE_CNAME
:

231 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
úame
.úame, 
¡¬t
);

232 ià(
”r
)

233 
”rÜ
;

237 
DNS_TYPE_SOA
:

238 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
sß
.
mÇme
, 
¡¬t
);

239 ià(
”r
)

240 
”rÜ
;

242 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
sß
.
ºame
, 
¡¬t
);

243 ià(
”r
)

244 
”rÜ
;

246 ià(
	`mbuf_g‘_Ëá
(
mb
) < 20)

247 
fm”r
;

249 
Ìr
->
rd©a
.
sß
.
£rŸl
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

250 
Ìr
->
rd©a
.
sß
.
»äesh
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

251 
Ìr
->
rd©a
.
sß
.
»Œy
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

252 
Ìr
->
rd©a
.
sß
.
expœe
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

253 
Ìr
->
rd©a
.
sß
.
‰lmš
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

256 
DNS_TYPE_PTR
:

257 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
±r
.
±rdÇme
, 
¡¬t
);

258 ià(
”r
)

259 
”rÜ
;

263 
DNS_TYPE_MX
:

264 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

265 
fm”r
;

267 
Ìr
->
rd©a
.
mx
.
´ef
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

269 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
mx
.
exchªge
, 
¡¬t
);

270 ià(
”r
)

271 
”rÜ
;

275 
DNS_TYPE_AAAA
:

276 ià(
Ìr
->
rdËn
 != 16)

277 
fm”r
;

279 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
Ìr
->
rd©a
.
¯¯
.
addr
, 16);

280 ià(
”r
)

281 
”rÜ
;

284 
DNS_TYPE_SRV
:

285 ià(
	`mbuf_g‘_Ëá
(
mb
) < 6)

286 
fm”r
;

288 
Ìr
->
rd©a
.
¤v
.
´i
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

289 
Ìr
->
rd©a
.
¤v
.
weight
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

290 
Ìr
->
rd©a
.
¤v
.
pÜt
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

292 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
¤v
.
rg‘
, 
¡¬t
);

293 ià(
”r
)

294 
”rÜ
;

298 
DNS_TYPE_NAPTR
:

299 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

300 
fm”r
;

302 
Ìr
->
rd©a
.
Ç±r
.
Üd”
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

303 
Ìr
->
rd©a
.
Ç±r
.
´ef
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

305 
”r
 = 
	`dns_c¡r_decode
(
mb
, &
Ìr
->
rd©a
.
Ç±r
.
æags
);

306 ià(
”r
)

307 
”rÜ
;

309 
”r
 = 
	`dns_c¡r_decode
(
mb
, &
Ìr
->
rd©a
.
Ç±r
.
£rviûs
);

310 ià(
”r
)

311 
”rÜ
;

313 
”r
 = 
	`dns_c¡r_decode
(
mb
, &
Ìr
->
rd©a
.
Ç±r
.
»gexp
);

314 ià(
”r
)

315 
”rÜ
;

317 
”r
 = 
	`dns_dÇme_decode
(
mb
, &
Ìr
->
rd©a
.
Ç±r
.
»¶aû
, 
¡¬t
);

318 ià(
”r
)

319 
”rÜ
;

324 
mb
->
pos
 +ğ
Ìr
->
rdËn
;

328 *
¼
 = 
Ìr
;

332 
fm”r
:

333 
”r
 = 
EINVAL
;

334 
”rÜ
:

335 
	`mem_d”ef
(
Ìr
);

337  
”r
;

338 
	}
}

350 
boŞ
 
	$dns_¼_cmp
(cÚ¡ 
dn¤r
 *
¼1
, cÚ¡ dn¤¸*
¼2
, 
boŞ
 
rd©a
)

352 ià(!
¼1
 || !
¼2
)

353  
çl£
;

355 ià(
¼1
 =ğ
¼2
)

356  
Œue
;

358 ià(
¼1
->
ty³
 !ğ
¼2
->type)

359  
çl£
;

361 ià(
¼1
->
dnsşass
 !ğ
¼2
->dnsclass)

362  
çl£
;

364 ià(
	`¡r_ÿ£cmp
(
¼1
->
Çme
, 
¼2
->name))

365  
çl£
;

367 ià(!
rd©a
)

368  
Œue
;

370 
¼1
->
ty³
) {

372 
DNS_TYPE_A
:

373 ià(
¼1
->
rd©a
.
a
.
addr
 !ğ
¼2
->rdata.a.addr)

374  
çl£
;

378 
DNS_TYPE_NS
:

379 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
ns
.
nsdÇme
, 
¼2
->rdata.ns.nsdname))

380  
çl£
;

384 
DNS_TYPE_CNAME
:

385 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
úame
.cname,

386 
¼2
->
rd©a
.
úame
.cname))

387  
çl£
;

391 
DNS_TYPE_SOA
:

392 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
sß
.
mÇme
, 
¼2
->rdata.soa.mname))

393  
çl£
;

395 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
sß
.
ºame
, 
¼2
->rdata.soa.rname))

396  
çl£
;

398 ià(
¼1
->
rd©a
.
sß
.
£rŸl
 !ğ
¼2
->rdata.soa.serial)

399  
çl£
;

401 ià(
¼1
->
rd©a
.
sß
.
»äesh
 !ğ
¼2
->rdata.soa.refresh)

402  
çl£
;

404 ià(
¼1
->
rd©a
.
sß
.
»Œy
 !ğ
¼2
->rdata.soa.retry)

405  
çl£
;

407 ià(
¼1
->
rd©a
.
sß
.
expœe
 !ğ
¼2
->rdata.soa.expire)

408  
çl£
;

410 ià(
¼1
->
rd©a
.
sß
.
‰lmš
 !ğ
¼2
->rdata.soa.ttlmin)

411  
çl£
;

415 
DNS_TYPE_PTR
:

416 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
±r
.
±rdÇme
,

417 
¼2
->
rd©a
.
±r
.
±rdÇme
))

418  
çl£
;

422 
DNS_TYPE_MX
:

423 ià(
¼1
->
rd©a
.
mx
.
´ef
 !ğ
¼2
->rdata.mx.pref)

424  
çl£
;

426 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
mx
.
exchªge
,

427 
¼2
->
rd©a
.
mx
.
exchªge
))

428  
çl£
;

432 
DNS_TYPE_AAAA
:

433 ià(
	`memcmp
(
¼1
->
rd©a
.
¯¯
.
addr
, 
¼2
->rdata.aaaa.addr, 16))

434  
çl£
;

438 
DNS_TYPE_SRV
:

439 ià(
¼1
->
rd©a
.
¤v
.
´i
 !ğ
¼2
->rdata.srv.pri)

440  
çl£
;

442 ià(
¼1
->
rd©a
.
¤v
.
weight
 !ğ
¼2
->rdata.srv.weight)

443  
çl£
;

445 ià(
¼1
->
rd©a
.
¤v
.
pÜt
 !ğ
¼2
->rdata.srv.port)

446  
çl£
;

448 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
¤v
.
rg‘
, 
¼2
->rdata.srv.target))

449  
çl£
;

453 
DNS_TYPE_NAPTR
:

454 ià(
¼1
->
rd©a
.
Ç±r
.
Üd”
 !ğ
¼2
->rdata.naptr.order)

455  
çl£
;

457 ià(
¼1
->
rd©a
.
Ç±r
.
´ef
 !ğ
¼2
->rdata.naptr.pref)

458  
çl£
;

461 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
Ç±r
.
æags
,

462 
¼2
->
rd©a
.
Ç±r
.
æags
))

463  
çl£
;

466 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
Ç±r
.
£rviûs
,

467 
¼2
->
rd©a
.
Ç±r
.
£rviûs
))

468  
çl£
;

471 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
Ç±r
.
»gexp
,

472 
¼2
->
rd©a
.
Ç±r
.
»gexp
))

473  
çl£
;

476 ià(
	`¡r_ÿ£cmp
(
¼1
->
rd©a
.
Ç±r
.
»¶aû
,

477 
¼2
->
rd©a
.
Ç±r
.
»¶aû
))

478  
çl£
;

483  
çl£
;

486  
Œue
;

487 
	}
}

497 cÚ¡ *
	$dns_¼_ty³Çme
(
ušt16_t
 
ty³
)

499 
ty³
) {

501 
DNS_TYPE_A
:  "A";

502 
DNS_TYPE_NS
:  "NS";

503 
DNS_TYPE_CNAME
:  "CNAME";

504 
DNS_TYPE_SOA
:  "SOA";

505 
DNS_TYPE_PTR
:  "PTR";

506 
DNS_TYPE_MX
:  "MX";

507 
DNS_TYPE_AAAA
:  "AAAA";

508 
DNS_TYPE_SRV
:  "SRV";

509 
DNS_TYPE_NAPTR
:  "NAPTR";

510 
DNS_QTYPE_IXFR
:  "IXFR";

511 
DNS_QTYPE_AXFR
:  "AXFR";

512 
DNS_QTYPE_ANY
:  "ANY";

515 
	}
}

525 cÚ¡ *
	$dns_¼_şas¢ame
(
ušt16_t
 
dnsşass
)

527 
dnsşass
) {

529 
DNS_CLASS_IN
:  "IN";

530 
DNS_QCLASS_ANY
:  "ANY";

533 
	}
}

544 
	$dns_¼_´št
(
»_´štf
 *
pf
, cÚ¡ 
dn¤r
 *
¼
)

546 cÚ¡ 
size_t
 
w
 = 24;

547 
§
 sa;

548 
size_t
 
n
, 
l
;

549 
”r
;

551 ià(!
pf
 || !
¼
)

552  
EINVAL
;

554 
l
 = 
	`¡r_Ën
(
¼
->
Çme
);

555 
n
 = (
w
 > 
l
) ? w -† : 0;

557 
”r
 = 
	`»_h´štf
(
pf
, "%s.", 
¼
->
Çme
);

558 
n
--)

559 
”r
 |ğ
pf
->
	`vph
(" ", 1,…f->
¬g
);

561 
”r
 |ğ
	`»_h´štf
(
pf
, " %10lld %-4s %-7s ",

562 
¼
->
‰l
,

563 
	`dns_¼_şas¢ame
(
¼
->
dnsşass
),

564 
	`dns_¼_ty³Çme
(
¼
->
ty³
));

566 
¼
->
ty³
) {

568 
DNS_TYPE_A
:

569 
	`§_£t_š
(&
§
, 
¼
->
rd©a
.
a
.
addr
, 0);

570 
”r
 |ğ
	`»_h´štf
(
pf
, "%j", &
§
);

573 
DNS_TYPE_NS
:

574 
”r
 |ğ
	`»_h´štf
(
pf
, "%s.", 
¼
->
rd©a
.
ns
.
nsdÇme
);

577 
DNS_TYPE_CNAME
:

578 
”r
 |ğ
	`»_h´štf
(
pf
, "%s.", 
¼
->
rd©a
.
úame
.cname);

581 
DNS_TYPE_SOA
:

582 
”r
 |ğ
	`»_h´štf
(
pf
, "%s. %s. %u %u %u %u %u",

583 
¼
->
rd©a
.
sß
.
mÇme
,

584 
¼
->
rd©a
.
sß
.
ºame
,

585 
¼
->
rd©a
.
sß
.
£rŸl
,

586 
¼
->
rd©a
.
sß
.
»äesh
,

587 
¼
->
rd©a
.
sß
.
»Œy
,

588 
¼
->
rd©a
.
sß
.
expœe
,

589 
¼
->
rd©a
.
sß
.
‰lmš
);

592 
DNS_TYPE_PTR
:

593 
”r
 |ğ
	`»_h´štf
(
pf
, "%s.", 
¼
->
rd©a
.
±r
.
±rdÇme
);

596 
DNS_TYPE_MX
:

597 
”r
 |ğ
	`»_h´štf
(
pf
, "%3u %s.", 
¼
->
rd©a
.
mx
.
´ef
,

598 
¼
->
rd©a
.
mx
.
exchªge
);

601 
DNS_TYPE_AAAA
:

602 
	`§_£t_š6
(&
§
, 
¼
->
rd©a
.
¯¯
.
addr
, 0);

603 
”r
 |ğ
	`»_h´štf
(
pf
, "%j", &
§
);

606 
DNS_TYPE_SRV
:

607 
”r
 |ğ
	`»_h´štf
(
pf
, "%3u %3u %u %s.",

608 
¼
->
rd©a
.
¤v
.
´i
,

609 
¼
->
rd©a
.
¤v
.
weight
,

610 
¼
->
rd©a
.
¤v
.
pÜt
,

611 
¼
->
rd©a
.
¤v
.
rg‘
);

614 
DNS_TYPE_NAPTR
:

615 
”r
 |ğ
	`»_h´štf
(
pf
, "%3u %3u \"%s\" \"%s\" \"%s\" %s.",

616 
¼
->
rd©a
.
Ç±r
.
Üd”
,

617 
¼
->
rd©a
.
Ç±r
.
´ef
,

618 
¼
->
rd©a
.
Ç±r
.
æags
,

619 
¼
->
rd©a
.
Ç±r
.
£rviûs
,

620 
¼
->
rd©a
.
Ç±r
.
»gexp
,

621 
¼
->
rd©a
.
Ç±r
.
»¶aû
);

625 
”r
 |ğ
	`»_h´štf
(
pf
, "?");

629  
”r
;

630 
	}
}

	@re-0.5.6/src/dns/rrlist.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_li¡.h
>

9 
	~<»_hash.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_fmt.h
>

12 
	~<»_dns.h
>

16 
	mCNAME_RECURSE_MAX
 = 16,

20 
	ssÜt
 {

21 
ušt16_t
 
	mty³
;

22 
ušt32_t
 
	mkey
;

26 
ušt32_t
 
	$sidx
(cÚ¡ 
dn¤r
 *
¼
, 
ušt32_t
 
key
)

28 
ušt32_t
 
addr
[4];

30 
¼
->
ty³
) {

32 
DNS_TYPE_A
:

33  
¼
->
rd©a
.
a
.
addr
 ^ 
key
;

35 
DNS_TYPE_AAAA
:

36 
	`memıy
(
addr
, 
¼
->
rd©a
.
¯¯
.addr, 16);

38  
addr
[0] ^‡ddr[1] ^‡ddr[2] ^‡ddr[3] ^ 
key
;

40 
DNS_TYPE_SRV
:

41  ((
	`hash_ç¡_¡r
(
¼
->
rd©a
.
¤v
.
rg‘
è& 0xfffè^ 
key
) +

42 
¼
->
rd©a
.
¤v
.
weight
;

47 
	}
}

50 
boŞ
 
	$¡d_sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

52 
dn¤r
 *
¼1
 = 
Ë1
->
d©a
;

53 
dn¤r
 *
¼2
 = 
Ë2
->
d©a
;

54 
sÜt
 *sÜˆğ
¬g
;

56 ià(
sÜt
->
ty³
 !ğ
¼1
->type)

57  
sÜt
->
ty³
 !ğ
¼2
->type;

59 ià(
sÜt
->
ty³
 !ğ
¼2
->type)

60  
Œue
;

62 
sÜt
->
ty³
) {

64 
DNS_TYPE_MX
:

65  
¼1
->
rd©a
.
mx
.
´ef
 <ğ
¼2
->rdata.mx.pref;

67 
DNS_TYPE_SRV
:

68 ià(
¼1
->
rd©a
.
¤v
.
´i
 =ğ
¼2
->rdata.srv.pri)

69  
	`sidx
(
¼1
, 
sÜt
->
key
è>ğsidx(
¼2
, sort->key);

71  
¼1
->
rd©a
.
¤v
.
´i
 < 
¼2
->rdata.srv.pri;

73 
DNS_TYPE_NAPTR
:

74 ià(
¼1
->
rd©a
.
Ç±r
.
Üd”
 =ğ
¼2
->rdata.naptr.order)

75  
¼1
->
rd©a
.
Ç±r
.
´ef
 <ğ
¼2
->rdata.naptr.pref;

77  
¼1
->
rd©a
.
Ç±r
.
Üd”
 < 
¼2
->rdata.naptr.order;

83  
Œue
;

84 
	}
}

87 
boŞ
 
	$addr_sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

89 
dn¤r
 *
¼1
 = 
Ë1
->
d©a
;

90 
dn¤r
 *
¼2
 = 
Ë2
->
d©a
;

91 
sÜt
 *sÜˆğ
¬g
;

93  
	`sidx
(
¼1
, 
sÜt
->
key
è>ğsidx(
¼2
, sort->key);

94 
	}
}

104 
	$dns_¼li¡_sÜt
(
li¡
 *
¼l
, 
ušt16_t
 
ty³
, 
size_t
 
key
)

106 
sÜt
 sÜˆğ{
ty³
, (
ušt32_t
)
key
>>5};

108 
	`li¡_sÜt
(
¼l
, 
¡d_sÜt_hªdËr
, &
sÜt
);

109 
	}
}

118 
	$dns_¼li¡_sÜt_addr
(
li¡
 *
¼l
, 
size_t
 
key
)

120 
sÜt
 sÜˆğ{0, (
ušt32_t
)
key
>>5};

122 
	`li¡_sÜt
(
¼l
, 
addr_sÜt_hªdËr
, &
sÜt
);

123 
	}
}

126 
dn¤r
 *
	$¼li¡_­¶y
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

127 
ušt16_t
 
ty³1
, ušt16_ˆ
ty³2
,

128 
ušt16_t
 
dnsşass
,

129 
boŞ
 
»cur£
, 
ušt32_t
 
d•th
,

130 
dns_¼li¡_h
 *
¼lh
, *
¬g
)

132 
Ë
 *Ë = 
	`li¡_h—d
(
¼l
);

134 ià(
d•th
 > 
CNAME_RECURSE_MAX
)

135  
NULL
;

137 
Ë
) {

139 
dn¤r
 *
¼
 = 
Ë
->
d©a
;

141 
Ë
 =†e->
Ãxt
;

143 ià(
Çme
 && 
	`¡r_ÿ£cmp
Òame, 
¼
->name))

146 ià(
ty³1
 !ğ
DNS_QTYPE_ANY
 && 
ty³2
 != DNS_QTYPE_ANY &&

147 
¼
->
ty³
 !ğ
ty³1
 &&„r->ty³ !ğ
ty³2
 &&

148 (
¼
->
ty³
 !ğ
DNS_TYPE_CNAME
 || !
»cur£
))

151 ià(
dnsşass
 !ğ
DNS_QCLASS_ANY
 && 
¼
->dnsclass != dnsclass)

154 ià(!
¼lh
 || 
	`¼lh
(
¼
, 
¬g
))

155  
¼
;

157 ià(
»cur£
 &&

158 
DNS_QTYPE_ANY
 !ğ
ty³1
 && DNS_QTYPE_ANY !ğ
ty³2
 &&

159 
DNS_TYPE_CNAME
 !ğ
ty³1
 && DNS_TYPE_CNAME !ğ
ty³2
 &&

160 
DNS_TYPE_CNAME
 =ğ
¼
->
ty³
) {

161 
¼
 = 
	`¼li¡_­¶y
(
¼l
,„r->
rd©a
.
úame
.úame, 
ty³1
,

162 
ty³2
, 
dnsşass
, 
»cur£
, ++
d•th
,

163 
¼lh
, 
¬g
);

164 ià(
¼
)

165  
¼
;

169  
NULL
;

170 
	}
}

186 
dn¤r
 *
	$dns_¼li¡_­¶y
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

187 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
,

188 
boŞ
 
»cur£
, 
dns_¼li¡_h
 *
¼lh
, *
¬g
)

190  
	`¼li¡_­¶y
(
¼l
, 
Çme
, 
ty³
,y³, 
dnsşass
,

191 
»cur£
, 0, 
¼lh
, 
¬g
);

192 
	}
}

209 
dn¤r
 *
	$dns_¼li¡_­¶y2
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

210 
ušt16_t
 
ty³1
, ušt16_ˆ
ty³2
,

211 
ušt16_t
 
dnsşass
, 
boŞ
 
»cur£
,

212 
dns_¼li¡_h
 *
¼lh
, *
¬g
)

214  
	`¼li¡_­¶y
(
¼l
, 
Çme
, 
ty³1
, 
ty³2
, 
dnsşass
,

215 
»cur£
, 0, 
¼lh
, 
¬g
);

216 
	}
}

219 
boŞ
 
	$fšd_hªdËr
(
dn¤r
 *
¼
, *
¬g
)

221 
ušt16_t
 
ty³
 = *(ušt16_ˆ*)
¬g
;

223  
¼
->
ty³
 ==ype;

224 
	}
}

238 
dn¤r
 *
	$dns_¼li¡_fšd
(
li¡
 *
¼l
, cÚ¡ *
Çme
,

239 
ušt16_t
 
ty³
, ušt16_ˆ
dnsşass
, 
boŞ
 
»cur£
)

241  
	`¼li¡_­¶y
(
¼l
, 
Çme
, 
ty³
,y³, 
dnsşass
,

242 
»cur£
, 0, 
fšd_hªdËr
, &
ty³
);

243 
	}
}

	@re-0.5.6/src/dns/win32/srv.c

6 
	~<wšsock2.h
>

7 
	~<hÍ­i.h
>

8 
	~<io.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_li¡.h
>

13 
	~<»_§.h
>

14 
	~<»_dns.h
>

15 
	~"../dns.h
"

18 
	#DEBUG_MODULE
 "wš32/¤v"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

23 
	$g‘_wšdns
(*
domaš
, 
size_t
 
dsize
, 
§
 *
¤vv
, 
ušt32_t
 *
n
)

25 
FIXED_INFO
 * 
FixedInfo
 = 
NULL
;

26 
ULONG
 
ulOutBufL’
;

27 
DWORD
 
dwR‘V®
;

28 
IP_ADDR_STRING
 * 
pIPAddr
;

29 
HANDLE
 
hLib
;

31 
FARPROC
 
´oc
;

32 
	`DWORD
 (
WINAPI
 *
_G‘N‘wÜkP¬ams
)(
FIXED_INFO
*, 
DWORD
*);

33 } 
u
;

34 
ušt32_t
 
i
;

35 
”r
;

37 ià(!
¤vv
 || !
n
 || !*n)

38  
EINVAL
;

40 
hLib
 = 
	`LßdLib¿ry
(
	`TEXT
("iphlpapi.dll"));

41 ià(!
hLib
)

42  
ENOSYS
;

44 
u
.
´oc
 = 
	`G‘ProcAdd»ss
(
hLib
, 
	`TEXT
("GetNetworkParams"));

45 ià(!
u
.
´oc
) {

46 
”r
 = 
ENOSYS
;

47 
out
;

50 
FixedInfo
 = (
FIXED_INFO
 *)
	`Glob®AÎoc
(
GPTR
, ( FIXED_INFO ));

51 
ulOutBufL’
 = Ğ
FIXED_INFO
 );

53 ià(
ERROR_BUFFER_OVERFLOW
 =ğ(*
u
.
_G‘N‘wÜkP¬ams
)(
FixedInfo
,

54 &
ulOutBufL’
)) {

55 
	`Glob®F»e
Ğ
FixedInfo
 );

56 
FixedInfo
 = (
FIXED_INFO
 *)
	`Glob®AÎoc
(
GPTR
, 
ulOutBufL’
);

59 ià((
dwR‘V®
 = (*
u
.
_G‘N‘wÜkP¬ams
)Ğ
FixedInfo
, &
ulOutBufL’
 ))) {

60 
	`DEBUG_WARNING
("couldn'ˆg‘‚‘wÜk…¬am (%d)\n", 
dwR‘V®
);

61 
”r
 = 
ENOENT
;

62 
out
;

65 
	`¡r_nıy
(
domaš
, 
FixedInfo
->
DomašName
, 
dsize
);

68 
	`´štf
Ğ"Ho¡ Name: %s\n", 
FixedInfo
->
Ho¡Name
);

69 
	`´štf
Ğ"Domaš Name: %s\n", 
FixedInfo
->
DomašName
);

70 
	`´štf
( "DNS Servers:\n" );

71 
	`´štf
Ğ"\t%s\n", 
FixedInfo
->
DnsS”v”Li¡
.
IpAdd»ss
.
SŒšg
 );

74 
i
 = 0;

75 
pIPAddr
 = &
FixedInfo
->
DnsS”v”Li¡
;

76 
pIPAddr
 && 
	`¡¾’
ÕIPAddr->
IpAdd»ss
.
SŒšg
) > 0) {

77 
”r
 = 
	`§_£t_¡r
(&
¤vv
[
i
], 
pIPAddr
->
IpAdd»ss
.
SŒšg
,

78 
DNS_PORT
);

79 ià(
”r
) {

80 
	`DEBUG_WARNING
("sa_set_str: %s (%m)\n",

81 
pIPAddr
->
IpAdd»ss
.
SŒšg
, 
”r
);

83 
	`DEBUG_INFO
("dn  %u: %j\n", 
i
, &
¤vv
[i]);

84 ++
i
;

85 
pIPAddr
 =…IPAdd¸->
Next
;

87 ià(
i
 >ğ*
n
)

91 *
n
 = 
i
;

92 
	`DEBUG_INFO
("gÙ %u‚ame£rv”s\n", 
i
);

93 
”r
 = 
i
>0 ? 0 : 
ENOENT
;

95 
out
:

96 ià(
FixedInfo
)

97 
	`Glob®F»e
(
FixedInfo
);

98 
	`F»eLib¿ry
(
hLib
);

99  
”r
;

100 
	}
}

	@re-0.5.6/src/fmt/ch.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

17 
ušt8_t
 
	$ch_hex
(
ch
)

19 ià('0' <ğ
ch
 && ch <= '9')

20  
ch
 - '0';

22 ià('A' <ğ
ch
 && ch <= 'F')

23  
ch
 - 'A' + 10;

25 ià('a' <ğ
ch
 && ch <= 'f')

26  
ch
 - 'a' + 10;

29 
	}
}

	@re-0.5.6/src/fmt/hexdump.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

18 
	$hexdump
(
FILE
 *
f
, cÚ¡ *
p
, 
size_t
 
Ën
)

20 cÚ¡ 
ušt8_t
 *
buf
 = 
p
;

21 
ušt32_t
 
j
;

22 
size_t
 
i
;

24 ià(!
f
 || !
buf
)

27 
i
=0; i < 
Ën
; i += 16) {

29 ()
	`»_årštf
(
f
, "%08x ", 
i
);

31 
j
=0; j<16; j++) {

32 cÚ¡ 
size_t
 
pos
 = 
i
+
j
;

33 ià(
pos
 < 
Ën
)

34 ()
	`»_årštf
(
f
, " %02x", 
buf
[
pos
]);

36 ()
	`»_årštf
(
f
, " ");

38 ià(
j
 == 7)

39 ()
	`»_årštf
(
f
, " ");

42 ()
	`»_årštf
(
f
, " |");

44 
j
=0; j<16; j++) {

45 cÚ¡ 
size_t
 
pos
 = 
i
+
j
;

46 
ušt8_t
 
v
;

47 ià(
pos
 >ğ
Ën
)

49 
v
 = 
buf
[
pos
];

50 ()
	`»_årštf
(
f
, "%c", 
	`i¥ršt
(
v
) ? v : '.');

51 ià(
j
 == 7)

52 ()
	`»_årštf
(
f
, " ");

55 ()
	`»_årštf
(
f
, "|\n");

57 
	}
}

	@re-0.5.6/src/fmt/pl.c

6 
	~<ùy³.h
>

7 
	~<sys/ty³s.h
>

8 #ifdeà
HAVE_STRINGS_H


9 
	#__EXTENSIONS__
 1

	)

10 
	~<¡ršgs.h
>

12 
	~<¡ršg.h
>

13 
	~<¡dlib.h
>

14 
	~<»_ty³s.h
>

15 
	~<»_mem.h
>

16 
	~<»_mbuf.h
>

17 
	~<»_fmt.h
>

21 cÚ¡ 
¶
 
	g¶_nuÎ
 = {
NULL
, 0};

30 
	$¶_£t_¡r
(
¶
 *¶, cÚ¡ *
¡r
)

32 ià(!
¶
 || !
¡r
)

35 
¶
->
p
 = 
¡r
;

36 
¶
->
l
 = 
	`¡¾’
(
¡r
);

37 
	}
}

47 
	$¶_£t_mbuf
(
¶
 *¶, cÚ¡ 
mbuf
 *
mb
)

49 ià(!
¶
 || !
mb
)

52 
¶
->
p
 = (*)
	`mbuf_buf
(
mb
);

53 
¶
->
l
 = 
	`mbuf_g‘_Ëá
(
mb
);

54 
	}
}

64 
ušt32_t
 
	$¶_u32
(cÚ¡ 
¶
 *pl)

66 
ušt32_t
 
v
=0, 
mul
=1;

67 cÚ¡ *
p
;

69 ià(!
¶
 || !¶->
p
)

72 
p
 = &
¶
->p[¶->
l
];

73 
p
 > 
¶
->p) {

74 cÚ¡ 
ušt8_t
 
c
 = *--
p
 - '0';

75 ià(
c
 > 9)

77 
v
 +ğ
mul
 * 
c
;

78 
mul
 *= 10;

81  
v
;

82 
	}
}

92 
ušt32_t
 
	$¶_x32
(cÚ¡ 
¶
 *pl)

94 
ušt32_t
 
v
=0, 
mul
=1;

95 cÚ¡ *
p
;

97 ià(!
¶
 || !¶->
p
)

100 
p
 = &
¶
->p[¶->
l
];

101 
p
 > 
¶
->p) {

103 cÚ¡ 
ch
 = *--
p
;

104 
ušt8_t
 
c
;

106 ià('0' <ğ
ch
 && ch <= '9')

107 
c
 = 
ch
 - '0';

108 ià('A' <ğ
ch
 && ch <= 'F')

109 
c
 = 
ch
 - 'A' + 10;

110 ià('a' <ğ
ch
 && ch <= 'f')

111 
c
 = 
ch
 - 'a' + 10;

115 
v
 +ğ
mul
 * 
c
;

116 
mul
 *= 16;

119  
v
;

120 
	}
}

130 
ušt64_t
 
	$¶_u64
(cÚ¡ 
¶
 *pl)

132 
ušt64_t
 
v
=0, 
mul
=1;

133 cÚ¡ *
p
;

135 ià(!
¶
 || !¶->
p
)

138 
p
 = &
¶
->p[¶->
l
];

139 
p
 > 
¶
->p) {

140 cÚ¡ 
ušt8_t
 
c
 = *--
p
 - '0';

141 ià(
c
 > 9)

143 
v
 +ğ
mul
 * 
c
;

144 
mul
 *= 10;

147  
v
;

148 
	}
}

158 
ušt64_t
 
	$¶_x64
(cÚ¡ 
¶
 *pl)

160 
ušt64_t
 
v
=0, 
mul
=1;

161 cÚ¡ *
p
;

163 ià(!
¶
 || !¶->
p
)

166 
p
 = &
¶
->p[¶->
l
];

167 
p
 > 
¶
->p) {

169 cÚ¡ 
ch
 = *--
p
;

170 
ušt8_t
 
c
;

172 ià('0' <ğ
ch
 && ch <= '9')

173 
c
 = 
ch
 - '0';

174 ià('A' <ğ
ch
 && ch <= 'F')

175 
c
 = 
ch
 - 'A' + 10;

176 ià('a' <ğ
ch
 && ch <= 'f')

177 
c
 = 
ch
 - 'a' + 10;

181 
v
 +ğ
mul
 * 
c
;

182 
mul
 *= 16;

185  
v
;

186 
	}
}

198 
	$¶_æßt
(cÚ¡ 
¶
 *pl)

200 
v
=0, 
mul
=1;

201 cÚ¡ *
p
;

202 
boŞ
 
Ãg
 = 
çl£
;

204 ià(!
¶
 || !¶->
p
)

207 
p
 = &
¶
->p[¶->
l
];

209 
p
 > 
¶
->p) {

211 cÚ¡ 
ch
 = *--
p
;

213 ià('0' <ğ
ch
 && ch <= '9') {

214 
v
 +ğ
mul
 * (
ch
 - '0');

215 
mul
 *= 10;

217 ià(
ch
 == '.') {

218 
v
 /ğ
mul
;

219 
mul
 = 1;

221 ià(
ch
 =ğ'-' && 
p
 =ğ
¶
->p) {

222 
Ãg
 = 
Œue
;

229  
Ãg
 ? -
v
 : v;

230 
	}
}

240 
boŞ
 
	$¶_is£t
(cÚ¡ 
¶
 *pl)

242  
¶
 ?…l->
p
 &&…l->
l
 : 
çl£
;

243 
	}
}

255 
	$¶_¡rıy
(cÚ¡ 
¶
 *¶, *
¡r
, 
size_t
 
size
)

257 
size_t
 
Ën
;

259 ià(!
¶
 || !¶->
p
 || !
¡r
 || !
size
)

260  
EINVAL
;

262 
Ën
 = 
	`mš
(
¶
->
l
, 
size
-1);

264 
	`memıy
(
¡r
, 
¶
->
p
, 
Ën
);

265 
¡r
[
Ën
] = '\0';

268 
	}
}

279 
	$¶_¡rdup
(**
d¡
, cÚ¡ 
¶
 *
¤c
)

281 *
p
;

283 ià(!
d¡
 || !
¤c
 || !¤c->
p
)

284  
EINVAL
;

286 
p
 = 
	`mem_®loc
(
¤c
->
l
+1, 
NULL
);

287 ià(!
p
)

288  
ENOMEM
;

290 
	`memıy
(
p
, 
¤c
->p, src->
l
);

291 
p
[
¤c
->
l
] = '\0';

293 *
d¡
 = 
p
;

296 
	}
}

307 
	$¶_dup
(
¶
 *
d¡
, cÚ¡ ¶ *
¤c
)

309 *
p
;

311 ià(!
d¡
 || !
¤c
 || !¤c->
p
)

312  
EINVAL
;

314 
p
 = 
	`mem_®loc
(
¤c
->
l
, 
NULL
);

315 ià(!
p
)

316  
ENOMEM
;

318 
	`memıy
(
p
, 
¤c
->p, src->
l
);

320 
d¡
->
p
 =…;

321 
d¡
->
l
 = 
¤c
->l;

324 
	}
}

336 
	$¶_¡rcmp
(cÚ¡ 
¶
 *¶, cÚ¡ *
¡r
)

338 
¶
 
s
;

340 ià(!
¶
 || !
¡r
)

341  
EINVAL
;

343 
	`¶_£t_¡r
(&
s
, 
¡r
);

345  
	`¶_cmp
(
¶
, &
s
);

346 
	}
}

358 
	$¶_¡rÿ£cmp
(cÚ¡ 
¶
 *¶, cÚ¡ *
¡r
)

360 
¶
 
s
;

362 ià(!
¶
 || !
¡r
)

363  
EINVAL
;

365 
	`¶_£t_¡r
(&
s
, 
¡r
);

367  
	`¶_ÿ£cmp
(
¶
, &
s
);

368 
	}
}

379 
	$¶_cmp
(cÚ¡ 
¶
 *
¶1
, cÚ¡ ¶ *
¶2
)

381 ià(!
¶1
 || !
¶2
)

382  
EINVAL
;

385 ià(
¶1
->
l
 !ğ
¶2
->l)

386  
EINVAL
;

389 ià(
¶1
->
l
 == 0)

397 ià(
¶1
 =ğ
¶2
)

401 ià(
¶1
->
p
 =ğ
¶2
->p)

404  0 =ğ
	`memcmp
(
¶1
->
p
, 
¶2
->p,…l1->
l
è? 0 : 
EINVAL
;

405 
	}
}

408 #iâdeà
HAVE_STRINGS_H


409 
	$ÿ£cmp
(cÚ¡ 
¶
 *¶, cÚ¡ *
¡r
)

411 
size_t
 
i
 = 0;

413 
	#LOWER
(
d
è((dè| 0x20202020)

	)

414 cÚ¡ 
ušt32_t
 *
p1
 = (ušt32_ˆ*)
¶
->
p
;

415 cÚ¡ 
ušt32_t
 *
p2
 = (ušt32_ˆ*)
¡r
;

416 cÚ¡ 
size_t
 
Ën
 = 
¶
->
l
 & ~0x3;

419 ià(((
size_t
)
¶
->
p
) & ((*) - 1))

420 
Ãxt
;

421 ià(((
size_t
)
¡r
) & ((*) - 1))

422 
Ãxt
;

425 ; 
i
<
Ën
; i+=4) {

426 ià(
	`LOWER
(*
p1
++è!ğLOWER(*
p2
++))

427  
EINVAL
;

430 
Ãxt
:

432 ; 
i
<
¶
->
l
; i++) {

433 ià(
	`tŞow”
(
¶
->
p
[
i
]è!ğtŞow”(
¡r
[i]))

434  
EINVAL
;

438 
	}
}

450 
	$¶_ÿ£cmp
(cÚ¡ 
¶
 *
¶1
, cÚ¡ ¶ *
¶2
)

452 ià(!
¶1
 || !
¶2
)

453  
EINVAL
;

456 ià(
¶1
->
l
 !ğ
¶2
->l)

457  
EINVAL
;

460 ià(
¶1
->
l
 == 0)

468 ià(
¶1
 =ğ
¶2
)

472 ià(
¶1
->
p
 =ğ
¶2
->p)

475 #ifdeà
HAVE_STRINGS_H


476  0 =ğ
	`¡ºÿ£cmp
(
¶1
->
p
, 
¶2
->p,…l1->
l
è? 0 : 
EINVAL
;

478  
	`ÿ£cmp
(
¶1
, 
¶2
->
p
);

480 
	}
}

491 cÚ¡ *
	$¶_¡rchr
(cÚ¡ 
¶
 *¶, 
c
)

493 cÚ¡ *
p
, *
’d
;

495 ià(!
¶
)

496  
NULL
;

498 
’d
 = 
¶
->
p
 +…l->
l
;

499 
p
 = 
¶
->p;… < 
’d
;…++) {

500 ià(*
p
 =ğ
c
)

501  
p
;

504  
NULL
;

505 
	}
}

	@re-0.5.6/src/fmt/print.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_§.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mem.h
>

11 
	~<m©h.h
>

12 #ifdeà
_MSC_VER


13 
	~<æßt.h
>

14 #iâdeà
isšf


15 
	#isšf
(
d
è(!
	`_fš™e
(d))

	)

17 #iâdeà
i¢ª


18 
	#i¢ª
(
d
è
	`_i¢ª
(d)

	)

21 #ifdeà
SOLARIS


22 
	~<›“å.h
>

23 #undeà
isšf


24 
	#isšf
(
a
è(
	`åşass
(×)è=ğ
FP_NINF
 || fpşass(×)è=ğ
FP_PINF
)

	)

25 #undeà
i¢ª


26 
	#i¢ª
(
a
è
	`i¢ªd
(×))

	)

30 
	eËngth_modif›r
 {

31 
	mLENMOD_NONE
 = 0,

32 
	mLENMOD_LONG
 = 1,

33 
	mLENMOD_LONG_LONG
 = 2,

34 
	mLENMOD_SIZE
 = 42,

38 
	mDEC_SIZE
 = 42,

39 
	mNUM_SIZE
 = 64

42 cÚ¡ 
	g´fx_Ãg
[] = "-";

43 cÚ¡ 
	g´fx_hex
[] = "0x";

44 cÚ¡ 
	g¡r_n
[] = "(nil)";

47 
	$wr™e_·dded
(cÚ¡ *
p
, 
size_t
 
sz
, size_ˆ
·d
, 
pch
,

48 
boŞ
 
¶r
, cÚ¡ *
´fx
, 
»_v´štf_h
 *
vph
,

49 *
¬g
)

51 cÚ¡ 
size_t
 
´fx_Ën
 = 
	`¡r_Ën
(
´fx
);

52 
”r
 = 0;

54 
·d
 -ğ
	`MIN
Õad, 
´fx_Ën
);

56 ià(
´fx
 && 
pch
 == '0')

57 
”r
 |ğ
	`vph
(
´fx
, 
´fx_Ën
, 
¬g
);

59 !
¶r
 && (
·d
-- > 
sz
))

60 
”r
 |ğ
	`vph
(&
pch
, 1, 
¬g
);

62 ià(
´fx
 && 
pch
 != '0')

63 
”r
 |ğ
	`vph
(
´fx
, 
´fx_Ën
, 
¬g
);

65 ià(
p
 && 
sz
)

66 
”r
 |ğ
	`vph
(
p
, 
sz
, 
¬g
);

68 
¶r
 && 
·d
-- > 
sz
)

69 
”r
 |ğ
	`vph
(&
pch
, 1, 
¬g
);

71  
”r
;

72 
	}
}

75 
ušt32_t
 
	$loÿl_™ß
(*
buf
, 
ušt64_t
 
n
, 
ušt8_t
 
ba£
, 
boŞ
 
uc
)

77 
c
, *
p
 = 
buf
 + 
NUM_SIZE
;

78 
ušt32_t
 
Ën
 = 1;

79 cÚ¡ 
a
 = 
uc
 ? 'A' : 'a';

81 *--
p
 = '\0';

83 cÚ¡ 
ušt64_t
 
dv
 = 
n
 / 
ba£
;

84 cÚ¡ 
ušt64_t
 
mul
 = 
dv
 * 
ba£
;

86 
c
 = ()(
n
 - 
mul
);

88 ià(
c
 < 10)

89 *--
p
 = '0' + 
c
;

91 *--
p
 = 
a
 + (
c
 - 10);

93 
n
 = 
dv
;

94 ++
Ën
;

96 } 
n
 != 0);

98 
	`memmove
(
buf
, 
p
, 
Ën
);

100  
Ën
 - 1;

101 
	}
}

104 
size_t
 
	$loÿl_áß
(*
buf
, 
n
, 
size_t
 
dp
)

106 *
p
 = 
buf
;

107 
a
 = ()
n
;

108 
b
 = 
n
 - ()
a
;

110 
b
 = (b < 0) ? -b : b;

113 
p
 +ğ
	`loÿl_™ß
Õ, (
a
 < 0è? -¨:‡, 10, 
çl£
);

115 *
p
++ = '.';

118 
dp
--) {

119 
v
;

121 
b
 *= 10;

122 
v
 = ()
b
;

123 
b
 -ğ
v
;

125 *
p
++ = '0' + ()
v
;

128 *
p
 = '\0';

130  
p
 - 
buf
;

131 
	}
}

163 
	$»_vh´štf
(cÚ¡ *
fmt
, 
va_li¡
 
­
, 
»_v´štf_h
 *
vph
, *
¬g
)

165 
ušt8_t
 
ba£
, *
b±r
;

166 
pch
, 
ch
, 
num
[
NUM_SIZE
], 
addr
[64], 
msg
[256];

167 
Ëngth_modif›r
 
Ënmod
 = 
LENMOD_NONE
;

168 
»_´štf
 
pf
;

169 
boŞ
 
fm
 = 
çl£
, 
¶r
 = false;

170 cÚ¡ 
¶
 *pl;

171 
size_t
 
·d
 = 0, 
åad
 = -1, 
Ën
, 
i
;

172 cÚ¡ *
¡r
, *
p
 = 
fmt
, *
p0
 = fmt;

173 cÚ¡ 
§
 *sa;

174 
»_´štf_h
 *
ph
;

175 *
ph_¬g
;

176 
va_li¡
 *
­l
;

177 
”r
 = 0;

178 *
±r
;

179 
ušt64_t
 
n
;

180 
št64_t
 
¢
;

181 
boŞ
 
uc
 = 
çl£
;

182 
dbl
;

184 ià(!
fmt
 || !
vph
)

185  
EINVAL
;

187 
pf
.
vph
 = vph;

188 
pf
.
¬g
 =‡rg;

190 ;*
p
 && !
”r
;…++) {

192 ià(!
fm
) {

193 ià(*
p
 != '%')

196 
pch
 = ' ';

197 
¶r
 = 
çl£
;

198 
·d
 = 0;

199 
åad
 = -1;

200 
Ënmod
 = 
LENMOD_NONE
;

201 
uc
 = 
çl£
;

203 ià(
p
 > 
p0
)

204 
”r
 |ğ
	`vph
(
p0
, 
p
 -…0, 
¬g
);

206 
fm
 = 
Œue
;

210 
fm
 = 
çl£
;

211 
ba£
 = 10;

213 *
p
) {

216 
¶r
 = 
Œue
;

217 
fm
 = 
Œue
;

221 
åad
 = 
·d
;

222 
·d
 = 0;

223 
fm
 = 
Œue
;

227 
ch
 = '%';

229 
”r
 |ğ
	`vph
(&
ch
, 1, 
¬g
);

233 
¡r
 = 
	`va_¬g
(
­
, const *);

234 
Ën
 = 
	`va_¬g
(
­
, 
size_t
);

236 
”r
 |ğ
	`wr™e_·dded
(
¡r
, sŒ ? 
Ën
 : 0, 
·d
, ' ',

237 
¶r
, 
NULL
, 
vph
, 
¬g
);

241 
ch
 = 
	`va_¬g
(
­
, );

243 
”r
 |ğ
	`wr™e_·dded
(&
ch
, 1, 
·d
, ' ', 
¶r
, 
NULL
,

244 
vph
, 
¬g
);

249 
Ënmod
) {

251 
LENMOD_SIZE
:

252 
¢
 = 
	`va_¬g
(
­
, 
ssize_t
);

256 
LENMOD_LONG_LONG
:

257 
¢
 = 
	`va_¬g
(
­
, signed );

260 
LENMOD_LONG
:

261 
¢
 = 
	`va_¬g
(
­
, signed );

264 
LENMOD_NONE
:

265 
¢
 = 
	`va_¬g
(
­
, signed);

269 
Ën
 = 
	`loÿl_™ß
(
num
, (
¢
 < 0è? -¢ : sn, 
ba£
,

270 
çl£
);

272 
”r
 |ğ
	`wr™e_·dded
(
num
, 
Ën
, 
·d
,

273 
¶r
 ? ' ' : 
pch
,…lr,

274 (
¢
 < 0è? 
´fx_Ãg
 : 
NULL
,

275 
vph
, 
¬g
);

280 
dbl
 = 
	`va_¬g
(
­
, );

282 ià(
åad
 =ğ(
size_t
)-1) {

283 
åad
 = 
·d
;

284 
·d
 = 0;

287 ià(
	`isšf
(
dbl
)) {

288 
”r
 |ğ
	`wr™e_·dded
("šf", 3, 
åad
,

289 ' ', 
¶r
, 
NULL
, 
vph
, 
¬g
);

291 ià(
	`i¢ª
(
dbl
)) {

292 
”r
 |ğ
	`wr™e_·dded
("Çn", 3, 
åad
,

293 ' ', 
¶r
, 
NULL
, 
vph
, 
¬g
);

296 
Ën
 = 
	`loÿl_áß
(
num
, 
dbl
,

297 
·d
 ? 
	`mš
Õad, 
DEC_SIZE
) : 6);

299 
”r
 |ğ
	`wr™e_·dded
(
num
, 
Ën
, 
åad
,

300 
¶r
 ? ' ' : 
pch
,…lr,

301 (
dbl
<0è? 
´fx_Ãg
 : 
NULL
,

302 
vph
, 
¬g
);

307 
ph
 = 
	`va_¬g
(
­
, 
»_´štf_h
 *);

308 
ph_¬g
 = 
	`va_¬g
(
­
, *);

310 ià(
ph
)

311 
”r
 |ğ
	`ph
(&
pf
, 
ph_¬g
);

315 ++
Ënmod
;

316 
fm
 = 
Œue
;

320 
¡r
 = 
	`¡r_”rÜ
(
	`va_¬g
(
­
, ), 
msg
, (msg));

321 
”r
 |ğ
	`wr™e_·dded
(
¡r
, 
	`¡r_Ën
(¡r), 
·d
,

322 ' ', 
¶r
, 
NULL
, 
vph
, 
¬g
);

326 
±r
 = 
	`va_¬g
(
­
, *);

328 ià(
±r
) {

329 
Ën
 = 
	`loÿl_™ß
(
num
, ()
±r
,

330 16, 
çl£
);

331 
”r
 |ğ
	`wr™e_·dded
(
num
, 
Ën
, 
·d
,

332 
¶r
 ? ' ' : 
pch
,…lr,

333 
´fx_hex
, 
vph
, 
¬g
);

336 
”r
 |ğ
	`wr™e_·dded
(
¡r_n
,

337 (
¡r_n
) - 1,

338 
·d
, ' ', 
¶r
, 
NULL
,

339 
vph
, 
¬g
);

344 
¶
 = 
	`va_¬g
(
­
, const pl *);

346 
”r
 |ğ
	`wr™e_·dded
(
¶
 ?…l->
p
 : 
NULL
,

347 (
¶
 &&…l->
p
è?…l->
l
 : 0,

348 
·d
, ' ', 
¶r
, 
NULL
, 
vph
, 
¬g
);

352 
¡r
 = 
	`va_¬g
(
­
, const *);

353 
”r
 |ğ
	`wr™e_·dded
(
¡r
, 
	`¡r_Ën
(¡r), 
·d
,

354 ' ', 
¶r
, 
NULL
, 
vph
, 
¬g
);

358 
uc
 = 
Œue
;

361 
ba£
 = 16;

364 
Ënmod
) {

366 
LENMOD_SIZE
:

367 
n
 = 
	`va_¬g
(
­
, 
size_t
);

371 
LENMOD_LONG_LONG
:

372 
n
 = 
	`va_¬g
(
­
, );

375 
LENMOD_LONG
:

376 
n
 = 
	`va_¬g
(
­
, );

379 
LENMOD_NONE
:

380 
n
 = 
	`va_¬g
(
­
, );

384 
Ën
 = 
	`loÿl_™ß
(
num
, 
n
, 
ba£
, 
uc
);

386 
”r
 |ğ
	`wr™e_·dded
(
num
, 
Ën
, 
·d
,

387 
¶r
 ? ' ' : 
pch
,…Ì, 
NULL
,

388 
vph
, 
¬g
);

392 
¡r
 = 
	`va_¬g
(
­
, *);

393 
­l
 = 
	`va_¬g
(
­
, 
va_li¡
 *);

395 ià(!
¡r
 || !
­l
)

398 
”r
 |ğ
	`»_vh´štf
(
¡r
, *
­l
, 
vph
, 
¬g
);

402 
uc
 = 
Œue
;

405 
b±r
 = 
	`va_¬g
(
­
, 
ušt8_t
 *);

406 
Ën
 = 
	`va_¬g
(
­
, 
size_t
);

408 
Ën
 = 
b±r
 ?†en : 0;

409 
pch
 = 
¶r
 ? ' ' :…ch;

411 !
¶r
 && 
·d
-- > (
Ën
 * 2))

412 
”r
 |ğ
	`vph
(&
pch
, 1, 
¬g
);

414 
i
=0; i<
Ën
; i++) {

415 cÚ¡ 
ušt8_t
 
v
 = *
b±r
++;

416 
ušt32_t
 
l
 = 
	`loÿl_™ß
(
num
, 
v
, 16, 
uc
);

417 
”r
 |ğ
	`wr™e_·dded
(
num
, 
l
, 2, '0',

418 
çl£
, 
NULL
, 
vph
, 
¬g
);

421 
¶r
 && 
·d
-- > (
Ën
 * 2))

422 
”r
 |ğ
	`vph
(&
pch
, 1, 
¬g
);

427 
Ënmod
 = 
LENMOD_SIZE
;

428 
fm
 = 
Œue
;

432 
§
 = 
	`va_¬g
(
­
, sa *);

433 ià(!
§
)

435 ià(
	`§_Áİ
(
§
, 
addr
, (addr))) {

436 
”r
 |ğ
	`wr™e_·dded
("?", 1, 
·d
, ' ',

437 
¶r
, 
NULL
, 
vph
, 
¬g
);

440 
”r
 |ğ
	`wr™e_·dded
(
addr
, 
	`¡¾’
×ddr), 
·d
, ' ',

441 
¶r
, 
NULL
, 
vph
, 
¬g
);

446 
§
 = 
	`va_¬g
(
­
, sa *);

447 ià(!
§
)

449 ià(
	`§_Áİ
(
§
, 
addr
, (addr))) {

450 
”r
 |ğ
	`wr™e_·dded
("?", 1, 
·d
, ' ',

451 
¶r
, 
NULL
, 
vph
, 
¬g
);

455 #ifdeà
HAVE_INET6


456 ià(
AF_INET6
 =ğ
	`§_af
(
§
)) {

457 
ch
 = '[';

458 
”r
 |ğ
	`vph
(&
ch
, 1, 
¬g
);

461 
”r
 |ğ
	`wr™e_·dded
(
addr
, 
	`¡¾’
×ddr), 
·d
, ' ',

462 
¶r
, 
NULL
, 
vph
, 
¬g
);

463 #ifdeà
HAVE_INET6


464 ià(
AF_INET6
 =ğ
	`§_af
(
§
)) {

465 
ch
 = ']';

466 
”r
 |ğ
	`vph
(&
ch
, 1, 
¬g
);

470 
ch
 = ':';

471 
”r
 |ğ
	`vph
(&
ch
, 1, 
¬g
);

472 
Ën
 = 
	`loÿl_™ß
(
num
, 
	`§_pÜt
(
§
), 10, 
çl£
);

473 
”r
 |ğ
	`wr™e_·dded
(
num
, 
Ën
, 
·d
,

474 
¶r
 ? ' ' : 
pch
,…Ì, 
NULL
,

475 
vph
, 
¬g
);

480 ià(('0' <ğ*
p
) && (*p <= '9')) {

481 ià(!
·d
 && ('0' =ğ*
p
)) {

482 
pch
 = '0';

485 
·d
 *= 10;

486 
·d
 +ğ*
p
 - '0';

488 
fm
 = 
Œue
;

492 
ch
 = '?';

494 
”r
 |ğ
	`vph
(&
ch
, 1, 
¬g
);

498 ià(!
fm
)

499 
p0
 = 
p
 + 1;

502 ià(!
fm
 && 
p
 > 
p0
)

503 
”r
 |ğ
	`vph
(
p0
, 
p
 -…0, 
¬g
);

505  
”r
;

506 
	}
}

509 
	$´št_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

511 
¶
 *¶ = 
¬g
;

513 ià(
size
 > 
¶
->
l
)

514  
ENOMEM
;

516 
	`memıy
((*)
¶
->
p
,…, 
size
);

518 
	`¶_advªû
(
¶
, 
size
);

521 
	}
}

524 
	sdyn_´št
 {

525 *
	m¡r
;

526 *
	mp
;

527 
size_t
 
	ml
;

528 
size_t
 
	msize
;

532 
	$´št_hªdËr_dyn
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

534 
dyn_´št
 *
dp
 = 
¬g
;

536 ià(
size
 > 
dp
->
l
 - 1) {

537 cÚ¡ 
size_t
 
Ãw_size
 = 
	`MAX
(
dp
->
size
 + size, dp->size * 2);

538 *
¡r
 = 
	`mem_»®loc
(
dp
->¡r, 
Ãw_size
);

539 ià(!
¡r
)

540  
ENOMEM
;

542 
dp
->
¡r
 = str;

543 
dp
->
l
 +ğ
Ãw_size
 - dp->
size
;

544 
dp
->
p
 = dp->
¡r
 + 
Ãw_size
 - dp->
l
;

545 
dp
->
size
 = 
Ãw_size
;

548 
	`memıy
(
dp
->
p
,…, 
size
);

550 
dp
->
p
 +ğ
size
;

551 
dp
->
l
 -ğ
size
;

554 
	}
}

557 
	s¡rm_´št
 {

558 
FILE
 *
	mf
;

559 
size_t
 
	mn
;

562 
	$´št_hªdËr_¡»am
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

564 
¡rm_´št
 *
¥
 = 
¬g
;

566 ià(1 !ğ
	`fwr™e
(
p
, 
size
, 1, 
¥
->
f
))

567  
ENOMEM
;

569 
¥
->
n
 +ğ
size
;

572 
	}
}

584 
	$»_vårštf
(
FILE
 *
¡»am
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

586 
¡rm_´št
 
¥
;

588 ià(!
¡»am
)

591 
¥
.
f
 = 
¡»am
;

592 
¥
.
n
 = 0;

594 ià(0 !ğ
	`»_vh´štf
(
fmt
, 
­
, 
´št_hªdËr_¡»am
, &
¥
))

597  ()
¥
.
n
;

598 
	}
}

609 
	$»_v´štf
(cÚ¡ *
fmt
, 
va_li¡
 
­
)

611  
	`»_vårštf
(
¡dout
, 
fmt
, 
­
);

612 
	}
}

625 
	$»_v¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

627 
¶
…l;

628 
”r
;

630 ià(!
¡r
 || !
size
)

633 
¶
.
p
 = 
¡r
;

634 
¶
.
l
 = 
size
 - 1;

636 
”r
 = 
	`»_vh´štf
(
fmt
, 
­
, 
´št_hªdËr
, &
¶
);

638 
¡r
[
size
 - 
¶
.
l
 - 1] = '\0';

640  
”r
 ? -1 : ()(
size
 - 
¶
.
l
 - 1);

641 
	}
}

653 
	$»_vsd´štf
(**
¡½
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

655 
dyn_´št
 
dp
;

656 
”r
;

658 ià(!
¡½
)

659  
EINVAL
;

661 
dp
.
size
 = 16;

662 
dp
.
¡r
 = 
	`mem_®loc
(dp.
size
, 
NULL
);

663 ià(!
dp
.
¡r
)

664  
ENOMEM
;

666 
dp
.
p
 = dp.
¡r
;

667 
dp
.
l
 = dp.
size
;

669 
”r
 = 
	`»_vh´štf
(
fmt
, 
­
, 
´št_hªdËr_dyn
, &
dp
);

670 ià(
”r
)

671 
out
;

673 *
dp
.
p
 = '\0';

675 
out
:

676 ià(
”r
)

677 
	`mem_d”ef
(
dp
.
¡r
);

679 *
¡½
 = 
dp
.
¡r
;

681  
”r
;

682 
	}
}

693 
	$»_h´štf
(
»_´štf
 *
pf
, cÚ¡ *
fmt
, ...)

695 
va_li¡
 
­
;

696 
”r
;

698 ià(!
pf
)

699  
EINVAL
;

701 
	`va_¡¬t
(
­
, 
fmt
);

702 
”r
 = 
	`»_vh´štf
(
fmt
, 
­
, 
pf
->
vph
,…f->
¬g
);

703 
	`va_’d
(
­
);

705  
”r
;

706 
	}
}

717 
	$»_årštf
(
FILE
 *
¡»am
, cÚ¡ *
fmt
, ...)

719 
va_li¡
 
­
;

720 
n
;

722 
	`va_¡¬t
(
­
, 
fmt
);

723 
n
 = 
	`»_vårštf
(
¡»am
, 
fmt
, 
­
);

724 
	`va_’d
(
­
);

726  
n
;

727 
	}
}

737 
	$»_´štf
(cÚ¡ *
fmt
, ...)

739 
va_li¡
 
­
;

740 
n
;

742 
	`va_¡¬t
(
­
, 
fmt
);

743 
n
 = 
	`»_v´štf
(
fmt
, 
­
);

744 
	`va_’d
(
­
);

746  
n
;

747 
	}
}

759 
	$»_¢´štf
(*
¡r
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

761 
va_li¡
 
­
;

762 
n
;

764 
	`va_¡¬t
(
­
, 
fmt
);

765 
n
 = 
	`»_v¢´štf
(
¡r
, 
size
, 
fmt
, 
­
);

766 
	`va_’d
(
­
);

768  
n
;

769 
	}
}

780 
	$»_sd´štf
(**
¡½
, cÚ¡ *
fmt
, ...)

782 
va_li¡
 
­
;

783 
”r
;

785 
	`va_¡¬t
(
­
, 
fmt
);

786 
”r
 = 
	`»_vsd´štf
(
¡½
, 
fmt
, 
­
);

787 
	`va_’d
(
­
);

789  
”r
;

790 
	}
}

	@re-0.5.6/src/fmt/prm.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

18 
boŞ
 
	$fmt_·¿m_exi¡s
(cÚ¡ 
¶
 *¶, cÚ¡ *
²ame
)

20 
¶
 
£mi
, 
eİ
;

21 
ex´
[128];

23 ià(!
¶
 || !
²ame
)

24  
çl£
;

26 ()
	`»_¢´štf
(
ex´
, (expr),

28 
²ame
);

30 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, 
ex´
, &
£mi
, 
NULL
, &
eİ
))

31  
çl£
;

33 ià(!
eİ
.
l
 &&ƒİ.
p
 < 
¶
->p +…l->l)

34  
çl£
;

36  
£mi
.
l
 > 0 || 
¶
->
p
 == semi.p;

37 
	}
}

49 
boŞ
 
	$fmt_·¿m_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ *
²ame
, ¶ *
v®
)

51 
¶
 
£mi
;

52 
ex´
[128];

54 ià(!
¶
 || !
²ame
)

55  
çl£
;

57 ()
	`»_¢´štf
(
ex´
, (expr),

59 
²ame
);

61 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, 
ex´
, &
£mi
, 
NULL
, NULL, NULL, 
v®
))

62  
çl£
;

64  
£mi
.
l
 > 0 || 
¶
->
p
 == semi.p;

65 
	}
}

75 
	$fmt_·¿m_­¶y
(cÚ¡ 
¶
 *¶, 
fmt_·¿m_h
 *
ph
, *
¬g
)

77 
¶
 
´mv
, 
´m
, 
£mi
, 
Çme
, 
v®
;

79 ià(!
¶
 || !
ph
)

82 
´mv
 = *
¶
;

84 !
	`»_»gex
(
´mv
.
p
,…rmv.
l
, "[ \t\r\n]*[~;]+[;]*",

85 
NULL
, &
´m
, &
£mi
)) {

87 
	`¶_advªû
(&
´mv
, 
£mi
.
p
 + semi.
l
 -…rmv.p);

89 ià(
	`»_»gex
(
´m
.
p
,…rm.
l
,

91 &
Çme
, 
NULL
, NULL, NULL, &
v®
))

94 
	`ph
(&
Çme
, &
v®
, 
¬g
);

96 
	}
}

	@re-0.5.6/src/fmt/regex.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

12 
	schr
 {

13 
ušt8_t
 
	mmš
;

14 
ušt8_t
 
	mmax
;

18 
boŞ
 
	$ex´_m©ch
(cÚ¡ 
chr
 *
chrv
, 
ušt32_t
 
n
, 
ušt8_t
 
c
,

19 
boŞ
 
Ãg
)

21 
ušt32_t
 
i
;

23 
i
=0; i<
n
; i++) {

25 ià(
c
 < 
chrv
[
i
].
mš
)

28 ià(
c
 > 
chrv
[
i
].
max
)

34  
Ãg
 ? (
i
 =ğ
n
) : (i !=‚);

35 
	}
}

64 
	$»_»gex
(cÚ¡ *
±r
, 
size_t
 
Ën
, cÚ¡ *
ex´
, ...)

66 
chr
 
chrv
[64];

67 cÚ¡ *
p
, *
•
;

68 
boŞ
 
fm
, 
¿nge
 = 
çl£
, 
ec
 = f®£, 
Ãg
 = f®£, 
qesc
 = false;

69 
ušt32_t
 
n
 = 0;

70 
va_li¡
 
­
;

71 
boŞ
 
“sc
;

72 
size_t
 
l
;

74 ià(!
±r
 || !
ex´
)

75  
EINVAL
;

77 
agaš
:

78 
“sc
 = 
çl£
;

79 
fm
 = 
çl£
;

80 
l
 = 
Ën
--;

81 
p
 = 
±r
++;

82 
•
 = 
ex´
;

84 
	`va_¡¬t
(
­
, 
ex´
);

86 ià(!
l
)

87 
out
;

89 ; *
•
;ƒp++) {

91 ià('\\' =ğ*
•
 && !
“sc
) {

92 
“sc
 = 
Œue
;

96 ià(!
fm
) {

99 ià('[' =ğ*
•
 && !
“sc
) {

100 
n
 = 0;

101 
fm
 = 
Œue
;

102 
ec
 = 
çl£
;

103 
Ãg
 = 
çl£
;

104 
¿nge
 = 
çl£
;

105 
qesc
 = 
çl£
;

109 ià(!
l
)

112 ià(
	`tŞow”
(*
•
è!ğtŞow”(*
p
)) {

113 
	`va_’d
(
­
);

114 
agaš
;

117 
“sc
 = 
çl£
;

118 ++
p
;

119 --
l
;

123 ià(
ec
) {

125 
ušt32_t
 
nm
, 
nmš
, 
nmax
;

126 
¶
 
Íl
, *¶ = 
	`va_¬g
(
­
, pl *);

127 
boŞ
 
quÙe
 = 
çl£
, 
esc
 = false;

130 ià('*' =ğ*
•
) {

131 
nmš
 = 0;

132 
nmax
 = -1;

135 ià('+' =ğ*
•
) {

136 
nmš
 = 1;

137 
nmax
 = -1;

140 ià('1' <ğ*
•
 && *ep <= '9') {

141 
nmš
 = *
•
 - '0';

142 
nmax
 = *
•
 - '0';

147 
fm
 = 
çl£
;

149 
Íl
.
p
 =…;

150 
Íl
.
l
 = 0;

152 
nm
 = 0; 
l
 &&‚m < 
nmax
;‚m++, 
p
++,†--, 
Íl
.l++) {

154 ià(
qesc
) {

156 ià(
esc
) {

157 
esc
 = 
çl£
;

161 *
p
) {

164 
esc
 = 
Œue
;

168 
quÙe
 = !quote;

172 ià(
quÙe
)

176 ià(!
	`ex´_m©ch
(
chrv
, 
n
, 
	`tŞow”
(*
p
), 
Ãg
))

181 ià(
qesc
 && 
Íl
.
l
 > 1 &&

182 
Íl
.
p
[0] =ğ'"' &&†¶.p[Íl.
l
 - 1] == '"') {

184 
Íl
.
p
 += 1;

185 
Íl
.
l
 -= 2;

186 
nm
 -= 2;

189 ià((
nm
 < 
nmš
è|| (nm > 
nmax
)) {

190 
	`va_’d
(
­
);

191 
agaš
;

194 ià(
¶
)

195 *
¶
 = 
Íl
;

197 
“sc
 = 
çl£
;

201 ià(
“sc
) {

202 
“sc
 = 
çl£
;

203 
chr
;

206 *
•
) {

210 
ec
 = 
Œue
;

215 ià(
n
)

218 
qesc
 = 
Œue
;

219 
Ãg
 = 
Œue
;

224 ià(
n
)

227 
Ãg
 = 
Œue
;

232 ià(!
n
 || 
¿nge
)

235 
¿nge
 = 
Œue
;

236 --
n
;

240 
chr
:

241 
chrv
[
n
].
max
 = 
	`tŞow”
(*
•
);

243 ià(
¿nge
)

244 
¿nge
 = 
çl£
;

246 
chrv
[
n
].
mš
 = 
	`tŞow”
(*
•
);

248 ià(++
n
 > 
	`ARRAY_SIZE
(
chrv
))

251 
out
:

252 
	`va_’d
(
­
);

254 ià(
fm
)

255  
EINVAL
;

257  *
•
 ? 
ENOENT
 : 0;

258 
	}
}

	@re-0.5.6/src/fmt/str.c

6 #undeà
__STRICT_ANSI__


7 
	~<¡ršg.h
>

8 #ifdeà
HAVE_STRINGS_H


9 
	~<¡ršgs.h
>

11 
	~<»_ty³s.h
>

12 
	~<»_mem.h
>

13 
	~<»_fmt.h
>

25 
	$¡r_hex
(
ušt8_t
 *
hex
, 
size_t
 
Ën
, cÚ¡ *
¡r
)

27 
size_t
 
i
;

29 ià(!
hex
 || !
¡r
 || (
	`¡¾’
(¡rè!ğ(2 * 
Ën
)))

30  
EINVAL
;

32 
i
=0; i<
Ën
*2; i+=2) {

33 
hex
[
i
/2] = 
	`ch_hex
(
¡r
[i]) << 4;

34 
hex
[
i
/2] +ğ
	`ch_hex
(
¡r
[i+1]);

38 
	}
}

48 
	$¡r_nıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
)

50 ià(!
d¡
 || !
¤c
 || !
n
)

53 ()
	`¡ºıy
(
d¡
, 
¤c
, 
n
-1);

54 
d¡
[
n
-1] = '\0';

55 
	}
}

66 
	$¡r_dup
(**
d¡
, cÚ¡ *
¤c
)

68 *
p
;

69 
size_t
 
sz
;

71 ià(!
d¡
 || !
¤c
)

72  
EINVAL
;

74 
sz
 = 
	`¡¾’
(
¤c
) + 1;

76 
p
 = 
	`mem_®loc
(
sz
, 
NULL
);

77 ià(!
p
)

78  
ENOMEM
;

80 
	`memıy
(
p
, 
¤c
, 
sz
);

82 *
d¡
 = 
p
;

85 
	}
}

97 
	$¡r_cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
)

99 ià(!
s1
 || !
s2
)

102  
	`¡rcmp
(
s1
, 
s2
);

103 
	}
}

115 
	$¡r_ÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
)

118 ià(
s1
 =ğ
s2
)

121 ià(!
s1
 || !
s2
)

124 #ifdeà
WIN32


125  
	`_¡ricmp
(
s1
, 
s2
);

127  
	`¡rÿ£cmp
(
s1
, 
s2
);

129 
	}
}

139 
size_t
 
	$¡r_Ën
(cÚ¡ *
s
)

141  
s
 ? 
	`¡¾’
(s) : 0;

142 
	}
}

	@re-0.5.6/src/fmt/str_error.c

6 
	#_GNU_SOURCE
 1

	)

7 
	#__EXTENSIONS__
 1

	)

8 
	~<¡ršg.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

22 cÚ¡ *
	$¡r_”rÜ
(
”ºum
, *
buf
, 
size_t
 
sz
)

24 cÚ¡ *
s
;

26 ià(!
buf
 || !
sz
)

27  
NULL
;

29 
buf
[0] = '\0';

30 #ifdeà
HAVE_STRERROR_R


32 #ifdeà
__GLIBC__


33 
s
 = 
	`¡»¼Ü_r
(
”ºum
, 
buf
, 
sz
);

35 ()
	`¡»¼Ü_r
(
”ºum
, 
buf
, 
sz
);

36 
s
 = 
buf
;

39 #–ià
	`defšed
 (
WIN32
è& !defšed (
__MINGW32__
)

40 ()
	`¡»¼Ü_s
(
buf
, 
sz
, 
”ºum
);

41 
s
 = 
buf
;

44 ()
”ºum
;

45 
s
 = "unknownƒrror";

48 
buf
[
sz
 - 1] = '\0';

50  
s
;

51 
	}
}

	@re-0.5.6/src/fmt/time.c

6 
	~<time.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

11 cÚ¡ *
	gdayv
[] = {"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"};

13 cÚ¡ *
	gmÚv
[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun",

25 
	$fmt_gmtime
(
»_´štf
 *
pf
, *
ts
)

27 cÚ¡ 
tm
 *tm;

28 
time_t
 
t
;

30 ià(!
ts
) {

31 
t
 = 
	`time
(
NULL
);

32 
ts
 = &
t
;

35 
tm
 = 
	`gmtime
(
ts
);

36 ià(!
tm
)

37  
EINVAL
;

39  
	`»_h´štf
(
pf
, "%s, %02u %s %u %02u:%02u:%02u GMT",

40 
dayv
[
	`mš
(()
tm
->
tm_wday
, 
	`ARRAY_SIZE
(dayv)-1)],

41 
tm
->
tm_mday
,

42 
mÚv
[
	`mš
(()
tm
->
tm_mÚ
, 
	`ARRAY_SIZE
(monv)-1)],

43 
tm
->
tm_y—r
 + 1900,

44 
tm
->
tm_hour
,m->
tm_mš
,m->
tm_£c
);

45 
	}
}

56 
	$fmt_humª_time
(
»_´štf
 *
pf
, cÚ¡ 
ušt32_t
 *
£cÚds
)

59 cÚ¡ 
ušt32_t
 
£c
 = *
£cÚds
%60;

60 cÚ¡ 
ušt32_t
 
mš
 = *
£cÚds
/60%60;

61 cÚ¡ 
ušt32_t
 
hrs
 = *
£cÚds
/60/60%24;

62 cÚ¡ 
ušt32_t
 
days
 = *
£cÚds
/60/60/24;

63 
”r
 = 0;

65 ià(
days
)

66 
”r
 |ğ
	`»_h´štf
(
pf
, "%u day% ", 
days
, 1==days?"":"s");

68 ià(
hrs
) {

69 
”r
 |ğ
	`»_h´štf
(
pf
, "%u hour% ", 
hrs
, 1==hrs?"":"s");

72 ià(
mš
) {

73 
”r
 |ğ
	`»_h´štf
(
pf
, "%u mš% ", 
mš
, 1==min?"":"s");

76 ià(
£c
) {

77 
”r
 |ğ
	`»_h´štf
(
pf
, "%u sec%s", 
£c
, 1==sec?"":"s");

80  
”r
;

81 
	}
}

	@re-0.5.6/src/fmt/unicode.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

11 cÚ¡ *
	ghex_ch¬s
 = "0123456789ABCDEF";

22 
	$utf8_’code
(
»_´štf
 *
pf
, cÚ¡ *
¡r
)

24 
ubuf
[6] = "\\u00", 
ebuf
[2] = "\\";

26 ià(!
pf
)

27  
EINVAL
;

29 ià(!
¡r
)

32 *
¡r
) {

33 cÚ¡ 
ušt8_t
 
c
 = *
¡r
++;

34 
boŞ
 
unicode
 = 
çl£
;

35 
ec
 = 0;

36 
”r
;

38 
c
) {

40 '"': 
ec
 = '"'; ;

41 '\\': 
ec
 = '\\'; ;

42 '/': 
ec
 = '/'; ;

43 '\b': 
ec
 = 'b'; ;

44 '\f': 
ec
 = 'f'; ;

45 '\n': 
ec
 = 'n'; ;

46 '\r': 
ec
 = 'r'; ;

47 '\t': 
ec
 = 't'; ;

49 ià(
c
 < ' ') {

50 
unicode
 = 
Œue
;

56 ià(
unicode
) {

57 
ubuf
[4] = 
hex_ch¬s
[(
c
>>4) & 0xf];

58 
ubuf
[5] = 
hex_ch¬s
[
c
 & 0xf];

60 
”r
 = 
pf
->
	`vph
(
ubuf
, (ubuf),…f->
¬g
);

62 ià(
ec
) {

63 
ebuf
[1] = 
ec
;

65 
”r
 = 
pf
->
	`vph
(
ebuf
, Óbuf),…f->
¬g
);

68 
”r
 = 
pf
->
	`vph
((*)&
c
, 1,…f->
¬g
);

71 ià(
”r
)

72  
”r
;

76 
	}
}

87 
	$utf8_decode
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

89 
size_t
 
i
;

91 ià(!
pf
)

92  
EINVAL
;

94 ià(!
¶
)

97 
i
=0; i<
¶
->
l
; i++) {

99 
ch
 = 
¶
->
p
[
i
];

100 
”r
;

102 ià(
ch
 == '\\') {

104 
ušt16_t
 
u
 = 0;

106 ++
i
;

108 ià(
i
 >ğ
¶
->
l
)

109  
EBADMSG
;

111 
ch
 = 
¶
->
p
[
i
];

113 
ch
) {

116 
ch
 = '\b';

120 
ch
 = '\f';

124 
ch
 = '\n';

128 
ch
 = '\r';

132 
ch
 = '\t';

136 ià(
i
+4 >ğ
¶
->
l
)

137  
EBADMSG
;

139 ià(!
	`isxdig™
(
¶
->
p
[
i
+1]) ||

140 !
	`isxdig™
(
¶
->
p
[
i
+2]) ||

141 !
	`isxdig™
(
¶
->
p
[
i
+3]) ||

142 !
	`isxdig™
(
¶
->
p
[
i
+4]))

143  
EBADMSG
;

145 
u
 |ğ((
ušt16_t
)
	`ch_hex
(
¶
->
p
[++
i
])) << 12;

146 
u
 |ğ((
ušt16_t
)
	`ch_hex
(
¶
->
p
[++
i
])) << 8;

147 
u
 |ğ((
ušt16_t
)
	`ch_hex
(
¶
->
p
[++
i
])) << 4;

148 
u
 |ğ((
ušt16_t
)
	`ch_hex
(
¶
->
p
[++
i
])) << 0;

150 ià(
u
 > 255) {

151 
ch
 = 
u
>>8;

152 
”r
 = 
pf
->
	`vph
(&
ch
, 1,…f->
¬g
);

153 ià(
”r
)

154  
”r
;

157 
ch
 = 
u
 & 0xff;

162 
”r
 = 
pf
->
	`vph
(&
ch
, 1,…f->
¬g
);

163 ià(
”r
)

164  
”r
;

168 
	}
}

	@re-0.5.6/src/hash/func.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_li¡.h
>

10 
	~<»_hash.h
>

21 
ušt32_t
 
	$hash_jß©
(cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
Ën
)

23 
ušt32_t
 
hash
 = 0;

24 
size_t
 
i
;

26 
i
 = 0; i < 
Ën
; i++) {

27 
hash
 +ğ
key
[
i
];

28 
hash
 += (hash << 10);

29 
hash
 ^= (hash >> 6);

31 
hash
 += (hash << 3);

32 
hash
 ^= (hash >> 11);

33 
hash
 += (hash << 15);

35  
hash
;

36 
	}
}

47 
ušt32_t
 
	$hash_jß©_ci
(cÚ¡ *
¡r
, 
size_t
 
Ën
)

49 
ušt32_t
 
hash
 = 0;

50 
size_t
 
i
;

52 
i
 = 0; i < 
Ën
; i++) {

53 
hash
 +ğ
	`tŞow”
(
¡r
[
i
]);

54 
hash
 += (hash << 10);

55 
hash
 ^= (hash >> 6);

57 
hash
 += (hash << 3);

58 
hash
 ^= (hash >> 11);

59 
hash
 += (hash << 15);

61  
hash
;

62 
	}
}

72 
ušt32_t
 
	$hash_jß©_¡r
(cÚ¡ *
¡r
)

74 
ušt32_t
 
hash
 = 0;

76 *
¡r
) {

77 
hash
 +ğ*
¡r
++;

78 
hash
 += (hash << 10);

79 
hash
 ^= (hash >> 6);

81 
hash
 += (hash << 3);

82 
hash
 ^= (hash >> 11);

83 
hash
 += (hash << 15);

85  
hash
;

86 
	}
}

96 
ušt32_t
 
	$hash_jß©_¡r_ci
(cÚ¡ *
¡r
)

98 
ušt32_t
 
hash
 = 0;

100 *
¡r
) {

101 
hash
 +ğ
	`tŞow”
(*
¡r
++);

102 
hash
 += (hash << 10);

103 
hash
 ^= (hash >> 6);

105 
hash
 += (hash << 3);

106 
hash
 ^= (hash >> 11);

107 
hash
 += (hash << 15);

109  
hash
;

110 
	}
}

120 
ušt32_t
 
	$hash_jß©_¶
(cÚ¡ 
¶
 *pl)

122  
¶
 ? 
	`hash_jß©
((cÚ¡ 
ušt8_t
 *íl->
p
,…l->
l
) : 0;

123 
	}
}

133 
ušt32_t
 
	$hash_jß©_¶_ci
(cÚ¡ 
¶
 *pl)

135  
¶
 ? 
	`hash_jß©_ci
Õl->
p
,…l->
l
) : 0;

136 
	}
}

143 #ià(
defšed
(
__BYTE_ORDER
è&& defšed(
__LITTLE_ENDIAN
) && \

144 
	g__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN
) || \

145 (
defšed
(
i386
è|| defšed(
__i386__
è|| defšed(
__i486__
) || \

146 
defšed
(
__i586__
è|| defšed(
__i686__
) || \

147 
defšed
(
vax
è|| 
	$defšed
(
MIPSEL
))

148 
	#HASH_LITTLE_ENDIAN
 1

	)

149 
	#HASH_BIG_ENDIAN
 0

	)

150 #–ià(
	`defšed
(
__BYTE_ORDER
è&& defšed(
__BIG_ENDIAN
) && \

151 
__BYTE_ORDER
 =ğ
__BIG_ENDIAN
) || \

152 (
	`defšed
(
¥¬c
è|| defšed(
POWERPC
) || \

153 
	`defšed
(
mc68000
è|| 
	$defšed
(
£l
))

154 
	#HASH_LITTLE_ENDIAN
 0

	)

155 
	#HASH_BIG_ENDIAN
 1

	)

157 
	#HASH_LITTLE_ENDIAN
 0

	)

158 
	#HASH_BIG_ENDIAN
 0

	)

161 
	#hashsize
(
n
è((
ušt32_t
)1<<Ò))

	)

162 
	#hashmask
(
n
è(
	`hashsize
Ò)-1)

	)

163 
	#rÙ
(
x
,
k
è(((x)<<(k)è| ((x)>>(32-(k))))

	)

165 
	#mix
(
a
,
b
,
c
) { \

166 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c, 4); c +ğ
b
; \

167 
b
 -ğ
a
; b ^ğ
	`rÙ
×, 6);‡ +ğ
c
; \

168 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 8); b +ğ
a
; \

169 
a
 -ğ
c
;‡ ^ğ
	`rÙ
(c,16); c +ğ
b
; \

170 
b
 -ğ
a
; b ^ğ
	`rÙ
×,19);‡ +ğ
c
; \

171 
c
 -ğ
b
; c ^ğ
	`rÙ
(b, 4); b +ğ
a
; \

172 
	}

	)
}

175 
	#fš®
(
a
,
b
,
c
) \

177 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,14); \

178 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,11); \

179 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,25); \

180 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,16); \

181 
a
 ^ğ
c
;‡ -ğ
	`rÙ
(c,4); \

182 
b
 ^ğ
a
; b -ğ
	`rÙ
(a,14); \

183 
c
 ^ğ
b
; c -ğ
	`rÙ
(b,24); \

184 }

	)

187 
ušt32_t
 
	$hashl™e
ĞcÚ¡ *
key
, 
size_t
 
Ëngth
, 
ušt32_t
 
š™v®
)

189 
ušt32_t
 
a
,
b
,
c
;

190 uniÚ { cÚ¡ *
±r
; 
size_t
 
i
; } 
u
;

193 
a
 = 
b
 = 
c
 = 0xd—db“à+ ((
ušt32_t
)
Ëngth
è+ 
š™v®
;

195 
u
.
±r
 = 
key
;

196 ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x3) == 0)) {

197 cÚ¡ 
ušt32_t
 *
k
 = (cÚ¡ ušt32_ˆ*)
key
;

199 
Ëngth
 > 12) {

200 
a
 +ğ
k
[0];

201 
b
 +ğ
k
[1];

202 
c
 +ğ
k
[2];

203 
	`mix
(
a
,
b
,
c
);

204 
Ëngth
 -= 12;

205 
k
 += 3;

208 #iâdeà
VALGRIND


209 
Ëngth
) {

211 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

212 11: 
c
+=
k
[2]&0xffffff; 
b
+=k[1]; 
a
+=k[0]; ;

213 10: 
c
+=
k
[2]&0xffff; 
b
+=k[1]; 
a
+=k[0]; ;

214 9 : 
c
+=
k
[2]&0xff; 
b
+=k[1]; 
a
+=k[0]; ;

215 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

216 7 : 
b
+=
k
[1]&0xffffff; 
a
+=k[0]; ;

217 6 : 
b
+=
k
[1]&0xffff; 
a
+=k[0]; ;

218 5 : 
b
+=
k
[1]&0xff; 
a
+=k[0]; ;

219 4 : 
a
+=
k
[0]; ;

220 3 : 
a
+=
k
[0]&0xffffff; ;

221 2 : 
a
+=
k
[0]&0xffff; ;

222 1 : 
a
+=
k
[0]&0xff; ;

223 0 :  
c
;

228 cÚ¡ 
ušt8_t
 *
k8
 = (cÚ¡ ušt8_ˆ*)
k
;

229 
Ëngth
) {

231 12: 
c
+=
k
[2]; 
b
+=k[1]; 
a
+=k[0]; ;

232 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

233 10: 
c
+=((
ušt32_t
)
k8
[9])<<8;

234 9 : 
c
+=
k8
[8];

235 8 : 
b
+=
k
[1]; 
a
+=k[0]; ;

236 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

237 6 : 
b
+=((
ušt32_t
)
k8
[5])<<8;

238 5 : 
b
+=
k8
[4];

239 4 : 
a
+=
k
[0]; ;

240 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

241 2 : 
a
+=((
ušt32_t
)
k8
[1])<<8;

242 1 : 
a
+=
k8
[0]; ;

243 0 :  
c
;

249 ià(
HASH_LITTLE_ENDIAN
 && ((
u
.
i
 & 0x1) == 0)) {

250 cÚ¡ 
ušt16_t
 *
k
 = (cÚ¡ ušt16_ˆ*)
key
;

251 cÚ¡ 
ušt8_t
 *
k8
;

253 
Ëngth
 > 12) {

254 
a
 +ğ
k
[0] + (((
ušt32_t
)k[1])<<16);

255 
b
 +ğ
k
[2] + (((
ušt32_t
)k[3])<<16);

256 
c
 +ğ
k
[4] + (((
ušt32_t
)k[5])<<16);

257 
	`mix
(
a
,
b
,
c
);

258 
Ëngth
 -= 12;

259 
k
 += 6;

262 
k8
 = (cÚ¡ 
ušt8_t
 *)
k
;

264 
Ëngth
) {

266 12: 
c
+=
k
[4]+(((
ušt32_t
)k[5])<<16);

267 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

268 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

270 11: 
c
+=((
ušt32_t
)
k8
[10])<<16;

271 10: 
c
+=
k
[4];

272 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

273 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

275 9 : 
c
+=
k8
[8];

276 8 : 
b
+=
k
[2]+(((
ušt32_t
)k[3])<<16);

277 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

279 7 : 
b
+=((
ušt32_t
)
k8
[6])<<16;

280 6 : 
b
+=
k
[2];

281 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

283 5 : 
b
+=
k8
[4];

284 4 : 
a
+=
k
[0]+(((
ušt32_t
)k[1])<<16);

286 3 : 
a
+=((
ušt32_t
)
k8
[2])<<16;

287 2 : 
a
+=
k
[0];

289 1 : 
a
+=
k8
[0];

291 0 :  
c
;

295 cÚ¡ 
ušt8_t
 *
k
 = (cÚ¡ ušt8_ˆ*)
key
;

297 
Ëngth
 > 12) {

298 
a
 +ğ
k
[0];

299 
a
 +ğ((
ušt32_t
)
k
[1])<<8;

300 
a
 +ğ((
ušt32_t
)
k
[2])<<16;

301 
a
 +ğ((
ušt32_t
)
k
[3])<<24;

302 
b
 +ğ
k
[4];

303 
b
 +ğ((
ušt32_t
)
k
[5])<<8;

304 
b
 +ğ((
ušt32_t
)
k
[6])<<16;

305 
b
 +ğ((
ušt32_t
)
k
[7])<<24;

306 
c
 +ğ
k
[8];

307 
c
 +ğ((
ušt32_t
)
k
[9])<<8;

308 
c
 +ğ((
ušt32_t
)
k
[10])<<16;

309 
c
 +ğ((
ušt32_t
)
k
[11])<<24;

310 
	`mix
(
a
,
b
,
c
);

311 
Ëngth
 -= 12;

312 
k
 += 12;

316 
Ëngth
) {

318 12: 
c
+=((
ušt32_t
)
k
[11])<<24;

319 11: 
c
+=((
ušt32_t
)
k
[10])<<16;

320 10: 
c
+=((
ušt32_t
)
k
[9])<<8;

321 9 : 
c
+=
k
[8];

322 8 : 
b
+=((
ušt32_t
)
k
[7])<<24;

323 7 : 
b
+=((
ušt32_t
)
k
[6])<<16;

324 6 : 
b
+=((
ušt32_t
)
k
[5])<<8;

325 5 : 
b
+=
k
[4];

326 4 : 
a
+=((
ušt32_t
)
k
[3])<<24;

327 3 : 
a
+=((
ušt32_t
)
k
[2])<<16;

328 2 : 
a
+=((
ušt32_t
)
k
[1])<<8;

329 1 : 
a
+=
k
[0];

331 0 :  
c
;

335 
	`fš®
(
a
,
b
,
c
);

336  
c
;

337 
	}
}

348 
ušt32_t
 
	$hash_ç¡
(cÚ¡ *
k
, 
size_t
 
Ën
)

350 vŞ©
¿ndom_£ed
 = 0x304a0012;

352 ià(!
k
)

355  
	`hashl™e
(
k
, 
Ën
, 
¿ndom_£ed
);

356 
	}
}

366 
ušt32_t
 
	$hash_ç¡_¡r
(cÚ¡ *
¡r
)

368  
	`hash_ç¡
(
¡r
, 
	`¡r_Ën
(str));

369 
	}
}

	@re-0.5.6/src/hash/hash.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_hash.h
>

14 
	shash
 {

15 
li¡
 *
	mbuck‘
;

16 
ušt32_t
 
	mbsize
;

20 
	$hash_de¡ruùÜ
(*
d©a
)

22 
hash
 *
h
 = 
d©a
;

24 
	`mem_d”ef
(
h
->
buck‘
);

25 
	}
}

36 
	$hash_®loc
(
hash
 **
hp
, 
ušt32_t
 
bsize
)

38 
hash
 *
h
;

39 
”r
 = 0;

41 ià(!
hp
 || !
bsize
)

42  
EINVAL
;

45 ià(
bsize
 & (bsize-1))

46  
EINVAL
;

48 
h
 = 
	`mem_z®loc
((*h), 
hash_de¡ruùÜ
);

49 ià(!
h
)

50  
ENOMEM
;

52 
h
->
bsize
 = bsize;

54 
h
->
buck‘
 = 
	`mem_z®loc
(
bsize
*(*h->buck‘), 
NULL
);

55 ià(!
h
->
buck‘
) {

56 
”r
 = 
ENOMEM
;

57 
out
;

60 
out
:

61 ià(
”r
)

62 
	`mem_d”ef
(
h
);

64 *
hp
 = 
h
;

66  
”r
;

67 
	}
}

78 
	$hash_­³nd
(
hash
 *
h
, 
ušt32_t
 
key
, 
Ë
 *Ë, *
d©a
)

80 ià(!
h
 || !
Ë
)

83 
	`li¡_­³nd
(&
h
->
buck‘
[
key
 & (h->
bsize
-1)], 
Ë
, 
d©a
);

84 
	}
}

92 
	$hash_uÆšk
(
Ë
 *le)

94 
	`li¡_uÆšk
(
Ë
);

95 
	}
}

108 
Ë
 *
	$hash_lookup
(cÚ¡ 
hash
 *
h
, 
ušt32_t
 
key
, 
li¡_­¶y_h
 *
ah
,

109 *
¬g
)

111 ià(!
h
 || !
ah
)

112  
NULL
;

114  
	`li¡_­¶y
(&
h
->
buck‘
[
key
 & (h->
bsize
-1)], 
Œue
, 
ah
, 
¬g
);

115 
	}
}

127 
Ë
 *
	$hash_­¶y
(cÚ¡ 
hash
 *
h
, 
li¡_­¶y_h
 *
ah
, *
¬g
)

129 
Ë
 *Ë = 
NULL
;

130 
ušt32_t
 
i
;

132 ià(!
h
 || !
ah
)

133  
NULL
;

135 
i
=0; (i<
h
->
bsize
è&& !
Ë
; i++)

136 
Ë
 = 
	`li¡_­¶y
(&
h
->
buck‘
[
i
], 
Œue
, 
ah
, 
¬g
);

138  
Ë
;

139 
	}
}

150 
li¡
 *
	$hash_li¡
(cÚ¡ 
hash
 *
h
, 
ušt32_t
 
key
)

152  
h
 ? &h->
buck‘
[
key
 & (h->
bsize
 - 1)] : 
NULL
;

153 
	}
}

163 
ušt32_t
 
	$hash_bsize
(cÚ¡ 
hash
 *
h
)

165  
h
 ? h->
bsize
 : 0;

166 
	}
}

174 
	$hash_æush
(
hash
 *
h
)

176 
ušt32_t
 
i
;

178 ià(!
h
)

181 
i
=0; i<
h
->
bsize
; i++)

182 
	`li¡_æush
(&
h
->
buck‘
[
i
]);

183 
	}
}

191 
	$hash_ş—r
(
hash
 *
h
)

193 
ušt32_t
 
i
;

195 ià(!
h
)

198 
i
=0; i<
h
->
bsize
; i++)

199 
	`li¡_ş—r
(&
h
->
buck‘
[
i
]);

200 
	}
}

210 
ušt32_t
 
	$hash_v®id_size
(
ušt32_t
 
size
)

212 
ušt32_t
 
x
;

214 
x
=0; (
ušt32_t
)1<<x < 
size
 && x < 31; x++)

217  1<<
x
;

218 
	}
}

	@re-0.5.6/src/hmac/apple/hmac.c

7 
	~<¡ršg.h
>

8 
	~<CommÚCry±o/CommÚHMAC.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

11 
	~<»_mem.h
>

12 
	~<»_hmac.h
>

15 ’um { 
	mKEY_SIZE
 = 256 };

17 
	shmac
 {

18 
CCHmacCÚ‹xt
 
	mùx
;

19 
ušt8_t
 
	mkey
[
KEY_SIZE
];

20 
size_t
 
	mkey_Ën
;

21 
CCHmacAlgÜ™hm
 
	m®go
;

25 
	$de¡ruùÜ
(*
¬g
)

27 
hmac
 *hmaøğ
¬g
;

29 
	`mem£t
(&
hmac
->
ùx
, 0, (hmac->ctx));

30 
	}
}

33 
	$hmac_ü—‹
(
hmac
 **
hmaı
, 
hmac_hash
 
hash
,

34 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_Ën
)

36 
hmac
 *hmac;

37 
CCHmacAlgÜ™hm
 
®go
;

39 ià(!
hmaı
 || !
key
 || !
key_Ën
 || key_ËÀ> 
KEY_SIZE
)

40  
EINVAL
;

42 
hash
) {

44 
HMAC_HASH_SHA1
:

45 
®go
 = 
kCCHmacAlgSHA1
;

48 
HMAC_HASH_SHA256
:

49 
®go
 = 
kCCHmacAlgSHA256
;

53  
ENOTSUP
;

56 
hmac
 = 
	`mem_z®loc
((*hmac), 
de¡ruùÜ
);

57 ià(!
hmac
)

58  
ENOMEM
;

60 
	`memıy
(
hmac
->
key
, key, 
key_Ën
);

61 
hmac
->
key_Ën
 = key_len;

62 
hmac
->
®go
 =‡lgo;

64 *
hmaı
 = 
hmac
;

67 
	}
}

70 
	$hmac_dige¡
(
hmac
 *hmac, 
ušt8_t
 *
md
, 
size_t
 
md_Ën
,

71 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©a_Ën
)

73 ià(!
hmac
 || !
md
 || !
md_Ën
 || !
d©a
 || !
d©a_Ën
)

74  
EINVAL
;

77 
	`CCHmacIn™
(&
hmac
->
ùx
, hmac->
®go
, hmac->
key
, hmac->
key_Ën
);

79 
	`CCHmacUpd©e
(&
hmac
->
ùx
, 
d©a
, 
d©a_Ën
);

80 
	`CCHmacFš®
(&
hmac
->
ùx
, 
md
);

83 
	}
}

	@re-0.5.6/src/hmac/hmac.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_sha.h
>

10 
	~<»_hmac.h
>

13 
	shmac
 {

14 
ušt8_t
 
	mkey
[
SHA_DIGEST_LENGTH
];

15 
size_t
 
	mkey_Ën
;

19 
	$de¡ruùÜ
(*
¬g
)

21 
hmac
 *hmaøğ
¬g
;

23 
	`mem£t
(
hmac
, 0, (*hmac));

24 
	}
}

27 
	$hmac_ü—‹
(
hmac
 **
hmaı
, 
hmac_hash
 
hash
,

28 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_Ën
)

30 
hmac
 *hmac;

32 ià(!
hmaı
 || !
key
 || !
key_Ën
)

33  
EINVAL
;

35 ià(
hash
 !ğ
HMAC_HASH_SHA1
)

36  
ENOTSUP
;

38 ià(
key_Ën
 > 
SHA_DIGEST_LENGTH
)

39  
EINVAL
;

41 
hmac
 = 
	`mem_z®loc
((*hmac), 
de¡ruùÜ
);

42 ià(!
hmac
)

43  
ENOMEM
;

45 
	`memıy
(
hmac
->
key
, key, 
key_Ën
);

46 
hmac
->
key_Ën
 = key_len;

48 *
hmaı
 = 
hmac
;

51 
	}
}

54 
	$hmac_dige¡
(
hmac
 *hmac, 
ušt8_t
 *
md
, 
size_t
 
md_Ën
,

55 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©a_Ën
)

57 ià(!
hmac
 || !
md
 || !
md_Ën
 || !
d©a
 || !
d©a_Ën
)

58  
EINVAL
;

60 
	`hmac_sha1
(
hmac
->
key
, hmac->
key_Ën
, 
d©a
, 
d©a_Ën
, 
md
, 
md_Ën
);

63 
	}
}

	@re-0.5.6/src/hmac/hmac_sha1.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 #ifdeà
USE_OPENSSL


9 
	~<İ’s¦/sha.h
>

10 
	~<İ’s¦/hmac.h
>

11 
	~<İ’s¦/”r.h
>

13 
	~<»_sha.h
>

15 
	~<»_hmac.h
>

19 #iâdeà
SHA_BLOCKSIZE


20 
	#SHA_BLOCKSIZE
 64

	)

34 
	$hmac_sha1
(cÚ¡ 
ušt8_t
 *
k
,

35 
size_t
 
lk
,

36 cÚ¡ 
ušt8_t
 *
d
,

37 
size_t
 
ld
,

38 
ušt8_t
 *
out
,

39 
size_t
 
t
)

41 #ifdeà
USE_OPENSSL


42 ()
t
;

44 ià(!
	`HMAC
(
	`EVP_sha1
(), 
k
, ()
lk
, 
d
, 
ld
, 
out
, 
NULL
))

45 
	`ERR_ş—r_”rÜ
();

47 
SHA_CTX
 
iùx
, 
oùx
;

48 
ušt8_t
 
isha
[
SHA_DIGEST_LENGTH
], 
osha
[SHA_DIGEST_LENGTH];

49 
ušt8_t
 
key
[
SHA_DIGEST_LENGTH
];

50 
ušt8_t
 
buf
[
SHA_BLOCKSIZE
];

51 
size_t
 
i
;

53 ià(
lk
 > 
SHA_BLOCKSIZE
) {

54 
SHA_CTX
 
tùx
;

56 
	`SHA1_In™
(&
tùx
);

57 
	`SHA1_Upd©e
(&
tùx
, 
k
, 
lk
);

58 
	`SHA1_Fš®
(
key
, &
tùx
);

60 
k
 = 
key
;

61 
lk
 = 
SHA_DIGEST_LENGTH
;

66 
	`SHA1_In™
(&
iùx
);

69 
i
 = 0 ; i < 
lk
 ; ++i)

70 
buf
[
i
] = 
k
[i] ^ 0x36;

71 
i
 = 
lk
 ; i < 
SHA_BLOCKSIZE
 ; ++i)

72 
buf
[
i
] = 0x36;

74 
	`SHA1_Upd©e
(&
iùx
, 
buf
, 
SHA_BLOCKSIZE
);

75 
	`SHA1_Upd©e
(&
iùx
, 
d
, 
ld
);

77 
	`SHA1_Fš®
(
isha
, &
iùx
);

81 
	`SHA1_In™
(&
oùx
);

85 
i
 = 0 ; i < 
lk
 ; ++i)

86 
buf
[
i
] = 
k
[i] ^ 0x5c;

87 
i
 = 
lk
 ; i < 
SHA_BLOCKSIZE
 ; ++i)

88 
buf
[
i
] = 0x5c;

90 
	`SHA1_Upd©e
(&
oùx
, 
buf
, 
SHA_BLOCKSIZE
);

91 
	`SHA1_Upd©e
(&
oùx
, 
isha
, 
SHA_DIGEST_LENGTH
);

93 
	`SHA1_Fš®
(
osha
, &
oùx
);

96 
t
 = > 
SHA_DIGEST_LENGTH
 ? SHA_DIGEST_LENGTH :;

97 
	`memıy
(
out
, 
osha
, 
t
);

99 
	}
}

	@re-0.5.6/src/hmac/openssl/hmac.c

7 
	~<İ’s¦/hmac.h
>

8 
	~<İ’s¦/”r.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_mem.h
>

11 
	~<»_hmac.h
>

14 
	shmac
 {

15 
HMAC_CTX
 *
	mùx
;

19 
	$de¡ruùÜ
(*
¬g
)

21 
hmac
 *hmaøğ
¬g
;

23 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L && \

24 !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

26 ià(
hmac
->
ùx
)

27 
	`HMAC_CTX_ä“
(
hmac
->
ùx
);

29 ià(
hmac
->
ùx
)

30 
	`HMAC_CTX_ş—nup
(
hmac
->
ùx
);

31 
	`mem_d”ef
(
hmac
->
ùx
);

33 
	}
}

36 
	$hmac_ü—‹
(
hmac
 **
hmaı
, 
hmac_hash
 
hash
,

37 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_Ën
)

39 
hmac
 *hmac;

40 cÚ¡ 
EVP_MD
 *
evp
;

41 
”r
 = 0;

43 ià(!
hmaı
 || !
key
 || !
key_Ën
)

44  
EINVAL
;

46 
hash
) {

48 
HMAC_HASH_SHA1
:

49 
evp
 = 
	`EVP_sha1
();

52 
HMAC_HASH_SHA256
:

53 
evp
 = 
	`EVP_sha256
();

57  
ENOTSUP
;

60 
hmac
 = 
	`mem_z®loc
((*hmac), 
de¡ruùÜ
);

61 ià(!
hmac
)

62  
ENOMEM
;

64 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L && \

65 !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

67 
hmac
->
ùx
 = 
	`HMAC_CTX_Ãw
();

68 ià(!
hmac
->
ùx
) {

69 
	`ERR_ş—r_”rÜ
();

70 
”r
 = 
ENOMEM
;

71 
out
;

74 
hmac
->
ùx
 = 
	`mem_z®loc
((*hmac->ùx), 
NULL
);

75 ià(!
hmac
->
ùx
) {

76 
”r
 = 
ENOMEM
;

77 
out
;

80 
	`HMAC_CTX_š™
(
hmac
->
ùx
);

83 #ià(
OPENSSL_VERSION_NUMBER
 >= 0x00909000)

84 ià(!
	`HMAC_In™_ex
(
hmac
->
ùx
, 
key
, ()
key_Ën
, 
evp
, 
NULL
)) {

85 
	`ERR_ş—r_”rÜ
();

86 
”r
 = 
EPROTO
;

89 
	`HMAC_In™_ex
(
hmac
->
ùx
, 
key
, ()
key_Ën
, 
evp
, 
NULL
);

92 
out
:

93 ià(
”r
)

94 
	`mem_d”ef
(
hmac
);

96 *
hmaı
 = 
hmac
;

98  
”r
;

99 
	}
}

102 
	$hmac_dige¡
(
hmac
 *hmac, 
ušt8_t
 *
md
, 
size_t
 
md_Ën
,

103 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
d©a_Ën
)

105 
Ën
 = ()
md_Ën
;

107 ià(!
hmac
 || !
md
 || !
md_Ën
 || !
d©a
 || !
d©a_Ën
)

108  
EINVAL
;

110 #ià(
OPENSSL_VERSION_NUMBER
 >= 0x00909000)

112 ià(!
	`HMAC_In™_ex
(
hmac
->
ùx
, 0, 0, 0, 
NULL
))

113 
”rÜ
;

115 ià(!
	`HMAC_Upd©e
(
hmac
->
ùx
, 
d©a
, ()
d©a_Ën
))

116 
”rÜ
;

117 ià(!
	`HMAC_Fš®
(
hmac
->
ùx
, 
md
, &
Ën
))

118 
”rÜ
;

122 
”rÜ
:

123 
	`ERR_ş—r_”rÜ
();

124  
EPROTO
;

128 
	`HMAC_In™_ex
(
hmac
->
ùx
, 0, 0, 0, 
NULL
);

130 
	`HMAC_Upd©e
(
hmac
->
ùx
, 
d©a
, ()
d©a_Ën
);

131 
	`HMAC_Fš®
(
hmac
->
ùx
, 
md
, &
Ën
);

135 
	}
}

	@re-0.5.6/src/http/auth.c

7 
	~<¡ršg.h
>

8 
	~<time.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_sys.h
>

11 
	~<»_md5.h
>

12 
	~<»_§.h
>

13 
	~<»_li¡.h
>

14 
	~<»_fmt.h
>

15 
	~<»_msg.h
>

16 
	~<»_h‰·uth.h
>

17 
	~<»_h‰p.h
>

21 
	mNONCE_EXPIRES
 = 300,

22 
	mNONCE_MIN_SIZE
 = 33,

26 
ušt64_t
 
	g£ü‘
;

27 
boŞ
 
	g£ü‘_£t
;

38 
	$h‰p_auth_´št_ch®Ënge
(
»_´štf
 *
pf
,

39 cÚ¡ 
h‰p_auth
 *
auth
)

41 
ušt8_t
 
key
[
MD5_SIZE
];

42 
ušt64_t
 
nv
[2];

44 ià(!
auth
)

47 ià(!
£ü‘_£t
) {

48 
£ü‘
 = 
	`¿nd_u64
();

49 
£ü‘_£t
 = 
Œue
;

52 
nv
[0] = 
	`time
(
NULL
);

53 
nv
[1] = 
£ü‘
;

55 
	`md5
((
ušt8_t
 *)
nv
, Òv), 
key
);

57  
	`»_h´štf
(
pf
,

60 
auth
->
»®m
,

61 
key
, (key), 
nv
[0],

62 
auth
->
¡®e
 ? ", stale=true" : "");

63 
	}
}

66 
	$chk_nÚû
(cÚ¡ 
¶
 *
nÚû
, 
ušt32_t
 
expœes
)

68 
ušt8_t
 
nkey
[
MD5_SIZE
], 
ckey
[MD5_SIZE];

69 
ušt64_t
 
nv
[2];

70 
¶
…l;

71 
št64_t
 
age
;

72 
i
;

74 ià(!
nÚû
 || !nÚû->
p
 ||‚Úû->
l
 < 
NONCE_MIN_SIZE
)

75  
EINVAL
;

77 
¶
 = *
nÚû
;

79 
i
=0; i<(
nkey
); i++) {

80 
nkey
[
i
] = 
	`ch_hex
(*
¶
.
p
++) << 4;

81 
nkey
[
i
] +ğ
	`ch_hex
(*
¶
.
p
++);

82 
¶
.
l
 -= 2;

85 
nv
[0] = 
	`¶_x64
(&
¶
);

86 
nv
[1] = 
£ü‘
;

88 
	`md5
((
ušt8_t
 *)
nv
, Òv), 
ckey
);

90 ià(
	`memcmp
(
nkey
, 
ckey
, 
MD5_SIZE
))

91  
EAUTH
;

93 
age
 = 
	`time
(
NULL
è- 
nv
[0];

95 ià(
age
 < 0 ||‡g> 
expœes
)

96  
ETIMEDOUT
;

99 
	}
}

113 
boŞ
 
	$h‰p_auth_check
(cÚ¡ 
¶
 *
hv®
, cÚ¡ ¶ *
m‘hod
,

114 
h‰p_auth
 *
auth
, 
h‰p_auth_h
 *
authh
, *
¬g
)

116 
h‰·uth_dige¡_»¥
 
»¥
;

117 
ušt8_t
 
ha1
[
MD5_SIZE
];

119 ià(!
hv®
 || !
m‘hod
 || !
auth
 || !
authh
)

120  
çl£
;

122 ià(
	`h‰·uth_dige¡_»¥Ú£_decode
(&
»¥
, 
hv®
))

123  
çl£
;

125 ià(
	`¶_¡rÿ£cmp
(&
»¥
.
»®m
, 
auth
->realm))

126  
çl£
;

128 ià(
	`chk_nÚû
(&
»¥
.
nÚû
, 
NONCE_EXPIRES
)) {

129 
auth
->
¡®e
 = 
Œue
;

130  
çl£
;

133 ià(
	`authh
(&
»¥
.
u£ºame
, 
ha1
, 
¬g
))

134  
çl£
;

136 ià(
	`h‰·uth_dige¡_»¥Ú£_auth
(&
»¥
, 
m‘hod
, 
ha1
))

137  
çl£
;

139  
Œue
;

140 
	}
}

153 
boŞ
 
	$h‰p_auth_check_»que¡
(cÚ¡ 
h‰p_msg
 *
msg
,

154 
h‰p_auth
 *
auth
,

155 
h‰p_auth_h
 *
authh
, *
¬g
)

157 cÚ¡ 
h‰p_hdr
 *
hdr
;

159 ià(!
msg
)

160  
çl£
;

162 
hdr
 = 
	`h‰p_msg_hdr
(
msg
, 
HTTP_HDR_AUTHORIZATION
);

163 ià(!
hdr
)

164  
çl£
;

166  
	`h‰p_auth_check
(&
hdr
->
v®
, &
msg
->
m‘
, 
auth
, 
authh
, 
¬g
);

167 
	}
}

	@re-0.5.6/src/http/chunk.c

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~"h‰p.h
"

13 
	$decode_chunk_size
(
h‰p_chunk
 *
chunk
, 
mbuf
 *
mb
)

15 
	`mbuf_g‘_Ëá
(
mb
)) {

17 
ch
 = ()
	`mbuf_»ad_u8
(
mb
);

18 
ušt8_t
 
c
;

20 ià(
ch
 == '\n') {

21 ià(
chunk
->
dig™
) {

22 
chunk
->
dig™
 = 
çl£
;

23 
chunk
->
·¿m
 = 
çl£
;

31 ià(
chunk
->
·¿m
)

34 ià('0' <ğ
ch
 && ch <= '9')

35 
c
 = 
ch
 - '0';

36 ià('A' <ğ
ch
 && ch <= 'F')

37 
c
 = 
ch
 - 'A' + 10;

38 ià('a' <ğ
ch
 && ch <= 'f')

39 
c
 = 
ch
 - 'a' + 10;

40 ià(
ch
 == '\r' || ch == ' ' || ch == '\t')

42 ià(
ch
 =ğ';' && 
chunk
->
dig™
) {

43 
chunk
->
·¿m
 = 
Œue
;

47  
EPROTO
;

49 
chunk
->
dig™
 = 
Œue
;

51 
chunk
->
size
 <<= 4;

52 
chunk
->
size
 +ğ
c
;

55  
ENODATA
;

56 
	}
}

59 
	$decode_Œa”
(
h‰p_chunk
 *
chunk
, 
mbuf
 *
mb
)

61 
	`mbuf_g‘_Ëá
(
mb
)) {

63 
ch
 = ()
	`mbuf_»ad_u8
(
mb
);

65 ià(
ch
 == '\n') {

66 ià(++
chunk
->
lf
 >= 2)

69 ià(
ch
 != '\r')

70 
chunk
->
lf
 = 0;

73  
ENODATA
;

74 
	}
}

77 
	$h‰p_chunk_decode
(
h‰p_chunk
 *
chunk
, 
mbuf
 *
mb
, 
size_t
 *
size
)

79 
”r
;

81 ià(!
chunk
 || !
mb
 || !
size
)

82  
EINVAL
;

84 ià(
chunk
->
Œa”
) {

85 
”r
 = 
	`decode_Œa”
(
chunk
, 
mb
);

86 ià(
”r
)

87  
”r
;

89 *
size
 = 0;

94 
”r
 = 
	`decode_chunk_size
(
chunk
, 
mb
);

95 ià(
”r
)

96  
”r
;

98 ià(
chunk
->
size
 == 0) {

99 
chunk
->
Œa”
 = 
Œue
;

100 
chunk
->
lf
 = 1;

102 
”r
 = 
	`decode_Œa”
(
chunk
, 
mb
);

103 ià(
”r
)

104  
”r
;

107 *
size
 = 
chunk
->size;

108 
chunk
->
size
 = 0;

111 
	}
}

	@re-0.5.6/src/http/client.c

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_li¡.h
>

13 
	~<»_hash.h
>

14 
	~<»_fmt.h
>

15 
	~<»_tmr.h
>

16 
	~<»_¤.h
>

17 
	~<»_tı.h
>

18 
	~<»_s.h
>

19 
	~<»_dns.h
>

20 
	~<»_msg.h
>

21 
	~<»_h‰p.h
>

22 
	~"h‰p.h
"

26 
	mCONN_TIMEOUT
 = 30000,

27 
	mRECV_TIMEOUT
 = 60000,

28 
	mIDLE_TIMEOUT
 = 900000,

29 
	mBUFSIZE_MAX
 = 524288,

30 
	mCONN_BSIZE
 = 256,

33 
	sh‰p_şi
 {

34 
li¡
 
	m»ql
;

35 
hash
 *
	mht_cÚn
;

36 
dnsc
 *
	mdnsc
;

37 
s
 *
	ms
;

40 
	gcÚn
;

42 
	sh‰p_»q
 {

43 
h‰p_chunk
 
	mchunk
;

44 
§
 
	m¤vv
[16];

45 
Ë
 
	mË
;

46 
h‰p_»q
 **
	m»qp
;

47 
h‰p_şi
 *
	mşi
;

48 
h‰p_msg
 *
	mmsg
;

49 
dns_qu”y
 *
	mdq
;

50 
cÚn
 *
	mcÚn
;

51 
mbuf
 *
	mmb»q
;

52 
mbuf
 *
	mmb
;

53 *
	mho¡
;

54 
h‰p_»¥_h
 *
	m»¥h
;

55 
h‰p_d©a_h
 *
	md©ah
;

56 
h‰p_cÚn_h
 *
	mcÚnh
;

57 *
	m¬g
;

58 
size_t
 
	mrx_Ën
;

59 
	m¤vc
;

60 
ušt16_t
 
	mpÜt
;

61 
boŞ
 
	mchunked
;

62 
boŞ
 
	m£cu»
;

63 
boŞ
 
	mşo£
;

67 
	scÚn
 {

68 
tmr
 
	mtmr
;

69 
§
 
	maddr
;

70 
Ë
 
	mhe
;

71 
h‰p_»q
 *
	m»q
;

72 
s_cÚn
 *
	msc
;

73 
tı_cÚn
 *
	mtc
;

74 
ušt64_t
 
	mu£c
;

78 
»q_şo£
(
h‰p_»q
 *
»q
, 
”r
,

79 cÚ¡ 
h‰p_msg
 *
msg
);

80 
»q_cÚÃù
(
h‰p_»q
 *
»q
);

81 
timeout_hªdËr
(*
¬g
);

84 
	$şi_de¡ruùÜ
(*
¬g
)

86 
h‰p_şi
 *
şi
 = 
¬g
;

87 
Ë
 *Ë = 
şi
->
»ql
.
h—d
;

89 
Ë
) {

90 
h‰p_»q
 *
»q
 = 
Ë
->
d©a
;

92 
Ë
 =†e->
Ãxt
;

93 
	`»q_şo£
(
»q
, 
ECONNABORTED
, 
NULL
);

96 
	`hash_æush
(
şi
->
ht_cÚn
);

97 
	`mem_d”ef
(
şi
->
ht_cÚn
);

98 
	`mem_d”ef
(
şi
->
dnsc
);

99 
	`mem_d”ef
(
şi
->
s
);

100 
	}
}

103 
	$»q_de¡ruùÜ
(*
¬g
)

105 
h‰p_»q
 *
»q
 = 
¬g
;

107 
	`li¡_uÆšk
(&
»q
->
Ë
);

108 
	`mem_d”ef
(
»q
->
msg
);

109 
	`mem_d”ef
(
»q
->
dq
);

110 
	`mem_d”ef
(
»q
->
cÚn
);

111 
	`mem_d”ef
(
»q
->
mb»q
);

112 
	`mem_d”ef
(
»q
->
mb
);

113 
	`mem_d”ef
(
»q
->
ho¡
);

114 
	}
}

117 
	$cÚn_de¡ruùÜ
(*
¬g
)

119 
cÚn
 *cÚÀğ
¬g
;

121 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

122 
	`hash_uÆšk
(&
cÚn
->
he
);

123 
	`mem_d”ef
(
cÚn
->
sc
);

124 
	`mem_d”ef
(
cÚn
->
tc
);

125 
	}
}

128 
	$cÚn_idË
(
cÚn
 *conn)

130 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
IDLE_TIMEOUT
, 
timeout_hªdËr
, conn);

131 
cÚn
->
»q
 = 
NULL
;

132 
	}
}

135 
	$»q_şo£
(
h‰p_»q
 *
»q
, 
”r
,

136 cÚ¡ 
h‰p_msg
 *
msg
)

138 
	`li¡_uÆšk
(&
»q
->
Ë
);

139 
»q
->
dq
 = 
	`mem_d”ef
(req->dq);

140 
»q
->
d©ah
 = 
NULL
;

142 ià(
»q
->
cÚn
) {

143 ià(
»q
->
cÚnh
)

144 
»q
->
	`cÚnh
Ôeq->
cÚn
->
tc
,„eq->cÚn->
sc
,„eq->
¬g
);

146 ià(
”r
 || 
»q
->
şo£
 ||„eq->
cÚnh
)

147 
	`mem_d”ef
(
»q
->
cÚn
);

149 
	`cÚn_idË
(
»q
->
cÚn
);

151 
»q
->
cÚn
 = 
NULL
;

154 
»q
->
cÚnh
 = 
NULL
;

156 ià(
»q
->
»qp
) {

157 *
»q
->
»qp
 = 
NULL
;

158 
»q
->
»qp
 = 
NULL
;

161 ià(
»q
->
»¥h
) {

162 ià(
msg
)

163 
msg
->
mb
->
pos
 = 0;

165 
»q
->
	`»¥h
(
”r
, 
msg
,„eq->
¬g
);

166 
»q
->
»¥h
 = 
NULL
;

169 
	`mem_d”ef
(
»q
);

170 
	}
}

173 
	$Œy_Ãxt
(
cÚn
 *cÚn, 
”r
)

175 
h‰p_»q
 *
»q
 = 
cÚn
->req;

176 
boŞ
 
»Œy
 = 
cÚn
->
u£c
 > 1;

178 
	`mem_d”ef
(
cÚn
);

180 ià(!
»q
)

183 
»q
->
cÚn
 = 
NULL
;

185 ià(
»Œy
)

186 ++
»q
->
¤vc
;

188 ià(
»q
->
¤vc
 > 0 && !»q->
msg
) {

190 
”r
 = 
	`»q_cÚÃù
(
»q
);

191 ià(!
”r
)

195 
	`»q_şo£
(
»q
, 
”r
, 
NULL
);

196 
	}
}

199 
	$wr™e_body_buf
(
h‰p_msg
 *
msg
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
sz
)

201 ià((
msg
->
mb
->
pos
 + 
sz
è> 
BUFSIZE_MAX
)

202  
EOVERFLOW
;

204  
	`mbuf_wr™e_mem
(
msg
->
mb
, 
buf
, 
sz
);

205 
	}
}

208 
	$wr™e_body
(
h‰p_»q
 *
»q
, 
mbuf
 *
mb
)

210 cÚ¡ 
size_t
 
size
 = 
	`mš
(
	`mbuf_g‘_Ëá
(
mb
), 
»q
->
rx_Ën
);

211 
”r
;

213 ià(
size
 == 0)

216 ià(
»q
->
d©ah
)

217 
”r
 = 
»q
->
	`d©ah
(
	`mbuf_buf
(
mb
), 
size
,„eq->
msg
,„eq->
¬g
);

219 
”r
 = 
	`wr™e_body_buf
(
»q
->
msg
, 
	`mbuf_buf
(
mb
), 
size
);

221 ià(
”r
)

222  
”r
;

224 
»q
->
rx_Ën
 -ğ
size
;

225 
mb
->
pos
 +ğ
size
;

228 
	}
}

231 
	$»q_»cv
(
h‰p_»q
 *
»q
, 
mbuf
 *
mb
, 
boŞ
 *
Ï¡
)

233 
”r
;

235 *
Ï¡
 = 
çl£
;

237 ià(!
»q
->
chunked
) {

239 
”r
 = 
	`wr™e_body
(
»q
, 
mb
);

240 ià(
”r
)

241  
”r
;

243 ià(
»q
->
rx_Ën
 == 0)

244 *
Ï¡
 = 
Œue
;

249 
	`mbuf_g‘_Ëá
(
mb
)) {

251 ià(
»q
->
rx_Ën
 == 0) {

253 
”r
 = 
	`h‰p_chunk_decode
(&
»q
->
chunk
, 
mb
, &»q->
rx_Ën
);

254 ià(
”r
 =ğ
ENODATA
)

256 ià(
”r
)

257  
”r
;

258 ià(
»q
->
rx_Ën
 == 0) {

259 *
Ï¡
 = 
Œue
;

264 
”r
 = 
	`wr™e_body
(
»q
, 
mb
);

265 ià(
”r
)

266  
”r
;

270 
	}
}

273 
	$timeout_hªdËr
(*
¬g
)

275 
cÚn
 *cÚÀğ
¬g
;

277 
	`Œy_Ãxt
(
cÚn
, 
ETIMEDOUT
);

278 
	}
}

281 
	$e¡ab_hªdËr
(*
¬g
)

283 
cÚn
 *cÚÀğ
¬g
;

284 
h‰p_»q
 *
»q
 = 
cÚn
->req;

285 
”r
;

287 ià(!
»q
)

290 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
»q
->
mb»q
);

291 ià(
”r
) {

292 
	`Œy_Ãxt
(
cÚn
, 
”r
);

296 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
RECV_TIMEOUT
, 
timeout_hªdËr
, conn);

297 
	}
}

300 
	$»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

302 cÚ¡ 
h‰p_hdr
 *
hdr
;

303 
cÚn
 *cÚÀğ
¬g
;

304 
h‰p_»q
 *
»q
 = 
cÚn
->req;

305 
size_t
 
pos
;

306 
boŞ
 
Ï¡
;

307 
”r
;

309 ià(!
»q
)

312 ià(
»q
->
msg
) {

313 
”r
 = 
	`»q_»cv
(
»q
, 
mb
, &
Ï¡
);

314 ià(
”r
 || 
Ï¡
)

315 
out
;

320 ià(
»q
->
mb
) {

322 cÚ¡ 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

324 ià((
	`mbuf_g‘_Ëá
(
»q
->
mb
è+ 
Ën
è> 
BUFSIZE_MAX
) {

325 
”r
 = 
EOVERFLOW
;

326 
out
;

329 
pos
 = 
»q
->
mb
->pos;

330 
»q
->
mb
->
pos
 =„eq->mb->
’d
;

332 
”r
 = 
	`mbuf_wr™e_mem
(
»q
->
mb
, 
	`mbuf_buf
(mb), 
Ën
);

333 ià(
”r
)

334 
out
;

336 
»q
->
mb
->
pos
 =…os;

339 
»q
->
mb
 = 
	`mem_»f
(mb);

342 
pos
 = 
»q
->
mb
->pos;

344 
”r
 = 
	`h‰p_msg_decode
(&
»q
->
msg
,„eq->
mb
, 
çl£
);

345 ià(
”r
) {

346 ià(
”r
 =ğ
ENODATA
) {

347 
»q
->
mb
->
pos
 =…os;

350 
out
;

353 ià(
»q
->
d©ah
)

354 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

356 
hdr
 = 
	`h‰p_msg_hdr
(
»q
->
msg
, 
HTTP_HDR_CONNECTION
);

357 ià(
hdr
 && !
	`¶_¡rÿ£cmp
(&hdr->
v®
, "close"))

358 
»q
->
şo£
 = 
Œue
;

360 ià(
	`h‰p_msg_hdr_has_v®ue
(
»q
->
msg
, 
HTTP_HDR_TRANSFER_ENCODING
,

362 
»q
->
chunked
 = 
Œue
;

364 
»q
->
rx_Ën
 =„eq->
msg
->
ş’
;

366 
”r
 = 
	`»q_»cv
(
»q
,„eq->
mb
, &
Ï¡
);

367 ià(
”r
 || 
Ï¡
)

368 
out
;

372 
out
:

373 
	`»q_şo£
(
»q
, 
”r
,„eq->
msg
);

374 
	}
}

377 
	$şo£_hªdËr
(
”r
, *
¬g
)

379 
cÚn
 *cÚÀğ
¬g
;

381 
	`Œy_Ãxt
(
cÚn
, 
”r
 ?ƒ¼ : 
ECONNRESET
);

382 
	}
}

385 
boŞ
 
	$cÚn_cmp
(
Ë
 *Ë, *
¬g
)

387 cÚ¡ 
cÚn
 *cÚÀğ
Ë
->
d©a
;

388 cÚ¡ 
h‰p_»q
 *
»q
 = 
¬g
;

390 ià(!
	`§_cmp
(&
»q
->
¤vv
[»q->
¤vc
], &
cÚn
->
addr
, 
SA_ALL
))

391  
çl£
;

393 ià(
»q
->
£cu»
 !ğ!!
cÚn
->
sc
)

394  
çl£
;

396  
cÚn
->
»q
 =ğ
NULL
;

397 
	}
}

400 
	$cÚn_cÚÃù
(
h‰p_»q
 *
»q
)

402 cÚ¡ 
§
 *
addr
 = &
»q
->
¤vv
[»q->
¤vc
];

403 
cÚn
 *conn;

404 
”r
;

406 
cÚn
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
»q
->
şi
->
ht_cÚn
,

407 
	`§_hash
(
addr
, 
SA_ALL
), 
cÚn_cmp
, 
»q
));

408 ià(
cÚn
) {

409 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
»q
->
mb»q
);

410 ià(!
”r
) {

411 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
RECV_TIMEOUT
,

412 
timeout_hªdËr
, 
cÚn
);

414 
»q
->
cÚn
 = conn;

415 
cÚn
->
»q
 =„eq;

417 ++
cÚn
->
u£c
;

422 
	`mem_d”ef
(
cÚn
);

425 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

426 ià(!
cÚn
)

427  
ENOMEM
;

429 
	`hash_­³nd
(
»q
->
şi
->
ht_cÚn
, 
	`§_hash
(
addr
, 
SA_ALL
), &
cÚn
->
he
, conn);

431 
cÚn
->
addr
 = *addr;

432 
cÚn
->
u£c
 = 1;

434 
”r
 = 
	`tı_cÚÃù
(&
cÚn
->
tc
, 
addr
, 
e¡ab_hªdËr
, 
»cv_hªdËr
,

435 
şo£_hªdËr
, 
cÚn
);

436 ià(
”r
)

437 
out
;

439 #ifdeà
USE_TLS


440 ià(
»q
->
£cu»
) {

442 
”r
 = 
	`s_¡¬t_tı
(&
cÚn
->
sc
, 
»q
->
şi
->
s
, cÚn->
tc
, 0);

443 ià(
”r
)

444 
out
;

448 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
CONN_TIMEOUT
, 
timeout_hªdËr
, conn);

450 
»q
->
cÚn
 = conn;

451 
cÚn
->
»q
 =„eq;

453 
out
:

454 ià(
”r
)

455 
	`mem_d”ef
(
cÚn
);

457  
”r
;

458 
	}
}

461 
	$»q_cÚÃù
(
h‰p_»q
 *
»q
)

463 
”r
 = 
EINVAL
;

465 
»q
->
¤vc
 > 0) {

467 --
»q
->
¤vc
;

469 
»q
->
mb
 = 
	`mem_d”ef
(req->mb);

471 
”r
 = 
	`cÚn_cÚÃù
(
»q
);

472 ià(!
”r
)

476  
”r
;

477 
	}
}

480 
boŞ
 
	$¼_hªdËr
(
dn¤r
 *
¼
, *
¬g
)

482 
h‰p_»q
 *
»q
 = 
¬g
;

484 ià(
»q
->
¤vc
 >ğ
	`ARRAY_SIZE
Ôeq->
¤vv
))

485  
Œue
;

487 
¼
->
ty³
) {

489 
DNS_TYPE_A
:

490 
	`§_£t_š
(&
»q
->
¤vv
[»q->
¤vc
++], 
¼
->
rd©a
.
a
.
addr
,

491 
»q
->
pÜt
);

494 
DNS_TYPE_AAAA
:

495 
	`§_£t_š6
(&
»q
->
¤vv
[»q->
¤vc
++], 
¼
->
rd©a
.
¯¯
.
addr
,

496 
»q
->
pÜt
);

500  
çl£
;

501 
	}
}

504 
	$qu”y_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

505 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

507 
h‰p_»q
 *
»q
 = 
¬g
;

508 ()
hdr
;

509 ()
authl
;

510 ()
addl
;

512 
	`dns_¼li¡_­¶y2
(
ª¦
, 
»q
->
ho¡
, 
DNS_TYPE_A
, 
DNS_TYPE_AAAA
,

513 
DNS_CLASS_IN
, 
Œue
, 
¼_hªdËr
, 
»q
);

514 ià(
»q
->
¤vc
 == 0) {

515 
”r
 =ƒ¼ ?ƒ¼ : 
EDESTADDRREQ
;

516 
ç
;

519 
”r
 = 
	`»q_cÚÃù
(
»q
);

520 ià(
”r
)

521 
ç
;

525 
ç
:

526 
	`»q_şo£
(
»q
, 
”r
, 
NULL
);

527 
	}
}

544 
	$h‰p_»que¡
(
h‰p_»q
 **
»qp
, 
h‰p_şi
 *
şi
, cÚ¡ *
m‘
,

545 cÚ¡ *
uri
, 
h‰p_»¥_h
 *
»¥h
, 
h‰p_d©a_h
 *
d©ah
,

546 *
¬g
, cÚ¡ *
fmt
, ...)

548 
¶
 
scheme
, 
ho¡
, 
pÜt
, 
·th
;

549 
h‰p_»q
 *
»q
;

550 
ušt16_t
 
deåÜt
;

551 
boŞ
 
£cu»
;

552 
va_li¡
 
­
;

553 
”r
;

555 ià(!
şi
 || !
m‘
 || !
uri
)

556  
EINVAL
;

558 ià(
	`»_»gex
(
uri
, 
	`¡¾’
(uri), "[a-z]+://[^:/]+[:]*[0-9]*[^]+",

559 &
scheme
, &
ho¡
, 
NULL
, &
pÜt
, &
·th
è|| scheme.
p
 !ğ
uri
)

560  
EINVAL
;

562 ià(!
	`¶_¡rÿ£cmp
(&
scheme
, "http") ||

563 !
	`¶_¡rÿ£cmp
(&
scheme
, "ws")) {

564 
£cu»
 = 
çl£
;

565 
deåÜt
 = 80;

567 #ifdeà
USE_TLS


568 ià(!
	`¶_¡rÿ£cmp
(&
scheme
, "https") ||

569 !
	`¶_¡rÿ£cmp
(&
scheme
, "wss")) {

570 
£cu»
 = 
Œue
;

571 
deåÜt
 = 443;

575  
ENOTSUP
;

577 
»q
 = 
	`mem_z®loc
((*»q), 
»q_de¡ruùÜ
);

578 ià(!
»q
)

579  
ENOMEM
;

581 
	`li¡_­³nd
(&
şi
->
»ql
, &
»q
->
Ë
,„eq);

583 
»q
->
şi
 = cli;

584 
»q
->
£cu»
 = secure;

585 
»q
->
pÜt
 = 
	`¶_is£t
(&pÜtè? 
	`¶_u32
(&pÜtè: 
deåÜt
;

586 
»q
->
»¥h
 =„esph;

587 
»q
->
d©ah
 = datah;

588 
»q
->
¬g
 =‡rg;

590 
”r
 = 
	`¶_¡rdup
(&
»q
->
ho¡
, &host);

591 ià(
”r
)

592 
out
;

594 
»q
->
mb»q
 = 
	`mbuf_®loc
(1024);

595 ià(!
»q
->
mb»q
) {

596 
”r
 = 
ENOMEM
;

597 
out
;

600 
”r
 = 
	`mbuf_´štf
(
»q
->
mb»q
,

603 
m‘
, &
·th
, &
ho¡
);

604 ià(
fmt
) {

605 
	`va_¡¬t
(
­
, 
fmt
);

606 
”r
 |ğ
	`mbuf_v´štf
(
»q
->
mb»q
, 
fmt
, 
­
);

607 
	`va_’d
(
­
);

610 
”r
 |ğ
	`mbuf_wr™e_¡r
(
»q
->
mb»q
, "\r\n");

612 ià(
”r
)

613 
out
;

615 
»q
->
mb»q
->
pos
 = 0;

617 ià(!
	`§_£t_¡r
(&
»q
->
¤vv
[0],„eq->
ho¡
,„eq->
pÜt
)) {

619 
»q
->
¤vc
 = 1;

621 
”r
 = 
	`»q_cÚÃù
(
»q
);

622 ià(
”r
)

623 
out
;

626 
”r
 = 
	`dnsc_qu”y
(&
»q
->
dq
, 
şi
->
dnsc
,„eq->
ho¡
,

627 
DNS_TYPE_A
, 
DNS_CLASS_IN
, 
Œue
,

628 
qu”y_hªdËr
, 
»q
);

629 ià(
”r
)

630 
out
;

633 
out
:

634 ià(
”r
)

635 
	`mem_d”ef
(
»q
);

636 ià(
»qp
) {

637 
»q
->
»qp
 =„eqp;

638 *
»qp
 = 
»q
;

641  
”r
;

642 
	}
}

651 
	$h‰p_»q_£t_cÚn_hªdËr
(
h‰p_»q
 *
»q
, 
h‰p_cÚn_h
 *
cÚnh
)

653 ià(!
»q
)

656 
»q
->
cÚnh
 = connh;

657 
	}
}

668 
	$h‰p_ş›Á_®loc
(
h‰p_şi
 **
ş
, 
dnsc
 *dnsc)

670 
h‰p_şi
 *
şi
;

671 
”r
;

673 ià(!
ş
 || !
dnsc
)

674  
EINVAL
;

676 
şi
 = 
	`mem_z®loc
((*şi), 
şi_de¡ruùÜ
);

677 ià(!
şi
)

678  
ENOMEM
;

680 
”r
 = 
	`hash_®loc
(&
şi
->
ht_cÚn
, 
CONN_BSIZE
);

681 ià(
”r
)

682 
out
;

684 #ifdeà
USE_TLS


685 
”r
 = 
	`s_®loc
(&
şi
->
s
, 
TLS_METHOD_SSLV23
, 
NULL
, NULL);

687 
”r
 = 0;

689 ià(
”r
)

690 
out
;

692 
şi
->
dnsc
 = 
	`mem_»f
(dnsc);

694 
out
:

695 ià(
”r
)

696 
	`mem_d”ef
(
şi
);

698 *
ş
 = 
şi
;

700  
”r
;

701 
	}
}

	@re-0.5.6/src/http/http.h

8 
	sh‰p_chunk
 {

9 
size_t
 
	msize
;

10 
	mlf
;

11 
boŞ
 
	mŒa”
;

12 
boŞ
 
	mdig™
;

13 
boŞ
 
	m·¿m
;

17 
h‰p_chunk_decode
(
h‰p_chunk
 *
chunk
, 
mbuf
 *
mb
, 
size_t
 *
size
);

	@re-0.5.6/src/http/msg.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_msg.h
>

14 
	~<»_h‰p.h
>

18 
	mSTARTLINE_MAX
 = 8192,

22 
	$hdr_de¡ruùÜ
(*
¬g
)

24 
h‰p_hdr
 *
hdr
 = 
¬g
;

26 
	`li¡_uÆšk
(&
hdr
->
Ë
);

27 
	}
}

30 
	$de¡ruùÜ
(*
¬g
)

32 
h‰p_msg
 *
msg
 = 
¬g
;

34 
	`li¡_æush
(&
msg
->
hd¾
);

35 
	`mem_d”ef
(
msg
->
_mb
);

36 
	`mem_d”ef
(
msg
->
mb
);

37 
	}
}

40 
h‰p_hdrid
 
	$hdr_hash
(cÚ¡ 
¶
 *
Çme
)

42 ià(!
Çme
->
l
)

43  
HTTP_HDR_NONE
;

45 
Çme
->
p
[0]) {

49 ià(
Çme
->
l
 > 1 &&‚ame->
p
[1] == '-')

50  
HTTP_HDR_NONE
;

55  (
h‰p_hdrid
)(
	`hash_jß©_ci
(
Çme
->
p
,‚ame->
l
) & 0xfff);

56 
	}
}

59 
šlše
 
boŞ
 
	$hdr_comma_£·¿‹d
(
h‰p_hdrid
 
id
)

61 
id
) {

63 
HTTP_HDR_ACCEPT
:

64 
HTTP_HDR_ACCEPT_CHARSET
:

65 
HTTP_HDR_ACCEPT_ENCODING
:

66 
HTTP_HDR_ACCEPT_LANGUAGE
:

67 
HTTP_HDR_ACCEPT_RANGES
:

68 
HTTP_HDR_ALLOW
:

69 
HTTP_HDR_CACHE_CONTROL
:

70 
HTTP_HDR_CONNECTION
:

71 
HTTP_HDR_CONTENT_ENCODING
:

72 
HTTP_HDR_CONTENT_LANGUAGE
:

73 
HTTP_HDR_EXPECT
:

74 
HTTP_HDR_IF_MATCH
:

75 
HTTP_HDR_IF_NONE_MATCH
:

76 
HTTP_HDR_PRAGMA
:

77 
HTTP_HDR_SEC_WEBSOCKET_EXTENSIONS
:

78 
HTTP_HDR_SEC_WEBSOCKET_PROTOCOL
:

79 
HTTP_HDR_SEC_WEBSOCKET_VERSION
:

80 
HTTP_HDR_TE
:

81 
HTTP_HDR_TRAILER
:

82 
HTTP_HDR_TRANSFER_ENCODING
:

83 
HTTP_HDR_UPGRADE
:

84 
HTTP_HDR_VARY
:

85 
HTTP_HDR_VIA
:

86 
HTTP_HDR_WARNING
:

87  
Œue
;

90  
çl£
;

92 
	}
}

95 
šlše
 
	$hdr_add
(
h‰p_msg
 *
msg
, cÚ¡ 
¶
 *
Çme
,

96 
h‰p_hdrid
 
id
, cÚ¡ *
p
, 
ssize_t
 
l
)

98 
h‰p_hdr
 *
hdr
;

99 
”r
 = 0;

101 
hdr
 = 
	`mem_z®loc
((*hdr), 
hdr_de¡ruùÜ
);

102 ià(!
hdr
)

103  
ENOMEM
;

105 
hdr
->
Çme
 = *name;

106 
hdr
->
v®
.
p
 =…;

107 
hdr
->
v®
.
l
 = 
	`MAX
(l, 0);

108 
hdr
->
id
 = id;

110 
	`li¡_­³nd
(&
msg
->
hd¾
, &
hdr
->
Ë
, hdr);

113 
id
) {

115 
HTTP_HDR_CONTENT_TYPE
:

116 
”r
 = 
	`msg_ùy³_decode
(&
msg
->
ùyp
, &
hdr
->
v®
);

119 
HTTP_HDR_CONTENT_LENGTH
:

120 
msg
->
ş’
 = 
	`¶_u32
(&
hdr
->
v®
);

127 ià(
”r
)

128 
	`mem_d”ef
(
hdr
);

130  
”r
;

131 
	}
}

143 
	$h‰p_msg_decode
(
h‰p_msg
 **
msgp
, 
mbuf
 *
mb
, 
boŞ
 
»q
)

145 
¶
 
b
, 
s
, 
e
, 
Çme
, 
scode
;

146 cÚ¡ *
p
, *
cv
;

147 
h‰p_msg
 *
msg
;

148 
boŞ
 
com£p
, 
quÙe
;

149 
h‰p_hdrid
 
id
 = 
HTTP_HDR_NONE
;

150 
ušt32_t
 
ws
, 
lf
;

151 
size_t
 
l
;

152 
”r
;

154 ià(!
msgp
 || !
mb
)

155  
EINVAL
;

157 
p
 = (cÚ¡ *)
	`mbuf_buf
(
mb
);

158 
l
 = 
	`mbuf_g‘_Ëá
(
mb
);

160 ià(
	`»_»gex
(
p
, 
l
, "[\r\n]*[^\r\n]+[\r]*[\n]1", &
b
, &
s
, 
NULL
, &
e
))

161  (
l
 > 
STARTLINE_MAX
è? 
EBADMSG
 : 
ENODATA
;

163 
msg
 = 
	`mem_z®loc
((*msg), 
de¡ruùÜ
);

164 ià(!
msg
)

165  
ENOMEM
;

167 
msg
->
_mb
 = 
	`mem_»f
(
mb
);

169 
msg
->
mb
 = 
	`mbuf_®loc
(8192);

170 ià(!
msg
->
mb
) {

171 
”r
 = 
ENOMEM
;

172 
out
;

175 ià(
»q
) {

176 ià(
	`»_»gex
(
s
.
p
, s.
l
, "[a-z]+ [^? ]+[^ ]* HTTP/[0-9.]+",

177 &
msg
->
m‘
, &msg->
·th
, &msg->
´m
, &msg->
v”
) ||

178 
msg
->
m‘
.
p
 !ğ
s
.p) {

179 
”r
 = 
EBADMSG
;

180 
out
;

184 ià(
	`»_»gex
(
s
.
p
, s.
l
, "HTTP/[0-9.]+ [0-9]+[ ]*[^]*",

185 &
msg
->
v”
, &
scode
, 
NULL
, &msg->
»asÚ
) ||

186 
msg
->
v”
.
p
 !ğ
s
.p + 5) {

187 
”r
 = 
EBADMSG
;

188 
out
;

191 
msg
->
scode
 = 
	`¶_u32
(&scode);

194 
l
 -ğ
e
.
p
 +ƒ.l -…;

195 
p
 = 
e
.°+ƒ.
l
;

197 
Çme
.
p
 = 
cv
 = 
NULL
;

198 
Çme
.
l
 = 
ws
 = 
lf
 = 0;

199 
com£p
 = 
çl£
;

200 
quÙe
 = 
çl£
;

202 ; 
l
 > 0; 
p
++,†--) {

204 *
p
) {

208 
lf
 = 0;

209 ++
ws
;

213 ++
ws
;

217 ++
ws
;

219 ià(!
Çme
.
p
) {

220 ++
p
; --
l
;

221 
”r
 = 0;

222 
out
;

225 ià(!
lf
++)

228 ++
p
; --
l
;

233 ià(
lf
 || (*
p
 =ğ',' && 
com£p
 && !
quÙe
)) {

235 ià(!
Çme
.
l
) {

236 
”r
 = 
EBADMSG
;

237 
out
;

240 
”r
 = 
	`hdr_add
(
msg
, &
Çme
, 
id
, 
cv
 ? cv : 
p
,

241 
cv
 ? 
p
 - cv - 
ws
 : 0);

242 ià(
”r
)

243 
out
;

245 ià(!
lf
) {

246 
cv
 = 
NULL
;

250 ià(
lf
 > 1) {

251 
”r
 = 0;

252 
out
;

255 
com£p
 = 
çl£
;

256 
Çme
.
p
 = 
NULL
;

257 
cv
 = 
NULL
;

258 
lf
 = 0;

261 ià(!
Çme
.
p
) {

262 
Çme
.
p
 =…;

263 
Çme
.
l
 = 0;

264 
ws
 = 0;

267 ià(!
Çme
.
l
) {

268 ià(*
p
 != ':') {

269 
ws
 = 0;

273 
Çme
.
l
 = 
	`MAX
(()(
p
 -‚ame.°- 
ws
), 0);

274 ià(!
Çme
.
l
) {

275 
”r
 = 
EBADMSG
;

276 
out
;

279 
id
 = 
	`hdr_hash
(&
Çme
);

280 
com£p
 = 
	`hdr_comma_£·¿‹d
(
id
);

284 ià(!
cv
) {

285 
quÙe
 = 
çl£
;

286 
cv
 = 
p
;

289 ià(*
p
 == '"')

290 
quÙe
 = !quote;

292 
ws
 = 0;

297 
”r
 = 
ENODATA
;

299 
out
:

300 ià(
”r
)

301 
	`mem_d”ef
(
msg
);

303 *
msgp
 = 
msg
;

304 
mb
->
pos
 = mb->
’d
 - 
l
;

307  
”r
;

308 
	}
}

319 cÚ¡ 
h‰p_hdr
 *
	$h‰p_msg_hdr
(cÚ¡ 
h‰p_msg
 *
msg
,

320 
h‰p_hdrid
 
id
)

322  
	`h‰p_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
NULL
, NULL);

323 
	}
}

337 cÚ¡ 
h‰p_hdr
 *
	$h‰p_msg_hdr_­¶y
(cÚ¡ 
h‰p_msg
 *
msg
,

338 
boŞ
 
fwd
, 
h‰p_hdrid
 
id
,

339 
h‰p_hdr_h
 *
h
, *
¬g
)

341 
Ë
 *le;

343 ià(!
msg
)

344  
NULL
;

346 
Ë
 = 
fwd
 ? 
msg
->
hd¾
.
h—d
 : msg->hd¾.

;

348 
Ë
) {

349 cÚ¡ 
h‰p_hdr
 *
hdr
 = 
Ë
->
d©a
;

351 
Ë
 = 
fwd
 ?†e->
Ãxt
 :†e->
´ev
;

353 ià(
hdr
->
id
 != id)

356 ià(!
h
 || 
	`h
(
hdr
, 
¬g
))

357  
hdr
;

360  
NULL
;

361 
	}
}

372 cÚ¡ 
h‰p_hdr
 *
	$h‰p_msg_xhdr
(cÚ¡ 
h‰p_msg
 *
msg
,

373 cÚ¡ *
Çme
)

375  
	`h‰p_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
NULL
, NULL);

376 
	}
}

390 cÚ¡ 
h‰p_hdr
 *
	$h‰p_msg_xhdr_­¶y
(cÚ¡ 
h‰p_msg
 *
msg
,

391 
boŞ
 
fwd
, cÚ¡ *
Çme
,

392 
h‰p_hdr_h
 *
h
, *
¬g
)

394 
Ë
 *le;

395 
¶
…l;

397 ià(!
msg
 || !
Çme
)

398  
NULL
;

400 
	`¶_£t_¡r
(&
¶
, 
Çme
);

402 
Ë
 = 
fwd
 ? 
msg
->
hd¾
.
h—d
 : msg->hd¾.

;

404 
Ë
) {

405 cÚ¡ 
h‰p_hdr
 *
hdr
 = 
Ë
->
d©a
;

407 
Ë
 = 
fwd
 ?†e->
Ãxt
 :†e->
´ev
;

409 ià(
	`¶_ÿ£cmp
(&
hdr
->
Çme
, &
¶
))

412 ià(!
h
 || 
	`h
(
hdr
, 
¬g
))

413  
hdr
;

416  
NULL
;

417 
	}
}

420 
boŞ
 
	$couÁ_hªdËr
(cÚ¡ 
h‰p_hdr
 *
hdr
, *
¬g
)

422 
ušt32_t
 *
n
 = 
¬g
;

423 ()
hdr
;

425 ++(*
n
);

427  
çl£
;

428 
	}
}

439 
ušt32_t
 
	$h‰p_msg_hdr_couÁ
(cÚ¡ 
h‰p_msg
 *
msg
, 
h‰p_hdrid
 
id
)

441 
ušt32_t
 
n
 = 0;

443 
	`h‰p_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
couÁ_hªdËr
, &
n
);

445  
n
;

446 
	}
}

457 
ušt32_t
 
	$h‰p_msg_xhdr_couÁ
(cÚ¡ 
h‰p_msg
 *
msg
, cÚ¡ *
Çme
)

459 
ušt32_t
 
n
 = 0;

461 
	`h‰p_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
couÁ_hªdËr
, &
n
);

463  
n
;

464 
	}
}

467 
boŞ
 
	$v®ue_hªdËr
(cÚ¡ 
h‰p_hdr
 *
hdr
, *
¬g
)

469  0 =ğ
	`¶_¡rÿ£cmp
(&
hdr
->
v®
, (cÚ¡ *)
¬g
);

470 
	}
}

482 
boŞ
 
	$h‰p_msg_hdr_has_v®ue
(cÚ¡ 
h‰p_msg
 *
msg
, 
h‰p_hdrid
 
id
,

483 cÚ¡ *
v®ue
)

485  
NULL
 !ğ
	`h‰p_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
v®ue_hªdËr
,

486 (*)
v®ue
);

487 
	}
}

499 
boŞ
 
	$h‰p_msg_xhdr_has_v®ue
(cÚ¡ 
h‰p_msg
 *
msg
, cÚ¡ *
Çme
,

500 cÚ¡ *
v®ue
)

502  
NULL
 !ğ
	`h‰p_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
v®ue_hªdËr
,

503 (*)
v®ue
);

504 
	}
}

515 
	$h‰p_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
h‰p_msg
 *
msg
)

517 
Ë
 *le;

518 
”r
;

520 ià(!
msg
)

523 ià(
	`¶_is£t
(&
msg
->
m‘
))

524 
”r
 = 
	`»_h´štf
(
pf
, "%¸%r%¸HTTP/%r\n", &
msg
->
m‘
,

525 &
msg
->
·th
, &msg->
´m
, &msg->
v”
);

527 
”r
 = 
	`»_h´štf
(
pf
, "HTTP/%¸%u %r\n", &
msg
->
v”
, msg->
scode
,

528 &
msg
->
»asÚ
);

530 
Ë
=
msg
->
hd¾
.
h—d
;†e;†eöe->
Ãxt
) {

532 cÚ¡ 
h‰p_hdr
 *
hdr
 = 
Ë
->
d©a
;

534 
”r
 |ğ
	`»_h´štf
(
pf
, "%r: %¸(%i)\n", &
hdr
->
Çme
, &hdr->
v®
,

535 
hdr
->
id
);

538  
”r
;

539 
	}
}

	@re-0.5.6/src/http/server.c

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_fmt.h
>

13 
	~<»_tmr.h
>

14 
	~<»_¤.h
>

15 
	~<»_tı.h
>

16 
	~<»_s.h
>

17 
	~<»_msg.h
>

18 
	~<»_h‰p.h
>

22 
	mTIMEOUT_IDLE
 = 600000,

23 
	mTIMEOUT_INIT
 = 10000,

24 
	mBUFSIZE_MAX
 = 524288,

27 
	sh‰p_sock
 {

28 
li¡
 
	mcÚÆ
;

29 
tı_sock
 *
	mts
;

30 
s
 *
	ms
;

31 
h‰p_»q_h
 *
	m»qh
;

32 *
	m¬g
;

35 
	sh‰p_cÚn
 {

36 
Ë
 
	mË
;

37 
tmr
 
	mtmr
;

38 
§
 
	m³”
;

39 
h‰p_sock
 *
	msock
;

40 
tı_cÚn
 *
	mtc
;

41 
s_cÚn
 *
	msc
;

42 
mbuf
 *
	mmb
;

46 
cÚn_şo£
(
h‰p_cÚn
 *
cÚn
);

49 
	$sock_de¡ruùÜ
(*
¬g
)

51 
h‰p_sock
 *
sock
 = 
¬g
;

52 
Ë
 *le;

54 
Ë
=
sock
->
cÚÆ
.
h—d
;†e;) {

56 
h‰p_cÚn
 *
cÚn
 = 
Ë
->
d©a
;

58 
Ë
 =†e->
Ãxt
;

60 
	`cÚn_şo£
(
cÚn
);

61 
	`mem_d”ef
(
cÚn
);

64 
	`mem_d”ef
(
sock
->
s
);

65 
	`mem_d”ef
(
sock
->
ts
);

66 
	}
}

69 
	$cÚn_de¡ruùÜ
(*
¬g
)

71 
h‰p_cÚn
 *
cÚn
 = 
¬g
;

73 
	`li¡_uÆšk
(&
cÚn
->
Ë
);

74 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

75 
	`mem_d”ef
(
cÚn
->
sc
);

76 
	`mem_d”ef
(
cÚn
->
tc
);

77 
	`mem_d”ef
(
cÚn
->
mb
);

78 
	}
}

81 
	$cÚn_şo£
(
h‰p_cÚn
 *
cÚn
)

83 
	`li¡_uÆšk
(&
cÚn
->
Ë
);

84 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

85 
cÚn
->
sc
 = 
	`mem_d”ef
(conn->sc);

86 
cÚn
->
tc
 = 
	`mem_d”ef
(conn->tc);

87 
cÚn
->
sock
 = 
NULL
;

88 
	}
}

91 
	$timeout_hªdËr
(*
¬g
)

93 
h‰p_cÚn
 *
cÚn
 = 
¬g
;

95 
	`cÚn_şo£
(
cÚn
);

96 
	`mem_d”ef
(
cÚn
);

97 
	}
}

100 
	$»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

102 
h‰p_cÚn
 *
cÚn
 = 
¬g
;

103 
”r
 = 0;

105 ià(
cÚn
->
mb
) {

107 cÚ¡ 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
), 
pos
 = 
cÚn
->mb->pos;

109 ià((
	`mbuf_g‘_Ëá
(
cÚn
->
mb
è+ 
Ën
è> 
BUFSIZE_MAX
) {

110 
”r
 = 
EOVERFLOW
;

111 
out
;

114 
cÚn
->
mb
->
pos
 = cÚn->mb->
’d
;

116 
”r
 = 
	`mbuf_wr™e_mem
(
cÚn
->
mb
, 
	`mbuf_buf
(mb), 
Ën
);

117 ià(
”r
)

118 
out
;

120 
cÚn
->
mb
->
pos
 =…os;

123 
cÚn
->
mb
 = 
	`mem_»f
(mb);

126 
cÚn
->
mb
) {

127 
size_t
 
’d
, 
pos
 = 
cÚn
->
mb
->pos;

128 
h‰p_msg
 *
msg
;

130 
”r
 = 
	`h‰p_msg_decode
(&
msg
, 
cÚn
->
mb
, 
Œue
);

131 ià(
”r
) {

132 ià(
”r
 =ğ
ENODATA
) {

133 
cÚn
->
mb
->
pos
 =…os;

134 
”r
 = 0;

138 
out
;

141 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
è< 
msg
->
ş’
) {

142 
cÚn
->
mb
->
pos
 =…os;

143 
	`mem_d”ef
(
msg
);

147 
	`mem_d”ef
(
msg
->
mb
);

148 
msg
->
mb
 = 
	`mem_»f
(msg->
_mb
);

150 
mb
 = 
cÚn
->mb;

152 
’d
 = 
mb
->end;

153 
mb
->
’d
 = mb->
pos
 + 
msg
->
ş’
;

155 ià(
’d
 > 
mb
->end) {

156 
mbuf
 *
mbn
 = 
	`mbuf_®loc
(
’d
 - 
mb
->end);

157 ià(!
mbn
) {

158 
	`mem_d”ef
(
msg
);

159 
”r
 = 
ENOMEM
;

160 
out
;

163 ()
	`mbuf_wr™e_mem
(
mbn
, 
mb
->
buf
 + mb->
’d
,

164 
’d
 - 
mb
->end);

165 
mbn
->
pos
 = 0;

167 
	`mem_d”ef
(
cÚn
->
mb
);

168 
cÚn
->
mb
 = 
mbn
;

171 
cÚn
->
mb
 = 
	`mem_d”ef
(conn->mb);

174 ià(
cÚn
->
sock
)

175 
cÚn
->
sock
->
	`»qh
(cÚn, 
msg
, cÚn->sock->
¬g
);

177 
	`mem_d”ef
(
msg
);

179 ià(!
cÚn
->
tc
) {

180 
”r
 = 
ENOTCONN
;

181 
out
;

184 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TIMEOUT_IDLE
, 
timeout_hªdËr
, conn);

187 
out
:

188 ià(
”r
) {

189 
	`cÚn_şo£
(
cÚn
);

190 
	`mem_d”ef
(
cÚn
);

192 
	}
}

195 
	$şo£_hªdËr
(
”r
, *
¬g
)

197 
h‰p_cÚn
 *
cÚn
 = 
¬g
;

198 ()
”r
;

200 
	`cÚn_şo£
(
cÚn
);

201 
	`mem_d”ef
(
cÚn
);

202 
	}
}

205 
	$cÚÃù_hªdËr
(cÚ¡ 
§
 *
³”
, *
¬g
)

207 
h‰p_sock
 *
sock
 = 
¬g
;

208 
h‰p_cÚn
 *
cÚn
;

209 
”r
;

211 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

212 ià(!
cÚn
) {

213 
”r
 = 
ENOMEM
;

214 
out
;

217 
	`li¡_­³nd
(&
sock
->
cÚÆ
, &
cÚn
->
Ë
, conn);

218 
cÚn
->
³”
 = *peer;

219 
cÚn
->
sock
 = sock;

221 
”r
 = 
	`tı_acû±
(&
cÚn
->
tc
, 
sock
->
ts
, 
NULL
, 
»cv_hªdËr
,

222 
şo£_hªdËr
, 
cÚn
);

223 ià(
”r
)

224 
out
;

226 #ifdeà
USE_TLS


227 ià(
sock
->
s
) {

228 
”r
 = 
	`s_¡¬t_tı
(&
cÚn
->
sc
, 
sock
->
s
, cÚn->
tc
, 0);

229 ià(
”r
)

230 
out
;

234 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TIMEOUT_INIT
, 
timeout_hªdËr
, conn);

236 
out
:

237 ià(
”r
) {

238 
	`mem_d”ef
(
cÚn
);

239 
	`tı_»jeù
(
sock
->
ts
);

241 
	}
}

254 
	$h‰p_li¡’
(
h‰p_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

255 
h‰p_»q_h
 *
»qh
, *
¬g
)

257 
h‰p_sock
 *
sock
;

258 
”r
;

260 ià(!
sockp
 || !
Ïddr
 || !
»qh
)

261  
EINVAL
;

263 
sock
 = 
	`mem_z®loc
((*sock), 
sock_de¡ruùÜ
);

264 ià(!
sock
)

265  
ENOMEM
;

267 
”r
 = 
	`tı_li¡’
(&
sock
->
ts
, 
Ïddr
, 
cÚÃù_hªdËr
, sock);

268 ià(
”r
)

269 
out
;

271 
sock
->
»qh
 =„eqh;

272 
sock
->
¬g
 =‡rg;

274 
out
:

275 ià(
”r
)

276 
	`mem_d”ef
(
sock
);

278 *
sockp
 = 
sock
;

280  
”r
;

281 
	}
}

295 
	$h‰ps_li¡’
(
h‰p_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

296 cÚ¡ *
û¹
, 
h‰p_»q_h
 *
»qh
, *
¬g
)

298 
h‰p_sock
 *
sock
;

299 
”r
;

301 ià(!
sockp
 || !
Ïddr
 || !
û¹
 || !
»qh
)

302  
EINVAL
;

304 
”r
 = 
	`h‰p_li¡’
(&
sock
, 
Ïddr
, 
»qh
, 
¬g
);

305 ià(
”r
)

306  
”r
;

308 #ifdeà
USE_TLS


309 
”r
 = 
	`s_®loc
(&
sock
->
s
, 
TLS_METHOD_SSLV23
, 
û¹
, 
NULL
);

311 
”r
 = 
EPROTONOSUPPORT
;

313 ià(
”r
)

314 
out
;

316 
out
:

317 ià(
”r
)

318 
	`mem_d”ef
(
sock
);

320 *
sockp
 = 
sock
;

322  
”r
;

323 
	}
}

333 
tı_sock
 *
	$h‰p_sock_tı
(
h‰p_sock
 *
sock
)

335  
sock
 ? sock->
ts
 : 
NULL
;

336 
	}
}

346 cÚ¡ 
§
 *
	$h‰p_cÚn_³”
(cÚ¡ 
h‰p_cÚn
 *
cÚn
)

348  
cÚn
 ? &cÚn->
³”
 : 
NULL
;

349 
	}
}

359 
tı_cÚn
 *
	$h‰p_cÚn_tı
(
h‰p_cÚn
 *
cÚn
)

361  
cÚn
 ? cÚn->
tc
 : 
NULL
;

362 
	}
}

372 
s_cÚn
 *
	$h‰p_cÚn_s
(
h‰p_cÚn
 *
cÚn
)

374  
cÚn
 ? cÚn->
sc
 : 
NULL
;

375 
	}
}

383 
	$h‰p_cÚn_şo£
(
h‰p_cÚn
 *
cÚn
)

385 ià(!
cÚn
)

388 
cÚn
->
sc
 = 
	`mem_d”ef
(conn->sc);

389 
cÚn
->
tc
 = 
	`mem_d”ef
(conn->tc);

390 
	}
}

393 
	$h‰p_v»¶y
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
,

394 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

396 
mbuf
 *
mb
;

397 
”r
;

399 ià(!
cÚn
 || !
scode
 || !
»asÚ
)

400  
EINVAL
;

402 ià(!
cÚn
->
tc
)

403  
ENOTCONN
;

405 
mb
 = 
	`mbuf_®loc
(8192);

406 ià(!
mb
)

407  
ENOMEM
;

409 
”r
 = 
	`mbuf_´štf
(
mb
, "HTTP/1.1 %u %s\r\n", 
scode
, 
»asÚ
);

410 ià(
fmt
)

411 
”r
 |ğ
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

413 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "Content-Length: 0\r\n\r\n");

414 ià(
”r
)

415 
out
;

417 
mb
->
pos
 = 0;

419 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
mb
);

420 ià(
”r
)

421 
out
;

423 
out
:

424 
	`mem_d”ef
(
mb
);

426  
”r
;

427 
	}
}

440 
	$h‰p_»¶y
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

441 cÚ¡ *
fmt
, ...)

443 
va_li¡
 
­
;

444 
”r
;

446 
	`va_¡¬t
(
­
, 
fmt
);

447 
”r
 = 
	`h‰p_v»¶y
(
cÚn
, 
scode
, 
»asÚ
, 
fmt
, 
­
);

448 
	`va_’d
(
­
);

450  
”r
;

451 
	}
}

465 
	$h‰p_ü•ly
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

466 cÚ¡ *
ùy³
, cÚ¡ *
fmt
, ...)

468 
mbuf
 *
mb
;

469 
va_li¡
 
­
;

470 
”r
;

472 ià(!
ùy³
 || !
fmt
)

473  
EINVAL
;

475 
mb
 = 
	`mbuf_®loc
(8192);

476 ià(!
mb
)

477  
ENOMEM
;

479 
	`va_¡¬t
(
­
, 
fmt
);

480 
”r
 = 
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

481 
	`va_’d
(
­
);

482 ià(
”r
)

483 
out
;

485 
”r
 = 
	`h‰p_»¶y
(
cÚn
, 
scode
, 
»asÚ
,

490 
ùy³
,

491 
mb
->
’d
,

492 
mb
->
buf
, mb->
’d
);

493 ià(
”r
)

494 
out
;

496 
out
:

497 
	`mem_d”ef
(
mb
);

499  
”r
;

500 
	}
}

512 
	$h‰p_”•ly
(
h‰p_cÚn
 *
cÚn
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

514  
	`h‰p_ü•ly
(
cÚn
, 
scode
, 
»asÚ
, "text/html",

520 
scode
, 
»asÚ
,

521 
scode
, 
»asÚ
);

522 
	}
}

	@re-0.5.6/src/httpauth/basic.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_md5.h
>

9 
	~<»_fmt.h
>

10 
	~<»_h‰·uth.h
>

	@re-0.5.6/src/httpauth/digest.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_md5.h
>

11 
	~<»_sys.h
>

12 
	~<»_h‰·uth.h
>

15 (
	tdige¡_decode_h
)(cÚ¡ 
	t¶
 *
	tÇme
, cÚ¡ ¶ *
	tv®
,

16 *
	t¬g
);

19 cÚ¡ 
¶
 
·¿m_®gÜ™hm
 = 
	`PL
("algorithm");

20 cÚ¡ 
¶
 
·¿m_úÚû
 = 
	`PL
("cnonce");

21 cÚ¡ 
¶
 
·¿m_nc
 = 
	`PL
("nc");

22 cÚ¡ 
¶
 
·¿m_nÚû
 = 
	`PL
("nonce");

23 cÚ¡ 
¶
 
·¿m_İaque
 = 
	`PL
("opaque");

24 cÚ¡ 
¶
 
·¿m_qİ
 = 
	`PL
("qop");

25 cÚ¡ 
¶
 
·¿m_»®m
 = 
	`PL
("realm");

26 cÚ¡ 
¶
 
·¿m_»¥Ú£
 = 
	`PL
("response");

27 cÚ¡ 
¶
 
·¿m_uri
 = 
	`PL
("uri");

28 cÚ¡ 
¶
 
·¿m_u£ºame
 = 
	`PL
("username");

29 cÚ¡ 
¶
 
·¿m_¡®e
 = 
	`PL
("stale");

32 
	$ch®Ënge_decode
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

33 *
¬g
)

35 
h‰·uth_dige¡_ch®l
 *
ch®l
 = 
¬g
;

37 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_»®m
))

38 
ch®l
->
»®m
 = *
v®
;

39 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_nÚû
))

40 
ch®l
->
nÚû
 = *
v®
;

41 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_İaque
))

42 
ch®l
->
İaque
ğ*
v®
;

43 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_¡®e
))

44 
ch®l
->
¡®e
 = *
v®
;

45 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_®gÜ™hm
))

46 
ch®l
->
®gÜ™hm
 = *
v®
;

47 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_qİ
))

48 
ch®l
->
qİ
 = *
v®
;

49 
	}
}

52 
	$»¥Ú£_decode
(cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
v®
,

53 *
¬g
)

55 
h‰·uth_dige¡_»¥
 *
»¥
 = 
¬g
;

57 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_»®m
))

58 
»¥
->
»®m
 = *
v®
;

59 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_nÚû
))

60 
»¥
->
nÚû
 = *
v®
;

61 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_»¥Ú£
))

62 
»¥
->
»¥Ú£
 = *
v®
;

63 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_u£ºame
))

64 
»¥
->
u£ºame
 = *
v®
;

65 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_uri
))

66 
»¥
->
uri
 = *
v®
;

67 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_nc
))

68 
»¥
->
nc
 = *
v®
;

69 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_úÚû
))

70 
»¥
->
úÚû
 = *
v®
;

71 ià(!
	`¶_ÿ£cmp
(
Çme
, &
·¿m_qİ
))

72 
»¥
->
qİ
 = *
v®
;

73 
	}
}

76 
	$dige¡_decode
(cÚ¡ 
¶
 *
hv®
, 
dige¡_decode_h
 *
dech
,

77 *
¬g
)

79 
¶
 
r
 = *
hv®
, 
¡¬t
, 
’d
, 
Çme
, 
v®
;

81 ià(
	`»_»gex
(
r
.
p
,„.
l
, "[ \t\r\n]*Dige¡[ \t\r\n]+", &
¡¬t
, &
’d
) ||

82 
¡¬t
.
p
 !ğ
r
.p)

83  
EBADMSG
;

85 
	`¶_advªû
(&
r
, 
’d
.
p
 -„.p);

87 !
	`»_»gex
(
r
.
p
,„.
l
,

89 
NULL
, &
Çme
, NULL, NULL, &
v®
)) {

91 
	`¶_advªû
(&
r
, 
v®
.
p
 + v®.
l
 -„.p);

93 
	`dech
(&
Çme
, &
v®
, 
¬g
);

97 
	}
}

108 
	$h‰·uth_dige¡_ch®Ënge_decode
(
h‰·uth_dige¡_ch®l
 *
ch®l
,

109 cÚ¡ 
¶
 *
hv®
)

111 
”r
;

113 ià(!
ch®l
 || !
hv®
)

114  
EINVAL
;

116 
	`mem£t
(
ch®l
, 0, (*chall));

118 
”r
 = 
	`dige¡_decode
(
hv®
, 
ch®Ënge_decode
, 
ch®l
);

119 ià(
”r
)

120  
”r
;

122 ià(!
ch®l
->
»®m
.
p
 || !ch®l->
nÚû
.p)

123  
EBADMSG
;

126 
	}
}

137 
	$h‰·uth_dige¡_»¥Ú£_decode
(
h‰·uth_dige¡_»¥
 *
»¥
,

138 cÚ¡ 
¶
 *
hv®
)

140 
”r
;

142 ià(!
»¥
 || !
hv®
)

143  
EINVAL
;

145 
	`mem£t
(
»¥
, 0, (*resp));

147 
”r
 = 
	`dige¡_decode
(
hv®
, 
»¥Ú£_decode
, 
»¥
);

148 ià(
”r
)

149  
”r
;

151 ià(!
»¥
->
»®m
.
p
 ||

152 !
»¥
->
nÚû
.
p
 ||

153 !
»¥
->
»¥Ú£
.
p
 ||

154 !
»¥
->
u£ºame
.
p
 ||

155 !
»¥
->
uri
.
p
)

156  
EBADMSG
;

159 
	}
}

171 
	$h‰·uth_dige¡_»¥Ú£_auth
(cÚ¡ 
h‰·uth_dige¡_»¥
 *
»¥
,

172 cÚ¡ 
¶
 *
m‘hod
, cÚ¡ 
ušt8_t
 *
ha1
)

174 
ušt8_t
 
ha2
[
MD5_SIZE
], 
dige¡
[MD5_SIZE], 
»¥Ú£
[MD5_SIZE];

175 cÚ¡ *
p
;

176 
ušt32_t
 
i
;

177 
”r
;

179 ià(!
»¥
 || !
m‘hod
 || !
ha1
)

180  
EINVAL
;

182 ià(
»¥
->
»¥Ú£
.
l
 != 32)

183  
EAUTH
;

185 
”r
 = 
	`md5_´štf
(
ha2
, "%r:%r", 
m‘hod
, &
»¥
->
uri
);

186 ià(
”r
)

187  
”r
;

189 ià(
	`¶_is£t
(&
»¥
->
qİ
))

190 
”r
 = 
	`md5_´štf
(
dige¡
, "%w:%r:%r:%r:%r:%w",

191 
ha1
, (
size_t
)
MD5_SIZE
,

192 &
»¥
->
nÚû
,

193 &
»¥
->
nc
,

194 &
»¥
->
úÚû
,

195 &
»¥
->
qİ
,

196 
ha2
, (ha2));

198 
”r
 = 
	`md5_´štf
(
dige¡
, "%w:%r:%w",

199 
ha1
, (
size_t
)
MD5_SIZE
,

200 &
»¥
->
nÚû
,

201 
ha2
, (ha2));

202 ià(
”r
)

203  
”r
;

205 
i
=0, 
p
=
»¥
->
»¥Ú£
.p; i<(response); i++) {

206 
»¥Ú£
[
i
] = 
	`ch_hex
(*
p
++) << 4;

207 
»¥Ú£
[
i
] +ğ
	`ch_hex
(*
p
++);

210 ià(
	`memcmp
(
dige¡
, 
»¥Ú£
, 
MD5_SIZE
))

211  
EAUTH
;

214 
	}
}

	@re-0.5.6/src/ice/cand.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_§.h
>

14 
	~<»_sys.h
>

15 
	~<»_¡un.h
>

16 
	~<»_tuº.h
>

17 
	~<»_iû.h
>

18 
	~"iû.h
"

21 
	#DEBUG_MODULE
 "iûÿnd"

	)

22 
	#DEBUG_LEVEL
 5

	)

23 
	~<»_dbg.h
>

26 
	$ÿnd_de¡ruùÜ
(*
¬g
)

28 
iû_ÿnd
 *
ÿnd
 = 
¬g
;

30 
	`li¡_uÆšk
(&
ÿnd
->
Ë
);

31 
	`mem_d”ef
(
ÿnd
->
found©iÚ
);

32 
	`mem_d”ef
(
ÿnd
->
iâame
);

34 ià(
ÿnd
 !ğÿnd->
ba£
)

35 
	`mem_d”ef
(
ÿnd
->
ba£
);

36 
	}
}

40 
	$compu‹_found©iÚ
(
iû_ÿnd
 *
ÿnd
)

42 
ušt32_t
 
v
;

44 
v
 = 
	`§_hash
(&
ÿnd
->
addr
, 
SA_ADDR
);

45 
v
 ^ğ
ÿnd
->
ty³
;

47  
	`»_sd´štf
(&
ÿnd
->
found©iÚ
, "%08x", 
v
);

48 
	}
}

51 
	$ÿnd_®loc
(
iû_ÿnd
 **
ÿndp
, 
iûm
 *icem,

52 
iû_ÿnd_ty³
 
ty³
, 
compid
,

53 
ušt32_t
 
´io
, cÚ¡ *
iâame
,

54 
iû_Œª¥
 
Œª¥
, cÚ¡ 
§
 *
addr
)

56 
iû_ÿnd
 *
ÿnd
;

57 
”r
;

59 ià(!
iûm
)

60  
EINVAL
;

62 
ÿnd
 = 
	`mem_z®loc
((*ÿnd), 
ÿnd_de¡ruùÜ
);

63 ià(!
ÿnd
)

64  
ENOMEM
;

66 
	`li¡_­³nd
(&
iûm
->
lÿndl
, &
ÿnd
->
Ë
, cand);

68 
ÿnd
->
ty³
 =ype;

69 
ÿnd
->
compid
 = compid;

70 
ÿnd
->
´io
 =…rio;

71 
ÿnd
->
Œª¥
 =ransp;

73 
	`§_ıy
(&
ÿnd
->
addr
,‡ddr);

75 
”r
 = 
	`compu‹_found©iÚ
(
ÿnd
);

77 ià(
iâame
)

78 
”r
 |ğ
	`¡r_dup
(&
ÿnd
->
iâame
, ifname);

80 ià(
”r
)

81 
	`mem_d”ef
(
ÿnd
);

82 ià(
ÿndp
)

83 *
ÿndp
 = 
ÿnd
;

85  
”r
;

86 
	}
}

89 
	$iûm_lÿnd_add_ba£
(
iûm
 *iûm, 
compid
, 
ušt16_t
 
Írio
,

90 cÚ¡ *
iâame
, 
iû_Œª¥
 
Œª¥
,

91 cÚ¡ 
§
 *
addr
)

93 
iûm_comp
 *
comp
;

94 
iû_ÿnd
 *
ÿnd
;

95 
”r
;

97 
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

98 ià(!
comp
)

99  
ENOENT
;

101 
”r
 = 
	`ÿnd_®loc
(&
ÿnd
, 
iûm
, 
ICE_CAND_TYPE_HOST
, 
compid
,

102 
	`iû_ÿnd_ÿlc_´io
(
ICE_CAND_TYPE_HOST
, 
Írio
, 
compid
),

103 
iâame
, 
Œª¥
, 
addr
);

104 ià(
”r
)

105  
”r
;

108 
ÿnd
->
ba£
 = cand;

110 
	`§_£t_pÜt
(&
ÿnd
->
addr
, 
comp
->
ÍÜt
);

113 
	}
}

116 
	$iûm_lÿnd_add
(
iûm
 *iûm, 
iû_ÿnd
 *
ba£
,

117 
iû_ÿnd_ty³
 
ty³
,

118 cÚ¡ 
§
 *
addr
)

120 
iû_ÿnd
 *
ÿnd
;

121 
”r
;

123 ià(!
ba£
)

124  
EINVAL
;

126 
”r
 = 
	`ÿnd_®loc
(&
ÿnd
, 
iûm
, 
ty³
, 
ba£
->
compid
,

127 
	`iû_ÿnd_ÿlc_´io
(
ty³
, 0, 
ba£
->
compid
),

128 
ba£
->
iâame
, ba£->
Œª¥
, 
addr
);

129 ià(
”r
)

130  
”r
;

132 
ÿnd
->
ba£
 = 
	`mem_»f
(base);

133 
	`§_ıy
(&
ÿnd
->
»l
, &
ba£
->
addr
);

136 
	}
}

139 
	$iûm_rÿnd_add
(
iûm
 *iûm, 
iû_ÿnd_ty³
 
ty³
, 
compid
,

140 
ušt32_t
 
´io
, cÚ¡ 
§
 *
addr
,

141 cÚ¡ 
§
 *
»l_addr
, cÚ¡ 
¶
 *
found©iÚ
)

143 
iû_ÿnd
 *
rÿnd
;

144 
”r
;

146 ià(!
iûm
 || !
found©iÚ
)

147  
EINVAL
;

149 
rÿnd
 = 
	`mem_z®loc
((*rÿnd), 
ÿnd_de¡ruùÜ
);

150 ià(!
rÿnd
)

151  
ENOMEM
;

153 
	`li¡_­³nd
(&
iûm
->
rÿndl
, &
rÿnd
->
Ë
,„cand);

155 
rÿnd
->
ty³
 =ype;

156 
rÿnd
->
compid
 = compid;

157 
rÿnd
->
´io
 =…rio;

159 
	`§_ıy
(&
rÿnd
->
addr
,‡ddr);

160 
	`§_ıy
(&
rÿnd
->
»l
, 
»l_addr
);

162 
”r
 = 
	`¶_¡rdup
(&
rÿnd
->
found©iÚ
, foundation);

164 ià(
”r
)

165 
	`mem_d”ef
(
rÿnd
);

167  
”r
;

168 
	}
}

171 
	$iûm_rÿnd_add_´æx
(
iû_ÿnd
 **
rı
, 
iûm
 *icem,

172 
compid
, 
ušt32_t
 
´io
,

173 cÚ¡ 
§
 *
addr
)

175 
iû_ÿnd
 *
rÿnd
;

176 
”r
;

178 ià(!
iûm
 || !
addr
)

179  
EINVAL
;

181 
rÿnd
 = 
	`mem_z®loc
((*rÿnd), 
ÿnd_de¡ruùÜ
);

182 ià(!
rÿnd
)

183  
ENOMEM
;

185 
	`li¡_­³nd
(&
iûm
->
rÿndl
, &
rÿnd
->
Ë
,„cand);

187 
rÿnd
->
ty³
 = 
ICE_CAND_TYPE_PRFLX
;

188 
rÿnd
->
compid
 = compid;

189 
rÿnd
->
´io
 =…rio;

190 
rÿnd
->
addr
 = *addr;

192 
”r
 = 
	`»_sd´štf
(&
rÿnd
->
found©iÚ
, "%08x", 
	`¿nd_u32
());

193 ià(
”r
)

194 
out
;

196 
	`iûcomp_´štf
(
	`iûm_comp_fšd
(
iûm
, 
compid
),

198 " w™h…riÜ™y %u (%J)\n", 
´io
, 
addr
);

200 
out
:

201 ià(
”r
)

202 
	`mem_d”ef
(
rÿnd
);

203 ià(
rı
)

204 *
rı
 = 
rÿnd
;

206  
”r
;

207 
	}
}

210 
iû_ÿnd
 *
	$iûm_ÿnd_fšd
(cÚ¡ 
li¡
 *
l¡
, 
compid
,

211 cÚ¡ 
§
 *
addr
)

213 
Ë
 *le;

215 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

217 
iû_ÿnd
 *
ÿnd
 = 
Ë
->
d©a
;

219 ià(
compid
 && 
ÿnd
->compid != compid)

222 ià(
addr
 && !
	`§_cmp
(&
ÿnd
->addr,‡ddr, 
SA_ALL
))

225  
ÿnd
;

228  
NULL
;

229 
	}
}

235 
iû_ÿnd
 *
	$iûm_lÿnd_fšd_checkli¡
(cÚ¡ 
iûm
 *icem,

236 
compid
)

238 
Ë
 *le;

240 
Ë
 = 
iûm
->
checkl
.
h—d
;†e;†ğË->
Ãxt
) {

241 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

243 ià(
ı
->
lÿnd
->
compid
 != compid)

246 
ı
->
lÿnd
->
ty³
) {

248 
ICE_CAND_TYPE_HOST
:

249 
ICE_CAND_TYPE_RELAY
:

250  
ı
->
lÿnd
;

257  
NULL
;

258 
	}
}

261 
iû_ÿnd
 *
	$iûm_lÿnd_ba£
(
iû_ÿnd
 *
lÿnd
)

263  
lÿnd
 ?†ÿnd->
ba£
 : 
NULL
;

264 
	}
}

267 cÚ¡ 
§
 *
	$iûm_lÿnd_addr
(cÚ¡ 
iû_ÿnd
 *
ÿnd
)

269  
ÿnd
 ? &ÿnd->
addr
 : 
NULL
;

270 
	}
}

273 
	$iûm_ÿnds_debug
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *
l¡
)

275 
Ë
 *le;

276 
”r
;

278 
”r
 = 
	`»_h´štf
(
pf
, " (%u)\n", 
	`li¡_couÁ
(
l¡
));

280 
Ë
 = 
	`li¡_h—d
(
l¡
);†&& !
”r
;†ğË->
Ãxt
) {

282 cÚ¡ 
iû_ÿnd
 *
ÿnd
 = 
Ë
->
d©a
;

284 
”r
 |ğ
	`»_h´štf
(
pf
, " {%u} fnd=%-2s…rio=%08x %24H",

285 
ÿnd
->
compid
, cªd->
found©iÚ
, cªd->
´io
,

286 
iûm_ÿnd_´št
, 
ÿnd
);

288 ià(
	`§_is£t
(&
ÿnd
->
»l
, 
SA_ADDR
))

289 
”r
 |ğ
	`»_h´štf
(
pf
, " (»l-addr=%J)", &
ÿnd
->
»l
);

291 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

294  
”r
;

295 
	}
}

298 
	$iûm_ÿnd_´št
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd
 *
ÿnd
)

300 
”r
 = 0;

302 ià(!
ÿnd
)

305 ià(
ÿnd
->
iâame
)

306 
”r
 |ğ
	`»_h´štf
(
pf
, "%s:", 
ÿnd
->
iâame
);

308 
”r
 |ğ
	`»_h´štf
(
pf
, "%s:%J",

309 
	`iû_ÿnd_ty³2Çme
(
ÿnd
->
ty³
), &ÿnd->
addr
);

311  
”r
;

312 
	}
}

314 
iû_ÿnd_ty³
 
	$iûm_ÿnd_ty³
(cÚ¡ 
iû_ÿnd
 *
ÿnd
)

316  
ÿnd
 ? cªd->
ty³
 : (
iû_ÿnd_ty³
)-1;

317 
	}
}

	@re-0.5.6/src/ice/candpair.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_§.h
>

14 
	~<»_¡un.h
>

15 
	~<»_iû.h
>

16 
	~"iû.h
"

19 
	#DEBUG_MODULE
 "úd·œ"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

24 
	$ÿnd·œ_de¡ruùÜ
(*
¬g
)

26 
iû_ÿnd·œ
 *
ı
 = 
¬g
;

28 
	`li¡_uÆšk
(&
ı
->
Ë
);

29 
	`mem_d”ef
(
ı
->
ù_cÚn
);

30 
	`mem_d”ef
(
ı
->
lÿnd
);

31 
	`mem_d”ef
(
ı
->
rÿnd
);

32 
	}
}

35 
boŞ
 
	$sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

37 cÚ¡ 
iû_ÿnd·œ
 *
ı1
 = 
Ë1
->
d©a
, *
ı2
 = 
Ë2
->data;

38 ()
¬g
;

40  
ı1
->
µrio
 >ğ
ı2
->pprio;

41 
	}
}

44 
	$ÿnd·œ_£t_µrio
(
iû_ÿnd·œ
 *
ı
)

46 
ušt32_t
 
g
, 
d
;

48 ià(
ICE_ROLE_CONTROLLING
 =ğ
ı
->
iûm
->
ÌŞe
) {

49 
g
 = 
ı
->
lÿnd
->
´io
;

50 
d
 = 
ı
->
rÿnd
->
´io
;

53 
g
 = 
ı
->
rÿnd
->
´io
;

54 
d
 = 
ı
->
lÿnd
->
´io
;

57 
ı
->
µrio
 = 
	`iû_ÿlc_·œ_´io
(
g
, 
d
);

58 
	}
}

64 
	$li¡_add_sÜ‹d
(
li¡
 *li¡, 
iû_ÿnd·œ
 *
ı
)

66 
Ë
 *le;

69 
Ë
 = 
	`li¡_
(
li¡
);†e;†ğË->
´ev
) {

70 
iû_ÿnd·œ
 *
ı0
 = 
Ë
->
d©a
;

72 ià(
ı
->
µrio
 < 
ı0
->pprio) {

73 
	`li¡_š£¹_aá”
(
li¡
, 
Ë
, &
ı
->le, cp);

78 
	`li¡_´•’d
(
li¡
, &
ı
->
Ë
, cp);

79 
	}
}

82 
	$iûm_ÿnd·œ_®loc
(
iû_ÿnd·œ
 **
ıp
, 
iûm
 *icem,

83 
iû_ÿnd
 *
lÿnd
, iû_ÿnd *
rÿnd
)

85 
iû_ÿnd·œ
 *
ı
;

86 
iûm_comp
 *
comp
;

88 ià(!
iûm
 || !
lÿnd
 || !
rÿnd
)

89  
EINVAL
;

91 
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
lÿnd
->
compid
);

92 ià(!
comp
)

93  
ENOENT
;

95 
ı
 = 
	`mem_z®loc
((*ı), 
ÿnd·œ_de¡ruùÜ
);

96 ià(!
ı
)

97  
ENOMEM
;

99 
ı
->
iûm
 = icem;

100 
ı
->
comp
 = comp;

101 
ı
->
lÿnd
 = 
	`mem_»f
(lcand);

102 
ı
->
rÿnd
 = 
	`mem_»f
(rcand);

103 
ı
->
¡©e
 = 
ICE_CANDPAIR_FROZEN
;

104 
ı
->
def
 = 
comp
->
def_lÿnd
 =ğ
lÿnd
 && comp->
def_rÿnd
 =ğ
rÿnd
;

106 
	`ÿnd·œ_£t_µrio
(
ı
);

108 
	`li¡_add_sÜ‹d
(&
iûm
->
checkl
, 
ı
);

110 ià(
ıp
)

111 *
ıp
 = 
ı
;

114 
	}
}

117 
	$iûm_ÿnd·œ_şÚe
(
iû_ÿnd·œ
 **
ıp
, iû_ÿnd·œ *
ı0
,

118 
iû_ÿnd
 *
lÿnd
, iû_ÿnd *
rÿnd
)

120 
iû_ÿnd·œ
 *
ı
;

122 ià(!
ı0
)

123  
EINVAL
;

125 
ı
 = 
	`mem_z®loc
((*ı), 
ÿnd·œ_de¡ruùÜ
);

126 ià(!
ı
)

127  
ENOMEM
;

129 
ı
->
iûm
 = 
ı0
->icem;

130 
ı
->
comp
 = 
ı0
->comp;

131 
ı
->
lÿnd
 = 
	`mem_»f
Öÿnd ?†ÿnd : 
ı0
->lcand);

132 
ı
->
rÿnd
 = 
	`mem_»f
Ôÿnd ?„ÿnd : 
ı0
->rcand);

133 
ı
->
def
 = 
ı0
->def;

134 
ı
->
v®id
 = 
ı0
->valid;

135 
ı
->
nomš©ed
 = 
ı0
->nominated;

136 
ı
->
¡©e
 = 
ı0
->state;

137 
ı
->
µrio
 = 
ı0
->pprio;

138 
ı
->
”r
 = 
ı0
->err;

139 
ı
->
scode
 = 
ı0
->scode;

141 
	`li¡_add_sÜ‹d
(&
ı0
->
iûm
->
checkl
, 
ı
);

143 ià(
ıp
)

144 *
ıp
 = 
ı
;

147 
	}
}

151 
	$iûm_ÿnd·œ_´io_Üd”
(
li¡
 *
l¡
)

153 
Ë
 *le;

155 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

156 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

158 
	`ÿnd·œ_£t_µrio
(
ı
);

161 
	`li¡_sÜt
(
l¡
, 
sÜt_hªdËr
, 
NULL
);

162 
	}
}

166 
	$iûm_ÿnd·œ_ÿnûl
(
iû_ÿnd·œ
 *
ı
)

168 ià(!
ı
)

171 
ı
->
ù_cÚn
 = 
	`mem_d”ef
(cp->ct_conn);

172 
	}
}

175 
	$iûm_ÿnd·œ_make_v®id
(
iû_ÿnd·œ
 *
ı
)

177 ià(!
ı
)

180 
ı
->
”r
 = 0;

181 
ı
->
scode
 = 0;

182 
ı
->
v®id
 = 
Œue
;

184 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_SUCCEEDED
);

186 
	`li¡_uÆšk
(&
ı
->
Ë
);

187 
	`li¡_add_sÜ‹d
(&
ı
->
iûm
->
v®idl
, cp);

188 
	}
}

191 
	$iûm_ÿnd·œ_çed
(
iû_ÿnd·œ
 *
ı
, 
”r
, 
ušt16_t
 
scode
)

193 ià(!
ı
)

196 
ı
->
”r
 =ƒrr;

197 
ı
->
scode
 = scode;

198 
ı
->
v®id
 = 
çl£
;

200 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_FAILED
);

201 
	}
}

204 
	$iûm_ÿnd·œ_£t_¡©e
(
iû_ÿnd·œ
 *
ı
,

205 
iû_ÿnd·œ_¡©e
 
¡©e
)

207 ià(!
ı
)

209 ià(
ı
->
¡©e
 =ğ¡©|| 
	`iûm_ÿnd·œ_iscom¶‘ed
(cp))

212 
	`iûcomp_´štf
(
ı
->
comp
,

214 
	`iû_ÿnd_ty³2Çme
(
ı
->
lÿnd
->
ty³
),

215 
	`iû_ÿnd_ty³2Çme
(
ı
->
rÿnd
->
ty³
),

216 
	`iû_ÿnd·œ_¡©e2Çme
(
ı
->
¡©e
),

217 
	`iû_ÿnd·œ_¡©e2Çme
(
¡©e
));

219 
ı
->
¡©e
 = state;

220 
	}
}

226 
	$iûm_ÿnd·œs_æush
(
li¡
 *
l¡
, 
iû_ÿnd_ty³
 
ty³
,

227 
compid
)

229 
Ë
 *Ë = 
	`li¡_h—d
(
l¡
);

231 
Ë
) {

233 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

235 
Ë
 =†e->
Ãxt
;

237 ià(
ı
->
lÿnd
->
compid
 != compid)

240 ià(
ı
->
lÿnd
->
ty³
 !=ype)

243 
	`mem_d”ef
(
ı
);

245 
	}
}

248 
boŞ
 
	$iûm_ÿnd·œ_iscom¶‘ed
(cÚ¡ 
iû_ÿnd·œ
 *
ı
)

250 ià(!
ı
)

251  
çl£
;

253  
ı
->
¡©e
 =ğ
ICE_CANDPAIR_FAILED
 ||

254 
ı
->
¡©e
 =ğ
ICE_CANDPAIR_SUCCEEDED
;

255 
	}
}

266 
boŞ
 
	$iûm_ÿnd·œ_cmp
(cÚ¡ 
iû_ÿnd·œ
 *
ı1
,

267 cÚ¡ 
iû_ÿnd·œ
 *
ı2
)

269 ià(!
	`§_cmp
(&
ı1
->
lÿnd
->
addr
, &
ı2
->lÿnd->addr, 
SA_ALL
))

270  
çl£
;

272  
	`§_cmp
(&
ı1
->
rÿnd
->
addr
, &
ı2
->rÿnd->addr, 
SA_ALL
);

273 
	}
}

288 
iû_ÿnd·œ
 *
	$iûm_ÿnd·œ_fšd
(cÚ¡ 
li¡
 *
l¡
,

289 cÚ¡ 
iû_ÿnd
 *
lÿnd
,

290 cÚ¡ 
iû_ÿnd
 *
rÿnd
)

292 
Ë
 *le;

294 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

296 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

298 ià(!
ı
->
lÿnd
 || !ı->
rÿnd
) {

299 
	`DEBUG_WARNING
("cÜru± cªd·œ %p\n", 
ı
);

303 ià(
lÿnd
 && 
ı
->lcand !=†cand)

306 ià(
rÿnd
 && 
ı
->rcand !=„cand)

309  
ı
;

312  
NULL
;

313 
	}
}

316 
iû_ÿnd·œ
 *
	$iûm_ÿnd·œ_fšd_¡
(cÚ¡ 
li¡
 *
l¡
,

317 
compid
,

318 
iû_ÿnd·œ_¡©e
 
¡©e
)

320 
Ë
 *le;

322 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

324 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

326 ià(
compid
 && 
ı
->
lÿnd
->compid != compid)

329 ià(
ı
->
¡©e
 != state)

332  
ı
;

335  
NULL
;

336 
	}
}

339 
iû_ÿnd·œ
 *
	$iûm_ÿnd·œ_fšd_compid
(cÚ¡ 
li¡
 *
l¡
,

340 
compid
)

342 
Ë
 *le;

344 
Ë
 = 
	`li¡_h—d
(
l¡
);†e;†ğË->
Ãxt
) {

346 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

348 ià(
ı
->
lÿnd
->
compid
 != compid)

351  
ı
;

354  
NULL
;

355 
	}
}

361 
iû_ÿnd·œ
 *
	$iûm_ÿnd·œ_fšd_rÿnd
(
iûm
 *icem,

362 cÚ¡ 
iû_ÿnd
 *
rÿnd
)

364 
iû_ÿnd·œ
 *
ı
;

366 
ı
 = 
	`iûm_ÿnd·œ_fšd
(&
iûm
->
checkl
, 
NULL
, 
rÿnd
);

367 ià(
ı
)

368  
ı
;

370 
ı
 = 
	`iûm_ÿnd·œ_fšd
(&
iûm
->
v®idl
, 
NULL
, 
rÿnd
);

371 ià(
ı
)

372  
ı
;

374  
NULL
;

375 
	}
}

378 
boŞ
 
	$iûm_ÿnd·œ_cmp_âd
(cÚ¡ 
iû_ÿnd·œ
 *
ı1
,

379 cÚ¡ 
iû_ÿnd·œ
 *
ı2
)

381 ià(!
ı1
 || !
ı2
)

382  
çl£
;

384  0 =ğ
	`¡rcmp
(
ı1
->
lÿnd
->
found©iÚ
, 
ı2
->lcand->foundation) &&

385 0 =ğ
	`¡rcmp
(
ı1
->
rÿnd
->
found©iÚ
, 
ı2
->rcand->foundation);

386 
	}
}

389 
	$iûm_ÿnd·œ_debug
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd·œ
 *
ı
)

391 
”r
;

393 ià(!
ı
)

396 
”r
 = 
	`»_h´štf
(
pf
, "{comp=%u} %10s {%c%c%c} %28H <---> %28H",

397 
ı
->
lÿnd
->
compid
,

398 
	`iû_ÿnd·œ_¡©e2Çme
(
ı
->
¡©e
),

399 
ı
->
def
 ? 'D' : ' ',

400 
ı
->
v®id
 ? 'V' : ' ',

401 
ı
->
nomš©ed
 ? 'N' : ' ',

402 
iûm_ÿnd_´št
, 
ı
->
lÿnd
,

403 
iûm_ÿnd_´št
, 
ı
->
rÿnd
);

405 ià(
ı
->
”r
)

406 
”r
 |ğ
	`»_h´štf
(
pf
, " (%m)", 
ı
->err);

408 ià(
ı
->
scode
)

409 
”r
 |ğ
	`»_h´štf
(
pf
, " [%u]", 
ı
->
scode
);

411  
”r
;

412 
	}
}

415 
	$iûm_ÿnd·œs_debug
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *list)

417 
Ë
 *le;

418 
”r
;

420 ià(!
li¡
)

423 
”r
 = 
	`»_h´štf
(
pf
, " (%u)\n", 
	`li¡_couÁ
(
li¡
));

425 
Ë
 = 
li¡
->
h—d
;†&& !
”r
;†ğË->
Ãxt
) {

427 cÚ¡ 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

428 
boŞ
 
is_£Ëùed
 = (
ı
 =ğı->
comp
->
ı_£l
);

430 
”r
 = 
	`»_h´štf
(
pf
, " %c %H\n",

431 
is_£Ëùed
 ? '*' : ' ',

432 
iûm_ÿnd·œ_debug
, 
ı
);

435  
”r
;

436 
	}
}

	@re-0.5.6/src/ice/chklist.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_§.h
>

14 
	~<»_¡un.h
>

15 
	~<»_iû.h
>

16 
	~"iû.h
"

19 
	#DEBUG_MODULE
 "chkli¡"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

27 
	$ÿnd·œs_fÜm
(
iûm
 *icem)

29 
Ë
 *le;

30 
”r
 = 0;

32 ià(
	`li¡_i£m±y
(&
iûm
->
lÿndl
))

33  
ENOENT
;

35 ià(
	`li¡_i£m±y
(&
iûm
->
rÿndl
)) {

36 
	`DEBUG_WARNING
("%s:‚Ø»mÙÿndid©es\n", 
iûm
->
Çme
);

37  
ENOENT
;

40 
Ë
 = 
iûm
->
lÿndl
.
h—d
;†e;†ğË->
Ãxt
) {

42 
iû_ÿnd
 *
lÿnd
 = 
Ë
->
d©a
;

43 
Ë
 *
¾e
;

45 
¾e
 = 
iûm
->
rÿndl
.
h—d
;„Ë;„Ë =„Ë->
Ãxt
) {

47 
iû_ÿnd
 *
rÿnd
 = 
¾e
->
d©a
;

49 ià(
lÿnd
->
compid
 !ğ
rÿnd
->compid)

52 ià(
	`§_af
(&
lÿnd
->
addr
è!ğ§_af(&
rÿnd
->addr))

55 
”r
 = 
	`iûm_ÿnd·œ_®loc
(
NULL
, 
iûm
, 
lÿnd
, 
rÿnd
);

56 ià(
”r
)

57  
”r
;

61  
”r
;

62 
	}
}

66 cÚ¡ 
§
 *
	$ÿnd_¤æx_addr
(cÚ¡ 
iû_ÿnd
 *
c
)

68  (
ICE_CAND_TYPE_SRFLX
 =ğ
c
->
ty³
è? &c->
ba£
->
addr
 : &c->addr;

69 
	}
}

73 *
	$unique_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
)

75 
iû_ÿnd·œ
 *
ı1
 = 
Ë1
->
d©a
, *
ı2
 = 
Ë2
->data;

77 ià(
ı1
->
comp
->
id
 !ğ
ı2
->comp->id)

78  
NULL
;

80 ià(!
	`§_cmp
(
	`ÿnd_¤æx_addr
(
ı1
->
lÿnd
),

81 
	`ÿnd_¤æx_addr
(
ı2
->
lÿnd
), 
SA_ALL
) ||

82 !
	`§_cmp
(&
ı1
->
rÿnd
->
addr
, &
ı2
->rÿnd->addr, 
SA_ALL
))

83  
NULL
;

85  
ı1
->
µrio
 < 
ı2
->pprio ? cp1 : cp2;

86 
	}
}

92 
	$ÿnd·œ_´uÃ
(
iûm
 *icem)

102 
ušt32_t
 
n
 = 
	`iû_li¡_unique
(&
iûm
->
checkl
, 
unique_hªdËr
);

103 ià(
n
 > 0) {

104 
	`DEBUG_NOTICE
("%s:…runed candidate…airs: %u\n",

105 
iûm
->
Çme
, 
n
);

107 
	}
}

113 
	$iû_ÿnd·œ_£t_¡©es
(
iûm
 *icem)

115 
Ë
 *Ë, *
Ë2
;

124 
Ë
 = 
iûm
->
checkl
.
h—d
;†e;†ğË->
Ãxt
) {

126 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

128 
Ë2
 = 
iûm
->
checkl
.
h—d
;†e2;†e2 =†e2->
Ãxt
) {

130 
iû_ÿnd·œ
 *
ı2
 = 
Ë2
->
d©a
;

132 ià(!
	`iûm_ÿnd·œ_cmp_âd
(
ı
, 
ı2
))

135 ià(
ı2
->
lÿnd
->
compid
 < 
ı
->lcand->compid &&

136 
ı2
->
µrio
 > 
ı
->pprio)

137 
ı
 = 
ı2
;

140 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_WAITING
);

142 
	}
}

157 
	$iûm_checkli¡_fÜm
(
iûm
 *icem)

159 
”r
;

161 ià(!
iûm
)

162  
EINVAL
;

164 ià(
ICE_MODE_LITE
 =ğ
iûm
->
lmode
) {

165 
	`DEBUG_WARNING
("%s: Checklist: only valid for full-mode\n",

166 
iûm
->
Çme
);

167  
EINVAL
;

170 ià(!
	`li¡_i£m±y
(&
iûm
->
checkl
))

171  
EALREADY
;

174 
”r
 = 
	`ÿnd·œs_fÜm
(
iûm
);

175 ià(
”r
)

176  
”r
;

180 
	`iûm_ÿnd·œ_´io_Üd”
(&
iûm
->
checkl
);

183 
	`ÿnd·œ_´uÃ
(
iûm
);

185  
”r
;

186 
	}
}

192 
boŞ
 
	$iscom¶‘ed
(cÚ¡ 
iûm
 *icem)

194 
Ë
 *le;

196 
Ë
 = 
iûm
->
checkl
.
h—d
;†e;†ğË->
Ãxt
) {

198 cÚ¡ 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

200 ià(!
	`iûm_ÿnd·œ_iscom¶‘ed
(
ı
))

201  
çl£
;

204  
Œue
;

205 
	}
}

209 
	$cÚşudšg_iû
(
iûm_comp
 *
comp
)

211 
iû_ÿnd·œ
 *
ı
;

213 ià(!
comp
 || comp->
cÚşuded
)

217 
ı
 = 
	`iûm_ÿnd·œ_fšd_¡
(&
comp
->
iûm
->
v®idl
, comp->
id
,

218 
ICE_CANDPAIR_SUCCEEDED
);

219 ià(!
ı
) {

220 
	`DEBUG_WARNING
("{%s.%u} conclude:‚o valid candpair found"

222 
comp
->
iûm
->
Çme
, comp->
id
,

223 
	`li¡_couÁ
(&
comp
->
iûm
->
v®idl
));

227 
	`iûm_comp_£t_£Ëùed
(
comp
, 
ı
);

229 ià(
comp
->
iûm
->
cÚf
.
nom
 =ğ
ICE_NOMINATION_REGULAR
) {

232 ()
	`iûm_cÚncheck_£nd
(
ı
, 
Œue
,rue);

233 
	`iûm_cÚncheck_scheduË_check
(
comp
->
iûm
);

236 
comp
->
cÚşuded
 = 
Œue
;

237 
	}
}

243 
	$iûm_checkli¡_upd©e
(
iûm
 *icem)

245 
Ë
 *le;

246 
boŞ
 
com¶
;

247 
”r
 = 0;

249 
com¶
 = 
	`iscom¶‘ed
(
iûm
);

250 ià(!
com¶
)

257 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

259 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

261 ià(!
	`iûm_ÿnd·œ_fšd_compid
(&
iûm
->
v®idl
, 
comp
->
id
)) {

262 
	`DEBUG_WARNING
("{%s.%u}‚o valid candidate…air"

264 
iûm
->
Çme
, 
comp
->
id
,

265 
	`li¡_couÁ
(&
iûm
->
v®idl
));

266 
”r
 = 
ENOENT
;

270 
	`cÚşudšg_iû
(
comp
);

272 ià(!
comp
->
ı_£l
)

275 
	`iûm_comp_k“·live
(
comp
, 
Œue
);

278 
iûm
->
¡©e
 = 
”r
 ? 
ICE_CHECKLIST_FAILED
 : 
ICE_CHECKLIST_COMPLETED
;

280 ià(
iûm
->
chkh
) {

281 
iûm
->
	`chkh
(
”r
, iûm->
ÌŞe
 =ğ
ICE_ROLE_CONTROLLING
,

282 
iûm
->
¬g
);

284 
	}
}

295 cÚ¡ 
§
 *
	$iûm_£Ëùed_Ïddr
(cÚ¡ 
iûm
 *iûm, 
compid
)

297 cÚ¡ 
iû_ÿnd
 *
ÿnd
 = 
	`iûm_£Ëùed_lÿnd
(
iûm
, 
compid
);

298  
	`iûm_lÿnd_addr
(
ÿnd
);

299 
	}
}

310 cÚ¡ 
iû_ÿnd
 *
	$iûm_£Ëùed_lÿnd
(cÚ¡ 
iûm
 *icem,

311 
compid
)

313 cÚ¡ 
iûm_comp
 *
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

314 ià(!
comp
 || !comp->
ı_£l
)

315  
NULL
;

317  
comp
->
ı_£l
->
lÿnd
;

318 
	}
}

329 cÚ¡ 
iû_ÿnd
 *
	$iûm_£Ëùed_rÿnd
(cÚ¡ 
iûm
 *icem,

330 
compid
)

332 cÚ¡ 
iûm_comp
 *
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

333 ià(!
comp
 || !comp->
ı_£l
)

334  
NULL
;

336  
comp
->
ı_£l
->
rÿnd
;

337 
	}
}

	@re-0.5.6/src/ice/comp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_sys.h
>

14 
	~<»_§.h
>

15 
	~<»_udp.h
>

16 
	~<»_¡un.h
>

17 
	~<»_tuº.h
>

18 
	~<»_iû.h
>

19 
	~"iû.h
"

22 
	#DEBUG_MODULE
 "iûcomp"

	)

23 
	#DEBUG_LEVEL
 5

	)

24 
	~<»_dbg.h
>

27 ’um {
	mCOMPID_MIN
 = 1, 
	mCOMPID_MAX
 = 255};

30 
boŞ
 
	$h–³r_»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

32 
iûm_comp
 *
comp
 = 
¬g
;

33 
iûm
 *iûm = 
comp
->icem;

34 
¡un_msg
 *
msg
 = 
NULL
;

35 
¡un_unknown_©Œ
 
ua
;

36 cÚ¡ 
size_t
 
¡¬t
 = 
mb
->
pos
;

39 
	`»_´štf
("{%d} UDP„ecv_helper: %u bytes from %J\n",

40 
comp
->
id
, 
	`mbuf_g‘_Ëá
(
mb
), 
¤c
);

43 ià(
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
))

44  
çl£
;

46 ià(
STUN_METHOD_BINDING
 =ğ
	`¡un_msg_m‘hod
(
msg
)) {

48 
	`¡un_msg_şass
(
msg
)) {

50 
STUN_CLASS_REQUEST
:

51 ()
	`iûm_¡und_»cv
(
comp
, 
¤c
, 
msg
, 
¡¬t
);

55 ()
	`¡un_ù¿ns_»cv
(
iûm
->
¡un
, 
msg
, &
ua
);

60 
	`mem_d”ef
(
msg
);

62  
Œue
;

63 
	}
}

66 
	$de¡ruùÜ
(*
¬g
)

68 
iûm_comp
 *
comp
 = 
¬g
;

70 
	`tmr_ÿnûl
(&
comp
->
tmr_ka
);

71 
	`mem_d”ef
(
comp
->
tuºc
);

72 
	`mem_d”ef
(
comp
->
ı_£l
);

73 
	`mem_d”ef
(
comp
->
def_lÿnd
);

74 
	`mem_d”ef
(
comp
->
def_rÿnd
);

75 
	`mem_d”ef
(
comp
->
uh
);

76 
	`mem_d”ef
(
comp
->
sock
);

77 
	}
}

80 
iû_ÿnd
 *
	$ÿnd_deçuÉ
(cÚ¡ 
li¡
 *
lÿndl
,

81 
compid
)

83 
iû_ÿnd
 *
def
 = 
NULL
;

84 
Ë
 *le;

87 
Ë
 = 
	`li¡_h—d
(
lÿndl
);†e;†ğË->
Ãxt
) {

89 
iû_ÿnd
 *
ÿnd
 = 
Ë
->
d©a
;

91 ià(
ÿnd
->
compid
 != compid)

94 
ÿnd
->
ty³
) {

96 
ICE_CAND_TYPE_RELAY
:

97  
ÿnd
;

99 
ICE_CAND_TYPE_SRFLX
:

100 ià(!
def
 || 
ICE_CAND_TYPE_SRFLX
 !ğdef->
ty³
)

101 
def
 = 
ÿnd
;

104 
ICE_CAND_TYPE_HOST
:

105 ià(!
def
)

106 
def
 = 
ÿnd
;

114  
def
;

115 
	}
}

118 
	$iûm_comp_®loc
(
iûm_comp
 **
ı
, 
iûm
 *iûm, 
id
,

119 *
sock
)

121 
iûm_comp
 *
comp
;

122 
§
 
loÿl
;

123 
”r
;

125 ià(!
ı
 || !
iûm
 || 
id
<1 || id>255 || !
sock
)

126  
EINVAL
;

128 
comp
 = 
	`mem_z®loc
((*comp), 
de¡ruùÜ
);

129 ià(!
comp
)

130  
ENOMEM
;

132 
comp
->
id
 = id;

133 
comp
->
sock
 = 
	`mem_»f
(sock);

134 
comp
->
iûm
 = icem;

136 
”r
 = 
	`udp_»gi¡”_h–³r
(&
comp
->
uh
, 
sock
, 
iûm
->
Ïy”
,

137 
NULL
, 
h–³r_»cv_hªdËr
, 
comp
);

138 ià(
”r
)

139 
out
;

141 
”r
 = 
	`udp_loÿl_g‘
(
comp
->
sock
, &
loÿl
);

142 ià(
”r
)

143 
out
;

145 
comp
->
ÍÜt
 = 
	`§_pÜt
(&
loÿl
);

147 
out
:

148 ià(
”r
)

149 
	`mem_d”ef
(
comp
);

151 *
ı
 = 
comp
;

153  
”r
;

154 
	}
}

157 
	$iûm_comp_£t_deçuÉ_ÿnd
(
iûm_comp
 *
comp
)

159 
iû_ÿnd
 *
ÿnd
;

161 ià(!
comp
)

162  
EINVAL
;

164 
ÿnd
 = 
	`ÿnd_deçuÉ
(&
comp
->
iûm
->
lÿndl
, comp->
id
);

165 ià(!
ÿnd
)

166  
ENOENT
;

168 
	`mem_d”ef
(
comp
->
def_lÿnd
);

169 
comp
->
def_lÿnd
 = 
	`mem_»f
(
ÿnd
);

172 
	}
}

175 
	$iûm_comp_£t_deçuÉ_rÿnd
(
iûm_comp
 *
comp
,

176 
iû_ÿnd
 *
rÿnd
)

178 ià(!
comp
)

181 
	`iûcomp_´štf
(
comp
, "Set default„emote candidate: %s:%J\n",

182 
	`iû_ÿnd_ty³2Çme
(
rÿnd
->
ty³
), &rÿnd->
addr
);

184 
	`mem_d”ef
(
comp
->
def_rÿnd
);

185 
comp
->
def_rÿnd
 = 
	`mem_»f
(
rÿnd
);

187 ià(
comp
->
tuºc
) {

188 
	`iûcomp_´štf
(
comp
, "Add TURN Channelo…eer %J\n",

189 &
rÿnd
->
addr
);

191 ()
	`tuºc_add_chª
(
comp
->
tuºc
, &
rÿnd
->
addr
, 
NULL
, NULL);

193 
	}
}

196 
	$iûm_comp_£t_£Ëùed
(
iûm_comp
 *
comp
, 
iû_ÿnd·œ
 *
ı
)

198 ià(!
comp
 || !
ı
)

201 ià(
ı
->
¡©e
 !ğ
ICE_CANDPAIR_SUCCEEDED
) {

202 
	`DEBUG_WARNING
("{%s.%u} set_selected: invalid state %s\n",

203 
comp
->
iûm
->
Çme
, comp->
id
,

204 
	`iû_ÿnd·œ_¡©e2Çme
(
ı
->
¡©e
));

207 
	`mem_d”ef
(
comp
->
ı_£l
);

208 
comp
->
ı_£l
 = 
	`mem_»f
(
ı
);

209 
	}
}

212 
iûm_comp
 *
	$iûm_comp_fšd
(cÚ¡ 
iûm
 *iûm, 
compid
)

214 
Ë
 *le;

216 ià(!
iûm
)

217  
NULL
;

219 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

221 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

223 ià(
comp
->
id
 =ğ
compid
)

224  
comp
;

227  
NULL
;

228 
	}
}

231 
	$timeout
(*
¬g
)

233 
iûm_comp
 *
comp
 = 
¬g
;

234 
iû_ÿnd·œ
 *
ı
;

236 
	`tmr_¡¬t
(&
comp
->
tmr_ka
, 
ICE_DEFAULT_Tr
 * 1000 + 
	`¿nd_u16
() % 1000,

237 
timeout
, 
comp
);

240 
ı
 = 
comp
->
ı_£l
;

241 ià(!
ı
)

244 ()
	`¡un_šdiÿtiÚ
(
comp
->
iûm
->
´Ùo
, comp->
sock
, &
ı
->
rÿnd
->
addr
,

245 (
ı
->
lÿnd
->
ty³
 =ğ
ICE_CAND_TYPE_RELAY
) ? 4 : 0,

246 
STUN_METHOD_BINDING
, 
NULL
, 0, 
Œue
, 0);

247 
	}
}

250 
	$iûm_comp_k“·live
(
iûm_comp
 *
comp
, 
boŞ
 
’abË
)

252 ià(!
comp
)

255 ià(
’abË
) {

256 
	`tmr_¡¬t
(&
comp
->
tmr_ka
, 
ICE_DEFAULT_Tr
 * 1000, 
timeout
, comp);

259 
	`tmr_ÿnûl
(&
comp
->
tmr_ka
);

261 
	}
}

264 
	$iûcomp_´štf
(
iûm_comp
 *
comp
, cÚ¡ *
fmt
, ...)

266 
va_li¡
 
­
;

268 ià(!
comp
 || !comp->
iûm
->
cÚf
.
debug
)

271 
	`va_¡¬t
(
­
, 
fmt
);

272 ()
	`»_´štf
("{%11s.%u} %v", 
comp
->
iûm
->
Çme
, comp->
id
, 
fmt
, &
­
);

273 
	`va_’d
(
­
);

274 
	}
}

277 
	$iûcomp_debug
(
»_´štf
 *
pf
, cÚ¡ 
iûm_comp
 *
comp
)

279 ià(!
comp
)

282  
	`»_h´štf
(
pf
, "id=%u†def=%J„def=%J concluded=%d",

283 
comp
->
id
,

284 
comp
->
def_lÿnd
 ? &comp->def_lÿnd->
addr
 : 
NULL
,

285 
comp
->
def_rÿnd
 ? &comp->def_rÿnd->
addr
 : 
NULL
,

286 
comp
->
cÚşuded
);

287 
	}
}

290 
	$iûm_£t_tuº_ş›Á
(
iûm
 *iûm, 
compid
,

291 
tuºc
 *turnc)

293 
iûm_comp
 *
comp
;

295 
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

296 ià(!
comp
)

297  
ENOENT
;

299 
comp
->
tuºc
 = 
	`mem_d”ef
(comp->turnc);

301 ià(
tuºc
)

302 
comp
->
tuºc
 = 
	`mem_»f
(turnc);

305 
	}
}

	@re-0.5.6/src/ice/connchk.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_¡un.h
>

14 
	~<»_tuº.h
>

15 
	~<»_iû.h
>

16 
	~"iû.h
"

19 
	#DEBUG_MODULE
 "cÚnchk"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

24 
	$·û_Ãxt
(
iûm
 *icem)

26 ià(
iûm
->
¡©e
 !ğ
ICE_CHECKLIST_RUNNING
)

29 
	`iûm_cÚncheck_scheduË_check
(
iûm
);

31 ià(
iûm
->
¡©e
 =ğ
ICE_CHECKLIST_FAILED
)

34 
	`iûm_checkli¡_upd©e
(
iûm
);

35 
	}
}

43 
iû_ÿnd·œ
 *
	$cÚ¡ruù_v®id_·œ
(
iûm
 *icem,

44 
iû_ÿnd·œ
 *
ı
,

45 cÚ¡ 
§
 *
m­³d
,

46 cÚ¡ 
§
 *
de¡
)

48 
iû_ÿnd
 *
lÿnd
, *
rÿnd
;

49 
iû_ÿnd·œ
 *
ı2
;

50 
”r
;

52 
lÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
lÿndl
, 
ı
->lÿnd->
compid
, 
m­³d
);

53 
rÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
rÿndl
, 
ı
->rÿnd->
compid
, 
de¡
);

55 ià(!
lÿnd
) {

56 
	`DEBUG_WARNING
("nØsuch†oÿÈÿndid©e: %J\n", 
m­³d
);

57  
NULL
;

59 ià(!
rÿnd
) {

60 
	`DEBUG_WARNING
("nØsuch„emÙÿndid©e: %J\n", 
de¡
);

61  
NULL
;

65 ià(
lÿnd
 !ğ
ı
->lÿnd || 
rÿnd
 != cp->rcand) {

67 ià(
lÿnd
 !ğ
ı
->lcand) {

68 
	`iûcomp_´štf
(
ı
->
comp
,

70 
m­³d
);

72 ià(
rÿnd
 !ğ
ı
->rcand) {

73 
	`iûcomp_´štf
(
ı
->
comp
,

75 
de¡
);

84 
	`iûm_ÿnd·œ_make_v®id
(
ı
);

86 
ı2
 = 
	`iûm_ÿnd·œ_fšd
(&
iûm
->
v®idl
, 
lÿnd
, 
rÿnd
);

87 ià(
ı2
)

88  
ı2
;

90 
”r
 = 
	`iûm_ÿnd·œ_şÚe
(&
ı2
, 
ı
, 
lÿnd
, 
rÿnd
);

91 ià(
”r
)

92  
NULL
;

94 
	`iûm_ÿnd·œ_make_v®id
(
ı2
);

97  
ı2
;

101 
	`iûm_ÿnd·œ_make_v®id
(
ı
);

103  
ı
;

105 
	}
}

108 
	$hªdË_sucûss
(
iûm
 *iûm, 
iû_ÿnd·œ
 *
ı
,

109 cÚ¡ 
§
 *
Ïddr
)

111 ià(!
	`iûm_ÿnd_fšd
(&
iûm
->
lÿndl
, 
ı
->
lÿnd
->
compid
, 
Ïddr
)) {

113 
”r
;

115 
	`iûcomp_´štf
(
ı
->
comp
, "adding†ocal PRFLX Candidate: %J\n",

116 
Ïddr
);

118 
”r
 = 
	`iûm_lÿnd_add
(
iûm
, 
ı
->
lÿnd
,

119 
ICE_CAND_TYPE_PRFLX
, 
Ïddr
);

120 ià(
”r
) {

121 
	`DEBUG_WARNING
("çedØadd PRFLX: %m\n", 
”r
);

125 
ı
 = 
	`cÚ¡ruù_v®id_·œ
(
iûm
, cp, 
Ïddr
, &ı->
rÿnd
->
addr
);

126 ià(!
ı
) {

127 
	`DEBUG_WARNING
("{%s}‚o valid candidate…air for %J\n",

128 
iûm
->
Çme
, 
Ïddr
);

132 
	`iûm_ÿnd·œ_make_v®id
(
ı
);

133 
	`iûm_comp_£t_£Ëùed
(
ı
->
comp
, cp);

135 
ı
->
nomš©ed
 = 
Œue
;

139 
	`iûm_cÚncheck_¡İ
(
iûm
, 0);

141 
	}
}

144 #ià
ICE_TRACE


145 
	$´št_”r
(
»_´štf
 *
pf
, cÚ¡ *
”r
)

147 ià(
”r
 && *err)

148  
	`»_h´štf
(
pf
, " (%m)", *
”r
);

151 
	}
}

155 
	$¡unc_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

156 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

158 
iû_ÿnd·œ
 *
ı
 = 
¬g
;

159 
iûm
 *iûm = 
ı
->icem;

160 
¡un_©Œ
 *
©Œ
;

162 ()
»asÚ
;

164 #ià
ICE_TRACE


165 
	`iûcomp_´štf
(
ı
->
comp
, "Rx %H <--- %H '%u %s'%H\n",

166 
iûm_ÿnd_´št
, 
ı
->
lÿnd
,

167 
iûm_ÿnd_´št
, 
ı
->
rÿnd
,

168 
scode
, 
»asÚ
, 
´št_”r
, &
”r
);

171 ià(
”r
) {

172 
	`iûm_ÿnd·œ_çed
(
ı
, 
”r
, 
scode
);

173 
out
;

176 
scode
) {

179 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

180 ià(!
©Œ
) {

181 
	`DEBUG_WARNING
("no XOR-MAPPED-ADDR in„esponse\n");

182 
	`iûm_ÿnd·œ_çed
(
ı
, 
EBADMSG
, 0);

186 
	`hªdË_sucûss
(
iûm
, 
ı
, &
©Œ
->
v
.
§
);

190 
	`iû_sw™ch_loÿl_rŞe
(
iûm
);

191 ()
	`iûm_cÚncheck_£nd
(
ı
, 
çl£
, 
Œue
);

195 
	`DEBUG_WARNING
("{%s.%u} STUN Response: %u %s\n",

196 
iûm
->
Çme
, 
ı
->
comp
->
id
, 
scode
, 
»asÚ
);

197 
	`iûm_ÿnd·œ_çed
(
ı
, 
”r
, 
scode
);

201 
out
:

202 
	`·û_Ãxt
(
iûm
);

203 
	}
}

206 
	$iûm_cÚncheck_£nd
(
iû_ÿnd·œ
 *
ı
, 
boŞ
 
u£_ÿnd
, boŞ 
Œigged
)

208 
iû_ÿnd
 *
lÿnd
 = 
ı
->lcand;

209 
iûm
 *iûm = 
ı
->icem;

210 
u£ºame_buf
[64];

211 
size_t
 
´esz
 = 0;

212 
ušt32_t
 
´io_´æx
;

213 
ušt16_t
 
ù¾_©Œ
;

214 
”r
 = 0;

216 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_INPROGRESS
);

218 ()
	`»_¢´štf
(
u£ºame_buf
, (username_buf),

219 "%s:%s", 
iûm
->
ruäag
, iûm->
luäag
);

222 
´io_´æx
 = 
	`iû_ÿnd_ÿlc_´io
(
ICE_CAND_TYPE_PRFLX
, 0, 
lÿnd
->
compid
);

224 
iûm
->
ÌŞe
) {

226 
ICE_ROLE_CONTROLLING
:

227 
ù¾_©Œ
 = 
STUN_ATTR_CONTROLLING
;

229 ià(
iûm
->
cÚf
.
nom
 =ğ
ICE_NOMINATION_AGGRESSIVE
)

230 
u£_ÿnd
 = 
Œue
;

233 
ICE_ROLE_CONTROLLED
:

234 
ù¾_©Œ
 = 
STUN_ATTR_CONTROLLED
;

238  
EINVAL
;

241 #ià
ICE_TRACE


242 
	`iûcomp_´štf
(
ı
->
comp
, "Tx %H ---> %H (%s) %s %s\n",

243 
iûm_ÿnd_´št
, 
ı
->
lÿnd
, iûm_ÿnd_´št, cp->
rÿnd
,

244 
	`iû_ÿnd·œ_¡©e2Çme
(
ı
->
¡©e
),

245 
u£_ÿnd
 ? "[USE]" : "",

246 
Œigged
 ? "[Trigged]" : "");

248 ()
Œigged
;

255 ià(!
iûm
->
½wd
) {

256 
	`DEBUG_WARNING
("no„emote…assword!\n");

259 ià(
ı
->
ù_cÚn
) {

260 
	`DEBUG_WARNING
("send_req: CONNCHECK‡lready Pending!\n");

261  
EBUSY
;

264 
lÿnd
->
ty³
) {

266 
ICE_CAND_TYPE_RELAY
:

268 
”r
 = 
	`tuºc_add_chª
(
ı
->
comp
->
tuºc
, &ı->
rÿnd
->
addr
,

269 
NULL
, NULL);

270 ià(
”r
) {

271 
	`DEBUG_WARNING
("add chªÃl: %m\n", 
”r
);

274 
´esz
 = 4;

277 
ICE_CAND_TYPE_HOST
:

278 
ICE_CAND_TYPE_SRFLX
:

279 
ICE_CAND_TYPE_PRFLX
:

280 
ı
->
ù_cÚn
 = 
	`mem_d”ef
(cp->ct_conn);

281 
”r
 = 
	`¡un_»que¡
(&
ı
->
ù_cÚn
, 
iûm
->
¡un
, iûm->
´Ùo
,

282 
ı
->
comp
->
sock
, &ı->
rÿnd
->
addr
, 
´esz
,

283 
STUN_METHOD_BINDING
,

284 (
ušt8_t
 *)
iûm
->
½wd
, 
	`¡r_Ën
(icem->rpwd),

285 
Œue
, 
¡unc_»¥_hªdËr
, 
ı
,

287 
STUN_ATTR_USERNAME
, 
u£ºame_buf
,

288 
STUN_ATTR_PRIORITY
, &
´io_´æx
,

289 
ù¾_©Œ
, &
iûm
->
t›brk
,

290 
STUN_ATTR_USE_CAND
,

291 
u£_ÿnd
 ? &use_cand : 0);

295 
	`DEBUG_WARNING
("unknowÀÿndid©ty³ %d\n", 
lÿnd
->
ty³
);

296 
”r
 = 
EINVAL
;

300  
”r
;

301 
	}
}

304 
	$abÜt_iû
(
iûm
 *iûm, 
”r
)

306 
iûm
->
¡©e
 = 
ICE_CHECKLIST_FAILED
;

307 
	`tmr_ÿnûl
(&
iûm
->
tmr_·û
);

309 ià(
iûm
->
chkh
) {

310 
iûm
->
	`chkh
(
”r
, iûm->
ÌŞe
 =ğ
ICE_ROLE_CONTROLLING
,

311 
iûm
->
¬g
);

314 
iûm
->
chkh
 = 
NULL
;

315 
	}
}

318 
	$do_check
(
iû_ÿnd·œ
 *
ı
)

320 
”r
;

322 
”r
 = 
	`iûm_cÚncheck_£nd
(
ı
, 
çl£
, false);

323 ià(
”r
) {

324 
	`iûm_ÿnd·œ_çed
(
ı
, 
”r
, 0);

326 ià(
”r
 =ğ
ENOMEM
) {

327 
	`abÜt_iû
(
ı
->
iûm
, 
”r
);

330 
	`·û_Ãxt
(
ı
->
iûm
);

333 
	}
}

339 
	$iûm_cÚncheck_scheduË_check
(
iûm
 *icem)

341 
iû_ÿnd·œ
 *
ı
;

345 
ı
 = 
	`iûm_ÿnd·œ_fšd_¡
(&
iûm
->
checkl
, 0, 
ICE_CANDPAIR_WAITING
);

346 ià(
ı
) {

347 
	`do_check
(
ı
);

355 
ı
 = 
	`iûm_ÿnd·œ_fšd_¡
(&
iûm
->
checkl
, 0, 
ICE_CANDPAIR_FROZEN
);

356 ià(
ı
) {

361 
	`do_check
(
ı
);

370 
iûm
->
¡©e
 = 
ICE_CHECKLIST_COMPLETED
;

372 
	}
}

375 
	$·û_timeout
(*
¬g
)

377 
iûm
 *iûm = 
¬g
;

379 
	`·û_Ãxt
(
iûm
);

380 
	}
}

386 
	$iûm_cÚncheck_¡¬t
(
iûm
 *icem)

388 
”r
;

390 ià(!
iûm
)

391  
EINVAL
;

393 ià(
ICE_MODE_FULL
 !ğ
iûm
->
lmode
)

394  
EINVAL
;

396 
”r
 = 
	`iûm_checkli¡_fÜm
(
iûm
);

397 ià(
”r
)

398  
”r
;

400 
iûm
->
¡©e
 = 
ICE_CHECKLIST_RUNNING
;

402 
	`iûm_´štf
(
iûm
, "starting connectivity checks"

404 
	`li¡_couÁ
(&
iûm
->
checkl
));

407 
	`tmr_¡¬t
(&
iûm
->
tmr_·û
, 10, 
·û_timeout
, icem);

410 
	}
}

413 
	$iûm_cÚncheck_cÚtšue
(
iûm
 *icem)

415 ià(!
	`tmr_i¤uÂšg
(&
iûm
->
tmr_·û
))

416 
	`tmr_¡¬t
(&
iûm
->
tmr_·û
, 1, 
·û_timeout
, icem);

417 
	}
}

423 
	$iûm_cÚncheck_¡İ
(
iûm
 *iûm, 
”r
)

425 
Ë
 *le;

427 
iûm
->
¡©e
 = 
”r
 ? 
ICE_CHECKLIST_FAILED
 : 
ICE_CHECKLIST_COMPLETED
;

429 
	`tmr_ÿnûl
(&
iûm
->
tmr_·û
);

431 
Ë
 = 
iûm
->
checkl
.
h—d
;†e;†ğË->
Ãxt
) {

432 
iû_ÿnd·œ
 *
ı
 = 
Ë
->
d©a
;

434 ià(!
	`iûm_ÿnd·œ_iscom¶‘ed
(
ı
)) {

435 
	`iûm_ÿnd·œ_ÿnûl
(
ı
);

436 
	`iûm_ÿnd·œ_çed
(
ı
, 
EINTR
, 0);

440 
	`iûm_checkli¡_upd©e
(
iûm
);

441 
	}
}

	@re-0.5.6/src/ice/ice.c

	@re-0.5.6/src/ice/ice.h

8 #iâdeà
RELEASE


9 
	#ICE_TRACE
 1

	)

13 
	eiû_checkl_¡©e
 {

14 
	mICE_CHECKLIST_NULL
 = -1,

15 
	mICE_CHECKLIST_RUNNING
,

16 
	mICE_CHECKLIST_COMPLETED
,

17 
	mICE_CHECKLIST_FAILED


20 
	eiû_Œª¥
 {

21 
	mICE_TRANSP_NONE
 = -1,

22 
	mICE_TRANSP_UDP
 = 
IPPROTO_UDP


27 
	mICE_DEFAULT_Tr
 = 15,

28 
	mICE_DEFAULT_Ta_RTP
 = 20,

29 
	mICE_DEFAULT_Ta_NON_RTP
 = 500,

30 
	mICE_DEFAULT_RTO_RTP
 = 100,

31 
	mICE_DEFAULT_RTO_NONRTP
 = 500,

32 
	mICE_DEFAULT_RC
 = 7

37 
	siûm_comp
 {

38 
Ë
 
	mË
;

39 
iûm
 *
	miûm
;

40 
iû_ÿnd
 *
	mdef_lÿnd
;

41 
iû_ÿnd
 *
	mdef_rÿnd
;

42 
iû_ÿnd·œ
 *
	mı_£l
;

43 
udp_h–³r
 *
	muh
;

44 *
	msock
;

45 
ušt16_t
 
	mÍÜt
;

46 
	mid
;

47 
boŞ
 
	mcÚşuded
;

48 
tuºc
 *
	mtuºc
;

49 
tmr
 
	mtmr_ka
;

53 
	siûm
 {

54 
iû_cÚf
 
	mcÚf
;

55 
¡un
 *
	m¡un
;

56 
§
 
	m¡un_¤v
;

57 
li¡
 
	mlÿndl
;

58 
li¡
 
	mrÿndl
;

59 
li¡
 
	mcheckl
;

60 
li¡
 
	mv®idl
;

61 
ušt64_t
 
	mt›brk
;

62 
boŞ
 
	mmism©ch
;

63 
iû_mode
 
	mlmode
;

64 
iû_mode
 
	mrmode
;

65 
iû_rŞe
 
	mÌŞe
;

66 
tmr
 
	mtmr_·û
;

67 
	m´Ùo
;

68 
	mÏy”
;

69 
iû_checkl_¡©e
 
	m¡©e
;

70 
li¡
 
	mcom¶
;

71 *
	mluäag
;

72 *
	mÍwd
;

73 *
	mruäag
;

74 *
	m½wd
;

75 
iû_cÚnchk_h
 *
	mchkh
;

76 *
	m¬g
;

77 
	mÇme
[32];

81 
	siû_ÿnd
 {

82 
Ë
 
	mË
;

83 
iû_ÿnd_ty³
 
	mty³
;

84 
ušt32_t
 
	m´io
;

85 *
	mfound©iÚ
;

86 
	mcompid
;

87 
§
 
	m»l
;

88 
§
 
	maddr
;

89 
iû_Œª¥
 
	mŒª¥
;

92 
iû_ÿnd
 *
	mba£
;

93 *
	miâame
;

97 
	siû_ÿnd·œ
 {

98 
Ë
 
	mË
;

99 
iûm
 *
	miûm
;

100 
iûm_comp
 *
	mcomp
;

101 
iû_ÿnd
 *
	mlÿnd
;

102 
iû_ÿnd
 *
	mrÿnd
;

103 
boŞ
 
	mdef
;

104 
boŞ
 
	mv®id
;

105 
boŞ
 
	mnomš©ed
;

106 
iû_ÿnd·œ_¡©e
 
	m¡©e
;

107 
ušt64_t
 
	mµrio
;

108 
¡un_ù¿ns
 *
	mù_cÚn
;

109 
	m”r
;

110 
ušt16_t
 
	mscode
;

115 
iûm_lÿnd_add_ba£
(
iûm
 *iûm, 
compid
, 
ušt16_t
 
Írio
,

116 cÚ¡ *
iâame
, 
iû_Œª¥
 
Œª¥
,

117 cÚ¡ 
§
 *
addr
);

118 
iûm_rÿnd_add
(
iûm
 *iûm, 
iû_ÿnd_ty³
 
ty³
, 
compid
,

119 
ušt32_t
 
´io
, cÚ¡ 
§
 *
addr
,

120 cÚ¡ 
§
 *
»l_addr
, cÚ¡ 
¶
 *
found©iÚ
);

121 
iûm_rÿnd_add_´æx
(
iû_ÿnd
 **
rı
, 
iûm
 *icem,

122 
compid
, 
ušt32_t
 
´io
,

123 cÚ¡ 
§
 *
addr
);

124 
iû_ÿnd
 *
iûm_lÿnd_fšd_checkli¡
(cÚ¡ 
iûm
 *icem,

125 
compid
);

126 
iûm_ÿnds_debug
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *
l¡
);

127 
iûm_ÿnd_´št
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd
 *
ÿnd
);

131 
iûm_ÿnd·œ_®loc
(
iû_ÿnd·œ
 **
ıp
, 
iûm
 *icem,

132 
iû_ÿnd
 *
lÿnd
, iû_ÿnd *
rÿnd
);

133 
iûm_ÿnd·œ_şÚe
(
iû_ÿnd·œ
 **
ıp
, iû_ÿnd·œ *
ı0
,

134 
iû_ÿnd
 *
lÿnd
, iû_ÿnd *
rÿnd
);

135 
iûm_ÿnd·œ_´io_Üd”
(
li¡
 *
l¡
);

136 
iûm_ÿnd·œ_ÿnûl
(
iû_ÿnd·œ
 *
ı
);

137 
iûm_ÿnd·œ_make_v®id
(
iû_ÿnd·œ
 *
ı
);

138 
iûm_ÿnd·œ_çed
(
iû_ÿnd·œ
 *
ı
, 
”r
, 
ušt16_t
 
scode
);

139 
iûm_ÿnd·œ_£t_¡©e
(
iû_ÿnd·œ
 *
ı
,

140 
iû_ÿnd·œ_¡©e
 
¡©e
);

141 
iûm_ÿnd·œs_æush
(
li¡
 *
l¡
, 
iû_ÿnd_ty³
 
ty³
,

142 
compid
);

143 
boŞ
 
iûm_ÿnd·œ_iscom¶‘ed
(cÚ¡ 
iû_ÿnd·œ
 *
ı
);

144 
boŞ
 
iûm_ÿnd·œ_cmp
(cÚ¡ 
iû_ÿnd·œ
 *
ı1
,

145 cÚ¡ 
iû_ÿnd·œ
 *
ı2
);

146 
boŞ
 
iûm_ÿnd·œ_cmp_âd
(cÚ¡ 
iû_ÿnd·œ
 *
ı1
,

147 cÚ¡ 
iû_ÿnd·œ
 *
ı2
);

148 
iû_ÿnd·œ
 *
iûm_ÿnd·œ_fšd
(cÚ¡ 
li¡
 *
l¡
,

149 cÚ¡ 
iû_ÿnd
 *
lÿnd
,

150 cÚ¡ 
iû_ÿnd
 *
rÿnd
);

151 
iû_ÿnd·œ
 *
iûm_ÿnd·œ_fšd_¡
(cÚ¡ 
li¡
 *
l¡
,

152 
compid
,

153 
iû_ÿnd·œ_¡©e
 
¡©e
);

154 
iû_ÿnd·œ
 *
iûm_ÿnd·œ_fšd_compid
(cÚ¡ 
li¡
 *
l¡
,

155 
compid
);

156 
iû_ÿnd·œ
 *
iûm_ÿnd·œ_fšd_rÿnd
(
iûm
 *icem,

157 cÚ¡ 
iû_ÿnd
 *
rÿnd
);

158 
iûm_ÿnd·œ_debug
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd·œ
 *
ı
);

159 
iûm_ÿnd·œs_debug
(
»_´štf
 *
pf
, cÚ¡ 
li¡
 *list);

163 
iûm_¡und_»cv
(
iûm_comp
 *
comp
, cÚ¡ 
§
 *
¤c
,

164 
¡un_msg
 *
»q
, 
size_t
 
´esz
);

168 
iûm_´štf
(
iûm
 *iûm, cÚ¡ *
fmt
, ...);

172 
iûm_checkli¡_fÜm
(
iûm
 *icem);

173 
iûm_checkli¡_upd©e
(
iûm
 *icem);

177 
iûm_comp_®loc
(
iûm_comp
 **
ı
, 
iûm
 *iûm, 
id
,

178 *
sock
);

179 
iûm_comp_£t_deçuÉ_ÿnd
(
iûm_comp
 *
comp
);

180 
iûm_comp_£t_deçuÉ_rÿnd
(
iûm_comp
 *
comp
,

181 
iû_ÿnd
 *
rÿnd
);

182 
iûm_comp_£t_£Ëùed
(
iûm_comp
 *
comp
, 
iû_ÿnd·œ
 *
ı
);

183 
iûm_comp
 *
iûm_comp_fšd
(cÚ¡ 
iûm
 *iûm, 
compid
);

184 
iûm_comp_k“·live
(
iûm_comp
 *
comp
, 
boŞ
 
’abË
);

185 
iûcomp_´štf
(
iûm_comp
 *
comp
, cÚ¡ *
fmt
, ...);

186 
iûcomp_debug
(
»_´štf
 *
pf
, cÚ¡ 
iûm_comp
 *
comp
);

190 
iûm_cÚncheck_scheduË_check
(
iûm
 *icem);

191 
iûm_cÚncheck_cÚtšue
(
iûm
 *icem);

192 
iûm_cÚncheck_£nd
(
iû_ÿnd·œ
 *
ı
, 
boŞ
 
u£_ÿnd
, boŞ 
Œigged
);

196 cÚ¡ *
iû_mode2Çme
(
iû_mode
 
mode
);

197 cÚ¡ *
iû_checkl_¡©e2Çme
(
iû_checkl_¡©e
 
c¡
);

201 * (
	tli¡_unique_h
)(
	tË
 *
	tË1
, Ë *
	tË2
);

203 
ušt64_t
 
iû_ÿlc_·œ_´io
(
ušt32_t
 
g
, ušt32_ˆ
d
);

204 
iû_sw™ch_loÿl_rŞe
(
iûm
 *icem);

205 
ušt32_t
 
iû_li¡_unique
(
li¡
 *li¡, 
li¡_unique_h
 *
uh
);

	@re-0.5.6/src/ice/icem.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_¡un.h
>

14 
	~<»_tuº.h
>

15 
	~<»_iû.h
>

16 
	~"iû.h
"

19 
	#DEBUG_MODULE
 "iûm"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

29 cÚ¡ 
iû_cÚf
 
	gcÚf_deçuÉ
 = {

30 
ICE_NOMINATION_REGULAR
,

31 
ICE_DEFAULT_RTO_RTP
,

32 
ICE_DEFAULT_RC
,

33 
çl£


38 
	$iû_d‘”mše_rŞe
(
iûm
 *iûm, 
iû_rŞe
 
rŞe
)

40 ià(!
iûm
)

43 ià(
iûm
->
lmode
 =ğiûm->
rmode
)

44 
iûm
->
ÌŞe
 = 
rŞe
;

45 ià(
iûm
->
lmode
 =ğ
ICE_MODE_FULL
)

46 
iûm
->
ÌŞe
 = 
ICE_ROLE_CONTROLLING
;

48 
iûm
->
ÌŞe
 = 
ICE_ROLE_CONTROLLED
;

49 
	}
}

52 
	$iûm_de¡ruùÜ
(*
d©a
)

54 
iûm
 *iûm = 
d©a
;

56 
	`tmr_ÿnûl
(&
iûm
->
tmr_·û
);

57 
	`li¡_æush
(&
iûm
->
com¶
);

58 
	`li¡_æush
(&
iûm
->
v®idl
);

59 
	`li¡_æush
(&
iûm
->
checkl
);

60 
	`li¡_æush
(&
iûm
->
lÿndl
);

61 
	`li¡_æush
(&
iûm
->
rÿndl
);

62 
	`mem_d”ef
(
iûm
->
luäag
);

63 
	`mem_d”ef
(
iûm
->
Íwd
);

64 
	`mem_d”ef
(
iûm
->
ruäag
);

65 
	`mem_d”ef
(
iûm
->
½wd
);

66 
	`mem_d”ef
(
iûm
->
¡un
);

67 
	}
}

86 
	$iûm_®loc
(
iûm
 **
iûmp
,

87 
iû_mode
 
mode
, 
iû_rŞe
 
rŞe
,

88 
´Ùo
, 
Ïy”
,

89 
ušt64_t
 
t›brk
, cÚ¡ *
luäag
, cÚ¡ *
Íwd
,

90 
iû_cÚnchk_h
 *
chkh
, *
¬g
)

92 
iûm
 *icem;

93 
”r
 = 0;

95 ià(!
iûmp
 || !
t›brk
 || !
luäag
 || !
Íwd
)

96  
EINVAL
;

98 ià(
	`¡r_Ën
(
luäag
è< 4 || sŒ_Ën(
Íwd
) < 22) {

99 
	`DEBUG_WARNING
("alloc:†ufrag/lpwd isoo short\n");

100  
EINVAL
;

103 ià(
´Ùo
 !ğ
IPPROTO_UDP
)

104  
EPROTONOSUPPORT
;

106 
iûm
 = 
	`mem_z®loc
((*iûm), 
iûm_de¡ruùÜ
);

107 ià(!
iûm
)

108  
ENOMEM
;

110 
iûm
->
cÚf
 = 
cÚf_deçuÉ
;

112 
	`tmr_š™
(&
iûm
->
tmr_·û
);

113 
	`li¡_š™
(&
iûm
->
lÿndl
);

114 
	`li¡_š™
(&
iûm
->
rÿndl
);

115 
	`li¡_š™
(&
iûm
->
checkl
);

116 
	`li¡_š™
(&
iûm
->
v®idl
);

118 
iûm
->
Ïy”
 =†ayer;

119 
iûm
->
´Ùo
 =…roto;

120 
iûm
->
¡©e
 = 
ICE_CHECKLIST_NULL
;

121 
iûm
->
chkh
 = chkh;

122 
iûm
->
¬g
 =‡rg;

124 ià(
”r
)

125 
out
;

127 
iûm
->
lmode
 = 
mode
;

128 
iûm
->
t›brk
 =iebrk;

130 
”r
 |ğ
	`¡r_dup
(&
iûm
->
luäag
,†ufrag);

131 
”r
 |ğ
	`¡r_dup
(&
iûm
->
Íwd
,†pwd);

132 ià(
”r
)

133 
out
;

135 
	`iû_d‘”mše_rŞe
(
iûm
, 
rŞe
);

137 ià(
ICE_MODE_FULL
 =ğ
iûm
->
lmode
) {

139 
”r
 = 
	`¡un_®loc
(&
iûm
->
¡un
, 
NULL
, NULL, NULL);

140 ià(
”r
)

141 
out
;

144 
	`¡un_cÚf
(
iûm
->
¡un
)->
¹o
 = iûm->
cÚf
.rto;

145 
	`¡un_cÚf
(
iûm
->
¡un
)->
rc
 = iûm->
cÚf
.rc;

148 
out
:

149 ià(
”r
)

150 
	`mem_d”ef
(
iûm
);

151 ià(
iûmp
)

152 *
iûmp
 = 
iûm
;

154  
”r
;

155 
	}
}

165 
iû_cÚf
 *
	$iûm_cÚf
(
iûm
 *icem)

167  
iûm
 ? &iûm->
cÚf
 : 
NULL
;

168 
	}
}

171 
iû_rŞe
 
	$iûm_loÿl_rŞe
(cÚ¡ 
iûm
 *icem)

173  
iûm
 ? iûm->
ÌŞe
 : 
ICE_ROLE_UNKNOWN
;

174 
	}
}

177 
	$iûm_£t_cÚf
(
iûm
 *iûm, cÚ¡ 
iû_cÚf
 *
cÚf
)

179 ià(!
iûm
 || !
cÚf
)

182 
iûm
->
cÚf
 = *conf;

184 ià(
iûm
->
¡un
) {

187 
	`¡un_cÚf
(
iûm
->
¡un
)->
¹o
 = iûm->
cÚf
.rto;

188 
	`¡un_cÚf
(
iûm
->
¡un
)->
rc
 = iûm->
cÚf
.rc;

190 
	}
}

199 
	$iûm_£t_rŞe
(
iûm
 *iûm, 
iû_rŞe
 
rŞe
)

201 ià(!
iûm
)

204 
	`iû_d‘”mše_rŞe
(
iûm
, 
rŞe
);

205 
	}
}

214 
	$iûm_£t_Çme
(
iûm
 *iûm, cÚ¡ *
Çme
)

216 ià(!
iûm
)

219 
	`¡r_nıy
(
iûm
->
Çme
,‚ame, (icem->name));

220 
	}
}

232 
	$iûm_comp_add
(
iûm
 *iûm, 
compid
, *
sock
)

234 
iûm_comp
 *
comp
;

235 
”r
;

237 ià(!
iûm
)

238  
EINVAL
;

240 ià(
	`iûm_comp_fšd
(
iûm
, 
compid
))

241  
EALREADY
;

243 
”r
 = 
	`iûm_comp_®loc
(&
comp
, 
iûm
, 
compid
, 
sock
);

244 ià(
”r
)

245  
”r
;

247 
	`li¡_­³nd
(&
iûm
->
com¶
, &
comp
->
Ë
, comp);

250 
	}
}

264 
	$iûm_ÿnd_add
(
iûm
 *iûm, 
compid
, 
ušt16_t
 
Írio
,

265 cÚ¡ *
iâame
, cÚ¡ 
§
 *
addr
)

267 ià(!
	`iûm_comp_fšd
(
iûm
, 
compid
))

268  
ENOENT
;

270  
	`iûm_lÿnd_add_ba£
(
iûm
, 
compid
, 
Írio
, 
iâame
,

271 
ICE_TRANSP_UDP
, 
addr
);

272 
	}
}

275 *
	$unique_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
)

277 
iû_ÿnd
 *
c1
 = 
Ë1
->
d©a
, *
c2
 = 
Ë2
->data;

279 ià(
c1
->
ba£
 !ğ
c2
->ba£ || !
	`§_cmp
(&c1->
addr
, &c2->addr, 
SA_ALL
))

280  
NULL
;

283  
c1
->
´io
 < 
c2
->prio ? c1 : c2;

284 
	}
}

288 
	$iûm_ÿnd_»dund_–im
(
iûm
 *icem)

290 
ušt32_t
 
n
;

292 
n
 = 
	`iû_li¡_unique
(&
iûm
->
lÿndl
, 
unique_hªdËr
);

293 ià(
n
 > 0) {

294 
	`iûm_´štf
(
iûm
, "»dundªˆÿndid©e –imš©ed: %u\n", 
n
);

296 
	}
}

307 cÚ¡ 
§
 *
	$iûm_ÿnd_deçuÉ
(
iûm
 *iûm, 
compid
)

309 cÚ¡ 
iûm_comp
 *
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

311 ià(!
comp
 || !comp->
def_lÿnd
)

312  
NULL
;

314  &
comp
->
def_lÿnd
->
addr
;

315 
	}
}

327 
boŞ
 
	$iûm_v”ify_suµÜt
(
iûm
 *iûm, 
compid
,

328 cÚ¡ 
§
 *
¿ddr
)

330 
iû_ÿnd
 *
rÿnd
;

331 
boŞ
 
m©ch
;

333 ià(!
iûm
)

334  
çl£
;

336 
rÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
rÿndl
, 
compid
, 
¿ddr
);

337 
m©ch
 = 
rÿnd
 !ğ
NULL
;

339 ià(!
m©ch
)

340 
iûm
->
mism©ch
 = 
Œue
;

342 ià(
rÿnd
) {

343 
	`iûm_comp_£t_deçuÉ_rÿnd
(
	`iûm_comp_fšd
(
iûm
, 
compid
),

344 
rÿnd
);

347  
m©ch
;

348 
	}
}

360 
	$iûm_add_chª
(
iûm
 *iûm, 
compid
, cÚ¡ 
§
 *
¿ddr
)

362 
iûm_comp
 *
comp
;

364 ià(!
iûm
)

365  
EINVAL
;

367 
comp
 = 
	`iûm_comp_fšd
(
iûm
, 
compid
);

368 ià(!
comp
)

369  
ENOENT
;

371 ià(
comp
->
tuºc
) {

372 
	`DEBUG_NOTICE
("{%s.%u} Add TURN Channelo…eer %J\n",

373 
comp
->
iûm
->
Çme
, comp->
id
, 
¿ddr
);

375  
	`tuºc_add_chª
(
comp
->
tuºc
, 
¿ddr
, 
NULL
, NULL);

379 
	}
}

382 
	$purge_»Ïyed
(
iûm
 *iûm, 
iûm_comp
 *
comp
)

384 ià(
comp
->
tuºc
) {

385 
	`DEBUG_NOTICE
("{%s.%u}…urge†ocal RELAY candidates\n",

386 
iûm
->
Çme
, 
comp
->
id
);

393 
	`iûm_ÿnd·œs_æush
(&
iûm
->
checkl
, 
ICE_CAND_TYPE_RELAY
, 
comp
->
id
);

394 
	`iûm_ÿnd·œs_æush
(&
iûm
->
v®idl
, 
ICE_CAND_TYPE_RELAY
, 
comp
->
id
);

396 
comp
->
tuºc
 = 
	`mem_d”ef
(comp->turnc);

397 
	}
}

405 
	$iûm_upd©e
(
iûm
 *icem)

407 
Ë
 *le;

409 ià(!
iûm
)

412 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

414 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

417 ià(
comp
->
ı_£l
) {

419 ià(
comp
->
ı_£l
->
lÿnd
->
ty³
 !ğ
ICE_CAND_TYPE_RELAY
)

420 
	`purge_»Ïyed
(
iûm
, 
comp
);

423 
	}
}

433 
boŞ
 
	$iûm_mism©ch
(cÚ¡ 
iûm
 *icem)

435  
iûm
 ? iûm->
mism©ch
 : 
Œue
;

436 
	}
}

447 
	$iûm_debug
(
»_´štf
 *
pf
, cÚ¡ 
iûm
 *icem)

449 
Ë
 *le;

450 
”r
 = 0;

452 ià(!
iûm
)

455 
”r
 |ğ
	`»_h´štf
(
pf
, "----- ICE MedŸ <%s> -----\n", 
iûm
->
Çme
);

457 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal_mode=%s,„emote_mode=%s",

458 
	`iû_mode2Çme
(
iûm
->
lmode
),

459 
	`iû_mode2Çme
(
iûm
->
rmode
));

460 
”r
 |ğ
	`»_h´štf
(
pf
, ",†oÿl_rŞe=%s\n", 
	`iû_rŞe2Çme
(
iûm
->
ÌŞe
));

461 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal_ufrag=\"%s\"†ocal_pwd=\"%s\"\n",

462 
iûm
->
luäag
, iûm->
Íwd
);

464 
”r
 |ğ
	`»_h´štf
(
pf
, " CompÚ’ts: (%u)\n", 
	`li¡_couÁ
(&
iûm
->
com¶
));

465 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

466 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

468 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
iûcomp_debug
, 
comp
);

471 
”r
 |ğ
	`»_h´štf
(
pf
, " Local Candidates: %H",

472 
iûm_ÿnds_debug
, &
iûm
->
lÿndl
);

473 
”r
 |ğ
	`»_h´štf
(
pf
, " Remote Candidates: %H",

474 
iûm_ÿnds_debug
, &
iûm
->
rÿndl
);

475 
”r
 |ğ
	`»_h´štf
(
pf
, " Check†ist: [state=%s]%H",

476 
	`iû_checkl_¡©e2Çme
(
iûm
->
¡©e
),

477 
iûm_ÿnd·œs_debug
, &
iûm
->
checkl
);

478 
”r
 |ğ
	`»_h´štf
(
pf
, " Valid†ist: %H",

479 
iûm_ÿnd·œs_debug
, &
iûm
->
v®idl
);

481 
”r
 |ğ
	`¡un_debug
(
pf
, 
iûm
->
¡un
);

483  
”r
;

484 
	}
}

494 
li¡
 *
	$iûm_lÿndl
(cÚ¡ 
iûm
 *icem)

496  
iûm
 ? (
li¡
 *)&iûm->
lÿndl
 : 
NULL
;

497 
	}
}

507 
li¡
 *
	$iûm_rÿndl
(cÚ¡ 
iûm
 *icem)

509  
iûm
 ? (
li¡
 *)&iûm->
rÿndl
 : 
NULL
;

510 
	}
}

520 
li¡
 *
	$iûm_checkl
(cÚ¡ 
iûm
 *icem)

522  
iûm
 ? (
li¡
 *)&iûm->
checkl
 : 
NULL
;

523 
	}
}

533 
li¡
 *
	$iûm_v®idl
(cÚ¡ 
iûm
 *icem)

535  
iûm
 ? (
li¡
 *)&iûm->
v®idl
 : 
NULL
;

536 
	}
}

546 
	$iûm_l™e_£t_deçuÉ_ÿndid©es
(
iûm
 *icem)

548 
Ë
 *le;

549 
”r
 = 0;

551 ià(
iûm
->
lmode
 !ğ
ICE_MODE_LITE
)

552  
EINVAL
;

554 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

556 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

558 
”r
 |ğ
	`iûm_comp_£t_deçuÉ_ÿnd
(
comp
);

561  
”r
;

562 
	}
}

565 
	$iûm_comps_£t_deçuÉ_ÿnd
(
iûm
 *icem)

567 
Ë
 *le;

568 
”r
 = 0;

570 ià(!
iûm
)

571  
EINVAL
;

573 
Ë
 = 
iûm
->
com¶
.
h—d
;†e;†ğË->
Ãxt
) {

575 
iûm_comp
 *
comp
 = 
Ë
->
d©a
;

577 
”r
 |ğ
	`iûm_comp_£t_deçuÉ_ÿnd
(
comp
);

580  
”r
;

581 
	}
}

584 
¡un
 *
	$iûm_¡un
(
iûm
 *icem)

586  
iûm
 ? iûm->
¡un
 : 
NULL
;

587 
	}
}

590 
	$iûm_´štf
(
iûm
 *iûm, cÚ¡ *
fmt
, ...)

592 
va_li¡
 
­
;

594 ià(!
iûm
 || !iûm->
cÚf
.
debug
)

597 
	`va_¡¬t
(
­
, 
fmt
);

598 ()
	`»_´štf
("{%11s. } %v", 
iûm
->
Çme
, 
fmt
, &
­
);

599 
	`va_’d
(
­
);

600 
	}
}

	@re-0.5.6/src/ice/icesdp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_§.h
>

14 
	~<»_Ãt.h
>

15 
	~<»_¡un.h
>

16 
	~<»_iû.h
>

17 
	~"iû.h
"

20 
	#DEBUG_MODULE
 "iûsdp"

	)

21 
	#DEBUG_LEVEL
 5

	)

22 
	~<»_dbg.h
>

25 cÚ¡ 
	giû_©Œ_ÿnd
[] = "candidate";

26 cÚ¡ 
	giû_©Œ_»mÙe_ÿnd
[] = "remote-candidates";

27 cÚ¡ 
	giû_©Œ_l™e
[] = "ice-lite";

28 cÚ¡ 
	giû_©Œ_uäag
[] = "ice-ufrag";

29 cÚ¡ 
	giû_©Œ_pwd
[] = "ice-pwd";

30 cÚ¡ 
	giû_©Œ_mism©ch
[] = "ice-mismatch";

33 cÚ¡ 
	g»l_addr_¡r
[] = "raddr";

34 cÚ¡ 
	g»l_pÜt_¡r
[] = "rport";

40 cÚ¡ *
	$Œª¥_Çme
(
iû_Œª¥
 
Œª¥
)

42 
Œª¥
) {

44 
ICE_TRANSP_UDP
:  "UDP";

47 
	}
}

50 
iû_Œª¥
 
	$Œª¥_»sŞve
(cÚ¡ 
¶
 *
Œª¥
)

52 ià(!
	`¶_¡rÿ£cmp
(
Œª¥
, "UDP"))

53  
ICE_TRANSP_UDP
;

55  
ICE_TRANSP_NONE
;

56 
	}
}

67 
	$iû_ÿnd_’code
(
»_´štf
 *
pf
, cÚ¡ 
iû_ÿnd
 *
ÿnd
)

69 
”r
;

71 
”r
 = 
	`»_h´štf
(
pf
, "%s %u %s %u %j %uyp %s",

72 
ÿnd
->
found©iÚ
, cªd->
compid
,

73 
	`Œª¥_Çme
(
ÿnd
->
Œª¥
), cªd->
´io
,

74 &
ÿnd
->
addr
, 
	`§_pÜt
(&cand->addr),

75 
	`iû_ÿnd_ty³2Çme
(
ÿnd
->
ty³
));

77 ià(
	`§_is£t
(&
ÿnd
->
»l
, 
SA_ADDR
))

78 
”r
 |ğ
	`»_h´štf
(
pf
, "„add¸%j", &
ÿnd
->
»l
);

80 ià(
	`§_is£t
(&
ÿnd
->
»l
, 
SA_PORT
))

81 
”r
 |ğ
	`»_h´štf
(
pf
, "„pÜˆ%u", 
	`§_pÜt
(&
ÿnd
->
»l
));

83  
”r
;

84 
	}
}

94 
boŞ
 
	$iû_»mÙeÿnds_ava
(cÚ¡ 
iûm
 *icem)

96 ià(!
iûm
)

97  
çl£
;

99  
iûm
->
ÌŞe
 =ğ
ICE_ROLE_CONTROLLING
 &&

100 
iûm
->
¡©e
 =ğ
ICE_CHECKLIST_COMPLETED
;

101 
	}
}

112 
	$iû_»mÙeÿnds_’code
(
»_´štf
 *
pf
, cÚ¡ 
iûm
 *icem)

114 
Ë
 *le;

115 
”r
 = 0;

117 ià(!
iûm
)

118  
EINVAL
;

120 
Ë
 = 
iûm
->
rÿndl
.
h—d
;†&& !
”r
;†ğË->
Ãxt
) {

122 cÚ¡ 
iû_ÿnd
 *
rÿnd
 = 
Ë
->
d©a
;

124 
”r
 = 
	`»_h´štf
(
pf
, "%s%d %j %u",

125 
iûm
->
rÿndl
.
h—d
==
Ë
 ? "" : " ",

126 
rÿnd
->
compid
,

127 &
rÿnd
->
addr
, 
	`§_pÜt
(&rcand->addr));

130  
”r
;

131 
	}
}

137 
	$uäag_decode
(
iûm
 *iûm, cÚ¡ *
v®ue
)

139 *
uäag
 = 
NULL
;

140 
”r
;

142 
”r
 = 
	`¡r_dup
(&
uäag
, 
v®ue
);

143 ià(
”r
)

144  
”r
;

146 
	`mem_d”ef
(
iûm
->
ruäag
);

147 
iûm
->
ruäag
 = 
	`mem_»f
(
uäag
);

149 
	`mem_d”ef
(
uäag
);

152 
	}
}

155 
	$pwd_decode
(
iûm
 *iûm, cÚ¡ *
v®ue
)

157 *
pwd
 = 
NULL
;

158 
”r
;

160 
”r
 = 
	`¡r_dup
(&
pwd
, 
v®ue
);

161 ià(
”r
)

162  
”r
;

164 
	`mem_d”ef
(
iûm
->
½wd
);

165 
iûm
->
½wd
 = 
	`mem_»f
(
pwd
);

167 
	`mem_d”ef
(
pwd
);

170 
	}
}

173 
	$medŸ_uäag_decode
(
iûm
 *iûm, cÚ¡ *
v®ue
)

175 
iûm
->
ruäag
 = 
	`mem_d”ef
(icem->rufrag);

177  
	`¡r_dup
(&
iûm
->
ruäag
, 
v®ue
);

178 
	}
}

181 
	$medŸ_pwd_decode
(
iûm
 *iûm, cÚ¡ *
v®ue
)

183 
iûm
->
½wd
 = 
	`mem_d”ef
(icem->rpwd);

185  
	`¡r_dup
(&
iûm
->
½wd
, 
v®ue
);

186 
	}
}

189 
	$ÿnd_decode
(
iûm
 *iûm, cÚ¡ *
v®
)

191 
¶
 
found©iÚ
, 
compid
, 
Œª¥
, 
´io
, 
addr
, 
pÜt
, 
ÿnd_ty³
;

192 
¶
 
exŒa
 = 
¶_nuÎ
;

193 
§
 
ÿddr
, 
»l_addr
;

194 
ty³
[8];

195 
ušt8_t
 
cid
;

196 
”r
;

198 
	`§_š™
(&
»l_addr
, 
AF_INET
);

200 
”r
 = 
	`»_»gex
(
v®
, 
	`¡¾’
(val),

202 &
found©iÚ
, &
compid
, &
Œª¥
, &
´io
,

203 &
addr
, &
pÜt
, &
ÿnd_ty³
, &
exŒa
);

204 ià(
”r
)

205  
”r
;

207 ià(
ICE_TRANSP_NONE
 =ğ
	`Œª¥_»sŞve
(&
Œª¥
)) {

208 
	`DEBUG_NOTICE
("<%s> ignoring candidate with"

210 
iûm
->
Çme
, &
Œª¥
, &
ÿnd_ty³
, &
addr
);

214 ià(
	`¶_is£t
(&
exŒa
)) {

216 
¶
 
Çme
, 
v®ue
;

219 !
	`»_»gex
(
exŒa
.
p
,ƒxŒa.
l
, " [^ ]+ [^ ]+",

220 &
Çme
, &
v®ue
)) {

222 
	`¶_advªû
(&
exŒa
, 
v®ue
.
p
 + v®ue.
l
 -ƒxtra.p);

224 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
Çme
, 
»l_addr_¡r
)) {

225 
”r
 = 
	`§_£t
(&
»l_addr
, &
v®ue
,

226 
	`§_pÜt
(&
»l_addr
));

227 ià(
”r
)

230 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
Çme
, 
»l_pÜt_¡r
)) {

231 
	`§_£t_pÜt
(&
»l_addr
, 
	`¶_u32
(&
v®ue
));

236 
”r
 = 
	`§_£t
(&
ÿddr
, &
addr
, 
	`¶_u32
(&
pÜt
));

237 ià(
”r
)

238  
”r
;

240 
cid
 = 
	`¶_u32
(&
compid
);

243 ià(
	`iûm_ÿnd_fšd
(&
iûm
->
rÿndl
, 
cid
, &
ÿddr
))

246 ()
	`¶_¡rıy
(&
ÿnd_ty³
, 
ty³
, (type));

248  
	`iûm_rÿnd_add
(
iûm
, 
	`iû_ÿnd_Çme2ty³
(
ty³
), 
cid
,

249 
	`¶_u32
(&
´io
), &
ÿddr
, &
»l_addr
, &
found©iÚ
);

250 
	}
}

262 
	$iû_sdp_decode
(
iûm
 *iûm, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

264 ià(!
iûm
)

265  
EINVAL
;

267 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_l™e
)) {

268 ià(
ICE_MODE_LITE
 =ğ
iûm
->
lmode
) {

269 
	`DEBUG_WARNING
("we‡re†ite,…eer is‡lso†ite!\n");

270  
EPROTO
;

272 
iûm
->
rmode
 = 
ICE_MODE_LITE
;

273 
iûm
->
ÌŞe
 = 
ICE_ROLE_CONTROLLING
;

275 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_uäag
))

276  
	`uäag_decode
(
iûm
, 
v®ue
);

277 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_pwd
))

278  
	`pwd_decode
(
iûm
, 
v®ue
);

281 
	}
}

293 
	$iûm_sdp_decode
(
iûm
 *iûm, cÚ¡ *
Çme
, cÚ¡ *
v®ue
)

295 ià(!
iûm
)

296  
EINVAL
;

298 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_ÿnd
))

299  
	`ÿnd_decode
(
iûm
, 
v®ue
);

300 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_mism©ch
))

301 
iûm
->
mism©ch
 = 
Œue
;

302 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_uäag
))

303  
	`medŸ_uäag_decode
(
iûm
, 
v®ue
);

304 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
iû_©Œ_pwd
))

305  
	`medŸ_pwd_decode
(
iûm
, 
v®ue
);

308 
	}
}

311 cÚ¡ *
	$iû_tıty³_Çme
(
iû_tıty³
 
tıty³
)

313 
tıty³
) {

315 
ICE_TCP_ACTIVE
:  "active";

316 
ICE_TCP_PASSIVE
:  "passive";

317 
ICE_TCP_SO
:  "so";

320 
	}
}

323 
iû_tıty³
 
	$iû_tıty³_»sŞve
(cÚ¡ 
¶
 *pl)

325 ià(0 =ğ
	`¶_¡rÿ£cmp
(
¶
, "aùive")è 
ICE_TCP_ACTIVE
;

326 ià(0 =ğ
	`¶_¡rÿ£cmp
(
¶
, "·ssive")è 
ICE_TCP_PASSIVE
;

327 ià(0 =ğ
	`¶_¡rÿ£cmp
(
¶
, "so")è 
ICE_TCP_SO
;

329  (
iû_tıty³
)-1;

330 
	}
}

333 
	$iû_ÿnd_©Œ_’code
(
»_´štf
 *
pf
,

334 cÚ¡ 
iû_ÿnd_©Œ
 *
ÿnd
)

336 
”r
 = 0;

338 ià(!
ÿnd
)

341 
”r
 |ğ
	`»_h´štf
(
pf
, "%s %u %s %u %j %uyp %s",

342 
ÿnd
->
found©iÚ
, cªd->
compid
,

343 
	`Ãt_´Ùo2Çme
(
ÿnd
->
´Ùo
), cªd->
´io
,

344 &
ÿnd
->
addr
, 
	`§_pÜt
(&cand->addr),

345 
	`iû_ÿnd_ty³2Çme
(
ÿnd
->
ty³
));

347 ià(
	`§_is£t
(&
ÿnd
->
»l_addr
, 
SA_ADDR
))

348 
”r
 |ğ
	`»_h´štf
(
pf
, "„add¸%j", &
ÿnd
->
»l_addr
);

350 ià(
	`§_is£t
(&
ÿnd
->
»l_addr
, 
SA_PORT
))

351 
”r
 |ğ
	`»_h´štf
(
pf
, "„pÜˆ%u", 
	`§_pÜt
(&
ÿnd
->
»l_addr
));

353 ià(
ÿnd
->
´Ùo
 =ğ
IPPROTO_TCP
) {

354 
”r
 |ğ
	`»_h´štf
(
pf
, "cptype %s",

355 
	`iû_tıty³_Çme
(
ÿnd
->
tıty³
));

358  
”r
;

359 
	}
}

362 
	$iû_ÿnd_©Œ_decode
(
iû_ÿnd_©Œ
 *
ÿnd
, cÚ¡ *
v®
)

364 
¶
 
¶_âd
, 
¶_compid
, 
¶_Œª¥
, 
¶_´io
, 
¶_addr
, 
¶_pÜt
;

365 
¶
 
¶_ty³
, 
¶_¿ddr
, 
¶_½Üt
, 
¶_İt
 = 
PL_INIT
;

366 
size_t
 
Ën
;

367 
ty³
[8];

368 
”r
;

370 ià(!
ÿnd
 || !
v®
)

371  
EINVAL
;

373 
	`mem£t
(
ÿnd
, 0, (*cand));

375 
Ën
 = 
	`¡r_Ën
(
v®
);

377 
”r
 = 
	`»_»gex
(
v®
, 
Ën
,

380 &
¶_âd
, &
¶_compid
, &
¶_Œª¥
, &
¶_´io
,

381 &
¶_addr
, &
¶_pÜt
, &
¶_ty³
, &
¶_İt
);

382 ià(
”r
)

383  
”r
;

385 ()
	`¶_¡rıy
(&
¶_âd
, 
ÿnd
->
found©iÚ
, (cand->foundation));

387 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶_Œª¥
, "UDP"))

388 
ÿnd
->
´Ùo
 = 
IPPROTO_UDP
;

389 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
¶_Œª¥
, "TCP"))

390 
ÿnd
->
´Ùo
 = 
IPPROTO_TCP
;

392 
ÿnd
->
´Ùo
 = 0;

394 
”r
 = 
	`§_£t
(&
ÿnd
->
addr
, &
¶_addr
, 
	`¶_u32
(&
¶_pÜt
));

395 ià(
”r
)

396  
”r
;

398 
ÿnd
->
compid
 = 
	`¶_u32
(&
¶_compid
);

399 
ÿnd
->
´io
 = 
	`¶_u32
(&
¶_´io
);

401 ()
	`¶_¡rıy
(&
¶_ty³
, 
ty³
, (type));

403 
ÿnd
->
ty³
 = 
	`iû_ÿnd_Çme2ty³
(type);

407 ià(0 =ğ
	`»_»gex
(
¶_İt
.
p
,…l_İt.
l
, "raddr [^ ]+„port [0-9]+",

408 &
¶_¿ddr
, &
¶_½Üt
)) {

410 
”r
 = 
	`§_£t
(&
ÿnd
->
»l_addr
, &
¶_¿ddr
, 
	`¶_u32
(&
¶_½Üt
));

411 ià(
”r
)

412  
”r
;

415 ià(
ÿnd
->
´Ùo
 =ğ
IPPROTO_TCP
) {

417 
¶
 
tıty³
;

419 
”r
 = 
	`»_»gex
(
¶_İt
.
p
,…l_İt.
l
, "tcptype [^ ]+",

420 &
tıty³
);

421 ià(
”r
)

422  
”r
;

424 
ÿnd
->
tıty³
 = 
	`iû_tıty³_»sŞve
(&tcptype);

428 
	}
}

	@re-0.5.6/src/ice/icestr.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_tmr.h
>

11 
	~<»_§.h
>

12 
	~<»_¡un.h
>

13 
	~<»_iû.h
>

14 
	~"iû.h
"

17 cÚ¡ *
	$iû_ÿnd_ty³2Çme
(
iû_ÿnd_ty³
 
ty³
)

19 
ty³
) {

21 
ICE_CAND_TYPE_HOST
:  "host";

22 
ICE_CAND_TYPE_SRFLX
:  "srflx";

23 
ICE_CAND_TYPE_PRFLX
:  "prflx";

24 
ICE_CAND_TYPE_RELAY
:  "relay";

27 
	}
}

30 
iû_ÿnd_ty³
 
	$iû_ÿnd_Çme2ty³
(cÚ¡ *
Çme
)

32 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, "ho¡")è 
ICE_CAND_TYPE_HOST
;

33 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, "¤æx")è 
ICE_CAND_TYPE_SRFLX
;

34 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, "´æx")è 
ICE_CAND_TYPE_PRFLX
;

35 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, "»Ïy")è 
ICE_CAND_TYPE_RELAY
;

37  (
iû_ÿnd_ty³
)-1;

38 
	}
}

41 cÚ¡ *
	$iû_mode2Çme
(
iû_mode
 
mode
)

43 
mode
) {

45 
ICE_MODE_FULL
:  "Full";

46 
ICE_MODE_LITE
:  "Lite";

49 
	}
}

52 cÚ¡ *
	$iû_rŞe2Çme
(
iû_rŞe
 
rŞe
)

54 
rŞe
) {

56 
ICE_ROLE_UNKNOWN
:  "Unknown";

57 
ICE_ROLE_CONTROLLING
:  "Controlling";

58 
ICE_ROLE_CONTROLLED
:  "Controlled";

61 
	}
}

64 cÚ¡ *
	$iû_ÿnd·œ_¡©e2Çme
(
iû_ÿnd·œ_¡©e
 
¡
)

66 
¡
) {

68 
ICE_CANDPAIR_FROZEN
:  "Frozen";

69 
ICE_CANDPAIR_WAITING
:  "Waiting";

70 
ICE_CANDPAIR_INPROGRESS
:  "InProgress";

71 
ICE_CANDPAIR_SUCCEEDED
:  "Succeeded";

72 
ICE_CANDPAIR_FAILED
:  "Failed";

75 
	}
}

78 cÚ¡ *
	$iû_checkl_¡©e2Çme
(
iû_checkl_¡©e
 
c¡
)

80 
c¡
) {

82 
ICE_CHECKLIST_NULL
:  "(NULL)";

83 
ICE_CHECKLIST_RUNNING
:  "Running";

84 
ICE_CHECKLIST_COMPLETED
:  "Completed";

85 
ICE_CHECKLIST_FAILED
:  "Failed";

88 
	}
}

	@re-0.5.6/src/ice/stunsrv.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_tmr.h
>

13 
	~<»_§.h
>

14 
	~<»_¡un.h
>

15 
	~<»_iû.h
>

16 
	~<»_sys.h
>

17 
	~"iû.h
"

20 
	#DEBUG_MODULE
 "¡un¤v"

	)

21 
	#DEBUG_LEVEL
 5

	)

22 
	~<»_dbg.h
>

25 cÚ¡ *
	gsw
 = "iû stun¤v v" 
VERSION
 " (" 
ARCH
 "/" 
OS
 ")";

28 
	$Œigg”ed_check
(
iûm
 *iûm, 
iû_ÿnd
 *
lÿnd
,

29 
iû_ÿnd
 *
rÿnd
)

31 
iû_ÿnd·œ
 *
ı
 = 
NULL
;

32 
”r
;

34 ià(
lÿnd
 && 
rÿnd
)

35 
ı
 = 
	`iûm_ÿnd·œ_fšd
(&
iûm
->
checkl
, 
lÿnd
, 
rÿnd
);

37 ià(
ı
) {

39 
ı
->
¡©e
) {

48 
ICE_CANDPAIR_INPROGRESS
:

49 
	`iûm_ÿnd·œ_ÿnûl
(
ı
);

53 
ICE_CANDPAIR_FAILED
:

54 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_WAITING
);

57 
ICE_CANDPAIR_FROZEN
:

58 
ICE_CANDPAIR_WAITING
:

59 
”r
 = 
	`iûm_cÚncheck_£nd
(
ı
, 
çl£
, 
Œue
);

60 ià(
”r
) {

61 
	`DEBUG_WARNING
("triggered check failed\n");

65 
ICE_CANDPAIR_SUCCEEDED
:

73 
”r
 = 
	`iûm_ÿnd·œ_®loc
(&
ı
, 
iûm
, 
lÿnd
, 
rÿnd
);

74 ià(
”r
) {

75 
	`DEBUG_WARNING
("failedo‡llocate candpair:"

77 
lÿnd
, 
rÿnd
, 
”r
);

81 
	`iûm_ÿnd·œ_´io_Üd”
(&
iûm
->
checkl
);

83 
	`iûm_ÿnd·œ_£t_¡©e
(
ı
, 
ICE_CANDPAIR_WAITING
);

85 ()
	`iûm_cÚncheck_£nd
(
ı
, 
çl£
, 
Œue
);

89 
	}
}

95 
	$hªdË_¡un_fuÎ
(
iûm
 *icem,

96 
iûm_comp
 *
comp
, cÚ¡ 
§
 *
¤c
,

97 
ušt32_t
 
´io
, 
boŞ
 
u£_ÿnd
, boŞ 
tuÂ–
)

99 
iû_ÿnd
 *
lÿnd
 = 
NULL
, *
rÿnd
;

100 
iû_ÿnd·œ
 *
ı
 = 
NULL
;

101 
”r
;

103 
rÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
rÿndl
, 
comp
->
id
, 
¤c
);

104 ià(!
rÿnd
) {

105 
”r
 = 
	`iûm_rÿnd_add_´æx
(&
rÿnd
, 
iûm
, 
comp
->
id
, 
´io
, 
¤c
);

106 ià(
”r
)

107  
”r
;

110 
ı
 = 
	`iûm_ÿnd·œ_fšd_rÿnd
(
iûm
, 
rÿnd
);

111 ià(
ı
)

112 
lÿnd
 = 
ı
->lcand;

114 
lÿnd
 = 
	`iûm_lÿnd_fšd_checkli¡
(
iûm
, 
comp
->
id
);

116 ià(!
lÿnd
) {

117 
	`DEBUG_WARNING
("{%s.%u}†ocal candidate‚ot found"

119 
iûm
->
Çme
, 
comp
->
id
,

120 
	`li¡_couÁ
(&
iûm
->
checkl
), 
¤c
);

124 
	`Œigg”ed_check
(
iûm
, 
lÿnd
, 
rÿnd
);

126 ià(!
ı
) {

127 
ı
 = 
	`iûm_ÿnd·œ_fšd_rÿnd
(
iûm
, 
rÿnd
);

128 ià(!
ı
) {

129 
	`DEBUG_WARNING
("{%s.%u} candidate…air‚ot found:"

131 
iûm
->
Çme
, 
comp
->
id
, 
¤c
);

136 #ià
ICE_TRACE


137 
	`iûcomp_´štf
(
comp
, "Rx Binding Request from %J via %s"

139 
¤c
, 
tuÂ–
 ? "Tunnel" : "Socket",

140 
ı
 ? 
	`iû_ÿnd·œ_¡©e2Çme
(ı->
¡©e
) : "n/a",

141 
u£_ÿnd
 ? "[USE]" : "");

143 ()
tuÂ–
;

147 ià(
u£_ÿnd
) {

148 ià(
iûm
->
ÌŞe
 =ğ
ICE_ROLE_CONTROLLED
 &&

149 
ı
->
¡©e
 =ğ
ICE_CANDPAIR_SUCCEEDED
) {

151 ià(!
ı
->
nomš©ed
) {

152 
	`iûcomp_´štf
(
comp
, "setting NOMINATED"

154 
iûm_ÿnd·œ_debug
, 
ı
);

157 
ı
->
nomš©ed
 = 
Œue
;

161 
	`iûm_ÿnd·œ_make_v®id
(
ı
);

163 ià(
iûm
->
cÚf
.
nom
 =ğ
ICE_NOMINATION_REGULAR
) {

164 
	`iûm_ÿnd·œ_ÿnûl
(
ı
);

165 
	`iûm_comp_£t_£Ëùed
(
comp
, 
ı
);

170 
	}
}

176 
	$hªdË_¡un_l™e
(
iûm
 *icem,

177 
iûm_comp
 *
comp
, cÚ¡ 
§
 *
¤c
,

178 
boŞ
 
u£_ÿnd
)

180 
iû_ÿnd
 *
lÿnd
, *
rÿnd
;

181 
iû_ÿnd·œ
 *
ı
;

182 
”r
;

184 ià(!
u£_ÿnd
)

187 
rÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
rÿndl
, 
comp
->
id
, 
¤c
);

188 ià(!
rÿnd
) {

189 
	`DEBUG_WARNING
("lite: could‚ot find„emote candidate\n");

194 
lÿnd
 = 
	`iûm_ÿnd_fšd
(&
iûm
->
lÿndl
, 
comp
->
id
, 
NULL
);

195 ià(!
lÿnd
) {

196 
	`DEBUG_WARNING
("lite: could‚ot find†ocal candidate\n");

201 ià(
	`iûm_ÿnd·œ_fšd
(&
iûm
->
v®idl
, 
lÿnd
, 
rÿnd
))

204 
”r
 = 
	`iûm_ÿnd·œ_®loc
(&
ı
, 
iûm
, 
lÿnd
, 
rÿnd
);

205 ià(
”r
) {

206 
	`DEBUG_WARNING
("lite: failedo created candidate…air\n");

207  
”r
;

210 
	`iûm_ÿnd·œ_make_v®id
(
ı
);

211 
ı
->
nomš©ed
 = 
Œue
;

214 
	}
}

217 
	$¡un¤v_”•ly
(
iûm_comp
 *
comp
, cÚ¡ 
§
 *
¤c
,

218 
size_t
 
´esz
, cÚ¡ 
¡un_msg
 *
»q
,

219 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

221 
iûm
 *iûm = 
comp
->icem;

223  
	`¡un_”•ly
(
iûm
->
´Ùo
, 
comp
->
sock
, 
¤c
, 
´esz
, 
»q
,

224 
scode
, 
»asÚ
,

225 (
ušt8_t
 *)
iûm
->
Íwd
, 
	`¡¾’
(iûm->Íwd), 
Œue
, 1,

226 
STUN_ATTR_SOFTWARE
, 
sw
);

227 
	}
}

230 
	$iûm_¡und_»cv
(
iûm_comp
 *
comp
, cÚ¡ 
§
 *
¤c
,

231 
¡un_msg
 *
»q
, 
size_t
 
´esz
)

233 
iûm
 *iûm = 
comp
->icem;

234 
¡un_©Œ
 *
©Œ
;

235 
¶
 
lu
, 
ru
;

236 
iû_rŞe
 
¼Şe
 = 
ICE_ROLE_UNKNOWN
;

237 
ušt64_t
 
t›brk
 = 0;

238 
ušt32_t
 
´io_´æx
;

239 
boŞ
 
u£_ÿnd
 = 
çl£
;

240 
”r
;

243 
”r
 = 
	`¡un_msg_chk_fšg”´št
(
»q
);

244 ià(
”r
)

245  
”r
;

247 
”r
 = 
	`¡un_msg_chk_mi
(
»q
, (
ušt8_t
 *)
iûm
->
Íwd
, 
	`¡¾’
(icem->lpwd));

248 ià(
”r
) {

249 ià(
”r
 =ğ
EBADMSG
)

250 
uÇuth
;

252 
badmsg
;

255 
©Œ
 = 
	`¡un_msg_©Œ
(
»q
, 
STUN_ATTR_USERNAME
);

256 ià(!
©Œ
)

257 
badmsg
;

259 
”r
 = 
	`»_»gex
(
©Œ
->
v
.
u£ºame
, 
	`¡¾’
(attr->v.username),

260 "[^:]+:[^]+", &
lu
, &
ru
);

261 ià(
”r
) {

262 
	`DEBUG_WARNING
("could‚ot…arse USERNAME‡ttribute (%s)\n",

263 
©Œ
->
v
.
u£ºame
);

264 
uÇuth
;

266 ià(
	`¶_¡rcmp
(&
lu
, 
iûm
->
luäag
))

267 
uÇuth
;

268 ià(
	`¡r_is£t
(
iûm
->
ruäag
è&& 
	`¶_¡rcmp
(&
ru
, icem->rufrag))

269 
uÇuth
;

271 
©Œ
 = 
	`¡un_msg_©Œ
(
»q
, 
STUN_ATTR_CONTROLLED
);

272 ià(
©Œ
) {

273 
¼Şe
 = 
ICE_ROLE_CONTROLLED
;

274 
t›brk
 = 
©Œ
->
v
.
ušt64
;

277 
©Œ
 = 
	`¡un_msg_©Œ
(
»q
, 
STUN_ATTR_CONTROLLING
);

278 ià(
©Œ
) {

279 
¼Şe
 = 
ICE_ROLE_CONTROLLING
;

280 
t›brk
 = 
©Œ
->
v
.
ušt64
;

283 ià(
¼Şe
 =ğ
iûm
->
ÌŞe
) {

284 ià(
iûm
->
t›brk
 >=iebrk)

285 
	`iû_sw™ch_loÿl_rŞe
(
iûm
);

287 
cÚæiù
;

290 
©Œ
 = 
	`¡un_msg_©Œ
(
»q
, 
STUN_ATTR_PRIORITY
);

291 ià(
©Œ
)

292 
´io_´æx
 = 
©Œ
->
v
.
ušt32
;

294 
badmsg
;

296 
©Œ
 = 
	`¡un_msg_©Œ
(
»q
, 
STUN_ATTR_USE_CAND
);

297 ià(
©Œ
)

298 
u£_ÿnd
 = 
Œue
;

300 ià(
iûm
->
lmode
 =ğ
ICE_MODE_FULL
) {

301 
”r
 = 
	`hªdË_¡un_fuÎ
(
iûm
, 
comp
, 
¤c
, 
´io_´æx
,

302 
u£_ÿnd
, 
´esz
 > 0);

305 
”r
 = 
	`hªdË_¡un_l™e
(
iûm
, 
comp
, 
¤c
, 
u£_ÿnd
);

308 ià(
”r
)

309 
badmsg
;

311  
	`¡un_»¶y
(
iûm
->
´Ùo
, 
comp
->
sock
, 
¤c
, 
´esz
, 
»q
,

312 (
ušt8_t
 *)
iûm
->
Íwd
, 
	`¡¾’
(iûm->Íwd), 
Œue
, 2,

313 
STUN_ATTR_XOR_MAPPED_ADDR
, 
¤c
,

314 
STUN_ATTR_SOFTWARE
, 
sw
);

316 
badmsg
:

317  
	`¡un¤v_”•ly
(
comp
, 
¤c
, 
´esz
, 
»q
, 400, "Bad Request");

319 
uÇuth
:

320  
	`¡un¤v_”•ly
(
comp
, 
¤c
, 
´esz
, 
»q
, 401, "Unauthorized");

322 
cÚæiù
:

323  
	`¡un¤v_”•ly
(
comp
, 
¤c
, 
´esz
, 
»q
, 487, "Role Conflict");

324 
	}
}

	@re-0.5.6/src/ice/util.c

6 
	~<¡ršg.h
>

7 #ifdeà
HAVE_SYS_TIME_H


8 
	~<sys/time.h
>

10 #iâdeà
WIN32


11 
	~<time.h
>

13 
	~<»_ty³s.h
>

14 
	~<»_fmt.h
>

15 
	~<»_mem.h
>

16 
	~<»_mbuf.h
>

17 
	~<»_li¡.h
>

18 
	~<»_tmr.h
>

19 
	~<»_§.h
>

20 
	~<»_¡un.h
>

21 
	~<»_sys.h
>

22 
	~<»_iû.h
>

23 
	~"iû.h
"

26 
	#DEBUG_MODULE
 "iûut"

	)

27 
	#DEBUG_LEVEL
 5

	)

28 
	~<»_dbg.h
>

32 
	mCAND_PRIO_RELAY
 = 0,

33 
	mCAND_PRIO_SRFLX
 = 100,

34 
	mCAND_PRIO_PRFLX
 = 110,

35 
	mCAND_PRIO_HOST
 = 126

39 
ušt32_t
 
	$ty³_´io
(
iû_ÿnd_ty³
 
ty³
)

41 
ty³
) {

43 
ICE_CAND_TYPE_HOST
:  
CAND_PRIO_HOST
;

44 
ICE_CAND_TYPE_SRFLX
:  
CAND_PRIO_SRFLX
;

45 
ICE_CAND_TYPE_PRFLX
:  
CAND_PRIO_PRFLX
;

46 
ICE_CAND_TYPE_RELAY
:  
CAND_PRIO_RELAY
;

49 
	}
}

52 
ušt32_t
 
	$iû_ÿnd_ÿlc_´io
(
iû_ÿnd_ty³
 
ty³
, 
ušt16_t
 
loÿl
,

53 
compid
)

55  
	`ty³_´io
(
ty³
)<<24 | (
ušt32_t
)
loÿl
<<8 | (256 - 
compid
);

56 
	}
}

66 
ušt64_t
 
	$iû_ÿlc_·œ_´io
(
ušt32_t
 
g
, ušt32_ˆ
d
)

68 cÚ¡ 
ušt64_t
 
m
 = 
	`mš
(
g
, 
d
);

69 cÚ¡ 
ušt64_t
 
x
 = 
	`max
(
g
, 
d
);

71  (
m
<<32è+ 2*
x
 + (
g
>
d
?1:0);

72 
	}
}

75 
	$iû_sw™ch_loÿl_rŞe
(
iûm
 *icem)

77 
iû_rŞe
 
Ãw_rŞe
;

79 ià(
ICE_ROLE_CONTROLLING
 =ğ
iûm
->
ÌŞe
)

80 
Ãw_rŞe
 = 
ICE_ROLE_CONTROLLED
;

82 
Ãw_rŞe
 = 
ICE_ROLE_CONTROLLING
;

84 
	`DEBUG_NOTICE
("Switch†ocal„ole from %so %s\n",

85 
	`iû_rŞe2Çme
(
iûm
->
ÌŞe
), iû_rŞe2Çme(
Ãw_rŞe
));

87 
iûm
->
ÌŞe
 = 
Ãw_rŞe
;

91 
Ë
 = 
iûm
->Ë.
li¡
->
h—d
;†e;†ğË->
Ãxt
) {

92 
iûm
 = 
Ë
->
d©a
;

93 
	`iûm_ÿnd·œ_´io_Üd”
(&
iûm
->
checkl
);

96 
	}
}

109 
ušt32_t
 
	$iû_li¡_unique
(
li¡
 *li¡, 
li¡_unique_h
 *
uh
)

111 
Ë
 *
Ë1
 = 
	`li¡_h—d
(
li¡
);

112 
ušt32_t
 
n
 = 0;

114 
Ë1
 &&†e1 !ğ
li¡
->

) {

116 
Ë
 *
Ë2
 = 
Ë1
->
Ãxt
;

117 *
d©a
 = 
NULL
;

119 
Ë2
) {

121 
d©a
 = 
	`uh
(
Ë1
, 
Ë2
);

123 
Ë2
 =†e2->
Ãxt
;

125 ià(!
d©a
)

128 ià(
Ë1
->
d©a
 == data)

131 
d©a
 = 
	`mem_d”ef
(data);

132 ++
n
;

136 
Ë1
 =†e1->
Ãxt
;

138 ià(
d©a
) {

139 
	`mem_d”ef
(
d©a
);

140 ++
n
;

144  
n
;

145 
	}
}

	@re-0.5.6/src/jbuf/jbuf.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_mem.h
>

11 
	~<»_¹p.h
>

12 
	~<»_jbuf.h
>

15 
	#DEBUG_MODULE
 "jbuf"

	)

16 
	#DEBUG_LEVEL
 5

	)

17 
	~<»_dbg.h
>

20 #iâdeà
RELEASE


21 
	#JBUF_STAT
 1

	)

25 #ià
JBUF_STAT


26 
	#STAT_ADD
(
v¬
, 
v®ue
è(
jb
->
¡©
.v¬è+ğ(v®ueè

	)

27 
	#STAT_INC
(
v¬
è++(
jb
->
¡©
.v¬è

	)

29 
	#STAT_ADD
(
v¬
, 
v®ue
)

	)

30 
	#STAT_INC
(
v¬
)

	)

35 
	säame
 {

36 
Ë
 
	mË
;

37 
¹p_h—d”
 
	mhdr
;

38 *
	mmem
;

48 
	sjbuf
 {

49 
li¡
 
	mpoŞl
;

50 
li¡
 
	mäam–
;

51 
ušt32_t
 
	mn
;

52 
ušt32_t
 
	mmš
;

53 
ušt32_t
 
	mmax
;

54 
ušt16_t
 
	m£q_put
;

55 
boŞ
 
	mruÂšg
;

57 #ià
JBUF_STAT


58 
ušt16_t
 
	m£q_g‘
;

59 
jbuf_¡©
 
	m¡©
;

65 
šlše
 
boŞ
 
	$£q_Ëss
(
ušt16_t
 
x
, ušt16_ˆ
y
)

67  ((
št16_t
)(
x
 - 
y
)) < 0;

68 
	}
}

74 
	$äame_®loc
(
jbuf
 *
jb
, 
äame
 **
f
)

76 
Ë
 *le;

78 
Ë
 = 
jb
->
poŞl
.
h—d
;

79 ià(
Ë
) {

80 
	`li¡_uÆšk
(
Ë
);

81 ++
jb
->
n
;

84 
äame
 *
f0
;

87 
Ë
 = 
jb
->
äam–
.
h—d
;

88 
f0
 = 
Ë
->
d©a
;

90 
	`STAT_INC
(
n_ov”æow
);

91 
	`DEBUG_INFO
("drop 1 old frame seq=%u (total dropped %u)\n",

92 
f0
->
hdr
.
£q
, 
jb
->
¡©
.
n_ov”æow
);

94 
f0
->
mem
 = 
	`mem_d”ef
(f0->mem);

95 
	`li¡_uÆšk
(
Ë
);

98 *
f
 = 
Ë
->
d©a
;

99 
	}
}

105 
	$äame_d”ef
(
jbuf
 *
jb
, 
äame
 *
f
)

107 
f
->
mem
 = 
	`mem_d”ef
(f->mem);

108 
	`li¡_uÆšk
(&
f
->
Ë
);

109 
	`li¡_­³nd
(&
jb
->
poŞl
, &
f
->
Ë
, f);

110 --
jb
->
n
;

111 
	}
}

114 
	$jbuf_de¡ruùÜ
(*
d©a
)

116 
jbuf
 *
jb
 = 
d©a
;

118 
	`jbuf_æush
(
jb
);

121 
	`li¡_æush
(&
jb
->
poŞl
);

122 
	}
}

134 
	$jbuf_®loc
(
jbuf
 **
jbp
, 
ušt32_t
 
mš
, ušt32_ˆ
max
)

136 
jbuf
 *
jb
;

137 
ušt32_t
 
i
;

138 
”r
 = 0;

140 ià(!
jbp
 || ( 
mš
 > 
max
))

141  
EINVAL
;

143 
	`DEBUG_INFO
("®loc: d–ay=%u-%u f¿mes\n", 
mš
, 
max
);

146 ià(!
	`£q_Ëss
(10, 20) || seq_less(20, 10) || !seq_less(65535, 0)) {

147 
	`DEBUG_WARNING
("seq_less() is broken\n");

148  
ENOSYS
;

151 
jb
 = 
	`mem_z®loc
((*jb), 
jbuf_de¡ruùÜ
);

152 ià(!
jb
)

153  
ENOMEM
;

155 
	`li¡_š™
(&
jb
->
poŞl
);

156 
	`li¡_š™
(&
jb
->
äam–
);

158 
jb
->
mš
 = min;

159 
jb
->
max
 = max;

162 
i
=0; i<
jb
->
max
; i++) {

163 
äame
 *
f
 = 
	`mem_z®loc
((*f), 
NULL
);

164 ià(!
f
) {

165 
”r
 = 
ENOMEM
;

169 
	`li¡_­³nd
(&
jb
->
poŞl
, &
f
->
Ë
, f);

170 
	`DEBUG_INFO
("®loc:‡ddšgØpoŞ†i¡ %u\n", 
i
);

173 ià(
”r
)

174 
	`mem_d”ef
(
jb
);

176 *
jbp
 = 
jb
;

178  
”r
;

179 
	}
}

191 
	$jbuf_put
(
jbuf
 *
jb
, cÚ¡ 
¹p_h—d”
 *
hdr
, *
mem
)

193 
äame
 *
f
;

194 
Ë
 *Ë, *

;

195 
ušt16_t
 
£q
;

196 
”r
 = 0;

198 ià(!
jb
 || !
hdr
)

199  
EINVAL
;

201 
£q
 = 
hdr
->seq;

203 
	`STAT_INC
(
n_put
);

205 ià(
jb
->
ruÂšg
) {

208 ià(
	`£q_Ëss
((
£q
 + 
jb
->
n
), jb->
£q_put
)) {

209 
	`STAT_INC
(
n_Ï‹
);

210 
	`DEBUG_INFO
("packetoo†ate: seq=%u (seq_put=%u)\n",

211 
£q
, 
jb
->
£q_put
);

212  
ETIMEDOUT
;

216 
	`äame_®loc
(
jb
, &
f
);

218 

 = 
jb
->
äam–
.tail;

223 ià(!

 || 
	`£q_Ëss
(((
äame
 *éa->
d©a
)->
hdr
.
£q
, seq)) {

224 
	`li¡_­³nd
(&
jb
->
äam–
, &
f
->
Ë
, f);

225 
out
;

229 
Ë
 = 

;†e;†ğË->
´ev
) {

230 cÚ¡ 
ušt16_t
 
£q_Ë
 = ((
äame
 *)
Ë
->
d©a
)->
hdr
.
£q
;

232 ià(
	`£q_Ëss
(
£q_Ë
, 
£q
)) {

233 
	`DEBUG_INFO
("put: out-of-sequence"

235 
£q_Ë
, 
£q
);

236 
	`li¡_š£¹_aá”
(&
jb
->
äam–
, 
Ë
, &
f
->le, f);

239 ià(
£q
 =ğ
£q_Ë
) {

241 
	`DEBUG_INFO
("du¶iÿ‹: seq=%u\n", 
£q
);

242 
	`STAT_INC
(
n_dups
);

243 
	`li¡_š£¹_aá”
(&
jb
->
äam–
, 
Ë
, &
f
->le, f);

244 
	`äame_d”ef
(
jb
, 
f
);

245  
EALREADY
;

252 ià(!
Ë
) {

253 
	`DEBUG_INFO
("put: out-of-sequence"

254 " -…uˆš h—d (£q=%u)\n", 
£q
);

255 
	`li¡_´•’d
(&
jb
->
äam–
, &
f
->
Ë
, f);

258 
	`STAT_INC
(
n_oos
);

260 
out
:

262 
jb
->
ruÂšg
 = 
Œue
;

263 
jb
->
£q_put
 = 
£q
;

266 
f
->
hdr
 = *hdr;

267 
f
->
mem
 = 
	`mem_»f
(mem);

269  
”r
;

270 
	}
}

282 
	$jbuf_g‘
(
jbuf
 *
jb
, 
¹p_h—d”
 *
hdr
, **
mem
)

284 
äame
 *
f
;

286 ià(!
jb
 || !
hdr
 || !
mem
)

287  
EINVAL
;

289 
	`STAT_INC
(
n_g‘
);

291 ià(
jb
->
n
 <ğjb->
mš
 || !jb->
äam–
.
h—d
) {

292 
	`DEBUG_INFO
("notƒnough buffer frames - wait.. (n=%u min=%u)\n",

293 
jb
->
n
, jb->
mš
);

294 
	`STAT_INC
(
n_und”æow
);

295  
ENOENT
;

302 
f
 = 
jb
->
äam–
.
h—d
->
d©a
;

304 #ià
JBUF_STAT


306 ià(
jb
->
£q_g‘
) {

307 cÚ¡ 
št16_t
 
£q_diff
 = 
f
->
hdr
.
£q
 - 
jb
->
£q_g‘
;

308 ià(
	`£q_Ëss
(
f
->
hdr
.
£q
, 
jb
->
£q_g‘
)) {

309 
	`DEBUG_WARNING
("g‘: seq=%uoØÏ‹\n", 
f
->
hdr
.
£q
);

311 ià(
£q_diff
 > 1) {

312 
	`STAT_ADD
(
n_lo¡
, 1);

313 
	`DEBUG_INFO
("get:‚_lost: diff=%d,seq=%u,seq_get=%u\n",

314 
£q_diff
, 
f
->
hdr
.
£q
, 
jb
->
£q_g‘
);

319 
jb
->
£q_g‘
 = 
f
->
hdr
.
£q
;

322 *
hdr
 = 
f
->hdr;

323 *
mem
 = 
	`mem_»f
(
f
->mem);

325 
	`äame_d”ef
(
jb
, 
f
);

328 
	}
}

336 
	$jbuf_æush
(
jbuf
 *
jb
)

338 
Ë
 *le;

340 ià(!
jb
)

343 ià(
jb
->
äam–
.
h—d
) {

344 
	`DEBUG_INFO
("æush: %u f¿mes\n", 
jb
->
n
);

348 
Ë
 = 
jb
->
äam–
.
h—d
;†e;†e = jb->framel.head) {

349 
	`DEBUG_INFO
(" flush frame: seq=%u\n",

350 ((
äame
 *)(
Ë
->
d©a
))->
hdr
.
£q
);

352 
	`äame_d”ef
(
jb
, 
Ë
->
d©a
);

355 
jb
->
n
 = 0;

356 
jb
->
ruÂšg
 = 
çl£
;

358 
	`STAT_INC
(
n_æush
);

359 
	}
}

370 
	$jbuf_¡©s
(cÚ¡ 
jbuf
 *
jb
, 
jbuf_¡©
 *
j¡©
)

372 ià(!
jb
 || !
j¡©
)

373  
EINVAL
;

375 #ià
JBUF_STAT


376 *
j¡©
 = 
jb
->
¡©
;

380  
ENOSYS
;

382 
	}
}

393 
	$jbuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
jbuf
 *
jb
)

395 
”r
 = 0;

397 ià(!
jb
)

400 
”r
 |ğ
	`»_h´štf
(
pf
, "--- jitter buffer debug---\n");

402 
”r
 |ğ
	`»_h´štf
(
pf
, "„uÂšg=%d", 
jb
->
ruÂšg
);

403 
”r
 |ğ
	`»_h´štf
(
pf
, " min=%u cur=%u max=%u [frames]\n",

404 
jb
->
mš
, jb->
n
, jb->
max
);

405 
”r
 |ğ
	`»_h´štf
(
pf
, " seq_put=%u\n", 
jb
->
£q_put
);

407 #ià
JBUF_STAT


408 
”r
 |ğ
	`»_h´štf
(
pf
, " St:…ut=%u", 
jb
->
¡©
.
n_put
);

409 
”r
 |ğ
	`»_h´štf
(
pf
, " g‘=%u", 
jb
->
¡©
.
n_g‘
);

410 
”r
 |ğ
	`»_h´štf
(
pf
, " oos=%u", 
jb
->
¡©
.
n_oos
);

411 
”r
 |ğ
	`»_h´štf
(
pf
, " dup=%u", 
jb
->
¡©
.
n_dups
);

412 
”r
 |ğ
	`»_h´štf
(
pf
, "†©e=%u", 
jb
->
¡©
.
n_Ï‹
);

413 
”r
 |ğ
	`»_h´štf
(
pf
, " or=%u", 
jb
->
¡©
.
n_ov”æow
);

414 
”r
 |ğ
	`»_h´štf
(
pf
, " ur=%u", 
jb
->
¡©
.
n_und”æow
);

415 
”r
 |ğ
	`»_h´štf
(
pf
, " flush=%u", 
jb
->
¡©
.
n_æush
);

416 
”r
 |ğ
	`»_h´štf
(
pf
, "…ut/g‘_¿tio=%u%%", 
jb
->
¡©
.
n_g‘
 ?

417 100*
jb
->
¡©
.
n_put
/jb->¡©.
n_g‘
 : 0);

418 
”r
 |ğ
	`»_h´štf
(
pf
, "†ost=%u (%u.%02u%%)\n",

419 
jb
->
¡©
.
n_lo¡
,

420 
jb
->
¡©
.
n_put
 ?

421 100*
jb
->
¡©
.
n_lo¡
/jb->¡©.
n_put
 : 0,

422 
jb
->
¡©
.
n_put
 ?

423 10000*
jb
->
¡©
.
n_lo¡
/jb->¡©.
n_put
%100 : 0);

426  
”r
;

427 
	}
}

	@re-0.5.6/src/json/decode.c

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_odiù.h
>

13 
	~<»_jsÚ.h
>

16 
šlše
 
	$mypow”10
(
ušt64_t
 
e
)

18 
p
 = 10, 
n
 = 1;

20 
e
 > 0) {

21 ià(
e
 & 1)

22 
n
 *ğ
p
;

24 
p
 *=…;

25 
e
 >>= 1;

28  
n
;

29 
	}
}

32 
boŞ
 
	$is_¡ršg
(
¶
 *
c
, const pl *pl)

34 ià(
¶
->
l
 < 2)

35  
çl£
;

37 ià(
¶
->
p
[0] !ğ'"'||…l->p[¶->
l
-1] != '"')

38  
çl£
;

40 
c
->
p
 = 
¶
->p + 1;

41 
c
->
l
 = 
¶
->l - 2;

43  
Œue
;

44 
	}
}

47 
boŞ
 
	$is_numb”
(*
d
, 
boŞ
 *
isæßt
, cÚ¡ 
¶
 *pl)

49 
boŞ
 
Ãg
 = 
çl£
, 
pos
 = f®£, 
äac
 = f®£, 
exp
 = false;

50 
v
 = 0, 
mul
 = 1;

51 cÚ¡ *
p
;

52 
št64_t
 
e
 = 0;

54 ià(!
¶
->
l
)

55  
çl£
;

57 
p
 = &
¶
->p[¶->
l
];

59 
p
 > 
¶
->p) {

61 cÚ¡ 
ch
 = *--
p
;

63 ià(
ch
 == 'e' || ch == 'E') {

65 ià(
exp
 || 
äac
)

66  
çl£
;

68 
exp
 = 
Œue
;

69 
e
 = 
Ãg
 ? -
v
 : v;

70 
v
 = 0;

71 
mul
 = 1;

72 
Ãg
 = 
çl£
;

73 
pos
 = 
çl£
;

75 ià(
pos
 || 
Ãg
) {

76  
çl£
;

78 ià(
ch
 == '.') {

80 ià(
äac
)

81  
çl£
;

83 
äac
 = 
Œue
;

84 
v
 /ğ
mul
;

85 
mul
 = 1;

87 ià('0' <ğ
ch
 && ch <= '9') {

88 
v
 +ğ
mul
 * (
ch
 - '0');

89 
mul
 *= 10;

91 ià(
ch
 == '-') {

92 
Ãg
 = 
Œue
;

94 ià(
ch
 == '+') {

95 
pos
 = 
Œue
;

98  
çl£
;

102 *
isæßt
 = (
äac
 || 
exp
);

104 ià(
exp
) {

105 ià(
e
 < 0)

106 
v
 /ğ
	`mypow”10
(-
e
);

108 
v
 *ğ
	`mypow”10
(
e
);

111 ià(
Ãg
)

112 
v
 = -v;

114 *
d
 = 
v
;

116  
Œue
;

117 
	}
}

120 
	$decode_Çme
(**
¡r
, cÚ¡ 
¶
 *pl)

122 
¶
 
¶s
;

124 ià(!
¶
->
p
)

125  
EBADMSG
;

127 ià(!
	`is_¡ršg
(&
¶s
, 
¶
))

128  
EBADMSG
;

130  
	`»_sd´štf
(
¡r
, "%H", 
utf8_decode
, &
¶s
);

131 
	}
}

134 
	$decode_v®ue
(
jsÚ_v®ue
 *
v®
, cÚ¡ 
¶
 *pl)

136 
dbl
;

137 
¶
 
¶s
;

138 
boŞ
 
isæßt
;

139 
”r
 = 0;

141 ià(!
¶
->
p
)

142  
EBADMSG
;

144 ià(
	`is_¡ršg
(&
¶s
, 
¶
)) {

146 
”r
 = 
	`»_sd´štf
(&
v®
->
v
.
¡r
, "%H", 
utf8_decode
, &
¶s
);

147 
v®
->
ty³
 = 
JSON_STRING
;

149 ià(
	`is_numb”
(&
dbl
, &
isæßt
, 
¶
)) {

151 ià(
isæßt
) {

152 
v®
->
ty³
 = 
JSON_DOUBLE
;

153 
v®
->
v
.
dbl
 = dbl;

156 
v®
->
ty³
 = 
JSON_INT
;

157 
v®
->
v
.
š‹g”
 = 
dbl
;

160 ià(!
	`¶_¡rÿ£cmp
(
¶
, "false")) {

162 
v®
->
v
.
boŞ—n
 = 
çl£
;

163 
v®
->
ty³
 = 
JSON_BOOL
;

165 ià(!
	`¶_¡rÿ£cmp
(
¶
, "true")) {

167 
v®
->
v
.
boŞ—n
 = 
Œue
;

168 
v®
->
ty³
 = 
JSON_BOOL
;

170 ià(!
	`¶_¡rÿ£cmp
(
¶
, "null")) {

172 
v®
->
ty³
 = 
JSON_NULL
;

175 
	`»_´štf
("jsÚ: v®uoàunknowÀty³: <%r>\n", 
¶
);

176 
”r
 = 
EBADMSG
;

179  
”r
;

180 
	}
}

183 
	$objeù_’Œy
(cÚ¡ 
¶
 *
¶_Çme
, cÚ¡ ¶ *
¶_v®
,

184 
jsÚ_objeù_’Œy_h
 *
Ûh
, *
¬g
)

186 
jsÚ_v®ue
 
v®
;

187 *
Çme
;

188 
”r
;

190 
”r
 = 
	`decode_Çme
(&
Çme
, 
¶_Çme
);

191 ià(
”r
)

192  
”r
;

194 
”r
 = 
	`decode_v®ue
(&
v®
, 
¶_v®
);

195 ià(
”r
)

196 
out
;

198 ià(
Ûh
)

199 
”r
 = 
	`Ûh
(
Çme
, &
v®
, 
¬g
);

201 ià(
v®
.
ty³
 =ğ
JSON_STRING
)

202 
	`mem_d”ef
(
v®
.
v
.
¡r
);

204 
out
:

205 
	`mem_d”ef
(
Çme
);

207  
”r
;

208 
	}
}

211 
	$¬¿y_’Œy
(
idx
, cÚ¡ 
¶
 *
¶_v®
,

212 
jsÚ_¬¿y_’Œy_h
 *
«h
, *
¬g
)

214 
jsÚ_v®ue
 
v®
;

215 
”r
;

217 
”r
 = 
	`decode_v®ue
(&
v®
, 
¶_v®
);

218 ià(
”r
)

219  
”r
;

221 ià(
«h
)

222 
”r
 = 
	`«h
(
idx
, &
v®
, 
¬g
);

224 ià(
v®
.
ty³
 =ğ
JSON_STRING
)

225 
	`mem_d”ef
(
v®
.
v
.
¡r
);

227  
”r
;

228 
	}
}

231 
	$objeù_¡¬t
(cÚ¡ 
¶
 *
¶_Çme
, 
idx
,

232 
jsÚ_hªdËrs
 *
h
)

234 *
Çme
 = 
NULL
;

235 
”r
 = 0;

237 ià(
¶_Çme
->
p
) {

239 
”r
 = 
	`decode_Çme
(&
Çme
, 
¶_Çme
);

240 ià(
”r
)

241  
”r
;

244 ià(
h
->
oh
)

245 
”r
 = 
h
->
	`oh
(
Çme
, 
idx
, h);

247 
	`mem_d”ef
(
Çme
);

249  
”r
;

250 
	}
}

253 
	$¬¿y_¡¬t
(cÚ¡ 
¶
 *
¶_Çme
, 
idx
,

254 
jsÚ_hªdËrs
 *
h
)

256 *
Çme
 = 
NULL
;

257 
”r
 = 0;

259 ià(
¶_Çme
->
p
) {

261 
”r
 = 
	`decode_Çme
(&
Çme
, 
¶_Çme
);

262 ià(
”r
)

263  
”r
;

266 ià(
h
->
ah
)

267 
”r
 = 
h
->
	`ah
(
Çme
, 
idx
, h);

269 
	`mem_d”ef
(
Çme
);

271  
”r
;

272 
	}
}

275 
šlše
 
	$chkv®
(
¶
 *
v®
, cÚ¡ *
p
)

277 ià(!
v®
->
p
 ||…<val->p)

278  
EINVAL
;

280 
v®
->
l
 = 
p
 - val->p;

283 
	}
}

286 
	$_jsÚ_decode
(cÚ¡ **
¡r
, 
size_t
 *
Ën
,

287 
d•th
, 
maxd•th
,

288 
jsÚ_objeù_h
 *
oh
, 
jsÚ_¬¿y_h
 *
ah
,

289 
jsÚ_objeù_’Œy_h
 *
Ûh
, 
jsÚ_¬¿y_’Œy_h
 *
«h
,

290 *
¬g
)

292 
boŞ
 
esc
 = 
çl£
, 
šquÙ
 = f®£, 
šobj
 = f®£, 
š¬¿y
 = false;

293 
¶
 
Çme
 = 
PL_INIT
, 
v®
 = PL_INIT;

294 
size_t
 
ws
 = 0;

295 
idx
 = 0;

296 
”r
;

298 ; *
Ën
>0; ++(*
¡r
), --(*len)) {

300 ià(
šquÙ
) {

301 ià(
esc
)

302 
esc
 = 
çl£
;

303 ià(**
¡r
 == '\"')

304 
šquÙ
 = 
çl£
;

305 ià(**
¡r
 == '\\')

306 
esc
 = 
Œue
;

311 **
¡r
) {

314 ià(!
šobj
 || 
Çme
.
p
 || 
	`chkv®
(&
v®
, *
¡r
 - 
ws
))

315  
EBADMSG
;

317 
Çme
 = 
v®
;

318 
v®
 = 
¶_nuÎ
;

322 ià(
	`chkv®
(&
v®
, *
¡r
 - 
ws
))

325 ià(
šobj
) {

327 ià(!
Çme
.
p
)

328  
EBADMSG
;

330 
”r
 = 
	`objeù_’Œy
(&
Çme
, &
v®
, 
Ûh
, 
¬g
);

331 ià(
”r
)

332  
”r
;

334 ià(
š¬¿y
) {

336 
”r
 = 
	`¬¿y_’Œy
(
idx
, &
v®
, 
«h
, 
¬g
);

337 ià(
”r
)

338  
”r
;

340 ++
idx
;

343  
EBADMSG
;

345 
Çme
 = 
¶_nuÎ
;

346 
v®
 = 
¶_nuÎ
;

350 ià(
šobj
 || 
š¬¿y
) {

352 
jsÚ_hªdËrs
 
h
 = {
oh
,
ah
,
Ûh
,
«h
,
¬g
};

354 ià(
d•th
 >ğ
maxd•th
)

355  
EOVERFLOW
;

357 ià(
šobj
 && !
Çme
.
p
)

358  
EBADMSG
;

360 
”r
 = 
	`objeù_¡¬t
(&
Çme
, 
idx
, &
h
);

361 ià(
”r
)

362  
”r
;

364 
Çme
 = 
¶_nuÎ
;

366 
”r
 = 
	`_jsÚ_decode
(
¡r
, 
Ën
, 
d•th
 + 1,

367 
maxd•th
, 
h
.
oh
, h.
ah
,

368 
h
.
Ûh
, h.
«h
, h.
¬g
);

369 ià(
”r
)

370  
”r
;

372 ià(
š¬¿y
)

373 ++
idx
;

376 
šobj
 = 
Œue
;

381 ià(
šobj
 || 
š¬¿y
) {

383 
jsÚ_hªdËrs
 
h
 = {
oh
,
ah
,
Ûh
,
«h
,
¬g
};

385 ià(
d•th
 >ğ
maxd•th
)

386  
EOVERFLOW
;

388 ià(
šobj
 && !
Çme
.
p
)

389  
EBADMSG
;

391 
”r
 = 
	`¬¿y_¡¬t
(&
Çme
, 
idx
, &
h
);

392 ià(
”r
)

393  
”r
;

395 
Çme
 = 
¶_nuÎ
;

397 
”r
 = 
	`_jsÚ_decode
(
¡r
, 
Ën
, 
d•th
 + 1,

398 
maxd•th
, 
h
.
oh
, h.
ah
,

399 
h
.
Ûh
, h.
«h
, h.
¬g
);

400 ià(
”r
)

401  
”r
;

403 ià(
š¬¿y
)

404 ++
idx
;

407 
š¬¿y
 = 
Œue
;

408 
idx
 = 0;

413 ià(!
šobj
)

414  
EBADMSG
;

416 ià(
	`chkv®
(&
v®
, *
¡r
 - 
ws
))

419 ià(!
Çme
.
p
)

420  
EBADMSG
;

422  
	`objeù_’Œy
(&
Çme
, &
v®
, 
Ûh
, 
¬g
);

425 ià(!
š¬¿y
)

426  
EBADMSG
;

428 ià(
	`chkv®
(&
v®
, *
¡r
 - 
ws
))

431  
	`¬¿y_’Œy
(
idx
, &
v®
, 
«h
, 
¬g
);

437 ++
ws
;

441 ià(
v®
.
p
)

444 ià(**
¡r
 == '\"')

445 
šquÙ
 = 
Œue
;

447 
v®
.
p
 = *
¡r
;

448 
v®
.
l
 = 0;

449 
ws
 = 0;

454 ià(
šobj
 || 
š¬¿y
)

455  
EBADMSG
;

458 
	}
}

461 
	$jsÚ_decode
(cÚ¡ *
¡r
, 
size_t
 
Ën
, 
maxd•th
,

462 
jsÚ_objeù_h
 *
oh
, 
jsÚ_¬¿y_h
 *
ah
,

463 
jsÚ_objeù_’Œy_h
 *
Ûh
, 
jsÚ_¬¿y_’Œy_h
 *
«h
, *
¬g
)

465 ià(!
¡r
)

466  
EINVAL
;

468  
	`_jsÚ_decode
(&
¡r
, &
Ën
, 0, 
maxd•th
, 
oh
, 
ah
, 
Ûh
, 
«h
, 
¬g
);

469 
	}
}

	@re-0.5.6/src/json/decode_odict.c

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_odiù.h
>

13 
	~<»_jsÚ.h
>

16 
	$cÚš”_add
(cÚ¡ *
Çme
, 
idx
,

17 
odiù_ty³
 
ty³
, 
jsÚ_hªdËrs
 *
h
)

19 
odiù
 *
o
 = 
h
->
¬g
, *
oc
;

20 
šdex
[64];

21 
”r
;

23 ià(!
Çme
) {

24 ià(
	`»_¢´štf
(
šdex
, (šdex), "%u", 
idx
) < 0)

25  
ENOMEM
;

27 
Çme
 = 
šdex
;

30 
”r
 = 
	`odiù_®loc
(&
oc
, 
	`hash_bsize
(
o
->
ht
));

31 ià(
”r
)

32  
”r
;

34 
”r
 = 
	`odiù_’Œy_add
(
o
, 
Çme
, 
ty³
, 
oc
);

35 
	`mem_d”ef
(
oc
);

36 
h
->
¬g
 = 
oc
;

38  
”r
;

39 
	}
}

42 
	$objeù_hªdËr
(cÚ¡ *
Çme
, 
idx
,

43 
jsÚ_hªdËrs
 *
h
)

45  
	`cÚš”_add
(
Çme
, 
idx
, 
ODICT_OBJECT
, 
h
);

46 
	}
}

49 
	$¬¿y_hªdËr
(cÚ¡ *
Çme
, 
idx
,

50 
jsÚ_hªdËrs
 *
h
)

52  
	`cÚš”_add
(
Çme
, 
idx
, 
ODICT_ARRAY
, 
h
);

53 
	}
}

56 
	$’Œy_add
(
odiù
 *
o
, cÚ¡ *
Çme
,

57 cÚ¡ 
jsÚ_v®ue
 *
v®
)

59 
v®
->
ty³
) {

61 
JSON_STRING
:

62  
	`odiù_’Œy_add
(
o
, 
Çme
, 
ODICT_STRING
, 
v®
->
v
.
¡r
);

64 
JSON_INT
:

65  
	`odiù_’Œy_add
(
o
, 
Çme
, 
ODICT_INT
, 
v®
->
v
.
š‹g”
);

67 
JSON_DOUBLE
:

68  
	`odiù_’Œy_add
(
o
, 
Çme
, 
ODICT_DOUBLE
, 
v®
->
v
.
dbl
);

70 
JSON_BOOL
:

71  
	`odiù_’Œy_add
(
o
, 
Çme
, 
ODICT_BOOL
, 
v®
->
v
.
boŞ—n
);

73 
JSON_NULL
:

74  
	`odiù_’Œy_add
(
o
, 
Çme
, 
ODICT_NULL
);

77  
ENOSYS
;

79 
	}
}

82 
	$objeù_’Œy_hªdËr
(cÚ¡ *
Çme
, cÚ¡ 
jsÚ_v®ue
 *
v®
,

83 *
¬g
)

85 
odiù
 *
o
 = 
¬g
;

87  
	`’Œy_add
(
o
, 
Çme
, 
v®
);

88 
	}
}

91 
	$¬¿y_’Œy_hªdËr
(
idx
, cÚ¡ 
jsÚ_v®ue
 *
v®
,

92 *
¬g
)

94 
odiù
 *
o
 = 
¬g
;

95 
šdex
[64];

97 ià(
	`»_¢´štf
(
šdex
, (šdex), "%u", 
idx
) < 0)

98  
ENOMEM
;

100  
	`’Œy_add
(
o
, 
šdex
, 
v®
);

101 
	}
}

104 
	$jsÚ_decode_odiù
(
odiù
 **
İ
, 
ušt32_t
 
hash_size
, cÚ¡ *
¡r
,

105 
size_t
 
Ën
, 
maxd•th
)

107 
odiù
 *
o
;

108 
”r
;

110 ià(!
İ
 || !
¡r
)

111  
EINVAL
;

113 
”r
 = 
	`odiù_®loc
(&
o
, 
hash_size
);

114 ià(
”r
)

115  
”r
;

117 
”r
 = 
	`jsÚ_decode
(
¡r
, 
Ën
, 
maxd•th
, 
objeù_hªdËr
, 
¬¿y_hªdËr
,

118 
objeù_’Œy_hªdËr
, 
¬¿y_’Œy_hªdËr
, 
o
);

119 ià(
”r
)

120 
	`mem_d”ef
(
o
);

122 *
İ
 = 
o
;

124  
”r
;

125 
	}
}

	@re-0.5.6/src/json/encode.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_odiù.h
>

10 
	~<»_jsÚ.h
>

13 
	$’code_’Œy
(
»_´štf
 *
pf
, cÚ¡ 
odiù_’Œy
 *
e
)

15 
odiù
 *
¬¿y
;

16 
Ë
 *le;

17 
”r
;

19 ià(!
e
)

22 
e
->
ty³
) {

24 
ODICT_OBJECT
:

25 
”r
 = 
	`jsÚ_’code_odiù
(
pf
, 
e
->
u
.
odiù
);

28 
ODICT_ARRAY
:

29 
¬¿y
 = 
e
->
u
.
odiù
;

30 ià(!
¬¿y
)

33 
”r
 = 
	`»_h´štf
(
pf
, "[");

35 
Ë
=
¬¿y
->
l¡
.
h—d
;†e;†eöe->
Ãxt
) {

37 cÚ¡ 
odiù_’Œy
 *
«
 = 
Ë
->
d©a
;

39 
”r
 |ğ
	`»_h´štf
(
pf
, "%H%s",

40 
’code_’Œy
, 
«
,

41 
Ë
->
Ãxt
 ? "," : "");

44 
”r
 |ğ
	`»_h´štf
(
pf
, "]");

47 
ODICT_INT
:

48 
”r
 = 
	`»_h´štf
(
pf
, "%Îd", 
e
->
u
.
š‹g”
);

51 
ODICT_DOUBLE
:

52 
”r
 = 
	`»_h´štf
(
pf
, "%f", 
e
->
u
.
dbl
);

55 
ODICT_STRING
:

56 
”r
 = 
	`»_h´štf
(
pf
, "\"%H\"", 
utf8_’code
, 
e
->
u
.
¡r
);

59 
ODICT_BOOL
:

60 
”r
 = 
	`»_h´štf
(
pf
, "%s", 
e
->
u
.
boŞ—n
 ? "true" : "false");

63 
ODICT_NULL
:

64 
”r
 = 
	`»_h´štf
(
pf
, "null");

68 
	`»_årštf
(
¡d”r
, "jsÚ: unsuµÜ‹dy³ %d\n", 
e
->
ty³
);

69 
”r
 = 
EINVAL
;

72  
”r
;

73 
	}
}

76 
	$jsÚ_’code_odiù
(
»_´štf
 *
pf
, cÚ¡ 
odiù
 *
o
)

78 
Ë
 *le;

79 
”r
;

81 ià(!
o
)

84 
”r
 = 
	`»_h´štf
(
pf
, "{");

86 
Ë
=
o
->
l¡
.
h—d
;†e;†eöe->
Ãxt
) {

88 cÚ¡ 
odiù_’Œy
 *
e
 = 
Ë
->
d©a
;

90 
”r
 |ğ
	`»_h´štf
(
pf
, "\"%H\":%H%s",

91 
utf8_’code
, 
e
->
key
,

92 
’code_’Œy
, 
e
,

93 
Ë
->
Ãxt
 ? "," : "");

96 
”r
 |ğ
	`»_h´štf
(
pf
, "}");

98  
”r
;

99 
	}
}

	@re-0.5.6/src/list/list.c

6 
	~<»_ty³s.h
>

7 
	~<»_li¡.h
>

8 
	~<»_mem.h
>

11 
	#DEBUG_MODULE
 "li¡"

	)

12 
	#DEBUG_LEVEL
 5

	)

13 
	~<»_dbg.h
>

21 
	$li¡_š™
(
li¡
 *list)

23 ià(!
li¡
)

26 
li¡
->
h—d
 = 
NULL
;

27 
li¡
->

 = 
NULL
;

28 
	}
}

36 
	$li¡_æush
(
li¡
 *list)

38 
Ë
 *le;

40 ià(!
li¡
)

43 
Ë
 = 
li¡
->
h—d
;

44 
Ë
) {

45 
Ë
 *
Ãxt
 =†e->next;

46 *
d©a
 = 
Ë
->data;

47 
Ë
->
li¡
 = 
NULL
;

48 
Ë
->
´ev
 =†e->
Ãxt
 = 
NULL
;

49 
Ë
->
d©a
 = 
NULL
;

50 
Ë
 = 
Ãxt
;

51 
	`mem_d”ef
(
d©a
);

54 
	`li¡_š™
(
li¡
);

55 
	}
}

63 
	$li¡_ş—r
(
li¡
 *list)

65 
Ë
 *le;

67 ià(!
li¡
)

70 
Ë
 = 
li¡
->
h—d
;

71 
Ë
) {

72 
Ë
 *
Ãxt
 =†e->next;

73 
Ë
->
li¡
 = 
NULL
;

74 
Ë
->
´ev
 =†e->
Ãxt
 = 
NULL
;

75 
Ë
->
d©a
 = 
NULL
;

76 
Ë
 = 
Ãxt
;

79 
	`li¡_š™
(
li¡
);

80 
	}
}

90 
	$li¡_­³nd
(
li¡
 *li¡, 
Ë
 *Ë, *
d©a
)

92 ià(!
li¡
 || !
Ë
)

95 ià(
Ë
->
li¡
) {

96 
	`DEBUG_WARNING
("­³nd:†lškedØ%p\n", 
Ë
->
li¡
);

100 
Ë
->
´ev
 = 
li¡
->

;

101 
Ë
->
Ãxt
 = 
NULL
;

102 
Ë
->
li¡
 =†ist;

103 
Ë
->
d©a
 = data;

105 ià(!
li¡
->
h—d
)

106 
li¡
->
h—d
 = 
Ë
;

108 ià(
li¡
->

)

109 
li¡
->

->
Ãxt
 = 
Ë
;

111 
li¡
->

 = 
Ë
;

112 
	}
}

122 
	$li¡_´•’d
(
li¡
 *li¡, 
Ë
 *Ë, *
d©a
)

124 ià(!
li¡
 || !
Ë
)

127 ià(
Ë
->
li¡
) {

128 
	`DEBUG_WARNING
("´•’d:†lškedØ%p\n", 
Ë
->
li¡
);

132 
Ë
->
´ev
 = 
NULL
;

133 
Ë
->
Ãxt
 = 
li¡
->
h—d
;

134 
Ë
->
li¡
 =†ist;

135 
Ë
->
d©a
 = data;

137 ià(
li¡
->
h—d
)

138 
li¡
->
h—d
->
´ev
 = 
Ë
;

140 ià(!
li¡
->

)

141 
li¡
->

 = 
Ë
;

143 
li¡
->
h—d
 = 
Ë
;

144 
	}
}

155 
	$li¡_š£¹_befÜe
(
li¡
 *li¡, 
Ë
 *Ë, Ë *
e
,

156 *
d©a
)

158 ià(!
li¡
 || !
Ë
 || !
e
)

161 ià(
e
->
li¡
) {

162 
	`DEBUG_WARNING
("š£¹_befÜe:†lškedØ%p\n", 
Ë
->
li¡
);

166 ià(
Ë
->
´ev
)

167 
Ë
->
´ev
->
Ãxt
 = 
e
;

168 ià(
li¡
->
h—d
 =ğ
Ë
)

169 
li¡
->
h—d
 = 
e
;

171 
e
->
´ev
 = 
Ë
->prev;

172 
e
->
Ãxt
 = 
Ë
;

173 
e
->
li¡
 =†ist;

174 
e
->
d©a
 = data;

176 
Ë
->
´ev
 = 
e
;

177 
	}
}

188 
	$li¡_š£¹_aá”
(
li¡
 *li¡, 
Ë
 *Ë, Ë *
e
,

189 *
d©a
)

191 ià(!
li¡
 || !
Ë
 || !
e
)

194 ià(
e
->
li¡
) {

195 
	`DEBUG_WARNING
("š£¹_aá”:†lškedØ%p\n", 
Ë
->
li¡
);

199 ià(
Ë
->
Ãxt
)

200 
Ë
->
Ãxt
->
´ev
 = 
e
;

201 ià(
li¡
->

 =ğ
Ë
)

202 
li¡
->

 = 
e
;

204 
e
->
´ev
 = 
Ë
;

205 
e
->
Ãxt
 = 
Ë
->next;

206 
e
->
li¡
 =†ist;

207 
e
->
d©a
 = data;

209 
Ë
->
Ãxt
 = 
e
;

210 
	}
}

218 
	$li¡_uÆšk
(
Ë
 *le)

220 
li¡
 *list;

222 ià(!
Ë
 || !Ë->
li¡
)

225 
li¡
 = 
Ë
->list;

227 ià(
Ë
->
´ev
)

228 
Ë
->
´ev
->
Ãxt
 =†e->next;

230 
li¡
->
h—d
 = 
Ë
->
Ãxt
;

232 ià(
Ë
->
Ãxt
)

233 
Ë
->
Ãxt
->
´ev
 =†e->prev;

235 
li¡
->

 = 
Ë
->
´ev
;

237 
Ë
->
Ãxt
 = 
NULL
;

238 
Ë
->
´ev
 = 
NULL
;

239 
Ë
->
li¡
 = 
NULL
;

240 
	}
}

250 
	$li¡_sÜt
(
li¡
 *li¡, 
li¡_sÜt_h
 *
sh
, *
¬g
)

252 
Ë
 *le;

253 
boŞ
 
sÜt
;

255 ià(!
li¡
 || !
sh
)

258 
»Œy
:

259 
Ë
 = 
li¡
->
h—d
;

260 
sÜt
 = 
çl£
;

262 
Ë
 &&†e->
Ãxt
) {

264 ià(
	`sh
(
Ë
,†e->
Ãxt
, 
¬g
)) {

266 
Ë
 =†e->
Ãxt
;

269 
Ë
 *
e
 =†e->
Ãxt
;

271 
	`li¡_uÆšk
(
Ë
);

272 
	`li¡_š£¹_aá”
(
li¡
, 
e
, 
Ë
,†e->
d©a
);

273 
sÜt
 = 
Œue
;

277 ià(
sÜt
) {

278 
»Œy
;

280 
	}
}

293 
Ë
 *
	$li¡_­¶y
(cÚ¡ 
li¡
 *li¡, 
boŞ
 
fwd
,

294 
li¡_­¶y_h
 *
ah
, *
¬g
)

296 
Ë
 *le;

298 ià(!
li¡
 || !
ah
)

299  
NULL
;

301 
Ë
 = 
fwd
 ? 
li¡
->
h—d
 :†i¡->

;

303 
Ë
) {

304 
Ë
 *
cur
 =†e;

306 
Ë
 = 
fwd
 ?†e->
Ãxt
 :†e->
´ev
;

308 ià(
	`ah
(
cur
, 
¬g
))

309  
cur
;

312  
NULL
;

313 
	}
}

323 
Ë
 *
	$li¡_h—d
(cÚ¡ 
li¡
 *list)

325  
li¡
 ?†i¡->
h—d
 : 
NULL
;

326 
	}
}

336 
Ë
 *
	$li¡_
(cÚ¡ 
li¡
 *list)

338  
li¡
 ?†i¡->

 : 
NULL
;

339 
	}
}

349 
ušt32_t
 
	$li¡_couÁ
(cÚ¡ 
li¡
 *list)

351 
ušt32_t
 
n
 = 0;

352 
Ë
 *le;

354 ià(!
li¡
)

357 
Ë
 = 
li¡
->
h—d
;†e;†ğË->
Ãxt
)

358 ++
n
;

360  
n
;

361 
	}
}

	@re-0.5.6/src/lock/lock.c

6 
	#_DEFAULT_SOURCE
 1

	)

7 
	#__USE_UNIX98
 1

	)

8 
	~<±h»ad.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_mem.h
>

11 
	~<»_lock.h
>

14 
	#DEBUG_MODULE
 "lock"

	)

15 
	#DEBUG_LEVEL
 5

	)

16 
	~<»_dbg.h
>

19 #iâdeà
RELEASE


20 
	#LOCK_DEBUG
 0

	)

25 
	slock
 {

26 
±h»ad_mu‹x_t
 
	mm
;

30 
	$lock_de¡ruùÜ
(*
d©a
)

32 
lock
 *
l
 = 
d©a
;

34 
”r
 = 
	`±h»ad_mu‹x_de¡roy
(&
l
->
m
);

35 ià(
”r
) {

36 
	`DEBUG_WARNING
("±h»ad_mu‹x_de¡roy: %m\n", 
”r
);

38 
	}
}

48 
	$lock_®loc
(
lock
 **
Í
)

50 
±h»ad_mu‹x©Œ_t
 
©Œ
;

51 
lock
 *
l
;

53 ià(!
Í
)

54  
EINVAL
;

56 
l
 = 
	`mem_z®loc
((*l), 
lock_de¡ruùÜ
);

57 ià(!
l
)

58  
ENOMEM
;

60 ()
	`±h»ad_mu‹x_š™
(&
l
->
m
, 
NULL
);

62 
	`±h»ad_mu‹x©Œ_š™
(&
©Œ
);

64 #ià
LOCK_DEBUG


65 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_ERRORCHECK
);

66 
	`DEBUG_NOTICE
("init debug†ock\n");

68 
	`±h»ad_mu‹x©Œ_£‰y³
(&
©Œ
, 
PTHREAD_MUTEX_NORMAL
);

70 
	`±h»ad_mu‹x_š™
(&
l
->
m
, &
©Œ
);

72 *
Í
 = 
l
;

74 
	}
}

82 
	$lock_»ad_g‘
(
lock
 *
l
)

84 cÚ¡ 
”r
 = 
	`±h»ad_mu‹x_lock
(&
l
->
m
);

85 ià(
”r
) {

86 
	`DEBUG_WARNING
("lock_»ad_g‘: %m\n", 
”r
);

88 
	}
}

96 
	$lock_wr™e_g‘
(
lock
 *
l
)

98 cÚ¡ 
”r
 = 
	`±h»ad_mu‹x_lock
(&
l
->
m
);

99 ià(
”r
) {

100 
	`DEBUG_WARNING
("lock_wr™e_g‘: %m\n", 
”r
);

102 
	}
}

112 
	$lock_»ad_Œy
(
lock
 *
l
)

114  
	`±h»ad_mu‹x_Œylock
(&
l
->
m
);

115 
	}
}

125 
	$lock_wr™e_Œy
(
lock
 *
l
)

127  
	`±h»ad_mu‹x_Œylock
(&
l
->
m
);

128 
	}
}

136 
	$lock_»l
(
lock
 *
l
)

138 cÚ¡ 
”r
 = 
	`±h»ad_mu‹x_uÆock
(&
l
->
m
);

139 ià(
”r
) {

140 
	`DEBUG_WARNING
("lock_»l: %m\n", 
”r
);

142 
	}
}

	@re-0.5.6/src/lock/rwlock.c

6 
	#_GNU_SOURCE
 1

	)

7 
	~<±h»ad.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_mem.h
>

10 
	~<»_lock.h
>

13 
	#DEBUG_MODULE
 "rwlock"

	)

14 
	#DEBUG_LEVEL
 5

	)

15 
	~<»_dbg.h
>

18 
	slock
 {

19 
±h»ad_rwlock_t
 
	mlock
;

23 
	$lock_de¡ruùÜ
(*
d©a
)

25 
lock
 *
l
 = 
d©a
;

27 
”r
 = 
	`±h»ad_rwlock_de¡roy
(&
l
->
lock
);

28 ià(
”r
) {

29 
	`DEBUG_WARNING
("±h»ad_rwlock_de¡roy: %m\n", 
”r
);

31 
	}
}

34 
	$lock_®loc
(
lock
 **
Í
)

36 
lock
 *
l
;

37 
”r
;

39 ià(!
Í
)

40  
EINVAL
;

42 
l
 = 
	`mem_z®loc
((*l), 
lock_de¡ruùÜ
);

43 ià(!
l
)

44  
ENOMEM
;

46 
”r
 = 
	`±h»ad_rwlock_š™
(&
l
->
lock
, 
NULL
);

47 ià(
”r
)

48 
out
;

50 *
Í
 = 
l
;

52 
out
:

53 ià(
”r
)

54 
	`mem_d”ef
(
l
);

55  
”r
;

56 
	}
}

59 
	$lock_»ad_g‘
(
lock
 *
l
)

61 
”r
;

63 ià(!
l
)

66 
”r
 = 
	`±h»ad_rwlock_rdlock
(&
l
->
lock
);

67 ià(
”r
) {

68 
	`DEBUG_WARNING
("lock_»ad_g‘: %m\n", 
”r
);

70 
	}
}

73 
	$lock_wr™e_g‘
(
lock
 *
l
)

75 
”r
;

77 ià(!
l
)

80 
”r
 = 
	`±h»ad_rwlock_w¾ock
(&
l
->
lock
);

81 ià(
”r
) {

82 
	`DEBUG_WARNING
("lock_wr™e_g‘: %m\n", 
”r
);

84 
	}
}

87 
	$lock_»ad_Œy
(
lock
 *
l
)

89 ià(!
l
)

90  
EINVAL
;

91  
	`±h»ad_rwlock_Œyrdlock
(&
l
->
lock
);

92 
	}
}

95 
	$lock_wr™e_Œy
(
lock
 *
l
)

97 ià(!
l
)

98  
EINVAL
;

99  
	`±h»ad_rwlock_Œyw¾ock
(&
l
->
lock
);

100 
	}
}

103 
	$lock_»l
(
lock
 *
l
)

105 
”r
;

107 ià(!
l
)

110 
”r
 = 
	`±h»ad_rwlock_uÆock
(&
l
->
lock
);

111 ià(
”r
) {

112 
	`DEBUG_WARNING
("lock_»l: %m\n", 
”r
);

114 
	}
}

	@re-0.5.6/src/lock/win32/lock.c

6 #undeà
_WIN32_WINNT


7 
	#_WIN32_WINNT
 0x0400

	)

8 
	~<wšdows.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_mem.h
>

11 
	~<»_lock.h
>

14 
	slock
 {

15 
CRITICAL_SECTION
 
	mc
;

19 
	$lock_de¡ruùÜ
(*
d©a
)

21 
lock
 *
l
 = 
d©a
;

23 
	`D–‘eCr™iÿlSeùiÚ
(&
l
->
c
);

24 
	}
}

27 
	$lock_®loc
(
lock
 **
Í
)

29 
lock
 *
l
;

31 ià(!
Í
)

32  
EINVAL
;

34 
l
 = 
	`mem_®loc
((*l), 
lock_de¡ruùÜ
);

35 ià(!
l
)

36  
ENOMEM
;

38 
	`In™ŸlizeCr™iÿlSeùiÚ
(&
l
->
c
);

40 *
Í
 = 
l
;

42 
	}
}

45 
	$lock_»ad_g‘
(
lock
 *
l
)

47 
	`EÁ”Cr™iÿlSeùiÚ
(&
l
->
c
);

48 
	}
}

51 
	$lock_wr™e_g‘
(
lock
 *
l
)

53 
	`EÁ”Cr™iÿlSeùiÚ
(&
l
->
c
);

54 
	}
}

57 
	$lock_»ad_Œy
(
lock
 *
l
)

59  
	`TryEÁ”Cr™iÿlSeùiÚ
(&
l
->
c
è? 0 : 
ENODEV
;

60 
	}
}

63 
	$lock_wr™e_Œy
(
lock
 *
l
)

65  
	`TryEÁ”Cr™iÿlSeùiÚ
(&
l
->
c
è? 0 : 
ENODEV
;

66 
	}
}

69 
	$lock_»l
(
lock
 *
l
)

71 
	`L—veCr™iÿlSeùiÚ
(&
l
->
c
);

72 
	}
}

	@re-0.5.6/src/main/epoll.c

6 
	~<uni¡d.h
>

7 
	~<sys/•Şl.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_sys.h
>

11 
	~"maš.h
"

14 
	#DEBUG_MODULE
 "•Şl"

	)

15 
	#DEBUG_LEVEL
 5

	)

16 
	~<»_dbg.h
>

24 
boŞ
 
	$•Şl_check
()

26 
ušt32_t
 
o¤–
;

27 
”r
, 
•fd
;

29 
”r
 = 
	`sys_»l_g‘
(&
o¤–
, 
NULL
, NULL, NULL);

30 ià(
”r
)

31  
çl£
;

33 ià(
o¤–
 < 0x020542) {

34 
	`DEBUG_INFO
("•ŞÈnÙ suµÜ‹d iÀo¤–=0x%08x\n", 
o¤–
);

35  
çl£
;

38 #ifdeà
OPENWRT


40 ià(
o¤–
 < 0x020619) {

41 
	`DEBUG_NOTICE
("•ŞÈi brok’ iÀo¤–=0x%08x\n", 
o¤–
);

42  
çl£
;

46 
•fd
 = 
	`•Şl_ü—‹
(64);

47 ià(-1 =ğ
•fd
) {

48 
	`DEBUG_NOTICE
("•Şl_ü—‹: %m\n", 
”ºo
);

49  
çl£
;

52 ()
	`şo£
(
•fd
);

54  
Œue
;

55 
	}
}

	@re-0.5.6/src/main/init.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_Ãt.h
>

10 
	~<»_sys.h
>

11 
	~<»_maš.h
>

12 
	~"maš.h
"

20 
	$lib»_š™
()

22 
”r
;

24 
	`¿nd_š™
();

26 #ifdeà
USE_OPENSSL


27 
”r
 = 
	`İ’s¦_š™
();

28 ià(
”r
)

29 
out
;

32 
”r
 = 
	`Ãt_sock_š™
();

33 ià(
”r
)

34 
out
;

36 
out
:

37 ià(
”r
) {

38 
	`Ãt_sock_şo£
();

39 #ifdeà
USE_OPENSSL


40 
	`İ’s¦_şo£
();

44  
”r
;

45 
	}
}

51 
	$lib»_şo£
()

53 ()
	`fd_£tsize
(0);

54 
	`Ãt_sock_şo£
();

55 #ifdeà
USE_OPENSSL


56 
	`İ’s¦_şo£
();

58 
	}
}

	@re-0.5.6/src/main/main.c

6 #ifdeà
HAVE_SYS_TIME_H


7 
	~<sys/time.h
>

9 
	~<sys/ty³s.h
>

10 #undeà
_STRICT_ANSI


11 
	~<¡ršg.h
>

12 #ifdeà
HAVE_UNISTD_H


13 
	~<uni¡d.h
>

15 #ifdeà
WIN32


16 
	~<wšsock.h
>

18 #ifdeà
HAVE_SIGNAL


19 
	~<sigÇl.h
>

21 #ifdeà
HAVE_SELECT_H


22 
	~<sys/£Ëù.h
>

24 #ifdeà
HAVE_POLL


25 
	~<pŞl.h
>

27 #ifdeà
HAVE_EPOLL


28 
	~<sys/•Şl.h
>

30 #ifdeà
HAVE_KQUEUE


31 
	~<sys/ty³s.h
>

32 
	~<sys/ev’t.h
>

33 
	~<sys/time.h
>

34 #undeà
LIST_INIT


35 #undeà
LIST_FOREACH


37 
	~<»_ty³s.h
>

38 
	~<»_fmt.h
>

39 
	~<»_mem.h
>

40 
	~<»_mbuf.h
>

41 
	~<»_li¡.h
>

42 
	~<»_tmr.h
>

43 
	~<»_maš.h
>

44 
	~"maš.h
"

45 #ifdeà
HAVE_PTHREAD


46 
	#__USE_GNU
 1

	)

47 
	~<¡dlib.h
>

48 
	~<±h»ad.h
>

52 
	#DEBUG_MODULE
 "maš"

	)

53 
	#DEBUG_LEVEL
 5

	)

54 
	~<»_dbg.h
>

71 #ià!
defšed
 (
RELEASE
è&& !defšed (
MAIN_DEBUG
)

72 
	#MAIN_DEBUG
 1

	)

78 
	mMAX_BLOCKING
 = 100,

79 #ià
defšed
 (
FD_SETSIZE
)

80 
	mDEFAULT_MAXFDS
 = 
FD_SETSIZE


82 
DEFAULT_MAXFDS
 = 128

88 
	s»
 {

91 
	mæags
;

92 
fd_h
 *
	mfh
;

93 *
	m¬g
;

94 } *
	mfhs
;

95 
	mmaxfds
;

96 
	mnfds
;

97 
pŞl_m‘hod
 
	mm‘hod
;

98 
boŞ
 
	mupd©e
;

99 
boŞ
 
	mpŞlšg
;

100 
	msig
;

101 
li¡
 
	mtm¾
;

103 #ifdeà
HAVE_POLL


104 
pŞlfd
 *
	mfds
;

107 #ifdeà
HAVE_EPOLL


108 
•Şl_ev’t
 *
	mev’ts
;

109 
	m•fd
;

112 #ifdeà
HAVE_KQUEUE


113 
kev’t
 *
	mevli¡
;

114 
	mkqfd
;

117 #ifdeà
HAVE_PTHREAD


118 
±h»ad_mu‹x_t
 
	mmu‹x
;

119 
±h»ad_mu‹x_t
 *
	mmu‹xp
;

123 
»
 
	gglob®_»
 = {

124 
NULL
,

127 
METHOD_NULL
,

128 
çl£
,

129 
çl£
,

131 
LIST_INIT
,

132 #ifdeà
HAVE_POLL


133 
NULL
,

135 #ifdeà
HAVE_EPOLL


136 
NULL
,

139 #ifdeà
HAVE_KQUEUE


140 
NULL
,

143 #ifdeà
HAVE_PTHREAD


144 #ià
MAIN_DEBUG
 && 
defšed
 (
PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
)

145 
PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
,

147 
PTHREAD_MUTEX_INITIALIZER
,

149 &
glob®_»
.
mu‹x
,

154 #ifdeà
HAVE_PTHREAD


156 
pŞl_şo£
(
»
 *re);

158 
±h»ad_Úû_t
 
	g±_Úû
 = 
PTHREAD_ONCE_INIT
;

159 
±h»ad_key_t
 
	g±_key
;

162 
	$th»ad_de¡ruùÜ
(*
¬g
)

164 
	`pŞl_şo£
(
¬g
);

165 
	`ä“
(
¬g
);

166 
	}
}

169 
	$»_Úû
()

171 
	`±h»ad_key_ü—‹
(&
±_key
, 
th»ad_de¡ruùÜ
);

172 
	}
}

175 
»
 *
	$»_g‘
()

177 
»
 *re;

179 
	`±h»ad_Úû
(&
±_Úû
, 
»_Úû
);

181 
»
 = 
	`±h»ad_g‘¥ecific
(
±_key
);

182 ià(!
»
) {

183 
»
 = &
glob®_»
;

186  
»
;

187 
	}
}

190 
šlše
 
	$»_lock
(
»
 *re)

192 
”r
;

194 
”r
 = 
	`±h»ad_mu‹x_lock
(
»
->
mu‹xp
);

195 ià(
”r
) {

196 
	`DEBUG_WARNING
("»_lock: %m\n", 
”r
);

198 
	}
}

201 
šlše
 
	$»_uÆock
(
»
 *re)

203 
”r
;

205 
”r
 = 
	`±h»ad_mu‹x_uÆock
(
»
->
mu‹xp
);

206 ià(
”r
) {

207 
	`DEBUG_WARNING
("»_uÆock: %m\n", 
”r
);

209 
	}
}

214 
»
 *
	$»_g‘
()

216  &
glob®_»
;

217 
	}
}

219 
	#»_lock
(
x
è

	)

220 
	#»_uÆock
(
x
è

	)

225 #ià
MAIN_DEBUG


233 
	$fd_hªdËr
(
»
 *», 
fd
, 
æags
)

235 cÚ¡ 
ušt64_t
 
tick
 = 
	`tmr_jiff›s
();

236 
ušt32_t
 
diff
;

238 
	`DEBUG_INFO
("ev’ˆÚ fd=%d (æags=0x%02x)...\n", 
fd
, 
æags
);

240 
»
->
fhs
[
fd
].
	`fh
(
æags
,„e->fhs[fd].
¬g
);

242 
diff
 = (
ušt32_t
)(
	`tmr_jiff›s
(è- 
tick
);

244 ià(
diff
 > 
MAX_BLOCKING
) {

245 
	`DEBUG_WARNING
("long‡sync blocking: %u>%u ms (h=%p‡rg=%p)\n",

246 
diff
, 
MAX_BLOCKING
,

247 
»
->
fhs
[
fd
].
fh
,„e->fhs[fd].
¬g
);

249 
	}
}

253 #ifdeà
HAVE_POLL


254 
	$£t_pŞl_fds
(
»
 *», 
fd
, 
æags
)

256 ià(!
»
->
fds
)

259 ià(
æags
)

260 
»
->
fds
[
fd
].fd = fd;

262 
»
->
fds
[
fd
].fd = -1;

264 
»
->
fds
[
fd
].
ev’ts
 = 0;

265 ià(
æags
 & 
FD_READ
)

266 
»
->
fds
[
fd
].
ev’ts
 |ğ
POLLIN
;

267 ià(
æags
 & 
FD_WRITE
)

268 
»
->
fds
[
fd
].
ev’ts
 |ğ
POLLOUT
;

269 ià(
æags
 & 
FD_EXCEPT
)

270 
»
->
fds
[
fd
].
ev’ts
 |ğ
POLLERR
;

273 
	}
}

277 #ifdeà
HAVE_EPOLL


278 
	$£t_•Şl_fds
(
»
 *», 
fd
, 
æags
)

280 
•Şl_ev’t
 
ev’t
;

281 
”r
 = 0;

283 ià(
»
->
•fd
 < 0)

284  
EBADFD
;

286 
	`mem£t
(&
ev’t
, 0, (event));

288 
	`DEBUG_INFO
("£t_•Şl_fds: fd=%d fÏgs=0x%02x\n", 
fd
, 
æags
);

290 ià(
æags
) {

291 
ev’t
.
d©a
.
fd
 = fd;

293 ià(
æags
 & 
FD_READ
)

294 
ev’t
.
ev’ts
 |ğ
EPOLLIN
;

295 ià(
æags
 & 
FD_WRITE
)

296 
ev’t
.
ev’ts
 |ğ
EPOLLOUT
;

297 ià(
æags
 & 
FD_EXCEPT
)

298 
ev’t
.
ev’ts
 |ğ
EPOLLERR
;

301 ià(-1 =ğ
	`•Şl_ùl
(
»
->
•fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev’t
)) {

304 ià(
EEXIST
 =ğ
”ºo
) {

306 ià(-1 =ğ
	`•Şl_ùl
(
»
->
•fd
, 
EPOLL_CTL_MOD
,

307 
fd
, &
ev’t
)) {

308 
”r
 = 
”ºo
;

309 
	`DEBUG_WARNING
("epoll_ctl:"

312 
fd
, 
”r
);

316 
”r
 = 
”ºo
;

317 
	`DEBUG_WARNING
("epoll_ctl: EPOLL_CTL_ADD:"

319 
fd
, 
”r
);

324 ià(-1 =ğ
	`•Şl_ùl
(
»
->
•fd
, 
EPOLL_CTL_DEL
, 
fd
, &
ev’t
)) {

325 
”r
 = 
”ºo
;

326 
	`DEBUG_INFO
("epoll_ctl: EPOLL_CTL_DEL: fd=%d (%m)\n",

327 
fd
, 
”r
);

331  
”r
;

332 
	}
}

336 #ifdeà
HAVE_KQUEUE


337 
	$£t_kqueue_fds
(
»
 *», 
fd
, 
æags
)

339 
kev’t
 
kev
[2];

340 
r
, 
n
 = 0;

342 
	`mem£t
(
kev
, 0, (kev));

345 
	`EV_SET
(&
kev
[0], 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 0);

346 
	`EV_SET
(&
kev
[1], 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 0);

347 
	`kev’t
(
»
->
kqfd
, 
kev
, 2, 
NULL
, 0, NULL);

349 
	`mem£t
(
kev
, 0, (kev));

351 ià(
æags
 & 
FD_WRITE
) {

352 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 0);

353 ++
n
;

355 ià(
æags
 & 
FD_READ
) {

356 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 0);

357 ++
n
;

360 ià(
n
) {

361 
r
 = 
	`kev’t
(
»
->
kqfd
, 
kev
, 
n
, 
NULL
, 0, NULL);

362 ià(
r
 < 0) {

363 
”r
 = 
”ºo
;

365 
	`DEBUG_WARNING
("set: [fd=%d, flags=%x] kevent: %m\n",

366 
fd
, 
æags
, 
”r
);

367  
”r
;

372 
	}
}

380 
	$»bud_fds
(
»
 *re)

382 
i
, 
”r
 = 0;

384 
	`DEBUG_INFO
("»budšg fd Òfds=%d)\n", 
»
->
nfds
);

387 
i
=0; i<
»
->
nfds
; i++) {

388 ià(!
»
->
fhs
[
i
].
fh
)

391 
»
->
m‘hod
) {

393 #ifdeà
HAVE_POLL


394 
METHOD_POLL
:

395 
”r
 = 
	`£t_pŞl_fds
(
»
, 
i
,„e->
fhs
[i].
æags
);

398 #ifdeà
HAVE_EPOLL


399 
METHOD_EPOLL
:

400 
”r
 = 
	`£t_•Şl_fds
(
»
, 
i
,„e->
fhs
[i].
æags
);

404 #ifdeà
HAVE_KQUEUE


405 
METHOD_KQUEUE
:

406 
”r
 = 
	`£t_kqueue_fds
(
»
, 
i
,„e->
fhs
[i].
æags
);

414 ià(
”r
)

418  
”r
;

419 
	}
}

422 
	$pŞl_š™
(
»
 *re)

424 
	`DEBUG_INFO
("pŞÈš™ (maxfds=%d)\n", 
»
->
maxfds
);

426 ià(!
»
->
maxfds
) {

427 
	`DEBUG_WARNING
("poll init: maxfds is 0\n");

428  
EINVAL
;

431 
»
->
m‘hod
) {

433 #ifdeà
HAVE_POLL


434 
METHOD_POLL
:

435 ià(!
»
->
fds
) {

436 
»
->
fds
 = 
	`mem_z®loc
Ôe->
maxfds
 * (*re->fds),

437 
NULL
);

438 ià(!
»
->
fds
)

439  
ENOMEM
;

443 #ifdeà
HAVE_EPOLL


444 
METHOD_EPOLL
:

445 ià(!
»
->
ev’ts
) {

446 
	`DEBUG_INFO
("allocate %u bytes forƒpoll set\n",

447 
»
->
maxfds
 * (*»->
ev’ts
));

448 
»
->
ev’ts
 = 
	`mem_z®loc
Ôe->
maxfds
*(*re->events),

449 
NULL
);

450 ià(!
»
->
ev’ts
)

451  
ENOMEM
;

454 ià(
»
->
•fd
 < 0

455 && -1 =ğ(
»
->
•fd
 = 
	`•Şl_ü—‹
Ôe->
maxfds
))) {

457 
”r
 = 
”ºo
;

459 
	`DEBUG_WARNING
("epoll_create: %m (maxfds=%d)\n",

460 
”r
, 
»
->
maxfds
);

461  
”r
;

463 
	`DEBUG_INFO
("š™:ƒpŞl_ü—‹(è•fd=%d\n", 
»
->
•fd
);

467 #ifdeà
HAVE_KQUEUE


468 
METHOD_KQUEUE
:

470 ià(!
»
->
evli¡
) {

471 
size_t
 
sz
 = 
»
->
maxfds
 * (*»->
evli¡
);

472 
»
->
evli¡
 = 
	`mem_z®loc
(
sz
, 
NULL
);

473 ià(!
»
->
evli¡
)

474  
ENOMEM
;

477 ià(
»
->
kqfd
 < 0) {

478 
»
->
kqfd
 = 
	`kqueue
();

479 ià(
»
->
kqfd
 < 0)

480  
”ºo
;

481 
	`DEBUG_INFO
("kqueue: fd=%d\n", 
»
->
kqfd
);

491 
	}
}

495 
	$pŞl_şo£
(
»
 *re)

497 
	`DEBUG_INFO
("poll close\n");

499 
»
->
fhs
 = 
	`mem_d”ef
(re->fhs);

500 
»
->
maxfds
 = 0;

502 #ifdeà
HAVE_POLL


503 
»
->
fds
 = 
	`mem_d”ef
(re->fds);

505 #ifdeà
HAVE_EPOLL


506 
	`DEBUG_INFO
("pŞl_şo£:ƒpfd=%d\n", 
»
->
•fd
);

508 ià(
»
->
•fd
 >= 0) {

509 ()
	`şo£
(
»
->
•fd
);

510 
»
->
•fd
 = -1;

513 
»
->
ev’ts
 = 
	`mem_d”ef
(re->events);

516 #ifdeà
HAVE_KQUEUE


517 ià(
»
->
kqfd
 >= 0) {

518 
	`şo£
(
»
->
kqfd
);

519 
»
->
kqfd
 = -1;

522 
»
->
evli¡
 = 
	`mem_d”ef
(re->evlist);

524 
	}
}

527 
	$pŞl_£tup
(
»
 *re)

529 
”r
;

531 
”r
 = 
	`fd_£tsize
(
DEFAULT_MAXFDS
);

532 ià(
”r
)

533 
out
;

535 ià(
METHOD_NULL
 =ğ
»
->
m‘hod
) {

536 
”r
 = 
	`pŞl_m‘hod_£t
(
	`pŞl_m‘hod_be¡
());

537 ià(
”r
)

538 
out
;

540 
	`DEBUG_INFO
("poll setup:…oll method‚ot set - seto `%s'\n",

541 
	`pŞl_m‘hod_Çme
(
»
->
m‘hod
));

544 
”r
 = 
	`pŞl_š™
(
»
);

546 
out
:

547 ià(
”r
)

548 
	`pŞl_şo£
(
»
);

550  
”r
;

551 
	}
}

564 
	$fd_li¡’
(
fd
, 
æags
, 
fd_h
 *
fh
, *
¬g
)

566 
»
 *» = 
	`»_g‘
();

567 
”r
 = 0;

569 
	`DEBUG_INFO
("fd_li¡’: fd=%d fÏgs=0x%02x\n", 
fd
, 
æags
);

571 ià(
fd
 < 0) {

572 
	`DEBUG_WARNING
("fd_li¡’: cÜru± fd %d\n", 
fd
);

573  
EBADF
;

576 ià(
æags
 || 
fh
) {

577 
”r
 = 
	`pŞl_£tup
(
»
);

578 ià(
”r
)

579  
”r
;

582 ià(
fd
 >ğ
»
->
maxfds
) {

583 ià(
æags
) {

584 
	`DEBUG_WARNING
("fd_listen: fd=%d flags=0x%02x"

586 
fd
, 
æags
, 
»
->
maxfds
);

588  
EMFILE
;

592 ià(
»
->
fhs
) {

593 
»
->
fhs
[
fd
].
æags
 = flags;

594 
»
->
fhs
[
fd
].
fh
 = fh;

595 
»
->
fhs
[
fd
].
¬g
 =‡rg;

598 
»
->
nfds
 = 
	`max
Ôe->nfds, 
fd
+1);

600 
»
->
m‘hod
) {

602 #ifdeà
HAVE_POLL


603 
METHOD_POLL
:

604 
”r
 = 
	`£t_pŞl_fds
(
»
, 
fd
, 
æags
);

608 #ifdeà
HAVE_EPOLL


609 
METHOD_EPOLL
:

610 ià(
»
->
•fd
 < 0)

611  
EBADFD
;

612 
”r
 = 
	`£t_•Şl_fds
(
»
, 
fd
, 
æags
);

616 #ifdeà
HAVE_KQUEUE


617 
METHOD_KQUEUE
:

618 
”r
 = 
	`£t_kqueue_fds
(
»
, 
fd
, 
æags
);

626 ià(
”r
) {

627 ià(
æags
 && 
fh
) {

628 
	`fd_şo£
(
fd
);

629 
	`DEBUG_WARNING
("fd_listen: fd=%d flags=0x%02x (%m)\n",

630 
fd
, 
æags
, 
”r
);

634  
”r
;

635 
	}
}

643 
	$fd_şo£
(
fd
)

645 ()
	`fd_li¡’
(
fd
, 0, 
NULL
, NULL);

646 
	}
}

656 
	$fd_pŞl
(
»
 *re)

658 cÚ¡ 
ušt64_t
 
to
 = 
	`tmr_Ãxt_timeout
(&
»
->
tm¾
);

659 
i
, 
n
;

660 #ifdeà
HAVE_SELECT


661 
fd_£t
 
rfds
, 
wfds
, 
efds
;

664 
	`DEBUG_INFO
("Ãxˆtim”: %Îu ms\n", 
to
);

667 
»
->
m‘hod
) {

669 #ifdeà
HAVE_POLL


670 
METHOD_POLL
:

671 
	`»_uÆock
(
»
);

672 
n
 = 
	`pŞl
(
»
->
fds
,„e->
nfds
, 
to
 ? ()to : -1);

673 
	`»_lock
(
»
);

676 #ifdeà
HAVE_SELECT


677 
METHOD_SELECT
: {

678 
timev®
 
tv
;

681 
	`FD_ZERO
(&
rfds
);

682 
	`FD_ZERO
(&
wfds
);

683 
	`FD_ZERO
(&
efds
);

685 
i
=0; i<
»
->
nfds
; i++) {

686 ià(!
»
->
fhs
[
i
].
fh
)

689 ià(
»
->
fhs
[
i
].
æags
 & 
FD_READ
)

690 
	`FD_SET
(
i
, &
rfds
);

691 ià(
»
->
fhs
[
i
].
æags
 & 
FD_WRITE
)

692 
	`FD_SET
(
i
, &
wfds
);

693 ià(
»
->
fhs
[
i
].
æags
 & 
FD_EXCEPT
)

694 
	`FD_SET
(
i
, &
efds
);

697 #ifdeà
WIN32


698 
tv
.
tv_£c
 = (è
to
 / 1000;

700 
tv
.
tv_£c
 = (
time_t
è
to
 / 1000;

702 
tv
.
tv_u£c
 = (
ušt32_t
è(
to
 % 1000) * 1000;

703 
	`»_uÆock
(
»
);

704 
n
 = 
	`£Ëù
(
»
->
nfds
, &
rfds
, &
wfds
, &
efds
, 
to
 ? &
tv
 : 
NULL
);

705 
	`»_lock
(
»
);

709 #ifdeà
HAVE_EPOLL


710 
METHOD_EPOLL
:

711 
	`»_uÆock
(
»
);

712 
n
 = 
	`•Şl_wa™
(
»
->
•fd
,„e->
ev’ts
,„e->
maxfds
,

713 
to
 ? ()to : -1);

714 
	`»_lock
(
»
);

718 #ifdeà
HAVE_KQUEUE


719 
METHOD_KQUEUE
: {

720 
time¥ec
 
timeout
;

722 
timeout
.
tv_£c
 = (
time_t
è(
to
 / 1000);

723 
timeout
.
tv_n£c
 = (
to
 % 1000) * 1000000;

725 
	`»_uÆock
(
»
);

726 
n
 = 
	`kev’t
(
»
->
kqfd
, 
NULL
, 0,„e->
evli¡
,„e->
maxfds
,

727 
to
 ? &
timeout
 : 
NULL
);

728 
	`»_lock
(
»
);

734 ()
to
;

735 
	`DEBUG_WARNING
("no…olling method set\n");

736  
EINVAL
;

739 ià(
n
 < 0)

740  
”ºo
;

743 
i
=0; (
n
 > 0è&& (˜< 
»
->
nfds
); i++) {

744 
fd
, 
æags
 = 0;

746 
»
->
m‘hod
) {

748 #ifdeà
HAVE_POLL


749 
METHOD_POLL
:

750 
fd
 = 
i
;

751 ià(
»
->
fds
[
fd
].
»v’ts
 & 
POLLIN
)

752 
æags
 |ğ
FD_READ
;

753 ià(
»
->
fds
[
fd
].
»v’ts
 & 
POLLOUT
)

754 
æags
 |ğ
FD_WRITE
;

755 ià(
»
->
fds
[
fd
].
»v’ts
 & (
POLLERR
|
POLLHUP
|
POLLNVAL
))

756 
æags
 |ğ
FD_EXCEPT
;

757 ià(
»
->
fds
[
fd
].
»v’ts
 & 
POLLNVAL
) {

758 
	`DEBUG_WARNING
("event: fd=%d POLLNVAL"

761 
fd
, 
»
->
fds
[fd].fd,

762 
»
->
fds
[
fd
].
ev’ts
);

765 
»
->
fds
[
fd
].
»v’ts
 = 0;

768 #ifdeà
HAVE_SELECT


769 
METHOD_SELECT
:

770 
fd
 = 
i
;

771 ià(
	`FD_ISSET
(
fd
, &
rfds
))

772 
æags
 |ğ
FD_READ
;

773 ià(
	`FD_ISSET
(
fd
, &
wfds
))

774 
æags
 |ğ
FD_WRITE
;

775 ià(
	`FD_ISSET
(
fd
, &
efds
))

776 
æags
 |ğ
FD_EXCEPT
;

779 #ifdeà
HAVE_EPOLL


781 
METHOD_EPOLL
:

782 
fd
 = 
»
->
ev’ts
[
i
].
d©a
.fd;

784 ià(
»
->
ev’ts
[
i
].ev’t & 
EPOLLIN
)

785 
æags
 |ğ
FD_READ
;

786 ià(
»
->
ev’ts
[
i
].ev’t & 
EPOLLOUT
)

787 
æags
 |ğ
FD_WRITE
;

788 ià(
»
->
ev’ts
[
i
].ev’t & 
EPOLLERR
)

789 
æags
 |ğ
FD_EXCEPT
;

791 ià(!
æags
) {

792 
	`DEBUG_WARNING
("•Şl:‚Øæag fd=%d\n", 
fd
);

798 #ifdeà
HAVE_KQUEUE


799 
METHOD_KQUEUE
: {

801 
kev’t
 *
kev
 = &
»
->
evli¡
[
i
];

803 
fd
 = ()
kev
->
id’t
;

805 ià(
fd
 >ğ
»
->
maxfds
) {

806 
	`DEBUG_WARNING
("Ïrgfd=%d\n", 
fd
);

810 ià(
kev
->
f‹r
 =ğ
EVFILT_READ
)

811 
æags
 |ğ
FD_READ
;

812 ià(
kev
->
f‹r
 =ğ
EVFILT_WRITE
)

813 
æags
 |ğ
FD_WRITE
;

815 
	`DEBUG_WARNING
("kqueue: unhandled "

817 
kev
->
f‹r
);

820 ià(
kev
->
æags
 & 
EV_EOF
) {

821 
æags
 |ğ
FD_EXCEPT
;

823 ià(
kev
->
æags
 & 
EV_ERROR
) {

824 
	`DEBUG_WARNING
("kqueue: EV_ERROR on fd %d\n",

825 
fd
);

828 ià(!
æags
) {

829 
	`DEBUG_WARNING
("kqueue:‚Øæag fd=%d\n", 
fd
);

836  
EINVAL
;

839 ià(!
æags
)

842 ià(
»
->
fhs
[
fd
].
fh
) {

843 
	`´štf
("»->fhs[fd] i % \n",
»
->
fhs
[
fd
]);

845 #ià
MAIN_DEBUG


846 
	`fd_hªdËr
(
»
, 
fd
, 
æags
);

848 
»
->
fhs
[
fd
].
	`fh
(
æags
,„e->fhs[fd].
¬g
);

853 ià(
»
->
upd©e
) {

854 
»
->
upd©e
 = 
çl£
;

858 --
n
;

862 
	}
}

872 
	$fd_£tsize
(
maxfds
)

874 
»
 *» = 
	`»_g‘
();

876 ià(!
maxfds
) {

877 
	`fd_debug
();

878 
	`pŞl_şo£
(
»
);

882 ià(!
»
->
maxfds
)

883 
»
->
maxfds
 = maxfds;

885 ià(!
»
->
fhs
) {

886 
	`DEBUG_INFO
("fd_setsize: maxfds=%d,‡llocating %u bytes\n",

887 
»
->
maxfds
,„e->maxfd * (*»->
fhs
));

889 
»
->
fhs
 = 
	`mem_z®loc
Ôe->
maxfds
 * (*»->fhs), 
NULL
);

890 ià(!
»
->
fhs
)

891  
ENOMEM
;

895 
	}
}

901 
	$fd_debug
()

903 cÚ¡ 
»
 *» = 
	`»_g‘
();

904 
i
;

906 ià(!
»
->
fhs
)

909 
i
=0; i<
»
->
nfds
; i++) {

911 ià(!
»
->
fhs
[
i
].
æags
)

914 ()
	`»_årštf
(
¡d”r
,

916 
i
, 
»
->
fhs
[i].
æags
,„e->fhs[i].
fh
,

917 
»
->
fhs
[
i
].
¬g
);

919 
	}
}

922 #ifdeà
HAVE_SIGNAL


924 
	$sigÇl_hªdËr
(
sig
)

926 ()
	`sigÇl
(
sig
, 
sigÇl_hªdËr
);

927 
	`»_g‘
()->
sig
 = sig;

928 
	}
}

940 
	$»_maš
(
»_sigÇl_h
 *
sigÇlh
)

942 
»
 *» = 
	`»_g‘
();

943 
”r
;

944 #ifdeà
HAVE_SIGNAL


945 ià(
sigÇlh
) {

946 ()
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

947 ()
	`sigÇl
(
SIGALRM
, 
sigÇl_hªdËr
);

948 ()
	`sigÇl
(
SIGTERM
, 
sigÇl_hªdËr
);

952 ià(
»
->
pŞlšg
) {

953 
	`DEBUG_WARNING
("main†oop‡lready…olling\n");

954 
	`´štf
("main†oop‡lready…olling\n");

955  
EALREADY
;

958 
”r
 = 
	`pŞl_£tup
(
»
);

959 ià(
”r
)

960 
out
;

962 
	`DEBUG_INFO
("Using‡sync I/O…olling method: `%s'\n",

963 
	`pŞl_m‘hod_Çme
(
»
->
m‘hod
));

964 
	`´štf
("Using‡sync I/O…olling method: `%s'\n",

965 
	`pŞl_m‘hod_Çme
(
»
->
m‘hod
));

967 
»
->
pŞlšg
 = 
Œue
;

969 
	`»_lock
(
»
);

972 ià(
»
->
sig
) {

973 ià(
sigÇlh
)

974 
	`sigÇlh
(
»
->
sig
);

976 
»
->
sig
 = 0;

979 ià(!
»
->
pŞlšg
) {

980 
”r
 = 0;

983 
	`´štf
("re_main 3 \n");

985 
”r
 = 
	`fd_pŞl
(
»
);

986 ià(
”r
) {

987 ià(
EINTR
 =ğ
”r
)

990 #ifdeà
DARWIN


992 ià(
EBADF
 =ğ
”r
)

999 
	`tmr_pŞl
(&
»
->
tm¾
);

1001 
	`»_uÆock
(
»
);

1003 
out
:

1004 
»
->
pŞlšg
 = 
çl£
;

1006  
”r
;

1007 
	}
}

1013 
	$»_ÿnûl
()

1015 
»
 *» = 
	`»_g‘
();

1017 
»
->
pŞlšg
 = 
çl£
;

1018 
	}
}

1029 
	$»_debug
(
»_´štf
 *
pf
, *
unu£d
)

1031 
»
 *» = 
	`»_g‘
();

1032 
”r
 = 0;

1034 ()
unu£d
;

1036 
”r
 |ğ
	`»_h´štf
(
pf
, "re main†oop:\n");

1037 
”r
 |ğ
	`»_h´štf
(
pf
, " maxfds: %d\n", 
»
->
maxfds
);

1038 
”r
 |ğ
	`»_h´štf
(
pf
, "‚fds: %d\n", 
»
->
nfds
);

1039 
”r
 |ğ
	`»_h´štf
(
pf
, " m‘hod: %d (%s)\n", 
»
->
m‘hod
,

1040 
	`pŞl_m‘hod_Çme
(
»
->
m‘hod
));

1042  
”r
;

1043 
	}
}

1054 
	$pŞl_m‘hod_£t
(
pŞl_m‘hod
 
m‘hod
)

1056 
»
 *» = 
	`»_g‘
();

1057 
”r
;

1059 
”r
 = 
	`fd_£tsize
(
DEFAULT_MAXFDS
);

1060 ià(
”r
)

1061  
”r
;

1063 
m‘hod
) {

1065 #ifdeà
HAVE_POLL


1066 
METHOD_POLL
:

1069 #ifdeà
HAVE_SELECT


1070 
METHOD_SELECT
:

1071 ià(
»
->
maxfds
 > ()
FD_SETSIZE
) {

1072 
	`DEBUG_WARNING
("SELECT: maxfds > FD_SETSIZE\n");

1073  
EMFILE
;

1077 #ifdeà
HAVE_EPOLL


1078 
METHOD_EPOLL
:

1079 ià(!
	`•Şl_check
())

1080  
EINVAL
;

1083 #ifdeà
HAVE_KQUEUE


1084 
METHOD_KQUEUE
:

1088 
	`DEBUG_WARNING
("poll method‚ot supported: '%s'\n",

1089 
	`pŞl_m‘hod_Çme
(
m‘hod
));

1090  
EINVAL
;

1093 
»
->
m‘hod
 = method;

1094 
»
->
upd©e
 = 
Œue
;

1096 
	`DEBUG_INFO
("Setting‡sync I/O…olling methodo `%s'\n",

1097 
	`pŞl_m‘hod_Çme
(
»
->
m‘hod
));

1099 
”r
 = 
	`pŞl_š™
(
»
);

1100 ià(
”r
)

1101  
”r
;

1103  
	`»bud_fds
(
»
);

1104 
	}
}

1112 
	$»_th»ad_š™
()

1114 #ifdeà
HAVE_PTHREAD


1115 
»
 *re;

1117 
	`±h»ad_Úû
(&
±_Úû
, 
»_Úû
);

1119 
»
 = 
	`±h»ad_g‘¥ecific
(
±_key
);

1120 ià(
»
) {

1121 
	`DEBUG_WARNING
("thread_init:‡lready‡dded forhread %d\n",

1122 
	`±h»ad_£lf
());

1123  
EALREADY
;

1126 
»
 = 
	`m®loc
((*re));

1127 ià(!
»
)

1128  
ENOMEM
;

1130 
	`mem£t
(
»
, 0, (*re));

1131 
	`±h»ad_mu‹x_š™
(&
»
->
mu‹x
, 
NULL
);

1132 
»
->
mu‹xp
 = &»->
mu‹x
;

1134 #ifdeà
HAVE_EPOLL


1135 
»
->
•fd
 = -1;

1138 #ifdeà
HAVE_KQUEUE


1139 
»
->
kqfd
 = -1;

1142 
	`±h»ad_£t¥ecific
(
±_key
, 
»
);

1145  
ENOSYS
;

1147 
	}
}

1153 
	$»_th»ad_şo£
()

1155 #ifdeà
HAVE_PTHREAD


1156 
»
 *re;

1158 
	`±h»ad_Úû
(&
±_Úû
, 
»_Úû
);

1160 
»
 = 
	`±h»ad_g‘¥ecific
(
±_key
);

1161 ià(
»
) {

1162 
	`pŞl_şo£
(
»
);

1163 
	`ä“
(
»
);

1164 
	`±h»ad_£t¥ecific
(
±_key
, 
NULL
);

1167 
	}
}

1175 
	$»_th»ad_’‹r
()

1177 
	`»_lock
(
	`»_g‘
());

1178 
	}
}

1186 
	$»_th»ad_Ëave
()

1188 
	`»_uÆock
(
	`»_g‘
());

1189 
	}
}

1197 
	$»_£t_mu‹x
(*
mu‹xp
)

1199 #ifdeà
HAVE_PTHREAD


1200 
»
 *» = 
	`»_g‘
();

1202 
»
->
mu‹xp
 = mu‹x°? mu‹x°: &»->
mu‹x
;

1204 ()
mu‹xp
;

1206 
	}
}

1216 
li¡
 *
tm¾_g‘
();

1217 
li¡
 *
	$tm¾_g‘
()

1219  &
	`»_g‘
()->
tm¾
;

1220 
	}
}

	@re-0.5.6/src/main/main.h

8 #ifdeà
HAVE_EPOLL


9 
boŞ
 
•Şl_check
();

13 #ifdeà
__ılu¥lus


17 #ifdeà
USE_OPENSSL


18 
İ’s¦_š™
();

19 
İ’s¦_şo£
();

22 #ifdeà
__ılu¥lus


	@re-0.5.6/src/main/method.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_maš.h
>

10 
	~"maš.h
"

13 cÚ¡ 
	g¡r_pŞl
[] = "poll";

14 cÚ¡ 
	g¡r_£Ëù
[] = "select";

15 cÚ¡ 
	g¡r_•Şl
[] = "epoll";

16 cÚ¡ 
	g¡r_kqueue
[] = "kqueue";

24 
pŞl_m‘hod
 
	$pŞl_m‘hod_be¡
()

26 
pŞl_m‘hod
 
m
 = 
METHOD_NULL
;

28 #ifdeà
HAVE_EPOLL


30 ià(
METHOD_NULL
 =ğ
m
) {

31 ià(
	`•Şl_check
())

32 
m
 = 
METHOD_EPOLL
;

36 #ifdeà
HAVE_KQUEUE


37 ià(
METHOD_NULL
 =ğ
m
) {

38 
m
 = 
METHOD_KQUEUE
;

42 #ifdeà
HAVE_POLL


43 ià(
METHOD_NULL
 =ğ
m
) {

44 
m
 = 
METHOD_POLL
;

47 #ifdeà
HAVE_SELECT


48 ià(
METHOD_NULL
 =ğ
m
) {

49 
m
 = 
METHOD_SELECT
;

53  
m
;

54 
	}
}

64 cÚ¡ *
	$pŞl_m‘hod_Çme
(
pŞl_m‘hod
 
m‘hod
)

66 
m‘hod
) {

68 
METHOD_POLL
:  
¡r_pŞl
;

69 
METHOD_SELECT
:  
¡r_£Ëù
;

70 
METHOD_EPOLL
:  
¡r_•Şl
;

71 
METHOD_KQUEUE
:  
¡r_kqueue
;

74 
	}
}

85 
	$pŞl_m‘hod_ty³
(
pŞl_m‘hod
 *
m‘hod
, cÚ¡ 
¶
 *
Çme
)

87 ià(!
m‘hod
 || !
Çme
)

88  
EINVAL
;

90 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, 
¡r_pŞl
))

91 *
m‘hod
 = 
METHOD_POLL
;

92 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, 
¡r_£Ëù
))

93 *
m‘hod
 = 
METHOD_SELECT
;

94 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, 
¡r_•Şl
))

95 *
m‘hod
 = 
METHOD_EPOLL
;

96 ià(0 =ğ
	`¶_¡rÿ£cmp
(
Çme
, 
¡r_kqueue
))

97 *
m‘hod
 = 
METHOD_KQUEUE
;

99  
ENOENT
;

102 
	}
}

	@re-0.5.6/src/main/openssl.c

6 #ifdeà
HAVE_SIGNAL


7 
	~<sigÇl.h
>

9 #ifdeà
HAVE_PTHREAD


10 
	~<±h»ad.h
>

12 
	~<İ’s¦/üy±o.h
>

13 
	~<İ’s¦/s¦.h
>

14 
	~<İ’s¦/”r.h
>

15 
	~<»_ty³s.h
>

16 
	~<»_lock.h
>

17 
	~<»_mem.h
>

18 
	~"maš.h
"

21 #ià
defšed
 (
HAVE_PTHREAD
è&& (
OPENSSL_VERSION_NUMBER
 < 0x10100000L)

24 
±h»ad_mu‹x_t
 *
	glockv
;

27 
šlše
 
	$th»adid
()

29 #ià
	`defšed
 (
DARWIN
è|| defšed (
FREEBSD
è|| defšed (
OPENBSD
) || \

30 
	`defšed
 (
NETBSD
è|| defšed (
DRAGONFLY
)

31  ()(*)
	`±h»ad_£lf
();

33  ()
	`±h»ad_£lf
();

35 
	}
}

38 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10000000

39 
	$th»adid_hªdËr
(
CRYPTO_THREADID
 *
id
)

41 
	`CRYPTO_THREADID_£t_num”ic
(
id
, 
	`th»adid
());

42 
	}
}

44 
	$th»adid_hªdËr
()

46  
	`th»adid
();

47 
	}
}

51 
	$lockšg_hªdËr
(
mode
, 
ty³
, cÚ¡ *
fe
, 
lše
)

53 ()
fe
;

54 ()
lše
;

56 ià(
mode
 & 
CRYPTO_LOCK
)

57 ()
	`±h»ad_mu‹x_lock
(&
lockv
[
ty³
]);

59 ()
	`±h»ad_mu‹x_uÆock
(&
lockv
[
ty³
]);

60 
	}
}

66 #ià
OPENSSL_VERSION_NUMBER
 < 0x10100000L

67 
CRYPTO_dyÆock_v®ue
 *
	$dyÆock_ü—‹_hªdËr
(cÚ¡ *
fe
,

68 
lše
)

70 
lock
 *lock;

71 ()
fe
;

72 ()
lše
;

74 ià(
	`lock_®loc
(&
lock
))

75  
NULL
;

77  (
CRYPTO_dyÆock_v®ue
 *)
lock
;

78 
	}
}

81 
	$dyÆock_lock_hªdËr
(
mode
, 
CRYPTO_dyÆock_v®ue
 *
l
,

82 cÚ¡ *
fe
, 
lše
)

84 
lock
 *lock = (lock *)
l
;

85 ()
fe
;

86 ()
lše
;

88 ià(
mode
 & 
CRYPTO_LOCK
)

89 
	`lock_wr™e_g‘
(
lock
);

91 
	`lock_»l
(
lock
);

92 
	}
}

95 
	$dyÆock_de¡roy_hªdËr
(
CRYPTO_dyÆock_v®ue
 *
l
,

96 cÚ¡ *
fe
, 
lše
)

98 ()
fe
;

99 ()
lše
;

101 
	`mem_d”ef
(
l
);

102 
	}
}

106 #ifdeà
SIGPIPE


107 
	$sigpe_hªdËr
(
x
)

109 ()
x
;

110 ()
	`sigÇl
(
SIGPIPE
, 
sigpe_hªdËr
);

111 
	}
}

115 
	$İ’s¦_š™
()

117 #ià
	`defšed
 (
HAVE_PTHREAD
è&& (
OPENSSL_VERSION_NUMBER
 < 0x10100000L)

118 
”r
, 
i
;

120 
lockv
 = 
	`mem_z®loc
((
±h»ad_mu‹x_t
è* 
	`CRYPTO_num_locks
(), 
NULL
);

121 ià(!
lockv
)

122  
ENOMEM
;

124 
i
=0; i<
	`CRYPTO_num_locks
(); i++) {

126 
”r
 = 
	`±h»ad_mu‹x_š™
(&
lockv
[
i
], 
NULL
);

127 ià(
”r
) {

128 
lockv
 = 
	`mem_d”ef
(lockv);

129  
”r
;

133 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10000000

134 
	`CRYPTO_THREADID_£t_ÿÎback
(
th»adid_hªdËr
);

136 
	`CRYPTO_£t_id_ÿÎback
(
th»adid_hªdËr
);

139 
	`CRYPTO_£t_lockšg_ÿÎback
(
lockšg_hªdËr
);

142 #ià
OPENSSL_VERSION_NUMBER
 < 0x10100000L

143 
	`CRYPTO_£t_dyÆock_ü—‹_ÿÎback
(
dyÆock_ü—‹_hªdËr
);

144 
	`CRYPTO_£t_dyÆock_lock_ÿÎback
(
dyÆock_lock_hªdËr
);

145 
	`CRYPTO_£t_dyÆock_de¡roy_ÿÎback
(
dyÆock_de¡roy_hªdËr
);

148 #ifdeà
SIGPIPE


149 ()
	`sigÇl
(
SIGPIPE
, 
sigpe_hªdËr
);

152 
	`SSL_lib¿ry_š™
();

153 
	`SSL_lßd_”rÜ_¡ršgs
();

156 
	}
}

159 
	$İ’s¦_şo£
()

161 
	`ERR_ä“_¡ršgs
();

162 #ià
	`defšed
 (
HAVE_PTHREAD
è&& (
OPENSSL_VERSION_NUMBER
 < 0x10100000L)

163 
lockv
 = 
	`mem_d”ef
(lockv);

165 
	}
}

	@re-0.5.6/src/mbuf/mbuf.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

13 
	#DEBUG_MODULE
 "mbuf"

	)

14 
	#DEBUG_LEVEL
 4

	)

15 
	~<»_dbg.h
>

18 ’um {
	mDEFAULT_SIZE
=512};

21 
	$mbuf_de¡ruùÜ
(*
d©a
)

23 
mbuf
 *
mb
 = 
d©a
;

25 
	`mem_d”ef
(
mb
->
buf
);

26 
	}
}

36 
mbuf
 *
	$mbuf_®loc
(
size_t
 
size
)

38 
mbuf
 *
mb
;

40 
mb
 = 
	`mem_z®loc
((*mb), 
mbuf_de¡ruùÜ
);

41 ià(!
mb
)

42  
NULL
;

44 ià(
	`mbuf_»size
(
mb
, 
size
 ? siz: 
DEFAULT_SIZE
))

45  
	`mem_d”ef
(
mb
);

47  
mb
;

48 
	}
}

58 
mbuf
 *
	$mbuf_®loc_»f
(
mbuf
 *
mbr
)

60 
mbuf
 *
mb
;

62 ià(!
mbr
)

63  
NULL
;

65 
mb
 = 
	`mem_z®loc
((*mb), 
mbuf_de¡ruùÜ
);

66 ià(!
mb
)

67  
NULL
;

69 
mb
->
buf
 = 
	`mem_»f
(
mbr
->buf);

70 
mb
->
size
 = 
mbr
->size;

71 
mb
->
pos
 = 
mbr
->pos;

72 
mb
->
’d
 = 
mbr
->end;

74  
mb
;

75 
	}
}

83 
	$mbuf_š™
(
mbuf
 *
mb
)

85 ià(!
mb
)

88 
mb
->
buf
 = 
NULL
;

89 
mb
->
size
 = 0;

90 
mb
->
pos
 = 0;

91 
mb
->
’d
 = 0;

92 
	}
}

100 
	$mbuf_»£t
(
mbuf
 *
mb
)

102 ià(!
mb
)

105 
mb
->
buf
 = 
	`mem_d”ef
(mb->buf);

106 
	`mbuf_š™
(
mb
);

107 
	}
}

118 
	$mbuf_»size
(
mbuf
 *
mb
, 
size_t
 
size
)

120 
ušt8_t
 *
buf
;

122 ià(!
mb
)

123  
EINVAL
;

125 
buf
 = 
mb
->buà? 
	`mem_»®loc
(mb->buf, 
size
è: 
	`mem_®loc
(size, 
NULL
);

126 ià(!
buf
)

127  
ENOMEM
;

129 
mb
->
buf
 = buf;

130 
mb
->
size
 = size;

133 
	}
}

141 
	$mbuf_Œim
(
mbuf
 *
mb
)

143 
”r
;

145 ià(!
mb
 || !mb->
’d
 || mb->’d =ğmb->
size
)

149 
”r
 = 
	`mbuf_»size
(
mb
, mb->
’d
);

150 ià(
”r
) {

151 
	`DEBUG_WARNING
("Œim:„esizçed (%m)\n", 
”r
);

153 
	}
}

164 
	$mbuf_shiá
(
mbuf
 *
mb
, 
ssize_t
 
shiá
)

166 
size_t
 
rsize
;

167 
ušt8_t
 *
p
;

169 ià(!
mb
)

170  
EINVAL
;

172 ià(((
ssize_t
)
mb
->
pos
 + 
shiá
) < 0 ||

173 ((
ssize_t
)
mb
->
’d
 + 
shiá
) < 0)

174  
ERANGE
;

176 
rsize
 = 
mb
->
’d
 + 
shiá
;

178 ià(
rsize
 > 
mb
->
size
) {

180 
”r
;

182 
”r
 = 
	`mbuf_»size
(
mb
, 
rsize
);

183 ià(
”r
)

184  
”r
;

187 
p
 = 
	`mbuf_buf
(
mb
);

189 
	`memmove
(
p
 + 
shiá
,…, 
	`mbuf_g‘_Ëá
(
mb
));

191 
mb
->
pos
 +ğ
shiá
;

192 
mb
->
’d
 +ğ
shiá
;

195 
	}
}

207 
	$mbuf_wr™e_mem
(
mbuf
 *
mb
, cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
size
)

209 
size_t
 
rsize
;

211 ià(!
mb
 || !
buf
)

212  
EINVAL
;

214 
rsize
 = 
mb
->
pos
 + 
size
;

216 ià(
rsize
 > 
mb
->
size
) {

217 cÚ¡ 
size_t
 
dsize
 = 
mb
->
size
 ? (mb->size * 2)

218 : 
DEFAULT_SIZE
;

219 
”r
;

221 
”r
 = 
	`mbuf_»size
(
mb
, 
	`MAX
(
rsize
, 
dsize
));

222 ià(
”r
)

223  
”r
;

226 
	`memıy
(
mb
->
buf
 + mb->
pos
, buf, 
size
);

228 
mb
->
pos
 +ğ
size
;

229 
mb
->
’d
 = 
	`MAX
(mb->’d, mb->
pos
);

232 
	}
}

243 
	$mbuf_wr™e_u8
(
mbuf
 *
mb
, 
ušt8_t
 
v
)

245  
	`mbuf_wr™e_mem
(
mb
, (
ušt8_t
 *)&
v
, (v));

246 
	}
}

257 
	$mbuf_wr™e_u16
(
mbuf
 *
mb
, 
ušt16_t
 
v
)

259  
	`mbuf_wr™e_mem
(
mb
, (
ušt8_t
 *)&
v
, (v));

260 
	}
}

271 
	$mbuf_wr™e_u32
(
mbuf
 *
mb
, 
ušt32_t
 
v
)

273  
	`mbuf_wr™e_mem
(
mb
, (
ušt8_t
 *)&
v
, (v));

274 
	}
}

285 
	$mbuf_wr™e_u64
(
mbuf
 *
mb
, 
ušt64_t
 
v
)

287  
	`mbuf_wr™e_mem
(
mb
, (
ušt8_t
 *)&
v
, (v));

288 
	}
}

299 
	$mbuf_wr™e_¡r
(
mbuf
 *
mb
, cÚ¡ *
¡r
)

301 ià(!
¡r
)

302  
EINVAL
;

304  
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
¡r
, 
	`¡¾’
(str));

305 
	}
}

316 
	$mbuf_wr™e_¶
(
mbuf
 *
mb
, cÚ¡ 
¶
 *pl)

318 ià(!
¶
)

319  
EINVAL
;

321  
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
¶
->
p
,…l->
l
);

322 
	}
}

334 
	$mbuf_»ad_mem
(
mbuf
 *
mb
, 
ušt8_t
 *
buf
, 
size_t
 
size
)

336 ià(!
mb
 || !
buf
)

337  
EINVAL
;

339 ià(
size
 > 
	`mbuf_g‘_Ëá
(
mb
)) {

340 
	`DEBUG_WARNING
("triedo„ead beyond mbufƒnd (%u > %u)\n",

341 
size
, 
	`mbuf_g‘_Ëá
(
mb
));

342  
EOVERFLOW
;

345 
	`memıy
(
buf
, 
mb
->buà+ mb->
pos
, 
size
);

347 
mb
->
pos
 +ğ
size
;

350 
	}
}

360 
ušt8_t
 
	$mbuf_»ad_u8
(
mbuf
 *
mb
)

362 
ušt8_t
 
v
;

364  (0 =ğ
	`mbuf_»ad_mem
(
mb
, &
v
, (v))) ? v : 0;

365 
	}
}

375 
ušt16_t
 
	$mbuf_»ad_u16
(
mbuf
 *
mb
)

377 
ušt16_t
 
v
;

379  (0 =ğ
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)&
v
, (v))) ? v : 0;

380 
	}
}

390 
ušt32_t
 
	$mbuf_»ad_u32
(
mbuf
 *
mb
)

392 
ušt32_t
 
v
;

394  (0 =ğ
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)&
v
, (v))) ? v : 0;

395 
	}
}

405 
ušt64_t
 
	$mbuf_»ad_u64
(
mbuf
 *
mb
)

407 
ušt64_t
 
v
;

409  (0 =ğ
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)&
v
, (v))) ? v : 0;

410 
	}
}

422 
	$mbuf_»ad_¡r
(
mbuf
 *
mb
, *
¡r
, 
size_t
 
size
)

424 ià(!
mb
 || !
¡r
)

425  
EINVAL
;

427 
size
--) {

428 cÚ¡ 
ušt8_t
 
c
 = 
	`mbuf_»ad_u8
(
mb
);

429 *
¡r
++ = 
c
;

430 ià('\0' =ğ
c
)

435 
	}
}

447 
	$mbuf_¡rdup
(
mbuf
 *
mb
, **
¡½
, 
size_t
 
Ën
)

449 *
¡r
;

450 
”r
;

452 ià(!
mb
 || !
¡½
)

453  
EINVAL
;

455 
¡r
 = 
	`mem_®loc
(
Ën
 + 1, 
NULL
);

456 ià(!
¡r
)

457  
ENOMEM
;

459 
”r
 = 
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)
¡r
, 
Ën
);

460 ià(
”r
)

461 
out
;

463 
¡r
[
Ën
] = '\0';

465 
out
:

466 ià(
”r
)

467 
	`mem_d”ef
(
¡r
);

469 *
¡½
 = 
¡r
;

471  
”r
;

472 
	}
}

475 
	$v´štf_hªdËr
(cÚ¡ *
p
, 
size_t
 
size
, *
¬g
)

477 
mbuf
 *
mb
 = 
¬g
;

479  
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
p
, 
size
);

480 
	}
}

492 
	$mbuf_v´štf
(
mbuf
 *
mb
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

494  
	`»_vh´štf
(
fmt
, 
­
, 
v´štf_hªdËr
, 
mb
);

495 
	}
}

506 
	$mbuf_´štf
(
mbuf
 *
mb
, cÚ¡ *
fmt
, ...)

508 
”r
 = 0;

509 
va_li¡
 
­
;

511 
	`va_¡¬t
(
­
, 
fmt
);

512 
”r
 = 
	`»_vh´štf
(
fmt
, 
­
, 
v´štf_hªdËr
, 
mb
);

513 
	`va_’d
(
­
);

515  
”r
;

516 
	}
}

530 
	$mbuf_wr™e_¶_sk
(
mbuf
 *
mb
, cÚ¡ 
¶
 *pl,

531 cÚ¡ 
¶
 *
sk
)

533 
¶
 
r
;

534 
”r
;

536 ià(!
¶
 || !
sk
)

537  
EINVAL
;

539 ià(
¶
->
p
 > 
sk
->°|| (sk->°+ sk->
l
) > (pl->p +…l->l))

540  
ERANGE
;

542 
r
.
p
 = 
¶
->p;

543 
r
.
l
 = 
sk
->
p
 - 
¶
->p;

545 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
r
.
p
,„.
l
);

546 ià(
”r
)

547  
”r
;

549 
r
.
p
 = 
sk
->°+ sk->
l
;

550 
r
.
l
 = 
¶
->
p
 +…l->l -„.p;

552  
	`mbuf_wr™e_mem
(
mb
, (cÚ¡ 
ušt8_t
 *)
r
.
p
,„.
l
);

553 
	}
}

565 
	$mbuf_fl
(
mbuf
 *
mb
, 
ušt8_t
 
c
, 
size_t
 
n
)

567 
size_t
 
rsize
;

569 ià(!
mb
 || !
n
)

570  
EINVAL
;

572 
rsize
 = 
mb
->
pos
 + 
n
;

574 ià(
rsize
 > 
mb
->
size
) {

575 cÚ¡ 
size_t
 
dsize
 = 
mb
->
size
 ? (mb->size * 2)

576 : 
DEFAULT_SIZE
;

577 
”r
;

579 
”r
 = 
	`mbuf_»size
(
mb
, 
	`MAX
(
rsize
, 
dsize
));

580 ià(
”r
)

581  
”r
;

584 
	`mem£t
(
mb
->
buf
 + mb->
pos
, 
c
, 
n
);

586 
mb
->
pos
 +ğ
n
;

587 
mb
->
’d
 = 
	`MAX
(mb->’d, mb->
pos
);

590 
	}
}

601 
	$mbuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
mbuf
 *
mb
)

603 ià(!
mb
)

606  
	`»_h´štf
(
pf
, "buf=%p…os=%zuƒnd=%zu size=%zu",

607 
mb
->
buf
, mb->
pos
, mb->
’d
, mb->
size
);

608 
	}
}

	@re-0.5.6/src/md5/md5.c

54 
	~"md5.h
"

55 
	~<¡ršg.h
>

57 #undeà
BYTE_ORDER


58 #ifdeà
ARCH_IS_BIG_ENDIAN


59 
	#BYTE_ORDER
 (
ARCH_IS_BIG_ENDIAN
 ? 1 : -1)

	)

61 
	#BYTE_ORDER
 0

	)

64 
	#T_MASK
 ((
md5_wÜd_t
)~0)

	)

65 
	#T1
 (
T_MASK
 ^ 0x28955b87)

	)

66 
	#T2
 (
T_MASK
 ^ 0x173848a9)

	)

67 
	#T3
 0x242070db

	)

68 
	#T4
 (
T_MASK
 ^ 0x3e423111)

	)

69 
	#T5
 (
T_MASK
 ^ 0x0a83f050)

	)

70 
	#T6
 0x4787c62a

	)

71 
	#T7
 (
T_MASK
 ^ 0x57cfb9ec)

	)

72 
	#T8
 (
T_MASK
 ^ 0x02b96aã)

	)

73 
	#T9
 0x698098d8

	)

74 
	#T10
 (
T_MASK
 ^ 0x74bb0850)

	)

75 
	#T11
 (
T_MASK
 ^ 0x0000a44e)

	)

76 
	#T12
 (
T_MASK
 ^ 0x76a32841)

	)

77 
	#T13
 0x6b901122

	)

78 
	#T14
 (
T_MASK
 ^ 0x02678e6c)

	)

79 
	#T15
 (
T_MASK
 ^ 0x5986bc71)

	)

80 
	#T16
 0x49b40821

	)

81 
	#T17
 (
T_MASK
 ^ 0x09e1da9d)

	)

82 
	#T18
 (
T_MASK
 ^ 0x3fbf4cbf)

	)

83 
	#T19
 0x265e5a51

	)

84 
	#T20
 (
T_MASK
 ^ 0x16493855)

	)

85 
	#T21
 (
T_MASK
 ^ 0x29d0eç2)

	)

86 
	#T22
 0x02441453

	)

87 
	#T23
 (
T_MASK
 ^ 0x275e197e)

	)

88 
	#T24
 (
T_MASK
 ^ 0x182c0437)

	)

89 
	#T25
 0x21e1cde6

	)

90 
	#T26
 (
T_MASK
 ^ 0x3cc8f829)

	)

91 
	#T27
 (
T_MASK
 ^ 0x0b2af278)

	)

92 
	#T28
 0x455a14ed

	)

93 
	#T29
 (
T_MASK
 ^ 0x561c16ç)

	)

94 
	#T30
 (
T_MASK
 ^ 0x03105c07)

	)

95 
	#T31
 0x676f02d9

	)

96 
	#T32
 (
T_MASK
 ^ 0x72d5b375)

	)

97 
	#T33
 (
T_MASK
 ^ 0x0005c6bd)

	)

98 
	#T34
 (
T_MASK
 ^ 0x788e097e)

	)

99 
	#T35
 0x6d9d6122

	)

100 
	#T36
 (
T_MASK
 ^ 0x021ac7f3)

	)

101 
	#T37
 (
T_MASK
 ^ 0x5b4115bb)

	)

102 
	#T38
 0x4bdecç9

	)

103 
	#T39
 (
T_MASK
 ^ 0x0944b49f)

	)

104 
	#T40
 (
T_MASK
 ^ 0x4140438f)

	)

105 
	#T41
 0x289b7ec6

	)

106 
	#T42
 (
T_MASK
 ^ 0x155ed805)

	)

107 
	#T43
 (
T_MASK
 ^ 0x2b10cf7a)

	)

108 
	#T44
 0x04881d05

	)

109 
	#T45
 (
T_MASK
 ^ 0x262b2fc6)

	)

110 
	#T46
 (
T_MASK
 ^ 0x1924661a)

	)

111 
	#T47
 0x1ç27cf8

	)

112 
	#T48
 (
T_MASK
 ^ 0x3b53a99a)

	)

113 
	#T49
 (
T_MASK
 ^ 0x0bd6ddbb)

	)

114 
	#T50
 0x432aff97

	)

115 
	#T51
 (
T_MASK
 ^ 0x546bdc58)

	)

116 
	#T52
 (
T_MASK
 ^ 0x036c5fc6)

	)

117 
	#T53
 0x655b59c3

	)

118 
	#T54
 (
T_MASK
 ^ 0x70f3336d)

	)

119 
	#T55
 (
T_MASK
 ^ 0x00100b82)

	)

120 
	#T56
 (
T_MASK
 ^ 0x7a7ba22e)

	)

121 
	#T57
 0x6ç87e4f

	)

122 
	#T58
 (
T_MASK
 ^ 0x01d3191f)

	)

123 
	#T59
 (
T_MASK
 ^ 0x5cãbûb)

	)

124 
	#T60
 0x4e0811a1

	)

125 
	#T61
 (
T_MASK
 ^ 0x08ac817d)

	)

126 
	#T62
 (
T_MASK
 ^ 0x42c50dÿ)

	)

127 
	#T63
 0x2ad7d2bb

	)

128 
	#T64
 (
T_MASK
 ^ 0x14792c6e)

	)

132 
	$md5_´oûss
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
 )

134 
md5_wÜd_t


135 
a
 = 
pms
->
abcd
[0], 
b
 =…ms->abcd[1],

136 
c
 = 
pms
->
abcd
[2], 
d
 =…ms->abcd[3];

137 
md5_wÜd_t
 
t
;

138 #ià
BYTE_ORDER
 > 0

140 
md5_wÜd_t
 
X
[16];

143 
md5_wÜd_t
 
xbuf
[16];

144 cÚ¡ 
md5_wÜd_t
 *
X
;

148 #ià
BYTE_ORDER
 == 0

154 cÚ¡ 
w
 = 1;

156 ià(*((cÚ¡ 
md5_by‹_t
 *)&
w
))

158 #ià
BYTE_ORDER
 <= 0

164 ià(!((
d©a
 - (cÚ¡ 
md5_by‹_t
 *)0) & 3)) {

166 
X
 = (cÚ¡ 
md5_wÜd_t
 *)(*)
d©a
;

170 
	`memıy
(
xbuf
, 
d©a
, 64);

171 
X
 = 
xbuf
;

175 #ià
BYTE_ORDER
 == 0

178 #ià
BYTE_ORDER
 >= 0

184 cÚ¡ 
md5_by‹_t
 *
xp
 = 
d©a
;

185 
i
;

187 #ià
BYTE_ORDER
 == 0

188 
X
 = 
xbuf
;

190 
	#xbuf
 
X


	)

192 
i
 = 0; i < 16; ++i, 
xp
 += 4)

193 
xbuf
[
i
] = 
xp
[0] + (xp[1] << 8)

194 + (
xp
[2] << 16)

195 + (
xp
[3] << 24);

200 
	#ROTATE_LEFT
(
x
, 
n
è(((xè<< (n)è| ((xè>> (32 - (n))))

	)

205 
	#F
(
x
, 
y
, 
z
è(((xè& (y)è| (~(xè& (z)))

	)

206 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

207 
t
 = 
a
 + 
	`F
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
; \

208 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

210 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 7, 
T1
);

211 
	`SET
(
d
, 
a
, 
b
, 
c
, 1, 12, 
T2
);

212 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 17, 
T3
);

213 
	`SET
(
b
, 
c
, 
d
, 
a
, 3, 22, 
T4
);

214 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 7, 
T5
);

215 
	`SET
(
d
, 
a
, 
b
, 
c
, 5, 12, 
T6
);

216 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 17, 
T7
);

217 
	`SET
(
b
, 
c
, 
d
, 
a
, 7, 22, 
T8
);

218 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 7, 
T9
);

219 
	`SET
(
d
, 
a
, 
b
, 
c
, 9, 12, 
T10
);

220 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 17, 
T11
);

221 
	`SET
(
b
, 
c
, 
d
, 
a
, 11, 22, 
T12
);

222 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 7, 
T13
);

223 
	`SET
(
d
, 
a
, 
b
, 
c
, 13, 12, 
T14
);

224 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 17, 
T15
);

225 
	`SET
(
b
, 
c
, 
d
, 
a
, 15, 22, 
T16
);

226 #undeà
SET


231 
	#G
(
x
, 
y
, 
z
è(((xè& (z)è| ((yè& ~(z)))

	)

232 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

233 
t
 = 
a
 + 
	`G
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
; \

234 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

236 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 5, 
T17
);

237 
	`SET
(
d
, 
a
, 
b
, 
c
, 6, 9, 
T18
);

238 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 14, 
T19
);

239 
	`SET
(
b
, 
c
, 
d
, 
a
, 0, 20, 
T20
);

240 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 5, 
T21
);

241 
	`SET
(
d
, 
a
, 
b
, 
c
, 10, 9, 
T22
);

242 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 14, 
T23
);

243 
	`SET
(
b
, 
c
, 
d
, 
a
, 4, 20, 
T24
);

244 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 5, 
T25
);

245 
	`SET
(
d
, 
a
, 
b
, 
c
, 14, 9, 
T26
);

246 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 14, 
T27
);

247 
	`SET
(
b
, 
c
, 
d
, 
a
, 8, 20, 
T28
);

248 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 5, 
T29
);

249 
	`SET
(
d
, 
a
, 
b
, 
c
, 2, 9, 
T30
);

250 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 14, 
T31
);

251 
	`SET
(
b
, 
c
, 
d
, 
a
, 12, 20, 
T32
);

252 #undeà
SET


257 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

258 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

259 
t
 = 
a
 + 
	`H
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
; \

260 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

262 
	`SET
(
a
, 
b
, 
c
, 
d
, 5, 4, 
T33
);

263 
	`SET
(
d
, 
a
, 
b
, 
c
, 8, 11, 
T34
);

264 
	`SET
(
c
, 
d
, 
a
, 
b
, 11, 16, 
T35
);

265 
	`SET
(
b
, 
c
, 
d
, 
a
, 14, 23, 
T36
);

266 
	`SET
(
a
, 
b
, 
c
, 
d
, 1, 4, 
T37
);

267 
	`SET
(
d
, 
a
, 
b
, 
c
, 4, 11, 
T38
);

268 
	`SET
(
c
, 
d
, 
a
, 
b
, 7, 16, 
T39
);

269 
	`SET
(
b
, 
c
, 
d
, 
a
, 10, 23, 
T40
);

270 
	`SET
(
a
, 
b
, 
c
, 
d
, 13, 4, 
T41
);

271 
	`SET
(
d
, 
a
, 
b
, 
c
, 0, 11, 
T42
);

272 
	`SET
(
c
, 
d
, 
a
, 
b
, 3, 16, 
T43
);

273 
	`SET
(
b
, 
c
, 
d
, 
a
, 6, 23, 
T44
);

274 
	`SET
(
a
, 
b
, 
c
, 
d
, 9, 4, 
T45
);

275 
	`SET
(
d
, 
a
, 
b
, 
c
, 12, 11, 
T46
);

276 
	`SET
(
c
, 
d
, 
a
, 
b
, 15, 16, 
T47
);

277 
	`SET
(
b
, 
c
, 
d
, 
a
, 2, 23, 
T48
);

278 #undeà
SET


283 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| ~(z)))

	)

284 
	#SET
(
a
, 
b
, 
c
, 
d
, 
k
, 
s
, 
Ti
)\

285 
t
 = 
a
 + 
	`I
(
b
,
c
,
d
è+ 
X
[
k
] + 
Ti
; \

286 
a
 = 
	`ROTATE_LEFT
(
t
, 
s
è+ 
b


	)

288 
	`SET
(
a
, 
b
, 
c
, 
d
, 0, 6, 
T49
);

289 
	`SET
(
d
, 
a
, 
b
, 
c
, 7, 10, 
T50
);

290 
	`SET
(
c
, 
d
, 
a
, 
b
, 14, 15, 
T51
);

291 
	`SET
(
b
, 
c
, 
d
, 
a
, 5, 21, 
T52
);

292 
	`SET
(
a
, 
b
, 
c
, 
d
, 12, 6, 
T53
);

293 
	`SET
(
d
, 
a
, 
b
, 
c
, 3, 10, 
T54
);

294 
	`SET
(
c
, 
d
, 
a
, 
b
, 10, 15, 
T55
);

295 
	`SET
(
b
, 
c
, 
d
, 
a
, 1, 21, 
T56
);

296 
	`SET
(
a
, 
b
, 
c
, 
d
, 8, 6, 
T57
);

297 
	`SET
(
d
, 
a
, 
b
, 
c
, 15, 10, 
T58
);

298 
	`SET
(
c
, 
d
, 
a
, 
b
, 6, 15, 
T59
);

299 
	`SET
(
b
, 
c
, 
d
, 
a
, 13, 21, 
T60
);

300 
	`SET
(
a
, 
b
, 
c
, 
d
, 4, 6, 
T61
);

301 
	`SET
(
d
, 
a
, 
b
, 
c
, 11, 10, 
T62
);

302 
	`SET
(
c
, 
d
, 
a
, 
b
, 2, 15, 
T63
);

303 
	`SET
(
b
, 
c
, 
d
, 
a
, 9, 21, 
T64
);

304 #undeà
SET


309 
pms
->
abcd
[0] +ğ
a
;

310 
pms
->
abcd
[1] +ğ
b
;

311 
pms
->
abcd
[2] +ğ
c
;

312 
pms
->
abcd
[3] +ğ
d
;

313 
	}
}

316 
	$md5_š™
(
md5_¡©e_t
 *
pms
)

318 
pms
->
couÁ
[0] =…ms->count[1] = 0;

319 
pms
->
abcd
[0] = 0x67452301;

320 
pms
->
abcd
[1] = 
T_MASK
 ^ 0x10325476;

321 
pms
->
abcd
[2] = 
T_MASK
 ^ 0x67452301;

322 
pms
->
abcd
[3] = 0x10325476;

323 
	}
}

326 
	$md5_­³nd
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
, 
nby‹s
)

328 cÚ¡ 
md5_by‹_t
 *
p
 = 
d©a
;

329 
Ëá
 = 
nby‹s
;

330 
off£t
 = (
pms
->
couÁ
[0] >> 3) & 63;

331 
md5_wÜd_t
 
nb™s
 = (md5_wÜd_t)(
nby‹s
 << 3);

333 ià(
nby‹s
 <= 0)

337 
pms
->
couÁ
[1] +ğ
nby‹s
 >> 29;

338 
pms
->
couÁ
[0] +ğ
nb™s
;

339 ià(
pms
->
couÁ
[0] < 
nb™s
)

340 
pms
->
couÁ
[1]++;

343 ià(
off£t
) {

344 
cİy
 = (
off£t
 + 
nby‹s
 > 64 ? 64 - offset :‚bytes);

346 
	`memıy
(
pms
->
buf
 + 
off£t
, 
p
, 
cİy
);

347 ià(
off£t
 + 
cİy
 < 64)

349 
p
 +ğ
cİy
;

350 
Ëá
 -ğ
cİy
;

351 
	`md5_´oûss
(
pms
,…ms->
buf
);

355 ; 
Ëá
 >ğ64; 
p
 += 64,†eft -= 64)

356 
	`md5_´oûss
(
pms
, 
p
);

359 ià(
Ëá
)

360 
	`memıy
(
pms
->
buf
, 
p
, 
Ëá
);

361 
	}
}

364 
	$md5_fšish
(
md5_¡©e_t
 *
pms
, 
md5_by‹_t
 
dige¡
[16])

366 cÚ¡ 
md5_by‹_t
 
·d
[64] = {

372 
md5_by‹_t
 
d©a
[8];

373 
i
;

376 
i
 = 0; i < 8; ++i)

377 
d©a
[
i
] = (
md5_by‹_t
)(
pms
->
couÁ
[i >> 2] >> ((i & 3) << 3));

379 
	`md5_­³nd
(
pms
, 
·d
, ((55 - (pms->
couÁ
[0] >> 3)) & 63) + 1);

381 
	`md5_­³nd
(
pms
, 
d©a
, 8);

382 
i
 = 0; i < 16; ++i)

383 
dige¡
[
i
] = (
md5_by‹_t
)(
pms
->
abcd
[i >> 2] >> ((i & 3) << 3));

384 
	}
}

	@re-0.5.6/src/md5/md5.h

50 #iâdeà
md5_INCLUDED


51 
	#md5_INCLUDED


	)

63 
	tmd5_by‹_t
;

64 
	tmd5_wÜd_t
;

67 
	smd5_¡©e_s
 {

68 
md5_wÜd_t
 
	mcouÁ
[2];

69 
md5_wÜd_t
 
	mabcd
[4];

70 
md5_by‹_t
 
	mbuf
[64];

71 } 
	tmd5_¡©e_t
;

73 #ifdeà
__ılu¥lus


79 
md5_š™
(
md5_¡©e_t
 *
pms
);

82 
md5_­³nd
(
md5_¡©e_t
 *
pms
, cÚ¡ 
md5_by‹_t
 *
d©a
, 
nby‹s
);

85 
md5_fšish
(
md5_¡©e_t
 *
pms
, 
md5_by‹_t
 
dige¡
[16]);

87 #ifdeà
__ılu¥lus


	@re-0.5.6/src/md5/wrap.c

6 #ifdeà
USE_OPENSSL


7 
	~<¡ddef.h
>

8 
	~<İ’s¦/md5.h
>

10 
	~"md5.h
"

12 
	~<»_ty³s.h
>

13 
	~<»_fmt.h
>

14 
	~<»_mem.h
>

15 
	~<»_mbuf.h
>

16 
	~<»_md5.h
>

26 
	$md5
(cÚ¡ 
ušt8_t
 *
d
, 
size_t
 
n
, ušt8_ˆ*
md
)

28 #ifdeà
USE_OPENSSL


29 ()
	`MD5
(
d
, 
n
, 
md
);

31 
md5_¡©e_t
 
¡©e
;

33 
	`md5_š™
(&
¡©e
);

34 
	`md5_­³nd
(&
¡©e
, 
d
, ()
n
);

35 
	`md5_fšish
(&
¡©e
, 
md
);

37 
	}
}

48 
	$md5_´štf
(
ušt8_t
 *
md
, cÚ¡ *
fmt
, ...)

50 
mbuf
 
mb
;

51 
va_li¡
 
­
;

52 
”r
;

54 
	`mbuf_š™
(&
mb
);

56 
	`va_¡¬t
(
­
, 
fmt
);

57 
”r
 = 
	`mbuf_v´štf
(&
mb
, 
fmt
, 
­
);

58 
	`va_’d
(
­
);

60 ià(!
”r
)

61 
	`md5
(
mb
.
buf
, mb.
’d
, 
md
);

63 
	`mbuf_»£t
(&
mb
);

65  
”r
;

66 
	}
}

	@re-0.5.6/src/mem/mem.c

6 
	~<ùy³.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 #ifdeà
HAVE_PTHREAD


10 
	~<±h»ad.h
>

12 
	~<»_ty³s.h
>

13 
	~<»_li¡.h
>

14 
	~<»_fmt.h
>

15 
	~<»_mbuf.h
>

16 
	~<»_mem.h
>

19 
	#DEBUG_MODULE
 "mem"

	)

20 
	#DEBUG_LEVEL
 5

	)

21 
	~<»_dbg.h
>

24 #iâdeà
RELEASE


25 
	#MEM_DEBUG
 1

	)

30 
	smem
 {

31 
ušt32_t
 
	mÄefs
;

32 
mem_de¡roy_h
 *
	mdh
;

33 #ià
MEM_DEBUG


34 
Ë
 
	mË
;

35 
ušt32_t
 
	mmagic
;

36 
size_t
 
	msize
;

40 #ià
MEM_DEBUG


42 
li¡
 
	gmeml
 = 
LIST_INIT
;

43 cÚ¡ 
ušt32_t
 
	gmem_magic
 = 0xe7fb9ac4;

44 
ssize_t
 
	gth»shŞd
 = -1;

46 
mem¡©
 
	gmem¡©
 = {

50 #ifdeà
HAVE_PTHREAD


52 
±h»ad_mu‹x_t
 
	gmem_mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

54 
šlše
 
	$mem_lock
()

56 
	`±h»ad_mu‹x_lock
(&
mem_mu‹x
);

57 
	}
}

60 
šlše
 
	$mem_uÆock
()

62 
	`±h»ad_mu‹x_uÆock
(&
mem_mu‹x
);

63 
	}
}

67 
	#mem_lock
(è

	)

68 
	#mem_uÆock
(è

	)

73 
	#STAT_ALLOC
(
m
, 
size
) \

74 
	`mem_lock
(); \

75 
mem¡©
.
by‹s_cur
 +ğ(
size
); \

76 
mem¡©
.
by‹s_³ak
 = 
	`max
(mem¡©.
by‹s_cur
, memstat.bytes_peak); \

77 ++
mem¡©
.
blocks_cur
; \

78 
mem¡©
.
blocks_³ak
 = 
	`max
(mem¡©.
blocks_cur
, memstat.blocks_peak); \

79 
mem¡©
.
size_mš
 = 
	`mš
(mem¡©.size_mš, 
size
); \

80 
mem¡©
.
size_max
 = 
	`max
(mem¡©.size_max, 
size
); \

81 
	`mem_uÆock
(); \

82 (
m
)->
size
 = (size); \

83 (
m
)->
magic
 = 
mem_magic
;

	)

86 
	#STAT_REALLOC
(
m
, 
size
) \

87 
	`mem_lock
(); \

88 
mem¡©
.
by‹s_cur
 +ğ((
size
è- (
m
)->size); \

89 
mem¡©
.
by‹s_³ak
 = 
	`max
(mem¡©.
by‹s_cur
, memstat.bytes_peak); \

90 
mem¡©
.
size_mš
 = 
	`mš
(mem¡©.size_mš, 
size
); \

91 
mem¡©
.
size_max
 = 
	`max
(mem¡©.size_max, 
size
); \

92 
	`mem_uÆock
(); \

93 (
m
)->
size
 = (size)

	)

96 
	#STAT_DEREF
(
m
) \

97 
	`mem_lock
(); \

98 
mem¡©
.
by‹s_cur
 -ğ(
m
)->
size
; \

99 --
mem¡©
.
blocks_cur
; \

100 
	`mem_uÆock
(); \

101 
	`mem£t
((
m
), 0xb5, (
mem
è+ (m)->
size
)

	)

104 
	#MAGIC_CHECK
(
m
) \

105 ià(
mem_magic
 !ğ(
m
)->
magic
) { \

106 
	`DEBUG_WARNING
("%s: magic check failed 0x%08x (%p)\n", \

107 
__REFUNC__
, (
m
)->
magic
, (m)+1); \

108 
BREAKPOINT
; \

109 }

	)

111 
	#STAT_ALLOC
(
m
, 
size
)

	)

112 
	#STAT_REALLOC
(
m
, 
size
)

	)

113 
	#STAT_DEREF
(
m
)

	)

114 
	#MAGIC_CHECK
(
m
)

	)

126 *
	$mem_®loc
(
size_t
 
size
, 
mem_de¡roy_h
 *
dh
)

128 
mem
 *
m
;

130 #ià
MEM_DEBUG


131 
	`mem_lock
();

132 ià(-1 !ğ
th»shŞd
 && (
mem¡©
.
blocks_cur
 >ğ(
size_t
)threshold)) {

133 
	`mem_uÆock
();

134  
NULL
;

136 
	`mem_uÆock
();

139 
m
 = 
	`m®loc
((*mè+ 
size
);

140 ià(!
m
)

141  
NULL
;

143 #ià
MEM_DEBUG


144 
	`mem£t
(&
m
->
Ë
, 0, (le));

145 
	`mem_lock
();

146 
	`li¡_­³nd
(&
meml
, &
m
->
Ë
, m);

147 
	`mem_uÆock
();

150 
m
->
Äefs
 = 1;

151 
m
->
dh
 = dh;

153 
	`STAT_ALLOC
(
m
, 
size
);

155  (*)(
m
 + 1);

156 
	}
}

167 *
	$mem_z®loc
(
size_t
 
size
, 
mem_de¡roy_h
 *
dh
)

169 *
p
;

171 
p
 = 
	`mem_®loc
(
size
, 
dh
);

172 ià(!
p
)

173  
NULL
;

175 
	`mem£t
(
p
, 0, 
size
);

177  
p
;

178 
	}
}

191 *
	$mem_»®loc
(*
d©a
, 
size_t
 
size
)

193 
mem
 *
m
, *
m2
;

195 ià(!
d©a
)

196  
NULL
;

198 
m
 = ((
mem
 *)
d©a
) - 1;

200 
	`MAGIC_CHECK
(
m
);

202 #ià
MEM_DEBUG


203 
	`mem_lock
();

206 ià(-1 !ğ
th»shŞd
 && 
size
 > 
m
->size) {

207 ià(
mem¡©
.
blocks_cur
 >ğ(
size_t
)
th»shŞd
) {

208 
	`mem_uÆock
();

209  
NULL
;

213 
	`li¡_uÆšk
(&
m
->
Ë
);

214 
	`mem_uÆock
();

217 
m2
 = 
	`»®loc
(
m
, (*m2è+ 
size
);

219 #ià
MEM_DEBUG


220 
	`mem_lock
();

221 
	`li¡_­³nd
(&
meml
, 
m2
 ? &m2->
Ë
 : &
m
->le, m2 ? m2 : m);

222 
	`mem_uÆock
();

225 ià(!
m2
) {

226  
NULL
;

229 
	`STAT_REALLOC
(
m2
, 
size
);

231  (*)(
m2
 + 1);

232 
	}
}

235 #iâdeà
SIZE_MAX


236 
	#SIZE_MAX
 (~((
size_t
)0))

	)

250 *
	$mem_»®loÿ¼ay
(*
±r
, 
size_t
 
nmemb
, size_ˆ
membsize
,

251 
mem_de¡roy_h
 *
dh
)

253 
size_t
 
tsize
;

255 ià(
membsize
 && 
nmemb
 > 
SIZE_MAX
 / membsize) {

256  
NULL
;

259 
tsize
 = 
nmemb
 * 
membsize
;

261 ià(
±r
) {

262  
	`mem_»®loc
(
±r
, 
tsize
);

265  
	`mem_®loc
(
tsize
, 
dh
);

267 
	}
}

277 *
	$mem_»f
(*
d©a
)

279 
mem
 *
m
;

281 ià(!
d©a
)

282  
NULL
;

284 
m
 = ((
mem
 *)
d©a
) - 1;

286 
	`MAGIC_CHECK
(
m
);

288 ++
m
->
Äefs
;

290  
d©a
;

291 
	}
}

303 *
	$mem_d”ef
(*
d©a
)

305 
mem
 *
m
;

307 ià(!
d©a
)

308  
NULL
;

310 
m
 = ((
mem
 *)
d©a
) - 1;

312 
	`MAGIC_CHECK
(
m
);

314 ià(--
m
->
Äefs
 > 0)

315  
NULL
;

317 ià(
m
->
dh
)

318 
m
->
	`dh
(
d©a
);

321 ià(
m
->
Äefs
 > 0)

322  
NULL
;

324 #ià
MEM_DEBUG


325 
	`mem_lock
();

326 
	`li¡_uÆšk
(&
m
->
Ë
);

327 
	`mem_uÆock
();

330 
	`STAT_DEREF
(
m
);

332 
	`ä“
(
m
);

334  
NULL
;

335 
	}
}

345 
ušt32_t
 
	$mem_Äefs
(cÚ¡ *
d©a
)

347 
mem
 *
m
;

349 ià(!
d©a
)

352 
m
 = ((
mem
 *)
d©a
) - 1;

354 
	`MAGIC_CHECK
(
m
);

356  
m
->
Äefs
;

357 
	}
}

360 #ià
MEM_DEBUG


361 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

363 
mem
 *
m
 = 
Ë
->
d©a
;

364 cÚ¡ 
ušt8_t
 *
p
 = (cÚ¡ ušt8_ˆ*)(
m
 + 1);

365 
size_t
 
i
;

367 ()
¬g
;

369 ()
	`»_årštf
(
¡d”r
, " %p:‚»fs=%-2u", 
p
, 
m
->
Äefs
);

371 ()
	`»_årštf
(
¡d”r
, " size=%-7u", 
m
->
size
);

373 ()
	`»_årštf
(
¡d”r
, " [");

375 
i
=0; i<16; i++) {

376 ià(
i
 >ğ
m
->
size
)

377 ()
	`»_årštf
(
¡d”r
, " ");

379 ()
	`»_årštf
(
¡d”r
, "%02x ", 
p
[
i
]);

382 ()
	`»_årštf
(
¡d”r
, "] [");

384 
i
=0; i<16; i++) {

385 ià(
i
 >ğ
m
->
size
)

386 ()
	`»_årštf
(
¡d”r
, " ");

388 ()
	`»_årštf
(
¡d”r
, "%c",

389 
	`i¥ršt
(
p
[
i
]) ?…[i] : '.');

392 ()
	`»_årštf
(
¡d”r
, "]");

394 
	`MAGIC_CHECK
(
m
);

396 ()
	`»_årštf
(
¡d”r
, "\n");

398  
çl£
;

399 
	}
}

406 
	$mem_debug
()

408 #ià
MEM_DEBUG


409 
ušt32_t
 
n
;

411 
	`mem_lock
();

412 
n
 = 
	`li¡_couÁ
(&
meml
);

413 
	`mem_uÆock
();

415 ià(!
n
)

418 
	`DEBUG_WARNING
("MemÜy†—k (%u):\n", 
n
);

420 
	`mem_lock
();

421 ()
	`li¡_­¶y
(&
meml
, 
Œue
, 
debug_hªdËr
, 
NULL
);

422 
	`mem_uÆock
();

424 
	}
}

433 
	$mem_th»shŞd_£t
(
ssize_t
 
n
)

435 #ià
MEM_DEBUG


436 
	`mem_lock
();

437 
th»shŞd
 = 
n
;

438 
	`mem_uÆock
();

440 ()
n
;

442 
	}
}

453 
	$mem_¡©us
(
»_´štf
 *
pf
, *
unu£d
)

455 #ià
MEM_DEBUG


456 
mem¡©
 
¡©
;

457 
ušt32_t
 
c
;

458 
”r
 = 0;

460 ()
unu£d
;

462 
	`mem_lock
();

463 
	`memıy
(&
¡©
, &
mem¡©
, (stat));

464 
c
 = 
	`li¡_couÁ
(&
meml
);

465 
	`mem_uÆock
();

467 
”r
 |ğ
	`»_h´štf
(
pf
, "Memory status: (%u bytes overhead…r block)\n",

468 (
mem
));

469 
”r
 |ğ
	`»_h´štf
(
pf
, " Cur: %u blocks, %u bytes (total %u bytes)\n",

470 
¡©
.
blocks_cur
, st.
by‹s_cur
,

471 
¡©
.
by‹s_cur


472 +(
¡©
.
blocks_cur
*(
mem
)));

473 
”r
 |ğ
	`»_h´štf
(
pf
, " Peak: %u blocks, %u bytes (total %u bytes)\n",

474 
¡©
.
blocks_³ak
, st.
by‹s_³ak
,

475 
¡©
.
by‹s_³ak


476 +(
¡©
.
blocks_³ak
*(
mem
)));

477 
”r
 |ğ
	`»_h´štf
(
pf
, " Block size: min=%u, max=%u\n",

478 
¡©
.
size_mš
, st.
size_max
);

479 
”r
 |ğ
	`»_h´štf
(
pf
, " TÙ® %u block ®loÿ‹d\n", 
c
);

481  
”r
;

483 ()
pf
;

484 ()
unu£d
;

487 
	}
}

497 
	$mem_g‘_¡©
(
mem¡©
 *
m¡©
)

499 ià(!
m¡©
)

500  
EINVAL
;

501 #ià
MEM_DEBUG


502 
	`mem_lock
();

503 
	`memıy
(
m¡©
, &
mem¡©
, (*mstat));

504 
	`mem_uÆock
();

507  
ENOSYS
;

509 
	}
}

	@re-0.5.6/src/mod/dl.c

6 
	~<dlfú.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~"mod_š‹º®.h
"

12 
	#DEBUG_MODULE
 "dl"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

16 #ifdeà
CYGWIN


17 
	#RTLD_LOCAL
 0

	)

20 cÚ¡ 
	gdl_æag
 = 
RTLD_NOW
 | 
RTLD_LOCAL
;

30 *
	$_mod_İ’
(cÚ¡ *
Çme
)

32 *
h
;

34 ià(!
Çme
)

35  
NULL
;

37 
h
 = 
	`dlİ’
(
Çme
, 
dl_æag
);

38 ià(!
h
) {

39 
	`DEBUG_WARNING
("mod: % (%s)\n", 
Çme
, 
	`dË¼Ü
());

40  
NULL
;

43  
h
;

44 
	}
}

55 *
	$_mod_sym
(*
h
, cÚ¡ *
symbŞ
)

57 *
sym
;

58 cÚ¡ *
”r
;

60 ià(!
h
 || !
symbŞ
)

61  
NULL
;

63 ()
	`dË¼Ü
();

65 
sym
 = 
	`dlsym
(
h
, 
symbŞ
);

66 
”r
 = 
	`dË¼Ü
();

67 ià(
”r
) {

68 
	`DEBUG_WARNING
("dlsym: %s\n", 
”r
);

69  
NULL
;

72  
sym
;

73 
	}
}

81 
	$_mod_şo£
(*
h
)

83 
”r
;

85 ià(!
h
)

88 
”r
 = 
	`dlşo£
(
h
);

89 ià(0 !ğ
”r
) {

90 
	`DEBUG_WARNING
("dlşo£: %d\n", 
”r
);

92 
	}
}

	@re-0.5.6/src/mod/mod.c

6 
	~<sys/ty³s.h
>

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_li¡.h
>

13 
	~<»_mod.h
>

14 
	~"mod_š‹º®.h
"

17 
	#DEBUG_MODULE
 "mod"

	)

18 
	#DEBUG_LEVEL
 5

	)

19 
	~<»_dbg.h
>

23 
	smod
 {

24 
Ë
 
	mË
;

25 *
	mh
;

26 cÚ¡ 
mod_expÜt
 *
	mme
;

30 
li¡
 
	gmodl
;

36 
	$mod_š™
()

38 
	`li¡_š™
(&
modl
);

39 
	}
}

45 
	$mod_şo£
()

47 
	`li¡_æush
(&
modl
);

48 
	}
}

51 
	$mod_de¡ruùÜ
(*
d©a
)

53 
mod
 *
m
 = 
d©a
;

54 cÚ¡ 
mod_expÜt
 *
me
 = 
m
->me;

55 
”r
;

57 ià(
me
 && me->
şo£
 && (
”r
 = me->
	`şo£
())) {

58 
	`DEBUG_NOTICE
("şo£:ƒ¼Ü (%m)\n", 
”r
);

61 
	`li¡_uÆšk
(&
m
->
Ë
);

63 
	`_mod_şo£
(
m
->
h
);

64 
	}
}

74 
mod
 *
	$mod_fšd
(cÚ¡ *
Çme
)

76 
Ë
 *le;

77 
¶
 
x
;

79 ià(!
Çme
)

80  
NULL
;

82 ià(
	`»_»gex
(
Çme
, 
	`¡¾’
Òame), "[/]*[^./]+" 
MOD_EXT
, 
NULL
, &
x
))

83  
NULL
;

85 
Ë
 = 
modl
.
h—d
;†e;†ğË->
Ãxt
) {

86 
mod
 *
m
 = 
Ë
->
d©a
;

88 ià(0 =ğ
	`¶_¡rÿ£cmp
(&
x
, 
m
->
me
->
Çme
))

89  
m
;

92  
NULL
;

93 
	}
}

104 
	$mod_lßd
(
mod
 **
mp
, cÚ¡ *
Çme
)

106 
mod
 *
m
;

107 
”r
 = 0;

109 ià(!
mp
 || !
Çme
)

110  
EINVAL
;

113 
m
 = 
	`mod_fšd
(
Çme
);

114 ià(
m
) {

115 
	`DEBUG_NOTICE
("moduË‡Ì—dy†ßded: %s\n", 
Çme
);

116  
EALREADY
;

119 
m
 = 
	`mem_z®loc
((*m), 
mod_de¡ruùÜ
);

120 ià(!
m
)

121  
ENOMEM
;

123 
	`li¡_­³nd
(&
modl
, &
m
->
Ë
, m);

125 
m
->
h
 = 
	`_mod_İ’
(
Çme
);

126 ià(!
m
->
h
) {

127 
”r
 = 
ENOENT
;

128 
out
;

131 
m
->
me
 = 
	`_mod_sym
(m->
h
, "exports");

132 ià(!
m
->
me
) {

133 
”r
 = 
ELIBBAD
;

134 
out
;

137 ià(
m
->
me
->
š™
 && (
”r
 = m->me->
	`š™
()))

138 
out
;

140 
out
:

141 ià(
”r
)

142 
	`mem_d”ef
(
m
);

144 *
mp
 = 
m
;

146  
”r
;

147 
	}
}

158 
	$mod_add
(
mod
 **
mp
, cÚ¡ 
mod_expÜt
 *
me
)

160 
mod
 *
m
;

161 
”r
 = 0;

163 ià(!
mp
 || !
me
)

164  
EINVAL
;

167 
m
 = 
	`mod_fšd
(
me
->
Çme
);

168 ià(
m
) {

169 
	`DEBUG_NOTICE
("moduË‡Ì—dy†ßded: %s\n", 
me
->
Çme
);

170  
EALREADY
;

173 
m
 = 
	`mem_z®loc
((*m), 
mod_de¡ruùÜ
);

174 ià(!
m
)

175  
ENOMEM
;

177 
	`li¡_­³nd
(&
modl
, &
m
->
Ë
, m);

179 
m
->
me
 = me;

181 ià(
m
->
me
->
š™
)

182 
”r
 = 
m
->
me
->
	`š™
();

184 ià(
”r
)

185 
	`mem_d”ef
(
m
);

187 *
mp
 = 
m
;

189  
”r
;

190 
	}
}

200 cÚ¡ 
mod_expÜt
 *
	$mod_expÜt
(cÚ¡ 
mod
 *
m
)

202  
m
 ? m->
me
 : 
NULL
;

203 
	}
}

211 
li¡
 *
	$mod_li¡
()

213  &
modl
;

214 
	}
}

225 
	$mod_debug
(
»_´štf
 *
pf
, *
unu£d
)

227 
Ë
 *le;

228 
”r
;

230 ()
unu£d
;

232 
”r
 = 
	`»_h´štf
(
pf
, "\n--- ModuË (%uè---\n", 
	`li¡_couÁ
(&
modl
));

234 
Ë
 = 
modl
.
h—d
;†&& !
”r
;†ğË->
Ãxt
) {

235 cÚ¡ 
mod
 *
m
 = 
Ë
->
d©a
;

236 cÚ¡ 
mod_expÜt
 *
me
 = 
m
->me;

238 
”r
 = 
	`»_h´štf
(
pf
, " %16sype=%-12s„ef=%u\n",

239 
me
->
Çme
, me->
ty³
, 
	`mem_Äefs
(
m
));

242 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

244  
”r
;

245 
	}
}

	@re-0.5.6/src/mod/mod_internal.h

8 #ifdeà
__ılu¥lus


13 *
_mod_İ’
(cÚ¡ *
Çme
);

14 *
_mod_sym
(*
h
, cÚ¡ *
symbŞ
);

15 
_mod_şo£
(*
h
);

18 #ifdeà
__ılu¥lus


	@re-0.5.6/src/mod/win32/dll.c

6 
	~<wšdows.h
>

7 
	~<»_ty³s.h
>

8 
	~"../mod_š‹º®.h
"

11 
	#DEBUG_MODULE
 "dÎ"

	)

12 
	#DEBUG_LEVEL
 5

	)

13 
	~<»_dbg.h
>

23 *
	$_mod_İ’
(cÚ¡ *
Çme
)

25 
HINSTANCE
 
DÎHªdË
 = 0;

27 
	`DEBUG_INFO
("lßdšg %s\n", 
Çme
);

29 
DÎHªdË
 = 
	`LßdLib¿ryA
(
Çme
);

30 ià(!
DÎHªdË
) {

31 
	`DEBUG_WARNING
("İ’: % LßdLib¿ryA(èçed\n", 
Çme
);

32  
NULL
;

35  
DÎHªdË
;

36 
	}
}

47 *
	$_mod_sym
(*
h
, cÚ¡ *
symbŞ
)

49 
HINSTANCE
 
DÎHªdË
 = (HINSTANCE)
h
;

51 
FARPROC
 
sym
;

52 *
±r
;

53 } 
u
;

55 ià(!
DÎHªdË
)

56  
NULL
;

58 
	`DEBUG_INFO
("g‘ symbŞ: %s\n", 
symbŞ
);

60 
u
.
sym
 = 
	`G‘ProcAdd»ss
(
DÎHªdË
, 
symbŞ
);

61 ià(!
u
.
sym
) {

62 
	`DEBUG_WARNING
("G‘ProcAdd»ss:‚ØsymbŞ %s\n", 
symbŞ
);

63  
NULL
;

66  
u
.
±r
;

67 
	}
}

75 
	$_mod_şo£
(*
h
)

77 
HINSTANCE
 
DÎHªdË
 = (HINSTANCE)
h
;

79 
	`DEBUG_INFO
("uÆßdšg %p\n", 
h
);

81 ià(!
DÎHªdË
)

84 
	`F»eLib¿ry
(
DÎHªdË
);

85 
	}
}

	@re-0.5.6/src/mqueue/mqueue.c

6 
	~<uni¡d.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_maš.h
>

11 
	~<»_mqueue.h
>

12 
	~"mqueue.h
"

15 
	#MAGIC
 0x14553399

	)

18 #ifdeà
WIN32


19 
	~<wšsock2.h
>

20 
	~<ws2tı.h
>

21 
	#şo£
 
şo£sock‘


	)

32 
	smqueue
 {

33 
	mpfd
[2];

34 
mqueue_h
 *
	mh
;

35 *
	m¬g
;

38 
	smsg
 {

39 *
	md©a
;

40 
ušt32_t
 
	mmagic
;

41 
	mid
;

45 
	$de¡ruùÜ
(*
¬g
)

47 
mqueue
 *
q
 = 
¬g
;

49 ià(
q
->
pfd
[0] >= 0) {

50 
	`fd_şo£
(
q
->
pfd
[0]);

51 ()
	`şo£
(
q
->
pfd
[0]);

53 ià(
q
->
pfd
[1] >= 0)

54 ()
	`şo£
(
q
->
pfd
[1]);

55 
	}
}

58 
	$ev’t_hªdËr
(
æags
, *
¬g
)

60 
mqueue
 *
mq
 = 
¬g
;

61 
msg
 msg;

62 
ssize_t
 
n
;

64 ià(!(
æags
 & 
FD_READ
))

67 
n
 = 
	`pe_»ad
(
mq
->
pfd
[0], &
msg
, (msg));

68 ià(
n
 < 0)

71 ià(
n
 !ğ(
msg
)) {

72 ()
	`»_årštf
(
¡d”r
, "mqueue: short„ead of %d bytes\n",

73 
n
);

77 ià(
msg
.
magic
 !ğ
MAGIC
) {

78 ()
	`»_årštf
(
¡d”r
, "mqueue: bad magic on„ead (%08x)\n",

79 
msg
.
magic
);

83 
mq
->
	`h
(
msg
.
id
, msg.
d©a
, mq->
¬g
);

84 
	}
}

96 
	$mqueue_®loc
(
mqueue
 **
mqp
, 
mqueue_h
 *
h
, *
¬g
)

98 
mqueue
 *
mq
;

99 
”r
 = 0;

101 ià(!
mqp
 || !
h
)

102  
EINVAL
;

104 
mq
 = 
	`mem_z®loc
((*mq), 
de¡ruùÜ
);

105 ià(!
mq
)

106  
ENOMEM
;

108 
mq
->
h
 = h;

109 
mq
->
¬g
 =‡rg;

111 
mq
->
pfd
[0] = mq->pfd[1] = -1;

112 ià(
	`pe
(
mq
->
pfd
) < 0) {

113 
”r
 = 
”ºo
;

114 
out
;

117 
”r
 = 
	`fd_li¡’
(
mq
->
pfd
[0], 
FD_READ
, 
ev’t_hªdËr
, mq);

118 ià(
”r
)

119 
out
;

121 
out
:

122 ià(
”r
)

123 
	`mem_d”ef
(
mq
);

125 *
mqp
 = 
mq
;

127  
”r
;

128 
	}
}

140 
	$mqueue_push
(
mqueue
 *
mq
, 
id
, *
d©a
)

142 
msg
 msg;

143 
ssize_t
 
n
;

145 ià(!
mq
)

146  
EINVAL
;

148 
msg
.
id
 = id;

149 
msg
.
d©a
 = data;

150 
msg
.
magic
 = 
MAGIC
;

152 
n
 = 
	`pe_wr™e
(
mq
->
pfd
[1], &
msg
, (msg));

153 ià(
n
 < 0)

154  
”ºo
;

156  (
n
 !ğ(
msg
)è? 
EPIPE
 : 0;

157 
	}
}

	@re-0.5.6/src/mqueue/mqueue.h

8 #ifdeà
WIN32


9 
pe
(
fds
[2]);

10 
ssize_t
 
pe_»ad
(
s
, *
buf
, 
size_t
 
Ën
);

11 
ssize_t
 
pe_wr™e
(
s
, cÚ¡ *
buf
, 
size_t
 
Ën
);

13 
šlše
 
ssize_t
 
	$pe_»ad
(
s
, *
buf
, 
size_t
 
Ën
)

15  
	`»ad
(
s
, 
buf
, 
Ën
);

16 
	}
}

19 
šlše
 
ssize_t
 
	$pe_wr™e
(
s
, cÚ¡ *
buf
, 
size_t
 
Ën
)

21  
	`wr™e
(
s
, 
buf
, 
Ën
);

22 
	}
}

	@re-0.5.6/src/mqueue/win32/pipe.c

6 
	~<wšsock2.h
>

7 
	~<»_ty³s.h
>

8 
	~"../mqueue.h
"

12 
	$pe
(
fds
[2])

14 
SOCKET
 
s
, 
rd
, 
wr
;

15 
sockaddr_š
 
£rv_addr
;

16 
Ën
 = (
£rv_addr
);

18 ià((
s
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)è=ğ
INVALID_SOCKET
)

19  
ENOSYS
;

21 
	`mem£t
((*è&
£rv_addr
, 0, (serv_addr));

22 
£rv_addr
.
sš_çmy
 = 
AF_INET
;

23 
£rv_addr
.
sš_pÜt
 = 
	`htÚs
(0);

24 
£rv_addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

25 ià(
	`bšd
(
s
, (
SOCKADDR
 *è& 
£rv_addr
, 
Ën
è=ğ
SOCKET_ERROR
)

26 
”rÜ
;

28 ià(
	`li¡’
(
s
, 1è=ğ
SOCKET_ERROR
)

29 
”rÜ
;

31 ià(
	`g‘sockÇme
(
s
, (
SOCKADDR
 *è&
£rv_addr
, &
Ën
è=ğ
SOCKET_ERROR
)

32 
”rÜ
;

34 ià((
wr
 = 
	`sock‘
(
PF_INET
, 
SOCK_STREAM
, 0)è=ğ
INVALID_SOCKET
)

35 
”rÜ
;

37 ià(
	`cÚÃù
(
wr
, (
SOCKADDR
 *è&
£rv_addr
, 
Ën
è=ğ
SOCKET_ERROR
) {

38 
	`şo£sock‘
(
wr
);

39 
”rÜ
;

42 
rd
 = 
	`acû±
(
s
, (
SOCKADDR
 *è&
£rv_addr
, &
Ën
);

43 ià(
rd
 =ğ
INVALID_SOCKET
) {

44 
	`şo£sock‘
(
wr
);

45 
”rÜ
;

48 
fds
[0] = 
rd
;

49 
fds
[1] = 
wr
;

51 
	`şo£sock‘
(
s
);

54 
”rÜ
:

55 
	`şo£sock‘
(
s
);

56  
ENOSYS
;

57 
	}
}

60 
ssize_t
 
	$pe_»ad
(
s
, *
buf
, 
size_t
 
Ën
)

62 
»t
 = 
	`»cv
(
s
, 
buf
, 
Ën
, 0);

64 ià(
»t
 < 0 && 
	`WSAG‘La¡E¼Ü
(è=ğ
WSAECONNRESET
)

65 
»t
 = 0;

67  
»t
;

68 
	}
}

71 
ssize_t
 
	$pe_wr™e
(
s
, cÚ¡ *
buf
, 
size_t
 
Ën
)

73  
	`£nd
(
s
, 
buf
, 
Ën
, 0);

74 
	}
}

	@re-0.5.6/src/msg/ctype.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_msg.h
>

19 
	$msg_ùy³_decode
(
msg_ùy³
 *
ùy³
, cÚ¡ 
¶
 *pl)

21 
¶
 
ws
;

23 ià(!
ùy³
 || !
¶
)

24  
EINVAL
;

26 ià(
	`»_»gex
(
¶
->
p
,…l->
l
,

29 &
ws
, &
ùy³
->
ty³
, 
NULL
, NULL, &ùy³->
subty³
,

30 &
ùy³
->
·¿ms
))

31  
EBADMSG
;

33 ià(
ws
.
p
 !ğ
¶
->p)

34  
EBADMSG
;

37 
	}
}

49 
boŞ
 
	$msg_ùy³_cmp
(cÚ¡ 
msg_ùy³
 *
ùy³
,

50 cÚ¡ *
ty³
, cÚ¡ *
subty³
)

52 ià(!
ùy³
 || !
ty³
 || !
subty³
)

53  
çl£
;

55 ià(
	`¶_¡rÿ£cmp
(&
ùy³
->
ty³
,ype))

56  
çl£
;

58 ià(
	`¶_¡rÿ£cmp
(&
ùy³
->
subty³
, subtype))

59  
çl£
;

61  
Œue
;

62 
	}
}

	@re-0.5.6/src/msg/param.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_msg.h
>

20 
	$msg_·¿m_exi¡s
(cÚ¡ 
¶
 *¶, cÚ¡ *
Çme
, ¶ *
v®
)

22 
¶
 
v1
, 
v2
;

23 
x´
[128];

25 ià(!
¶
 || !
Çme
 || !
v®
)

26  
EINVAL
;

28 ()
	`»_¢´štf
(
x´
, (x´), ";[ \t\r\n]*%s[ \t\r\n;=]*", 
Çme
);

30 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, 
x´
, &
v1
, &
v2
))

31  
ENOENT
;

33 ià(!
v2
.
l
 && v2.
p
 < 
¶
->p +…l->l)

34  
ENOENT
;

36 
v®
->
p
 = 
v1
.p - 1;

37 
v®
->
l
 = 
v2
.
p
 - val->p;

40 
	}
}

52 
	$msg_·¿m_decode
(cÚ¡ 
¶
 *¶, cÚ¡ *
Çme
, ¶ *
v®
)

54 
ex´
[128];

55 
¶
 
v
;

57 ià(!
¶
 || !
Çme
 || !
v®
)

58  
EINVAL
;

60 ()
	`»_¢´štf
(
ex´
, (expr),

62 
Çme
);

64 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, 
ex´
, 
NULL
, NULL, NULL, &
v
))

65  
ENOENT
;

67 *
v®
 = 
v
;

70 
	}
}

	@re-0.5.6/src/natbd/filtering.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_¡un.h
>

13 
	~<»_Çtbd.h
>

16 
	#DEBUG_MODULE
 "Çtbd_f‹ršg"

	)

17 
	#DEBUG_LEVEL
 5

	)

18 
	~<»_dbg.h
>

49 
	sÇt_f‹ršg
 {

50 
¡un
 *
	m¡un
;

51 
§
 
	m¤v
;

52 
	m‹¡_pha£
;

53 
Çt_f‹ršg_h
 *
	mfh
;

54 *
	m¬g
;

58 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

59 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

61 
¡un_chªge_»q
 
chªge_»q
;

62 
Çt_f‹ršg
 *
nf
 = 
¬g
;

63 
¡un_©Œ
 *
©Œ
;

64 ()
»asÚ
;

66 ià(
”r
 =ğ
ECONNABORTED
) {

67 
nf
->
	`fh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

71 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_OTHER_ADDR
);

72 ià(!
”r
 && !
©Œ
) {

73 
	`DEBUG_WARNING
("no OTHER-ADDRESS in„esponse -‡bort\n");

74 
nf
->
	`fh
(
EINVAL
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

78 
nf
->
‹¡_pha£
) {

83 ià(
”r
 || 
scode
) {

84 
	`DEBUG_WARNING
("Test I: stun_response_handler: %m\n",

85 
”r
);

86 
nf
->
	`fh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

98 ++
nf
->
‹¡_pha£
;

100 
chªge_»q
.

 = 
Œue
;

101 
chªge_»q
.
pÜt
 = 
Œue
;

103 
”r
 = 
	`¡un_»que¡
(
NULL
, 
nf
->
¡un
, 
IPPROTO_UDP
, NULL, &nf->
¤v
,

104 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

105 
¡un_»¥Ú£_hªdËr
, 
nf
, 2,

106 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
,

107 
STUN_ATTR_CHANGE_REQ
, &
chªge_»q
);

108 ià(
”r
) {

109 
	`DEBUG_WARNING
("¡unc_»que¡_£nd: (%m)\n", 
”r
);

110 
nf
->
	`fh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

122 ià(0 =ğ
”r
) {

123 ià(!
scode
) {

124 
nf
->
	`fh
(0, 
NAT_TYPE_ENDP_INDEP
,‚f->
¬g
);

127 
nf
->
	`fh
(
EINVAL
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

136 ++
nf
->
‹¡_pha£
;

138 
chªge_»q
.

 = 
çl£
;

139 
chªge_»q
.
pÜt
 = 
Œue
;

141 
”r
 = 
	`¡un_»que¡
(
NULL
, 
nf
->
¡un
, 
IPPROTO_UDP
, NULL, &nf->
¤v
,

142 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

143 
¡un_»¥Ú£_hªdËr
, 
nf
, 2,

144 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
,

145 
STUN_ATTR_CHANGE_REQ
, &
chªge_»q
);

146 ià(
”r
) {

147 
	`DEBUG_WARNING
("¡unc_»que¡_£nd: (%m)\n", 
”r
);

148 
nf
->
	`fh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

154 
	`DEBUG_INFO
("Test III completed\n");

156 ià(0 =ğ
”r
 && !
scode
) {

157 
nf
->
	`fh
(0, 
NAT_TYPE_ADDR_DEP
,‚f->
¬g
);

160 
nf
->
	`fh
(0, 
NAT_TYPE_ADDR_PORT_DEP
,‚f->
¬g
);

165 
	`DEBUG_WARNING
("šv®ide¡…ha£ %d\n", 
nf
->
‹¡_pha£
);

166 
nf
->
	`fh
(
EINVAL
, 
NAT_TYPE_UNKNOWN
,‚f->
¬g
);

169 
	}
}

172 
	$f‹ršg_de¡ruùÜ
(*
d©a
)

174 
Çt_f‹ršg
 *
nf
 = 
d©a
;

176 
	`mem_d”ef
(
nf
->
¡un
);

177 
	}
}

191 
	$Çt_f‹ršg_®loc
(
Çt_f‹ršg
 **
nå
, cÚ¡ 
§
 *
¤v
,

192 cÚ¡ 
¡un_cÚf
 *
cÚf
,

193 
Çt_f‹ršg_h
 *
fh
, *
¬g
)

195 
Çt_f‹ršg
 *
nf
;

196 
”r
;

198 ià(!
nå
 || !
¤v
 || !
fh
)

199  
EINVAL
;

201 
nf
 = 
	`mem_z®loc
((*nf), 
f‹ršg_de¡ruùÜ
);

202 ià(!
nf
)

203  
ENOMEM
;

205 
”r
 = 
	`¡un_®loc
(&
nf
->
¡un
, 
cÚf
, 
NULL
, NULL);

206 ià(
”r
)

207 
out
;

209 
	`§_ıy
(&
nf
->
¤v
, srv);

211 
nf
->
fh
 = fh;

212 
nf
->
¬g
 =‡rg;

214 
out
:

215 ià(
”r
)

216 
	`mem_d”ef
(
nf
);

218 *
nå
 = 
nf
;

220  
”r
;

221 
	}
}

231 
	$Çt_f‹ršg_¡¬t
(
Çt_f‹ršg
 *
nf
)

233 ià(!
nf
)

234  
EINVAL
;

236 
nf
->
‹¡_pha£
 = 1;

238  
	`¡un_»que¡
(
NULL
, 
nf
->
¡un
, 
IPPROTO_UDP
, NULL, &nf->
¤v
, 0,

239 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

240 
¡un_»¥Ú£_hªdËr
, 
nf
, 1,

241 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

242 
	}
}

	@re-0.5.6/src/natbd/genalg.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_¡un.h
>

13 
	~<»_Çtbd.h
>

16 
	#DEBUG_MODULE
 "Çtbd_g’®g"

	)

17 
	#DEBUG_LEVEL
 7

	)

18 
	~<»_dbg.h
>

35 
	sÇt_g’®g
 {

36 
¡un
 *
	m¡un
;

37 
§
 
	m¤v
;

38 
	m´Ùo
;

39 
Çt_g’®g_h
 *
	mh
;

40 *
	m¬g
;

44 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

45 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

47 
¡un_©Œ
 *
xm­
, *
m­
;

48 
Çt_g’®g
 *
ng
 = 
¬g
;

49 
¡©us
 = 0;

50 ()
»asÚ
;

52 ià(
”r
) {

53 
ng
->
	`h
(
”r
, 0, 
NULL
, -1, NULL,‚g->
¬g
);

57 
scode
) {

60 
m­
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

61 
xm­
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

62 ià(!
m­
 || !
xm­
) {

63 
ng
->
	`h
(
EINVAL
, 
scode
, 
»asÚ
, -1, 
NULL
,‚g->
¬g
);

67 
¡©us
 = 
	`§_cmp
(&
m­
->
v
.
§
, &
xm­
->v.§, 
SA_ALL
) ? -1 : 1;

69 
ng
->
	`h
(0, 
scode
, 
»asÚ
, 
¡©us
, &
xm­
->
v
.
§
,‚g->
¬g
);

73 
ng
->
	`h
(0, 
scode
, 
»asÚ
, -1, 
NULL
,‚g->
¬g
);

76 
	}
}

79 
	$g’®g_de¡ruùÜ
(*
d©a
)

81 
Çt_g’®g
 *
ng
 = 
d©a
;

83 
	`mem_d”ef
(
ng
->
¡un
);

84 
	}
}

99 
	$Çt_g’®g_®loc
(
Çt_g’®g
 **
ngp
, cÚ¡ 
§
 *
¤v
, 
´Ùo
,

100 cÚ¡ 
¡un_cÚf
 *
cÚf
,

101 
Çt_g’®g_h
 *
gh
, *
¬g
)

103 
Çt_g’®g
 *
ng
;

104 
”r
;

106 ià(!
ngp
 || !
¤v
 || !
´Ùo
 || !
gh
)

107  
EINVAL
;

109 
ng
 = 
	`mem_z®loc
((*ng), 
g’®g_de¡ruùÜ
);

110 ià(!
ng
)

111  
ENOMEM
;

113 
”r
 = 
	`¡un_®loc
(&
ng
->
¡un
, 
cÚf
, 
NULL
, NULL);

114 ià(
”r
)

115 
out
;

117 
	`§_ıy
(&
ng
->
¤v
, srv);

118 
ng
->
´Ùo
 =…roto;

119 
ng
->
h
 = 
gh
;

120 
ng
->
¬g
 =‡rg;

122 
out
:

123 ià(
”r
)

124 
	`mem_d”ef
(
ng
);

126 *
ngp
 = 
ng
;

128  
”r
;

129 
	}
}

139 
	$Çt_g’®g_¡¬t
(
Çt_g’®g
 *
ng
)

141 
”r
;

143 ià(!
ng
)

144  
EINVAL
;

146 
”r
 = 
	`¡un_»que¡
(
NULL
, 
ng
->
¡un
,‚g->
´Ùo
, NULL, &ng->
¤v
, 0,

147 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

148 
¡un_»¥Ú£_hªdËr
, 
ng
, 1,

149 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

151  
”r
;

152 
	}
}

	@re-0.5.6/src/natbd/hairpinning.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_mem.h
>

10 
	~<»_§.h
>

11 
	~<»_udp.h
>

12 
	~<»_tı.h
>

13 
	~<»_li¡.h
>

14 
	~<»_¡un.h
>

15 
	~<»_Çtbd.h
>

18 
	#DEBUG_MODULE
 "Çtbd_haœpšnšg"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

38 
	sÇt_haœpšnšg
 {

39 
¡un
 *
	m¡un
;

40 
	m´Ùo
;

41 
§
 
	m¤v
;

42 
udp_sock
 *
	mus
;

43 
tı_cÚn
 *
	mtc
;

44 
tı_sock
 *
	mts
;

45 
tı_cÚn
 *
	mtc2
;

46 
Çt_haœpšnšg_h
 *
	mhph
;

47 *
	m¬g
;

51 
	$haœpšnšg_de¡ruùÜ
(*
d©a
)

53 
Çt_haœpšnšg
 *
nh
 = 
d©a
;

55 
	`mem_d”ef
(
nh
->
us
);

56 
	`mem_d”ef
(
nh
->
tc
);

57 
	`mem_d”ef
(
nh
->
ts
);

58 
	`mem_d”ef
(
nh
->
tc2
);

59 
	`mem_d”ef
(
nh
->
¡un
);

60 
	}
}

63 
	$msg_»cv
(
Çt_haœpšnšg
 *
nh
, 
´Ùo
, *
sock
,

64 cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
)

66 
¡un_unknown_©Œ
 
ua
;

67 
¡un_msg
 *
msg
;

69 ià(0 !ğ
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
))

72 
	`¡un_msg_şass
(
msg
)) {

74 
STUN_CLASS_REQUEST
:

75 ()
	`¡un_»¶y
(
´Ùo
, 
sock
, 
¤c
, 0, 
msg
, 
NULL
, 0, 
çl£
, 3,

76 
STUN_ATTR_XOR_MAPPED_ADDR
, 
¤c
,

77 
STUN_ATTR_MAPPED_ADDR
, 
¤c
,

78 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

81 
STUN_CLASS_ERROR_RESP
:

82 
STUN_CLASS_SUCCESS_RESP
:

83 ()
	`¡un_ù¿ns_»cv
(
nh
->
¡un
, 
msg
, &
ua
);

87 
	`DEBUG_WARNING
("unknowÀşas 0x%04x\n", 
	`¡un_msg_şass
(
msg
));

91 
	`mem_d”ef
(
msg
);

92 
	}
}

95 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
,

96 *
¬g
)

98 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

100 
	`msg_»cv
(
nh
, 
IPPROTO_UDP
,‚h->
us
, 
¤c
, 
mb
);

101 
	}
}

104 
	$¡un_»¥Ú£_hªdËr2
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

105 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

107 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

108 ()
»asÚ
;

109 ()
msg
;

111 ià(
”r
 || 
scode
) {

112 
nh
->
	`hph
(0, 
çl£
,‚h->
¬g
);

117 
nh
->
	`hph
(0, 
Œue
,‚h->
¬g
);

118 
	}
}

121 
	$haœpš_£nd
(
Çt_haœpšnšg
 *
nh
, cÚ¡ 
§
 *
¤v
)

123  
	`¡un_»que¡
(
NULL
, 
nh
->
¡un
,‚h->
´Ùo
, NULL,

124 
¤v
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

125 
¡un_»¥Ú£_hªdËr2
, 
nh
, 1,

126 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

127 
	}
}

135 
	$tı_»cv_hªdËr2
(
mbuf
 *
mb
, *
¬g
)

137 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

139 
	`msg_»cv
(
nh
, 
IPPROTO_TCP
,‚h->
tc2
, 
NULL
, 
mb
);

140 
	}
}

143 
	$tı_şo£_hªdËr2
(
”r
, *
¬g
)

145 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

147 ià(
”r
)

148 
nh
->
	`hph
(
”r
, 
çl£
,‚h->
¬g
);

149 
	}
}

152 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

153 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

155 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

156 cÚ¡ 
¡un_©Œ
 *
©Œ
;

157 ()
»asÚ
;

159 ià(
”r
) {

160 
nh
->
	`hph
(
”r
, 
çl£
,‚h->
¬g
);

164 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

165 ià(!
©Œ
)

166 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

168 ià(
scode
 || !
©Œ
) {

169 
nh
->
	`hph
(
EBADMSG
, 
çl£
,‚h->
¬g
);

174 
”r
 = 
	`haœpš_£nd
(
nh
, &
©Œ
->
v
.
§
);

175 ià(
”r
) {

176 
	`DEBUG_WARNING
("haœpš_£nd: (%m)\n", 
”r
);

179 ià(
”r
)

180 
nh
->
	`hph
(
”r
, 
çl£
,‚h->
¬g
);

181 
	}
}

184 
	$m­³d_£nd
(
Çt_haœpšnšg
 *
nh
)

186  
	`¡un_»que¡
(
NULL
, 
nh
->
¡un
,‚h->
´Ùo
,‚h->
us
 ?

187 (*)
nh
->
us
 : (*êh->
tc
,

188 &
nh
->
¤v
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

189 
¡un_»¥Ú£_hªdËr
, 
nh
, 1,

190 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

191 
	}
}

194 
	$tı_cÚn_hªdËr
(cÚ¡ 
§
 *
³”
, *
¬g
)

196 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

197 
”r
;

199 ()
³”
;

201 
”r
 = 
	`tı_acû±
(&
nh
->
tc2
,‚h->
ts
, 
NULL
, 
tı_»cv_hªdËr2
,

202 
tı_şo£_hªdËr2
, 
nh
);

203 ià(
”r
) {

204 
	`DEBUG_WARNING
("TCP cÚn:ı_acû±: %m\n", 
”r
);

206 
	}
}

213 
	$tı_e¡ab_hªdËr
(*
¬g
)

215 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

216 
”r
;

218 
”r
 = 
	`m­³d_£nd
(
nh
);

219 ià(
”r
) {

220 
	`DEBUG_WARNING
("TCPƒ¡ablished: m­³d_£nd (%m)\n", 
”r
);

221 
nh
->
	`hph
(
”r
, 
çl£
,‚h->
¬g
);

223 
	}
}

226 
	$tı_»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

228 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

229 
”r
;

231 
”r
 = 
	`¡un_»cv
(
nh
->
¡un
, 
mb
);

232 ià(
”r
 && 
ENOENT
 !=ƒrr) {

233 
	`DEBUG_WARNING
("¡uÀ»cv: %m\n", 
”r
);

235 
	}
}

238 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

240 
Çt_haœpšnšg
 *
nh
 = 
¬g
;

242 ià(
”r
)

243 
nh
->
	`hph
(
”r
, 
çl£
,‚h->
¬g
);

244 
	}
}

260 
	$Çt_haœpšnšg_®loc
(
Çt_haœpšnšg
 **
nhp
,

261 cÚ¡ 
§
 *
¤v
, 
´Ùo
,

262 cÚ¡ 
¡un_cÚf
 *
cÚf
,

263 
Çt_haœpšnšg_h
 *
hph
, *
¬g
)

265 
Çt_haœpšnšg
 *
nh
;

266 
§
 
loÿl
;

267 
”r
;

269 ià(!
¤v
 || !
hph
)

270  
EINVAL
;

272 
nh
 = 
	`mem_z®loc
((*nh), 
haœpšnšg_de¡ruùÜ
);

273 ià(!
nh
)

274  
ENOMEM
;

276 
”r
 = 
	`¡un_®loc
(&
nh
->
¡un
, 
cÚf
, 
NULL
, NULL);

277 ià(
”r
)

278 
out
;

280 
	`§_ıy
(&
nh
->
¤v
, srv);

281 
nh
->
´Ùo
 =…roto;

282 
nh
->
hph
 = hph;

283 
nh
->
¬g
 =‡rg;

285 
´Ùo
) {

287 
IPPROTO_UDP
:

288 
”r
 = 
	`udp_li¡’
(&
nh
->
us
, 
NULL
, 
udp_»cv_hªdËr
,‚h);

291 
IPPROTO_TCP
:

292 
	`§_£t_š
(&
loÿl
, 0, 0);

297 
”r
 = 
	`tı_sock_®loc
(&
nh
->
ts
, &
loÿl
, 
tı_cÚn_hªdËr
,‚h);

298 ià(
”r
)

301 
”r
 = 
	`tı_cÚn_®loc
(&
nh
->
tc
, &nh->
¤v
,

302 
tı_e¡ab_hªdËr
, 
tı_»cv_hªdËr
,

303 
tı_şo£_hªdËr
, 
nh
);

304 ià(
”r
)

307 
”r
 = 
	`tı_sock_bšd
(
nh
->
ts
, &
loÿl
);

308 ià(
”r
)

311 
”r
 = 
	`tı_sock_loÿl_g‘
(
nh
->
ts
, &
loÿl
);

312 ià(
”r
)

315 
”r
 = 
	`tı_cÚn_bšd
(
nh
->
tc
, &
loÿl
);

316 ià(
”r
)

322 
”r
 = 
	`tı_sock_li¡’
(
nh
->
ts
, 5);

326 
”r
 = 
EPROTONOSUPPORT
;

330 
out
:

331 ià(
”r
)

332 
	`mem_d”ef
(
nh
);

334 *
nhp
 = 
nh
;

336  
”r
;

337 
	}
}

347 
	$Çt_haœpšnšg_¡¬t
(
Çt_haœpšnšg
 *
nh
)

349 ià(!
nh
)

350  
EINVAL
;

352 
nh
->
´Ùo
) {

354 
IPPROTO_UDP
:

355  
	`m­³d_£nd
(
nh
);

357 
IPPROTO_TCP
:

358  
	`tı_cÚn_cÚÃù
(
nh
->
tc
, &nh->
¤v
);

361  
EPROTONOSUPPORT
;

363 
	}
}

	@re-0.5.6/src/natbd/lifetime.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_udp.h
>

14 
	~<»_¡un.h
>

15 
	~<»_Çtbd.h
>

18 
	#DEBUG_MODULE
 "Çtbd_liãtime"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

35 
	sÇt_liãtime
 {

36 
¡un
 *
	m¡un
;

37 
¡un_ù¿ns
 *
	mùx
;

38 
¡un_ù¿ns
 *
	mùy
;

39 
udp_sock
 *
	mus_x
;

40 
udp_sock
 *
	mus_y
;

41 
§
 
	m¤v
;

42 
§
 
	mm­
;

43 
tmr
 
	mtmr
;

44 
boŞ
 
	m´obšg
;

45 
Çt_liãtime_š‹rv®
 
	mš‹rv®
;

46 
Çt_liãtime_h
 *
	mlh
;

47 *
	m¬g
;

51 
timeout
(*
¬g
);

52 
bšdšg_ok
(
Çt_liãtime
 *
Æ
);

53 
bšdšg_expœed
(
Çt_liãtime
 *
Æ
);

61 
	$msg_»cv
(
¡un
 *¡un, cÚ¡ 
§
 *
¤c
,

62 
mbuf
 *
mb
)

64 
”r
;

65 ()
¤c
;

67 
”r
 = 
	`¡un_»cv
(
¡un
, 
mb
);

68 ià(
”r
 && 
ENOENT
 !=ƒrr) {

69 
	`DEBUG_WARNING
("msg_»cv: stunc_»cv(): (%m)\n", 
”r
);

71 
	}
}

74 
	$udp_»cv_hªdËr_x
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
,

75 *
¬g
)

77 
Çt_liãtime
 *
Æ
 = 
¬g
;

80 
	`msg_»cv
(
Æ
->
¡un
, 
¤c
, 
mb
);

81 
	}
}

84 
	$¡un_»¥Ú£_hªdËr_x
(
”r
, 
ušt16_t
 
scode
,

85 cÚ¡ *
»asÚ
,

86 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

88 
Çt_liãtime
 *
Æ
 = 
¬g
;

89 
¡un_©Œ
 *
©Œ
;

91 ()
»asÚ
;

93 ià(
”r
) {

94 
	`DEBUG_WARNING
("¡un_»¥Ú£_hªdË¸X: %m\n", 
”r
);

95 
out
;

98 
scode
) {

101 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

102 ià(!
©Œ
) {

103 
”r
 = 
EPROTO
;

107 
Æ
->
m­
 = 
©Œ
->
v
.
xÜ_m­³d_addr
;

109 
	`DEBUG_INFO
("Startingimer of %d seconds...[zzz]...\n",

110 
Æ
->
š‹rv®
.
cur
);

112 
	`tmr_¡¬t
(&
Æ
->
tmr
,‚l->
š‹rv®
.
cur
*1000, 
timeout
,‚l);

116 
”r
 = 
EPROTO
;

120 
out
:

121 
Æ
->
	`lh
(
”r
, &Æ->
š‹rv®
,‚l->
¬g
);

122 
	`bšdšg_expœed
(
Æ
);

123 
	}
}

131 
	$udp_»cv_hªdËr_y
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
,

132 *
¬g
)

134 
Çt_liãtime
 *
Æ
 = 
¬g
;

136 ()
¤c
;

137 ()
mb
;

139 ià(!
Æ
->
´obšg
) {

140 
	`DEBUG_WARNING
("Y: hmm,‚ot…robing?\n");

143 
	`bšdšg_expœed
(
Æ
);

144 
	}
}

147 
	$¡un_»¥Ú£_hªdËr_y
(
”r
, 
ušt16_t
 
scode
,

148 cÚ¡ *
»asÚ
,

149 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

151 
Çt_liãtime
 *
Æ
 = 
¬g
;

152 ()
»asÚ
;

153 ()
msg
;

155 ià(
”r
) {

156 
	`bšdšg_expœed
(
Æ
);

160 
scode
) {

163 
	`bšdšg_ok
(
Æ
);

167 
Æ
->
	`lh
(
EBADMSG
, &Æ->
š‹rv®
,‚l->
¬g
);

170 
	}
}

178 
	$¡¬t_‹¡
(
Çt_liãtime
 *
Æ
)

180 
Æ
->
´obšg
 = 
çl£
;

182 
	`tmr_ÿnûl
(&
Æ
->
tmr
);

184 
Æ
->
ùx
 = 
	`mem_d”ef
(nl->ctx);

185  
	`¡un_»que¡
(&
Æ
->
ùx
,‚l->
¡un
, 
IPPROTO_UDP
,‚l->
us_x
,

186 &
Æ
->
¤v
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

187 
¡un_»¥Ú£_hªdËr_x
, 
Æ
, 1,

188 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

189 
	}
}

192 
	$timeout
(*
¬g
)

194 
Çt_liãtime
 *
Æ
 = 
¬g
;

195 cÚ¡ 
ušt16_t
 
½
 = 
	`§_pÜt
(&
Æ
->
m­
);

196 
”r
;

198 
Æ
->
´obšg
 = 
Œue
;

200 
Æ
->
ùy
 = 
	`mem_d”ef
(nl->cty);

201 
”r
 = 
	`¡un_»que¡
(&
Æ
->
ùy
,‚l->
¡un
, 
IPPROTO_UDP
,‚l->
us_y
,

202 &
Æ
->
¤v
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

203 
¡un_»¥Ú£_hªdËr_y
, 
Æ
, 2,

204 
STUN_ATTR_RESP_PORT
, &
½
,

205 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

206 ià(
”r
)

207 
out
;

211 
out
:

212 
	`DEBUG_WARNING
("timeout: (%m)\n", 
”r
);

214 
Æ
->
	`lh
(
”r
, &Æ->
š‹rv®
,‚l->
¬g
);

216 ()
	`¡¬t_‹¡
(
Æ
);

217 
	}
}

221 
	$bšdšg_ok
(
Çt_liãtime
 *
Æ
)

223 
Æ
->
š‹rv®
.
mš
 = 
	`max
(1,‚l->š‹rv®.
cur
);

225 ià(
Æ
->
š‹rv®
.
max
 > 0)

226 
Æ
->
š‹rv®
.
cur
 = (Æ->š‹rv®.
mš
 +‚l->š‹rv®.
max
) / 2;

228 
Æ
->
š‹rv®
.
cur
 *= 2;

230 
Æ
->
	`lh
(0, &Æ->
š‹rv®
,‚l->
¬g
);

232 ()
	`¡¬t_‹¡
(
Æ
);

233 
	}
}

237 
	$bšdšg_expœed
(
Çt_liãtime
 *
Æ
)

239 
Æ
->
š‹rv®
.
max
 =‚l->š‹rv®.
cur
;

241 
Æ
->
š‹rv®
.
cur
 = (Æ->š‹rv®.
mš
 +‚l->š‹rv®.
max
) / 2;

243 
Æ
->
	`lh
(0, &Æ->
š‹rv®
,‚l->
¬g
);

245 ()
	`¡¬t_‹¡
(
Æ
);

246 
	}
}

249 
	$liãtime_de¡ruùÜ
(*
d©a
)

251 
Çt_liãtime
 *
Æ
 = 
d©a
;

253 
	`tmr_ÿnûl
(&
Æ
->
tmr
);

255 
	`mem_d”ef
(
Æ
->
ùx
);

256 
	`mem_d”ef
(
Æ
->
ùy
);

257 
	`mem_d”ef
(
Æ
->
us_x
);

258 
	`mem_d”ef
(
Æ
->
us_y
);

259 
	`mem_d”ef
(
Æ
->
¡un
);

260 
	}
}

275 
	$Çt_liãtime_®loc
(
Çt_liãtime
 **
Æp
, cÚ¡ 
§
 *
¤v
,

276 
ušt32_t
 
š‹rv®
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

277 
Çt_liãtime_h
 *
lh
, *
¬g
)

279 
Çt_liãtime
 *
Æ
;

280 
”r
;

282 ià(!
Æp
 || !
¤v
 || !
š‹rv®
 || !
lh
)

283  
EINVAL
;

285 
Æ
 = 
	`mem_z®loc
((*Æ), 
liãtime_de¡ruùÜ
);

286 ià(!
Æ
)

287  
ENOMEM
;

289 
	`tmr_š™
(&
Æ
->
tmr
);

291 
”r
 = 
	`¡un_®loc
(&
Æ
->
¡un
, 
cÚf
, 
NULL
, NULL);

292 ià(
”r
)

293 
out
;

295 
”r
 = 
	`udp_li¡’
(&
Æ
->
us_x
, 
NULL
, 
udp_»cv_hªdËr_x
,‚l);

296 ià(
”r
)

297 
out
;

299 
”r
 = 
	`udp_li¡’
(&
Æ
->
us_y
, 
NULL
, 
udp_»cv_hªdËr_y
,‚l);

300 ià(
”r
)

301 
out
;

303 
	`§_ıy
(&
Æ
->
¤v
, srv);

304 
Æ
->
š‹rv®
.
mš
 = 1;

305 
Æ
->
š‹rv®
.
cur
 = interval;

306 
Æ
->
lh
 =†h;

307 
Æ
->
¬g
 =‡rg;

309 
out
:

310 ià(
”r
)

311 
	`mem_d”ef
(
Æ
);

313 *
Æp
 = 
Æ
;

315  
”r
;

316 
	}
}

326 
	$Çt_liãtime_¡¬t
(
Çt_liãtime
 *
Æ
)

328 ià(!
Æ
)

329  
EINVAL
;

331  
	`¡¬t_‹¡
(
Æ
);

332 
	}
}

	@re-0.5.6/src/natbd/mapping.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_§.h
>

11 
	~<»_udp.h
>

12 
	~<»_tı.h
>

13 
	~<»_li¡.h
>

14 
	~<»_¡un.h
>

15 
	~<»_Çtbd.h
>

18 
	#DEBUG_MODULE
 "Çtbd_m­pšg"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

47 
	sÇt_m­pšg
 {

48 
¡un
 *
	m¡un
;

49 
udp_sock
 *
	mus
;

50 
tı_cÚn
 *
	mtc
;

51 
§
 
	mÏddr
;

52 
§
 
	mm­
[3];

53 
§
 
	m¤v
;

54 
Çt_m­pšg_h
 *
	mmh
;

55 *
	m¬g
;

56 
	m´Ùo
;

57 
ušt32_t
 
	m‹¡_pha£
;

58 
tı_cÚn
 *
	mtcv
[3];

62 
m­pšg_£nd
(
Çt_m­pšg
 *
nm
);

65 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

66 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

68 
Çt_m­pšg
 *
nm
 = 
¬g
;

69 
¡un_©Œ
 *
m­
, *
Ùh”
;

71 ià(
”r
) {

72 
	`DEBUG_WARNING
("¡un_»¥Ú£_hªdËr: (%m)\n", 
”r
);

73 
nm
->
	`mh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

77 
scode
) {

80 
Ùh”
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_OTHER_ADDR
);

81 
m­
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

82 ià(!
m­
)

83 
m­
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

85 ià(!
m­
 || !
Ùh”
) {

86 
	`DEBUG_WARNING
("missing‡ttributes: %s %s\n",

87 
m­
 ? "" : "MAPPED-ADDR",

88 
Ùh”
 ? "" : "OTHER-ADDR");

89 
nm
->
	`mh
(
EPROTO
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

93 
nm
->
m­
[nm->
‹¡_pha£
-1] = m­->
v
.
§
;

97 
	`DEBUG_WARNING
("Bšdšg E¼Ü Re¥: %u %s\n", 
scode
, 
»asÚ
);

98 
nm
->
	`mh
(
EPROTO
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

102 
nm
->
‹¡_pha£
) {

106 ià(
	`§_cmp
(&
nm
->
Ïddr
, &nm->
m­
[0], 
SA_ALL
)) {

107 
nm
->
	`mh
(0, 
NAT_TYPE_ENDP_INDEP
,‚m->
¬g
);

113 ++
nm
->
‹¡_pha£
;

115 
	`§_£t_pÜt
(&
Ùh”
->
v
.
Ùh”_addr
, 
	`§_pÜt
(&
nm
->
¤v
));

116 
	`§_ıy
(&
nm
->
¤v
, &
Ùh”
->
v
.
Ùh”_addr
);

118 
”r
 = 
	`m­pšg_£nd
(
nm
);

119 ià(
”r
) {

120 
	`DEBUG_WARNING
("¡unc_»que¡_£nd: (%m)\n", 
”r
);

121 
nm
->
	`mh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

127 ià(
	`§_cmp
(&
nm
->
m­
[0], &nm->m­[1], 
SA_ALL
)) {

128 
nm
->
	`mh
(0, 
NAT_TYPE_ENDP_INDEP
,‚m->
¬g
);

134 ++
nm
->
‹¡_pha£
;

136 
	`§_£t_pÜt
(&
nm
->
¤v
, 
	`§_pÜt
(&
Ùh”
->
v
.
Ùh”_addr
));

137 
”r
 = 
	`m­pšg_£nd
(
nm
);

138 ià(
”r
) {

139 
	`DEBUG_WARNING
("¡unc_»que¡_£nd: (%m)\n", 
”r
);

140 
nm
->
	`mh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

146 ià(
	`§_cmp
(&
nm
->
m­
[1], &nm->m­[2], 
SA_ALL
)) {

147 
nm
->
	`mh
(0, 
NAT_TYPE_ADDR_DEP
,‚m->
¬g
);

150 
nm
->
	`mh
(0, 
NAT_TYPE_ADDR_PORT_DEP
,‚m->
¬g
);

152 ++
nm
->
‹¡_pha£
;

156 
	`DEBUG_WARNING
("šv®ide¡…ha£ %d\n", 
nm
->
‹¡_pha£
);

157 
nm
->
	`mh
(
EINVAL
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

160 
	}
}

163 
	$m­pšg_£nd
(
Çt_m­pšg
 *
nm
)

165 
nm
->
´Ùo
) {

167 
IPPROTO_UDP
:

168  
	`¡un_»que¡
(
NULL
, 
nm
->
¡un
, 
IPPROTO_UDP
,‚m->
us
,

169 &
nm
->
¤v
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0,

170 
çl£
, 
¡un_»¥Ú£_hªdËr
, 
nm
, 1,

171 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

173 
IPPROTO_TCP
:

174 
nm
->
tc
 = 
	`mem_d”ef
(nm->tc);

175 
nm
->
tc
 = 
	`mem_»f
Òm->
tcv
[nm->
‹¡_pha£
-1]);

176  
	`tı_cÚn_cÚÃù
(
nm
->
tc
, &nm->
¤v
);

179  
EPROTONOSUPPORT
;

181 
	}
}

184 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
,

185 *
¬g
)

187 
Çt_m­pšg
 *
nm
 = 
¬g
;

188 
”r
;

189 ()
¤c
;

191 
”r
 = 
	`¡un_»cv
(
nm
->
¡un
, 
mb
);

192 ià(
”r
 && 
ENOENT
 !=ƒrr) {

193 
	`DEBUG_WARNING
("udp_»cv_hªdËr: stunc_»cv(): (%m)\n", 
”r
);

195 
	}
}

198 
	$m­pšg_de¡ruùÜ
(*
d©a
)

200 
Çt_m­pšg
 *
nm
 = 
d©a
;

201 
i
;

203 
	`mem_d”ef
(
nm
->
us
);

204 
	`mem_d”ef
(
nm
->
tc
);

206 
i
=0; i<3; i++)

207 
	`mem_d”ef
(
nm
->
tcv
[
i
]);

209 
	`mem_d”ef
(
nm
->
¡un
);

210 
	}
}

213 
	$tı_e¡ab_hªdËr
(*
¬g
)

215 
Çt_m­pšg
 *
nm
 = 
¬g
;

216 
”r
;

218 
”r
 = 
	`¡un_»que¡
(
NULL
, 
nm
->
¡un
, 
IPPROTO_TCP
,‚m->
tc
, NULL, 0,

219 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

220 
¡un_»¥Ú£_hªdËr
, 
nm
, 1,

221 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

223 ià(
”r
) {

224 
	`DEBUG_WARNING
("TCPƒ¡ablished: m­pšg_£nd (%m)\n", 
”r
);

225 
nm
->
	`mh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

227 
	}
}

230 
	$tı_»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

232 
Çt_m­pšg
 *
nm
 = 
¬g
;

233 
”r
;

235 
”r
 = 
	`¡un_»cv
(
nm
->
¡un
, 
mb
);

236 ià(
”r
 && 
ENOENT
 !=ƒrr) {

237 
	`DEBUG_WARNING
("¡unø»cv: %m\n", 
”r
);

239 
	}
}

242 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

244 
Çt_m­pšg
 *
nm
 = 
¬g
;

246 
	`DEBUG_NOTICE
("TCP CÚÃùiÚ Clo£d (%m)\n", 
”r
);

248 ià(
”r
) {

249 
nm
->
	`mh
(
”r
, 
NAT_TYPE_UNKNOWN
,‚m->
¬g
);

251 
	}
}

267 
	$Çt_m­pšg_®loc
(
Çt_m­pšg
 **
nmp
, cÚ¡ 
§
 *
Ïddr
,

268 cÚ¡ 
§
 *
¤v
, 
´Ùo
,

269 cÚ¡ 
¡un_cÚf
 *
cÚf
,

270 
Çt_m­pšg_h
 *
mh
, *
¬g
)

272 
Çt_m­pšg
 *
nm
;

273 
i
, 
”r
;

275 ià(!
nmp
 || !
Ïddr
 || !
¤v
 || !
mh
)

276  
EINVAL
;

278 
nm
 = 
	`mem_z®loc
((*nm), 
m­pšg_de¡ruùÜ
);

279 ià(!
nm
)

280  
ENOMEM
;

282 
”r
 = 
	`¡un_®loc
(&
nm
->
¡un
, 
cÚf
, 
NULL
, NULL);

283 ià(
”r
)

284 
out
;

286 
nm
->
´Ùo
 =…roto;

287 
	`§_ıy
(&
nm
->
Ïddr
,†addr);

289 
´Ùo
) {

291 
IPPROTO_UDP
:

292 
”r
 = 
	`udp_li¡’
(&
nm
->
us
, &nm->
Ïddr
, 
udp_»cv_hªdËr
,‚m);

293 ià(
”r
)

294 
out
;

295 
”r
 = 
	`udp_loÿl_g‘
(
nm
->
us
, &nm->
Ïddr
);

296 ià(
”r
)

297 
out
;

300 
IPPROTO_TCP
:

303 
i
=0; i<3; i++) {

304 
”r
 = 
	`tı_cÚn_®loc
(&
nm
->
tcv
[
i
], 
¤v
,

305 
tı_e¡ab_hªdËr
,

306 
tı_»cv_hªdËr
,

307 
tı_şo£_hªdËr
, 
nm
);

308 ià(
”r
)

309 
out
;

311 
”r
 = 
	`tı_cÚn_bšd
(
nm
->
tcv
[
i
], &nm->
Ïddr
);

312 ià(
”r
)

313 
out
;

315 
”r
 = 
	`tı_cÚn_loÿl_g‘
(
nm
->
tcv
[
i
], &nm->
Ïddr
);

316 ià(
”r
)

317 
out
;

322 
”r
 = 
EPROTONOSUPPORT
;

323 
out
;

326 
	`§_ıy
(&
nm
->
¤v
, srv);

327 
nm
->
mh
 = mh;

328 
nm
->
¬g
 =‡rg;

330 *
nmp
 = 
nm
;

332 
out
:

333 ià(
”r
)

334 
	`mem_d”ef
(
nm
);

335  
”r
;

336 
	}
}

346 
	$Çt_m­pšg_¡¬t
(
Çt_m­pšg
 *
nm
)

348 ià(!
nm
)

349  
EINVAL
;

351 
nm
->
‹¡_pha£
 = 1;

353  
	`m­pšg_£nd
(
nm
);

354 
	}
}

	@re-0.5.6/src/natbd/natstr.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_¡un.h
>

12 
	~<»_Çtbd.h
>

22 cÚ¡ *
	$Çt_ty³_¡r
(
Çt_ty³
 
ty³
)

24 
ty³
) {

26 
NAT_TYPE_UNKNOWN
:  "Unknown";

27 
NAT_TYPE_ENDP_INDEP
:  "Endpoint Independent";

28 
NAT_TYPE_ADDR_DEP
:  "Address Dependent";

29 
NAT_TYPE_ADDR_PORT_DEP
:  "Address‡nd Port Dependent";

32 
	}
}

	@re-0.5.6/src/net/bsd/brt.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_§.h
>

10 
	~<»_Ãt.h
>

11 
	~<sys/sysùl.h
>

12 
	~<Ãt/rou‹.h
>

13 
	~<Ãt/if.h
>

20 #ifdeà
__APPLE__


21 
	#RT_MSGHDR_ALIGNMENT
 (
ušt32_t
)

	)

23 
	#RT_MSGHDR_ALIGNMENT
 ()

	)

26 
	#ROUNDUP
(
a
) \

27 ((
a
) > 0 \

28 ? (1 + (((
size_t
)(
a
è- 1è| (
RT_MSGHDR_ALIGNMENT
 - 1))) \

29 : 
RT_MSGHDR_ALIGNMENT
)

	)

32 
	$Ãt_¹_li¡
(
Ãt_¹_h
 *
¹h
, *
¬g
)

35 
mib
[] = {
CTL_NET
, 
PF_ROUTE
, 0, 
AF_UNSPEC
,

36 
NET_RT_FLAGS
, 
RTF_GATEWAY
};

37 
iâame
[
IFNAMSIZ
], *
buf
, *
p
;

38 
¹_msghdr
 *
¹
;

39 
sockaddr
 *
§
, *
§_b
[
RTAX_MAX
];

40 
§
 
d¡
, 
gw
;

41 
size_t
 
l
;

42 
i
, 
”r
 = 0;

44 ià(
	`sysùl
(
mib
, (mib)/(), 0, &
l
, 0, 0) < 0)

45  
”ºo
;

46 ià(!
l
)

47  
ENOENT
;

49 
buf
 = 
	`mem_®loc
(
l
, 
NULL
);

50 ià(!
buf
)

51  
ENOMEM
;

53 ià(
	`sysùl
(
mib
, (mib)/(), 
buf
, &
l
, 0, 0) < 0) {

54 
”r
 = 
”ºo
;

55 
out
;

58 
p
 = 
buf
;…<buf+
l
;… +ğ
¹
->
¹m_msgËn
) {

59 
¹
 = (*)
p
;

60 
§
 = (
sockaddr
 *)(
¹
 + 1);

62 ià(
¹
->
¹m_ty³
 !ğ
RTM_GET
)

65 ià(!(
¹
->
¹m_æags
 & 
RTF_UP
))

68 
i
=0; i<
RTAX_MAX
; i++) {

70 ià(
¹
->
¹m_addrs
 & (1 << 
i
)) {

71 
§_b
[
i
] = 
§
;

72 
§
 = (
sockaddr
 *)

73 ((*)
§
 + 
	`ROUNDUP
(§->
§_Ën
));

76 
§_b
[
i
] = 
NULL
;

80 ià((
¹
->
¹m_addrs
 & 
RTA_DST
) == RTA_DST) {

81 
”r
 = 
	`§_£t_§
(&
d¡
, 
§_b
[
RTAX_DST
]);

82 ià(
”r
)

85 ià((
¹
->
¹m_addrs
 & 
RTA_GATEWAY
) == RTA_GATEWAY) {

86 
”r
 = 
	`§_£t_§
(&
gw
, 
§_b
[
RTAX_GATEWAY
]);

87 ià(
”r
)

91 
	`if_šdextÚame
(
¹
->
¹m_šdex
, 
iâame
);

93 ià(
	`¹h
(
iâame
, &
d¡
, 0, &
gw
, 
¬g
))

97 
out
:

98 
	`mem_d”ef
(
buf
);

100  
”r
;

101 
	}
}

	@re-0.5.6/src/net/if.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_Ãt.h
>

13 
	#DEBUG_MODULE
 "Ãtif"

	)

14 
	#DEBUG_LEVEL
 5

	)

15 
	~<»_dbg.h
>

19 
	siãÁry
 {

20 
	maf
;

21 *
	miâame
;

22 
§
 *
	m
;

23 
size_t
 
	msz
;

24 
boŞ
 
	mfound
;

28 
boŞ
 
	$if_g‘Çme_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *sa,

29 *
¬g
)

31 
iãÁry
 *
iã
 = 
¬g
;

33 ià(
iã
->
af
 !ğ
	`§_af
(
§
))

34  
çl£
;

36 ià(0 =ğ
	`§_cmp
(
§
, 
iã
->

, 
SA_ADDR
)) {

37 
	`¡r_nıy
(
iã
->
iâame
, iâame, iã->
sz
);

38 
iã
->
found
 = 
Œue
;

39  
Œue
;

42  
çl£
;

43 
	}
}

56 
	$Ãt_if_g‘Çme
(*
iâame
, 
size_t
 
sz
, 
af
, cÚ¡ 
§
 *

)

58 
iãÁry
 
iã
;

59 
”r
;

61 ià(!
iâame
 || !
sz
 || !

)

62  
EINVAL
;

64 
iã
.
af
 =‡f;

65 
iã
.
iâame
 = ifname;

66 
iã
.

 = (
§
 *)ip;

67 
iã
.
sz
 = sz;

68 
iã
.
found
 = 
çl£
;

70 
”r
 = 
	`Ãt_if_li¡
(
if_g‘Çme_hªdËr
, &
iã
);

72  
iã
.
found
 ? 
”r
 : 
ENODEV
;

73 
	}
}

76 
boŞ
 
	$if_g‘addr_hªdËr
(cÚ¡ *
iâame
,

77 cÚ¡ 
§
 *§, *
¬g
)

79 
iãÁry
 *
iã
 = 
¬g
;

82 ià(
	`¡r_is£t
(
iã
->
iâame
è&& 0 !ğ
	`¡r_ÿ£cmp
(ife->ifname, ifname))

83  
çl£
;

85 ià(!
	`§_is£t
(
§
, 
SA_ADDR
))

86  
çl£
;

90 ià(
	`§_is_loİback
(
§
è|| 
	`§_is_lškloÿl
(sa))

91  
çl£
;

95 ià(
iã
->
af
 !ğ
	`§_af
(
§
))

96  
çl£
;

99 
	`§_ıy
(
iã
->

, 
§
);

100 
iã
->
found
 = 
Œue
;

102  
iã
->
found
;

103 
	}
}

117 
	$Ãt_if_g‘addr
(cÚ¡ *
iâame
, 
af
, 
§
 *

)

119 
iãÁry
 
iã
;

120 
”r
;

122 ià(!

)

123  
EINVAL
;

125 
iã
.
af
 =‡f;

126 
iã
.
iâame
 = (*)ifname;

127 
iã
.

 = ip;

128 
iã
.
sz
 = 0;

129 
iã
.
found
 = 
çl£
;

131 #ifdeà
HAVE_GETIFADDRS


132 
”r
 = 
	`Ãt_g‘içddrs
(
if_g‘addr_hªdËr
, &
iã
);

134 
”r
 = 
	`Ãt_if_li¡
(
if_g‘addr_hªdËr
, &
iã
);

137  
iã
.
found
 ? 
”r
 : 
ENODEV
;

138 
	}
}

141 
boŞ
 
	$if_debug_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *sa,

142 *
¬g
)

144 
»_´štf
 *
pf
 = 
¬g
;

146 ()
	`»_h´štf
(
pf
, " %10s: %j\n", 
iâame
, 
§
);

148  
çl£
;

149 
	}
}

160 
	$Ãt_if_debug
(
»_´štf
 *
pf
, *
unu£d
)

162 
”r
;

164 ()
unu£d
;

166 
”r
 = 
	`»_h´štf
(
pf
, "net interfaces:\n");

168 #ifdeà
HAVE_GETIFADDRS


169 
”r
 |ğ
	`Ãt_g‘içddrs
(
if_debug_hªdËr
, 
pf
);

171 
”r
 |ğ
	`Ãt_if_li¡
(
if_debug_hªdËr
, 
pf
);

174  
”r
;

175 
	}
}

178 
boŞ
 
	$lškloÿl_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *sa,

179 *
¬g
)

181 **
¬gv
 = 
¬g
;

182 
af
 = *(*)
¬gv
[1];

184 ià(
¬gv
[0] && 0 !ğ
	`¡r_ÿ£cmp
×rgv[0], 
iâame
))

185  
çl£
;

187 ià(
af
 !ğ
AF_UNSPEC
 &&‡à!ğ
	`§_af
(
§
))

188  
çl£
;

190 ià(
	`§_is_lškloÿl
(
§
)) {

191 *((
§
 *)
¬gv
[2]) = *sa;

192  
Œue
;

195  
çl£
;

196 
	}
}

208 
	$Ãt_if_g‘lškloÿl
(cÚ¡ *
iâame
, 
af
, 
§
 *

)

210 
§
 
addr
;

211 *
¬gv
[3];

212 
”r
;

214 ià(!

)

215  
EINVAL
;

217 
	`§_š™
(&
addr
, 
	`§_af
(

));

219 
¬gv
[0] = (*)
iâame
;

220 
¬gv
[1] = &
af
;

221 
¬gv
[2] = &
addr
;

223 
”r
 = 
	`Ãt_if_­¶y
(
lškloÿl_hªdËr
, 
¬gv
);

224 ià(
”r
)

225  
”r
;

227 ià(!
	`§_is£t
(&
addr
, 
SA_ADDR
))

228  
ENOENT
;

230 *

 = 
addr
;

233 
	}
}

	@re-0.5.6/src/net/ifaddrs.c

6 
	~<uni¡d.h
>

7 
	~<sys/sock‘.h
>

8 
	#__USE_MISC
 1

	)

9 
	~<Ãt/if.h
>

10 
	~<içddrs.h
>

11 
	~<»_ty³s.h
>

12 
	~<»_fmt.h
>

13 
	~<»_§.h
>

14 
	~<»_Ãt.h
>

17 
	#DEBUG_MODULE
 "içddrs"

	)

18 
	#DEBUG_LEVEL
 5

	)

19 
	~<»_dbg.h
>

31 
	$Ãt_g‘içddrs
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

33 
içddrs
 *
iç
, *
iå
;

34 
”r
;

36 ià(!
ifh
)

37  
EINVAL
;

39 ià(0 !ğ
	`g‘içddrs
(&
iç
)) {

40 
”r
 = 
”ºo
;

41 
	`DEBUG_WARNING
("g‘içddrs: %m\n", 
”r
);

42  
”r
;

45 
iå
 = 
iç
; iç; iç = iç->
iç_Ãxt
) {

46 
§
 sa;

48 
	`DEBUG_INFO
("içddr: %10 æags=%08x\n", 
iç
->
iç_Çme
,

49 
iç
->
iç_æags
);

51 ià(
iç
->
iç_æags
 & 
IFF_UP
) {

52 
”r
 = 
	`§_£t_§
(&
§
, 
iç
->
iç_addr
);

53 ià(
”r
)

56 ià(
	`ifh
(
iç
->
iç_Çme
, &
§
, 
¬g
))

61 
	`ä“içddrs
(
iå
);

64 
	}
}

	@re-0.5.6/src/net/linux/rt.c

6 
	#_BSD_SOURCE
 1

	)

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	~<¡ršg.h
>

9 
	~<uni¡d.h
>

10 
	#__USE_POSIX
 1

	)

11 
	~<Ãtdb.h
>

12 
	#__USE_MISC
 1

	)

13 
	~<Ãt/if.h
>

14 #undeà
__STRICT_ANSI__


15 
	~<lšux/ty³s.h
>

16 
	~<lšux/Ãšk.h
>

17 
	~<lšux/¹Ãšk.h
>

18 
	~<»_ty³s.h
>

19 
	~<»_mbuf.h
>

20 
	~<»_fmt.h
>

21 
	~<»_§.h
>

22 
	~<»_Ãt.h
>

25 
	#DEBUG_MODULE
 "lšux¹"

	)

26 
	#DEBUG_LEVEL
 5

	)

27 
	~<»_dbg.h
>

31 #undeà
RTM_RTA


32 
	#RTM_RTA
(
r
è(*)(((*)Ô)è+ 
	`NLMSG_ALIGN
((
¹msg
)))

	)

33 #undeà
RTA_NEXT


34 
	#RTA_NEXT
(
¹a
, 
Ën
è(Ö’è-ğ
	`RTA_ALIGN
(Ô)->
¹a_Ën
), \

35 (*)(((*)(
¹a
)è+ 
	`RTA_ALIGN
(Ô)->
¹a_Ën
)))

	)

36 #undeà
NLMSG_NEXT


37 
	#NLMSG_NEXT
(
Æh
,
Ën
è(Ö’è-ğ
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
), \

38 (*)(((*)(
Æh
)è+ 
	`NLMSG_ALIGN
(Òlh)->
Æmsg_Ën
)))

	)

41 ’um {
	mBUFSIZE
 = 8192};

45 
	sÃt_¹
 {

46 
	miâame
[
IFNAMSIZ
];

47 
§
 
	md¡
;

48 
	md¡Ën
;

49 
§
 
	mgw
;

53 
	$»ad_sock
(
fd
, 
ušt8_t
 *
buf
, 
size_t
 
size
, 
£q
, 
pid
)

55 
Æmsghdr
 *
Æhdr
;

56 
n
 = 0, 
Ën
 = 0;

60 ià((
n
 = 
	`»cv
(
fd
, 
buf
, 
size
 - 
Ën
, 0)) < 0) {

61 
	`DEBUG_WARNING
("SOCK READ: %m\n", 
”ºo
);

64 
Æhdr
 = (
Æmsghdr
 *)(*)
buf
;

67 ià(0 =ğ
	`NLMSG_OK
(
Æhdr
, (
ušt32_t
)
n
) ||

68 
NLMSG_ERROR
 =ğ
Æhdr
->
Æmsg_ty³
) {

69 
	`DEBUG_WARNING
("Error in„eceived…acket\n");

74 ià(
NLMSG_DONE
 =ğ
Æhdr
->
Æmsg_ty³
) {

79 
buf
 +ğ
n
;

80 
Ën
 +ğ
n
;

84 ià(0 =ğ(
Æhdr
->
Æmsg_æags
 & 
NLM_F_MULTI
)) {

88 } 
Æhdr
->
Æmsg_£q
 !ğ(
ušt32_t
)
£q
 ||

89 
Æhdr
->
Æmsg_pid
 !ğ(
ušt32_t
)
pid
);

91  
Ën
;

92 
	}
}

96 
	$¹_·r£
(cÚ¡ 
Æmsghdr
 *
Æhdr
, 
Ãt_¹
 *
¹
)

98 
¹msg
 *rtmsg;

99 
¹©Œ
 *rtattr;

100 
Ën
;

102 
¹msg
 = (¹msg *)
	`NLMSG_DATA
(
Æhdr
);

105 ià(
RT_TABLE_MAIN
 !ğ
¹msg
->
¹m_bË
)

106  
EINVAL
;

108 
	`§_š™
(&
¹
->
d¡
, 
¹msg
->
¹m_çmy
);

109 
¹
->
d¡Ën
 = 
¹msg
->
¹m_d¡_Ën
;

112 
¹©Œ
 = (¹©Œ *)
	`RTM_RTA
(
¹msg
);

113 
Ën
 = 
	`RTM_PAYLOAD
(
Æhdr
);

114 ;
	`RTA_OK
(
¹©Œ
, 
Ën
);„‰¸ğ
	`RTA_NEXT
(rtattr,†en)) {

116 
¹©Œ
->
¹a_ty³
) {

118 
RTA_OIF
:

119 
	`if_šdextÚame
(*(*)
	`RTA_DATA
(
¹©Œ
), 
¹
->
iâame
);

122 
RTA_GATEWAY
:

123 
¹msg
->
¹m_çmy
) {

125 
AF_INET
:

126 
	`§_š™
(&
¹
->
gw
, 
AF_INET
);

127 
¹
->
gw
.
u
.
š
.
sš_addr
.
s_addr


128 ğ*(
ušt32_t
 *)
	`RTA_DATA
(
¹©Œ
);

131 #ifdeà
HAVE_INET6


132 
AF_INET6
:

133 
	`§_£t_š6
(&
¹
->
gw
, 
	`RTA_DATA
(
¹©Œ
), 0);

138 
	`DEBUG_WARNING
("RTA_DST: unknown family %d\n",

139 
¹msg
->
¹m_çmy
);

145 
RTA_PREFSRC
:

146 
¹
->
¤ÿddr
 = *(
ušt32_t
 *)
	`RTA_DATA
(
¹©Œ
);

150 
RTA_DST
:

151 
¹msg
->
¹m_çmy
) {

153 
AF_INET
:

154 
	`§_š™
(&
¹
->
d¡
, 
AF_INET
);

155 
¹
->
d¡
.
u
.
š
.
sš_addr
.
s_addr


156 ğ*(
ušt32_t
 *)
	`RTA_DATA
(
¹©Œ
);

159 #ifdeà
HAVE_INET6


160 
AF_INET6
:

161 
	`§_£t_š6
(&
¹
->
d¡
, 
	`RTA_DATA
(
¹©Œ
), 0);

166 
	`DEBUG_WARNING
("RTA_DST: unknown family %d\n",

167 
¹msg
->
¹m_çmy
);

175 
	}
}

186 
	$Ãt_¹_li¡
(
Ãt_¹_h
 *
¹h
, *
¬g
)

189 
ušt8_t
 
buf
[
BUFSIZE
];

190 
Æmsghdr
 
msg
[1];

191 } 
u
;

192 
Æmsghdr
 *
Æmsg
;

193 
sock
, 
Ën
, 
£q
 = 0, 
”r
 = 0;

195 ià(!
¹h
)

196  
EINVAL
;

199 ià((
sock
 = 
	`sock‘
(
PF_NETLINK
, 
SOCK_DGRAM
, 
NETLINK_ROUTE
)) < 0) {

200 
	`DEBUG_WARNING
("li¡: sock‘(): (%m)\n", 
”ºo
);

201  
”ºo
;

205 
	`mem£t
(
u
.
buf
, 0, (u.buf));

208 
Æmsg
 = 
u
.
msg
;

211 
Æmsg
->
Æmsg_Ën
 = 
	`NLMSG_LENGTH
((
¹msg
));

212 
Æmsg
->
Æmsg_ty³
 = 
RTM_GETROUTE
;

213 
Æmsg
->
Æmsg_æags
 = 
NLM_F_DUMP
 | 
NLM_F_REQUEST
;

214 
Æmsg
->
Æmsg_£q
 = 
£q
++;

215 
Æmsg
->
Æmsg_pid
 = 
	`g‘pid
();

218 ià(
	`£nd
(
sock
, 
Æmsg
,‚lmsg->
Æmsg_Ën
, 0) < 0) {

219 
”r
 = 
”ºo
;

220 
	`DEBUG_WARNING
("li¡: wr™tØsock‘ faed (%m)\n", 
”r
);

221 
out
;

225 ià((
Ën
 = 
	`»ad_sock
(
sock
, 
u
.
buf
, (u.buf), 
£q
, 
	`g‘pid
())) < 0) {

226 
”r
 = 
”ºo
;

227 
	`DEBUG_WARNING
("li¡:„—d from sock‘ faed (%m)\n", 
”r
);

228 
out
;

232 ;
	`NLMSG_OK
(
Æmsg
,(
ušt32_t
)
Ën
);Æmsg = 
	`NLMSG_NEXT
(nlmsg,len)) {

233 
Ãt_¹
 
¹
;

235 
	`mem£t
(&
¹
, 0, (
Ãt_¹
));

236 ià(0 !ğ
	`¹_·r£
(
Æmsg
, &
¹
))

239 #ifdeà
HAVE_INET6


240 ià(
AF_INET6
 =ğ
	`§_af
(&
¹
.
d¡
)

241 && 
	`IN6_IS_ADDR_UNSPECIFIED
(&
¹
.
d¡
.
u
.
š6
.
sš6_addr
))

245 ià(
	`¹h
(
¹
.
iâame
, &¹.
d¡
,„t.
d¡Ën
, &¹.
gw
, 
¬g
))

249 
out
:

250 ()
	`şo£
(
sock
);

252  
”r
;

253 
	}
}

	@re-0.5.6/src/net/net.c

6 
	#_BSD_SOURCE
 1

	)

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

10 #ià!
defšed
(
WIN32
è&& !defšed(
CYGWIN
)

11 
	#__USE_BSD
 1

	)

12 
	~<uni¡d.h
>

13 
	~<Ãtdb.h
>

15 
	~<»_ty³s.h
>

16 
	~<»_fmt.h
>

17 
	~<»_mbuf.h
>

18 
	~<»_§.h
>

19 
	~<»_Ãt.h
>

22 
	#DEBUG_MODULE
 "Ãt"

	)

23 
	#DEBUG_LEVEL
 5

	)

24 
	~<»_dbg.h
>

35 
	$Ãt_ho¡addr
(
af
, 
§
 *

)

37 
ho¡Çme
[256];

38 
š_addr
 
š
;

39 
ho¡’t
 *
he
;

41 ià(-1 =ğ
	`g‘ho¡Çme
(
ho¡Çme
, (hostname)))

42  
”ºo
;

44 
he
 = 
	`g‘ho¡byÇme
(
ho¡Çme
);

45 ià(!
he
)

46  
ENOENT
;

48 ià(
af
 !ğ
he
->
h_add¹y³
)

49  
EAFNOSUPPORT
;

52 
	`memıy
(&
š
, 
he
->
h_addr_li¡
[0], (in));

53 
	`§_£t_š
(

, 
	`Áohl
(
š
.
s_addr
), 0);

56 
	}
}

67 
	$Ãt_deçuÉ_sourû_addr_g‘
(
af
, 
§
 *

)

69 #ià
	`defšed
(
WIN32
è|| defšed(
CYGWIN
)

70  
	`Ãt_ho¡addr
(
af
, 

);

72 
iâame
[64] = "";

74 #ifdeà
HAVE_ROUTE_LIST


76 ()
	`Ãt_¹_deçuÉ_g‘
(
af
, 
iâame
, (ifname));

80 ià(0 =ğ
	`Ãt_if_g‘addr
(
iâame
, 
af
, 

))

84 ià(0 =ğ
	`Ãt_if_g‘addr
(
NULL
, 
af
, 

))

87  
	`Ãt_if_g‘addr4
(
iâame
, 
af
, 

);

89 
	}
}

101 
	$Ãt_if_­¶y
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

103 #ifdeà
HAVE_GETIFADDRS


104  
	`Ãt_g‘içddrs
(
ifh
, 
¬g
);

106  
	`Ãt_if_li¡
(
ifh
, 
¬g
);

108 
	}
}

111 
boŞ
 
	$Ãt_¹_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *
d¡
,

112 
d¡Ën
, cÚ¡ 
§
 *
gw
, *
¬g
)

114 **
¬gv
 = 
¬g
;

115 
§
 *

 = 
¬gv
[1];

116 ()
d¡
;

117 ()
d¡Ën
;

119 ià(0 =ğ
	`¡r_cmp
(
iâame
, 
¬gv
[0])) {

120 *

 = *
gw
;

121  
Œue
;

124  
çl£
;

125 
	}
}

136 
	$Ãt_deçuÉ_g©eway_g‘
(
af
, 
§
 *
gw
)

138 
iâame
[64];

139 *
¬gv
[2];

140 
”r
;

142 ià(!
af
 || !
gw
)

143  
EINVAL
;

145 
”r
 = 
	`Ãt_¹_deçuÉ_g‘
(
af
, 
iâame
, (ifname));

146 ià(
”r
)

147  
”r
;

149 
¬gv
[0] = 
iâame
;

150 
¬gv
[1] = 
gw
;

152 
”r
 = 
	`Ãt_¹_li¡
(
Ãt_¹_hªdËr
, 
¬gv
);

153 ià(
”r
)

154  
”r
;

157 
	}
}

	@re-0.5.6/src/net/netstr.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_Ãt.h
>

18 cÚ¡ *
	$Ãt_´Ùo2Çme
(
´Ùo
)

20 
´Ùo
) {

22 
IPPROTO_UDP
:  "UDP";

23 
IPPROTO_TCP
:  "TCP";

24 #ifdeà
IPPROTO_SCTP


25 
IPPROTO_SCTP
:  "SCTP";

29 
	}
}

39 cÚ¡ *
	$Ãt_af2Çme
(
af
)

41 
af
) {

43 
AF_UNSPEC
:  "AF_UNSPEC";

44 
AF_INET
:  "AF_INET";

45 #ifdeà
HAVE_INET6


46 
AF_INET6
:  "AF_INET6";

50 
	}
}

	@re-0.5.6/src/net/posix/pif.c

6 
	~<¡ršg.h
>

7 
	~<uni¡d.h
>

8 
	~<sys/ioùl.h
>

9 
	~<sys/sock‘.h
>

10 
	#__USE_POSIX
 1

	)

11 
	#__USE_XOPEN2K
 1

	)

12 
	~<Ãtdb.h
>

13 
	#__USE_MISC
 1

	)

14 
	~<Ãt/if.h
>

15 
	~<¬·/š‘.h
>

17 #ifdeà
__sun


18 
	~<sys/sockio.h
>

20 
	~<»_ty³s.h
>

21 
	~<»_fmt.h
>

22 
	~<»_mbuf.h
>

23 
	~<»_§.h
>

24 
	~<»_Ãt.h
>

27 
	#DEBUG_MODULE
 "posixif"

	)

28 
	#DEBUG_LEVEL
 5

	)

29 
	~<»_dbg.h
>

43 
	$Ãt_if_g‘addr4
(cÚ¡ *
iâame
, 
af
, 
§
 *

)

45 
addršfo
 
hšts
, *
»s
, *
r
;

46 
”rÜ
, 
”r
;

48 ià(
AF_INET
 !ğ
af
)

49  
EAFNOSUPPORT
;

51 
	`mem£t
(&
hšts
, 0, (hints));

53 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

54 
hšts
.
ai_æags
 = 
AI_PASSIVE
;

55 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

56 
”rÜ
 = 
	`g‘addršfo
(
NULL
, "0", &
hšts
, &
»s
);

57 ià(
”rÜ
) {

58 
	`DEBUG_WARNING
("get_ifaddr: getaddrinfo(): %s\n",

59 
	`gai_¡»¼Ü
(
”rÜ
));

60  
EADDRNOTAVAIL
;

63 
”r
 = 
ENOENT
;

64 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

65 
iäeq
 
iär
;

66 
fd
 = -1;

68 
fd
 = 
	`sock‘
(
r
->
ai_çmy
, 
SOCK_DGRAM
, 0);

69 ià(
fd
 < 0) {

73 
iär
.
iä_addr
.
§_çmy
 = 
r
->
ai_çmy
;

74 
	`¡r_nıy
(
iär
.
iä_Çme
, 
iâame
, (ifrr.ifr_name));

76 ià(
	`ioùl
(
fd
, 
SIOCGIFADDR
, &
iär
) < 0) {

77 
”r
 = 
”ºo
;

78 
Ãxt
;

81 
”r
 = 
	`§_£t_§
(

, &
iär
.
iä_iäu
.
iäu_addr
);

83 
Ãxt
:

84 ()
	`şo£
(
fd
);

87 
	`ä“addršfo
(
»s
);

88  
”r
;

89 
	}
}

102 
	$Ãt_if_li¡
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

104 
iäeq
 
iäv
[32], *
iä
;

105 
ifcÚf
 
ifc
;

106 
sockfd
 = -1;

107 
”r
 = 0;

109 ià(0 > (
sockfd
 = 
	`sock‘
(
AF_INET
, 
SOCK_DGRAM
, 
IPPROTO_IP
))) {

110 
”r
 = 
”ºo
;

111 
	`DEBUG_WARNING
("š‹rçû†i¡: sock‘(): (%m)\n", 
”r
);

112 
out
;

115 
ifc
.
ifc_Ën
 = (
iäv
);

116 
ifc
.
ifc_»q
 = 
iäv
;

118 ià(0 !ğ
	`ioùl
(
sockfd
, 
SIOCGIFCONF
, &
ifc
)) {

119 
”r
 = 
”ºo
;

120 
	`DEBUG_WARNING
("š‹rçû†i¡: ioùÈSIOCFIFCONF: %m\n", 
”r
);

121 
out
;

124 
iä
 = 
ifc
.
ifc_»q
;

125 (*)
iä
 < ((*)
ifc
.
ifc_buf
 + ifc.
ifc_Ën
);

126 ++
iä
) {

127 
iäeq
 
iär
;

128 
§
 sa;

130 ià(
iä
->
iä_addr
.
§_d©a
 == (ifr+1)->ifr_addr.sa_data)

133 ià(
	`ioùl
(
sockfd
, 
SIOCGIFFLAGS
, 
iä
))

137 ià(
iä
->
iä_æags
 & 
IFF_LOOPBACK
)

141 ià(!(
iä
->
iä_æags
 & 
IFF_UP
))

144 
iär
.
iä_addr
.
§_çmy
 = 
AF_INET
;

145 
	`¡r_nıy
(
iär
.
iä_Çme
, 
iä
->ifr_name, (ifrr.ifr_name));

147 ià(
	`ioùl
(
sockfd
, 
SIOCGIFADDR
, &
iär
) < 0) {

148 
”r
 = 
”ºo
;

152 
”r
 = 
	`§_£t_§
(&
§
, &
iär
.
iä_iäu
.
iäu_addr
);

153 ià(
”r
) {

154 
	`DEBUG_WARNING
("if_li¡: sa_£t_§ %m\n", 
”r
);

158 ià(
ifh
 && 
	`ifh
(
iä
->
iä_Çme
, &
§
, 
¬g
))

162 
out
:

163 ià(
sockfd
 >= 0)

164 ()
	`şo£
(
sockfd
);

166  
”r
;

167 
	}
}

	@re-0.5.6/src/net/rt.c

6 
	#_BSD_SOURCE
 1

	)

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_Ãt.h
>

15 
	sÃt_¹
 {

16 
	maf
;

17 *
	miâame
;

18 
size_t
 
	msize
;

19 
	m´efix
;

23 
boŞ
 
	$¹_debug_hªdËr
(cÚ¡ *
iâame
, cÚ¡ 
§
 *
d¡
,

24 
d¡Ën
, cÚ¡ 
§
 *
gw
, *
¬g
)

26 
addr
[64];

27 
»_´štf
 *
pf
 = 
¬g
;

28 
”r
 = 0;

30 ()
	`»_¢´štf
(
addr
, ×ddr), "%j/%d", 
d¡
, 
d¡Ën
);

32 
”r
 |ğ
	`»_h´štf
(
pf
, " %-44s", 
addr
);

33 
”r
 |ğ
	`»_h´štf
(
pf
, "%-40j", 
gw
);

34 
”r
 |ğ
	`»_h´štf
(
pf
, " %-15 ", 
iâame
);

36 #ifdeà
HAVE_INET6


37 ià(
AF_INET6
 =ğ
	`§_af
(
d¡
)) {

38 cÚ¡ 
sockaddr_š6
 *
sš6
 = &
d¡
->
u
.
š6
;

39 cÚ¡ 
š6_addr
 *
š6
 = &
sš6
->
sš6_addr
;

41 ià(
	`IN6_IS_ADDR_MULTICAST
(
š6
))

42 
”r
 |ğ
	`»_h´štf
(
pf
, " MULTICAST");

43 ià(
	`IN6_IS_ADDR_LINKLOCAL
(
š6
))

44 
”r
 |ğ
	`»_h´štf
(
pf
, " LINKLOCAL");

45 ià(
	`IN6_IS_ADDR_SITELOCAL
(
š6
))

46 
”r
 |ğ
	`»_h´štf
(
pf
, " SITELOCAL");

50 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

52  0 !ğ
”r
;

53 
	}
}

64 
	$Ãt_¹_debug
(
»_´štf
 *
pf
, *
unu£d
)

66 
”r
 = 0;

68 ()
unu£d
;

70 
”r
 |ğ
	`»_h´štf
(
pf
, "net„outes:\n");

72 
”r
 |ğ
	`»_h´štf
(
pf
, " Destination "

77 
”r
 |ğ
	`Ãt_¹_li¡
(
¹_debug_hªdËr
, 
pf
);

79  
”r
;

80 
	}
}

83 
boŞ
 
	$¹_deçuÉ_g‘_hªdËr
(cÚ¡ *
_iâame
, cÚ¡ 
§
 *
d¡
,

84 
d¡Ën
, cÚ¡ 
§
 *
gw
, *
¬g
)

86 
Ãt_¹
 *
¹
 = 
¬g
;

88 ()
d¡Ën
;

89 ()
gw
;

91 ià(
	`§_af
(
d¡
è!ğ
¹
->
af
)

92  
çl£
;

94 
¹
->
af
) {

96 
AF_INET
:

97 ià(0 =ğ
	`§_š
(
d¡
)) {

98 
	`¡r_nıy
(
¹
->
iâame
, 
_iâame
,„t->
size
);

99  
Œue
;

103 #ifdeà
HAVE_INET6


104 
AF_INET6
:

105 ià(
	`IN6_IS_ADDR_MULTICAST
(&
d¡
->
u
.
š6
.
sš6_addr
))

106  
çl£
;

107 ià(
	`IN6_IS_ADDR_LINKLOCAL
(&
d¡
->
u
.
š6
.
sš6_addr
))

108  
çl£
;

110 ià(
d¡Ën
 < 
¹
->
´efix
) {

111 
¹
->
´efix
 = 
d¡Ën
;

112 
	`¡r_nıy
(
¹
->
iâame
, 
_iâame
,„t->
size
);

113  
çl£
;

119  
çl£
;

120 
	}
}

132 
	$Ãt_¹_deçuÉ_g‘
(
af
, *
iâame
, 
size_t
 
size
)

134 
Ãt_¹
 
¹
;

135 
”r
;

137 
¹
.
af
 =‡f;

138 
¹
.
iâame
 = ifname;

139 
¹
.
size
 = size;

140 
¹
.
´efix
 = 256;

142 
”r
 = 
	`Ãt_¹_li¡
(
¹_deçuÉ_g‘_hªdËr
, &
¹
);

143 ià(
”r
)

144  
”r
;

146  '\0' !ğ
iâame
[0] ? 0 : 
EINVAL
;

147 
	}
}

150 #iâdeà
HAVE_ROUTE_LIST


152 
	$Ãt_¹_li¡
(
Ãt_¹_h
 *
¹h
, *
¬g
)

154 ()
¹h
;

155 ()
¬g
;

156  
ENOSYS
;

157 
	}
}

	@re-0.5.6/src/net/sock.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_Ãt.h
>

12 
	#DEBUG_MODULE
 "Ãtsock"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

17 
boŞ
 
	gš™ed
 = 
çl£
;

20 #ifdeà
WIN32


21 
	$w§_š™
()

23 
WORD
 
wV”siÚReque¡ed
 = 
	`MAKEWORD
(2, 2);

24 
WSADATA
 
w§D©a
;

25 
”r
;

27 
”r
 = 
	`WSAS¹up
(
wV”siÚReque¡ed
, &
w§D©a
);

28 ià(
”r
 != 0) {

29 
	`DEBUG_WARNING
("Could‚Ù†ßd wšsock (%m)\n", 
”r
);

30  
”r
;

38 ià(
	`LOBYTE
(
w§D©a
.
wV”siÚ
) != 2 ||

39 
	`HIBYTE
(
w§D©a
.
wV”siÚ
) != 2 ) {

40 
	`WSACËªup
();

41 
	`DEBUG_WARNING
("Bad winsock verion (%d.%d)\n",

42 
	`HIBYTE
(
w§D©a
.
wV”siÚ
),

43 
	`LOBYTE
(
w§D©a
.
wV”siÚ
));

44  
EINVAL
;

48 
	}
}

57 
	$Ãt_sock_š™
()

59 
”r
 = 0;

61 
	`DEBUG_INFO
("sock in™: in™ed=%d\n", 
š™ed
);

63 ià(
š™ed
)

66 #ifdeà
WIN32


67 
”r
 = 
	`w§_š™
();

70 
š™ed
 = 
Œue
;

72  
”r
;

73 
	}
}

79 
	$Ãt_sock_şo£
()

81 #ifdeà
WIN32


82 cÚ¡ 
”r
 = 
	`WSACËªup
();

83 ià(0 !ğ
”r
) {

84 
	`DEBUG_WARNING
("sock clo£: WSACËªu°(%d)\n", 
”r
);

88 
š™ed
 = 
çl£
;

90 
	`DEBUG_INFO
("sock close\n");

91 
	}
}

	@re-0.5.6/src/net/sockopt.c

6 #ifdeà
HAVE_UNISTD_H


7 
	~<uni¡d.h
>

9 
	~<fú.h
>

10 
	~<»_ty³s.h
>

11 
	~<»_fmt.h
>

12 
	~<»_Ãt.h
>

15 
	#DEBUG_MODULE
 "sockİt"

	)

16 
	#DEBUG_LEVEL
 5

	)

17 
	~<»_dbg.h
>

21 #ifdeà
WIN32


22 
	#BUF_CAST
 (*)

	)

24 
	#BUF_CAST


	)

36 
	$Ãt_sockİt_blockšg_£t
(
fd
, 
boŞ
 
blockšg
)

38 #ifdeà
WIN32


39 
noblock
 = !
blockšg
;

40 
”r
 = 0;

42 ià(0 !ğ
	`ioùlsock‘
(
fd
, 
FIONBIO
, &
noblock
)) {

43 
”r
 = 
	`WSAG‘La¡E¼Ü
();

44 
	`DEBUG_WARNING
("nonblock set: fd=%dƒrr=%d (%m)\n",

45 
fd
, 
”r
,ƒrr);

47  
”r
;

49 
æags
;

50 
”r
 = 0;

52 
æags
 = 
	`fú
(
fd
, 
F_GETFL
);

53 ià(-1 =ğ
æags
) {

54 
”r
 = 
”ºo
;

55 
	`DEBUG_WARNING
("sockİˆ£t: fnùÈF_GETFL: (%m)\n", 
”r
);

56 
out
;

59 ià(
blockšg
)

60 
æags
 &ğ~
O_NONBLOCK
;

62 
æags
 |ğ
O_NONBLOCK
;

64 ià(-1 =ğ
	`fú
(
fd
, 
F_SETFL
, 
æags
)) {

65 
”r
 = 
”ºo
;

66 
	`DEBUG_WARNING
("sockopt set: fcntl F_SETFL‚on-block (%m)\n",

67 
”r
);

70 
out
:

71  
”r
;

73 
	}
}

84 
	$Ãt_sockİt_»u£_£t
(
fd
, 
boŞ
 
»u£
)

86 
r
 = 
»u£
;

88 #ifdeà
SO_REUSEADDR


89 ià(-1 =ğ
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

90 
BUF_CAST
 &
r
, (r))) {

91 
	`DEBUG_WARNING
("SO_REUSEADDR: %m\n", 
”ºo
);

92  
”ºo
;

96 #ifdeà
SO_REUSEPORT


97 ià(-1 =ğ
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEPORT
,

98 
BUF_CAST
 &
r
, (r))) {

99 
	`DEBUG_INFO
("SO_REUSEPORT: %m\n", 
”ºo
);

100  
”ºo
;

104 #ià!
	`defšed
(
SO_REUSEADDR
è&& !defšed(
SO_REUSEPORT
)

105 ()
r
;

106 ()
fd
;

107 ()
»u£
;

108  
ENOSYS
;

112 
	}
}

	@re-0.5.6/src/net/win32/wif.c

6 
	~<wšsock2.h
>

7 
	~<hÍ­i.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_Ãt.h
>

11 
	~<»_§.h
>

14 
	#DEBUG_MODULE
 "wif"

	)

15 
	#DEBUG_LEVEL
 5

	)

16 
	~<»_dbg.h
>

25 
	$if_li¡_g¯
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

27 
IP_ADAPTER_ADDRESSES
 
addrv
[16], *
cur
;

28 
ULONG
 
»t
, 
Ën
 = (
addrv
);

29 cÚ¡ 
ULONG
 
æags
 = 
GAA_FLAG_SKIP_ANYCAST
 | 
GAA_FLAG_SKIP_MULTICAST
;

30 
HANDLE
 
hLib
;

32 
FARPROC
 
´oc
;

33 
	`ULONG
 (
WINAPI
 *
g¯
)(
ULONG
, ULONG, 
PVOID
,

34 
PIP_ADAPTER_ADDRESSES
, 
PULONG
);

35 } 
u
;

36 
boŞ
 
¡İ
 = 
çl£
;

37 
”r
 = 0;

39 
hLib
 = 
	`LßdLib¿ry
(
	`TEXT
("iphlpapi.dll"));

40 ià(!
hLib
)

41  
ENOSYS
;

43 
u
.
´oc
 = 
	`G‘ProcAdd»ss
(
hLib
, 
	`TEXT
("GetAdaptersAddresses"));

44 ià(!
u
.
´oc
) {

45 
”r
 = 
ENOSYS
;

46 
out
;

49 
»t
 = (*
u
.
g¯
)(
AF_UNSPEC
, 
æags
, 
NULL
, 
addrv
, &
Ën
);

50 ià(
»t
 !ğ
ERROR_SUCCESS
) {

51 
	`DEBUG_WARNING
("if_li¡: G‘Ad­‹rsAdd»s£ »t=%u\n", 
»t
);

52 
”r
 = 
ENODEV
;

53 
out
;

56 
cur
 = 
addrv
; cu¸&& !
¡İ
; cu¸ğcur->
Next
) {

57 
PIP_ADAPTER_UNICAST_ADDRESS
 

;

60 

 = 
cur
->
Fœ¡Uniÿ¡Add»ss
; ip; i°ğ->
Next
) {

61 
§
 sa;

63 
	`§_£t_§
(&
§
, 

->
Add»ss
.
ÍSockaddr
);

65 ià(
ifh
 && 
	`ifh
(
cur
->
Ad­‹rName
, &
§
, 
¬g
)) {

66 
¡İ
 = 
Œue
;

72 
out
:

73 
	`F»eLib¿ry
(
hLib
);

75  
”r
;

76 
	}
}

84 
	$if_li¡_gai
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

86 
IP_ADAPTER_INFO
 
šfo
[32];

87 
PIP_ADAPTER_INFO
 
p
 = 
šfo
;

88 
ULONG
 
ulOutBufL’
 = (
šfo
);

89 
DWORD
 
»t
;

91 
»t
 = 
	`G‘Ad­‹rsInfo
(
šfo
, &
ulOutBufL’
);

92 ià(
»t
 !ğ
ERROR_SUCCESS
) {

93 
	`DEBUG_WARNING
("if_li¡: G‘Ad­‹rsInfØ»t=%u\n", 
»t
);

94  
ENODEV
;

97 
p
 = 
šfo
;…;… =…->
Next
) {

98 
§
 sa;

100 ià(
	`§_£t_¡r
(&
§
, 
p
->
IpAdd»ssLi¡
.
IpAdd»ss
.
SŒšg
, 0))

103 ià(
ifh
 && 
	`ifh
(
p
->
Ad­‹rName
, &
§
, 
¬g
))

108 
	}
}

119 
	$Ãt_if_li¡
(
Ãt_içddr_h
 *
ifh
, *
¬g
)

123 ià(!
	`if_li¡_g¯
(
ifh
, 
¬g
))

126  
	`if_li¡_gai
(
ifh
, 
¬g
);

127 
	}
}

	@re-0.5.6/src/odict/entry.c

7 
	~"»_ty³s.h
"

8 
	~"»_fmt.h
"

9 
	~"»_mem.h
"

10 
	~"»_li¡.h
"

11 
	~"»_hash.h
"

12 
	~"»_odiù.h
"

15 
	$de¡ruùÜ
(*
¬g
)

17 
odiù_’Œy
 *
e
 = 
¬g
;

19 
e
->
ty³
) {

21 
ODICT_OBJECT
:

22 
ODICT_ARRAY
:

23 
	`mem_d”ef
(
e
->
u
.
odiù
);

26 
ODICT_STRING
:

27 
	`mem_d”ef
(
e
->
u
.
¡r
);

34 
	`hash_uÆšk
(&
e
->
he
);

35 
	`li¡_uÆšk
(&
e
->
Ë
);

36 
	`mem_d”ef
(
e
->
key
);

37 
	}
}

40 
	$odiù_’Œy_add
(
odiù
 *
o
, cÚ¡ *
key
,

41 
ty³
, ...)

43 
odiù_’Œy
 *
e
;

44 
va_li¡
 
­
;

45 
”r
;

47 ià(!
o
 || !
key
)

48  
EINVAL
;

50 
e
 = 
	`mem_z®loc
((*e), 
de¡ruùÜ
);

51 ià(!
e
)

52  
ENOMEM
;

54 
e
->
ty³
 =ype;

56 
”r
 = 
	`¡r_dup
(&
e
->
key
, key);

57 ià(
”r
)

58 
out
;

60 
	`va_¡¬t
(
­
, 
ty³
);

62 
e
->
ty³
) {

64 
ODICT_OBJECT
:

65 
ODICT_ARRAY
:

66 
e
->
u
.
odiù
 = 
	`mem_»f
(
	`va_¬g
(
­
, odict *));

69 
ODICT_STRING
:

70 
”r
 = 
	`¡r_dup
(&
e
->
u
.
¡r
, 
	`va_¬g
(
­
, const *));

73 
ODICT_INT
:

74 
e
->
u
.
š‹g”
 = 
	`va_¬g
(
­
, 
št64_t
);

77 
ODICT_DOUBLE
:

78 
e
->
u
.
dbl
 = 
	`va_¬g
(
­
, );

81 
ODICT_BOOL
:

82 
e
->
u
.
boŞ—n
 = 
	`va_¬g
(
­
, );

85 
ODICT_NULL
:

89 
”r
 = 
EINVAL
;

93 
	`va_’d
(
­
);

95 ià(
”r
)

96 
out
;

98 
	`li¡_­³nd
(&
o
->
l¡
, &
e
->
Ë
,ƒ);

99 
	`hash_­³nd
(
o
->
ht
, 
	`hash_ç¡_¡r
(
e
->
key
), &e->
he
,ƒ);

101 
out
:

102 ià(
”r
)

103 
	`mem_d”ef
(
e
);

105  
”r
;

106 
	}
}

109 
	$odiù_’Œy_d–
(
odiù
 *
o
, cÚ¡ *
key
)

111 
	`mem_d”ef
((
odiù_’Œy
 *)
	`odiù_lookup
(
o
, 
key
));

112 
	}
}

115 
	$odiù_’Œy_debug
(
»_´štf
 *
pf
, cÚ¡ 
odiù_’Œy
 *
e
)

117 
”r
;

119 ià(!
e
)

122 
”r
 = 
	`»_h´štf
(
pf
, "%s", 
e
->
key
);

124 
e
->
ty³
) {

126 
ODICT_OBJECT
:

127 
ODICT_ARRAY
:

128 
”r
 |ğ
	`»_h´štf
(
pf
, ":%H", 
odiù_debug
, 
e
->
u
.
odiù
);

131 
ODICT_STRING
:

132 
”r
 |ğ
	`»_h´štf
(
pf
, ":%s", 
e
->
u
.
¡r
);

135 
ODICT_INT
:

136 
”r
 |ğ
	`»_h´štf
(
pf
, ":%Îi", 
e
->
u
.
š‹g”
);

139 
ODICT_DOUBLE
:

140 
”r
 |ğ
	`»_h´štf
(
pf
, ":%f", 
e
->
u
.
dbl
);

143 
ODICT_BOOL
:

144 
”r
 |ğ
	`»_h´štf
(
pf
, ":%s", 
e
->
u
.
boŞ—n
 ? "true" : "false");

147 
ODICT_NULL
:

151  
”r
;

152 
	}
}

	@re-0.5.6/src/odict/odict.c

6 
	~"»_ty³s.h
"

7 
	~"»_fmt.h
"

8 
	~"»_mem.h
"

9 
	~"»_li¡.h
"

10 
	~"»_hash.h
"

11 
	~"»_odiù.h
"

14 
	$de¡ruùÜ
(*
¬g
)

16 
odiù
 *
o
 = 
¬g
;

18 
	`hash_ş—r
(
o
->
ht
);

19 
	`li¡_æush
(&
o
->
l¡
);

20 
	`mem_d”ef
(
o
->
ht
);

21 
	}
}

24 
	$odiù_®loc
(
odiù
 **
İ
, 
ušt32_t
 
hash_size
)

26 
odiù
 *
o
;

27 
”r
;

29 ià(!
İ
 || !
hash_size
)

30  
EINVAL
;

32 
o
 = 
	`mem_z®loc
((*o), 
de¡ruùÜ
);

33 ià(!
o
)

34  
ENOMEM
;

36 
”r
 = 
	`hash_®loc
(&
o
->
ht
, 
	`hash_v®id_size
(
hash_size
));

37 ià(
”r
)

38 
out
;

40 
out
:

41 ià(
”r
)

42 
	`mem_d”ef
(
o
);

44 *
İ
 = 
o
;

46  
”r
;

47 
	}
}

50 cÚ¡ 
odiù_’Œy
 *
	$odiù_lookup
(cÚ¡ 
odiù
 *
o
, cÚ¡ *
key
)

52 
Ë
 *le;

54 ià(!
o
 || !
key
)

55  
NULL
;

57 
Ë
 = 
	`li¡_h—d
(
	`hash_li¡
(
o
->
ht
, 
	`hash_ç¡_¡r
(
key
)));

59 
Ë
) {

60 cÚ¡ 
odiù_’Œy
 *
e
 = 
Ë
->
d©a
;

62 ià(!
	`¡r_cmp
(
e
->
key
, key))

63  
e
;

65 
Ë
 =†e->
Ãxt
;

68  
NULL
;

69 
	}
}

72 
size_t
 
	$odiù_couÁ
(cÚ¡ 
odiù
 *
o
, 
boŞ
 
Ã¡ed
)

74 
Ë
 *le;

75 
size_t
 
n
 = 0;

77 ià(!
o
)

80 ià(!
Ã¡ed
)

81  
	`li¡_couÁ
(&
o
->
l¡
);

83 
Ë
=
o
->
l¡
.
h—d
;†e;†eöe->
Ãxt
) {

85 cÚ¡ 
odiù_’Œy
 *
e
 = 
Ë
->
d©a
;

87 
e
->
ty³
) {

89 
ODICT_OBJECT
:

90 
ODICT_ARRAY
:

91 
n
 +ğ
	`odiù_couÁ
(
e
->
u
.
odiù
, 
Œue
);

95 
n
 += 1;

100  
n
;

101 
	}
}

104 
	$odiù_debug
(
»_´štf
 *
pf
, cÚ¡ 
odiù
 *
o
)

106 
Ë
 *le;

107 
”r
;

109 ià(!
o
)

112 
”r
 = 
	`»_h´štf
(
pf
, "{");

114 
Ë
=
o
->
l¡
.
h—d
;†e;†eöe->
Ãxt
) {

116 cÚ¡ 
odiù_’Œy
 *
e
 = 
Ë
->
d©a
;

118 
”r
 |ğ
	`»_h´štf
(
pf
, " %H", 
odiù_’Œy_debug
, 
e
);

121 
”r
 |ğ
	`»_h´štf
(
pf
, " }");

123  
”r
;

124 
	}
}

	@re-0.5.6/src/odict/type.c

7 
	~"»_ty³s.h
"

8 
	~"»_fmt.h
"

9 
	~"»_mem.h
"

10 
	~"»_li¡.h
"

11 
	~"»_hash.h
"

12 
	~"»_odiù.h
"

15 
boŞ
 
	$odiù_ty³_iscÚš”
(
odiù_ty³
 
ty³
)

17 
ty³
) {

19 
ODICT_OBJECT
:

20 
ODICT_ARRAY
:

21  
Œue
;

24  
çl£
;

26 
	}
}

29 
boŞ
 
	$odiù_ty³_i¤—l
(
odiù_ty³
 
ty³
)

31 
ty³
) {

33 
ODICT_STRING
:

34 
ODICT_INT
:

35 
ODICT_DOUBLE
:

36 
ODICT_BOOL
:

37 
ODICT_NULL
:

38  
Œue
;

41  
çl£
;

43 
	}
}

46 cÚ¡ *
	$odiù_ty³_Çme
(
odiù_ty³
 
ty³
)

48 
ty³
) {

50 
ODICT_OBJECT
:  "Object";

51 
ODICT_ARRAY
:  "Array";

52 
ODICT_STRING
:  "String";

53 
ODICT_INT
:  "Integer";

54 
ODICT_DOUBLE
:  "Double";

55 
ODICT_BOOL
:  "Boolean";

56 
ODICT_NULL
:  "Null";

59 
	}
}

	@re-0.5.6/src/rtp/fb.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_sys.h
>

13 
	~<»_§.h
>

14 
	~<»_¹p.h
>

15 
	~"¹ı.h
"

18 
	#DEBUG_MODULE
 "¹ı_pb"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

24 
	mGNACK_SIZE
 = 4,

25 
	mSLI_SIZE
 = 4

41 
	$¹ı_¹pfb_gÇck_’code
(
mbuf
 *
mb
, 
ušt16_t
 
pid
, ušt16_ˆ
bÍ
)

43 
”r
;

44 
”r
 = 
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
pid
));

45 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
bÍ
));

46  
”r
;

47 
	}
}

60 
	$¹ı_psfb_¦i_’code
(
mbuf
 *
mb
, 
ušt16_t
 
fœ¡
, ušt16_ˆ
numb”
,

61 
ušt8_t
 
picid
)

63 cÚ¡ 
ušt32_t
 
v
 = 
fœ¡
<<19 | 
numb”
<<6 | 
picid
;

64  
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
v
));

65 
	}
}

79 
	$¹ı_¹pfb_decode
(
mbuf
 *
mb
, 
¹ı_msg
 *
msg
)

81 
size_t
 
i
, 
sz
;

83 ià(!
msg
)

84  
EINVAL
;

86 
msg
->
hdr
.
couÁ
) {

88 
RTCP_RTPFB_GNACK
:

89 
sz
 = 
msg
->
r
.
fb
.
n
 * (*msg->r.fb.
fci
.
gÇckv
);

90 
msg
->
r
.
fb
.
fci
.
gÇckv
 = 
	`mem_®loc
(
sz
, 
NULL
);

91 ià(!
msg
->
r
.
fb
.
fci
.
gÇckv
)

92  
ENOMEM
;

94 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
msg
->
r
.
fb
.
n
 * 
GNACK_SIZE
)

95  
EBADMSG
;

96 
i
=0; i<
msg
->
r
.
fb
.
n
; i++) {

97 
msg
->
r
.
fb
.
fci
.
gÇckv
[
i
].
pid
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

98 
msg
->
r
.
fb
.
fci
.
gÇckv
[
i
].
bÍ
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

103 
	`DEBUG_NOTICE
("unknowÀRTPFB fmˆ%d\n", 
msg
->
hdr
.
couÁ
);

108 
	}
}

119 
	$¹ı_psfb_decode
(
mbuf
 *
mb
, 
¹ı_msg
 *
msg
)

121 
size_t
 
i
, 
sz
;

123 ià(!
msg
)

124  
EINVAL
;

126 
msg
->
hdr
.
couÁ
) {

128 
RTCP_PSFB_PLI
:

132 
RTCP_PSFB_SLI
:

133 
sz
 = 
msg
->
r
.
fb
.
n
 * (*msg->r.fb.
fci
.
¦iv
);

134 
msg
->
r
.
fb
.
fci
.
¦iv
 = 
	`mem_®loc
(
sz
, 
NULL
);

135 ià(!
msg
->
r
.
fb
.
fci
.
¦iv
)

136  
ENOMEM
;

138 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
msg
->
r
.
fb
.
n
 * 
SLI_SIZE
)

139  
EBADMSG
;

140 
i
=0; i<
msg
->
r
.
fb
.
n
; i++) {

141 cÚ¡ 
ušt32_t
 
v
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

143 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
fœ¡
 = 
v
>>19 & 0x1fff;

144 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
numb”
 = 
v
>> 6 & 0x1fff;

145 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
picid
 = 
v
>> 0 & 0x003f;

149 
RTCP_PSFB_AFB
:

150 
sz
 = 
msg
->
r
.
fb
.
n
 * 4;

152 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
sz
)

153  
EBADMSG
;

155 
msg
->
r
.
fb
.
fci
.
afb
 = 
	`mbuf_®loc_»f
(
mb
);

156 ià(!
msg
->
r
.
fb
.
fci
.
afb
)

157  
ENOMEM
;

159 
msg
->
r
.
fb
.
fci
.
afb
->
’d
 = msg->r.fb.fci.afb->
pos
 + 
sz
;

160 
	`mbuf_advªû
(
mb
, 
sz
);

164 
	`DEBUG_NOTICE
("unknowÀPSFB fmˆ%d\n", 
msg
->
hdr
.
couÁ
);

169 
	}
}

	@re-0.5.6/src/rtp/member.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_§.h
>

14 
	~<»_¹p.h
>

15 
	~"¹ı.h
"

18 
	$de¡ruùÜ
(*
d©a
)

20 
¹p_memb”
 *
mbr
 = 
d©a
;

22 
	`hash_uÆšk
(&
mbr
->
Ë
);

23 
	`mem_d”ef
(
mbr
->
s
);

24 
	}
}

27 
¹p_memb”
 *
	$memb”_add
(
hash
 *
ht
, 
ušt32_t
 
¤c
)

29 
¹p_memb”
 *
mbr
;

31 
mbr
 = 
	`mem_z®loc
((*mbr), 
de¡ruùÜ
);

32 ià(!
mbr
)

33  
NULL
;

35 
	`hash_­³nd
(
ht
, 
¤c
, &
mbr
->
Ë
, mbr);

36 
mbr
->
¤c
 = src;

38  
mbr
;

39 
	}
}

42 
boŞ
 
	$hash_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

44 cÚ¡ 
¹p_memb”
 *
mbr
 = 
Ë
->
d©a
;

46  
mbr
->
¤c
 =ğ*(
ušt32_t
 *)
¬g
;

47 
	}
}

50 
¹p_memb”
 *
	$memb”_fšd
(
hash
 *
ht
, 
ušt32_t
 
¤c
)

52  
	`li¡_Ëd©a
(
	`hash_lookup
(
ht
, 
¤c
, 
hash_cmp_hªdËr
, &src));

53 
	}
}

	@re-0.5.6/src/rtp/ntp.c

6 #ifdeà
HAVE_SYS_TIME_H


7 
	~<sys/time.h
>

9 
	~<time.h
>

11 
	~<»_ty³s.h
>

12 
	~<»_fmt.h
>

13 
	~<»_li¡.h
>

14 
	~<»_§.h
>

15 
	~<»_¹p.h
>

16 
	~"¹ı.h
"

26 
	#UNIX_NTP_OFFSET
 0x83¯7e80

	)

30 
	$unix2Áp
(
Áp_time
 *
Áp
, cÚ¡ 
timev®
 *
tv
)

32 
Áp
->
hi
 = (
ušt32_t
)(
tv
->
tv_£c
 + 
UNIX_NTP_OFFSET
);

33 
Áp
->
lo
 = (
ušt32_t
)(()
tv
->
tv_u£c
*()(1LL<<32)*1.0e-6);

34 
	}
}

38 
	$Áp2unix
(
timev®
 *
tv
, cÚ¡ 
Áp_time
 *
Áp
)

40 
tv
->
tv_£c
 = 
Áp
->
hi
 - 
UNIX_NTP_OFFSET
;

41 
tv
->
tv_u£c
 = (
ušt32_t
)(1.0e6 * (è
Áp
->
lo
 / (1LL<<32));

42 
	}
}

45 
	$Áp_time_g‘
(
Áp_time
 *
Áp
)

47 
timev®
 
tv
;

48 #ifdeà
WIN32


50 
ns100
;

51 
FILETIME
 
á
;

52 } 
now
;

54 
	`G‘Sy¡emTimeAsFeTime
(&
now
.
á
);

55 
tv
.
tv_u£c
 = (è((
now
.
ns100
 / 10LL) % 1000000LL);

56 
tv
.
tv_£c
 = (è((
now
.
ns100
 - 116444736000000000LL) / 10000000LL);

58 ià(
	`g‘timeofday
(&
tv
, 
NULL
) != 0)

59  
”ºo
;

61 
	`unix2Áp
(
Áp
, &
tv
);

64 
	}
}

68 
ušt32_t
 
	$Áp_com·ù
(cÚ¡ 
Áp_time
 *
Áp
)

70  
Áp
 ? (Ò->
hi
 & 0xffffè<< 16 | (Áp->
lo
 >> 16)) : 0;

71 
	}
}

75 
ušt64_t
 
	$Áp_com·ù2us
(
ušt32_t
 
Ápc
)

77 cÚ¡ 
ušt32_t
 
hi
 = (
Ápc
 >> 16) & 0xffff;

78 cÚ¡ 
ušt32_t
 
lo
 = (
Ápc
 & 0xffff) << 16;

80  (1000000ULL * 
hi
è+ ((1000000ULL * 
lo
) >> 32);

81 
	}
}

	@re-0.5.6/src/rtp/pkt.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_sys.h
>

13 
	~<»_§.h
>

14 
	~<»_¹p.h
>

15 
	~"¹ı.h
"

18 
	#DEBUG_MODULE
 "¹ı_pkt"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

23 
	$¹ı_de¡ruùÜ
(*
d©a
)

25 
¹ı_msg
 *
msg
 = 
d©a
;

26 
size_t
 
i
, 
j
;

28 
msg
->
hdr
.
±
) {

30 
RTCP_SR
:

31 
	`mem_d”ef
(
msg
->
r
.
¤
.
¼v
);

34 
RTCP_RR
:

35 
	`mem_d”ef
(
msg
->
r
.
¼
.
¼v
);

38 
RTCP_SDES
:

39 ià(!
msg
->
r
.
sdesv
)

42 
i
=0; i<
msg
->
hdr
.
couÁ
; i++) {

43 
¹ı_sdes
 *
sdes
 = &
msg
->
r
.
sdesv
[
i
];

45 
j
=0; j<
sdes
->
n
; j++) {

47 
	`mem_d”ef
(
sdes
->
™emv
[
j
].
d©a
);

49 
	`mem_d”ef
(
sdes
->
™emv
);

51 
	`mem_d”ef
(
msg
->
r
.
sdesv
);

54 
RTCP_BYE
:

55 
	`mem_d”ef
(
msg
->
r
.
bye
.
¤cv
);

56 
	`mem_d”ef
(
msg
->
r
.
bye
.
»asÚ
);

59 
RTCP_APP
:

60 
	`mem_d”ef
(
msg
->
r
.
­p
.
d©a
);

63 
RTCP_RTPFB
:

64 
RTCP_PSFB
:

65 
	`mem_d”ef
(
msg
->
r
.
fb
.
fci
.
p
);

72 
	}
}

85 
	$¹ı_hdr_’code
(
mbuf
 *
mb
, 
ušt8_t
 
couÁ
, 
¹ı_ty³
 
ty³
,

86 
ušt16_t
 
Ëngth
)

88 
”r
;

90 ià(!
mb
)

91  
EINVAL
;

93 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
RTCP_VERSION
<<6 | 
couÁ
);

94 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
ty³
);

95 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
Ëngth
));

97  
”r
;

98 
	}
}

109 
	$¹ı_hdr_decode
(
mbuf
 *
mb
, 
¹ı_hdr
 *
hdr
)

111 
ušt8_t
 
b
;

113 ià(!
hdr
)

114  
EINVAL
;

115 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_HDR_SIZE
)

116  
EBADMSG
;

118 
b
 = 
	`mbuf_»ad_u8
(
mb
);

119 
hdr
->
±
 = 
	`mbuf_»ad_u8
(
mb
);

120 
hdr
->
Ëngth
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

122 
hdr
->
v”siÚ
 = (
b
 >> 6) & 0x3;

123 
hdr
->
p
 = (
b
 >> 5) & 0x1;

124 
hdr
->
couÁ
 = (
b
 >> 0) & 0x1f;

127 
	}
}

130 
	$¹ı_v’code
(
mbuf
 *
mb
, 
¹ı_ty³
 
ty³
, 
ušt32_t
 
couÁ
,

131 
va_li¡
 
­
)

133 
size_t
 
i
, 
pos
;

134 
ušt16_t
 
Ën
;

135 cÚ¡ 
ušt8_t
 *
d©a
;

136 
size_t
 
d©a_Ën
;

137 cÚ¡ 
ušt32_t
 *
¤cv
;

138 cÚ¡ *
»asÚ
;

139 
¹ı_’code_h
 *
’ch
;

140 *
¬g
;

141 
”r
 = 0;

143 ià(!
mb
)

144  
EINVAL
;

146 
pos
 = 
mb
->pos;

149 
mb
->
pos
 = mb->
’d
 = (mb->po + 
RTCP_HDR_SIZE
);

151 
ty³
) {

153 
RTCP_SR
:

154 
i
=0; i<6; i++)

155 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

156 
’ch
 = 
	`va_¬g
(
­
, 
¹ı_’code_h
 *);

157 
¬g
 = 
	`va_¬g
(
­
, *);

158 ià(
’ch
)

159 
”r
 |ğ
	`’ch
(
mb
, 
¬g
);

162 
RTCP_RR
:

163 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

164 
’ch
 = 
	`va_¬g
(
­
, 
¹ı_’code_h
 *);

165 
¬g
 = 
	`va_¬g
(
­
, *);

166 ià(
’ch
)

167 
”r
 |ğ
	`’ch
(
mb
, 
¬g
);

170 
RTCP_SDES
:

171 
’ch
 = 
	`va_¬g
(
­
, 
¹ı_’code_h
 *);

172 
¬g
 = 
	`va_¬g
(
­
, *);

173 ià(
’ch
)

174 
”r
 |ğ
	`’ch
(
mb
, 
¬g
);

177 
RTCP_BYE
:

178 
¤cv
 = 
	`va_¬g
(
­
, 
ušt32_t
 *);

179 
»asÚ
 = 
	`va_¬g
(
­
, *);

180 
i
=0; i<
couÁ
 && !
”r
; i++) {

181 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¤cv
[
i
]));

183 ià(
»asÚ
) {

184 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
	`¡¾’
(
»asÚ
));

185 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, 
»asÚ
);

189 
RTCP_APP
:

190 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

191 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
	`va_¬g
(
­
, 
ušt8_t
 *), 4);

192 
d©a
 = 
	`va_¬g
(
­
, cÚ¡ 
ušt8_t
 *);

193 
d©a_Ën
 = 
	`va_¬g
(
­
, 
size_t
);

194 ià(
d©a
) {

195 ià(
d©a_Ën
 % 4) {

196 
	`DEBUG_WARNING
("not‡ multiple of 32bits\n");

197  
EBADMSG
;

199 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
d©a
, 
d©a_Ën
);

203 
RTCP_FIR
:

204 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

207 
RTCP_NACK
:

208 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

209 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
	`va_¬g
(
­
, 
ušt32_t
)));

210 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
	`va_¬g
(
­
, 
ušt32_t
)));

213 
RTCP_RTPFB
:

214 
RTCP_PSFB
:

215 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

216 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
	`va_¬g
(
­
, 
ušt32_t
)));

217 
’ch
 = 
	`va_¬g
(
­
, 
¹ı_’code_h
 *);

218 
¬g
 = 
	`va_¬g
(
­
, *);

219 ià(
’ch
)

220 
”r
 |ğ
	`’ch
(
mb
, 
¬g
);

224  
EINVAL
;

226 ià(
”r
)

227  
”r
;

230 (
mb
->
’d
 - 
pos
) & 0x3)

231 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

232 ià(
”r
)

233  
”r
;

236 
mb
->
pos
 =…os;

237 
Ën
 = (
mb
->
’d
 - 
pos
 - 
RTCP_HDR_SIZE
)/(
ušt32_t
);

238 
”r
 = 
	`¹ı_hdr_’code
(
mb
, 
couÁ
, 
ty³
, 
Ën
);

239 ià(
”r
)

240  
”r
;

242 
mb
->
pos
 = mb->
’d
;

245 
	}
}

257 
	$¹ı_’code
(
mbuf
 *
mb
, 
¹ı_ty³
 
ty³
, 
ušt32_t
 
couÁ
, ...)

259 
va_li¡
 
­
;

260 
”r
;

262 
	`va_¡¬t
(
­
, 
couÁ
);

263 
”r
 = 
	`¹ı_v’code
(
mb
, 
ty³
, 
couÁ
, 
­
);

264 
	`va_’d
(
­
);

266  
”r
;

267 
	}
}

278 
	$¹ı_decode
(
¹ı_msg
 **
msgp
, 
mbuf
 *
mb
)

280 
¹ı_msg
 *
msg
 = 
NULL
;

281 
size_t
 
¡¬t
, 
i
, 
sz
, 
couÁ
, 
»m
;

282 
”r
;

284 ià(!
msgp
)

285  
EINVAL
;

286 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_HDR_SIZE
)

287  
EBADMSG
;

289 
msg
 = 
	`mem_z®loc
((*msg), 
¹ı_de¡ruùÜ
);

290 ià(!
msg
)

291  
ENOMEM
;

293 
¡¬t
 = 
mb
->
pos
;

296 
”r
 = 
	`¹ı_hdr_decode
(
mb
, &
msg
->
hdr
);

297 ià(
”r
)

298 
out
;

300 ià(
msg
->
hdr
.
v”siÚ
 !ğ
RTCP_VERSION
)

301 
badmsg
;

304 
»m
 = 
msg
->
hdr
.
Ëngth
 * (
ušt32_t
);

305 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
»m
)

306 
badmsg
;

308 
couÁ
 = 
msg
->
hdr
.count;

310 
msg
->
hdr
.
±
) {

312 
RTCP_SR
:

313 ià(
	`mbuf_g‘_Ëá
(
mb
è< (
RTCP_SRC_SIZE
 + 
RTCP_SR_SIZE
))

314 
badmsg
;

315 
msg
->
r
.
¤
.
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

316 
msg
->
r
.
¤
.
Áp_£c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

317 
msg
->
r
.
¤
.
Áp_äac
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

318 
msg
->
r
.
¤
.
¹p_ts
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

319 
msg
->
r
.
¤
.
p£Á
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

320 
msg
->
r
.
¤
.
o£Á
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

322 
”r
 = 
	`¹ı_¼_®loc
(&
msg
->
r
.
¤
.
¼v
, 
couÁ
);

323 ià(
”r
)

324 
out
;

325 
i
=0; i<
couÁ
 && !
”r
; i++)

326 
”r
 = 
	`¹ı_¼_decode
(
mb
, &
msg
->
r
.
¤
.
¼v
[
i
]);

329 
RTCP_RR
:

330 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_SRC_SIZE
)

331 
badmsg
;

332 
msg
->
r
.
¼
.
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

334 
”r
 = 
	`¹ı_¼_®loc
(&
msg
->
r
.
¼
.
¼v
, 
couÁ
);

335 ià(
”r
)

336 
out
;

337 
i
=0; i<
couÁ
 && !
”r
; i++)

338 
”r
 = 
	`¹ı_¼_decode
(
mb
, &
msg
->
r
.
¼
.
¼v
[
i
]);

341 
RTCP_SDES
:

342 ià(
couÁ
 == 0)

345 
sz
 = 
couÁ
 * (*
msg
->
r
.
sdesv
);

346 
msg
->
r
.
sdesv
 = 
	`mem_z®loc
(
sz
, 
NULL
);

347 ià(!
msg
->
r
.
sdesv
) {

348 
”r
 = 
ENOMEM
;

349 
out
;

352 
i
=0; i<
msg
->
hdr
.
couÁ
 && !
”r
; i++)

353 
”r
 = 
	`¹ı_sdes_decode
(
mb
, &
msg
->
r
.
sdesv
[
i
]);

356 
RTCP_BYE
:

357 
sz
 = 
couÁ
 * (*
msg
->
r
.
bye
.
¤cv
);

358 
msg
->
r
.
bye
.
¤cv
 = 
	`mem_®loc
(
sz
, 
NULL
);

359 ià(!
msg
->
r
.
bye
.
¤cv
) {

360 
”r
 = 
ENOMEM
;

361 
out
;

363 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
sz
)

364 
badmsg
;

365 
i
=0; i<
couÁ
; i++)

366 
msg
->
r
.
bye
.
¤cv
[
i
] = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

369 ià(
»m
 > 
couÁ
*(
ušt32_t
)) {

370 cÚ¡ 
size_t
 
Ën
 = 
	`mbuf_»ad_u8
(
mb
);

371 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ën
)

372 
badmsg
;

374 
”r
 = 
	`mbuf_¡rdup
(
mb
, &
msg
->
r
.
bye
.
»asÚ
, 
Ën
);

378 
RTCP_APP
:

379 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_APP_SIZE
)

380 
badmsg
;

381 
msg
->
r
.
­p
.
¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

382 ()
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)
msg
->
r
.
­p
.
Çme
,

383 (
msg
->
r
.
­p
.
Çme
));

384 ià(
»m
 > 
RTCP_APP_SIZE
) {

385 
msg
->
r
.
­p
.
d©a_Ën
 = 
»m
 - 
RTCP_APP_SIZE
;

386 
msg
->
r
.
­p
.
d©a
 = 
	`mem_®loc
(msg->r.­p.
d©a_Ën
, 
NULL
);

387 ià(!
msg
->
r
.
­p
.
d©a
) {

388 
”r
 = 
ENOMEM
;

389 
out
;

391 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
msg
->
r
.
­p
.
d©a_Ën
)

392 
badmsg
;

393 ()
	`mbuf_»ad_mem
(
mb
, 
msg
->
r
.
­p
.
d©a
,

394 
msg
->
r
.
­p
.
d©a_Ën
);

398 
RTCP_FIR
:

399 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_FIR_SIZE
)

400 
badmsg
;

401 
msg
->
r
.
fœ
.
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

404 
RTCP_NACK
:

405 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_NACK_SIZE
)

406 
badmsg
;

407 
msg
->
r
.
Çck
.
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

408 
msg
->
r
.
Çck
.
f¢
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

409 
msg
->
r
.
Çck
.
bÍ
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

412 
RTCP_RTPFB
:

413 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_FB_SIZE
)

414 
badmsg
;

416 ià(
msg
->
hdr
.
Ëngth
 < 2)

417 
badmsg
;

419 
msg
->
r
.
fb
.
s¤c_·ck‘
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

420 
msg
->
r
.
fb
.
s¤c_medŸ
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

421 
msg
->
r
.
fb
.
n
 = msg->
hdr
.
Ëngth
 - 2;

423 
”r
 = 
	`¹ı_¹pfb_decode
(
mb
, 
msg
);

426 
RTCP_PSFB
:

427 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_FB_SIZE
)

428 
badmsg
;

430 ià(
msg
->
hdr
.
Ëngth
 < 2)

431 
badmsg
;

433 
msg
->
r
.
fb
.
s¤c_·ck‘
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

434 
msg
->
r
.
fb
.
s¤c_medŸ
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

435 
msg
->
r
.
fb
.
n
 = msg->
hdr
.
Ëngth
 - 2;

437 
”r
 = 
	`¹ı_psfb_decode
(
mb
, 
msg
);

442 
	`mbuf_advªû
(
mb
, 
»m
);

445 ià(
”r
)

446 
out
;

449 (
mb
->
pos
 - 
¡¬t
è& 0x3 && 
	`mbuf_g‘_Ëá
(mb))

450 ++
mb
->
pos
;

452 
out
:

453 ià(
”r
)

454 
	`mem_d”ef
(
msg
);

456 *
msgp
 = 
msg
;

458  
”r
;

460 
badmsg
:

461 
	`mem_d”ef
(
msg
);

462  
EBADMSG
;

463 
	}
}

	@re-0.5.6/src/rtp/rr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_sys.h
>

14 
	~<»_Ãt.h
>

15 
	~<»_¹p.h
>

16 
	~"¹ı.h
"

19 
	$¹ı_¼_®loc
(
¹ı_¼
 **
¼p
, 
size_t
 
couÁ
)

21 
¹ı_¼
 *
¼
;

23 ià(!
¼p
)

24  
EINVAL
;

26 
¼
 = 
	`mem_®loc
(
couÁ
 * (*¼), 
NULL
);

27 ià(!
¼
)

28  
ENOMEM
;

30 *
¼p
 = 
¼
;

32 
	}
}

35 
	$¹ı_¼_’code
(
mbuf
 *
mb
, cÚ¡ 
¹ı_¼
 *
¼
)

37 
”r
;

39 ià(!
mb
 || !
¼
)

40  
EINVAL
;

42 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
s¤c
));

43 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
äaùiÚ
<<24 |

44 (
¼
->
lo¡
 & 0x00ffffff)));

45 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
Ï¡_£q
));

46 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
j™‹r
));

47 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
l¤
));

48 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¼
->
dl¤
));

50  
”r
;

51 
	}
}

54 
	$¹ı_¼_decode
(
mbuf
 *
mb
, 
¹ı_¼
 *
¼
)

56 
ušt32_t
 
w
;

58 ià(!
¼
)

59  
EINVAL
;

60 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_RR_SIZE
)

61  
EBADMSG
;

63 
¼
->
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

64 
w
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

65 
¼
->
äaùiÚ
 = 
w
>>24;„r->
lo¡
 = w & 0x00ffffffU;

66 
¼
->
Ï¡_£q
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

67 
¼
->
j™‹r
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

68 
¼
->
l¤
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

69 
¼
->
dl¤
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

72 
	}
}

	@re-0.5.6/src/rtp/rtcp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_¹p.h
>

14 
	~"¹ı.h
"

17 
	$¹ı_quick_£nd
(
¹p_sock
 *
rs
, 
¹ı_ty³
 
ty³
,

18 
ušt32_t
 
couÁ
, ...)

20 
mbuf
 *
mb
;

21 
va_li¡
 
­
;

22 
”r
;

24 
mb
 = 
	`mbuf_®loc
(32);

25 ià(!
mb
)

26  
ENOMEM
;

28 
mb
->
pos
 = 
RTCP_HEADROOM
;

30 
	`va_¡¬t
(
­
, 
couÁ
);

31 
”r
 = 
	`¹ı_v’code
(
mb
, 
ty³
, 
couÁ
, 
­
);

32 
	`va_’d
(
­
);

34 
mb
->
pos
 = 
RTCP_HEADROOM
;

36 ià(!
”r
)

37 
”r
 = 
	`¹ı_£nd
(
rs
, 
mb
);

39 
	`mem_d”ef
(
mb
);

41  
”r
;

42 
	}
}

55 
	$¹ı_£nd_­p
(
¹p_sock
 *
rs
, cÚ¡ 
Çme
[4],

56 cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
Ën
)

58  
	`¹ı_quick_£nd
(
rs
, 
RTCP_APP
, 0, 
	`¹p_£ss_s¤c
(rs),

59 
Çme
, 
d©a
, 
Ën
);

60 
	}
}

71 
	$¹ı_£nd_fœ
(
¹p_sock
 *
rs
, 
ušt32_t
 
s¤c
)

73  
	`¹ı_quick_£nd
(
rs
, 
RTCP_FIR
, 0, 
s¤c
);

74 
	}
}

86 
	$¹ı_£nd_Çck
(
¹p_sock
 *
rs
, 
ušt16_t
 
f¢
, ušt16_ˆ
bÍ
)

88  
	`¹ı_quick_£nd
(
rs
, 
RTCP_NACK
, 0, 
	`¹p_£ss_s¤c
Ôs), 
f¢
, 
bÍ
);

89 
	}
}

100 
	$¹ı_£nd_¶i
(
¹p_sock
 *
rs
, 
ušt32_t
 
fb_s¤c
)

102  
	`¹ı_quick_£nd
(
rs
, 
RTCP_PSFB
, 
RTCP_PSFB_PLI
,

103 
	`¹p_£ss_s¤c
(
rs
), 
fb_s¤c
, 
NULL
, NULL);

104 
	}
}

107 cÚ¡ *
	$¹ı_ty³_Çme
(
¹ı_ty³
 
ty³
)

109 
ty³
) {

111 
RTCP_FIR
:  "FIR";

112 
RTCP_NACK
:  "NACK";

113 
RTCP_SR
:  "SR";

114 
RTCP_RR
:  "RR";

115 
RTCP_SDES
:  "SDES";

116 
RTCP_BYE
:  "BYE";

117 
RTCP_APP
:  "APP";

118 
RTCP_RTPFB
:  "RTPFB";

119 
RTCP_PSFB
:  "PSFB";

120 
RTCP_XR
:  "XR";

121 
RTCP_AVB
:  "AVB";

124 
	}
}

127 cÚ¡ *
	$¹ı_sdes_Çme
(
¹ı_sdes_ty³
 
sdes
)

129 
sdes
) {

131 
RTCP_SDES_END
:  "END";

132 
RTCP_SDES_CNAME
:  "CNAME";

133 
RTCP_SDES_NAME
:  "NAME";

134 
RTCP_SDES_EMAIL
:  "EMAIL";

135 
RTCP_SDES_PHONE
:  "PHONE";

136 
RTCP_SDES_LOC
:  "LOC";

137 
RTCP_SDES_TOOL
:  "TOOL";

138 
RTCP_SDES_NOTE
:  "NOTE";

139 
RTCP_SDES_PRIV
:  "PRIV";

142 
	}
}

153 
	$¹ı_msg_´št
(
»_´štf
 *
pf
, cÚ¡ 
¹ı_msg
 *
msg
)

155 
size_t
 
i
, 
j
;

156 
”r
;

158 ià(!
msg
)

161 
”r
 = 
	`»_h´štf
(
pf
, "%8s…ad=%d count=%-2d…t=%-3d†en=%u ",

162 
	`¹ı_ty³_Çme
((
¹ı_ty³
)
msg
->
hdr
.
±
),

163 
msg
->
hdr
.
p
,

164 
msg
->
hdr
.
couÁ
, msg->hdr.
±
, msg->hdr.
Ëngth
);

165 ià(
”r
)

166  
”r
;

168 
msg
->
hdr
.
±
) {

170 
RTCP_SR
:

171 
”r
 = 
	`»_h´štf
(
pf
, "%08x %u %u %u %u %u",

172 
msg
->
r
.
¤
.
s¤c
,

173 
msg
->
r
.
¤
.
Áp_£c
,

174 
msg
->
r
.
¤
.
Áp_äac
,

175 
msg
->
r
.
¤
.
¹p_ts
,

176 
msg
->
r
.
¤
.
p£Á
,

177 
msg
->
r
.
¤
.
o£Á
);

178 
i
=0; i<
msg
->
hdr
.
couÁ
 && !
”r
; i++) {

179 cÚ¡ 
¹ı_¼
 *
¼
 = &
msg
->
r
.
¤
.
¼v
[
i
];

180 
”r
 = 
	`»_h´štf
(
pf
, " {%08x %u %d %u %u %u %u}",

181 
¼
->
s¤c
,„r->
äaùiÚ
,„r->
lo¡
,

182 
¼
->
Ï¡_£q
,„r->
j™‹r
,

183 
¼
->
l¤
,„r->
dl¤
);

187 
RTCP_RR
:

188 
”r
 = 
	`»_h´štf
(
pf
, "%08x", 
msg
->
r
.
¼
.
s¤c
);

189 
i
=0; i<
msg
->
hdr
.
couÁ
 && !
”r
; i++) {

190 cÚ¡ 
¹ı_¼
 *
¼
 = &
msg
->
r
.¼.
¼v
[
i
];

191 
”r
 = 
	`»_h´štf
(
pf
, " {0x%08x %u %d %u %u %u %u}",

192 
¼
->
s¤c
,„r->
äaùiÚ
,„r->
lo¡
,

193 
¼
->
Ï¡_£q
,„r->
j™‹r
,

194 
¼
->
l¤
,„r->
dl¤
);

198 
RTCP_SDES
:

199 
i
=0; i<
msg
->
hdr
.
couÁ
; i++) {

200 cÚ¡ 
¹ı_sdes
 *
sdes
 = &
msg
->
r
.
sdesv
[
i
];

202 
”r
 = 
	`»_h´štf
(
pf
, " {0x%08x‚=%u",

203 
sdes
->
¤c
, sdes->
n
);

204 
j
=0; j<
sdes
->
n
 && !
”r
; j++) {

205 cÚ¡ 
¹ı_sdes_™em
 *
™em
;

206 
™em
 = &
sdes
->
™emv
[
j
];

207 
”r
 = 
	`»_h´štf
(
pf
, " <%s:%b>",

208 
	`¹ı_sdes_Çme
(
™em
->
ty³
),

209 
™em
->
d©a
,

210 (
size_t
)
™em
->
Ëngth
);

212 
”r
 |ğ
	`»_h´štf
(
pf
, "}");

216 
RTCP_BYE
:

217 
”r
 = 
	`»_h´štf
(
pf
, "%u srcs:", 
msg
->
hdr
.
couÁ
);

218 
i
=0; i<
msg
->
hdr
.
couÁ
 && !
”r
; i++) {

219 
”r
 = 
	`»_h´štf
(
pf
, " %08x",

220 
msg
->
r
.
bye
.
¤cv
[
i
]);

222 
”r
 |ğ
	`»_h´štf
(
pf
, " '%s'", 
msg
->
r
.
bye
.
»asÚ
);

225 
RTCP_APP
:

226 
”r
 = 
	`»_h´štf
(
pf
, "src=%08x '%b' data=%zu",

227 
msg
->
r
.
­p
.
¤c
,

228 
msg
->
r
.
­p
.
Çme
, (msg->r.app.name),

229 
msg
->
r
.
­p
.
d©a_Ën
);

232 
RTCP_FIR
:

233 
”r
 = 
	`»_h´štf
(
pf
, "s¤c=%08x", 
msg
->
r
.
fœ
.
s¤c
);

236 
RTCP_NACK
:

237 
”r
 = 
	`»_h´štf
(
pf
, "ssrc=%08x fsn=%04x blp=%04x",

238 
msg
->
r
.
Çck
.
s¤c
, msg->r.Çck.
f¢
,

239 
msg
->
r
.
Çck
.
bÍ
);

242 
RTCP_RTPFB
:

243 
”r
 = 
	`»_h´štf
(
pf
, "pkt=%08x med=%08x‚=%u",

244 
msg
->
r
.
fb
.
s¤c_·ck‘
,

245 
msg
->
r
.
fb
.
s¤c_medŸ
,

246 
msg
->
r
.
fb
.
n
);

247 ià(
msg
->
hdr
.
couÁ
 =ğ
RTCP_RTPFB_GNACK
) {

248 
”r
 |ğ
	`»_h´štf
(
pf
, " GNACK");

249 
i
=0; i<
msg
->
r
.
fb
.
n
; i++) {

250 
”r
 |ğ
	`»_h´štf
(
pf
, " {%04x %04x}",

251 
msg
->
r
.
fb
.
fci
.
gÇckv
[
i
].
pid
,

252 
msg
->
r
.
fb
.
fci
.
gÇckv
[
i
].
bÍ
);

257 
RTCP_PSFB
:

258 
”r
 = 
	`»_h´štf
(
pf
, "pkt=%08x med=%08x‚=%u",

259 
msg
->
r
.
fb
.
s¤c_·ck‘
,

260 
msg
->
r
.
fb
.
s¤c_medŸ
,

261 
msg
->
r
.
fb
.
n
);

262 ià(
msg
->
hdr
.
couÁ
 =ğ
RTCP_PSFB_SLI
) {

263 
”r
 |ğ
	`»_h´štf
(
pf
, " SLI");

264 
i
=0; i<
msg
->
r
.
fb
.
n
; i++) {

265 
”r
 |ğ
	`»_h´štf
(
pf
, " {%04x %04x %02x}",

266 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
fœ¡
,

267 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
numb”
,

268 
msg
->
r
.
fb
.
fci
.
¦iv
[
i
].
picid
);

271 ià(
msg
->
hdr
.
couÁ
 =ğ
RTCP_PSFB_AFB
) {

272 
”r
 |ğ
	`»_h´štf
(
pf
, " AFB %u bytes",

273 
msg
->
r
.
fb
.
n
 * 4);

278 
”r
 = 
	`»_h´štf
(
pf
, "<Ën=%u>", 
msg
->
hdr
.
Ëngth
);

282 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

284  
”r
;

285 
	}
}

	@re-0.5.6/src/rtp/rtcp.h

10 
	mRTCP_HDR_SIZE
 = 4,

11 
	mRTCP_SRC_SIZE
 = 4,

12 
	mRTCP_SR_SIZE
 = 20,

13 
	mRTCP_RR_SIZE
 = 24,

14 
	mRTCP_APP_SIZE
 = 8,

15 
	mRTCP_FIR_SIZE
 = 4,

16 
	mRTCP_NACK_SIZE
 = 8,

17 
	mRTCP_FB_SIZE
 = 8,

18 
	mRTCP_MAX_SDES
 = 255,

19 
	mRTCP_HEADROOM
 = 4,

23 
	sÁp_time
 {

24 
ušt32_t
 
	mhi
;

25 
ušt32_t
 
	mlo
;

28 
	ghash
;

31 
	s¹p_sourû
 {

32 
§
 
	m¹p_³”
;

33 
ušt16_t
 
	mmax_£q
;

34 
ušt32_t
 
	mcyşes
;

35 
ušt32_t
 
	mba£_£q
;

36 
ušt32_t
 
	mbad_£q
;

37 
ušt32_t
 
	m´ob©iÚ
;

38 
ušt32_t
 
	m»ûived
;

39 
ušt32_t
 
	mex³ùed_´iÜ
;

40 
ušt32_t
 
	m»ûived_´iÜ
;

41 
	mŒªs™
;

42 
ušt32_t
 
	mj™‹r
;

43 
size_t
 
	m¹p_rx_by‹s
;

44 
ušt64_t
 
	m¤_»cv
;

45 
Áp_time
 
	mÏ¡_¤
;

46 
ušt32_t
 
	m¹p_ts
;

47 
ušt32_t
 
	mp£Á
;

48 
ušt32_t
 
	mo£Á
;

52 
	s¹p_memb”
 {

53 
Ë
 
	mË
;

54 
¹p_sourû
 *
	ms
;

55 
ušt32_t
 
	m¤c
;

56 
	mcum_lo¡
;

57 
ušt32_t
 
	mj™
;

58 
ušt32_t
 
	m¹t
;

63 
¹p_memb”
 *
memb”_add
(
hash
 *
ht
, 
ušt32_t
 
¤c
);

64 
¹p_memb”
 *
memb”_fšd
(
hash
 *
ht
, 
ušt32_t
 
¤c
);

67 
sourû_š™_£q
(
¹p_sourû
 *
s
, 
ušt16_t
 
£q
);

68 
sourû_upd©e_£q
(
¹p_sourû
 *
s
, 
ušt16_t
 
£q
);

69 
sourû_ÿlc_j™‹r
(
¹p_sourû
 *
s
, 
ušt32_t
 
¹p_ts
,

70 
ušt32_t
 
¬riv®
);

71 
sourû_ÿlc_lo¡
(cÚ¡ 
¹p_sourû
 *
s
);

72 
ušt8_t
 
sourû_ÿlc_äaùiÚ_lo¡
(
¹p_sourû
 *
s
);

75 
¹ı_¼_®loc
(
¹ı_¼
 **
¼p
, 
size_t
 
couÁ
);

76 
¹ı_¼_’code
(
mbuf
 *
mb
, cÚ¡ 
¹ı_¼
 *
¼
);

77 
¹ı_¼_decode
(
mbuf
 *
mb
, 
¹ı_¼
 *
¼
);

80 
¹ı_sdes_decode
(
mbuf
 *
mb
, 
¹ı_sdes
 *
sdes
);

83 
¹ı_¹pfb_gÇck_’code
(
mbuf
 *
mb
, 
ušt16_t
 
pid
, ušt16_ˆ
bÍ
);

84 
¹ı_psfb_¦i_’code
(
mbuf
 *
mb
, 
ušt16_t
 
fœ¡
, ušt16_ˆ
numb”
,

85 
ušt8_t
 
picid
);

86 
¹ı_¹pfb_decode
(
mbuf
 *
mb
, 
¹ı_msg
 *
msg
);

87 
¹ı_psfb_decode
(
mbuf
 *
mb
, 
¹ı_msg
 *
msg
);

90 
	gtimev®
;

91 
unix2Áp
(
Áp_time
 *
Áp
, cÚ¡ 
timev®
 *
tv
);

92 
Áp2unix
(
timev®
 *
tv
, cÚ¡ 
Áp_time
 *
Áp
);

93 
Áp_time_g‘
(
Áp_time
 *
Áp
);

94 
ušt32_t
 
Áp_com·ù
(cÚ¡ 
Áp_time
 *
Áp
);

95 
ušt64_t
 
Áp_com·ù2us
(
ušt32_t
 
Ápc
);

98 
¹ı_£ss
 *
¹p_¹ı_£ss
(cÚ¡ 
¹p_sock
 *
rs
);

101 (
	t¹ı_’code_h
)(
	tmbuf
 *
	tmb
, *
	t¬g
);

103 
	`¹ı_hdr_’code
(
mbuf
 *
mb
, 
ušt8_t
 
couÁ
, 
¹ı_ty³
 
ty³
,

104 
ušt16_t
 
Ëngth
);

105 
	`¹ı_hdr_decode
(
mbuf
 *
mb
, 
¹ı_hdr
 *
hdr
);

106 
	`¹ı_v’code
(
mbuf
 *
mb
, 
¹ı_ty³
 
ty³
, 
ušt32_t
 
couÁ
,

107 
va_li¡
 
­
);

110 
¹ı_£ss
;

112 
	`¹ı_£ss_®loc
(
¹ı_£ss
 **
£s¥
, 
¹p_sock
 *
rs
);

113 
	`¹ı_’abË
(
¹ı_£ss
 *
£ss
, 
boŞ
 
’abËd
, cÚ¡ *
úame
);

114 
	`¹ı_£nd
(
¹p_sock
 *
rs
, 
mbuf
 *
mb
);

115 
	`¹ı_hªdËr
(
¹ı_£ss
 *
£ss
, 
¹ı_msg
 *
msg
);

116 
	`¹ı_£ss_tx_¹p
(
¹ı_£ss
 *
£ss
, 
ušt32_t
 
ts
,

117 
size_t
 
·ylßd_size
);

118 
	`¹ı_£ss_rx_¹p
(
¹ı_£ss
 *
£ss
, 
ušt16_t
 
£q
, 
ušt32_t
 
ts
,

119 
ušt32_t
 
¤c
, 
size_t
 
·ylßd_size
,

120 cÚ¡ 
§
 *
³”
);

	@re-0.5.6/src/rtp/rtp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_sys.h
>

14 
	~<»_Ãt.h
>

15 
	~<»_udp.h
>

16 
	~<»_¹p.h
>

17 
	~"¹ı.h
"

20 
	#DEBUG_MODULE
 "¹p"

	)

21 
	#DEBUG_LEVEL
 5

	)

22 
	~<»_dbg.h
>

26 
	s¹p_sock
 {

29 
ušt16_t
 
	m£q
;

30 
ušt32_t
 
	ms¤c
;

31 } 
	m’c
;

32 
	m´Ùo
;

33 *
	msock_¹p
;

34 *
	msock_¹ı
;

35 
§
 
	mloÿl
;

36 
§
 
	m¹ı_³”
;

37 
¹p_»cv_h
 *
	m»cvh
;

38 
¹ı_»cv_h
 *
	m¹ıh
;

39 *
	m¬g
;

40 
¹ı_£ss
 *
	m¹ı
;

41 
boŞ
 
	m¹ı_mux
;

53 
	$¹p_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
¹p_h—d”
 *
hdr
)

55 
ušt8_t
 
buf
[2];

56 
”r
, 
i
;

58 ià(!
mb
 || !
hdr
)

59  
EINVAL
;

61 
buf
[0] = (
hdr
->
v”
 & 0x02) << 6;

62 
buf
[0] |ğ(
hdr
->
·d
 & 0x01) << 5;

63 
buf
[0] |ğ(
hdr
->
ext
 & 0x01) << 4;

64 
buf
[0] |ğ(
hdr
->
cc
 & 0x0f) << 0;

65 
buf
[1] = (
hdr
->
m
 & 0x01) << 7;

66 
buf
[1] |ğ(
hdr
->
±
 & 0x7f) << 0;

68 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, 
buf
, (buf));

69 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
£q
));

70 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
hdr
->
ts
));

71 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
hdr
->
s¤c
));

73 
i
=0; i<
hdr
->
cc
; i++) {

74 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
hdr
->
c¤c
[
i
]));

77  
”r
;

78 
	}
}

89 
	$¹p_hdr_decode
(
¹p_h—d”
 *
hdr
, 
mbuf
 *
mb
)

91 
ušt8_t
 
buf
[2];

92 
”r
, 
i
;

93 
size_t
 
h—d”_Ën
;

95 ià(!
hdr
 || !
mb
)

96  
EINVAL
;

98 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTP_HEADER_SIZE
)

99  
EBADMSG
;

101 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
buf
, (buf));

102 ià(
”r
)

103  
”r
;

105 
hdr
->
v”
 = (
buf
[0] >> 6) & 0x03;

106 
hdr
->
·d
 = (
buf
[0] >> 5) & 0x01;

107 
hdr
->
ext
 = (
buf
[0] >> 4) & 0x01;

108 
hdr
->
cc
 = (
buf
[0] >> 0) & 0x0f;

109 
hdr
->
m
 = (
buf
[1] >> 7) & 0x01;

110 
hdr
->
±
 = (
buf
[1] >> 0) & 0x7f;

112 
hdr
->
£q
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

113 
hdr
->
ts
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

114 
hdr
->
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

116 
h—d”_Ën
 = 
hdr
->
cc
*(
ušt32_t
);

117 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
h—d”_Ën
)

118  
EBADMSG
;

120 
i
=0; i<
hdr
->
cc
; i++) {

121 
hdr
->
c¤c
[
i
] = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

124 ià(
hdr
->
ext
) {

125 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

126  
EBADMSG
;

128 
hdr
->
x
.
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

129 
hdr
->
x
.
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

131 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
hdr
->
x
.
Ën
*(
ušt32_t
))

132  
EBADMSG
;

134 
mb
->
pos
 +ğ
hdr
->
x
.
Ën
*(
ušt32_t
);

138 
	}
}

141 
	$de¡ruùÜ
(*
d©a
)

143 
¹p_sock
 *
rs
 = 
d©a
;

145 
rs
->
´Ùo
) {

147 
IPPROTO_UDP
:

148 
	`udp_hªdËr_£t
(
rs
->
sock_¹p
, 
NULL
, NULL);

149 
	`udp_hªdËr_£t
(
rs
->
sock_¹ı
, 
NULL
, NULL);

157 
	`mem_d”ef
(
rs
->
¹ı
);

159 
	`mem_d”ef
(
rs
->
sock_¹p
);

160 
	`mem_d”ef
(
rs
->
sock_¹ı
);

161 
	}
}

164 
	$¹ı_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

166 
¹p_sock
 *
rs
 = 
¬g
;

167 
¹ı_msg
 *
msg
;

169 0 =ğ
	`¹ı_decode
(&
msg
, 
mb
)) {

172 
	`¹ı_hªdËr
(
rs
->
¹ı
, 
msg
);

175 ià(
rs
->
¹ıh
)

176 
rs
->
	`¹ıh
(
¤c
, 
msg
,„s->
¬g
);

178 
	`mem_d”ef
(
msg
);

180 
	}
}

183 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

185 
¹p_sock
 *
rs
 = 
¬g
;

186 
¹p_h—d”
 
hdr
;

187 
”r
;

190 ià(
rs
->
¹ı_mux
) {

191 
ušt8_t
 
±
;

193 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

196 
±
 = 
	`mbuf_buf
(
mb
)[1] & 0x7f;

198 ià(64 <ğ
±
 &&…t <= 95) {

199 
	`¹ı_»cv_hªdËr
(
¤c
, 
mb
, 
¬g
);

204 
”r
 = 
	`¹p_decode
(
rs
, 
mb
, &
hdr
);

205 ià(
”r
)

208 ià(
rs
->
¹ı
) {

209 
	`¹ı_£ss_rx_¹p
(
rs
->
¹ı
, 
hdr
.
£q
, hdr.
ts
,

210 
hdr
.
s¤c
, 
	`mbuf_g‘_Ëá
(
mb
), 
¤c
);

213 ià(
rs
->
»cvh
)

214 
rs
->
	`»cvh
(
¤c
, &
hdr
, 
mb
,„s->
¬g
);

215 
	}
}

218 
	$udp_¿nge_li¡’
(
¹p_sock
 *
rs
, cÚ¡ 
§
 *

,

219 
ušt16_t
 
mš_pÜt
, ušt16_ˆ
max_pÜt
)

221 
§
 
¹ı
;

222 
Œ›s
 = 64;

223 
”r
 = 0;

225 
rs
->
loÿl
 = 
¹ı
 = *

;

228 
Œ›s
--) {

229 
udp_sock
 *
us_¹p
, *
us_¹ı
;

230 
ušt16_t
 
pÜt
;

232 
pÜt
 = (
mš_pÜt
 + (
	`¿nd_u16
(è% (
max_pÜt
 - min_port)));

233 
pÜt
 &= 0xfffe;

235 
	`§_£t_pÜt
(&
rs
->
loÿl
, 
pÜt
);

236 
”r
 = 
	`udp_li¡’
(&
us_¹p
, &
rs
->
loÿl
, 
udp_»cv_hªdËr
,„s);

237 ià(
”r
)

240 
	`§_£t_pÜt
(&
¹ı
, 
pÜt
 + 1);

241 
”r
 = 
	`udp_li¡’
(&
us_¹ı
, &
¹ı
, 
¹ı_»cv_hªdËr
, 
rs
);

242 ià(
”r
) {

243 
	`mem_d”ef
(
us_¹p
);

248 
rs
->
sock_¹p
 = 
us_¹p
;

249 
rs
->
sock_¹ı
 = 
us_¹ı
;

253  
”r
;

254 
	}
}

264 
	$¹p_®loc
(
¹p_sock
 **
r¥
)

266 
¹p_sock
 *
rs
;

268 ià(!
r¥
)

269  
EINVAL
;

271 
rs
 = 
	`mem_z®loc
((*rs), 
de¡ruùÜ
);

272 ià(!
rs
)

273  
ENOMEM
;

275 
	`§_š™
(&
rs
->
¹ı_³”
, 
AF_UNSPEC
);

277 
rs
->
’c
.
£q
 = 
	`¿nd_u16
() & 0x7fff;

278 
rs
->
’c
.
s¤c
 = 
	`¿nd_u32
();

280 *
r¥
 = 
rs
;

283 
	}
}

301 
	$¹p_li¡’
(
¹p_sock
 **
r¥
, 
´Ùo
, cÚ¡ 
§
 *

,

302 
ušt16_t
 
mš_pÜt
, ušt16_ˆ
max_pÜt
, 
boŞ
 
’abË_¹ı
,

303 
¹p_»cv_h
 *
»cvh
, 
¹ı_»cv_h
 *
¹ıh
, *
¬g
)

305 
¹p_sock
 *
rs
;

306 
”r
;

308 ià(!

 || 
mš_pÜt
 >ğ
max_pÜt
 || !
»cvh
)

309  
EINVAL
;

311 
”r
 = 
	`¹p_®loc
(&
rs
);

312 ià(
”r
)

313  
”r
;

315 
rs
->
´Ùo
 =…roto;

316 
rs
->
»cvh
 =„ecvh;

317 
rs
->
¹ıh
 =„tcph;

318 
rs
->
¬g
 =‡rg;

321 ià(
’abË_¹ı
) {

322 
”r
 = 
	`¹ı_£ss_®loc
(&
rs
->
¹ı
,„s);

323 ià(
”r
)

324 
out
;

327 
´Ùo
) {

329 
IPPROTO_UDP
:

330 
”r
 = 
	`udp_¿nge_li¡’
(
rs
, 

, 
mš_pÜt
, 
max_pÜt
);

334 
”r
 = 
EPROTONOSUPPORT
;

338 
out
:

339 ià(
”r
)

340 
	`mem_d”ef
(
rs
);

342 *
r¥
 = 
rs
;

344  
”r
;

345 
	}
}

362 
	$¹p_’code
(
¹p_sock
 *
rs
, 
boŞ
 
ext
, boŞ 
m¬k”
, 
ušt8_t
 
±
,

363 
ušt32_t
 
ts
, 
mbuf
 *
mb
)

365 
¹p_h—d”
 
hdr
;

367 ià(!
rs
 || 
±
&~0x7à|| !
mb
)

368  
EINVAL
;

370 
hdr
.
v”
 = 
RTP_VERSION
;

371 
hdr
.
·d
 = 
çl£
;

372 
hdr
.
ext
 =ƒxt;

373 
hdr
.
cc
 = 0;

374 
hdr
.
m
 = 
m¬k”
 ? 1 : 0;

375 
hdr
.
±
 =…t;

376 
hdr
.
£q
 = 
rs
->
’c
.seq++;

377 
hdr
.
ts
 =s;

378 
hdr
.
s¤c
 = 
rs
->
’c
.ssrc;

380  
	`¹p_hdr_’code
(
mb
, &
hdr
);

381 
	}
}

393 
	$¹p_decode
(
¹p_sock
 *
rs
, 
mbuf
 *
mb
,

394 
¹p_h—d”
 *
hdr
)

396 
”r
;

398 ià(!
rs
 || !
mb
 || !
hdr
)

399  
EINVAL
;

401 
	`mem£t
(
hdr
, 0, (*hdr));

402 
”r
 = 
	`¹p_hdr_decode
(
hdr
, 
mb
);

403 ià(
”r
)

404  
”r
;

406 ià(
RTP_VERSION
 !ğ
hdr
->
v”
)

407  
EBADMSG
;

410 
	}
}

426 
	$¹p_£nd
(
¹p_sock
 *
rs
, cÚ¡ 
§
 *
d¡
, 
boŞ
 
ext
,

427 
boŞ
 
m¬k”
, 
ušt8_t
 
±
, 
ušt32_t
 
ts
, 
mbuf
 *
mb
)

429 
size_t
 
pos
;

430 
”r
;

432 ià(!
rs
 || !
mb
)

433  
EINVAL
;

435 ià(
mb
->
pos
 < 
RTP_HEADER_SIZE
) {

436 
	`DEBUG_WARNING
("rtp_send: buffer must have space for"

438 
mb
->
pos
, mb->
’d
);

439  
EBADMSG
;

442 
	`mbuf_advªû
(
mb
, -
RTP_HEADER_SIZE
);

444 
pos
 = 
mb
->pos;

446 
”r
 = 
	`¹p_’code
(
rs
, 
ext
, 
m¬k”
, 
±
, 
ts
, 
mb
);

447 ià(
”r
)

448  
”r
;

450 ià(
rs
->
¹ı
)

451 
	`¹ı_£ss_tx_¹p
(
rs
->
¹ı
, 
ts
, 
	`mbuf_g‘_Ëá
(
mb
));

453 
mb
->
pos
 =…os;

455  
	`udp_£nd
(
rs
->
sock_¹p
, 
d¡
, 
mb
);

456 
	}
}

466 *
	$¹p_sock
(cÚ¡ 
¹p_sock
 *
rs
)

468  
rs
 ?„s->
sock_¹p
 : 
NULL
;

469 
	}
}

479 *
	$¹ı_sock
(cÚ¡ 
¹p_sock
 *
rs
)

481  
rs
 ?„s->
sock_¹ı
 : 
NULL
;

482 
	}
}

492 cÚ¡ 
§
 *
	$¹p_loÿl
(cÚ¡ 
¹p_sock
 *
rs
)

494  
rs
 ? &rs->
loÿl
 : 
NULL
;

495 
	}
}

505 
ušt32_t
 
	$¹p_£ss_s¤c
(cÚ¡ 
¹p_sock
 *
rs
)

507  
rs
 ?„s->
’c
.
s¤c
 : 0;

508 
	}
}

518 
¹ı_£ss
 *
	$¹p_¹ı_£ss
(cÚ¡ 
¹p_sock
 *
rs
)

520  
rs
 ?„s->
¹ı
 : 
NULL
;

521 
	}
}

531 
	$¹ı_¡¬t
(
¹p_sock
 *
rs
, cÚ¡ *
úame
,

532 cÚ¡ 
§
 *
³”
)

534 ià(!
rs
)

537 ià(
³”
)

538 
rs
->
¹ı_³”
 = *
³”
;

540 ()
	`¹ı_’abË
(
rs
->
¹ı
, 
³”
 !ğ
NULL
, 
úame
);

541 
	}
}

550 
	$¹ı_’abË_mux
(
¹p_sock
 *
rs
, 
boŞ
 
’abËd
)

552 ià(!
rs
)

555 
rs
->
¹ı_mux
 = 
’abËd
;

556 
	}
}

567 
	$¹ı_£nd
(
¹p_sock
 *
rs
, 
mbuf
 *
mb
)

569 ià(!
rs
 || !rs->
sock_¹ı
 || !
	`§_is£t
(&rs->
¹ı_³”
, 
SA_ALL
))

570  
EINVAL
;

572  
	`udp_£nd
(
rs
->
¹ı_mux
 ?„s->
sock_¹p
 :„s->
sock_¹ı
,

573 &
rs
->
¹ı_³”
, 
mb
);

574 
	}
}

585 
	$¹p_debug
(
»_´štf
 *
pf
, cÚ¡ 
¹p_sock
 *
rs
)

587 
”r
;

589 ià(!
rs
 || !
pf
)

590  
EINVAL
;

592 
”r
 = 
	`»_h´štf
(
pf
, "RTP debug:\n");

593 
”r
 |ğ
	`»_h´štf
(
pf
, " Encode: seq=%u ssrc=0x%lx\n",

594 
rs
->
’c
.
£q
,„s->’c.
s¤c
);

596 ià(
rs
->
¹ı
)

597 
”r
 |ğ
	`¹ı_debug
(
pf
, 
rs
);

599  
”r
;

600 
	}
}

	@re-0.5.6/src/rtp/sdes.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_¹p.h
>

14 
	~"¹ı.h
"

17 
	#DEBUG_MODULE
 "¹ı_sdes"

	)

18 
	#DEBUG_LEVEL
 5

	)

19 
	~<»_dbg.h
>

23 
	mRTCP_SDES_MIN_SIZE
 = 1,

36 
	$¹ı_sdes_’code
(
mbuf
 *
mb
, 
ušt32_t
 
¤c
, ušt32_ˆ
™emc
, ...)

38 
va_li¡
 
­
;

39 
size_t
 
¡¬t
;

40 
”r
 = 0;

42 ià(!
mb
 || !
™emc
)

43  
EINVAL
;

45 
	`va_¡¬t
(
­
, 
™emc
);

47 
¡¬t
 = 
mb
->
pos
;

48 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¤c
));

51 
™emc
-- && !
”r
) {

52 cÚ¡ 
ušt8_t
 
ty³
 = 
	`va_¬g
(
­
, );

53 cÚ¡ *
v
 = 
	`va_¬g
(
­
, const *);

54 
size_t
 
Ën
;

55 ià(!
v
)

58 
Ën
 = 
	`¡¾’
(
v
);

59 ià(
Ën
 > 255) {

60 
”r
 = 
EINVAL
;

61 
out
;

64 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
ty³
);

65 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
Ën
 & 0xff);

66 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, (
ušt8_t
 *)
v
, 
Ën
);

70 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
RTCP_SDES_END
);

71 (
mb
->
pos
 - 
¡¬t
) & 0x3)

72 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
RTCP_SDES_END
);

74 
out
:

75 
	`va_’d
(
­
);

77  
”r
;

78 
	}
}

89 
	$¹ı_sdes_decode
(
mbuf
 *
mb
, 
¹ı_sdes
 *
sdes
)

91 
size_t
 
¡¬t
;

93 ià(!
sdes
)

94  
EINVAL
;

95 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
RTCP_SRC_SIZE
)

96  
EBADMSG
;

98 
¡¬t
 = 
mb
->
pos
;

99 
sdes
->
¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

102 
	`mbuf_g‘_Ëá
(
mb
è>ğ
RTCP_SDES_MIN_SIZE
) {

103 
ušt8_t
 
ty³
;

104 
¹ı_sdes_™em
 *
™em
;

106 
ty³
 = 
	`mbuf_»ad_u8
(
mb
);

107 ià(
ty³
 =ğ
RTCP_SDES_END
)

110 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

111  
EBADMSG
;

113 ià(!
sdes
->
™emv
) {

114 
sdes
->
™emv
 = 
	`mem_®loc
((*sdes->™emv), 
NULL
);

115 ià(!
sdes
->
™emv
)

116  
ENOMEM
;

119 cÚ¡ 
size_t
 
sz
 = (
sdes
->
n
 + 1è* (*sdes->
™emv
);

120 
¹ı_sdes_™em
 *
™emv
;

122 
™emv
 = 
	`mem_»®loc
(
sdes
->™emv, 
sz
);

123 ià(!
™emv
)

124  
ENOMEM
;

126 
sdes
->
™emv
 = itemv;

129 
™em
 = &
sdes
->
™emv
[sdes->
n
];

131 
™em
->
ty³
 = (
¹ı_sdes_ty³
)type;

132 
™em
->
Ëngth
 = 
	`mbuf_»ad_u8
(
mb
);

133 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
™em
->
Ëngth
)

134  
EBADMSG
;

135 
™em
->
d©a
 = 
	`mem_®loc
(™em->
Ëngth
, 
NULL
);

136 ià(!
™em
->
d©a
)

137  
ENOMEM
;

138 ()
	`mbuf_»ad_mem
(
mb
, (
ušt8_t
 *)
™em
->
d©a
, i‹m->
Ëngth
);

140 
sdes
->
n
++;

144 (
mb
->
pos
 - 
¡¬t
è& 0x3 && 
	`mbuf_g‘_Ëá
(mb))

145 ++
mb
->
pos
;

148 
	}
}

	@re-0.5.6/src/rtp/sess.c

6 #ifdeà
HAVE_SYS_TIME_H


7 
	~<sys/time.h
>

9 
	~<time.h
>

10 #ifdeà
WIN32


11 
	~<wšsock2.h
>

13 
	~<¡ršg.h
>

14 
	~<»_ty³s.h
>

15 
	~<»_fmt.h
>

16 
	~<»_mem.h
>

17 
	~<»_mbuf.h
>

18 
	~<»_li¡.h
>

19 
	~<»_hash.h
>

20 
	~<»_tmr.h
>

21 
	~<»_§.h
>

22 
	~<»_lock.h
>

23 
	~<»_¹p.h
>

24 
	~"¹ı.h
"

27 
	#DEBUG_MODULE
 "¹ı_£ss"

	)

28 
	#DEBUG_LEVEL
 5

	)

29 
	~<»_dbg.h
>

34 
	mRTCP_INTERVAL
 = 5000,

35 
	mMAX_MEMBERS
 = 8,

39 
	stx¡©
 {

40 
ušt32_t
 
	mp£Á
;

41 
ušt32_t
 
	mo£Á
;

42 
ušt64_t
 
	mjfs_»f
;

43 
ušt32_t
 
	mts_»f
;

44 
boŞ
 
	mts_synûd
;

48 
	s¹ı_£ss
 {

49 
¹p_sock
 *
	mrs
;

50 
hash
 *
	mmemb”s
;

51 
tmr
 
	mtmr
;

52 *
	múame
;

53 
ušt32_t
 
	mmemb”c
;

54 
ušt32_t
 
	m£nd”c
;

55 
ušt32_t
 
	m¤©e_tx
;

56 
ušt32_t
 
	m¤©e_rx
;

59 
lock
 *
	mlock
;

60 
tx¡©
 
	mtx¡©
;

65 
scheduË
(
¹ı_£ss
 *
£ss
);

66 
£nd_bye_·ck‘
(
¹ı_£ss
 *
£ss
);

69 
	$£ss_de¡ruùÜ
(*
d©a
)

71 
¹ı_£ss
 *
£ss
 = 
d©a
;

73 ià(
£ss
->
úame
)

74 ()
	`£nd_bye_·ck‘
(
£ss
);

76 
	`tmr_ÿnûl
(&
£ss
->
tmr
);

78 
	`mem_d”ef
(
£ss
->
úame
);

79 
	`hash_æush
(
£ss
->
memb”s
);

80 
	`mem_d”ef
(
£ss
->
memb”s
);

81 
	`mem_d”ef
(
£ss
->
lock
);

82 
	}
}

85 
¹p_memb”
 *
	$g‘_memb”
(
¹ı_£ss
 *
£ss
, 
ušt32_t
 
¤c
)

87 
¹p_memb”
 *
mbr
;

89 
mbr
 = 
	`memb”_fšd
(
£ss
->
memb”s
, 
¤c
);

90 ià(
mbr
)

91  
mbr
;

93 ià(
£ss
->
memb”c
 >ğ
MAX_MEMBERS
)

94  
NULL
;

96 
mbr
 = 
	`memb”_add
(
£ss
->
memb”s
, 
¤c
);

97 ià(!
mbr
)

98  
NULL
;

100 ++
£ss
->
memb”c
;

102  
mbr
;

103 
	}
}

107 
	$ÿlc_¹t
(
ušt32_t
 *
¹t
, ušt32_ˆ
l¤
, ušt32_ˆ
dl¤
)

109 
Áp_time
‚tp_time;

110 
ušt64_t
 
a_us
, 
l¤_us
, 
dl¤_us
;

111 
”r
;

113 
”r
 = 
	`Áp_time_g‘
(&
Áp_time
);

114 ià(
”r
)

117 
a_us
 = 
	`Áp_com·ù2us
(
	`Áp_com·ù
(&
Áp_time
));

118 
l¤_us
 = 
	`Áp_com·ù2us
(
l¤
);

119 
dl¤_us
 = 1000000ULL * 
dl¤
 / 65536;

122 *
¹t
 = 
	`MAX
(()(
a_us
 - 
l¤_us
 - 
dl¤_us
), 0);

123 
	}
}

127 
	$hªdË_¼_block
(
¹ı_£ss
 *
£ss
, 
¹p_memb”
 *
mbr
,

128 cÚ¡ 
¹ı_¼
 *
¼
)

131 
mbr
->
cum_lo¡
 = 
¼
->
lo¡
;

134 ià(
£ss
->
¤©e_tx
)

135 
mbr
->
j™
 = 1000000 * 
¼
->
j™‹r
 / 
£ss
->
¤©e_tx
;

138 ià(
¼
->
l¤
 &&„r->
dl¤
)

139 
	`ÿlc_¹t
(&
mbr
->
¹t
, 
¼
->
l¤
,„r->
dl¤
);

140 
	}
}

144 
	$hªdË_šcomšg_¼
(
¹ı_£ss
 *
£ss
,

145 cÚ¡ 
¹ı_msg
 *
msg
)

147 
¹p_memb”
 *
mbr
;

148 
ušt32_t
 
i
;

150 
mbr
 = 
	`g‘_memb”
(
£ss
, 
msg
->
r
.
¼
.
s¤c
);

151 ià(!
mbr
)

154 
i
=0; i<
msg
->
hdr
.
couÁ
; i++)

155 
	`hªdË_¼_block
(
£ss
, 
mbr
, &
msg
->
r
.
¼
.
¼v
[
i
]);

156 
	}
}

160 
	$hªdË_šcomšg_¤
(
¹ı_£ss
 *
£ss
,

161 cÚ¡ 
¹ı_msg
 *
msg
)

163 
¹p_memb”
 *
mbr
;

164 
ušt32_t
 
i
;

166 
mbr
 = 
	`g‘_memb”
(
£ss
, 
msg
->
r
.
¤
.
s¤c
);

167 ià(!
mbr
) {

168 
	`DEBUG_WARNING
("0x%08x: could‚ot‡dd member\n",

169 
msg
->
r
.
¤
.
s¤c
);

173 ià(
mbr
->
s
) {

175 
mbr
->
s
->
¤_»cv
 = 
	`tmr_jiff›s
();

178 
mbr
->
s
->
Ï¡_¤
.
hi
 = 
msg
->
r
.
¤
.
Áp_£c
;

179 
mbr
->
s
->
Ï¡_¤
.
lo
 = 
msg
->
r
.
¤
.
Áp_äac
;

180 
mbr
->
s
->
¹p_ts
 = 
msg
->
r
.
¤
.rtp_ts;

181 
mbr
->
s
->
p£Á
 = 
msg
->
r
.
¤
.psent;

182 
mbr
->
s
->
o£Á
 = 
msg
->
r
.
¤
.osent;

185 
i
=0; i<
msg
->
hdr
.
couÁ
; i++)

186 
	`hªdË_¼_block
(
£ss
, 
mbr
, &
msg
->
r
.
¤
.
¼v
[
i
]);

187 
	}
}

190 
	$hªdË_šcomšg_bye
(
¹ı_£ss
 *
£ss
,

191 cÚ¡ 
¹ı_msg
 *
msg
)

193 
ušt32_t
 
i
;

195 
i
=0; i<
msg
->
hdr
.
couÁ
; i++) {

197 
¹p_memb”
 *
mbr
;

199 
mbr
 = 
	`memb”_fšd
(
£ss
->
memb”s
, 
msg
->
r
.
bye
.
¤cv
[
i
]);

200 ià(
mbr
) {

201 ià(
mbr
->
s
)

202 --
£ss
->
£nd”c
;

204 --
£ss
->
memb”c
;

205 
	`mem_d”ef
(
mbr
);

208 
	}
}

211 
	$¹ı_hªdËr
(
¹ı_£ss
 *
£ss
, 
¹ı_msg
 *
msg
)

213 ià(!
£ss
 || !
msg
)

216 
msg
->
hdr
.
±
) {

218 
RTCP_SR
:

219 
	`hªdË_šcomšg_¤
(
£ss
, 
msg
);

222 
RTCP_RR
:

223 
	`hªdË_šcomšg_¼
(
£ss
, 
msg
);

226 
RTCP_BYE
:

227 
	`hªdË_šcomšg_bye
(
£ss
, 
msg
);

233 
	}
}

236 
	$¹ı_£ss_®loc
(
¹ı_£ss
 **
£s¥
, 
¹p_sock
 *
rs
)

238 
¹ı_£ss
 *
£ss
;

239 
”r
;

241 ià(!
£s¥
)

242  
EINVAL
;

244 
£ss
 = 
	`mem_z®loc
((*£ss), 
£ss_de¡ruùÜ
);

245 ià(!
£ss
)

246  
ENOMEM
;

248 
£ss
->
rs
 =„s;

249 
	`tmr_š™
(&
£ss
->
tmr
);

251 
”r
 = 
	`lock_®loc
(&
£ss
->
lock
);

252 ià(
”r
)

253 
out
;

255 
”r
 = 
	`hash_®loc
(&
£ss
->
memb”s
, 
MAX_MEMBERS
);

256 ià(
”r
)

257 
out
;

259 
out
:

260 ià(
”r
)

261 
	`mem_d”ef
(
£ss
);

263 *
£s¥
 = 
£ss
;

265  
”r
;

266 
	}
}

276 
	$¹ı_£t_¤©e
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤©e_tx
, ušt32_ˆ
¤©e_rx
)

278 
¹ı_£ss
 *
£ss
 = 
	`¹p_¹ı_£ss
(
rs
);

279 ià(!
£ss
)

282 
£ss
->
¤©e_tx
 = srate_tx;

283 
£ss
->
¤©e_rx
 = srate_rx;

284 
	}
}

293 
	$¹ı_£t_¤©e_tx
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤©e_tx
)

295 
¹ı_£ss
 *
£ss
 = 
	`¹p_¹ı_£ss
(
rs
);

296 ià(!
£ss
)

299 
£ss
->
¤©e_tx
 = srate_tx;

300 
	}
}

309 
	$¹ı_£t_¤©e_rx
(
¹p_sock
 *
rs
, 
ušt32_t
 
¤©e_rx
)

311 
¹ı_£ss
 *
£ss
 = 
	`¹p_¹ı_£ss
(
rs
);

312 ià(!
£ss
)

315 
£ss
->
¤©e_rx
 = srate_rx;

316 
	}
}

319 
	$¹ı_’abË
(
¹ı_£ss
 *
£ss
, 
boŞ
 
’abËd
, cÚ¡ *
úame
)

321 
”r
;

323 ià(!
£ss
)

324  
EINVAL
;

326 
£ss
->
úame
 = 
	`mem_d”ef
(sess->cname);

327 
”r
 = 
	`¡r_dup
(&
£ss
->
úame
, cname);

328 ià(
”r
)

329  
”r
;

331 ià(
’abËd
)

332 
	`scheduË
(
£ss
);

334 
	`tmr_ÿnûl
(&
£ss
->
tmr
);

337 
	}
}

341 
ušt32_t
 
	$ÿlc_l¤
(cÚ¡ 
Áp_time
 *
Ï¡_¤
)

343  
Ï¡_¤
->
hi
 ? 
	`Áp_com·ù
(last_sr) : 0;

344 
	}
}

347 
ušt32_t
 
	$ÿlc_dl¤
(
ušt64_t
 
¤_»cv
)

349 ià(
¤_»cv
) {

350 cÚ¡ 
ušt64_t
 
diff
 = 
	`tmr_jiff›s
(è- 
¤_»cv
;

351  (
ušt32_t
)((65536 * 
diff
) / 1000);

356 
	}
}

359 
boŞ
 
	$£nd”_­¶y_hªdËr
(
Ë
 *Ë, *
¬g
)

361 
¹p_memb”
 *
mbr
 = 
Ë
->
d©a
;

362 
¹p_sourû
 *
s
 = 
mbr
->s;

363 
mbuf
 *
mb
 = 
¬g
;

364 
¹ı_¼
 
¼
;

366 ià(!
s
)

367  
çl£
;

370 
¼
.
s¤c
 = 
mbr
->
¤c
;

371 
¼
.
äaùiÚ
 = 
	`sourû_ÿlc_äaùiÚ_lo¡
(
s
);

372 
¼
.
lo¡
 = 
	`sourû_ÿlc_lo¡
(
s
);

373 
¼
.
Ï¡_£q
 = 
s
->
cyşes
 | s->
max_£q
;

374 
¼
.
j™‹r
 = 
s
->jitter >> 4;

375 
¼
.
l¤
 = 
	`ÿlc_l¤
(&
s
->
Ï¡_¤
);

376 
¼
.
dl¤
 = 
	`ÿlc_dl¤
(
s
->
¤_»cv
);

378  0 !ğ
	`¹ı_¼_’code
(
mb
, &
¼
);

379 
	}
}

382 
	$’code_hªdËr
(
mbuf
 *
mb
, *
¬g
)

384 
hash
 *
memb”s
 = 
¬g
;

387 ià(
	`hash_­¶y
(
memb”s
, 
£nd”_­¶y_hªdËr
, 
mb
))

388  
ENOMEM
;

391 
	}
}

395 
	$mk_¤
(
¹ı_£ss
 *
£ss
, 
mbuf
 *
mb
)

397 
Áp_time
 
Áp
 = {0, 0};

398 
tx¡©
xstat;

399 
ušt32_t
 
dur
, 
¹p_ts
 = 0;

400 
”r
;

402 
”r
 = 
	`Áp_time_g‘
(&
Áp
);

403 ià(
”r
)

404  
”r
;

406 
	`lock_wr™e_g‘
(
£ss
->
lock
);

407 
tx¡©
 = 
£ss
->txstat;

408 
£ss
->
tx¡©
.
ts_synûd
 = 
çl£
;

409 
	`lock_»l
(
£ss
->
lock
);

411 ià(
tx¡©
.
jfs_»f
) {

412 
dur
 = (
ušt32_t
)(
	`tmr_jiff›s
(è- 
tx¡©
.
jfs_»f
);

413 
¹p_ts
 = 
tx¡©
.
ts_»f
 + 
dur
 * 
£ss
->
¤©e_tx
 / 1000;

416 
”r
 = 
	`¹ı_’code
(
mb
, 
RTCP_SR
, 
£ss
->
£nd”c
, 
	`¹p_£ss_s¤c
(£ss->
rs
),

417 
Áp
.
hi
,‚.
lo
, 
¹p_ts
, 
tx¡©
.
p£Á
,x¡©.
o£Á
,

418 
’code_hªdËr
, 
£ss
->
memb”s
);

419 ià(
”r
)

420  
”r
;

422  
”r
;

423 
	}
}

426 
	$sdes_’code_hªdËr
(
mbuf
 *
mb
, *
¬g
)

428 
¹ı_£ss
 *
£ss
 = 
¬g
;

430  
	`¹ı_sdes_’code
(
mb
, 
	`¹p_£ss_s¤c
(
£ss
->
rs
), 1,

431 
RTCP_SDES_CNAME
, 
£ss
->
úame
);

432 
	}
}

435 
	$mk_sdes
(
¹ı_£ss
 *
£ss
, 
mbuf
 *
mb
)

437  
	`¹ı_’code
(
mb
, 
RTCP_SDES
, 1, 
sdes_’code_hªdËr
, 
£ss
);

438 
	}
}

441 
	$£nd_¹ı_»pÜt
(
¹ı_£ss
 *
£ss
)

443 
mbuf
 *
mb
;

444 
”r
;

446 
mb
 = 
	`mbuf_®loc
(512);

447 ià(!
mb
)

448  
ENOMEM
;

450 
mb
->
pos
 = 
RTCP_HEADROOM
;

452 
”r
 = 
	`mk_¤
(
£ss
, 
mb
);

453 
”r
 |ğ
	`mk_sdes
(
£ss
, 
mb
);

454 ià(
”r
)

455 
out
;

457 
mb
->
pos
 = 
RTCP_HEADROOM
;

459 
”r
 = 
	`¹ı_£nd
(
£ss
->
rs
, 
mb
);

461 
out
:

462 
	`mem_d”ef
(
mb
);

463  
”r
;

464 
	}
}

467 
	$£nd_bye_·ck‘
(
¹ı_£ss
 *
£ss
)

469 cÚ¡ 
ušt32_t
 
s¤c
 = 
	`¹p_£ss_s¤c
(
£ss
->
rs
);

470 
mbuf
 *
mb
;

471 
”r
;

473 
mb
 = 
	`mbuf_®loc
(512);

474 ià(!
mb
)

475  
ENOMEM
;

477 
mb
->
pos
 = 
RTCP_HEADROOM
;

479 
”r
 = 
	`¹ı_’code
(
mb
, 
RTCP_BYE
, 1, &
s¤c
, "Adjo");

480 
”r
 |ğ
	`mk_sdes
(
£ss
, 
mb
);

481 ià(
”r
)

482 
out
;

484 
mb
->
pos
 = 
RTCP_HEADROOM
;

486 
”r
 = 
	`¹ı_£nd
(
£ss
->
rs
, 
mb
);

488 
out
:

489 
	`mem_d”ef
(
mb
);

490  
”r
;

491 
	}
}

494 
	$timeout
(*
¬g
)

496 
¹ı_£ss
 *
£ss
 = 
¬g
;

497 
”r
;

499 
”r
 = 
	`£nd_¹ı_»pÜt
(
£ss
);

500 ià(
”r
) {

501 
	`DEBUG_WARNING
("S’d RTCP„•Üˆçed: %m\n", 
”r
);

504 
	`scheduË
(
£ss
);

505 
	}
}

508 
	$scheduË
(
¹ı_£ss
 *
£ss
)

510 
	`tmr_¡¬t
(&
£ss
->
tmr
, 
RTCP_INTERVAL
, 
timeout
, sess);

511 
	}
}

514 
	$¹ı_£ss_tx_¹p
(
¹ı_£ss
 *
£ss
, 
ušt32_t
 
ts
, 
size_t
 
·ylßd_size
)

516 ià(!
£ss
)

519 
	`lock_wr™e_g‘
(
£ss
->
lock
);

521 
£ss
->
tx¡©
.
o£Á
 +ğ(
ušt32_t
)
·ylßd_size
;

522 
£ss
->
tx¡©
.
p£Á
 += 1;

524 ià(!
£ss
->
tx¡©
.
ts_synûd
) {

525 
£ss
->
tx¡©
.
jfs_»f
 = 
	`tmr_jiff›s
();

526 
£ss
->
tx¡©
.
ts_»f
 = 
ts
;

527 
£ss
->
tx¡©
.
ts_synûd
 = 
Œue
;

530 
	`lock_»l
(
£ss
->
lock
);

531 
	}
}

534 
	$¹ı_£ss_rx_¹p
(
¹ı_£ss
 *
£ss
, 
ušt16_t
 
£q
, 
ušt32_t
 
ts
,

535 
ušt32_t
 
s¤c
, 
size_t
 
·ylßd_size
,

536 cÚ¡ 
§
 *
³”
)

538 
¹p_memb”
 *
mbr
;

540 ià(!
£ss
)

543 
mbr
 = 
	`g‘_memb”
(
£ss
, 
s¤c
);

544 ià(!
mbr
) {

545 
	`DEBUG_NOTICE
("could‚Ù‡dd memb”: 0x%08x\n", 
s¤c
);

549 ià(!
mbr
->
s
) {

550 
mbr
->
s
 = 
	`mem_z®loc
((*mbr->s), 
NULL
);

551 ià(!
mbr
->
s
) {

552 
	`DEBUG_NOTICE
("could‚Ù‡dd s’d”: 0x%08x\n", 
s¤c
);

557 
	`sourû_š™_£q
(
mbr
->
s
, 
£q
);

559 
	`§_ıy
(&
mbr
->
s
->
¹p_³”
, 
³”
);

560 ++
£ss
->
£nd”c
;

563 ià(!
	`sourû_upd©e_£q
(
mbr
->
s
, 
£q
)) {

564 
	`DEBUG_WARNING
("rtp_update_seq()„eturned 0\n");

567 ià(
£ss
->
¤©e_rx
) {

569 
ušt64_t
 
ts_¬rive
;

572 
ts_¬rive
 = 
	`tmr_jiff›s
(è* 
£ss
->
¤©e_rx
 / 1000;

574 
	`sourû_ÿlc_j™‹r
(
mbr
->
s
, 
ts
, (
ušt32_t
)
ts_¬rive
);

577 
mbr
->
s
->
¹p_rx_by‹s
 +ğ
·ylßd_size
;

578 
	}
}

590 
	$¹ı_¡©s
(
¹p_sock
 *
rs
, 
ušt32_t
 
s¤c
, 
¹ı_¡©s
 *
¡©s
)

592 cÚ¡ 
¹ı_£ss
 *
£ss
 = 
	`¹p_¹ı_£ss
(
rs
);

593 
¹p_memb”
 *
mbr
;

595 ià(!
£ss
 || !
¡©s
)

596  
EINVAL
;

598 
mbr
 = 
	`memb”_fšd
(
£ss
->
memb”s
, 
s¤c
);

599 ià(!
mbr
)

600  
ENOENT
;

602 
	`lock_»ad_g‘
(
£ss
->
lock
);

603 
¡©s
->
tx
.
£Á
 = 
£ss
->
tx¡©
.
p£Á
;

604 
	`lock_»l
(
£ss
->
lock
);

606 
¡©s
->
tx
.
lo¡
 = 
mbr
->
cum_lo¡
;

607 
¡©s
->
tx
.
j™
 = 
mbr
->jit;

609 
¡©s
->
¹t
 = 
mbr
->rtt;

611 ià(!
mbr
->
s
) {

612 
	`mem£t
(&
¡©s
->
rx
, 0, (stats->rx));

616 
¡©s
->
rx
.
£Á
 = 
mbr
->
s
->
»ûived
;

617 
¡©s
->
rx
.
lo¡
 = 
	`sourû_ÿlc_lo¡
(
mbr
->
s
);

618 
¡©s
->
rx
.
j™
 = 
£ss
->
¤©e_rx
 ?

619 1000000 * (
mbr
->
s
->
j™‹r
>>4è/ 
£ss
->
¤©e_rx
 : 0;

622 
	}
}

625 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

627 cÚ¡ 
¹p_memb”
 *
mbr
 = 
Ë
->
d©a
;

628 
»_´štf
 *
pf
 = 
¬g
;

629 
”r
;

631 
”r
 = 
	`»_h´štf
(
pf
, " member 0x%08x:†ost=%d Jitter=%.1fms"

632 " RTT=%.1fms\n", 
mbr
->
¤c
, mbr->
cum_lo¡
,

633 ()
mbr
->
j™
/1000, ()mbr->
¹t
/1000);

634 ià(
mbr
->
s
) {

635 
”r
 |ğ
	`»_h´štf
(
pf
,

637 &
mbr
->
s
->
¹p_³”
, mbr->s->
p£Á
,

638 
mbr
->
s
->
»ûived
);

641  
”r
 != 0;

642 
	}
}

653 
	$¹ı_debug
(
»_´štf
 *
pf
, cÚ¡ 
¹p_sock
 *
rs
)

655 cÚ¡ 
¹ı_£ss
 *
£ss
 = 
	`¹p_¹ı_£ss
(
rs
);

656 
”r
 = 0;

658 ià(!
£ss
)

661 
”r
 |ğ
	`»_h´štf
(
pf
, "----- RTCP Session: -----\n");

662 
”r
 |ğ
	`»_h´štf
(
pf
, " cname=%s SSRC=0x%08x/%u„x=%uHz\n",

663 
£ss
->
úame
,

664 
	`¹p_£ss_s¤c
(
£ss
->
rs
),„tp_sess_ssrc(sess->rs),

665 
£ss
->
¤©e_rx
);

667 
	`hash_­¶y
(
£ss
->
memb”s
, 
debug_hªdËr
, 
pf
);

669 
	`lock_»ad_g‘
(
£ss
->
lock
);

670 
”r
 |ğ
	`»_h´štf
(
pf
, " TX:…ackets=%u, octets=%u\n",

671 
£ss
->
tx¡©
.
p£Á
, sess->tx¡©.
o£Á
);

672 
	`lock_»l
(
£ss
->
lock
);

674  
”r
;

675 
	}
}

	@re-0.5.6/src/rtp/source.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_§.h
>

14 
	~<»_¹p.h
>

15 
	~"¹ı.h
"

19 
	mRTP_SEQ_MOD
 = 1<<16,

23 
	$sourû_š™_£q
(
¹p_sourû
 *
s
, 
ušt16_t
 
£q
)

25 ià(!
s
)

28 
s
->
ba£_£q
 = 
£q
;

29 
s
->
max_£q
 = 
£q
;

30 
s
->
bad_£q
 = 
RTP_SEQ_MOD
 + 1;

31 
s
->
cyşes
 = 0;

32 
s
->
»ûived
 = 0;

33 
s
->
»ûived_´iÜ
 = 0;

34 
s
->
ex³ùed_´iÜ
 = 0;

36 
	}
}

42 
	$sourû_upd©e_£q
(
¹p_sourû
 *
s
, 
ušt16_t
 
£q
)

44 
ušt16_t
 
ud–
 = 
£q
 - 
s
->
max_£q
;

45 cÚ¡ 
MAX_DROPOUT
 = 3000;

46 cÚ¡ 
MAX_MISORDER
 = 100;

47 cÚ¡ 
MIN_SEQUENTIAL
 = 2;

53 ià(
s
->
´ob©iÚ
) {

56 ià(
£q
 =ğ
s
->
max_£q
 + 1) {

57 
s
->
´ob©iÚ
--;

58 
s
->
max_£q
 = 
£q
;

59 ià(
s
->
´ob©iÚ
 == 0) {

60 
	`sourû_š™_£q
(
s
, 
£q
);

61 
s
->
»ûived
++;

66 
s
->
´ob©iÚ
 = 
MIN_SEQUENTIAL
 - 1;

67 
s
->
max_£q
 = 
£q
;

71 ià(
ud–
 < 
MAX_DROPOUT
) {

74 ià(
£q
 < 
s
->
max_£q
) {

78 
s
->
cyşes
 +ğ
RTP_SEQ_MOD
;

80 
s
->
max_£q
 = 
£q
;

82 ià(
ud–
 <ğ
RTP_SEQ_MOD
 - 
MAX_MISORDER
) {

85 ià(
£q
 =ğ
s
->
bad_£q
) {

91 
	`sourû_š™_£q
(
s
, 
£q
);

94 
s
->
bad_£q
 = (
£q
 + 1è& (
RTP_SEQ_MOD
-1);

102 
s
->
»ûived
++;

104 
	}
}

114 
	$sourû_ÿlc_j™‹r
(
¹p_sourû
 *
s
, 
ušt32_t
 
¹p_ts
,

115 
ušt32_t
 
¬riv®
)

117 cÚ¡ 
Œªs™
 = 
¬riv®
 - 
¹p_ts
;

118 
d
 = 
Œªs™
 - 
s
->transit;

120 ià(!
s
->
Œªs™
) {

121 
s
->
Œªs™
 =ransit;

125 
s
->
Œªs™
 =ransit;

127 ià(
d
 < 0)

128 
d
 = -d;

130 
s
->
j™‹r
 +ğ
d
 - ((s->jitter + 8) >> 4);

131 
	}
}

135 
	$sourû_ÿlc_lo¡
(cÚ¡ 
¹p_sourû
 *
s
)

137 
ex‹nded_max
 = 
s
->
cyşes
 + s->
max_£q
;

138 
ex³ùed
 = 
ex‹nded_max
 - 
s
->
ba£_£q
 + 1;

139 
lo¡
;

141 
lo¡
 = 
ex³ùed
 - 
s
->
»ûived
;

144 ià(
lo¡
 > 0x7fffff)

145 
lo¡
 = 0x7fffff;

146 ià(
lo¡
 < -0x7fffff)

147 
lo¡
 = -0x7fffff;

149  
lo¡
;

150 
	}
}

154 
ušt8_t
 
	$sourû_ÿlc_äaùiÚ_lo¡
(
¹p_sourû
 *
s
)

156 
ex‹nded_max
 = 
s
->
cyşes
 + s->
max_£q
;

157 
ex³ùed
 = 
ex‹nded_max
 - 
s
->
ba£_£q
 + 1;

158 
ex³ùed_š‹rv®
 = 
ex³ùed
 - 
s
->
ex³ùed_´iÜ
;

159 
»ûived_š‹rv®
;

160 
lo¡_š‹rv®
;

161 
ušt8_t
 
äaùiÚ
;

163 
s
->
ex³ùed_´iÜ
 = 
ex³ùed
;

165 
»ûived_š‹rv®
 = 
s
->
»ûived
 - s->
»ûived_´iÜ
;

167 
s
->
»ûived_´iÜ
 = s->
»ûived
;

169 
lo¡_š‹rv®
 = 
ex³ùed_š‹rv®
 - 
»ûived_š‹rv®
;

171 ià(
ex³ùed_š‹rv®
 =ğ0 || 
lo¡_š‹rv®
 <= 0)

172 
äaùiÚ
 = 0;

174 
äaùiÚ
 = (
lo¡_š‹rv®
 << 8è/ 
ex³ùed_š‹rv®
;

176  
äaùiÚ
;

177 
	}
}

	@re-0.5.6/src/sa/ntop.c

7 
	#_BSD_SOURCE
 1

	)

8 
	#_DEFAULT_SOURCE
 1

	)

10 #ifdeà
HAVE_INET_NTOP


11 #ifdeà
WIN32


12 #ifdeà
_MSC_VER


13 #´agm¨
w¬nšg
 (
di§bË
: 4090)

15 
	~<wšdows.h
>

17 
	#__USE_BSD
 1

	)

18 
	~<sys/ty³s.h
>

19 
	~<sys/sock‘.h
>

20 
	~<¬·/š‘.h
>

21 
	#__USE_POSIX
 1

	)

22 
	~<Ãtdb.h
>

25 
	~<¡ršg.h
>

26 
	~<»_ty³s.h
>

27 
	~<»_fmt.h
>

28 
	~<»_mbuf.h
>

29 
	~<»_§.h
>

30 
	~"§.h
"

33 
	#DEBUG_MODULE
 "Ãt_Áİ"

	)

34 
	#DEBUG_LEVEL
 5

	)

35 
	~<»_dbg.h
>

38 #iâdeà
HAVE_INET_NTOP


41 
	#NS_IN6ADDRSZ
 16

	)

42 
	#NS_INT16SZ
 2

	)

46 
	$š‘_Áİ4
(cÚ¡ 
u_ch¬
 *
¤c
, *
d¡
, 
size_t
 
size
)

48 ià(
	`»_¢´štf
(
d¡
, 
size
, "%u.%u.%u.%u",

49 
¤c
[0], src[1], src[2], src[3]) < 0) {

50 
”ºo
 = 
ENOSPC
;

51 
d¡
[
size
-1] = 0;

52  
NULL
;

55  
d¡
;

56 
	}
}

59 #ifdeà
HAVE_INET6


68 
	$š‘_Áİ6
(cÚ¡ 
u_ch¬
 *
¤c
, *
d¡
, 
size_t
 
size
)

77 
tmp
[ "ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"], *

;

78 ¡ruù { 
ba£
, 
Ën
; } 
be¡
, 
cur
;

79 
u_št
 
wÜds
[
NS_IN6ADDRSZ
 / 
NS_INT16SZ
];

80 
i
;

87 
	`mem£t
(
wÜds
, '\0',  words);

88 
i
 = 0; i < 
NS_IN6ADDRSZ
; i++)

89 
wÜds
[
i
 / 2] |ğ(
¤c
[i] << ((1 - (i % 2)) << 3));

90 
be¡
.
ba£
 = -1;

91 
be¡
.
Ën
 = 0;

92 
cur
.
ba£
 = -1;

93 
cur
.
Ën
 = 0;

94 
i
 = 0; i < (
NS_IN6ADDRSZ
 / 
NS_INT16SZ
); i++) {

95 ià(
wÜds
[
i
] == 0) {

96 ià(
cur
.
ba£
 == -1)

97 
cur
.
ba£
 = 
i
, cur.
Ën
 = 1;

99 
cur
.
Ën
++;

102 ià(
cur
.
ba£
 != -1) {

103 ià(
be¡
.
ba£
 =ğ-1 || 
cur
.
Ën
 > best.len)

104 
be¡
 = 
cur
;

105 
cur
.
ba£
 = -1;

109 ià(
cur
.
ba£
 != -1) {

110 ià(
be¡
.
ba£
 =ğ-1 || 
cur
.
Ën
 > best.len)

111 
be¡
 = 
cur
;

113 ià(
be¡
.
ba£
 !ğ-1 && be¡.
Ën
 < 2)

114 
be¡
.
ba£
 = -1;

119 

 = 
tmp
;

120 
i
 = 0; i < (
NS_IN6ADDRSZ
 / 
NS_INT16SZ
); i++) {

122 ià(
be¡
.
ba£
 !ğ-1 && 
i
 >= best.base &&

123 
i
 < (
be¡
.
ba£
 + be¡.
Ën
)) {

124 ià(
i
 =ğ
be¡
.
ba£
)

125 *

++ = ':';

129 ià(
i
 != 0)

130 *

++ = ':';

132 ià(
i
 =ğ6 && 
be¡
.
ba£
 == 0 &&

133 (
be¡
.
Ën
 =ğ6 || (be¡.ËÀ=ğ5 && 
wÜds
[5] == 0xffff))) {

134 ià(!
	`š‘_Áİ4
(
¤c
+12, 

,  
tmp
 - (tp -mp)))

135  
NULL
;

136 

 +ğ
	`¡¾’
(tp);

139 

 +ğ
	`¥rštf
Ñp, "%x", 
wÜds
[
i
]);

142 ià(
be¡
.
ba£
 !ğ-1 && (be¡.ba£ + be¡.
Ën
) ==

143 (
NS_IN6ADDRSZ
 / 
NS_INT16SZ
))

144 *

++ = ':';

145 *

++ = '\0';

150 ià((
size_t
)(

 - 
tmp
è> 
size
) {

151 
”ºo
 = 
ENOSPC
;

152  
NULL
;

154 
	`¡rıy
(
d¡
, 
tmp
);

156  
d¡
;

157 
	}
}

164 cÚ¡ * 
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
size_t
 
size
);

165 cÚ¡ * 
	$š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
size_t
 
size
)

167 
af
) {

169 
AF_INET
:

170  
	`š‘_Áİ4
(
¤c
, 
d¡
, 
size
);

172 #ifdeà
HAVE_INET6


173 
AF_INET6
:

174  
	`š‘_Áİ6
(
¤c
, 
d¡
, 
size
);

178 
	`DEBUG_WARNING
("š‘_Áİ: unknowÀadd»s çmy %d\n", 
af
);

179  
NULL
;

181 
	}
}

200 
	$Ãt_š‘_Áİ
(cÚ¡ 
§
 *§, *
buf
, 
size
)

202 ià(!
§
 || !
buf
 || !
size
)

203  
EINVAL
;

205 
§
->
u
.§.
§_çmy
) {

207 
AF_INET
:

208 
	`š‘_Áİ
(
AF_INET
, &
§
->
u
.
š
.
sš_addr
, 
buf
, 
size
);

211 #ifdeà
HAVE_INET6


212 
AF_INET6
:

213 
	`š‘_Áİ
(
AF_INET6
, &
§
->
u
.
š6
.
sš6_addr
, 
buf
, 
size
);

218  
EAFNOSUPPORT
;

222 
	}
}

	@re-0.5.6/src/sa/printaddr.c

6 #ifdeà
HAVE_GETIFADDRS


7 
	~<sys/ty³s.h
>

8 
	~<sys/sock‘.h
>

9 
	#__USE_MISC
 1

	)

10 
	~<Ãt/if.h
>

12 
	~<»_ty³s.h
>

13 
	~<»_fmt.h
>

14 
	~<»_§.h
>

25 
	$§_´št_addr
(
»_´štf
 *
pf
, cÚ¡ 
§
 *sa)

27 
”r
;

29 ià(!
§
)

32 
”r
 = 
	`»_h´štf
(
pf
, "%j", 
§
);

34 #ià
	`defšed
 (
HAVE_GETIFADDRS
è&& defšed (
HAVE_INET6
)

35 ià(
	`§_af
(
§
è=ğ
AF_INET6
 && 
	`§_is_lškloÿl
(sa)) {

37 
iâame
[
IF_NAMESIZE
];

39 ià(!
	`if_šdextÚame
(
§
->
u
.
š6
.
sš6_scİe_id
, 
iâame
))

40  
”ºo
;

42 
”r
 |ğ
	`»_h´štf
(
pf
, "%%%s", 
iâame
);

46  
”r
;

47 
	}
}

	@re-0.5.6/src/sa/pton.c

7 
	#_BSD_SOURCE
 1

	)

8 
	#_DEFAULT_SOURCE
 1

	)

10 #ifdeà
HAVE_INET_PTON


11 #ifdeà
WIN32


12 
	~<wšdows.h
>

14 
	~<sys/ty³s.h
>

15 
	~<sys/sock‘.h
>

16 
	~<¬·/š‘.h
>

17 
	#__USE_POSIX
 1

	)

18 
	~<Ãtdb.h
>

21 
	~<¡ršg.h
>

22 
	~<»_ty³s.h
>

23 
	~<»_fmt.h
>

24 
	~<»_mbuf.h
>

25 
	~<»_§.h
>

26 
	~"§.h
"

29 
	#DEBUG_MODULE
 "Ãt_±Ú"

	)

30 
	#DEBUG_LEVEL
 5

	)

31 
	~<»_dbg.h
>

34 #iâdeà
HAVE_INET_PTON


37 
	#NS_INADDRSZ
 4

	)

38 
	#NS_IN6ADDRSZ
 16

	)

39 
	#NS_INT16SZ
 2

	)

53 
	$š‘_±Ú4
(cÚ¡ *
¤c
, 
u_ch¬
 *
d¡
)

55 cÚ¡ 
dig™s
[] = "0123456789";

56 
§w_dig™
, 
où‘s
, 
ch
;

57 
u_ch¬
 
tmp
[
NS_INADDRSZ
], *

;

59 
§w_dig™
 = 0;

60 
où‘s
 = 0;

61 *(

 = 
tmp
) = 0;

62 (
ch
 = *
¤c
++) != '\0') {

63 cÚ¡ *
pch
;

65 ià((
pch
 = 
	`¡rchr
(
dig™s
, 
ch
)è!ğ
NULL
) {

66 
u_št
 
ÃwV®
 = (u_štè(*

 * 10 + (
pch
 - 
dig™s
));

68 ià(
ÃwV®
 > 255)

70 *

 = 
ÃwV®
;

71 ià(! 
§w_dig™
) {

72 ià(++
où‘s
 > 4)

74 
§w_dig™
 = 1;

77 ià(
ch
 =ğ'.' && 
§w_dig™
) {

78 ià(
où‘s
 == 4)

80 *++

 = 0;

81 
§w_dig™
 = 0;

86 ià(
où‘s
 < 4)

89 
	`memıy
(
d¡
, 
tmp
, 
NS_INADDRSZ
);

91 
	}
}

94 #ifdeà
HAVE_INET6


109 
	$š‘_±Ú6
(cÚ¡ *
¤c
, 
u_ch¬
 *
d¡
)

111 cÚ¡ 
xdig™s_l
[] = "0123456789abcdef",

112 
xdig™s_u
[] = "0123456789ABCDEF";

113 
u_ch¬
 
tmp
[
NS_IN6ADDRSZ
], *

, *
’dp
, *
cŞÚp
;

114 cÚ¡ *
xdig™s
, *
cu¹ok
;

115 
ch
, 
§w_xdig™
;

116 
u_št
 
v®
;

118 
	`mem£t
((

 = 
tmp
), '\0', 
NS_IN6ADDRSZ
);

119 
’dp
 = 

 + 
NS_IN6ADDRSZ
;

120 
cŞÚp
 = 
NULL
;

122 ià(*
¤c
 == ':')

123 ià(*++
¤c
 != ':')

125 
cu¹ok
 = 
¤c
;

126 
§w_xdig™
 = 0;

127 
v®
 = 0;

128 (
ch
 = *
¤c
++) != '\0') {

129 cÚ¡ *
pch
;

131 ià((
pch
 = 
	`¡rchr
((
xdig™s
 = 
xdig™s_l
), 
ch
)è=ğ
NULL
)

132 
pch
 = 
	`¡rchr
((
xdig™s
 = 
xdig™s_u
), 
ch
);

133 ià(
pch
 !ğ
NULL
) {

134 
v®
 <<= 4;

135 
v®
 |ğ(
u_št
)(
pch
 - 
xdig™s
);

136 ià(
v®
 > 0xffff)

138 
§w_xdig™
 = 1;

141 ià(
ch
 == ':') {

142 
cu¹ok
 = 
¤c
;

143 ià(!
§w_xdig™
) {

144 ià(
cŞÚp
)

146 
cŞÚp
 = 

;

149 ià(

 + 
NS_INT16SZ
 > 
’dp
)

151 *

++ = (
u_ch¬
è(
v®
 >> 8) & 0xff;

152 *

++ = (
u_ch¬
è
v®
 & 0xff;

153 
§w_xdig™
 = 0;

154 
v®
 = 0;

157 ià(
ch
 =ğ'.' && ((

 + 
NS_INADDRSZ
è<ğ
’dp
) &&

158 
	`š‘_±Ú4
(
cu¹ok
, 

) > 0) {

159 

 +ğ
NS_INADDRSZ
;

160 
§w_xdig™
 = 0;

165 ià(
§w_xdig™
) {

166 ià(

 + 
NS_INT16SZ
 > 
’dp
)

168 *

++ = (
u_ch¬
è(
v®
 >> 8) & 0xff;

169 *

++ = (
u_ch¬
è
v®
 & 0xff;

171 ià(
cŞÚp
 !ğ
NULL
) {

176 cÚ¡ 
n
 = ()(

 - 
cŞÚp
);

177 
i
;

179 
i
 = 1; i <ğ
n
; i++) {

180 
’dp
[- 
i
] = 
cŞÚp
[
n
 - i];

181 
cŞÚp
[
n
 - 
i
] = 0;

183 

 = 
’dp
;

185 ià(

 !ğ
’dp
)

187 
	`memıy
(
d¡
, 
tmp
, 
NS_IN6ADDRSZ
);

190 
	}
}

197 
	$š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
)

199 ià(!
¤c
 || !
d¡
)

202 
af
) {

204 
AF_INET
:

205  
	`š‘_±Ú4
(
¤c
, (
u_ch¬
*è
d¡
);

207 #ifdeà
HAVE_INET6


208 
AF_INET6
:

209  
	`š‘_±Ú6
(
¤c
, (
u_ch¬
*è
d¡
);

213 
	`DEBUG_INFO
("š‘_±Ú: unknowÀadd»s çmy %d\n", 
af
);

214 
”ºo
 = 
EAFNOSUPPORT
;

217 
	}
}

229 
	$Ãt_š‘_±Ú
(cÚ¡ *
addr
, 
§
 *sa)

231 ià(!
addr
)

232  
EINVAL
;

234 ià(
	`š‘_±Ú
(
AF_INET
, 
addr
, &
§
->
u
.
š
.
sš_addr
) > 0) {

235 
§
->
u
.
š
.
sš_çmy
 = 
AF_INET
;

237 #ifdeà
HAVE_INET6


238 ià(
	`š‘_±Ú
(
AF_INET6
, 
addr
, &
§
->
u
.
š6
.
sš6_addr
) > 0) {

240 ià(
	`IN6_IS_ADDR_V4MAPPED
(&
§
->
u
.
š6
.
sš6_addr
)) {

241 cÚ¡ 
ušt8_t
 *
a
 = &
§
->
u
.
š6
.
sš6_addr
.
s6_addr
[12];

242 
§
->
u
.
š
.
sš_çmy
 = 
AF_INET
;

243 
	`memıy
(&
§
->
u
.
š
.
sš_addr
.
s_addr
, 
a
, 4);

246 
§
->
u
.
š6
.
sš6_çmy
 = 
AF_INET6
;

251  
EINVAL
;

255 
	}
}

	@re-0.5.6/src/sa/sa.c

6 
	#_BSD_SOURCE
 1

	)

7 
	#_DEFAULT_SOURCE
 1

	)

8 
	~<¡ršg.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~"§.h
"

16 
	#DEBUG_MODULE
 "§"

	)

17 
	#DEBUG_LEVEL
 5

	)

18 
	~<»_dbg.h
>

27 
	$§_š™
(
§
 *§, 
af
)

29 ià(!
§
)

32 
	`mem£t
(
§
, 0, (*sa));

33 
§
->
u
.§.
§_çmy
 = 
af
;

34 
§
->
Ën
 = (§->
u
);

35 
	}
}

47 
	$§_£t
(
§
 *§, cÚ¡ 
¶
 *
addr
, 
ušt16_t
 
pÜt
)

49 
buf
[64];

51 ()
	`¶_¡rıy
(
addr
, 
buf
, (buf));

52  
	`§_£t_¡r
(
§
, 
buf
, 
pÜt
);

53 
	}
}

65 
	$§_£t_¡r
(
§
 *§, cÚ¡ *
addr
, 
ušt16_t
 
pÜt
)

67 
”r
;

69 ià(!
§
 || !
addr
)

70  
EINVAL
;

72 
”r
 = 
	`Ãt_š‘_±Ú
(
addr
, 
§
);

73 ià(
”r
)

74  
”r
;

76 
§
->
u
.§.
§_çmy
) {

78 
AF_INET
:

79 
§
->
u
.
š
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

80 
§
->
Ën
 = (
sockaddr_š
);

83 #ifdeà
HAVE_INET6


84 
AF_INET6
:

85 
§
->
u
.
š6
.
sš6_pÜt
 = 
	`htÚs
(
pÜt
);

86 
§
->
Ën
 = (
sockaddr_š6
);

91  
EAFNOSUPPORT
;

95 
	}
}

107 
	$§_£t_š
(
§
 *§, 
ušt32_t
 
addr
, 
ušt16_t
 
pÜt
)

109 ià(!
§
)

112 
§
->
u
.
š
.
sš_çmy
 = 
AF_INET
;

113 
§
->
u
.
š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
addr
);

114 
§
->
u
.
š
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

115 
§
->
Ën
 = (
sockaddr_š
);

116 
	}
}

128 
	$§_£t_š6
(
§
 *§, cÚ¡ 
ušt8_t
 *
addr
, 
ušt16_t
 
pÜt
)

130 ià(!
§
)

133 #ifdeà
HAVE_INET6


134 
§
->
u
.
š6
.
sš6_çmy
 = 
AF_INET6
;

135 
	`memıy
(&
§
->
u
.
š6
.
sš6_addr
, 
addr
, 16);

136 
§
->
u
.
š6
.
sš6_pÜt
 = 
	`htÚs
(
pÜt
);

137 
§
->
Ën
 = (
sockaddr_š6
);

139 ()
addr
;

140 ()
pÜt
;

142 
	}
}

153 
	$§_£t_§
(
§
 *§, cÚ¡ 
sockaddr
 *
s
)

155 ià(!
§
 || !
s
)

156  
EINVAL
;

158 
s
->
§_çmy
) {

160 
AF_INET
:

161 
	`memıy
(&
§
->
u
.
š
, 
s
, (
sockaddr_š
));

162 
§
->
Ën
 = (
sockaddr_š
);

165 #ifdeà
HAVE_INET6


166 
AF_INET6
:

167 
	`memıy
(&
§
->
u
.
š6
, 
s
, (
sockaddr_š6
));

168 
§
->
Ën
 = (
sockaddr_š6
);

173  
EAFNOSUPPORT
;

176 
§
->
u
.§.
§_çmy
 = 
s
->sa_family;

179 
	}
}

188 
	$§_£t_pÜt
(
§
 *§, 
ušt16_t
 
pÜt
)

190 ià(!
§
)

193 
§
->
u
.§.
§_çmy
) {

195 
AF_INET
:

196 
§
->
u
.
š
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

199 #ifdeà
HAVE_INET6


200 
AF_INET6
:

201 
§
->
u
.
š6
.
sš6_pÜt
 = 
	`htÚs
(
pÜt
);

206 
	`DEBUG_WARNING
("sa_set_port:‚o‡f %d (port %u)\n",

207 
§
->
u
.§.
§_çmy
, 
pÜt
);

210 
	}
}

231 
	$§_decode
(
§
 *§, cÚ¡ *
¡r
, 
size_t
 
Ën
)

233 
¶
 
addr
, 
pÜt
,…l;

234 cÚ¡ *
c
;

236 ià(!
§
 || !
¡r
 || !
Ën
)

237  
EINVAL
;

239 
¶
.
p
 = 
¡r
;

240 
¶
.
l
 = 
Ën
;

242 ià('[' =ğ
¡r
[0] && (
c
 = 
	`¶_¡rchr
(&
¶
, ']'))) {

243 
addr
.
p
 = 
¡r
 + 1;

244 
addr
.
l
 = 
c
 - 
¡r
 - 1;

245 ++
c
;

247 ià(
NULL
 !ğ(
c
 = 
	`¶_¡rchr
(&
¶
, ':'))) {

248 
addr
.
p
 = 
¡r
;

249 
addr
.
l
 = 
c
 - 
¡r
;

252  
EINVAL
;

255 ià(
Ën
 < (
size_t
)(
c
 - 
¡r
 + 2))

256  
EINVAL
;

258 ià(':' !ğ*
c
)

259  
EINVAL
;

261 
pÜt
.
p
 = ++
c
;

262 
pÜt
.
l
 = 
Ën
 + 
¡r
 - 
c
;

264  
	`§_£t
(
§
, &
addr
, 
	`¶_u32
(&
pÜt
));

265 
	}
}

275 
	$§_af
(cÚ¡ 
§
 *sa)

277  
§
 ? sa->
u
.§.
§_çmy
 : 
AF_UNSPEC
;

278 
	}
}

288 
ušt32_t
 
	$§_š
(cÚ¡ 
§
 *sa)

290  
§
 ? 
	`Áohl
(§->
u
.
š
.
sš_addr
.
s_addr
) : 0;

291 
	}
}

300 
	$§_š6
(cÚ¡ 
§
 *§, 
ušt8_t
 *
addr
)

302 ià(!
§
 || !
addr
)

305 #ifdeà
HAVE_INET6


306 
	`memıy
(
addr
, &
§
->
u
.
š6
.
sš6_addr
, 16);

308 
	}
}

320 
	$§_Áİ
(cÚ¡ 
§
 *§, *
buf
, 
size
)

322  
	`Ãt_š‘_Áİ
(
§
, 
buf
, 
size
);

323 
	}
}

333 
ušt16_t
 
	$§_pÜt
(cÚ¡ 
§
 *sa)

335 ià(!
§
)

338 
§
->
u
.§.
§_çmy
) {

340 
AF_INET
:

341  
	`Áohs
(
§
->
u
.
š
.
sš_pÜt
);

343 #ifdeà
HAVE_INET6


344 
AF_INET6
:

345  
	`Áohs
(
§
->
u
.
š6
.
sš6_pÜt
);

351 
	}
}

362 
boŞ
 
	$§_is£t
(cÚ¡ 
§
 *§, 
æag
)

364 ià(!
§
)

365  
çl£
;

367 
§
->
u
.§.
§_çmy
) {

369 
AF_INET
:

370 ià(
æag
 & 
SA_ADDR
)

371 ià(
INADDR_ANY
 =ğ
§
->
u
.
š
.
sš_addr
.
s_addr
)

372  
çl£
;

373 ià(
æag
 & 
SA_PORT
)

374 ià(0 =ğ
§
->
u
.
š
.
sš_pÜt
)

375  
çl£
;

378 #ifdeà
HAVE_INET6


379 
AF_INET6
:

380 ià(
æag
 & 
SA_ADDR
)

381 ià(
	`IN6_IS_ADDR_UNSPECIFIED
(&
§
->
u
.
š6
.
sš6_addr
))

382  
çl£
;

383 ià(
æag
 & 
SA_PORT
)

384 ià(0 =ğ
§
->
u
.
š6
.
sš6_pÜt
)

385  
çl£
;

390  
çl£
;

393  
Œue
;

394 
	}
}

405 
ušt32_t
 
	$§_hash
(cÚ¡ 
§
 *§, 
æag
)

407 
ušt32_t
 
v
 = 0;

409 ià(!
§
)

412 
§
->
u
.§.
§_çmy
) {

414 
AF_INET
:

415 ià(
æag
 & 
SA_ADDR
)

416 
v
 +ğ
	`Áohl
(
§
->
u
.
š
.
sš_addr
.
s_addr
);

417 ià(
æag
 & 
SA_PORT
)

418 
v
 +ğ
	`Áohs
(
§
->
u
.
š
.
sš_pÜt
);

421 #ifdeà
HAVE_INET6


422 
AF_INET6
:

423 ià(
æag
 & 
SA_ADDR
) {

424 
ušt32_t
 *
a
 = (ušt32_ˆ*)&
§
->
u
.
š6
.
sš6_addr
;

425 
v
 +ğ
a
[0] ^‡[1] ^‡[2] ^‡[3];

427 ià(
æag
 & 
SA_PORT
)

428 
v
 +ğ
	`Áohs
(
§
->
u
.
š6
.
sš6_pÜt
);

433 
	`DEBUG_WARNING
("§_hash: unknowÀaà%d\n", 
§
->
u
.§.
§_çmy
);

437  
v
;

438 
	}
}

447 
	$§_ıy
(
§
 *
d¡
, cÚ¡ § *
¤c
)

449 ià(!
d¡
 || !
¤c
)

452 
	`memıy
(
d¡
, 
¤c
, (*dst));

453 
	}
}

465 
boŞ
 
	$§_cmp
(cÚ¡ 
§
 *
l
, cÚ¡ § *
r
, 
æag
)

467 ià(!
l
 || !
r
)

468  
çl£
;

470 ià(
l
 =ğ
r
)

471  
Œue
;

473 ià(
l
->
u
.
§
.
§_çmy
 !ğ
r
->u.sa.sa_family)

474  
çl£
;

476 
l
->
u
.
§
.
§_çmy
) {

478 
AF_INET
:

479 ià(
æag
 & 
SA_ADDR
)

480 ià(
l
->
u
.
š
.
sš_addr
.
s_addr
 !ğ
r
->u.in.sin_addr.s_addr)

481  
çl£
;

482 ià(
æag
 & 
SA_PORT
)

483 ià(
l
->
u
.
š
.
sš_pÜt
 !ğ
r
->u.in.sin_port)

484  
çl£
;

487 #ifdeà
HAVE_INET6


488 
AF_INET6
:

489 ià(
æag
 & 
SA_ADDR
)

490 ià(
	`memcmp
(&
l
->
u
.
š6
.
sš6_addr
,

491 &
r
->
u
.
š6
.
sš6_addr
, 16))

492  
çl£
;

493 ià(
æag
 & 
SA_PORT
)

494 ià(
l
->
u
.
š6
.
sš6_pÜt
 !ğ
r
->u.in6.sin6_port)

495  
çl£
;

500  
çl£
;

503  
Œue
;

504 
	}
}

508 
	#IN_IS_ADDR_LINKLOCAL
(
a
) \

509 (((
a
è& 
	`htÚl
(0xffff0000)è=ğhtÚÈ(0xa9ã0000))

	)

519 
boŞ
 
	$§_is_lškloÿl
(cÚ¡ 
§
 *sa)

521 ià(!
§
)

522  
çl£
;

524 
	`§_af
(
§
)) {

526 
AF_INET
:

527  
	`IN_IS_ADDR_LINKLOCAL
(
§
->
u
.
š
.
sš_addr
.
s_addr
);

529 #ifdeà
HAVE_INET6


530 
AF_INET6
:

531  
	`IN6_IS_ADDR_LINKLOCAL
(&
§
->
u
.
š6
.
sš6_addr
);

535  
çl£
;

537 
	}
}

547 
boŞ
 
	$§_is_loİback
(cÚ¡ 
§
 *sa)

549 ià(!
§
)

550  
çl£
;

552 
	`§_af
(
§
)) {

554 
AF_INET
:

555  
INADDR_LOOPBACK
 =ğ
	`Áohl
(
§
->
u
.
š
.
sš_addr
.
s_addr
);

557 #ifdeà
HAVE_INET6


558 
AF_INET6
:

559  
	`IN6_IS_ADDR_LOOPBACK
(&
§
->
u
.
š6
.
sš6_addr
);

563  
çl£
;

565 
	}
}

575 
boŞ
 
	$§_is_ªy
(cÚ¡ 
§
 *sa)

577 ià(!
§
)

578  
çl£
;

580 
	`§_af
(
§
)) {

582 
AF_INET
:

583  
INADDR_ANY
 =ğ
	`Áohl
(
§
->
u
.
š
.
sš_addr
.
s_addr
);

585 #ifdeà
HAVE_INET6


586 
AF_INET6
:

587  
	`IN6_IS_ADDR_UNSPECIFIED
(&
§
->
u
.
š6
.
sš6_addr
);

591  
çl£
;

593 
	}
}

	@re-0.5.6/src/sa/sa.h

9 
Ãt_š‘_Áİ
(cÚ¡ 
§
 *§, *
buf
, 
size
);

10 
Ãt_š‘_±Ú
(cÚ¡ *
addr
, 
§
 *sa);

	@re-0.5.6/src/sdp/attr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_sdp.h
>

14 
	~"sdp.h
"

17 
	ssdp_©Œ
 {

18 
Ë
 
	mË
;

19 *
	mÇme
;

20 *
	mv®
;

24 
	$de¡ruùÜ
(*
¬g
)

26 
sdp_©Œ
 *
©Œ
 = 
¬g
;

28 
	`li¡_uÆšk
(&
©Œ
->
Ë
);

29 
	`mem_d”ef
(
©Œ
->
Çme
);

30 
	`mem_d”ef
(
©Œ
->
v®
);

31 
	}
}

34 
	$sdp_©Œ_add
(
li¡
 *
l¡
, 
¶
 *
Çme
, ¶ *
v®
)

36 
sdp_©Œ
 *
©Œ
;

37 
”r
;

39 
©Œ
 = 
	`mem_z®loc
((*©Œ), 
de¡ruùÜ
);

40 ià(!
©Œ
)

41  
ENOMEM
;

43 
	`li¡_­³nd
(
l¡
, &
©Œ
->
Ë
,‡ttr);

45 
”r
 = 
	`¶_¡rdup
(&
©Œ
->
Çme
,‚ame);

47 ià(
	`¶_is£t
(
v®
))

48 
”r
 |ğ
	`¶_¡rdup
(&
©Œ
->
v®
, val);

50 ià(
”r
)

51 
	`mem_d”ef
(
©Œ
);

53  
”r
;

54 
	}
}

57 
	$sdp_©Œ_addv
(
li¡
 *
l¡
, cÚ¡ *
Çme
, cÚ¡ *
v®
,

58 
va_li¡
 
­
)

60 
sdp_©Œ
 *
©Œ
;

61 
”r
;

63 
©Œ
 = 
	`mem_z®loc
((*©Œ), 
de¡ruùÜ
);

64 ià(!
©Œ
)

65  
ENOMEM
;

67 
	`li¡_­³nd
(
l¡
, &
©Œ
->
Ë
,‡ttr);

69 
”r
 = 
	`¡r_dup
(&
©Œ
->
Çme
,‚ame);

71 ià(
	`¡r_is£t
(
v®
))

72 
”r
 |ğ
	`»_vsd´štf
(&
©Œ
->
v®
, v®, 
­
);

74 ià(
”r
)

75 
	`mem_d”ef
(
©Œ
);

77  
”r
;

78 
	}
}

81 
	$sdp_©Œ_d–
(cÚ¡ 
li¡
 *
l¡
, cÚ¡ *
Çme
)

83 
Ë
 *Ë = 
	`li¡_h—d
(
l¡
);

85 
Ë
) {

87 
sdp_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

89 
Ë
 =†e->
Ãxt
;

91 ià(0 =ğ
	`¡r_ÿ£cmp
(
Çme
, 
©Œ
->name))

92 
	`mem_d”ef
(
©Œ
);

94 
	}
}

97 cÚ¡ *
	$sdp_©Œ_­¶y
(cÚ¡ 
li¡
 *
l¡
, cÚ¡ *
Çme
,

98 
sdp_©Œ_h
 *
©Œh
, *
¬g
)

100 
Ë
 *Ë = 
	`li¡_h—d
(
l¡
);

102 
Ë
) {

104 cÚ¡ 
sdp_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

106 
Ë
 =†e->
Ãxt
;

108 ià(
Çme
 && (!
©Œ
->Çm|| 
	`¡rcmp
(name,‡ttr->name)))

111 ià(!
©Œh
 || 
	`©Œh
(
©Œ
->
Çme
,‡‰r->
v®
?©Œ->v® : "", 
¬g
))

112  
©Œ
->
v®
 ?‡ttr->val : "";

115  
NULL
;

116 
	}
}

119 
	$sdp_©Œ_´št
(
»_´štf
 *
pf
, cÚ¡ 
sdp_©Œ
 *
©Œ
)

121 ià(!
©Œ
)

124 ià(
©Œ
->
v®
)

125  
	`»_h´štf
(
pf
, "a=%s:%s\r\n", 
©Œ
->
Çme
,‡‰r->
v®
);

127  
	`»_h´štf
(
pf
, "a=%s\r\n", 
©Œ
->
Çme
);

128 
	}
}

131 
	$sdp_©Œ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_©Œ
 *
©Œ
)

133 ià(!
©Œ
)

136 ià(
©Œ
->
v®
)

137  
	`»_h´štf
(
pf
, "%s='%s'", 
©Œ
->
Çme
,‡‰r->
v®
);

139  
	`»_h´štf
(
pf
, "%s", 
©Œ
->
Çme
);

140 
	}
}

	@re-0.5.6/src/sdp/format.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_li¡.h
>

13 
	~<»_§.h
>

14 
	~<»_sdp.h
>

15 
	~"sdp.h
"

18 
	$de¡ruùÜ
(*
¬g
)

20 
sdp_fÜm©
 *
fmt
 = 
¬g
;

22 
	`li¡_uÆšk
(&
fmt
->
Ë
);

24 ià(
fmt
->
»f
)

25 
	`mem_d”ef
(
fmt
->
d©a
);

27 
	`mem_d”ef
(
fmt
->
id
);

28 
	`mem_d”ef
(
fmt
->
·¿ms
);

29 
	`mem_d”ef
(
fmt
->
½¬ams
);

30 
	`mem_d”ef
(
fmt
->
Çme
);

31 
	}
}

52 
	$sdp_fÜm©_add
(
sdp_fÜm©
 **
fm
, 
sdp_medŸ
 *
m
,

53 
boŞ
 
´•’d
, cÚ¡ *
id
, cÚ¡ *
Çme
,

54 
ušt32_t
 
¤©e
, 
ušt8_t
 
ch
, 
sdp_fm_’c_h
 *
’ch
,

55 
sdp_fm_cmp_h
 *
cmph
, *
d©a
, 
boŞ
 
»f
,

56 cÚ¡ *
·¿ms
, ...)

58 
sdp_fÜm©
 *
fmt
;

59 
”r
;

61 ià(!
m
)

62  
EINVAL
;

64 ià(!
id
 && (
m
->
dyÅt
 > 
RTP_DYNPT_END
))

65  
ERANGE
;

67 
fmt
 = 
	`mem_z®loc
((*fmt), 
de¡ruùÜ
);

68 ià(!
fmt
)

69  
ENOMEM
;

71 ià(
´•’d
)

72 
	`li¡_´•’d
(&
m
->
lfm
, &
fmt
->
Ë
, fmt);

74 
	`li¡_­³nd
(&
m
->
lfm
, &
fmt
->
Ë
, fmt);

76 ià(
id
)

77 
”r
 = 
	`¡r_dup
(&
fmt
->
id
, id);

79 
”r
 = 
	`»_sd´štf
(&
fmt
->
id
, "%i", 
m
->
dyÅt
++);

80 ià(
”r
)

81 
out
;

83 ià(
Çme
) {

84 
”r
 = 
	`¡r_dup
(&
fmt
->
Çme
,‚ame);

85 ià(
”r
)

86 
out
;

89 ià(
·¿ms
) {

90 
va_li¡
 
­
;

92 
	`va_¡¬t
(
­
, 
·¿ms
);

93 
”r
 = 
	`»_vsd´štf
(&
fmt
->
·¿ms
,…¬ams, 
­
);

94 
	`va_’d
(
­
);

96 ià(
”r
)

97 
out
;

100 
fmt
->
±
 = 
	`©oi
(fmt->
id
);

101 
fmt
->
¤©e
 = srate;

102 
fmt
->
ch
 = ch;

103 
fmt
->
’ch
 =ƒnch;

104 
fmt
->
cmph
 = cmph;

105 
fmt
->
d©a
 = 
»f
 ? 
	`mem_»f
(data) : data;

106 
fmt
->
»f
 =„ef;

107 
fmt
->
sup
 = 
Œue
;

109 
out
:

110 ià(
”r
)

111 
	`mem_d”ef
(
fmt
);

112 ià(
fm
)

113 *
fm
 = 
fmt
;

115  
”r
;

116 
	}
}

119 
	$sdp_fÜm©_¿dd
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *
id
)

121 
sdp_fÜm©
 *
fmt
;

122 
”r
;

124 ià(!
m
 || !
id
)

125  
EINVAL
;

127 
fmt
 = 
	`mem_z®loc
((*fmt), 
de¡ruùÜ
);

128 ià(!
fmt
)

129  
ENOMEM
;

131 
	`li¡_­³nd
(&
m
->
rfm
, &
fmt
->
Ë
, fmt);

133 
”r
 = 
	`¶_¡rdup
(&
fmt
->
id
, id);

134 ià(
”r
)

135 
out
;

137 
fmt
->
±
 = 
	`©oi
(fmt->
id
);

139 
out
:

140 ià(
”r
)

141 
	`mem_d”ef
(
fmt
);

143  
”r
;

144 
	}
}

147 
sdp_fÜm©
 *
	$sdp_fÜm©_fšd
(cÚ¡ 
li¡
 *
l¡
, cÚ¡ 
¶
 *
id
)

149 
Ë
 *le;

151 ià(!
l¡
 || !
id
)

152  
NULL
;

154 
Ë
=
l¡
->
h—d
;†e;†eöe->
Ãxt
) {

156 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

158 ià(
	`¶_¡rcmp
(
id
, 
fmt
->id))

161  
fmt
;

164  
NULL
;

165 
	}
}

176 
	$sdp_fÜm©_£t_·¿ms
(
sdp_fÜm©
 *
fmt
, cÚ¡ *
·¿ms
, ...)

178 
”r
 = 0;

180 ià(!
fmt
)

181  
EINVAL
;

183 
fmt
->
·¿ms
 = 
	`mem_d”ef
(fmt->params);

185 ià(
·¿ms
) {

186 
va_li¡
 
­
;

188 
	`va_¡¬t
(
­
, 
·¿ms
);

189 
”r
 = 
	`»_vsd´štf
(&
fmt
->
·¿ms
,…¬ams, 
­
);

190 
	`va_’d
(
­
);

193  
”r
;

194 
	}
}

205 
boŞ
 
	$sdp_fÜm©_cmp
(cÚ¡ 
sdp_fÜm©
 *
fmt1
,

206 cÚ¡ 
sdp_fÜm©
 *
fmt2
)

208 ià(!
fmt1
 || !
fmt2
)

209  
çl£
;

211 ià(
fmt1
->
±
 < 
RTP_DYNPT_START
 && 
fmt2
->pt < RTP_DYNPT_START) {

213 ià(!
fmt1
->
id
 || !
fmt2
->id)

214  
çl£
;

216  
	`¡rcmp
(
fmt1
->
id
, 
fmt2
->idè? 
çl£
 : 
Œue
;

219 ià(
	`¡r_ÿ£cmp
(
fmt1
->
Çme
, 
fmt2
->name))

220  
çl£
;

222 ià(
fmt1
->
¤©e
 !ğ
fmt2
->srate)

223  
çl£
;

225 ià(
fmt1
->
ch
 !ğ
fmt2
->ch)

226  
çl£
;

228 ià(
fmt1
->
cmph
 && !fmt1->
	`cmph
(fmt1->
·¿ms
, 
fmt2
->·¿ms, fmt1->
d©a
))

229  
çl£
;

231 ià(
fmt2
->
cmph
 && !fmt2->
	`cmph
(fmt2->
·¿ms
, 
fmt1
->·¿ms, fmt2->
d©a
))

232  
çl£
;

234  
Œue
;

235 
	}
}

246 
	$sdp_fÜm©_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_fÜm©
 *
fmt
)

248 
”r
;

250 ià(!
fmt
)

253 
”r
 = 
	`»_h´štf
(
pf
, "%3s", 
fmt
->
id
);

255 ià(
fmt
->
Çme
)

256 
”r
 |ğ
	`»_h´štf
(
pf
, " %s/%u/%u",

257 
fmt
->
Çme
, fmt->
¤©e
, fmt->
ch
);

259 ià(
fmt
->
·¿ms
)

260 
”r
 |ğ
	`»_h´štf
(
pf
, " (%s)", 
fmt
->
·¿ms
);

262 ià(
fmt
->
sup
)

263 
”r
 |ğ
	`»_h´štf
(
pf
, " *");

265  
”r
;

266 
	}
}

	@re-0.5.6/src/sdp/media.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_li¡.h
>

13 
	~<»_§.h
>

14 
	~<»_sdp.h
>

15 
	~"sdp.h
"

18 
	$de¡ruùÜ
(*
¬g
)

20 
sdp_medŸ
 *
m
 = 
¬g
;

21 
i
;

23 
	`li¡_æush
(&
m
->
lfm
);

24 
	`li¡_æush
(&
m
->
rfm
);

25 
	`li¡_æush
(&
m
->
¿‰¾
);

26 
	`li¡_æush
(&
m
->
Ï‰¾
);

28 ià(
m
->
Ë
.
li¡
) {

29 
m
->
di§bËd
 = 
Œue
;

30 
m
->
’ch
 = 
NULL
;

31 
	`mem_»f
(
m
);

35 
i
=0; i<
	`ARRAY_SIZE
(
m
->
´Ùov
); i++)

36 
	`mem_d”ef
(
m
->
´Ùov
[
i
]);

38 
	`li¡_uÆšk
(&
m
->
Ë
);

39 
	`mem_d”ef
(
m
->
Çme
);

40 
	`mem_d”ef
(
m
->
´Ùo
);

41 
	`mem_d”ef
(
m
->
u´Ùo
);

42 
	}
}

45 
	$medŸ_®loc
(
sdp_medŸ
 **
mp
, 
li¡
 *list)

47 
sdp_medŸ
 *
m
;

48 
i
;

50 
m
 = 
	`mem_z®loc
((*m), 
de¡ruùÜ
);

51 ià(!
m
)

52  
ENOMEM
;

54 
	`li¡_­³nd
(
li¡
, &
m
->
Ë
, m);

56 
m
->
ldœ
 = 
SDP_SENDRECV
;

57 
m
->
rdœ
 = 
SDP_SENDRECV
;

58 
m
->
dyÅt
 = 
RTP_DYNPT_START
;

60 
	`§_š™
(&
m
->
Ïddr
, 
AF_INET
);

61 
	`§_š™
(&
m
->
¿ddr
, 
AF_INET
);

62 
	`§_š™
(&
m
->
Ïddr_¹ı
, 
AF_INET
);

63 
	`§_š™
(&
m
->
¿ddr_¹ı
, 
AF_INET
);

65 
i
=0; i<
SDP_BANDWIDTH_MAX
; i++) {

66 
m
->
lbwv
[
i
] = -1;

67 
m
->
rbwv
[
i
] = -1;

70 *
mp
 = 
m
;

73 
	}
}

87 
	$sdp_medŸ_add
(
sdp_medŸ
 **
mp
, 
sdp_£ssiÚ
 *
£ss
,

88 cÚ¡ *
Çme
, 
ušt16_t
 
pÜt
, cÚ¡ *
´Ùo
)

90 
sdp_medŸ
 *
m
;

91 
”r
;

93 ià(!
£ss
 || !
Çme
 || !
´Ùo
)

94  
EINVAL
;

96 
”r
 = 
	`medŸ_®loc
(&
m
, &
£ss
->
lmedŸl
);

97 ià(
”r
)

98  
”r
;

100 
”r
 = 
	`¡r_dup
(&
m
->
Çme
,‚ame);

101 
”r
 |ğ
	`¡r_dup
(&
m
->
´Ùo
,…roto);

102 ià(
”r
)

103 
out
;

105 
	`§_£t_pÜt
(&
m
->
Ïddr
, 
pÜt
);

107 
out
:

108 ià(
”r
)

109 
	`mem_d”ef
(
m
);

110 ià(
mp
)

111 *
mp
 = 
m
;

113  
”r
;

114 
	}
}

127 
	$sdp_medŸ_¿dd
(
sdp_medŸ
 **
mp
, 
sdp_£ssiÚ
 *
£ss
,

128 cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
´Ùo
)

130 
sdp_medŸ
 *
m
;

131 
”r
;

133 ià(!
mp
 || !
£ss
 || !
Çme
 || !
´Ùo
)

134  
EINVAL
;

136 
”r
 = 
	`medŸ_®loc
(&
m
, &
£ss
->
medŸl
);

137 ià(
”r
)

138  
”r
;

140 
m
->
di§bËd
 = 
Œue
;

142 
”r
 = 
	`¶_¡rdup
(&
m
->
Çme
,‚ame);

143 
”r
 |ğ
	`¶_¡rdup
(&
m
->
´Ùo
,…roto);

145 ià(
”r
)

146 
	`mem_d”ef
(
m
);

148 *
mp
 = 
m
;

150  
”r
;

151 
	}
}

159 
	$sdp_medŸ_¼e£t
(
sdp_medŸ
 *
m
)

161 
i
;

163 ià(!
m
)

166 
	`§_š™
(&
m
->
¿ddr
, 
AF_INET
);

167 
	`§_š™
(&
m
->
¿ddr_¹ı
, 
AF_INET
);

169 
	`li¡_æush
(&
m
->
rfm
);

170 
	`li¡_æush
(&
m
->
¿‰¾
);

172 
m
->
rdœ
 = 
SDP_SENDRECV
;

174 
i
=0; i<
SDP_BANDWIDTH_MAX
; i++)

175 
m
->
rbwv
[
i
] = -1;

176 
	}
}

188 
boŞ
 
	$sdp_medŸ_´Ùo_cmp
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *
´Ùo
,

189 
boŞ
 
upd©e
)

191 
i
;

193 ià(!
m
 || !
´Ùo
)

194  
çl£
;

196 ià(!
	`¶_¡rcmp
(
´Ùo
, 
m
->proto))

197  
Œue
;

199 
i
=0; i<
	`ARRAY_SIZE
(
m
->
´Ùov
); i++) {

201 ià(!
m
->
´Ùov
[
i
] || 
	`¶_¡rcmp
(
´Ùo
, m->protov[i]))

204 ià(
upd©e
) {

205 
	`mem_d”ef
(
m
->
´Ùo
);

206 
m
->
´Ùo
 = 
	`mem_»f
(m->
´Ùov
[
i
]);

209  
Œue
;

212  
çl£
;

213 
	}
}

226 
sdp_medŸ
 *
	$sdp_medŸ_fšd
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

227 cÚ¡ 
¶
 *
Çme
,

228 cÚ¡ 
¶
 *
´Ùo
,

229 
boŞ
 
upd©e_´Ùo
)

231 
Ë
 *le;

233 ià(!
£ss
 || !
Çme
 || !
´Ùo
)

234  
NULL
;

236 
Ë
=
£ss
->
lmedŸl
.
h—d
;†e;†eöe->
Ãxt
) {

238 
sdp_medŸ
 *
m
 = 
Ë
->
d©a
;

240 ià(
	`¶_¡rcmp
(
Çme
, 
m
->name))

243 ià(!
	`sdp_medŸ_´Ùo_cmp
(
m
, 
´Ùo
, 
upd©e_´Ùo
))

246  
m
;

249  
NULL
;

250 
	}
}

259 
	$sdp_medŸ_®ign_fÜm©s
(
sdp_medŸ
 *
m
, 
boŞ
 
ofãr
)

261 
sdp_fÜm©
 *
rfmt
, *
lfmt
;

262 
Ë
 *
¾e
, *
Îe
;

264 ià(!
m
 || m->
di§bËd
 || !
	`§_pÜt
(&m->
¿ddr
è|| m->
fmt_ignÜe
)

267 
Îe
=
m
->
lfm
.
h—d
;†Ë;†ËöË->
Ãxt
) {

269 
lfmt
 = 
Îe
->
d©a
;

271 
lfmt
->
½¬ams
 = 
	`mem_d”ef
(lfmt->rparams);

272 
lfmt
->
sup
 = 
çl£
;

275 
¾e
=
m
->
rfm
.
h—d
;„Ë;„ËôË->
Ãxt
) {

277 
rfmt
 = 
¾e
->
d©a
;

279 
Îe
=
m
->
lfm
.
h—d
;†Ë;†ËöË->
Ãxt
) {

281 
lfmt
 = 
Îe
->
d©a
;

283 ià(
	`sdp_fÜm©_cmp
(
lfmt
, 
rfmt
))

287 ià(!
Îe
) {

288 
rfmt
->
sup
 = 
çl£
;

292 
	`mem_d”ef
(
lfmt
->
½¬ams
);

293 
lfmt
->
½¬ams
 = 
	`mem_»f
(
rfmt
->
·¿ms
);

295 
lfmt
->
sup
 = 
Œue
;

296 
rfmt
->
sup
 = 
Œue
;

298 ià(
rfmt
->
»f
)

299 
rfmt
->
d©a
 = 
	`mem_d”ef
(rfmt->data);

301 
rfmt
->
d©a
 = 
NULL
;

303 ià(
lfmt
->
»f
)

304 
rfmt
->
d©a
 = 
	`mem_»f
(
lfmt
->data);

306 
rfmt
->
d©a
 = 
lfmt
->data;

308 
rfmt
->
»f
 = 
lfmt
->ref;

310 ià(
ofãr
) {

311 
	`mem_d”ef
(
lfmt
->
id
);

312 
lfmt
->
id
 = 
	`mem_»f
(
rfmt
->id);

313 
lfmt
->
±
 = 
	`©oi
Öfmt->
id
 ?†fmt->id : "");

315 
	`li¡_uÆšk
(&
lfmt
->
Ë
);

316 
	`li¡_­³nd
(&
m
->
lfm
, &
lfmt
->
Ë
,†fmt);

320 ià(
ofãr
) {

322 
Îe
=
m
->
lfm
.

;†le; ) {

324 
lfmt
 = 
Îe
->
d©a
;

326 
Îe
 =†Ë->
´ev
;

328 ià(!
lfmt
->
sup
) {

329 
	`li¡_uÆšk
(&
lfmt
->
Ë
);

330 
	`li¡_­³nd
(&
m
->
lfm
, &
lfmt
->
Ë
,†fmt);

334 
	}
}

345 
	$sdp_medŸ_£t_®t_´Ùos
(
sdp_medŸ
 *
m
, 
´Ùoc
, ...)

347 cÚ¡ *
´Ùo
;

348 
”r
 = 0;

349 
i
;

350 
va_li¡
 
­
;

352 ià(!
m
)

353  
EINVAL
;

355 
	`va_¡¬t
(
­
, 
´Ùoc
);

357 
i
=0; i<
	`ARRAY_SIZE
(
m
->
´Ùov
); i++) {

359 
m
->
´Ùov
[
i
] = 
	`mem_d”ef
(m->protov[i]);

361 ià(
i
 >ğ
´Ùoc
)

364 
´Ùo
 = 
	`va_¬g
(
­
, const *);

365 ià(
´Ùo
)

366 
”r
 |ğ
	`¡r_dup
(&
m
->
´Ùov
[
i
], 
´Ùo
);

369 
	`va_’d
(
­
);

371  
”r
;

372 
	}
}

382 
	$sdp_medŸ_£t_’code_hªdËr
(
sdp_medŸ
 *
m
, 
sdp_medŸ_’c_h
 *
’ch
,

383 *
¬g
)

385 ià(!
m
)

388 
m
->
’ch
 =ƒnch;

389 
m
->
¬g
 =‡rg;

390 
	}
}

399 
	$sdp_medŸ_£t_fmt_ignÜe
(
sdp_medŸ
 *
m
, 
boŞ
 
fmt_ignÜe
)

401 ià(!
m
)

404 
m
->
fmt_ignÜe
 = fmt_ignore;

405 
	}
}

414 
	$sdp_medŸ_£t_di§bËd
(
sdp_medŸ
 *
m
, 
boŞ
 
di§bËd
)

416 ià(!
m
)

419 
m
->
di§bËd
 = disabled;

420 
	}
}

429 
	$sdp_medŸ_£t_ÍÜt
(
sdp_medŸ
 *
m
, 
ušt16_t
 
pÜt
)

431 ià(!
m
)

434 
	`§_£t_pÜt
(&
m
->
Ïddr
, 
pÜt
);

435 
	}
}

444 
	$sdp_medŸ_£t_Ïddr
(
sdp_medŸ
 *
m
, cÚ¡ 
§
 *
Ïddr
)

446 ià(!
m
 || !
Ïddr
)

449 
m
->
Ïddr
 = *laddr;

450 
	}
}

460 
	$sdp_medŸ_£t_lbªdwidth
(
sdp_medŸ
 *
m
, 
sdp_bªdwidth
 
ty³
,

461 
št32_t
 
bw
)

463 ià(!
m
 || 
ty³
 >ğ
SDP_BANDWIDTH_MAX
)

466 
m
->
lbwv
[
ty³
] = 
bw
;

467 
	}
}

476 
	$sdp_medŸ_£t_ÍÜt_¹ı
(
sdp_medŸ
 *
m
, 
ušt16_t
 
pÜt
)

478 ià(!
m
)

481 
	`§_£t_pÜt
(&
m
->
Ïddr_¹ı
, 
pÜt
);

482 
	}
}

491 
	$sdp_medŸ_£t_Ïddr_¹ı
(
sdp_medŸ
 *
m
, cÚ¡ 
§
 *
Ïddr
)

493 ià(!
m
 || !
Ïddr
)

496 
m
->
Ïddr_¹ı
 = *
Ïddr
;

497 
	}
}

506 
	$sdp_medŸ_£t_ldœ
(
sdp_medŸ
 *
m
, 
sdp_dœ
 
dœ
)

508 ià(!
m
)

511 
m
->
ldœ
 = 
dœ
;

512 
	}
}

525 
	$sdp_medŸ_£t_Ï‰r
(
sdp_medŸ
 *
m
, 
boŞ
 
»¶aû
,

526 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, ...)

528 
va_li¡
 
­
;

529 
”r
;

531 ià(!
m
 || !
Çme
)

532  
EINVAL
;

534 ià(
»¶aû
)

535 
	`sdp_©Œ_d–
(&
m
->
Ï‰¾
, 
Çme
);

537 
	`va_¡¬t
(
­
, 
v®ue
);

538 
”r
 = 
	`sdp_©Œ_addv
(&
m
->
Ï‰¾
, 
Çme
, 
v®ue
, 
­
);

539 
	`va_’d
(
­
);

541  
”r
;

542 
	}
}

551 
	$sdp_medŸ_d–_Ï‰r
(
sdp_medŸ
 *
m
, cÚ¡ *
Çme
)

553 ià(!
m
 || !
Çme
)

556 
	`sdp_©Œ_d–
(&
m
->
Ï‰¾
, 
Çme
);

557 
	}
}

560 cÚ¡ *
	$sdp_medŸ_´Ùo
(cÚ¡ 
sdp_medŸ
 *
m
)

562  
m
 ? m->
´Ùo
 : 
NULL
;

563 
	}
}

573 
ušt16_t
 
	$sdp_medŸ_½Üt
(cÚ¡ 
sdp_medŸ
 *
m
)

575  
m
 ? 
	`§_pÜt
(&m->
¿ddr
) : 0;

576 
	}
}

586 cÚ¡ 
§
 *
	$sdp_medŸ_¿ddr
(cÚ¡ 
sdp_medŸ
 *
m
)

588  
m
 ? &m->
¿ddr
 : 
NULL
;

589 
	}
}

599 cÚ¡ 
§
 *
	$sdp_medŸ_Ïddr
(cÚ¡ 
sdp_medŸ
 *
m
)

601  
m
 ? &m->
Ïddr
 : 
NULL
;

602 
	}
}

611 
	$sdp_medŸ_¿ddr_¹ı
(cÚ¡ 
sdp_medŸ
 *
m
, 
§
 *
¿ddr
)

613 ià(!
m
 || !
¿ddr
)

616 ià(
	`§_is£t
(&
m
->
¿ddr_¹ı
, 
SA_ALL
)) {

617 *
¿ddr
 = 
m
->
¿ddr_¹ı
;

619 ià(
	`§_is£t
(&
m
->
¿ddr_¹ı
, 
SA_PORT
)) {

620 *
¿ddr
 = 
m
->raddr;

621 
	`§_£t_pÜt
(
¿ddr
, 
	`§_pÜt
(&
m
->
¿ddr_¹ı
));

624 
ušt16_t
 
pÜt
 = 
	`§_pÜt
(&
m
->
¿ddr
);

626 *
¿ddr
 = 
m
->raddr;

627 
	`§_£t_pÜt
(
¿ddr
, 
pÜt
 ?…ort + 1 : 0);

629 
	}
}

640 
št32_t
 
	$sdp_medŸ_rbªdwidth
(cÚ¡ 
sdp_medŸ
 *
m
,

641 
sdp_bªdwidth
 
ty³
)

643 ià(!
m
 || 
ty³
 >ğ
SDP_BANDWIDTH_MAX
)

646  
m
->
rbwv
[
ty³
];

647 
	}
}

657 
sdp_dœ
 
	$sdp_medŸ_ldœ
(cÚ¡ 
sdp_medŸ
 *
m
)

659  
m
 ? m->
ldœ
 : 
SDP_INACTIVE
;

660 
	}
}

670 
sdp_dœ
 
	$sdp_medŸ_rdœ
(cÚ¡ 
sdp_medŸ
 *
m
)

672  
m
 ? m->
rdœ
 : 
SDP_INACTIVE
;

673 
	}
}

683 
sdp_dœ
 
	$sdp_medŸ_dœ
(cÚ¡ 
sdp_medŸ
 *
m
)

685  
m
 ? (
sdp_dœ
)(m->
ldœ
 & m->
rdœ
è: 
SDP_INACTIVE
;

686 
	}
}

697 cÚ¡ 
sdp_fÜm©
 *
	$sdp_medŸ_lfÜm©
(cÚ¡ 
sdp_medŸ
 *
m
, 
±
)

699 
Ë
 *le;

701 ià(!
m
)

702  
NULL
;

704 
Ë
=
m
->
lfm
.
h—d
;†e;†eöe->
Ãxt
) {

706 cÚ¡ 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

708 ià(
±
 =ğ
fmt
->pt)

709  
fmt
;

712  
NULL
;

713 
	}
}

724 cÚ¡ 
sdp_fÜm©
 *
	$sdp_medŸ_rfÜm©
(cÚ¡ 
sdp_medŸ
 *
m
,

725 cÚ¡ *
Çme
)

727 
Ë
 *le;

729 ià(!
m
 || !
	`§_pÜt
(&m->
¿ddr
))

730  
NULL
;

732 
Ë
=
m
->
rfm
.
h—d
;†e;†eöe->
Ãxt
) {

734 cÚ¡ 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

736 ià(!
fmt
->
sup
)

739 ià(
Çme
 && 
	`¡r_ÿ£cmp
Òame, 
fmt
->name))

742  
fmt
;

745  
NULL
;

746 
	}
}

762 
sdp_fÜm©
 *
	$sdp_medŸ_fÜm©
(cÚ¡ 
sdp_medŸ
 *
m
,

763 
boŞ
 
loÿl
, cÚ¡ *
id
,

764 
±
, cÚ¡ *
Çme
,

765 
št32_t
 
¤©e
, 
št8_t
 
ch
)

767  
	`sdp_medŸ_fÜm©_­¶y
(
m
, 
loÿl
, 
id
, 
±
, 
Çme
, 
¤©e
, 
ch
,

768 
NULL
, NULL);

769 
	}
}

787 
sdp_fÜm©
 *
	$sdp_medŸ_fÜm©_­¶y
(cÚ¡ 
sdp_medŸ
 *
m
,

788 
boŞ
 
loÿl
, cÚ¡ *
id
,

789 
±
, cÚ¡ *
Çme
,

790 
št32_t
 
¤©e
, 
št8_t
 
ch
,

791 
sdp_fÜm©_h
 *
fmth
, *
¬g
)

793 
Ë
 *le;

795 ià(!
m
)

796  
NULL
;

798 
Ë
 = 
loÿl
 ? 
m
->
lfm
.
h—d
 : m->
rfm
.head;

800 
Ë
) {

802 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

804 
Ë
 =†e->
Ãxt
;

806 ià(
id
 && (!
fmt
->id || 
	`¡rcmp
(id, fmt->id)))

809 ià(
±
 >ğ0 &&…ˆ!ğ
fmt
->pt)

812 ià(
Çme
 && 
	`¡r_ÿ£cmp
Òame, 
fmt
->name))

815 ià(
¤©e
 >ğ0 && (
ušt32_t
)¤©!ğ
fmt
->srate)

818 ià(
ch
 >ğ0 && (
ušt8_t
)ch !ğ
fmt
->ch)

821 ià(!
fmth
 || 
	`fmth
(
fmt
, 
¬g
))

822  
fmt
;

825  
NULL
;

826 
	}
}

837 cÚ¡ 
li¡
 *
	$sdp_medŸ_fÜm©_l¡
(cÚ¡ 
sdp_medŸ
 *
m
, 
boŞ
 
loÿl
)

839 ià(!
m
)

840  
NULL
;

842  
loÿl
 ? &
m
->
lfm
 : &m->
rfm
;

843 
	}
}

854 cÚ¡ *
	$sdp_medŸ_¿‰r
(cÚ¡ 
sdp_medŸ
 *
m
, cÚ¡ *
Çme
)

856 ià(!
m
 || !
Çme
)

857  
NULL
;

859  
	`sdp_©Œ_­¶y
(&
m
->
¿‰¾
, 
Çme
, 
NULL
, NULL);

860 
	}
}

872 cÚ¡ *
	$sdp_medŸ_£ssiÚ_¿‰r
(cÚ¡ 
sdp_medŸ
 *
m
,

873 cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

874 cÚ¡ *
Çme
)

876 cÚ¡ *
v®
;

878 
v®
 = 
	`sdp_medŸ_¿‰r
(
m
, 
Çme
);

879 ià(!
v®
)

880 
v®
 = 
	`sdp_£ssiÚ_¿‰r
(
£ss
, 
Çme
);

882  
v®
;

883 
	}
}

896 cÚ¡ *
	$sdp_medŸ_¿‰r_­¶y
(cÚ¡ 
sdp_medŸ
 *
m
, cÚ¡ *
Çme
,

897 
sdp_©Œ_h
 *
©Œh
, *
¬g
)

899 ià(!
m
)

900  
NULL
;

902  
	`sdp_©Œ_­¶y
(&
m
->
¿‰¾
, 
Çme
, 
©Œh
, 
¬g
);

903 
	}
}

913 cÚ¡ *
	$sdp_medŸ_Çme
(cÚ¡ 
sdp_medŸ
 *
m
)

915  
m
 ? m->
Çme
 : 
NULL
;

916 
	}
}

927 
	$sdp_medŸ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_medŸ
 *
m
)

929 
Ë
 *le;

930 
”r
;

932 ià(!
m
)

935 
”r
 = 
	`»_h´štf
(
pf
, "% %s\n", 
m
->
Çme
, m->
´Ùo
);

937 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal formats:\n");

939 
Ë
=
m
->
lfm
.
h—d
;†e;†eöe->
Ãxt
)

940 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_fÜm©_debug
, 
Ë
->
d©a
);

942 
”r
 |ğ
	`»_h´štf
(
pf
, "„emote formats:\n");

944 
Ë
=
m
->
rfm
.
h—d
;†e;†eöe->
Ãxt
)

945 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_fÜm©_debug
, 
Ë
->
d©a
);

947 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal‡ttributes:\n");

949 
Ë
=
m
->
Ï‰¾
.
h—d
;†e;†eöe->
Ãxt
)

950 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_©Œ_debug
, 
Ë
->
d©a
);

952 
”r
 |ğ
	`»_h´štf
(
pf
, "„emote‡ttributes:\n");

954 
Ë
=
m
->
¿‰¾
.
h—d
;†e;†eöe->
Ãxt
)

955 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_©Œ_debug
, 
Ë
->
d©a
);

957  
”r
;

958 
	}
}

	@re-0.5.6/src/sdp/msg.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_sdp.h
>

13 
	~"sdp.h
"

16 
	$©Œ_decode_fm
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *pl)

18 
sdp_fÜm©
 *
fmt
;

19 
¶
 
id
, 
·¿ms
;

21 ià(!
m
)

24 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^ ]+ [^]*", &
id
, &
·¿ms
))

25  
EBADMSG
;

27 
fmt
 = 
	`sdp_fÜm©_fšd
(&
m
->
rfm
, &
id
);

28 ià(!
fmt
)

31 
fmt
->
·¿ms
 = 
	`mem_d”ef
(fmt->params);

33  
	`¶_¡rdup
(&
fmt
->
·¿ms
, &params);

34 
	}
}

37 
	$©Œ_decode_¹ı
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *pl)

39 
¶
 
pÜt
, 
addr
;

40 
”r
 = 0;

42 ià(!
m
)

45 ià(!
	`»_»gex
(
¶
->
p
,…l->
l
, "[0-9]+ IN IP[46]1 [^ ]+",

46 &
pÜt
, 
NULL
, &
addr
)) {

47 ()
	`§_£t
(&
m
->
¿ddr_¹ı
, &
addr
, 
	`¶_u32
(&
pÜt
));

49 ià(!
	`»_»gex
(
¶
->
p
,…l->
l
, "[0-9]+", &
pÜt
)) {

50 
	`§_£t_pÜt
(&
m
->
¿ddr_¹ı
, 
	`¶_u32
(&
pÜt
));

53 
”r
 = 
EBADMSG
;

55  
”r
;

56 
	}
}

59 
	$©Œ_decode_¹pm­
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *pl)

61 
¶
 
id
, 
Çme
, 
¤©e
, 
ch
;

62 
sdp_fÜm©
 *
fmt
;

63 
”r
;

65 ià(!
m
)

68 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^ ]+ [^/]+/[0-9]+[/]*[^]*",

69 &
id
, &
Çme
, &
¤©e
, 
NULL
, &
ch
))

70  
EBADMSG
;

72 
fmt
 = 
	`sdp_fÜm©_fšd
(&
m
->
rfm
, &
id
);

73 ià(!
fmt
)

76 
fmt
->
Çme
 = 
	`mem_d”ef
(fmt->name);

78 
”r
 = 
	`¶_¡rdup
(&
fmt
->
Çme
, &name);

79 ià(
”r
)

80  
”r
;

82 
fmt
->
¤©e
 = 
	`¶_u32
(&srate);

83 
fmt
->
ch
 = ch.
l
 ? 
	`¶_u32
(&ch) : 1;

86 
	}
}

89 
	$©Œ_decode
(
sdp_£ssiÚ
 *
£ss
, 
sdp_medŸ
 *
m
,

90 
sdp_dœ
 *
dœ
, cÚ¡ 
¶
 *pl)

92 
¶
 
Çme
, 
v®
;

93 
”r
 = 0;

95 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^:]+:[^]+", &
Çme
, &
v®
)) {

96 
Çme
 = *
¶
;

97 
v®
 = 
¶_nuÎ
;

100 ià(!
	`¶_¡rcmp
(&
Çme
, "fmtp"))

101 
”r
 = 
	`©Œ_decode_fm
(
m
, &
v®
);

103 ià(!
	`¶_¡rcmp
(&
Çme
, "inactive"))

104 *
dœ
 = 
SDP_INACTIVE
;

106 ià(!
	`¶_¡rcmp
(&
Çme
, "recvonly"))

107 *
dœ
 = 
SDP_SENDONLY
;

109 ià(!
	`¶_¡rcmp
(&
Çme
, "rtcp"))

110 
”r
 = 
	`©Œ_decode_¹ı
(
m
, &
v®
);

112 ià(!
	`¶_¡rcmp
(&
Çme
, "rtpmap"))

113 
”r
 = 
	`©Œ_decode_¹pm­
(
m
, &
v®
);

115 ià(!
	`¶_¡rcmp
(&
Çme
, "sendonly"))

116 *
dœ
 = 
SDP_RECVONLY
;

118 ià(!
	`¶_¡rcmp
(&
Çme
, "sendrecv"))

119 *
dœ
 = 
SDP_SENDRECV
;

122 
”r
 = 
	`sdp_©Œ_add
(
m
 ? &m->
¿‰¾
 : &
£ss
->rattrl,

123 &
Çme
, &
v®
);

125  
”r
;

126 
	}
}

129 
	$bªdwidth_decode
(
št32_t
 *
bwv
, cÚ¡ 
¶
 *pl)

131 
¶
 
ty³
, 
bw
;

133 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^:]+:[0-9]+", &
ty³
, &
bw
))

134  
EBADMSG
;

136 ià(!
	`¶_¡rcmp
(&
ty³
, "CT"))

137 
bwv
[
SDP_BANDWIDTH_CT
] = 
	`¶_u32
(&
bw
);

139 ià(!
	`¶_¡rcmp
(&
ty³
, "AS"))

140 
bwv
[
SDP_BANDWIDTH_AS
] = 
	`¶_u32
(&
bw
);

142 ià(!
	`¶_¡rcmp
(&
ty³
, "RS"))

143 
bwv
[
SDP_BANDWIDTH_RS
] = 
	`¶_u32
(&
bw
);

145 ià(!
	`¶_¡rcmp
(&
ty³
, "RR"))

146 
bwv
[
SDP_BANDWIDTH_RR
] = 
	`¶_u32
(&
bw
);

148 ià(!
	`¶_¡rcmp
(&
ty³
, "TIAS"))

149 
bwv
[
SDP_BANDWIDTH_TIAS
] = 
	`¶_u32
(&
bw
);

152 
	}
}

155 
	$cÚn_decode
(
§
 *§, cÚ¡ 
¶
 *pl)

157 
¶
 
v
;

159 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "IN IP[46]1 [^ ]+", 
NULL
, &
v
))

160  
EBADMSG
;

162 ()
	`§_£t
(
§
, &
v
, 
	`§_pÜt
(sa));

165 
	}
}

168 
	$medŸ_decode
(
sdp_medŸ
 **
mp
, 
sdp_£ssiÚ
 *
£ss
,

169 
boŞ
 
ofãr
, cÚ¡ 
¶
 *pl)

171 
¶
 
Çme
, 
pÜt
, 
´Ùo
, 
fmtv
, 
fmt
;

172 
sdp_medŸ
 *
m
;

173 
”r
;

175 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[a-z]+ [^ ]+ [^ ]+[^]*",

176 &
Çme
, &
pÜt
, &
´Ùo
, &
fmtv
))

177  
EBADMSG
;

179 
m
 = 
	`li¡_Ëd©a
(*
mp
 ? (*mp)->
Ë
.
Ãxt
 : 
£ss
->
medŸl
.
h—d
);

180 ià(!
m
) {

181 ià(!
ofãr
)

182  
EPROTO
;

184 
m
 = 
	`sdp_medŸ_fšd
(
£ss
, &
Çme
, &
´Ùo
, 
Œue
);

185 ià(!
m
) {

186 
”r
 = 
	`sdp_medŸ_¿dd
(&
m
, 
£ss
, &
Çme
, &
´Ùo
);

187 ià(
”r
)

188  
”r
;

191 
	`li¡_uÆšk
(&
m
->
Ë
);

192 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

195 
m
->
u´Ùo
 = 
	`mem_d”ef
(m->uproto);

198 ià(
	`¶_¡rcmp
(&
Çme
, 
m
->name))

199  
ofãr
 ? 
ENOTSUP
 : 
EPROTO
;

201 
m
->
u´Ùo
 = 
	`mem_d”ef
(m->uproto);

203 ià(!
	`sdp_medŸ_´Ùo_cmp
(
m
, &
´Ùo
, 
ofãr
)) {

205 
”r
 = 
	`¶_¡rdup
(&
m
->
u´Ùo
, &
´Ùo
);

206 ià(
”r
)

207  
”r
;

211 !
	`»_»gex
(
fmtv
.
p
, fmtv.
l
, " [^ ]+", &
fmt
)) {

213 
	`¶_advªû
(&
fmtv
, 
fmt
.
p
 + fmt.
l
 - fmtv.p);

215 
”r
 = 
	`sdp_fÜm©_¿dd
(
m
, &
fmt
);

216 ià(
”r
)

217  
”r
;

220 
m
->
¿ddr
 = 
£ss
->raddr;

221 
	`§_£t_pÜt
(&
m
->
¿ddr
, m->
u´Ùo
 ? 0 : 
	`¶_u32
(&
pÜt
));

223 
m
->
rdœ
 = 
£ss
->rdir;

225 *
mp
 = 
m
;

228 
	}
}

231 
	$v”siÚ_decode
(cÚ¡ 
¶
 *pl)

233  
	`¶_¡rcmp
(
¶
, "0"è? 
ENOSYS
 : 0;

234 
	}
}

246 
	$sdp_decode
(
sdp_£ssiÚ
 *
£ss
, 
mbuf
 *
mb
, 
boŞ
 
ofãr
)

248 
sdp_medŸ
 *
m
;

249 
¶
…l, 
v®
;

250 
Ë
 *le;

251 
ty³
 = 0;

252 
”r
 = 0;

254 ià(!
£ss
 || !
mb
)

255  
EINVAL
;

257 
	`sdp_£ssiÚ_¼e£t
(
£ss
);

259 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

261 
m
 = 
Ë
->
d©a
;

263 
	`sdp_medŸ_¼e£t
(
m
);

266 
¶
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
mb
);

267 
¶
.
l
 = 
	`mbuf_g‘_Ëá
(
mb
);

269 
m
 = 
NULL
;

271 ;
¶
.
l
 && !
”r
;…l.
p
++,…l.l--) {

273 *
¶
.
p
) {

277 ià(!
ty³
)

280 
ty³
) {

283 
”r
 = 
	`©Œ_decode
(
£ss
, 
m
,

284 
m
 ? &m->
rdœ
 : &
£ss
->rdir,

285 &
v®
);

289 
”r
 = 
	`bªdwidth_decode
(
m
? m->
rbwv
 : 
£ss
->rbwv,

290 &
v®
);

294 
”r
 = 
	`cÚn_decode
(
m
 ? &m->
¿ddr
 : &
£ss
->raddr,

295 &
v®
);

299 
”r
 = 
	`medŸ_decode
(&
m
, 
£ss
, 
ofãr
, &
v®
);

303 
”r
 = 
	`v”siÚ_decode
(&
v®
);

308 ià(
”r
)

309 
	`»_´štf
("** %c='%r': %m\n", 
ty³
, &
v®
, 
”r
);

312 
ty³
 = 0;

316 ià(
ty³
) {

317 
v®
.
l
++;

321 ià(
¶
.
l
 < 2 || *Õl.
p
 + 1) != '=') {

322 
”r
 = 
EBADMSG
;

326 
ty³
 = *
¶
.
p
;

327 
v®
.
p
 = 
¶
.p + 2;

328 
v®
.
l
 = 0;

330 
¶
.
p
 += 1;

331 
¶
.
l
 -= 1;

336 ià(
”r
)

337  
”r
;

339 ià(
ty³
)

340  
EBADMSG
;

342 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
)

343 
	`sdp_medŸ_®ign_fÜm©s
(
Ë
->
d©a
, 
ofãr
);

346 
	}
}

349 
	$medŸ_’code
(cÚ¡ 
sdp_medŸ
 *
m
, 
mbuf
 *
mb
, 
boŞ
 
ofãr
)

351 
sdp_bªdwidth
 
i
;

352 cÚ¡ *
´Ùo
;

353 
”r
, 
supc
 = 0;

354 
boŞ
 
di§bËd
;

355 
Ë
 *le;

356 
ušt16_t
 
pÜt
;

358 
Ë
=
m
->
lfm
.
h—d
;†e;†eöe->
Ãxt
) {

360 cÚ¡ 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

362 ià(
fmt
->
sup
)

363 ++
supc
;

366 ià(
m
->
u´Ùo
 && !
ofãr
) {

367 
di§bËd
 = 
Œue
;

368 
pÜt
 = 0;

369 
´Ùo
 = 
m
->
u´Ùo
;

371 ià(
m
->
di§bËd
 || 
supc
 =ğ0 || (!
ofãr
 && !
	`§_pÜt
(&m->
¿ddr
))) {

372 
di§bËd
 = 
Œue
;

373 
pÜt
 = 0;

374 
´Ùo
 = 
m
->proto;

377 
di§bËd
 = 
çl£
;

378 
pÜt
 = 
	`§_pÜt
(&
m
->
Ïddr
);

379 
´Ùo
 = 
m
->proto;

382 
”r
 = 
	`mbuf_´štf
(
mb
, "m=% %u %s", 
m
->
Çme
, 
pÜt
, 
´Ùo
);

384 ià(
di§bËd
) {

385 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, " 0\r\n");

386  
”r
;

389 
Ë
=
m
->
lfm
.
h—d
;†e;†eöe->
Ãxt
) {

391 cÚ¡ 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

393 ià(!
fmt
->
sup
)

396 
”r
 |ğ
	`mbuf_´štf
(
mb
, " %s", 
fmt
->
id
);

399 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "\r\n");

401 ià(
	`§_is£t
(&
m
->
Ïddr
, 
SA_ADDR
)) {

402 cÚ¡ 
v”
 = 
	`§_af
(&
m
->
Ïddr
è=ğ
AF_INET
 ? 4 : 6;

403 
”r
 |ğ
	`mbuf_´štf
(
mb
, "c=IN IP%d %j\r\n", 
v”
, &
m
->
Ïddr
);

406 
i
=
SDP_BANDWIDTH_MIN
; i<
SDP_BANDWIDTH_MAX
; i++) {

408 ià(
m
->
lbwv
[
i
] < 0)

411 
”r
 |ğ
	`mbuf_´štf
(
mb
, "b=%s:%i\r\n",

412 
	`sdp_bªdwidth_Çme
(
i
), 
m
->
lbwv
[i]);

415 
Ë
=
m
->
lfm
.
h—d
;†e;†eöe->
Ãxt
) {

417 cÚ¡ 
sdp_fÜm©
 *
fmt
 = 
Ë
->
d©a
;

419 ià(!
fmt
->
sup
 || !
	`¡r_is£t
(fmt->
Çme
))

422 
”r
 |ğ
	`mbuf_´štf
(
mb
, "a=rtpmap:%s %s/%u",

423 
fmt
->
id
, fmt->
Çme
, fmt->
¤©e
);

425 ià(
fmt
->
ch
 > 1)

426 
”r
 |ğ
	`mbuf_´štf
(
mb
, "/%u", 
fmt
->
ch
);

428 
”r
 |ğ
	`mbuf_´štf
(
mb
, "\r\n");

430 ià(
	`¡r_is£t
(
fmt
->
·¿ms
))

431 
”r
 |ğ
	`mbuf_´štf
(
mb
, "a=fmtp:%s %s\r\n",

432 
fmt
->
id
, fmt->
·¿ms
);

433 ià(
fmt
->
’ch
)

434 
”r
 |ğ
fmt
->
	`’ch
(
mb
, fmt, 
ofãr
, fmt->
d©a
);

437 ià(
	`§_is£t
(&
m
->
Ïddr_¹ı
, 
SA_ALL
))

438 
”r
 |ğ
	`mbuf_´štf
(
mb
, "a=rtcp:%u IN IP%d %j\r\n",

439 
	`§_pÜt
(&
m
->
Ïddr_¹ı
),

440 (
AF_INET
 =ğ
	`§_af
(&
m
->
Ïddr_¹ı
)) ? 4 : 6,

441 &
m
->
Ïddr_¹ı
);

442 ià(
	`§_is£t
(&
m
->
Ïddr_¹ı
, 
SA_PORT
))

443 
”r
 |ğ
	`mbuf_´štf
(
mb
, "a=rtcp:%u\r\n",

444 
	`§_pÜt
(&
m
->
Ïddr_¹ı
));

446 
”r
 |ğ
	`mbuf_´štf
(
mb
, "a=%s\r\n",

447 
	`sdp_dœ_Çme
(
ofãr
 ? 
m
->
ldœ
 : m->ldœ & m->
rdœ
));

449 
Ë
 = 
m
->
Ï‰¾
.
h—d
;†e;†ğË->
Ãxt
)

450 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%H", 
sdp_©Œ_´št
, 
Ë
->
d©a
);

452 ià(
m
->
’ch
)

453 
”r
 |ğ
m
->
	`’ch
(
mb
, 
ofãr
, m->
¬g
);

455  
”r
;

456 
	}
}

468 
	$sdp_’code
(
mbuf
 **
mbp
, 
sdp_£ssiÚ
 *
£ss
, 
boŞ
 
ofãr
)

470 cÚ¡ 
v”
 = 
	`§_af
(&
£ss
->
Ïddr
è=ğ
AF_INET
 ? 4 : 6;

471 
sdp_bªdwidth
 
i
;

472 
mbuf
 *
mb
;

473 
Ë
 *le;

474 
”r
;

476 ià(!
mbp
 || !
£ss
)

477  
EINVAL
;

479 
mb
 = 
	`mbuf_®loc
(512);

480 ià(!
mb
)

481  
ENOMEM
;

483 
”r
 = 
	`mbuf_´štf
(
mb
, "v=%u\r\n", 
SDP_VERSION
);

484 
”r
 |ğ
	`mbuf_´štf
(
mb
, "o=- %u %u IN IP%d %j\r\n",

485 
£ss
->
id
, sess->
v”
++, 
v”
, &£ss->
Ïddr
);

486 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "s=-\r\n");

487 
”r
 |ğ
	`mbuf_´štf
(
mb
, "c=IN IP%d %j\r\n", 
v”
, &
£ss
->
Ïddr
);

489 
i
=
SDP_BANDWIDTH_MIN
; i<
SDP_BANDWIDTH_MAX
; i++) {

491 ià(
£ss
->
lbwv
[
i
] < 0)

494 
”r
 |ğ
	`mbuf_´štf
(
mb
, "b=%s:%i\r\n",

495 
	`sdp_bªdwidth_Çme
(
i
), 
£ss
->
lbwv
[i]);

498 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "t=0 0\r\n");

500 
Ë
 = 
£ss
->
Ï‰¾
.
h—d
;†e;†ğË->
Ãxt
)

501 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%H", 
sdp_©Œ_´št
, 
Ë
->
d©a
);

503 
Ë
=
£ss
->
lmedŸl
.
h—d
; 
ofãr
 &&†e;) {

505 
sdp_medŸ
 *
m
 = 
Ë
->
d©a
;

507 
Ë
 =†e->
Ãxt
;

509 ià(
m
->
di§bËd
)

512 
	`li¡_uÆšk
(&
m
->
Ë
);

513 
	`li¡_­³nd
(&
£ss
->
medŸl
, &
m
->
Ë
, m);

516 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
) {

518 
sdp_medŸ
 *
m
 = 
Ë
->
d©a
;

520 
”r
 |ğ
	`medŸ_’code
(
m
, 
mb
, 
ofãr
);

523 
mb
->
pos
 = 0;

525 ià(
”r
)

526 
	`mem_d”ef
(
mb
);

528 *
mbp
 = 
mb
;

530  
”r
;

531 
	}
}

	@re-0.5.6/src/sdp/sdp.h

9 
	mRTP_DYNPT_START
 = 96,

10 
	mRTP_DYNPT_END
 = 127,

14 
	ssdp_£ssiÚ
 {

15 
li¡
 
	mlmedŸl
;

16 
li¡
 
	mmedŸl
;

17 
li¡
 
	mÏ‰¾
;

18 
li¡
 
	m¿‰¾
;

19 
§
 
	mÏddr
;

20 
§
 
	m¿ddr
;

21 
št32_t
 
	mlbwv
[
SDP_BANDWIDTH_MAX
];

22 
št32_t
 
	mrbwv
[
SDP_BANDWIDTH_MAX
];

23 
ušt32_t
 
	mid
;

24 
ušt32_t
 
	mv”
;

25 
sdp_dœ
 
	mrdœ
;

28 
	ssdp_medŸ
 {

29 
Ë
 
	mË
;

30 
li¡
 
	mlfm
;

31 
li¡
 
	mrfm
;

32 
li¡
 
	mÏ‰¾
;

33 
li¡
 
	m¿‰¾
;

34 
§
 
	mÏddr
;

35 
§
 
	m¿ddr
;

36 
§
 
	mÏddr_¹ı
;

37 
§
 
	m¿ddr_¹ı
;

38 
št32_t
 
	mlbwv
[
SDP_BANDWIDTH_MAX
];

39 
št32_t
 
	mrbwv
[
SDP_BANDWIDTH_MAX
];

40 *
	mÇme
;

41 *
	m´Ùo
;

42 *
	m´Ùov
[8];

43 *
	mu´Ùo
;

44 
sdp_medŸ_’c_h
 *
	m’ch
;

45 *
	m¬g
;

46 
sdp_dœ
 
	mldœ
;

47 
sdp_dœ
 
	mrdœ
;

48 
boŞ
 
	mfmt_ignÜe
;

49 
boŞ
 
	mdi§bËd
;

50 
	mdyÅt
;

55 
sdp_£ssiÚ_¼e£t
(
sdp_£ssiÚ
 *
£ss
);

59 
sdp_medŸ_¿dd
(
sdp_medŸ
 **
mp
, 
sdp_£ssiÚ
 *
£ss
,

60 cÚ¡ 
¶
 *
Çme
, cÚ¡ ¶ *
´Ùo
);

61 
sdp_medŸ_¼e£t
(
sdp_medŸ
 *
m
);

62 
boŞ
 
sdp_medŸ_´Ùo_cmp
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *
´Ùo
,

63 
boŞ
 
upd©e
);

64 
sdp_medŸ
 *
sdp_medŸ_fšd
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

65 cÚ¡ 
¶
 *
Çme
,

66 cÚ¡ 
¶
 *
´Ùo
,

67 
boŞ
 
upd©e_´Ùo
);

68 
sdp_medŸ_®ign_fÜm©s
(
sdp_medŸ
 *
m
, 
boŞ
 
ofãr
);

72 
sdp_fÜm©_¿dd
(
sdp_medŸ
 *
m
, cÚ¡ 
¶
 *
id
);

73 
sdp_fÜm©
 *
sdp_fÜm©_fšd
(cÚ¡ 
li¡
 *
l¡
,

74 cÚ¡ 
¶
 *
id
);

78 
	gsdp_©Œ
;

80 
sdp_©Œ_add
(
li¡
 *
l¡
, 
¶
 *
Çme
, ¶ *
v®
);

81 
sdp_©Œ_addv
(
li¡
 *
l¡
, cÚ¡ *
Çme
, cÚ¡ *
v®
,

82 
va_li¡
 
­
);

83 
sdp_©Œ_d–
(cÚ¡ 
li¡
 *
l¡
, cÚ¡ *
Çme
);

84 cÚ¡ *
sdp_©Œ_­¶y
(cÚ¡ 
li¡
 *
l¡
, cÚ¡ *
Çme
,

85 
sdp_©Œ_h
 *
©Œh
, *
¬g
);

86 
sdp_©Œ_´št
(
»_´štf
 *
pf
, cÚ¡ 
sdp_©Œ
 *
©Œ
);

87 
sdp_©Œ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_©Œ
 *
©Œ
);

	@re-0.5.6/src/sdp/session.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_sdp.h
>

14 
	~<»_sys.h
>

15 
	~"sdp.h
"

18 
	$de¡ruùÜ
(*
¬g
)

20 
sdp_£ssiÚ
 *
£ss
 = 
¬g
;

22 
	`li¡_æush
(&
£ss
->
lmedŸl
);

23 
	`li¡_æush
(&
£ss
->
medŸl
);

24 
	`li¡_æush
(&
£ss
->
¿‰¾
);

25 
	`li¡_æush
(&
£ss
->
Ï‰¾
);

26 
	}
}

37 
	$sdp_£ssiÚ_®loc
(
sdp_£ssiÚ
 **
£s¥
, cÚ¡ 
§
 *
Ïddr
)

39 
sdp_£ssiÚ
 *
£ss
;

40 
”r
 = 0, 
i
;

42 ià(!
£s¥
 || !
Ïddr
)

43  
EINVAL
;

45 
£ss
 = 
	`mem_z®loc
((*£ss), 
de¡ruùÜ
);

46 ià(!
£ss
)

47  
ENOMEM
;

49 
£ss
->
Ïddr
 = *laddr;

50 
£ss
->
id
 = 
	`¿nd_u32
();

51 
£ss
->
v”
 = 
	`¿nd_u32
() & 0x7fffffff;

52 
£ss
->
rdœ
 = 
SDP_SENDRECV
;

54 
	`§_š™
(&
£ss
->
¿ddr
, 
AF_INET
);

56 
i
=0; i<
SDP_BANDWIDTH_MAX
; i++) {

57 
£ss
->
lbwv
[
i
] = -1;

58 
£ss
->
rbwv
[
i
] = -1;

61 ià(
”r
)

62 
	`mem_d”ef
(
£ss
);

64 *
£s¥
 = 
£ss
;

66  
”r
;

67 
	}
}

75 
	$sdp_£ssiÚ_¼e£t
(
sdp_£ssiÚ
 *
£ss
)

77 
i
;

79 ià(!
£ss
)

82 
	`§_š™
(&
£ss
->
¿ddr
, 
AF_INET
);

84 
	`li¡_æush
(&
£ss
->
¿‰¾
);

86 
£ss
->
rdœ
 = 
SDP_SENDRECV
;

88 
i
=0; i<
SDP_BANDWIDTH_MAX
; i++)

89 
£ss
->
rbwv
[
i
] = -1;

90 
	}
}

99 
	$sdp_£ssiÚ_£t_Ïddr
(
sdp_£ssiÚ
 *
£ss
, cÚ¡ 
§
 *
Ïddr
)

101 ià(!
£ss
 || !
Ïddr
)

104 
£ss
->
Ïddr
 = *laddr;

105 
	}
}

115 
	$sdp_£ssiÚ_£t_lbªdwidth
(
sdp_£ssiÚ
 *
£ss
,

116 
sdp_bªdwidth
 
ty³
, 
št32_t
 
bw
)

118 ià(!
£ss
 || 
ty³
 >ğ
SDP_BANDWIDTH_MAX
)

121 
£ss
->
lbwv
[
ty³
] = 
bw
;

122 
	}
}

135 
	$sdp_£ssiÚ_£t_Ï‰r
(
sdp_£ssiÚ
 *
£ss
, 
boŞ
 
»¶aû
,

136 cÚ¡ *
Çme
, cÚ¡ *
v®ue
, ...)

138 
va_li¡
 
­
;

139 
”r
;

141 ià(!
£ss
 || !
Çme
)

142  
EINVAL
;

144 ià(
»¶aû
)

145 
	`sdp_©Œ_d–
(&
£ss
->
Ï‰¾
, 
Çme
);

147 
	`va_¡¬t
(
­
, 
v®ue
);

148 
”r
 = 
	`sdp_©Œ_addv
(&
£ss
->
Ï‰¾
, 
Çme
, 
v®ue
, 
­
);

149 
	`va_’d
(
­
);

151  
”r
;

152 
	}
}

161 
	$sdp_£ssiÚ_d–_Ï‰r
(
sdp_£ssiÚ
 *
£ss
, cÚ¡ *
Çme
)

163 ià(!
£ss
 || !
Çme
)

166 
	`sdp_©Œ_d–
(&
£ss
->
Ï‰¾
, 
Çme
);

167 
	}
}

178 
št32_t
 
	$sdp_£ssiÚ_lbªdwidth
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

179 
sdp_bªdwidth
 
ty³
)

181 ià(!
£ss
 || 
ty³
 >ğ
SDP_BANDWIDTH_MAX
)

184  
£ss
->
lbwv
[
ty³
];

185 
	}
}

196 
št32_t
 
	$sdp_£ssiÚ_rbªdwidth
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

197 
sdp_bªdwidth
 
ty³
)

199 ià(!
£ss
 || 
ty³
 >ğ
SDP_BANDWIDTH_MAX
)

202  
£ss
->
rbwv
[
ty³
];

203 
	}
}

214 cÚ¡ *
	$sdp_£ssiÚ_¿‰r
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
, cÚ¡ *
Çme
)

216 ià(!
£ss
 || !
Çme
)

217  
NULL
;

219  
	`sdp_©Œ_­¶y
(&
£ss
->
¿‰¾
, 
Çme
, 
NULL
, NULL);

220 
	}
}

233 cÚ¡ *
	$sdp_£ssiÚ_¿‰r_­¶y
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

234 cÚ¡ *
Çme
,

235 
sdp_©Œ_h
 *
©Œh
, *
¬g
)

237 ià(!
£ss
)

238  
NULL
;

240  
	`sdp_©Œ_­¶y
(&
£ss
->
¿‰¾
, 
Çme
, 
©Œh
, 
¬g
);

241 
	}
}

252 cÚ¡ 
li¡
 *
	$sdp_£ssiÚ_medŸl
(cÚ¡ 
sdp_£ssiÚ
 *
£ss
,

253 
boŞ
 
loÿl
)

255 ià(!
£ss
)

256  
NULL
;

258  
loÿl
 ? &
£ss
->
lmedŸl
 : &£ss->
medŸl
;

259 
	}
}

270 
	$sdp_£ssiÚ_debug
(
»_´štf
 *
pf
, cÚ¡ 
sdp_£ssiÚ
 *
£ss
)

272 
Ë
 *le;

273 
”r
;

275 ià(!
£ss
)

278 
”r
 = 
	`»_h´štf
(
pf
, "SDP session\n");

280 
”r
 |ğ
	`»_h´štf
(
pf
, "†ocal‡ttributes:\n");

282 
Ë
=
£ss
->
Ï‰¾
.
h—d
;†e;†eöe->
Ãxt
)

283 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_©Œ_debug
, 
Ë
->
d©a
);

285 
”r
 |ğ
	`»_h´štf
(
pf
, "„emote‡ttributes:\n");

287 
Ë
=
£ss
->
¿‰¾
.
h—d
;†e;†eöe->
Ãxt
)

288 
”r
 |ğ
	`»_h´štf
(
pf
, " %H\n", 
sdp_©Œ_debug
, 
Ë
->
d©a
);

290 
”r
 |ğ
	`»_h´štf
(
pf
, "session media:\n");

292 
Ë
=
£ss
->
medŸl
.
h—d
;†e;†eöe->
Ãxt
)

293 
”r
 |ğ
	`sdp_medŸ_debug
(
pf
, 
Ë
->
d©a
);

295 
”r
 |ğ
	`»_h´štf
(
pf
, "local media:\n");

297 
Ë
=
£ss
->
lmedŸl
.
h—d
;†e;†eöe->
Ãxt
)

298 
”r
 |ğ
	`sdp_medŸ_debug
(
pf
, 
Ë
->
d©a
);

300  
”r
;

301 
	}
}

	@re-0.5.6/src/sdp/str.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_li¡.h
>

9 
	~<»_§.h
>

10 
	~<»_sdp.h
>

13 cÚ¡ 
	gsdp_©Œ_fm
[] = "fmtp";

14 cÚ¡ 
	gsdp_©Œ_max±ime
[] = "maxptime";

15 cÚ¡ 
	gsdp_©Œ_±ime
[] = "ptime";

16 cÚ¡ 
	gsdp_©Œ_¹ı
[] = "rtcp";

17 cÚ¡ 
	gsdp_©Œ_¹pm­
[] = "rtpmap";

19 cÚ¡ 
	gsdp_medŸ_audio
[] = "audio";

20 cÚ¡ 
	gsdp_medŸ_video
[] = "video";

21 cÚ¡ 
	gsdp_medŸ_‹xt
[] = "text";

23 cÚ¡ 
	gsdp_´Ùo_¹·vp
[] = "RTP/AVP";

24 cÚ¡ 
	gsdp_´Ùo_¹p§vp
[] = "RTP/SAVP";

34 cÚ¡ *
	$sdp_dœ_Çme
(
sdp_dœ
 
dœ
)

36 
dœ
) {

38 
SDP_INACTIVE
:  "inactive";

39 
SDP_RECVONLY
:  "recvonly";

40 
SDP_SENDONLY
:  "sendonly";

41 
SDP_SENDRECV
:  "sendrecv";

44 
	}
}

54 cÚ¡ *
	$sdp_bªdwidth_Çme
(
sdp_bªdwidth
 
ty³
)

56 
ty³
) {

58 
SDP_BANDWIDTH_CT
:  "CT";

59 
SDP_BANDWIDTH_AS
:  "AS";

60 
SDP_BANDWIDTH_RS
:  "RS";

61 
SDP_BANDWIDTH_RR
:  "RR";

62 
SDP_BANDWIDTH_TIAS
:  "TIAS";

65 
	}
}

	@re-0.5.6/src/sdp/util.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_li¡.h
>

10 
	~<»_§.h
>

11 
	~<»_sdp.h
>

22 
	$sdp_extm­_decode
(
sdp_extm­
 *
ext
, cÚ¡ *
v®
)

24 
¶
 
id
, 
dœ
;

26 ià(!
ext
 || !
v®
)

27  
EINVAL
;

29 ià(
	`»_»gex
(
v®
, 
	`¡¾’
(val), "[0-9]+[/]*[a-z]* [^ ]+[ ]*[^ ]*",

30 &
id
, 
NULL
, &
dœ
, &
ext
->
Çme
, NULL, &ext->
©Œs
))

31  
EBADMSG
;

33 
ext
->
dœ_£t
 = 
çl£
;

34 
ext
->
dœ
 = 
SDP_SENDRECV
;

36 ià(
	`¶_is£t
(&
dœ
)) {

38 
ext
->
dœ_£t
 = 
Œue
;

40 ià(!
	`¶_¡rcmp
(&
dœ
, "£ndÚly")è
ext
->dœ = 
SDP_SENDONLY
;

41 ià(!
	`¶_¡rcmp
(&
dœ
, "£nd»cv")è
ext
->dœ = 
SDP_SENDRECV
;

42 ià(!
	`¶_¡rcmp
(&
dœ
, "»cvÚly")è
ext
->dœ = 
SDP_RECVONLY
;

43 ià(!
	`¶_¡rcmp
(&
dœ
, "šaùive")è
ext
->dœ = 
SDP_INACTIVE
;

44 
ext
->
dœ_£t
 = 
çl£
;

47 
ext
->
id
 = 
	`¶_u32
(&id);

50 
	}
}

	@re-0.5.6/src/sha/sha1.c

82 
	#SHA1HANDSOFF
 1

	)

84 #ifdeà
HAVE_CONFIG_H


85 
	~"cÚfig.h
"

88 
	~<¡dio.h
>

89 
	~<¡ršg.h
>

90 
	~<»_ty³s.h
>

91 
	~<»_sha.h
>

93 
SHA1_T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
ušt8_t
 
bufãr
[64]);

95 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

97 #ià
defšed
 (
BYTE_ORDER
è&& defšed(
BIG_ENDIAN
) && (BYTE_ORDER == BIG_ENDIAN)

98 
	#WORDS_BIGENDIAN
 1

	)

100 #ifdeà
_BIG_ENDIAN


101 
	#WORDS_BIGENDIAN
 1

	)

108 #ifdeà
WORDS_BIGENDIAN


109 
	#blk0
(
i
è
block
->
l
[i]

	)

111 
	#blk0
(
i
è(
block
->
l
[i] = (
	`rŞ
(block->l[i],24)&0xff00ff00) \

112 |(
	`rŞ
(
block
->
l
[
i
],8)&0x00ff00ff))

	)

114 
	#blk
(
i
è(
block
->
l
[i&15] = 
	`rŞ
(block->l[(i+13)&15]^block->l[(i+8)&15] \

115 ^
block
->
l
[(
i
+2)&15]^block->l[i&15],1))

	)

118 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
) \

119 
z
+=((
w
&(
x
^
y
))^y)+
	`blk0
(
i
)+0x5a827999+
	`rŞ
(
v
,5);wôŞ(w,30);

	)

120 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
) \

121 
z
+=((
w
&(
x
^
y
))^y)+
	`blk
(
i
)+0x5a827999+
	`rŞ
(
v
,5);wôŞ(w,30);

	)

122 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
) \

123 
z
+=(
w
^
x
^
y
)+
	`blk
(
i
)+0x6ed9eba1+
	`rŞ
(
v
,5);wôŞ(w,30);

	)

124 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
) \

125 
z
+=(((
w
|
x
)&
y
)|(w&x))+
	`blk
(
i
)+0x8f1bbcdc+
	`rŞ
(
v
,5);wôŞ(w,30);

	)

126 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
) \

127 
z
+=(
w
^
x
^
y
)+
	`blk
(
i
)+0xÿ62c1d6+
	`rŞ
(
v
,5);wôŞ(w,30);

	)

131 
	$SHA1_T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
ušt8_t
 
bufãr
[64])

133 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

135 
ušt8_t
 
c
[64];

136 
ušt32_t
 
l
[16];

137 } 
	tCHAR64LONG16
;

138 
CHAR64LONG16
* 
block
;

140 #ifdeà
SHA1HANDSOFF


141 
CHAR64LONG16
 
wÜk¥aû
;

142 
block
 = &
wÜk¥aû
;

143 
	`memıy
(
block
, 
bufãr
, 64);

145 
block
 = (
CHAR64LONG16
*)
bufãr
;

149 
a
 = 
¡©e
[0];

150 
b
 = 
¡©e
[1];

151 
c
 = 
¡©e
[2];

152 
d
 = 
¡©e
[3];

153 
e
 = 
¡©e
[4];

156 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2);R0(c,d,e,a,b, 3);

157 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6);R0(d,e,a,b,c, 7);

158 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10);R0(e,a,b,c,d,11);

159 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14);R0(a,b,c,d,e,15);

160 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18);R1(b,c,d,e,a,19);

161 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22);R2(c,d,e,a,b,23);

162 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26);R2(d,e,a,b,c,27);

163 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30);R2(e,a,b,c,d,31);

164 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34);R2(a,b,c,d,e,35);

165 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38);R2(b,c,d,e,a,39);

166 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42);R3(c,d,e,a,b,43);

167 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46);R3(d,e,a,b,c,47);

168 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50);R3(e,a,b,c,d,51);

169 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54);R3(a,b,c,d,e,55);

170 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58);R3(b,c,d,e,a,59);

171 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62);R4(c,d,e,a,b,63);

172 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66);R4(d,e,a,b,c,67);

173 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70);R4(e,a,b,c,d,71);

174 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74);R4(a,b,c,d,e,75);

175 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78);R4(b,c,d,e,a,79);

178 
¡©e
[0] +ğ
a
;

179 
¡©e
[1] +ğ
b
;

180 
¡©e
[2] +ğ
c
;

181 
¡©e
[3] +ğ
d
;

182 
¡©e
[4] +ğ
e
;

185 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

186 
	}
}

194 
	$SHA1_In™
(
SHA1_CTX
* 
cÚ‹xt
)

197 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

198 
cÚ‹xt
->
¡©e
[1] = 0xefcdab89;

199 
cÚ‹xt
->
¡©e
[2] = 0x98badcfe;

200 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

201 
cÚ‹xt
->
¡©e
[4] = 0xc3d2e1f0;

202 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

203 
	}
}

213 
	$SHA1_Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ *
p
, 
size_t
 
Ën
)

215 cÚ¡ 
ušt8_t
* 
d©a
 = 
p
;

216 
size_t
 
i
, 
j
;

218 
j
 = (
cÚ‹xt
->
couÁ
[0] >> 3) & 63;

219 ià((
cÚ‹xt
->
couÁ
[0] +ğ(
ušt32_t
)(
Ën
 << 3)) < (len << 3))

220 
cÚ‹xt
->
couÁ
[1]++;

221 
cÚ‹xt
->
couÁ
[1] +ğ(
ušt32_t
)(
Ën
 >> 29);

222 ià((
j
 + 
Ën
) > 63) {

223 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

224 
	`SHA1_T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

225  ; 
i
 + 63 < 
Ën
; i += 64) {

226 
	`SHA1_T¿nsfÜm
(
cÚ‹xt
->
¡©e
, 
d©a
 + 
i
);

228 
j
 = 0;

230 
i
 = 0;

231 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

232 
	}
}

241 
	$SHA1_Fš®
(
ušt8_t
 
dige¡
[
SHA1_DIGEST_SIZE
], 
SHA1_CTX
* 
cÚ‹xt
)

243 
ušt32_t
 
i
;

244 
ušt8_t
 
fš®couÁ
[8];

246 
i
 = 0; i < 8; i++) {

247 
fš®couÁ
[
i
] = (
ušt8_t
)((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

248 >> ((3-(
i
 & 3)) * 8) ) & 255);

250 
	`SHA1_Upd©e
(
cÚ‹xt
, (
ušt8_t
 *)"\200", 1);

251 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

252 
	`SHA1_Upd©e
(
cÚ‹xt
, (
ušt8_t
 *)"\0", 1);

254 
	`SHA1_Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

255 
i
 = 0; i < 
SHA1_DIGEST_SIZE
; i++) {

256 
dige¡
[
i
] = (
ušt8_t
)

257 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

261 
i
 = 0;

262 
	`mem£t
(
cÚ‹xt
->
bufãr
, 0, 64);

263 
	`mem£t
(
cÚ‹xt
->
¡©e
, 0, 20);

264 
	`mem£t
(
cÚ‹xt
->
couÁ
, 0, 8);

265 
	`mem£t
(
fš®couÁ
, 0, 8);

267 #ifdeà
SHA1HANDSOFF


268 
	`SHA1_T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

270 
	}
}

	@re-0.5.6/src/sip/addr.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_uri.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_msg.h
>

14 
	~<»_s.h
>

25 
	$s_addr_decode
(
s_addr
 *
addr
, cÚ¡ 
¶
 *pl)

27 
”r
;

29 ià(!
addr
 || !
¶
)

30  
EINVAL
;

32 
	`mem£t
(
addr
, 0, (*addr));

34 ià(0 =ğ
	`»_»gex
(
¶
->
p
,…l->
l
, "[~ \t\r\n<]*[ \t\r\n]*<[^>]+>[^]*",

35 &
addr
->
dÇme
, 
NULL
, &addr->
auri
, &addr->
·¿ms
)) {

37 ià(!
addr
->
dÇme
.
l
)

38 
addr
->
dÇme
.
p
 = 
NULL
;

40 ià(!
addr
->
·¿ms
.
l
)

41 
addr
->
·¿ms
.
p
 = 
NULL
;

44 
	`mem£t
(
addr
, 0, (*addr));

46 ià(
	`»_»gex
(
¶
->
p
,…l->
l
, "[^;]+[^]*",

47 &
addr
->
auri
, &addr->
·¿ms
))

48  
EBADMSG
;

51 
”r
 = 
	`uri_decode
(&
addr
->
uri
, &addr->
auri
);

52 ià(
”r
)

53 
	`mem£t
(
addr
, 0, (*addr));

55  
”r
;

56 
	}
}

	@re-0.5.6/src/sip/auth.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_uri.h
>

12 
	~<»_li¡.h
>

13 
	~<»_§.h
>

14 
	~<»_sys.h
>

15 
	~<»_md5.h
>

16 
	~<»_h‰·uth.h
>

17 
	~<»_udp.h
>

18 
	~<»_msg.h
>

19 
	~<»_s.h
>

20 
	~"s.h
"

23 
	ss_auth
 {

24 
li¡
 
	m»®ml
;

25 
s_auth_h
 *
	mauthh
;

26 *
	m¬g
;

27 
boŞ
 
	m»f
;

28 
	m”r
;

32 
	s»®m
 {

33 
Ë
 
	mË
;

34 *
	m»®m
;

35 *
	mnÚû
;

36 *
	mqİ
;

37 *
	mİaque
;

38 *
	mu£r
;

39 *
	m·ss
;

40 
ušt32_t
 
	mnc
;

41 
s_hdrid
 
	mhdr
;

45 
	$dummy_hªdËr
(**
u£r
, **
·ss
, cÚ¡ *
¾m
, *
¬g
)

47 ()
u£r
;

48 ()
·ss
;

49 ()
¾m
;

50 ()
¬g
;

52  
EAUTH
;

53 
	}
}

56 
	$»®m_de¡ruùÜ
(*
¬g
)

58 
»®m
 *»®m = 
¬g
;

60 
	`li¡_uÆšk
(&
»®m
->
Ë
);

61 
	`mem_d”ef
(
»®m
->realm);

62 
	`mem_d”ef
(
»®m
->
nÚû
);

63 
	`mem_d”ef
(
»®m
->
qİ
);

64 
	`mem_d”ef
(
»®m
->
İaque
);

65 
	`mem_d”ef
(
»®m
->
u£r
);

66 
	`mem_d”ef
(
»®m
->
·ss
);

67 
	}
}

70 
	$auth_de¡ruùÜ
(*
¬g
)

72 
s_auth
 *
auth
 = 
¬g
;

74 ià(
auth
->
»f
)

75 
	`mem_d”ef
(
auth
->
¬g
);

77 
	`li¡_æush
(&
auth
->
»®ml
);

78 
	}
}

81 
	$mkdige¡
(
ušt8_t
 *
dige¡
, cÚ¡ 
»®m
 *realm,

82 cÚ¡ *
m‘
, cÚ¡ *
uri
, 
ušt64_t
 
úÚû
)

84 
ušt8_t
 
ha1
[
MD5_SIZE
], 
ha2
[MD5_SIZE];

85 
”r
;

87 
”r
 = 
	`md5_´štf
(
ha1
, "%s:%s:%s",

88 
»®m
->
u£r
,„—lm->»®m,„—lm->
·ss
);

89 ià(
”r
)

90  
”r
;

92 
”r
 = 
	`md5_´štf
(
ha2
, "%s:%s", 
m‘
, 
uri
);

93 ià(
”r
)

94  
”r
;

96 ià(
»®m
->
qİ
)

97  
	`md5_´štf
(
dige¡
, "%w:%s:%08x:%016llx:auth:%w",

98 
ha1
, (ha1),

99 
»®m
->
nÚû
,

100 
»®m
->
nc
,

101 
úÚû
,

102 
ha2
, (ha2));

104  
	`md5_´štf
(
dige¡
, "%w:%s:%w",

105 
ha1
, (ha1),

106 
»®m
->
nÚû
,

107 
ha2
, (ha2));

108 
	}
}

111 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

113 
»®m
 *»®m = 
Ë
->
d©a
;

114 
¶
 *
ch»®m
 = 
¬g
;

117 ià(
»®m
->
nc
 == 1)

118  
çl£
;

120  0 =ğ
	`¶_¡rÿ£cmp
(
ch»®m
, 
»®m
->realm);

121 
	}
}

124 
boŞ
 
	$auth_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
, cÚ¡ 
s_msg
 *
msg
,

125 *
¬g
)

127 
h‰·uth_dige¡_ch®l
 
ch
;

128 
s_auth
 *
auth
 = 
¬g
;

129 
»®m
 *»®m = 
NULL
;

130 
”r
;

131 ()
msg
;

133 ià(
	`h‰·uth_dige¡_ch®Ënge_decode
(&
ch
, &
hdr
->
v®
)) {

134 
”r
 = 
EBADMSG
;

135 
out
;

138 ià(
	`¶_is£t
(&
ch
.
®gÜ™hm
è&& 
	`¶_¡rÿ£cmp
(&ch.algorithm, "md5")) {

139 
”r
 = 
ENOSYS
;

140 
out
;

143 
»®m
 = 
	`li¡_Ëd©a
(
	`li¡_­¶y
(&
auth
->
»®ml
, 
Œue
, 
cmp_hªdËr
,

144 &
ch
.
»®m
));

145 ià(!
»®m
) {

146 
»®m
 = 
	`mem_z®loc
((*»®m), 
»®m_de¡ruùÜ
);

147 ià(!
»®m
) {

148 
”r
 = 
ENOMEM
;

149 
out
;

152 
	`li¡_­³nd
(&
auth
->
»®ml
, &
»®m
->
Ë
,„ealm);

154 
”r
 = 
	`¶_¡rdup
(&
»®m
->»®m, &
ch
.realm);

155 ià(
”r
)

156 
out
;

158 
”r
 = 
auth
->
	`authh
(&
»®m
->
u£r
, &»®m->
·ss
,

159 
»®m
->»®m, 
auth
->
¬g
);

160 ià(
”r
)

161 
out
;

164 ià(!
	`¶_is£t
(&
ch
.
¡®e
è|| 
	`¶_¡rÿ£cmp
(&ch.stale, "true")) {

165 
”r
 = 
EAUTH
;

166 
out
;

169 
»®m
->
nÚû
 = 
	`mem_d”ef
(realm->nonce);

170 
»®m
->
qİ
 = 
	`mem_d”ef
(realm->qop);

171 
»®m
->
İaque
 = 
	`mem_d”ef
(realm->opaque);

174 
»®m
->
hdr
 = hdr->
id
;

175 
»®m
->
nc
 = 1;

177 
”r
 = 
	`¶_¡rdup
(&
»®m
->
nÚû
, &
ch
.nonce);

179 ià(
	`¶_is£t
(&
ch
.
qİ
))

180 
”r
 |ğ
	`¶_¡rdup
(&
»®m
->
qİ
, &
ch
.qop);

182 ià(
	`¶_is£t
(&
ch
.
İaque
))

183 
”r
 |ğ
	`¶_¡rdup
(&
»®m
->
İaque
, &
ch
.opaque);

185 
out
:

186 ià(
”r
) {

187 
	`mem_d”ef
(
»®m
);

188 
auth
->
”r
 =ƒrr;

189  
Œue
;

192  
çl£
;

193 
	}
}

204 
	$s_auth_auth’tiÿ‹
(
s_auth
 *
auth
, cÚ¡ 
s_msg
 *
msg
)

206 ià(!
auth
 || !
msg
)

207  
EINVAL
;

209 ià(
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_WWW_AUTHENTICATE
,

210 
auth_hªdËr
, 
auth
))

211  
auth
->
”r
;

213 ià(
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_PROXY_AUTHENTICATE
,

214 
auth_hªdËr
, 
auth
))

215  
auth
->
”r
;

218 
	}
}

221 
	$s_auth_’code
(
mbuf
 *
mb
, 
s_auth
 *
auth
, cÚ¡ *
m‘
,

222 cÚ¡ *
uri
)

224 
Ë
 *le;

225 
”r
 = 0;

227 ià(!
mb
 || !
auth
 || !
m‘
 || !
uri
)

228  
EINVAL
;

230 
Ë
 = 
auth
->
»®ml
.
h—d
;†e;†ğË->
Ãxt
) {

232 cÚ¡ 
ušt64_t
 
úÚû
 = 
	`¿nd_u64
();

233 
»®m
 *»®m = 
Ë
->
d©a
;

234 
ušt8_t
 
dige¡
[
MD5_SIZE
];

236 
”r
 = 
	`mkdige¡
(
dige¡
, 
»®m
, 
m‘
, 
uri
, 
úÚû
);

237 ià(
”r
)

240 
»®m
->
hdr
) {

242 
SIP_HDR_WWW_AUTHENTICATE
:

243 
”r
 = 
	`mbuf_wr™e_¡r
(
mb
, "Authorization: ");

246 
SIP_HDR_PROXY_AUTHENTICATE
:

247 
”r
 = 
	`mbuf_wr™e_¡r
(
mb
, "Proxy-Authorization: ");

254 
”r
 |ğ
	`mbuf_´štf
(
mb
, "Dige¡ u£ºame=\"%s\"", 
»®m
->
u£r
);

255 
”r
 |ğ
	`mbuf_´štf
(
mb
, ",„—lm=\"%s\"", 
»®m
->realm);

256 
”r
 |ğ
	`mbuf_´štf
(
mb
, ",‚Úû=\"%s\"", 
»®m
->
nÚû
);

257 
”r
 |ğ
	`mbuf_´štf
(
mb
, ", uri=\"%s\"", 
uri
);

258 
”r
 |ğ
	`mbuf_´štf
(
mb
, ",„esponse=\"%w\"",

259 
dige¡
, (digest));

261 ià(
»®m
->
İaque
)

262 
”r
 |ğ
	`mbuf_´štf
(
mb
, ", opaque=\"%s\"",

263 
»®m
->
İaque
);

265 ià(
»®m
->
qİ
) {

266 
”r
 |ğ
	`mbuf_´štf
(
mb
, ", cnÚû=\"%016Îx\"", 
úÚû
);

267 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, ", qop=auth");

268 
”r
 |ğ
	`mbuf_´štf
(
mb
, ",‚c=%08x", 
»®m
->
nc
);

271 ++
»®m
->
nc
;

273 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "\r\n");

274 ià(
”r
)

278  
”r
;

279 
	}
}

292 
	$s_auth_®loc
(
s_auth
 **
authp
, 
s_auth_h
 *
authh
,

293 *
¬g
, 
boŞ
 
»f
)

295 
s_auth
 *
auth
;

297 ià(!
authp
)

298  
EINVAL
;

300 
auth
 = 
	`mem_z®loc
((*auth), 
auth_de¡ruùÜ
);

301 ià(!
auth
)

302  
ENOMEM
;

304 
auth
->
authh
 =‡uthh ?‡uthh : 
dummy_hªdËr
;

305 
auth
->
¬g
 = 
»f
 ? 
	`mem_»f
(arg) :‡rg;

306 
auth
->
»f
 =„ef;

308 *
authp
 = 
auth
;

311 
	}
}

319 
	$s_auth_»£t
(
s_auth
 *
auth
)

321 ià(!
auth
)

324 
	`li¡_æush
(&
auth
->
»®ml
);

325 
	}
}

	@re-0.5.6/src/sip/contact.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_uri.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_msg.h
>

14 
	~<»_s.h
>

25 
	$s_cÚù_£t
(
s_cÚù
 *
cÚù
, cÚ¡ *
uri
,

26 cÚ¡ 
§
 *
addr
, 
s_Œª¥
 

)

28 ià(!
cÚù
)

31 
cÚù
->
uri
 = uri;

32 
cÚù
->
addr
 =‡ddr;

33 
cÚù
->

 =p;

34 
	}
}

45 
	$s_cÚù_´št
(
»_´štf
 *
pf
, cÚ¡ 
s_cÚù
 *
cÚù
)

47 ià(!
cÚù
)

50 ià(
cÚù
->
uri
 && 
	`¡rchr
(contact->uri, ':'))

51  
	`»_h´štf
(
pf
, "CÚù: <%s>\r\n", 
cÚù
->
uri
);

53  
	`»_h´štf
(
pf
, "Contact: <sip:%s@%J%s>\r\n",

54 
cÚù
->
uri
,

55 
cÚù
->
addr
,

56 
	`s_Œª¥_·¿m
(
cÚù
->

));

57 
	}
}

	@re-0.5.6/src/sip/cseq.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_uri.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_msg.h
>

13 
	~<»_s.h
>

24 
	$s_c£q_decode
(
s_c£q
 *
c£q
, cÚ¡ 
¶
 *pl)

26 
¶
 
num
;

27 
”r
;

29 ià(!
c£q
 || !
¶
)

30  
EINVAL
;

32 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
, "[0-9]+[ \t\r\n]+[^ \t\r\n]+",

33 &
num
, 
NULL
, &
c£q
->
m‘
);

34 ià(
”r
)

35  
”r
;

37 
c£q
->
num
 = 
	`¶_u32
(&num);

40 
	}
}

	@re-0.5.6/src/sip/ctrans.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_fmt.h
>

14 
	~<»_uri.h
>

15 
	~<»_sys.h
>

16 
	~<»_tmr.h
>

17 
	~<»_udp.h
>

18 
	~<»_msg.h
>

19 
	~<»_s.h
>

20 
	~"s.h
"

23 
	e¡©e
 {

24 
	mTRYING
,

25 
	mCALLING
,

26 
	mPROCEEDING
,

27 
	mCOMPLETED
,

32 
	mCOMPLETE_WAIT
 = 32000,

36 
	ss_ù¿ns
 {

37 
Ë
 
	mhe
;

38 
§
 
	md¡
;

39 
tmr
 
	mtmr
;

40 
tmr
 
	mtm»
;

41 
s
 *
	ms
;

42 
mbuf
 *
	mmb
;

43 
mbuf
 *
	mmb_ack
;

44 
s_msg
 *
	m»q
;

45 
s_cÚnq’t
 *
	mq’t
;

46 *
	mm‘
;

47 *
	mb¿nch
;

48 
s_»¥_h
 *
	m»¥h
;

49 *
	m¬g
;

50 
s_Œª¥
 
	m
;

51 
¡©e
 
	m¡©e
;

52 
ušt32_t
 
	mtxc
;

53 
boŞ
 
	mšv™e
;

57 
boŞ
 
	$rou‹_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
, cÚ¡ 
s_msg
 *
msg
,

58 *
¬g
)

60 ()
msg
;

61  0 !ğ
	`mbuf_´štf
(
¬g
, "Rou‹: %r\r\n", &
hdr
->
v®
);

62 
	}
}

65 
	$»que¡_cİy
(
mbuf
 **
mbp
, 
s_ù¿ns
 *
ù
,

66 cÚ¡ *
m‘
, cÚ¡ 
s_msg
 *
»¥
)

68 
mbuf
 *
mb
;

69 
”r
;

71 ià(!
ù
->
»q
) {

72 
”r
 = 
	`s_msg_decode
(&
ù
->
»q
, ct->
mb
);

73 ià(
”r
)

74  
”r
;

77 
mb
 = 
	`mbuf_®loc
(1024);

78 ià(!
mb
)

79  
ENOMEM
;

81 
”r
 = 
	`mbuf_´štf
(
mb
, "% %¸SIP/2.0\r\n", 
m‘
, &
ù
->
»q
->
ruri
);

82 
”r
 |ğ
	`mbuf_´štf
(
mb
, "VŸ: %r\r\n", &
ù
->
»q
->
vŸ
.
v®
);

83 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "Max-Forwards: 70\r\n");

84 
”r
 |ğ
	`s_msg_hdr_­¶y
(
ù
->
»q
, 
Œue
, 
SIP_HDR_ROUTE
,

85 
rou‹_hªdËr
, 
mb
è? 
ENOMEM
 : 0;

86 
”r
 |ğ
	`mbuf_´štf
(
mb
, "To: %r\r\n",

87 
»¥
 ? &»¥->
to
.
v®
 : &
ù
->
»q
->to.val);

88 
”r
 |ğ
	`mbuf_´štf
(
mb
, "From: %r\r\n", &
ù
->
»q
->
äom
.
v®
);

89 
”r
 |ğ
	`mbuf_´štf
(
mb
, "C®l-ID: %r\r\n", &
ù
->
»q
->
ÿÎid
);

90 
”r
 |ğ
	`mbuf_´štf
(
mb
, "CSeq: %u %s\r\n", 
ù
->
»q
->
c£q
.
num
, 
m‘
);

91 ià(
ù
->
s
->
soáw¬e
)

92 
”r
 |ğ
	`mbuf_´štf
(
mb
, "U£r-Ag’t: %s\r\n",
ù
->
s
->
soáw¬e
);

93 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "Content-Length: 0\r\n\r\n");

95 
mb
->
pos
 = 0;

97 ià(
”r
)

98 
	`mem_d”ef
(
mb
);

100 *
mbp
 = 
mb
;

102  
”r
;

103 
	}
}

106 
	$de¡ruùÜ
(*
¬g
)

108 
s_ù¿ns
 *
ù
 = 
¬g
;

110 
	`hash_uÆšk
(&
ù
->
he
);

111 
	`tmr_ÿnûl
(&
ù
->
tmr
);

112 
	`tmr_ÿnûl
(&
ù
->
tm»
);

113 
	`mem_d”ef
(
ù
->
m‘
);

114 
	`mem_d”ef
(
ù
->
b¿nch
);

115 
	`mem_d”ef
(
ù
->
q’t
);

116 
	`mem_d”ef
(
ù
->
»q
);

117 
	`mem_d”ef
(
ù
->
mb
);

118 
	`mem_d”ef
(
ù
->
mb_ack
);

119 
	}
}

122 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

124 
s_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

125 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

127 ià(
	`¶_¡rcmp
(&
msg
->
vŸ
.
b¿nch
, 
ù
->branch))

128  
çl£
;

130 ià(
	`¶_¡rcmp
(&
msg
->
c£q
.
m‘
, 
ù
->met))

131  
çl£
;

133  
Œue
;

134 
	}
}

137 
	$dummy_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

139 ()
”r
;

140 ()
msg
;

141 ()
¬g
;

142 
	}
}

145 
	$‹rmš©e
(
s_ù¿ns
 *
ù
, 
”r
)

147 
ù
->
¡©e
) {

149 
TRYING
:

150 
CALLING
:

151 
PROCEEDING
:

152 
ù
->
	`»¥h
(
”r
, 
NULL
, ct->
¬g
);

158 
	}
}

161 
	$Œª¥Üt_hªdËr
(
”r
, *
¬g
)

163 
s_ù¿ns
 *
ù
 = 
¬g
;

165 
	`‹rmš©e
(
ù
, 
”r
);

166 
	`mem_d”ef
(
ù
);

167 
	}
}

170 
	$tmr_hªdËr
(*
¬g
)

172 
s_ù¿ns
 *
ù
 = 
¬g
;

174 
	`‹rmš©e
(
ù
, 
ETIMEDOUT
);

175 
	`mem_d”ef
(
ù
);

176 
	}
}

179 
	$»Œªsm™_hªdËr
(*
¬g
)

181 
s_ù¿ns
 *
ù
 = 
¬g
;

182 
ušt32_t
 
timeout
;

183 
”r
;

185 
ù
->
txc
++;

187 
ù
->
¡©e
) {

189 
TRYING
:

190 
timeout
 = 
	`MIN
(
SIP_T1
<<
ù
->
txc
, 
SIP_T2
);

193 
CALLING
:

194 
timeout
 = 
SIP_T1
<<
ù
->
txc
;

197 
PROCEEDING
:

198 
timeout
 = 
SIP_T2
;

205 
	`tmr_¡¬t
(&
ù
->
tm»
, 
timeout
, 
»Œªsm™_hªdËr
, ct);

207 
”r
 = 
	`s_Œª¥_£nd
(&
ù
->
q’t
, ct->
s
, 
NULL
, ct->

, &ù->
d¡
,

208 
ù
->
mb
, 
Œª¥Üt_hªdËr
, ct);

209 ià(
”r
) {

210 
	`‹rmš©e
(
ù
, 
”r
);

211 
	`mem_d”ef
(
ù
);

213 
	}
}

216 
	$šv™e_»¥Ú£
(
s_ù¿ns
 *
ù
, cÚ¡ 
s_msg
 *
msg
)

218 
ù
->
¡©e
) {

220 
CALLING
:

221 
	`tmr_ÿnûl
(&
ù
->
tmr
);

222 
	`tmr_ÿnûl
(&
ù
->
tm»
);

224 
PROCEEDING
:

225 ià(
msg
->
scode
 < 200) {

226 
ù
->
¡©e
 = 
PROCEEDING
;

227 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

229 ià(
msg
->
scode
 < 300) {

230 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

231 
	`mem_d”ef
(
ù
);

234 
ù
->
¡©e
 = 
COMPLETED
;

236 ()
	`»que¡_cİy
(&
ù
->
mb_ack
, ct, "ACK", 
msg
);

237 ()
	`s_£nd
(
ù
->
s
, 
NULL
, ct->

, &ù->
d¡
,

238 
ù
->
mb_ack
);

240 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

242 ià(
	`s_Œª¥_»lŸbË
(
ù
->

)) {

243 
	`mem_d”ef
(
ù
);

247 
	`tmr_¡¬t
(&
ù
->
tmr
, 
COMPLETE_WAIT
, 
tmr_hªdËr
, ct);

251 
COMPLETED
:

252 ià(
msg
->
scode
 < 300)

255 ()
	`s_£nd
(
ù
->
s
, 
NULL
, ct->

, &ù->
d¡
, ct->
mb_ack
);

261 
	}
}

264 
boŞ
 
	$»¥Ú£_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

266 
s_ù¿ns
 *
ù
;

267 
s
 *s = 
¬g
;

269 
ù
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
s
->
ht_ù¿ns
,

270 
	`hash_jß©_¶
(&
msg
->
vŸ
.
b¿nch
),

271 
cmp_hªdËr
, (*)
msg
));

272 ià(!
ù
)

273  
çl£
;

275 ià(
ù
->
šv™e
) {

276 
	`šv™e_»¥Ú£
(
ù
, 
msg
);

277  
Œue
;

280 
ù
->
¡©e
) {

282 
TRYING
:

283 
PROCEEDING
:

284 ià(
msg
->
scode
 < 200) {

285 
ù
->
¡©e
 = 
PROCEEDING
;

286 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

289 
ù
->
¡©e
 = 
COMPLETED
;

290 
ù
->
	`»¥h
(0, 
msg
, ct->
¬g
);

292 ià(
	`s_Œª¥_»lŸbË
(
ù
->

)) {

293 
	`mem_d”ef
(
ù
);

297 
	`tmr_¡¬t
(&
ù
->
tmr
, 
SIP_T4
, 
tmr_hªdËr
, ct);

298 
	`tmr_ÿnûl
(&
ù
->
tm»
);

306  
Œue
;

307 
	}
}

310 
	$s_ù¿ns_»que¡
(
s_ù¿ns
 **
ùp
, 
s
 *sip,

311 
s_Œª¥
 

, cÚ¡ 
§
 *
d¡
, *
m‘
,

312 *
b¿nch
, 
mbuf
 *
mb
,

313 
s_»¥_h
 *
»¥h
, *
¬g
)

315 
s_ù¿ns
 *
ù
;

316 
”r
;

318 ià(!
s
 || !
d¡
 || !
m‘
 || !
b¿nch
 || !
mb
)

319  
EINVAL
;

321 
ù
 = 
	`mem_z®loc
((*ù), 
de¡ruùÜ
);

322 ià(!
ù
)

323  
ENOMEM
;

325 
	`hash_­³nd
(
s
->
ht_ù¿ns
, 
	`hash_jß©_¡r
(
b¿nch
), &
ù
->
he
, ct);

327 
ù
->
šv™e
 = !
	`¡rcmp
(
m‘
, "INVITE");

328 
ù
->
b¿nch
 = 
	`mem_»f
(branch);

329 
ù
->
m‘
 = 
	`mem_»f
(met);

330 
ù
->
mb
 = 
	`mem_»f
(mb);

331 
ù
->
d¡
 = *dst;

332 
ù
->

 =p;

333 
ù
->
s
 = sip;

334 
ù
->
¡©e
 = ct->
šv™e
 ? 
CALLING
 : 
TRYING
;

335 
ù
->
»¥h
 =„e¥h ?„e¥h : 
dummy_hªdËr
;

336 
ù
->
¬g
 =‡rg;

338 
”r
 = 
	`s_Œª¥_£nd
(&
ù
->
q’t
, 
s
, 
NULL
, 

, 
d¡
, 
mb
,

339 
Œª¥Üt_hªdËr
, 
ù
);

340 ià(
”r
)

341 
out
;

343 
	`tmr_¡¬t
(&
ù
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
, ct);

345 ià(!
	`s_Œª¥_»lŸbË
(
ù
->

))

346 
	`tmr_¡¬t
(&
ù
->
tm»
, 
SIP_T1
, 
»Œªsm™_hªdËr
, ct);

348 
out
:

349 ià(
”r
)

350 
	`mem_d”ef
(
ù
);

351 ià(
ùp
)

352 *
ùp
 = 
ù
;

354  
”r
;

355 
	}
}

358 
	$s_ù¿ns_ÿnûl
(
s_ù¿ns
 *
ù
)

360 
mbuf
 *
mb
 = 
NULL
;

361 *
ÿnûl
 = 
NULL
;

362 
”r
;

364 ià(!
ù
)

365  
EINVAL
;

367 ià(!
ù
->
šv™e
)

370 
ù
->
¡©e
) {

372 
PROCEEDING
:

373 
	`tmr_¡¬t
(&
ù
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
, ct);

377  
EPROTO
;

380 
”r
 = 
	`¡r_dup
(&
ÿnûl
, "CANCEL");

381 ià(
”r
)

382 
out
;

384 
”r
 = 
	`»que¡_cİy
(&
mb
, 
ù
, 
ÿnûl
, 
NULL
);

385 ià(
”r
)

386 
out
;

388 
”r
 = 
	`s_ù¿ns_»que¡
(
NULL
, 
ù
->
s
, ct->

, &ù->
d¡
, 
ÿnûl
,

389 
ù
->
b¿nch
, 
mb
, 
NULL
, NULL);

390 ià(
”r
)

391 
out
;

393 
out
:

394 
	`mem_d”ef
(
ÿnûl
);

395 
	`mem_d”ef
(
mb
);

397  
”r
;

398 
	}
}

401 
	$s_ù¿ns_š™
(
s
 *s, 
ušt32_t
 
sz
)

403 
”r
;

405 
”r
 = 
	`s_li¡’
(
NULL
, 
s
, 
çl£
, 
»¥Ú£_hªdËr
, sip);

406 ià(
”r
)

407  
”r
;

409  
	`hash_®loc
(&
s
->
ht_ù¿ns
, 
sz
);

410 
	}
}

413 cÚ¡ *
	$¡©’ame
(
¡©e
 state)

415 
¡©e
) {

417 
TRYING
:  "TRYING";

418 
CALLING
:  "CALLING";

419 
PROCEEDING
:  "PROCEEDING";

420 
COMPLETED
:  "COMPLETED";

423 
	}
}

426 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

428 
s_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

429 
»_´štf
 *
pf
 = 
¬g
;

431 ()
	`»_h´štf
(
pf
, " %-10s %-10s %2llus (%s)\n",

432 
ù
->
m‘
,

433 
	`¡©’ame
(
ù
->
¡©e
),

434 
	`tmr_g‘_expœe
(&
ù
->
tmr
)/1000,

435 
ù
->
b¿nch
);

437  
çl£
;

438 
	}
}

441 
	$s_ù¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip)

443 
”r
;

445 
”r
 = 
	`»_h´štf
(
pf
, "clientransactions:\n");

446 
	`hash_­¶y
(
s
->
ht_ù¿ns
, 
debug_hªdËr
, 
pf
);

448  
”r
;

449 
	}
}

	@re-0.5.6/src/sip/dialog.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_fmt.h
>

14 
	~<»_uri.h
>

15 
	~<»_sys.h
>

16 
	~<»_tmr.h
>

17 
	~<»_udp.h
>

18 
	~<»_msg.h
>

19 
	~<»_s.h
>

20 
	~"s.h
"

24 
	mROUTE_OFFSET
 = 7,

25 
	mX64_STRSIZE
 = 17,

28 
	ss_dŸlog
 {

29 
uri
 
	mrou‹
;

30 
mbuf
 *
	mmb
;

31 *
	mÿÎid
;

32 *
	mÉag
;

33 *
	m¹ag
;

34 *
	muri
;

35 
ušt32_t
 
	mhash
;

36 
ušt32_t
 
	ml£q
;

37 
ušt32_t
 
	mr£q
;

38 
size_t
 
	mıos
;

42 
	srou‹_’c
 {

43 
mbuf
 *
	mmb
;

44 
size_t
 
	m’d
;

48 
	$x64_¡rdup
(**
¡½
, 
ušt64_t
 
v®
)

50 *
¡r
;

52 
¡r
 = 
	`mem_®loc
(
X64_STRSIZE
, 
NULL
);

53 ià(!
¡r
)

54  
ENOMEM
;

56 ()
	`»_¢´štf
(
¡r
, 
X64_STRSIZE
, "%016Îx", 
v®
);

58 *
¡½
 = 
¡r
;

61 
	}
}

64 
	$de¡ruùÜ
(*
¬g
)

66 
s_dŸlog
 *
dlg
 = 
¬g
;

68 
	`mem_d”ef
(
dlg
->
ÿÎid
);

69 
	`mem_d”ef
(
dlg
->
Éag
);

70 
	`mem_d”ef
(
dlg
->
¹ag
);

71 
	`mem_d”ef
(
dlg
->
uri
);

72 
	`mem_d”ef
(
dlg
->
mb
);

73 
	}
}

89 
	$s_dŸlog_®loc
(
s_dŸlog
 **
dlgp
,

90 cÚ¡ *
uri
, cÚ¡ *
to_uri
,

91 cÚ¡ *
äom_Çme
, cÚ¡ *
äom_uri
,

92 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
)

94 cÚ¡ 
ušt64_t
 
Éag
 = 
	`¿nd_u64
();

95 
s_dŸlog
 *
dlg
;

96 
s_addr
 
addr
;

97 
size_t
 
»nd
 = 0;

98 
¶
…l;

99 
ušt32_t
 
i
;

100 
”r
;

102 ià(!
dlgp
 || !
uri
 || !
to_uri
 || !
äom_uri
)

103  
EINVAL
;

105 
dlg
 = 
	`mem_z®loc
((*dlg), 
de¡ruùÜ
);

106 ià(!
dlg
)

107  
ENOMEM
;

109 
dlg
->
hash
 = 
	`hash_ç¡_¡r
(
äom_uri
);

110 
dlg
->
l£q
 = 
	`¿nd_u16
();

112 
”r
 = 
	`¡r_dup
(&
dlg
->
uri
, uri);

113 ià(
”r
)

114 
out
;

116 
”r
 = 
	`x64_¡rdup
(&
dlg
->
ÿÎid
, 
	`¿nd_u64
());

117 ià(
”r
)

118 
out
;

120 
”r
 = 
	`x64_¡rdup
(&
dlg
->
Éag
,†tag);

121 ià(
”r
)

122 
out
;

124 
dlg
->
mb
 = 
	`mbuf_®loc
(512);

125 ià(!
dlg
->
mb
) {

126 
”r
 = 
ENOMEM
;

127 
out
;

130 
i
=0; i<
rou‹c
; i++) {

131 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "Rou‹: <%s;Ì>\r\n", 
rou‹v
[
i
]);

132 ià(
i
 == 0)

133 
»nd
 = 
dlg
->
mb
->
pos
 - 2;

135 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "To: <%s>\r\n", 
to_uri
);

136 
dlg
->
ıos
 = dlg->
mb
->
pos
;

137 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "From: %s%s%s<%s>;tag=%016llx\r\n",

138 
äom_Çme
 ? "\"" : "", from_name,

139 
äom_Çme
 ? "\" " : "",

140 
äom_uri
, 
Éag
);

141 ià(
”r
)

142 
out
;

144 
dlg
->
mb
->
pos
 = 0;

146 ià(
»nd
) {

147 
¶
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
dlg
->
mb
è+ 
ROUTE_OFFSET
;

148 
¶
.
l
 = 
»nd
 - 
ROUTE_OFFSET
;

149 
”r
 = 
	`s_addr_decode
(&
addr
, &
¶
);

150 
dlg
->
rou‹
 = 
addr
.
uri
;

153 
	`¶_£t_¡r
(&
¶
, 
dlg
->
uri
);

154 
”r
 = 
	`uri_decode
(&
dlg
->
rou‹
, &
¶
);

157 
out
:

158 ià(
”r
)

159 
	`mem_d”ef
(
dlg
);

161 *
dlgp
 = 
dlg
;

163  
”r
;

164 
	}
}

167 
boŞ
 
	$»cÜd_rou‹_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
,

168 cÚ¡ 
s_msg
 *
msg
,

169 *
¬g
)

171 
rou‹_’c
 *
»nc
 = 
¬g
;

172 ()
msg
;

174 ià(
	`mbuf_´štf
(
»nc
->
mb
, "Rou‹: %r\r\n", &
hdr
->
v®
))

175  
Œue
;

177 ià(!
»nc
->
’d
)

178 
»nc
->
’d
 =„’c->
mb
->
pos
 - 2;

180  
çl£
;

181 
	}
}

192 
	$s_dŸlog_acû±
(
s_dŸlog
 **
dlgp
, cÚ¡ 
s_msg
 *
msg
)

194 cÚ¡ 
s_hdr
 *
cÚù
;

195 
s_dŸlog
 *
dlg
;

196 
rou‹_’c
 
»nc
;

197 
s_addr
 
addr
;

198 
¶
…l;

199 
”r
;

201 ià(!
dlgp
 || !
msg
 || !msg->
»q
)

202  
EINVAL
;

204 
cÚù
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTACT
);

206 ià(!
cÚù
 || !
msg
->
ÿÎid
.
p
)

207  
EBADMSG
;

209 ià(
	`s_addr_decode
(&
addr
, &
cÚù
->
v®
))

210  
EBADMSG
;

212 
dlg
 = 
	`mem_z®loc
((*dlg), 
de¡ruùÜ
);

213 ià(!
dlg
)

214  
ENOMEM
;

216 
dlg
->
hash
 = 
	`¿nd_u32
();

217 
dlg
->
l£q
 = 
	`¿nd_u16
();

218 
dlg
->
r£q
 = 
msg
->
c£q
.
num
;

220 
”r
 = 
	`¶_¡rdup
(&
dlg
->
uri
, &
addr
.
auri
);

221 ià(
”r
)

222 
out
;

224 
”r
 = 
	`¶_¡rdup
(&
dlg
->
ÿÎid
, &
msg
->callid);

225 ià(
”r
)

226 
out
;

228 
”r
 = 
	`x64_¡rdup
(&
dlg
->
Éag
, 
msg
->
g
);

229 ià(
”r
)

230 
out
;

232 
”r
 = 
	`¶_¡rdup
(&
dlg
->
¹ag
, &
msg
->
äom
.
g
);

233 ià(
”r
)

234 
out
;

236 
dlg
->
mb
 = 
	`mbuf_®loc
(512);

237 ià(!
dlg
->
mb
) {

238 
”r
 = 
ENOMEM
;

239 
out
;

242 
»nc
.
mb
 = 
dlg
->mb;

243 
»nc
.
’d
 = 0;

245 
”r
 |ğ
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_RECORD_ROUTE
,

246 
»cÜd_rou‹_hªdËr
, &
»nc
è? 
ENOMEM
 : 0;

247 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "To: %r\r\n", &
msg
->
äom
.
v®
);

248 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "From: %r;g=%016Îx\r\n", &
msg
->
to
.
v®
,

249 
msg
->
g
);

250 ià(
”r
)

251 
out
;

253 
dlg
->
mb
->
pos
 = 0;

255 ià(
»nc
.
’d
) {

256 
¶
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
dlg
->
mb
è+ 
ROUTE_OFFSET
;

257 
¶
.
l
 = 
»nc
.
’d
 - 
ROUTE_OFFSET
;

258 
”r
 = 
	`s_addr_decode
(&
addr
, &
¶
);

259 
dlg
->
rou‹
 = 
addr
.
uri
;

262 
	`¶_£t_¡r
(&
¶
, 
dlg
->
uri
);

263 
”r
 = 
	`uri_decode
(&
dlg
->
rou‹
, &
¶
);

266 
out
:

267 ià(
”r
)

268 
	`mem_d”ef
(
dlg
);

270 *
dlgp
 = 
dlg
;

272  
”r
;

273 
	}
}

284 
	$s_dŸlog_ü—‹
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
)

286 *
uri
 = 
NULL
, *
¹ag
 = NULL;

287 cÚ¡ 
s_hdr
 *
cÚù
;

288 
rou‹_’c
 
»nc
;

289 
s_addr
 
addr
;

290 
¶
…l;

291 
”r
;

293 ià(!
dlg
 || dlg->
¹ag
 || !dlg->
ıos
 || !
msg
)

294  
EINVAL
;

296 
cÚù
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTACT
);

298 ià(!
cÚù
)

299  
EBADMSG
;

301 ià(
	`s_addr_decode
(&
addr
, &
cÚù
->
v®
))

302  
EBADMSG
;

304 
»nc
.
mb
 = 
	`mbuf_®loc
(512);

305 ià(!
»nc
.
mb
)

306  
ENOMEM
;

308 
”r
 = 
	`¶_¡rdup
(&
uri
, &
addr
.
auri
);

309 ià(
”r
)

310 
out
;

312 
”r
 = 
	`¶_¡rdup
(&
¹ag
, 
msg
->
»q
 ? &msg->
äom
.
g
 : &msg->
to
.tag);

313 ià(
”r
)

314 
out
;

316 
»nc
.
’d
 = 0;

318 
”r
 |ğ
	`s_msg_hdr_­¶y
(
msg
, msg->
»q
, 
SIP_HDR_RECORD_ROUTE
,

319 
»cÜd_rou‹_hªdËr
, &
»nc
è? 
ENOMEM
 : 0;

320 
”r
 |ğ
	`mbuf_´štf
(
»nc
.
mb
, "To: %r\r\n",

321 
msg
->
»q
 ? &msg->
äom
.
v®
 : &msg->
to
.val);

323 
dlg
->
mb
->
pos
 = dlg->
ıos
;

324 
”r
 |ğ
	`mbuf_wr™e_mem
(
»nc
.
mb
, 
	`mbuf_buf
(
dlg
->mb),

325 
	`mbuf_g‘_Ëá
(
dlg
->
mb
));

326 
dlg
->
mb
->
pos
 = 0;

328 ià(
”r
)

329 
out
;

331 
»nc
.
mb
->
pos
 = 0;

333 ià(
»nc
.
’d
) {

334 
¶
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
»nc
.
mb
è+ 
ROUTE_OFFSET
;

335 
¶
.
l
 = 
»nc
.
’d
 - 
ROUTE_OFFSET
;

336 
”r
 = 
	`s_addr_decode
(&
addr
, &
¶
);

337 ià(
”r
)

338 
out
;

340 
dlg
->
rou‹
 = 
addr
.
uri
;

343 
uri
 
tmp
;

345 
	`¶_£t_¡r
(&
¶
, 
uri
);

346 
”r
 = 
	`uri_decode
(&
tmp
, &
¶
);

347 ià(
”r
)

348 
out
;

350 
dlg
->
rou‹
 = 
tmp
;

353 
	`mem_d”ef
(
dlg
->
mb
);

354 
	`mem_d”ef
(
dlg
->
uri
);

356 
dlg
->
mb
 = 
	`mem_»f
(
»nc
.mb);

357 
dlg
->
¹ag
 = 
	`mem_»f
(rtag);

358 
dlg
->
uri
 = 
	`mem_»f
(uri);

359 
dlg
->
r£q
 = 
msg
->
»q
 ? msg->
c£q
.
num
 : 0;

360 
dlg
->
ıos
 = 0;

362 
out
:

363 
	`mem_d”ef
(
»nc
.
mb
);

364 
	`mem_d”ef
(
¹ag
);

365 
	`mem_d”ef
(
uri
);

367  
”r
;

368 
	}
}

380 
	$s_dŸlog_fÜk
(
s_dŸlog
 **
dlgp
, s_dŸlog *
odlg
,

381 cÚ¡ 
s_msg
 *
msg
)

383 cÚ¡ 
s_hdr
 *
cÚù
;

384 
s_dŸlog
 *
dlg
;

385 
rou‹_’c
 
»nc
;

386 
s_addr
 
addr
;

387 
¶
…l;

388 
”r
;

390 ià(!
dlgp
 || !
odlg
 || !odlg->
ıos
 || !
msg
)

391  
EINVAL
;

393 
cÚù
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTACT
);

395 ià(!
cÚù
 || !
msg
->
ÿÎid
.
p
)

396  
EBADMSG
;

398 ià(
	`s_addr_decode
(&
addr
, &
cÚù
->
v®
))

399  
EBADMSG
;

401 
dlg
 = 
	`mem_z®loc
((*dlg), 
de¡ruùÜ
);

402 ià(!
dlg
)

403  
ENOMEM
;

405 
dlg
->
ÿÎid
 = 
	`mem_»f
(
odlg
->callid);

406 
dlg
->
Éag
 = 
	`mem_»f
(
odlg
->ltag);

407 
dlg
->
hash
 = 
odlg
->hash;

408 
dlg
->
l£q
 = 
odlg
->lseq;

409 
dlg
->
r£q
 = 
msg
->
»q
 ? msg->
c£q
.
num
 : 0;

411 
”r
 = 
	`¶_¡rdup
(&
dlg
->
uri
, &
addr
.
auri
);

412 ià(
”r
)

413 
out
;

415 
”r
 = 
	`¶_¡rdup
(&
dlg
->
¹ag
, 
msg
->
»q
 ? &msg->
äom
.
g
 : &msg->
to
.tag);

416 ià(
”r
)

417 
out
;

419 
dlg
->
mb
 = 
	`mbuf_®loc
(512);

420 ià(!
dlg
->
mb
) {

421 
”r
 = 
ENOMEM
;

422 
out
;

425 
»nc
.
mb
 = 
dlg
->mb;

426 
»nc
.
’d
 = 0;

428 
”r
 |ğ
	`s_msg_hdr_­¶y
(
msg
, msg->
»q
, 
SIP_HDR_RECORD_ROUTE
,

429 
»cÜd_rou‹_hªdËr
, &
»nc
è? 
ENOMEM
 : 0;

430 
”r
 |ğ
	`mbuf_´štf
(
dlg
->
mb
, "To: %r\r\n",

431 
msg
->
»q
 ? &msg->
äom
.
v®
 : &msg->
to
.val);

433 
odlg
->
mb
->
pos
 = odlg->
ıos
;

434 
”r
 |ğ
	`mbuf_wr™e_mem
(
dlg
->
mb
, 
	`mbuf_buf
(
odlg
->mb),

435 
	`mbuf_g‘_Ëá
(
odlg
->
mb
));

436 
odlg
->
mb
->
pos
 = 0;

438 ià(
”r
)

439 
out
;

441 
dlg
->
mb
->
pos
 = 0;

443 ià(
»nc
.
’d
) {

444 
¶
.
p
 = (cÚ¡ *)
	`mbuf_buf
(
dlg
->
mb
è+ 
ROUTE_OFFSET
;

445 
¶
.
l
 = 
»nc
.
’d
 - 
ROUTE_OFFSET
;

446 
”r
 = 
	`s_addr_decode
(&
addr
, &
¶
);

447 
dlg
->
rou‹
 = 
addr
.
uri
;

450 
	`¶_£t_¡r
(&
¶
, 
dlg
->
uri
);

451 
”r
 = 
	`uri_decode
(&
dlg
->
rou‹
, &
¶
);

454 
out
:

455 ià(
”r
)

456 
	`mem_d”ef
(
dlg
);

458 *
dlgp
 = 
dlg
;

460  
”r
;

461 
	}
}

472 
	$s_dŸlog_upd©e
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
)

474 cÚ¡ 
s_hdr
 *
cÚù
;

475 
s_addr
 
addr
;

476 *
uri
;

477 
”r
;

479 ià(!
dlg
 || !
msg
)

480  
EINVAL
;

482 
cÚù
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_CONTACT
);

483 ià(!
cÚù
)

484  
EBADMSG
;

486 ià(
	`s_addr_decode
(&
addr
, &
cÚù
->
v®
))

487  
EBADMSG
;

489 
”r
 = 
	`¶_¡rdup
(&
uri
, &
addr
.
auri
);

490 ià(
”r
)

491  
”r
;

493 ià(
dlg
->
rou‹
.
scheme
.
p
 =ğdlg->
uri
) {

495 
uri
 
tmp
;

496 
¶
…l;

498 
	`¶_£t_¡r
(&
¶
, 
uri
);

499 
”r
 = 
	`uri_decode
(&
tmp
, &
¶
);

500 ià(
”r
)

501 
out
;

503 
dlg
->
rou‹
 = 
tmp
;

506 
	`mem_d”ef
(
dlg
->
uri
);

507 
dlg
->
uri
 = 
	`mem_»f
(uri);

509 
out
:

510 
	`mem_d”ef
(
uri
);

512  
”r
;

513 
	}
}

524 
boŞ
 
	$s_dŸlog_r£q_v®id
(
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
)

526 ià(!
dlg
 || !
msg
 || !msg->
»q
)

527  
çl£
;

529 ià(
msg
->
c£q
.
num
 < 
dlg
->
r£q
)

530  
çl£
;

532 
dlg
->
r£q
 = 
msg
->
c£q
.
num
;

534  
Œue
;

535 
	}
}

538 
	$s_dŸlog_’code
(
mbuf
 *
mb
, 
s_dŸlog
 *
dlg
, 
ušt32_t
 
c£q
,

539 cÚ¡ *
m‘
)

541 
”r
 = 0;

543 ià(!
mb
 || !
dlg
 || !
m‘
)

544  
EINVAL
;

546 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
	`mbuf_buf
(
dlg
->mb), 
	`mbuf_g‘_Ëá
(dlg->mb));

547 
”r
 |ğ
	`mbuf_´štf
(
mb
, "C®l-ID: %s\r\n", 
dlg
->
ÿÎid
);

548 
”r
 |ğ
	`mbuf_´štf
(
mb
, "CSeq: %u %s\r\n", 
	`¡rcmp
(
m‘
, "ACK") ?

549 
dlg
->
l£q
++ : 
c£q
, 
m‘
);

551  
”r
;

552 
	}
}

555 cÚ¡ *
	$s_dŸlog_uri
(cÚ¡ 
s_dŸlog
 *
dlg
)

557  
dlg
 ? dlg->
uri
 : 
NULL
;

558 
	}
}

561 cÚ¡ 
uri
 *
	$s_dŸlog_rou‹
(cÚ¡ 
s_dŸlog
 *
dlg
)

563  
dlg
 ? &dlg->
rou‹
 : 
NULL
;

564 
	}
}

567 
ušt32_t
 
	$s_dŸlog_hash
(cÚ¡ 
s_dŸlog
 *
dlg
)

569  
dlg
 ? dlg->
hash
 : 0;

570 
	}
}

580 cÚ¡ *
	$s_dŸlog_ÿÎid
(cÚ¡ 
s_dŸlog
 *
dlg
)

582  
dlg
 ? dlg->
ÿÎid
 : 
NULL
;

583 
	}
}

593 
ušt32_t
 
	$s_dŸlog_l£q
(cÚ¡ 
s_dŸlog
 *
dlg
)

595  
dlg
 ? dlg->
l£q
 : 0;

596 
	}
}

606 
boŞ
 
	$s_dŸlog_e¡ablished
(cÚ¡ 
s_dŸlog
 *
dlg
)

608  
dlg
 && dlg->
¹ag
;

609 
	}
}

620 
boŞ
 
	$s_dŸlog_cmp
(cÚ¡ 
s_dŸlog
 *
dlg
, cÚ¡ 
s_msg
 *
msg
)

622 ià(!
dlg
 || !
msg
)

623  
çl£
;

625 ià(
	`¶_¡rcmp
(&
msg
->
ÿÎid
, 
dlg
->callid))

626  
çl£
;

628 ià(
	`¶_¡rcmp
(
msg
->
»q
 ? &msg->
to
.
g
 : &msg->
äom
.g, 
dlg
->
Éag
))

629  
çl£
;

631 ià(
	`¶_¡rcmp
(
msg
->
»q
 ? &msg->
äom
.
g
 : &msg->
to
.g, 
dlg
->
¹ag
))

632  
çl£
;

634  
Œue
;

635 
	}
}

646 
boŞ
 
	$s_dŸlog_cmp_h®f
(cÚ¡ 
s_dŸlog
 *
dlg
,

647 cÚ¡ 
s_msg
 *
msg
)

649 ià(!
dlg
 || !
msg
)

650  
çl£
;

652 ià(
	`¶_¡rcmp
(&
msg
->
ÿÎid
, 
dlg
->callid))

653  
çl£
;

655 ià(
	`¶_¡rcmp
(
msg
->
»q
 ? &msg->
to
.
g
 : &msg->
äom
.g, 
dlg
->
Éag
))

656  
çl£
;

658  
Œue
;

659 
	}
}

	@re-0.5.6/src/sip/keepalive.c

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_mem.h
>

11 
	~<»_mbuf.h
>

12 
	~<»_§.h
>

13 
	~<»_li¡.h
>

14 
	~<»_sys.h
>

15 
	~<»_uri.h
>

16 
	~<»_udp.h
>

17 
	~<»_msg.h
>

18 
	~<»_s.h
>

19 
	~"s.h
"

22 
	$de¡ruùÜ
(*
¬g
)

24 
s_k“·live
 *
ka
 = 
¬g
;

26 ià(
ka
->
k­
)

27 *
ka
->
k­
 = 
NULL
;

29 
	`li¡_uÆšk
(&
ka
->
Ë
);

30 
	}
}

33 
	$s_k“·live_sigÇl
(
li¡
 *
k®
, 
”r
)

35 
Ë
 *Ë = 
	`li¡_h—d
(
k®
);

37 
Ë
) {

39 
s_k“·live
 *
ka
 = 
Ë
->
d©a
;

40 
s_k“·live_h
 *
kah
 = 
ka
->kah;

41 *
¬g
 = 
ka
->arg;

43 
Ë
 =†e->
Ãxt
;

45 
	`li¡_uÆšk
(&
ka
->
Ë
);

46 
	`mem_d”ef
(
ka
);

48 
	`kah
(
”r
, 
¬g
);

50 
	}
}

53 
ušt64_t
 
	$s_k“·live_wa™
(
ušt32_t
 
š‹rv®
)

55  
š‹rv®
 * (800 + 
	`¿nd_u16
() % 201);

56 
	}
}

71 
	$s_k“·live_¡¬t
(
s_k“·live
 **
k­
, 
s
 *sip,

72 cÚ¡ 
s_msg
 *
msg
, 
ušt32_t
 
š‹rv®
,

73 
s_k“·live_h
 *
kah
, *
¬g
)

75 
s_k“·live
 *
ka
;

76 
”r
;

78 ià(!
k­
 || !
s
 || !
msg
 || !
kah
)

79  
EINVAL
;

81 
ka
 = 
	`mem_z®loc
((*ka), 
de¡ruùÜ
);

82 ià(!
ka
)

83  
ENOMEM
;

85 
ka
->
kah
 = kah;

86 
ka
->
¬g
 =‡rg;

88 
msg
->

) {

90 
SIP_TRANSP_UDP
:

91 
”r
 = 
	`s_k“·live_udp
(
ka
, 
s
, (
udp_sock
 *)
msg
->
sock
,

92 &
msg
->
¤c
, 
š‹rv®
);

95 
SIP_TRANSP_TCP
:

96 
SIP_TRANSP_TLS
:

97 
”r
 = 
	`s_k“·live_tı
(
ka
, (
s_cÚn
 *)
msg
->
sock
,

98 
š‹rv®
);

102 
”r
 = 
EPROTONOSUPPORT
;

106 ià(
”r
) {

107 
	`mem_d”ef
(
ka
);

110 
ka
->
k­
 = kap;

111 *
k­
 = 
ka
;

114  
”r
;

115 
	}
}

	@re-0.5.6/src/sip/keepalive_udp.c

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_li¡.h
>

13 
	~<»_hash.h
>

14 
	~<»_fmt.h
>

15 
	~<»_uri.h
>

16 
	~<»_sys.h
>

17 
	~<»_tmr.h
>

18 
	~<»_udp.h
>

19 
	~<»_¡un.h
>

20 
	~<»_msg.h
>

21 
	~<»_s.h
>

22 
	~"s.h
"

26 
	mUDP_KEEPALIVE_INTVAL
 = 29,

30 
	ss_udpcÚn
 {

31 
Ë
 
	mhe
;

32 
li¡
 
	mk®
;

33 
tmr
 
	mtmr_ka
;

34 
§
 
	mmaddr
;

35 
§
 
	m·ddr
;

36 
udp_sock
 *
	mus
;

37 
¡un_ù¿ns
 *
	mù
;

38 
¡un
 *
	m¡un
;

39 
ušt32_t
 
	mka_š‹rv®
;

43 
udpcÚn_k“·live_hªdËr
(*
¬g
);

46 
	$de¡ruùÜ
(*
¬g
)

48 
s_udpcÚn
 *
uc
 = 
¬g
;

50 
	`li¡_æush
(&
uc
->
k®
);

51 
	`hash_uÆšk
(&
uc
->
he
);

52 
	`tmr_ÿnûl
(&
uc
->
tmr_ka
);

53 
	`mem_d”ef
(
uc
->
ù
);

54 
	`mem_d”ef
(
uc
->
us
);

55 
	`mem_d”ef
(
uc
->
¡un
);

56 
	}
}

59 
	$udpcÚn_şo£
(
s_udpcÚn
 *
uc
, 
”r
)

61 
	`s_k“·live_sigÇl
(&
uc
->
k®
, 
”r
);

62 
	`hash_uÆšk
(&
uc
->
he
);

63 
	`tmr_ÿnûl
(&
uc
->
tmr_ka
);

64 
uc
->
ù
 = 
	`mem_d”ef
(uc->ct);

65 
uc
->
us
 = 
	`mem_d”ef
(uc->us);

66 
uc
->
¡un
 = 
	`mem_d”ef
(uc->stun);

67 
	}
}

70 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

71 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

73 
s_udpcÚn
 *
uc
 = 
¬g
;

74 
¡un_©Œ
 *
©Œ
;

75 ()
»asÚ
;

77 ià(
”r
 || 
scode
) {

78 
”r
 =ƒ¼ ?ƒ¼ : 
EPROTO
;

79 
out
;

82 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

83 ià(!
©Œ
) {

84 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

85 ià(!
©Œ
) {

86 
”r
 = 
EPROTO
;

87 
out
;

91 ià(!
	`§_is£t
(&
uc
->
maddr
, 
SA_ALL
)) {

92 
uc
->
maddr
 = 
©Œ
->
v
.
§
;

94 ià(!
	`§_cmp
(&
uc
->
maddr
, &
©Œ
->
v
.
§
, 
SA_ALL
)) {

95 
”r
 = 
ENOTCONN
;

96 
out
;

99 
out
:

100 ià(
”r
) {

101 
	`udpcÚn_şo£
(
uc
, 
”r
);

102 
	`mem_d”ef
(
uc
);

105 
	`tmr_¡¬t
(&
uc
->
tmr_ka
, 
	`s_k“·live_wa™
(uc->
ka_š‹rv®
),

106 
udpcÚn_k“·live_hªdËr
, 
uc
);

108 
	}
}

111 
	$udpcÚn_k“·live_hªdËr
(*
¬g
)

113 
s_udpcÚn
 *
uc
 = 
¬g
;

114 
”r
;

116 ià(!
uc
->
k®
.
h—d
) {

118 
	`udpcÚn_şo£
(
uc
, 0);

119 
	`mem_d”ef
(
uc
);

123 
”r
 = 
	`¡un_»que¡
(&
uc
->
ù
, uc->
¡un
, 
IPPROTO_UDP
, uc->
us
,

124 &
uc
->
·ddr
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0,

125 
çl£
, 
¡un_»¥Ú£_hªdËr
, 
uc
, 1,

126 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

127 ià(
”r
) {

128 
	`udpcÚn_şo£
(
uc
, 
”r
);

129 
	`mem_d”ef
(
uc
);

131 
	}
}

134 
s_udpcÚn
 *
	$udpcÚn_fšd
(
s
 *s, 
udp_sock
 *
us
,

135 cÚ¡ 
§
 *
·ddr
)

137 
Ë
 *le;

139 
Ë
 = 
	`li¡_h—d
(
	`hash_li¡
(
s
->
ht_udpcÚn
, 
	`§_hash
(
·ddr
, 
SA_ALL
)));

141 ; 
Ë
;†ğË->
Ãxt
) {

143 
s_udpcÚn
 *
uc
 = 
Ë
->
d©a
;

145 ià(!
	`§_cmp
(&
uc
->
·ddr
,…addr, 
SA_ALL
))

148 ià(
uc
->
us
 != us)

151  
uc
;

154  
NULL
;

155 
	}
}

158 
	$s_k“·live_udp
(
s_k“·live
 *
ka
, 
s
 *sip,

159 
udp_sock
 *
us
, cÚ¡ 
§
 *
·ddr
,

160 
ušt32_t
 
š‹rv®
)

162 
s_udpcÚn
 *
uc
;

164 ià(!
ka
 || !
s
 || !
us
 || !
·ddr
)

165  
EINVAL
;

167 
uc
 = 
	`udpcÚn_fšd
(
s
, 
us
, 
·ddr
);

168 ià(!
uc
) {

169 
uc
 = 
	`mem_z®loc
((*uc), 
de¡ruùÜ
);

170 ià(!
uc
)

171  
ENOMEM
;

173 
	`hash_­³nd
(
s
->
ht_udpcÚn
, 
	`§_hash
(
·ddr
, 
SA_ALL
),

174 &
uc
->
he
, uc);

176 
uc
->
·ddr
 = *paddr;

177 
uc
->
¡un
 = 
	`mem_»f
(
s
->stun);

178 
uc
->
us
 = 
	`mem_»f
(us);

179 
uc
->
ka_š‹rv®
 = 
š‹rv®
 ? iÁ”v® : 
UDP_KEEPALIVE_INTVAL
;

182 
	`tmr_¡¬t
(&
uc
->
tmr_ka
, 0, 
udpcÚn_k“·live_hªdËr
, uc);

185 
	`li¡_­³nd
(&
uc
->
k®
, &
ka
->
Ë
, ka);

188 
	}
}

	@re-0.5.6/src/sip/msg.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_sys.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_li¡.h
>

13 
	~<»_hash.h
>

14 
	~<»_fmt.h
>

15 
	~<»_uri.h
>

16 
	~<»_udp.h
>

17 
	~<»_msg.h
>

18 
	~<»_s.h
>

19 
	~"s.h
"

23 
	mHDR_HASH_SIZE
 = 32,

24 
	mSTARTLINE_MAX
 = 8192,

28 
	$hdr_de¡ruùÜ
(*
¬g
)

30 
s_hdr
 *
hdr
 = 
¬g
;

32 
	`li¡_uÆšk
(&
hdr
->
Ë
);

33 
	`hash_uÆšk
(&
hdr
->
he
);

34 
	}
}

37 
	$de¡ruùÜ
(*
¬g
)

39 
s_msg
 *
msg
 = 
¬g
;

41 
	`li¡_æush
(&
msg
->
hd¾
);

42 
	`hash_æush
(
msg
->
hdrht
);

43 
	`mem_d”ef
(
msg
->
hdrht
);

44 
	`mem_d”ef
(
msg
->
sock
);

45 
	`mem_d”ef
(
msg
->
mb
);

46 
	}
}

49 
s_hdrid
 
	$hdr_hash
(cÚ¡ 
¶
 *
Çme
)

51 ià(!
Çme
->
l
)

52  
SIP_HDR_NONE
;

54 ià(
Çme
->
l
 > 1) {

55 
Çme
->
p
[0]) {

59 ià(
Çme
->
p
[1] == '-')

60  
SIP_HDR_NONE
;

65  (
s_hdrid
)

66 (
	`hash_jß©_ci
(
Çme
->
p
,‚ame->
l
) & 0xfff);

71 
	`tŞow”
(
Çme
->
p
[0])) {

73 'a':  
SIP_HDR_ACCEPT_CONTACT
;

74 'b':  
SIP_HDR_REFERRED_BY
;

75 'c':  
SIP_HDR_CONTENT_TYPE
;

76 'd':  
SIP_HDR_REQUEST_DISPOSITION
;

77 'e':  
SIP_HDR_CONTENT_ENCODING
;

78 'f':  
SIP_HDR_FROM
;

79 'i':  
SIP_HDR_CALL_ID
;

80 'j':  
SIP_HDR_REJECT_CONTACT
;

81 'k':  
SIP_HDR_SUPPORTED
;

82 'l':  
SIP_HDR_CONTENT_LENGTH
;

83 'm':  
SIP_HDR_CONTACT
;

84 'n':  
SIP_HDR_IDENTITY_INFO
;

85 'o':  
SIP_HDR_EVENT
;

86 'r':  
SIP_HDR_REFER_TO
;

87 's':  
SIP_HDR_SUBJECT
;

88 't':  
SIP_HDR_TO
;

89 'u':  
SIP_HDR_ALLOW_EVENTS
;

90 'v':  
SIP_HDR_VIA
;

91 'x':  
SIP_HDR_SESSION_EXPIRES
;

92 'y':  
SIP_HDR_IDENTITY
;

93 :  
SIP_HDR_NONE
;

95 
	}
}

98 
šlše
 
boŞ
 
	$hdr_comma_£·¿‹d
(
s_hdrid
 
id
)

100 
id
) {

102 
SIP_HDR_ACCEPT
:

103 
SIP_HDR_ACCEPT_CONTACT
:

104 
SIP_HDR_ACCEPT_ENCODING
:

105 
SIP_HDR_ACCEPT_LANGUAGE
:

106 
SIP_HDR_ACCEPT_RESOURCE_PRIORITY
:

107 
SIP_HDR_ALERT_INFO
:

108 
SIP_HDR_ALLOW
:

109 
SIP_HDR_ALLOW_EVENTS
:

110 
SIP_HDR_AUTHENTICATION_INFO
:

111 
SIP_HDR_CALL_INFO
:

112 
SIP_HDR_CONTACT
:

113 
SIP_HDR_CONTENT_ENCODING
:

114 
SIP_HDR_CONTENT_LANGUAGE
:

115 
SIP_HDR_ERROR_INFO
:

116 
SIP_HDR_HISTORY_INFO
:

117 
SIP_HDR_IN_REPLY_TO
:

118 
SIP_HDR_P_ASSERTED_IDENTITY
:

119 
SIP_HDR_P_ASSOCIATED_URI
:

120 
SIP_HDR_P_EARLY_MEDIA
:

121 
SIP_HDR_P_MEDIA_AUTHORIZATION
:

122 
SIP_HDR_P_PREFERRED_IDENTITY
:

123 
SIP_HDR_P_REFUSED_URI_LIST
:

124 
SIP_HDR_P_VISITED_NETWORK_ID
:

125 
SIP_HDR_PATH
:

126 
SIP_HDR_PERMISSION_MISSING
:

127 
SIP_HDR_PROXY_REQUIRE
:

128 
SIP_HDR_REASON
:

129 
SIP_HDR_RECORD_ROUTE
:

130 
SIP_HDR_REJECT_CONTACT
:

131 
SIP_HDR_REQUEST_DISPOSITION
:

132 
SIP_HDR_REQUIRE
:

133 
SIP_HDR_RESOURCE_PRIORITY
:

134 
SIP_HDR_ROUTE
:

135 
SIP_HDR_SECURITY_CLIENT
:

136 
SIP_HDR_SECURITY_SERVER
:

137 
SIP_HDR_SECURITY_VERIFY
:

138 
SIP_HDR_SERVICE_ROUTE
:

139 
SIP_HDR_SUPPORTED
:

140 
SIP_HDR_TRIGGER_CONSENT
:

141 
SIP_HDR_UNSUPPORTED
:

142 
SIP_HDR_VIA
:

143 
SIP_HDR_WARNING
:

144  
Œue
;

147  
çl£
;

149 
	}
}

152 
šlše
 
	$hdr_add
(
s_msg
 *
msg
, cÚ¡ 
¶
 *
Çme
,

153 
s_hdrid
 
id
, cÚ¡ *
p
, 
ssize_t
 
l
,

154 
boŞ
 
©omic
, boŞ 
lše
)

156 
s_hdr
 *
hdr
;

157 
”r
 = 0;

159 
hdr
 = 
	`mem_z®loc
((*hdr), 
hdr_de¡ruùÜ
);

160 ià(!
hdr
)

161  
ENOMEM
;

163 
hdr
->
Çme
 = *name;

164 
hdr
->
v®
.
p
 =…;

165 
hdr
->
v®
.
l
 = 
	`MAX
(l, 0);

166 
hdr
->
id
 = id;

168 
id
) {

170 
SIP_HDR_VIA
:

171 
SIP_HDR_ROUTE
:

172 ià(!
©omic
)

175 
	`hash_­³nd
(
msg
->
hdrht
, 
id
, &
hdr
->
he
, 
	`mem_»f
(hdr));

176 
	`li¡_­³nd
(&
msg
->
hd¾
, &
hdr
->
Ë
, 
	`mem_»f
(hdr));

180 ià(
©omic
)

181 
	`hash_­³nd
(
msg
->
hdrht
, 
id
, &
hdr
->
he
, 
	`mem_»f
(hdr));

182 ià(
lše
)

183 
	`li¡_­³nd
(&
msg
->
hd¾
, &
hdr
->
Ë
, 
	`mem_»f
(hdr));

188 
id
) {

190 
SIP_HDR_VIA
:

191 ià(!
©omic
 || 
	`¶_is£t
(&
msg
->
vŸ
.
£Áby
))

194 
”r
 = 
	`s_vŸ_decode
(&
msg
->
vŸ
, &
hdr
->
v®
);

197 
SIP_HDR_TO
:

198 
”r
 = 
	`s_addr_decode
((
s_addr
 *)&
msg
->
to
, &
hdr
->
v®
);

199 ià(
”r
)

202 ()
	`msg_·¿m_decode
(&
msg
->
to
.
·¿ms
, "g", &msg->to.
g
);

203 
msg
->
to
.
v®
 = 
hdr
->val;

206 
SIP_HDR_FROM
:

207 
”r
 = 
	`s_addr_decode
((
s_addr
 *)&
msg
->
äom
,

208 &
hdr
->
v®
);

209 ià(
”r
)

212 ()
	`msg_·¿m_decode
(&
msg
->
äom
.
·¿ms
, "tag",

213 &
msg
->
äom
.
g
);

214 
msg
->
äom
.
v®
 = 
hdr
->val;

217 
SIP_HDR_CALL_ID
:

218 
msg
->
ÿÎid
 = 
hdr
->
v®
;

221 
SIP_HDR_CSEQ
:

222 
”r
 = 
	`s_c£q_decode
(&
msg
->
c£q
, &
hdr
->
v®
);

225 
SIP_HDR_MAX_FORWARDS
:

226 
msg
->
maxfwd
 = 
hdr
->
v®
;

229 
SIP_HDR_CONTENT_TYPE
:

230 
”r
 = 
	`msg_ùy³_decode
(&
msg
->
ùyp
, &
hdr
->
v®
);

233 
SIP_HDR_CONTENT_LENGTH
:

234 
msg
->
ş’
 = 
hdr
->
v®
;

237 
SIP_HDR_EXPIRES
:

238 
msg
->
expœes
 = 
hdr
->
v®
;

246 
	`mem_d”ef
(
hdr
);

248  
”r
;

249 
	}
}

260 
	$s_msg_decode
(
s_msg
 **
msgp
, 
mbuf
 *
mb
)

262 
¶
 
x
, 
y
, 
z
, 
e
, 
Çme
;

263 cÚ¡ *
p
, *
v
, *
cv
;

264 
s_msg
 *
msg
;

265 
boŞ
 
com£p
, 
quÙe
;

266 
s_hdrid
 
id
 = 
SIP_HDR_NONE
;

267 
ušt32_t
 
ws
, 
lf
;

268 
size_t
 
l
;

269 
”r
;

271 ià(!
msgp
 || !
mb
)

272  
EINVAL
;

274 
p
 = (cÚ¡ *)
	`mbuf_buf
(
mb
);

275 
l
 = 
	`mbuf_g‘_Ëá
(
mb
);

277 ià(
	`»_»gex
(
p
, 
l
, "[^ \t\r\n]+ [^ \t\r\n]+ [^\r\n]*[\r]*[\n]1",

278 &
x
, &
y
, &
z
, 
NULL
, &
e
è|| x.
p
 !ğ(*)
	`mbuf_buf
(
mb
))

279  (
l
 > 
STARTLINE_MAX
è? 
EBADMSG
 : 
ENODATA
;

281 
msg
 = 
	`mem_z®loc
((*msg), 
de¡ruùÜ
);

282 ià(!
msg
)

283  
ENOMEM
;

285 
”r
 = 
	`hash_®loc
(&
msg
->
hdrht
, 
HDR_HASH_SIZE
);

286 ià(
”r
)

287 
out
;

289 
msg
->
g
 = 
	`¿nd_u64
();

290 
msg
->
mb
 = 
	`mem_»f
(mb);

291 
msg
->
»q
 = (0 =ğ
	`¶_¡rcmp
(&
z
, "SIP/2.0"));

293 ià(
msg
->
»q
) {

295 
msg
->
m‘
 = 
x
;

296 
msg
->
ruri
 = 
y
;

297 
msg
->
v”
 = 
z
;

299 ià(
	`uri_decode
(&
msg
->
uri
, &
y
)) {

300 
”r
 = 
EBADMSG
;

301 
out
;

305 
msg
->
v”
 = 
x
;

306 
msg
->
scode
 = 
	`¶_u32
(&
y
);

307 
msg
->
»asÚ
 = 
z
;

309 ià(!
msg
->
scode
) {

310 
”r
 = 
EBADMSG
;

311 
out
;

315 
l
 -ğ
e
.
p
 +ƒ.l -…;

316 
p
 = 
e
.°+ƒ.
l
;

318 
Çme
.
p
 = 
v
 = 
cv
 = 
NULL
;

319 
Çme
.
l
 = 
ws
 = 
lf
 = 0;

320 
com£p
 = 
çl£
;

321 
quÙe
 = 
çl£
;

323 ; 
l
 > 0; 
p
++,†--) {

325 *
p
) {

329 
lf
 = 0;

330 ++
ws
;

334 ++
ws
;

338 ++
ws
;

340 ià(!
lf
++)

343 ++
p
; --
l
;

348 ià(
lf
 || (*
p
 =ğ',' && 
com£p
 && !
quÙe
)) {

350 ià(!
Çme
.
l
) {

351 
”r
 = 
EBADMSG
;

352 
out
;

355 
”r
 = 
	`hdr_add
(
msg
, &
Çme
, 
id
, 
cv
 ? cv : 
p
,

356 
cv
 ? 
p
 - cv - 
ws
 : 0,

357 
Œue
, 
cv
 =ğ
v
 && 
lf
);

358 ià(
”r
)

359 
out
;

361 ià(!
lf
) {

362 
cv
 = 
NULL
;

366 ià(
cv
 !ğ
v
) {

367 
”r
 = 
	`hdr_add
(
msg
, &
Çme
, 
id
,

368 
v
 ? v : 
p
,

369 
v
 ? 
p
 - v - 
ws
 : 0,

370 
çl£
, 
Œue
);

371 ià(
”r
)

372 
out
;

375 ià(
lf
 > 1) {

376 
”r
 = 0;

377 
out
;

380 
com£p
 = 
çl£
;

381 
Çme
.
p
 = 
NULL
;

382 
cv
 = 
v
 = 
NULL
;

383 
lf
 = 0;

386 ià(!
Çme
.
p
) {

387 
Çme
.
p
 =…;

388 
Çme
.
l
 = 0;

389 
ws
 = 0;

392 ià(!
Çme
.
l
) {

393 ià(*
p
 != ':') {

394 
ws
 = 0;

398 
Çme
.
l
 = 
	`MAX
(()(
p
 -‚ame.°- 
ws
), 0);

399 ià(!
Çme
.
l
) {

400 
”r
 = 
EBADMSG
;

401 
out
;

404 
id
 = 
	`hdr_hash
(&
Çme
);

405 
com£p
 = 
	`hdr_comma_£·¿‹d
(
id
);

409 ià(!
cv
) {

410 
quÙe
 = 
çl£
;

411 
cv
 = 
p
;

414 ià(!
v
) {

415 
v
 = 
p
;

418 ià(*
p
 == '"')

419 
quÙe
 = !quote;

421 
ws
 = 0;

426 
”r
 = 
ENODATA
;

428 
out
:

429 ià(
”r
)

430 
	`mem_d”ef
(
msg
);

432 *
msgp
 = 
msg
;

433 
mb
->
pos
 = mb->
’d
 - 
l
;

436  
”r
;

437 
	}
}

448 cÚ¡ 
s_hdr
 *
	$s_msg_hdr
(cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
id
)

450  
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
NULL
, NULL);

451 
	}
}

465 cÚ¡ 
s_hdr
 *
	$s_msg_hdr_­¶y
(cÚ¡ 
s_msg
 *
msg
,

466 
boŞ
 
fwd
, 
s_hdrid
 
id
,

467 
s_hdr_h
 *
h
, *
¬g
)

469 
li¡
 *
l¡
;

470 
Ë
 *le;

472 ià(!
msg
)

473  
NULL
;

475 
l¡
 = 
	`hash_li¡
(
msg
->
hdrht
, 
id
);

477 
Ë
 = 
fwd
 ? 
	`li¡_h—d
(
l¡
è: 
	`li¡_
(lst);

479 
Ë
) {

480 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

482 
Ë
 = 
fwd
 ?†e->
Ãxt
 :†e->
´ev
;

484 ià(
hdr
->
id
 != id)

487 ià(!
h
 || 
	`h
(
hdr
, 
msg
, 
¬g
))

488  
hdr
;

491  
NULL
;

492 
	}
}

503 cÚ¡ 
s_hdr
 *
	$s_msg_xhdr
(cÚ¡ 
s_msg
 *
msg
, cÚ¡ *
Çme
)

505  
	`s_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
NULL
, NULL);

506 
	}
}

520 cÚ¡ 
s_hdr
 *
	$s_msg_xhdr_­¶y
(cÚ¡ 
s_msg
 *
msg
,

521 
boŞ
 
fwd
, cÚ¡ *
Çme
,

522 
s_hdr_h
 *
h
, *
¬g
)

524 
li¡
 *
l¡
;

525 
Ë
 *le;

526 
¶
…l;

528 ià(!
msg
 || !
Çme
)

529  
NULL
;

531 
	`¶_£t_¡r
(&
¶
, 
Çme
);

533 
l¡
 = 
	`hash_li¡
(
msg
->
hdrht
, 
	`hdr_hash
(&
¶
));

535 
Ë
 = 
fwd
 ? 
	`li¡_h—d
(
l¡
è: 
	`li¡_
(lst);

537 
Ë
) {

538 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

540 
Ë
 = 
fwd
 ?†e->
Ãxt
 :†e->
´ev
;

542 ià(
	`¶_ÿ£cmp
(&
hdr
->
Çme
, &
¶
))

545 ià(!
h
 || 
	`h
(
hdr
, 
msg
, 
¬g
))

546  
hdr
;

549  
NULL
;

550 
	}
}

553 
boŞ
 
	$couÁ_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
, cÚ¡ 
s_msg
 *
msg
,

554 *
¬g
)

556 
ušt32_t
 *
n
 = 
¬g
;

557 ()
hdr
;

558 ()
msg
;

560 ++(*
n
);

562  
çl£
;

563 
	}
}

574 
ušt32_t
 
	$s_msg_hdr_couÁ
(cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
id
)

576 
ušt32_t
 
n
 = 0;

578 
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
couÁ_hªdËr
, &
n
);

580  
n
;

581 
	}
}

592 
ušt32_t
 
	$s_msg_xhdr_couÁ
(cÚ¡ 
s_msg
 *
msg
, cÚ¡ *
Çme
)

594 
ušt32_t
 
n
 = 0;

596 
	`s_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
couÁ_hªdËr
, &
n
);

598  
n
;

599 
	}
}

602 
boŞ
 
	$v®ue_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
, cÚ¡ 
s_msg
 *
msg
,

603 *
¬g
)

605 ()
msg
;

607  0 =ğ
	`¶_¡rÿ£cmp
(&
hdr
->
v®
, (cÚ¡ *)
¬g
);

608 
	}
}

620 
boŞ
 
	$s_msg_hdr_has_v®ue
(cÚ¡ 
s_msg
 *
msg
, 
s_hdrid
 
id
,

621 cÚ¡ *
v®ue
)

623  
NULL
 !ğ
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
id
, 
v®ue_hªdËr
,

624 (*)
v®ue
);

625 
	}
}

637 
boŞ
 
	$s_msg_xhdr_has_v®ue
(cÚ¡ 
s_msg
 *
msg
, cÚ¡ *
Çme
,

638 cÚ¡ *
v®ue
)

640  
NULL
 !ğ
	`s_msg_xhdr_­¶y
(
msg
, 
Œue
, 
Çme
, 
v®ue_hªdËr
,

641 (*)
v®ue
);

642 
	}
}

650 
	$s_msg_dump
(cÚ¡ 
s_msg
 *
msg
)

652 
Ë
 *le;

653 
ušt32_t
 
i
;

655 ià(!
msg
)

658 
i
=0; i<
HDR_HASH_SIZE
; i++) {

660 
Ë
 = 
	`li¡_h—d
(
	`hash_li¡
(
msg
->
hdrht
, 
i
));

662 
Ë
) {

663 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

665 
Ë
 =†e->
Ãxt
;

667 ()
	`»_´štf
("%02u '%r'='%r'\n", 
i
, &
hdr
->
Çme
,

668 &
hdr
->
v®
);

672 
Ë
 = 
	`li¡_h—d
(&
msg
->
hd¾
);

674 
Ë
) {

675 cÚ¡ 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

677 
Ë
 =†e->
Ãxt
;

679 ()
	`»_´štf
("%02u '%r'='%r'\n", 
hdr
->
id
, &hdr->
Çme
,

680 &
hdr
->
v®
);

682 
	}
}

	@re-0.5.6/src/sip/reply.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_fmt.h
>

12 
	~<»_uri.h
>

13 
	~<»_udp.h
>

14 
	~<»_msg.h
>

15 
	~<»_s.h
>

16 
	~"s.h
"

19 
	$v»¶yf
(
s_¡¿ns
 **
¡p
, 
mbuf
 **
mbp
, 
boŞ
 
Œªs
,

20 
s
 *s, cÚ¡ 
s_msg
 *
msg
, 
boŞ
 
»c_rou‹
,

21 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

22 cÚ¡ *
fmt
, 
va_li¡
 
­
)

24 
boŞ
 
½Üt
 = 
çl£
;

25 
ušt32_t
 
vŸc
 = 0;

26 
mbuf
 *
mb
;

27 
§
 
d¡
;

28 
Ë
 *le;

29 
”r
;

31 ià(!
s
 || !
msg
 || !
»asÚ
)

32  
EINVAL
;

34 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "ACK"))

37 
mb
 = 
	`mbuf_®loc
(1024);

38 ià(!
mb
) {

39 
”r
 = 
ENOMEM
;

40 
out
;

43 
”r
 = 
	`mbuf_´štf
(
mb
, "SIP/2.0 %u %s\r\n", 
scode
, 
»asÚ
);

45 
Ë
 = 
msg
->
hd¾
.
h—d
;†e;†ğË->
Ãxt
) {

47 
s_hdr
 *
hdr
 = 
Ë
->
d©a
;

48 
¶
 
½
;

50 
hdr
->
id
) {

52 
SIP_HDR_VIA
:

53 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%r: ", &
hdr
->
Çme
);

54 ià(
vŸc
++) {

55 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%r\r\n", &
hdr
->
v®
);

59 ià(!
	`msg_·¿m_exi¡s
(&
msg
->
vŸ
.
·¿ms
, "½Üt", &
½
)){

60 
”r
 |ğ
	`mbuf_wr™e_¶_sk
(
mb
, &
hdr
->
v®
, &
½
);

61 
”r
 |ğ
	`mbuf_´štf
(
mb
, ";rport=%u",

62 
	`§_pÜt
(&
msg
->
¤c
));

63 
½Üt
 = 
Œue
;

66 
”r
 |ğ
	`mbuf_wr™e_¶
(
mb
, &
hdr
->
v®
);

68 ià(
½Üt
 || !
	`§_cmp
(&
msg
->
¤c
, &msg->
vŸ
.
addr
,

69 
SA_ADDR
))

70 
”r
 |ğ
	`mbuf_´štf
(
mb
, ";received=%j",

71 &
msg
->
¤c
);

73 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "\r\n");

76 
SIP_HDR_TO
:

77 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%r: %r", &
hdr
->
Çme
,

78 &
hdr
->
v®
);

79 ià(!
	`¶_is£t
(&
msg
->
to
.
g
è&& 
scode
 > 100)

80 
”r
 |ğ
	`mbuf_´štf
(
mb
, ";tag=%016llx",

81 
msg
->
g
);

82 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, "\r\n");

85 
SIP_HDR_RECORD_ROUTE
:

86 ià(!
»c_rou‹
)

91 
SIP_HDR_FROM
:

92 
SIP_HDR_CALL_ID
:

93 
SIP_HDR_CSEQ
:

94 
”r
 |ğ
	`mbuf_´štf
(
mb
, "%r: %r\r\n",

95 &
hdr
->
Çme
, &hdr->
v®
);

103 ià(
s
->
soáw¬e
)

104 
”r
 |ğ
	`mbuf_´štf
(
mb
, "S”v”: %s\r\n", 
s
->
soáw¬e
);

106 ià(
fmt
)

107 
”r
 |ğ
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

109 
”r
 |ğ
	`mbuf_´štf
(
mb
, "Content-Length: 0\r\n\r\n");

111 ià(
”r
)

112 
out
;

114 
mb
->
pos
 = 0;

116 
	`s_»¶y_addr
(&
d¡
, 
msg
, 
½Üt
);

118 ià(
Œªs
) {

119 
”r
 = 
	`s_¡¿ns_»¶y
(
¡p
, 
s
, 
msg
, &
d¡
, 
scode
, 
mb
);

122 
”r
 = 
	`s_£nd
(
s
, 
msg
->
sock
, msg->

, &
d¡
, 
mb
);

125 
out
:

126 ià(
”r
 && 
¡p
)

127 *
¡p
 = 
	`mem_d”ef
(*stp);

129 ià(!
”r
 && 
mbp
)

130 *
mbp
 = 
mb
;

132 
	`mem_d”ef
(
mb
);

134  
”r
;

135 
	}
}

152 
	$s_Œ•lyf
(
s_¡¿ns
 **
¡p
, 
mbuf
 **
mbp
, 
s
 *sip,

153 cÚ¡ 
s_msg
 *
msg
, 
boŞ
 
»c_rou‹
, 
ušt16_t
 
scode
,

154 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, ...)

156 
va_li¡
 
­
;

157 
”r
;

159 
	`va_¡¬t
(
­
, 
fmt
);

160 
”r
 = 
	`v»¶yf
(
¡p
, 
mbp
, 
Œue
, 
s
, 
msg
, 
»c_rou‹
, 
scode
, 
»asÚ
,

161 
fmt
, 
­
);

162 
	`va_’d
(
­
);

164  
”r
;

165 
	}
}

179 
	$s_Œ•ly
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

180 cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

182  
	`s_Œ•lyf
(
¡p
, 
NULL
, 
s
, 
msg
, 
çl£
, 
scode
, 
»asÚ
, NULL);

183 
	}
}

197 
	$s_»¶yf
(
s
 *s, cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

198 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, ...)

200 
va_li¡
 
­
;

201 
”r
;

203 
	`va_¡¬t
(
­
, 
fmt
);

204 
”r
 = 
	`v»¶yf
(
NULL
, NULL, 
çl£
, 
s
, 
msg
, f®£, 
scode
, 
»asÚ
,

205 
fmt
, 
­
);

206 
	`va_’d
(
­
);

208  
”r
;

209 
	}
}

222 
	$s_»¶y
(
s
 *s, cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

223 cÚ¡ *
»asÚ
)

225  
	`s_»¶yf
(
s
, 
msg
, 
scode
, 
»asÚ
, 
NULL
);

226 
	}
}

236 
	$s_»¶y_addr
(
§
 *
addr
, cÚ¡ 
s_msg
 *
msg
, 
boŞ
 
½Üt
)

238 
ušt16_t
 
pÜt
;

239 
¶
…l;

241 ià(!
addr
 || !
msg
)

244 
pÜt
 = 
	`§_pÜt
(&
msg
->
vŸ
.
addr
);

245 *
addr
 = 
msg
->
¤c
;

247 
msg
->

) {

249 
SIP_TRANSP_UDP
:

250 ià(!
	`msg_·¿m_decode
(&
msg
->
vŸ
.
·¿ms
, "maddr", &
¶
)) {

251 ()
	`§_£t
(
addr
, &
¶
,
	`s_Œª¥_pÜt
(
msg
->

, 
pÜt
));

255 ià(
½Üt
)

260 
SIP_TRANSP_TCP
:

261 
SIP_TRANSP_TLS
:

262 
	`§_£t_pÜt
(
addr
, 
	`s_Œª¥_pÜt
(
msg
->

, 
pÜt
));

268 
	}
}

	@re-0.5.6/src/sip/request.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_fmt.h
>

12 
	~<»_dns.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_udp.h
>

16 
	~<»_msg.h
>

17 
	~<»_s.h
>

18 
	~"s.h
"

21 
	ss_»que¡
 {

22 
Ë
 
	mË
;

23 
li¡
 
	mÿch–
;

24 
li¡
 
	madd¾
;

25 
li¡
 
	m¤vl
;

26 
s_»que¡
 **
	m»qp
;

27 
s_ù¿ns
 *
	mù
;

28 
dns_qu”y
 *
	mdnsq
;

29 
dns_qu”y
 *
	mdnsq2
;

30 
s
 *
	ms
;

31 *
	mm‘
;

32 *
	muri
;

33 *
	mho¡
;

34 
mbuf
 *
	mmb
;

35 
s_£nd_h
 *
	m£ndh
;

36 
s_»¥_h
 *
	m»¥h
;

37 *
	m¬g
;

38 
size_t
 
	msÜtkey
;

39 
s_Œª¥
 
	m
;

40 
boŞ
 
	m_£Ëùed
;

41 
boŞ
 
	m¡©eful
;

42 
boŞ
 
	mÿnûËd
;

43 
boŞ
 
	m´ov»cv
;

44 
ušt16_t
 
	mpÜt
;

48 
»que¡_Ãxt
(
s_»que¡
 *
»q
);

49 
boŞ
 
¼_­³nd_hªdËr
(
dn¤r
 *
¼
, *
¬g
);

50 
¤v_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

51 
li¡
 *
authl
, li¡ *
addl
, *
¬g
);

52 
¤v_lookup
(
s_»que¡
 *
»q
, cÚ¡ *
domaš
);

53 
addr_lookup
(
s_»que¡
 *
»q
, cÚ¡ *
Çme
);

56 
	$¡r_ldup
(**
d¡
, cÚ¡ *
¤c
, 
Ën
)

58 
¶
…l;

60 
¶
.
p
 = 
¤c
;

61 
¶
.
l
 = 
Ën
 < 0 ? 
	`¡r_Ën
(
¤c
è: (
size_t
)len;

63  
	`¶_¡rdup
(
d¡
, &
¶
);

64 
	}
}

67 
	$de¡ruùÜ
(*
¬g
)

69 
s_»que¡
 *
»q
 = 
¬g
;

71 ià(
»q
->
»qp
 &&„eq->
¡©eful
) {

73 *
»q
->
»qp
 = 
NULL
;

74 
»q
->
»qp
 = 
NULL
;

75 
»q
->
£ndh
 = 
NULL
;

76 
»q
->
»¥h
 = 
NULL
;

77 
	`s_»que¡_ÿnûl
(
	`mem_»f
(
»q
));

81 
	`li¡_æush
(&
»q
->
ÿch–
);

82 
	`li¡_æush
(&
»q
->
add¾
);

83 
	`li¡_æush
(&
»q
->
¤vl
);

84 
	`li¡_uÆšk
(&
»q
->
Ë
);

85 
	`mem_d”ef
(
»q
->
dnsq
);

86 
	`mem_d”ef
(
»q
->
dnsq2
);

87 
	`mem_d”ef
(
»q
->
ù
);

88 
	`mem_d”ef
(
»q
->
m‘
);

89 
	`mem_d”ef
(
»q
->
uri
);

90 
	`mem_d”ef
(
»q
->
ho¡
);

91 
	`mem_d”ef
(
»q
->
mb
);

92 
	}
}

95 
	$‹rmš©e
(
s_»que¡
 *
»q
, 
”r
,

96 cÚ¡ 
s_msg
 *
msg
)

98 ià(
»q
->
»qp
) {

99 *
»q
->
»qp
 = 
NULL
;

100 
»q
->
»qp
 = 
NULL
;

103 
	`li¡_uÆšk
(&
»q
->
Ë
);

104 
»q
->
£ndh
 = 
NULL
;

106 ià(
»q
->
»¥h
) {

107 
»q
->
	`»¥h
(
”r
, 
msg
,„eq->
¬g
);

108 
»q
->
»¥h
 = 
NULL
;

110 
	}
}

113 
boŞ
 
	$şo£_hªdËr
(
Ë
 *Ë, *
¬g
)

115 
s_»que¡
 *
»q
 = 
Ë
->
d©a
;

116 ()
¬g
;

118 
»q
->
dnsq
 = 
	`mem_d”ef
(req->dnsq);

119 
»q
->
dnsq2
 = 
	`mem_d”ef
(req->dnsq2);

120 
»q
->
ù
 = 
	`mem_d”ef
(req->ct);

122 
	`‹rmš©e
(
»q
, 
ECONNABORTED
, 
NULL
);

123 
	`mem_d”ef
(
»q
);

125  
çl£
;

126 
	}
}

129 
	$»¥Ú£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

131 
s_»que¡
 *
»q
 = 
¬g
;

133 ià(
msg
 && msg->
scode
 < 200) {

134 ià(!
»q
->
´ov»cv
) {

135 
»q
->
´ov»cv
 = 
Œue
;

136 ià(
»q
->
ÿnûËd
)

137 ()
	`s_ù¿ns_ÿnûl
(
»q
->
ù
);

140 ià(
»q
->
»¥h
)

141 
»q
->
	`»¥h
(
”r
, 
msg
,„eq->
¬g
);

146 
»q
->
ù
 = 
NULL
;

148 ià(!
»q
->
ÿnûËd
 && (
”r
 || 
msg
->
scode
 == 503) &&

149 (
»q
->
add¾
.
h—d
 ||„eq->
¤vl
.head)) {

151 
”r
 = 
	`»que¡_Ãxt
(
»q
);

152 ià(!
”r
)

156 
	`‹rmš©e
(
»q
, 
”r
, 
msg
);

157 
	`mem_d”ef
(
»q
);

158 
	}
}

161 
	$»que¡
(
s_»que¡
 *
»q
, 
s_Œª¥
 

,

162 cÚ¡ 
§
 *
d¡
)

164 
mbuf
 *
mb
 = 
NULL
;

165 *
b¿nch
 = 
NULL
;

166 
”r
 = 
ENOMEM
;

167 
§
 
Ïddr
;

169 
»q
->
´ov»cv
 = 
çl£
;

171 
b¿nch
 = 
	`mem_®loc
(24, 
NULL
);

172 
mb
 = 
	`mbuf_®loc
(1024);

174 ià(!
b¿nch
 || !
mb
)

175 
out
;

177 ()
	`»_¢´štf
(
b¿nch
, 24, "z9hG4bK%016Îx", 
	`¿nd_u64
());

179 
”r
 = 
	`s_Œª¥_Ïddr
(
»q
->
s
, &
Ïddr
, 

, 
d¡
);

180 ià(
”r
)

181 
out
;

183 
”r
 = 
	`mbuf_´štf
(
mb
, "% % SIP/2.0\r\n", 
»q
->
m‘
,„eq->
uri
);

184 
”r
 |ğ
	`mbuf_´štf
(
mb
, "Via: SIP/2.0/%s %J;branch=%s;rport\r\n",

185 
	`s_Œª¥_Çme
(

), &
Ïddr
, 
b¿nch
);

186 
”r
 |ğ
»q
->
£ndh
 ?„eq->
	`£ndh
(

, &
Ïddr
, 
d¡
, 
mb
,„eq->
¬g
) : 0;

187 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
	`mbuf_buf
(
»q
->mb), 
	`mbuf_g‘_Ëá
(req->mb));

188 ià(
”r
)

189 
out
;

191 
mb
->
pos
 = 0;

193 ià(!
»q
->
¡©eful
)

194 
”r
 = 
	`s_£nd
(
»q
->
s
, 
NULL
, 

, 
d¡
, 
mb
);

196 
”r
 = 
	`s_ù¿ns_»que¡
(&
»q
->
ù
,„eq->
s
, 

, 
d¡
,„eq->
m‘
,

197 
b¿nch
, 
mb
, 
»¥Ú£_hªdËr
, 
»q
);

198 ià(
”r
)

199 
out
;

201 
out
:

202 
	`mem_d”ef
(
b¿nch
);

203 
	`mem_d”ef
(
mb
);

205  
”r
;

206 
	}
}

209 
	$»que¡_Ãxt
(
s_»que¡
 *
»q
)

211 
dn¤r
 *
¼
;

212 
§
 
d¡
;

213 
”r
;

215 
agaš
:

216 
¼
 = 
	`li¡_Ëd©a
(
»q
->
add¾
.
h—d
);

217 ià(!
¼
) {

218 
¼
 = 
	`li¡_Ëd©a
(
»q
->
¤vl
.
h—d
);

219 ià(!
¼
)

220  
ENOENT
;

222 
»q
->
pÜt
 = 
¼
->
rd©a
.
¤v
.port;

224 
	`dns_¼li¡_­¶y2
(&
»q
->
ÿch–
, 
¼
->
rd©a
.
¤v
.
rg‘
,

225 
DNS_TYPE_A
, 
DNS_TYPE_AAAA
, 
DNS_CLASS_IN
,

226 
Œue
, 
¼_­³nd_hªdËr
, &
»q
->
add¾
);

228 
	`li¡_uÆšk
(&
¼
->
Ë
);

230 ià(
»q
->
add¾
.
h—d
) {

231 
	`dns_¼li¡_sÜt_addr
(&
»q
->
add¾
,„eq->
sÜtkey
);

232 
	`mem_d”ef
(
¼
);

233 
agaš
;

236 
”r
 = 
	`addr_lookup
(
»q
, 
¼
->
rd©a
.
¤v
.
rg‘
);

237 
	`mem_d”ef
(
¼
);

239  
”r
;

242 
¼
->
ty³
) {

244 
DNS_TYPE_A
:

245 
	`§_£t_š
(&
d¡
, 
¼
->
rd©a
.
a
.
addr
, 
»q
->
pÜt
);

248 
DNS_TYPE_AAAA
:

249 
	`§_£t_š6
(&
d¡
, 
¼
->
rd©a
.
¯¯
.
addr
, 
»q
->
pÜt
);

253  
EINVAL
;

256 
	`li¡_uÆšk
(&
¼
->
Ë
);

257 
	`mem_d”ef
(
¼
);

259 
”r
 = 
	`»que¡
(
»q
,„eq->

, &
d¡
);

260 ià(
”r
) {

261 ià(
»q
->
add¾
.
h—d
 ||„eq->
¤vl
.head)

262 
agaš
;

264 ià(!
»q
->
¡©eful
) {

265 
»q
->
»¥h
 = 
NULL
;

266 
	`‹rmš©e
(
»q
, 0, 
NULL
);

267 
	`mem_d”ef
(
»q
);

270  
”r
;

271 
	}
}

274 
boŞ
 
	$Œª¥_Ãxt
(
s
 *s, 
s_Œª¥
 *

)

276 
s_Œª¥
 
i
;

278 
i
=(
s_Œª¥
)(*

+1); i<
SIP_TRANSPC
; i++) {

280 ià(!
	`s_Œª¥_suµÜ‹d
(
s
, 
i
, 
AF_UNSPEC
))

283 *

 = 
i
;

284  
Œue
;

287  
çl£
;

288 
	}
}

291 
boŞ
 
	$Œª¥_Ãxt_¤v
(
s
 *s, 
s_Œª¥
 *

)

293 
s_Œª¥
 
i
;

295 
i
=(
s_Œª¥
)(*

-1); i>
SIP_TRANSP_NONE
; i--) {

297 ià(!
	`s_Œª¥_suµÜ‹d
(
s
, 
i
, 
AF_UNSPEC
))

300 *

 = 
i
;

301  
Œue
;

304  
çl£
;

305 
	}
}

308 
boŞ
 
	$¼_­³nd_hªdËr
(
dn¤r
 *
¼
, *
¬g
)

310 
li¡
 *
l¡
 = 
¬g
;

312 
¼
->
ty³
) {

314 
DNS_TYPE_A
:

315 
DNS_TYPE_AAAA
:

316 
DNS_TYPE_SRV
:

317 ià(
¼
->
Ë
.
li¡
)

320 
	`li¡_­³nd
(
l¡
, &
¼
->
Ë
, 
	`mem_»f
(rr));

324  
çl£
;

325 
	}
}

328 
boŞ
 
	$¼_ÿche_hªdËr
(
dn¤r
 *
¼
, *
¬g
)

330 
s_»que¡
 *
»q
 = 
¬g
;

332 
¼
->
ty³
) {

334 
DNS_TYPE_A
:

335 ià(!
	`s_Œª¥_suµÜ‹d
(
»q
->
s
,„eq->

, 
AF_INET
))

338 
	`li¡_uÆšk
(&
¼
->
Ë_´iv
);

339 
	`li¡_­³nd
(&
»q
->
ÿch–
, &
¼
->
Ë_´iv
,„r);

342 #ifdeà
HAVE_INET6


343 
DNS_TYPE_AAAA
:

344 ià(!
	`s_Œª¥_suµÜ‹d
(
»q
->
s
,„eq->

, 
AF_INET6
))

347 
	`li¡_uÆšk
(&
¼
->
Ë_´iv
);

348 
	`li¡_­³nd
(&
»q
->
ÿch–
, &
¼
->
Ë_´iv
,„r);

352 
DNS_TYPE_CNAME
:

353 
	`li¡_uÆšk
(&
¼
->
Ë_´iv
);

354 
	`li¡_­³nd
(&
»q
->
ÿch–
, &
¼
->
Ë_´iv
,„r);

358  
çl£
;

359 
	}
}

362 
boŞ
 
	$¼_Ç±r_hªdËr
(
dn¤r
 *
¼
, *
¬g
)

364 
s_»que¡
 *
»q
 = 
¬g
;

365 
s_Œª¥
 

;

367 ià(
¼
->
ty³
 !ğ
DNS_TYPE_NAPTR
)

368  
çl£
;

370 ià(!
	`¡r_ÿ£cmp
(
¼
->
rd©a
.
Ç±r
.
£rviûs
, "SIP+D2U"))

371 

 = 
SIP_TRANSP_UDP
;

372 ià(!
	`¡r_ÿ£cmp
(
¼
->
rd©a
.
Ç±r
.
£rviûs
, "SIP+D2T"))

373 

 = 
SIP_TRANSP_TCP
;

374 ià(!
	`¡r_ÿ£cmp
(
¼
->
rd©a
.
Ç±r
.
£rviûs
, "SIPS+D2T"))

375 

 = 
SIP_TRANSP_TLS
;

377  
çl£
;

379 ià(!
	`s_Œª¥_suµÜ‹d
(
»q
->
s
, 

, 
AF_UNSPEC
))

380  
çl£
;

382 
»q
->

 =p;

383 
»q
->
_£Ëùed
 = 
Œue
;

385  
Œue
;

386 
	}
}

389 
	$Ç±r_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

390 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

392 
s_»que¡
 *
»q
 = 
¬g
;

393 
dn¤r
 *
¼
;

394 ()
hdr
;

395 ()
authl
;

397 
	`dns_¼li¡_sÜt
(
ª¦
, 
DNS_TYPE_NAPTR
, 
»q
->
sÜtkey
);

399 
¼
 = 
	`dns_¼li¡_­¶y
(
ª¦
, 
NULL
, 
DNS_TYPE_NAPTR
, 
DNS_CLASS_IN
, 
çl£
,

400 
¼_Ç±r_hªdËr
, 
»q
);

401 ià(!
¼
) {

402 
»q
->

 = 
SIP_TRANSPC
;

403 ià(!
	`Œª¥_Ãxt_¤v
(
»q
->
s
, &»q->

)) {

404 
”r
 = 
EPROTONOSUPPORT
;

405 
ç
;

408 
”r
 = 
	`¤v_lookup
(
»q
,„eq->
ho¡
);

409 ià(
”r
)

410 
ç
;

415 
	`dns_¼li¡_­¶y
(
addl
, 
¼
->
rd©a
.
Ç±r
.
»¶aû
, 
DNS_TYPE_SRV
,

416 
DNS_CLASS_IN
, 
Œue
, 
¼_­³nd_hªdËr
, &
»q
->
¤vl
);

418 ià(!
»q
->
¤vl
.
h—d
) {

419 
”r
 = 
	`dnsc_qu”y
(&
»q
->
dnsq
,„eq->
s
->
dnsc
,

420 
¼
->
rd©a
.
Ç±r
.
»¶aû
, 
DNS_TYPE_SRV
,

421 
DNS_CLASS_IN
, 
Œue
, 
¤v_hªdËr
, 
»q
);

422 ià(
”r
)

423 
ç
;

428 
	`dns_¼li¡_sÜt
(&
»q
->
¤vl
, 
DNS_TYPE_SRV
,„eq->
sÜtkey
);

430 
	`dns_¼li¡_­¶y
(
addl
, 
NULL
, 
DNS_QTYPE_ANY
, 
DNS_CLASS_IN
, 
çl£
,

431 
¼_ÿche_hªdËr
, 
»q
);

433 
”r
 = 
	`»que¡_Ãxt
(
»q
);

434 ià(
”r
)

435 
ç
;

439 
ç
:

440 
	`‹rmš©e
(
»q
, 
”r
, 
NULL
);

441 
	`mem_d”ef
(
»q
);

442 
	}
}

445 
	$¤v_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

446 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

448 
s_»que¡
 *
»q
 = 
¬g
;

449 ()
hdr
;

450 ()
authl
;

452 
	`dns_¼li¡_­¶y
(
ª¦
, 
NULL
, 
DNS_TYPE_SRV
, 
DNS_CLASS_IN
, 
çl£
,

453 
¼_­³nd_hªdËr
, &
»q
->
¤vl
);

455 ià(!
»q
->
¤vl
.
h—d
) {

456 ià(!
»q
->
_£Ëùed
) {

457 ià(
	`Œª¥_Ãxt_¤v
(
»q
->
s
, &»q->

)) {

459 
”r
 = 
	`¤v_lookup
(
»q
,„eq->
ho¡
);

460 ià(
”r
)

461 
ç
;

466 
»q
->

 = 
SIP_TRANSP_NONE
;

467 ià(!
	`Œª¥_Ãxt
(
»q
->
s
, &»q->

)) {

468 
”r
 = 
EPROTONOSUPPORT
;

469 
ç
;

473 
»q
->
pÜt
 = 
	`s_Œª¥_pÜt
Ôeq->

, 0);

475 
”r
 = 
	`addr_lookup
(
»q
,„eq->
ho¡
);

476 ià(
”r
)

477 
ç
;

482 
	`dns_¼li¡_sÜt
(&
»q
->
¤vl
, 
DNS_TYPE_SRV
,„eq->
sÜtkey
);

484 
	`dns_¼li¡_­¶y
(
addl
, 
NULL
, 
DNS_QTYPE_ANY
, 
DNS_CLASS_IN
, 
çl£
,

485 
¼_ÿche_hªdËr
, 
»q
);

487 
”r
 = 
	`»que¡_Ãxt
(
»q
);

488 ià(
”r
)

489 
ç
;

493 
ç
:

494 
	`‹rmš©e
(
»q
, 
”r
, 
NULL
);

495 
	`mem_d”ef
(
»q
);

496 
	}
}

499 
	$addr_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

500 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

502 
s_»que¡
 *
»q
 = 
¬g
;

503 ()
hdr
;

504 ()
authl
;

505 ()
addl
;

507 
	`dns_¼li¡_­¶y2
(
ª¦
, 
NULL
, 
DNS_TYPE_A
, 
DNS_TYPE_AAAA
, 
DNS_CLASS_IN
,

508 
çl£
, 
¼_­³nd_hªdËr
, &
»q
->
add¾
);

511 ià(
»q
->
dnsq
 ||„eq->
dnsq2
)

514 ià(!
»q
->
add¾
.
h—d
 && !»q->
¤vl
.head) {

515 
”r
 =ƒ¼ ?ƒ¼ : 
EDESTADDRREQ
;

516 
ç
;

519 
	`dns_¼li¡_sÜt_addr
(&
»q
->
add¾
,„eq->
sÜtkey
);

521 
”r
 = 
	`»que¡_Ãxt
(
»q
);

522 ià(
”r
)

523 
ç
;

527 
ç
:

528 
	`‹rmš©e
(
»q
, 
”r
, 
NULL
);

529 
	`mem_d”ef
(
»q
);

530 
	}
}

533 
	$¤v_lookup
(
s_»que¡
 *
»q
, cÚ¡ *
domaš
)

535 
Çme
[256];

537 ià(
	`»_¢´štf
(
Çme
, (name), "%s.%s",

538 
	`s_Œª¥_¤vid
(
»q
->

), 
domaš
) < 0)

539  
ENOMEM
;

541  
	`dnsc_qu”y
(&
»q
->
dnsq
,„eq->
s
->
dnsc
, 
Çme
, 
DNS_TYPE_SRV
,

542 
DNS_CLASS_IN
, 
Œue
, 
¤v_hªdËr
, 
»q
);

543 
	}
}

546 
	$addr_lookup
(
s_»que¡
 *
»q
, cÚ¡ *
Çme
)

548 
”r
;

550 ià(
	`s_Œª¥_suµÜ‹d
(
»q
->
s
,„eq->

, 
AF_INET
)) {

552 
”r
 = 
	`dnsc_qu”y
(&
»q
->
dnsq
,„eq->
s
->
dnsc
, 
Çme
,

553 
DNS_TYPE_A
, 
DNS_CLASS_IN
, 
Œue
,

554 
addr_hªdËr
, 
»q
);

555 ià(
”r
)

556  
”r
;

559 #ifdeà
HAVE_INET6


560 ià(
	`s_Œª¥_suµÜ‹d
(
»q
->
s
,„eq->

, 
AF_INET6
)) {

562 
”r
 = 
	`dnsc_qu”y
(&
»q
->
dnsq2
,„eq->
s
->
dnsc
, 
Çme
,

563 
DNS_TYPE_AAAA
, 
DNS_CLASS_IN
, 
Œue
,

564 
addr_hªdËr
, 
»q
);

565 ià(
”r
)

566  
”r
;

570 ià(!
»q
->
dnsq
 && !»q->
dnsq2
)

571  
EPROTONOSUPPORT
;

574 
	}
}

596 
	$s_»que¡
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

597 cÚ¡ *
m‘
, 
m‘l
, cÚ¡ *
uri
, 
ur
,

598 cÚ¡ 
uri
 *
rou‹
, 
mbuf
 *
mb
, 
size_t
 
sÜtkey
,

599 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
, *
¬g
)

601 
s_»que¡
 *
»q
;

602 
§
 
d¡
;

603 
¶
…l;

604 
”r
;

606 ià(!
s
 || !
m‘
 || !
uri
 || !
rou‹
 || !
mb
)

607  
EINVAL
;

609 ià(
	`¶_¡rÿ£cmp
(&
rou‹
->
scheme
, "sip"))

610  
ENOSYS
;

612 
»q
 = 
	`mem_z®loc
((*»q), 
de¡ruùÜ
);

613 ià(!
»q
)

614  
ENOMEM
;

616 
	`li¡_­³nd
(&
s
->
»ql
, &
»q
->
Ë
,„eq);

618 
”r
 = 
	`¡r_ldup
(&
»q
->
m‘
, m‘, 
m‘l
);

619 ià(
”r
)

620 
out
;

622 
”r
 = 
	`¡r_ldup
(&
»q
->
uri
, uri, 
ur
);

623 ià(
”r
)

624 
out
;

626 ià(
	`msg_·¿m_decode
(&
rou‹
->
·¿ms
, "maddr", &
¶
))

627 
¶
 = 
rou‹
->
ho¡
;

629 
”r
 = 
	`¶_¡rdup
(&
»q
->
ho¡
, &
¶
);

630 ià(
”r
)

631 
out
;

633 
»q
->
¡©eful
 = stateful;

634 
»q
->
sÜtkey
 = sortkey;

635 
»q
->
mb
 = 
	`mem_»f
(mb);

636 
»q
->
s
 = sip;

637 
»q
->
£ndh
 = sendh;

638 
»q
->
»¥h
 =„esph;

639 
»q
->
¬g
 =‡rg;

641 ià(!
	`msg_·¿m_decode
(&
rou‹
->
·¿ms
, "Œª¥Üt", &
¶
)) {

643 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "udp"))

644 
»q
->

 = 
SIP_TRANSP_UDP
;

645 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "tcp"))

646 
»q
->

 = 
SIP_TRANSP_TCP
;

647 ià(!
	`¶_¡rÿ£cmp
(&
¶
, "tls"))

648 
»q
->

 = 
SIP_TRANSP_TLS
;

650 
”r
 = 
EPROTONOSUPPORT
;

651 
out
;

654 ià(!
	`s_Œª¥_suµÜ‹d
(
s
, 
»q
->

, 
AF_UNSPEC
)) {

655 
”r
 = 
EPROTONOSUPPORT
;

656 
out
;

659 
»q
->
_£Ëùed
 = 
Œue
;

662 
»q
->

 = 
SIP_TRANSP_NONE
;

663 ià(!
	`Œª¥_Ãxt
(
s
, &
»q
->

)) {

664 
”r
 = 
EPROTONOSUPPORT
;

665 
out
;

668 
»q
->
_£Ëùed
 = 
çl£
;

671 ià(!
	`§_£t_¡r
(&
d¡
, 
»q
->
ho¡
,

672 
	`s_Œª¥_pÜt
(
»q
->

, 
rou‹
->
pÜt
))) {

674 
”r
 = 
	`»que¡
(
»q
,„eq->

, &
d¡
);

675 ià(!
»q
->
¡©eful
) {

676 
	`mem_d”ef
(
»q
);

677  
”r
;

680 ià(
rou‹
->
pÜt
) {

682 
»q
->
pÜt
 = 
	`s_Œª¥_pÜt
Ôeq->

, 
rou‹
->port);

683 
”r
 = 
	`addr_lookup
(
»q
,„eq->
ho¡
);

685 ià(
»q
->
_£Ëùed
) {

687 
”r
 = 
	`¤v_lookup
(
»q
,„eq->
ho¡
);

690 
”r
 = 
	`dnsc_qu”y
(&
»q
->
dnsq
, 
s
->
dnsc
,„eq->
ho¡
,

691 
DNS_TYPE_NAPTR
, 
DNS_CLASS_IN
, 
Œue
,

692 
Ç±r_hªdËr
, 
»q
);

695 
out
:

696 ià(
”r
)

697 
	`mem_d”ef
(
»q
);

698 ià(
»qp
) {

699 
»q
->
»qp
 =„eqp;

700 *
»qp
 = 
»q
;

703  
”r
;

704 
	}
}

724 
	$s_»que¡f
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

725 cÚ¡ *
m‘
, cÚ¡ *
uri
, cÚ¡ ur˜*
rou‹
,

726 
s_auth
 *
auth
, 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
,

727 *
¬g
, cÚ¡ *
fmt
, ...)

729 
uri
 
Ìou‹
;

730 
mbuf
 *
mb
;

731 
va_li¡
 
­
;

732 
”r
;

734 ià(!
s
 || !
m‘
 || !
uri
 || !
fmt
)

735  
EINVAL
;

737 ià(!
rou‹
) {

738 
¶
 
url
;

740 
	`¶_£t_¡r
(&
url
, 
uri
);

742 
”r
 = 
	`uri_decode
(&
Ìou‹
, &
url
);

743 ià(
”r
)

744  
”r
;

746 
rou‹
 = &
Ìou‹
;

749 
mb
 = 
	`mbuf_®loc
(2048);

750 ià(!
mb
)

751  
ENOMEM
;

753 
”r
 = 
	`mbuf_wr™e_¡r
(
mb
, "Max-Forwards: 70\r\n");

755 ià(
auth
)

756 
”r
 |ğ
	`s_auth_’code
(
mb
, 
auth
, 
m‘
, 
uri
);

758 ià(
”r
)

759 
out
;

761 
	`va_¡¬t
(
­
, 
fmt
);

762 
”r
 = 
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

763 
	`va_’d
(
­
);

765 ià(
”r
)

766 
out
;

768 
mb
->
pos
 = 0;

770 
”r
 = 
	`s_»que¡
(
»qp
, 
s
, 
¡©eful
, 
m‘
, -1, 
uri
, -1, 
rou‹
, 
mb
,

771 (
size_t
)
¬g
, 
£ndh
, 
»¥h
,‡rg);

772 ià(
”r
)

773 
out
;

775 
out
:

776 
	`mem_d”ef
(
mb
);

778  
”r
;

779 
	}
}

799 
	$s_d»que¡f
(
s_»que¡
 **
»qp
, 
s
 *s, 
boŞ
 
¡©eful
,

800 cÚ¡ *
m‘
, 
s_dŸlog
 *
dlg
, 
ušt32_t
 
c£q
,

801 
s_auth
 *
auth
, 
s_£nd_h
 *
£ndh
, 
s_»¥_h
 *
»¥h
,

802 *
¬g
, cÚ¡ *
fmt
, ...)

804 
mbuf
 *
mb
;

805 
va_li¡
 
­
;

806 
”r
;

808 ià(!
s
 || !
m‘
 || !
dlg
 || !
fmt
)

809  
EINVAL
;

811 
mb
 = 
	`mbuf_®loc
(2048);

812 ià(!
mb
)

813  
ENOMEM
;

815 
”r
 = 
	`mbuf_wr™e_¡r
(
mb
, "Max-Forwards: 70\r\n");

817 ià(
auth
)

818 
”r
 |ğ
	`s_auth_’code
(
mb
, 
auth
, 
m‘
, 
	`s_dŸlog_uri
(
dlg
));

820 
”r
 |ğ
	`s_dŸlog_’code
(
mb
, 
dlg
, 
c£q
, 
m‘
);

822 ià(
s
->
soáw¬e
)

823 
”r
 |ğ
	`mbuf_´štf
(
mb
, "U£r-Ag’t: %s\r\n", 
s
->
soáw¬e
);

825 ià(
”r
)

826 
out
;

828 
	`va_¡¬t
(
­
, 
fmt
);

829 
”r
 = 
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

830 
	`va_’d
(
­
);

832 ià(
”r
)

833 
out
;

835 
mb
->
pos
 = 0;

837 
”r
 = 
	`s_»que¡
(
»qp
, 
s
, 
¡©eful
, 
m‘
, -1, 
	`s_dŸlog_uri
(
dlg
),

838 -1, 
	`s_dŸlog_rou‹
(
dlg
), 
mb
, 
	`s_dŸlog_hash
(dlg),

839 
£ndh
, 
»¥h
, 
¬g
);

840 ià(
”r
)

841 
out
;

843 
out
:

844 
	`mem_d”ef
(
mb
);

846  
”r
;

847 
	}
}

855 
	$s_»que¡_ÿnûl
(
s_»que¡
 *
»q
)

857 ià(!
»q
 ||„eq->
ÿnûËd
)

860 
»q
->
ÿnûËd
 = 
Œue
;

862 ià(!
»q
->
´ov»cv
)

865 ()
	`s_ù¿ns_ÿnûl
(
»q
->
ù
);

866 
	}
}

869 
	$s_»que¡_şo£
(
s
 *sip)

871 ià(!
s
)

874 
	`li¡_­¶y
(&
s
->
»ql
, 
Œue
, 
şo£_hªdËr
, 
NULL
);

875 
	}
}

886 
boŞ
 
	$s_»que¡_loİs
(
s_loİ¡©e
 *
ls
, 
ušt16_t
 
scode
)

888 
boŞ
 
loİ
 = 
çl£
;

890 ià(!
ls
)

891  
çl£
;

893 ià(
scode
 < 200) {

894  
çl£
;

896 ià(
scode
 < 300) {

897 
ls
->
çc
 = 0;

899 ià(
scode
 < 400) {

900 
loİ
 = (++
ls
->
çc
 >= 16);

903 
scode
) {

906 ià(
ls
->
Ï¡_scode
 =ğ
scode
)

907 
loİ
 = 
Œue
;

912 ià(++
ls
->
çc
 >= 16)

913 
loİ
 = 
Œue
;

918 
ls
->
Ï¡_scode
 = 
scode
;

920  
loİ
;

921 
	}
}

929 
	$s_loİ¡©e_»£t
(
s_loİ¡©e
 *
ls
)

931 ià(!
ls
)

934 
ls
->
Ï¡_scode
 = 0;

935 
ls
->
çc
 = 0;

936 
	}
}

	@re-0.5.6/src/sip/sip.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_tmr.h
>

16 
	~<»_udp.h
>

17 
	~<»_¡un.h
>

18 
	~<»_msg.h
>

19 
	~<»_s.h
>

20 
	~"s.h
"

23 
	$de¡ruùÜ
(*
¬g
)

25 
s
 *s = 
¬g
;

27 ià(
s
->
şosšg
) {

28 
s
->
şosšg
 = 
çl£
;

29 
	`mem_»f
(
s
);

30 ià(
s
->
ex™h
)

31 
s
->
	`ex™h
(s->
¬g
);

35 
	`s_»que¡_şo£
(
s
);

36 
	`s_»que¡_şo£
(
s
);

38 
	`hash_æush
(
s
->
ht_ù¿ns
);

39 
	`mem_d”ef
(
s
->
ht_ù¿ns
);

41 
	`hash_æush
(
s
->
ht_¡¿ns
);

42 
	`hash_ş—r
(
s
->
ht_¡¿ns_mrg
);

43 
	`mem_d”ef
(
s
->
ht_¡¿ns
);

44 
	`mem_d”ef
(
s
->
ht_¡¿ns_mrg
);

46 
	`hash_æush
(
s
->
ht_cÚn
);

47 
	`mem_d”ef
(
s
->
ht_cÚn
);

49 
	`hash_æush
(
s
->
ht_udpcÚn
);

50 
	`mem_d”ef
(
s
->
ht_udpcÚn
);

52 
	`li¡_æush
(&
s
->
Œª¥l
);

53 
	`li¡_æush
(&
s
->
l¢¾
);

55 
	`mem_d”ef
(
s
->
soáw¬e
);

56 
	`mem_d”ef
(
s
->
dnsc
);

57 
	`mem_d”ef
(
s
->
¡un
);

58 
	}
}

61 
	$l¢r_de¡ruùÜ
(*
¬g
)

63 
s_l¢r
 *
l¢r
 = 
¬g
;

65 ià(
l¢r
->
l¢½
)

66 *
l¢r
->
l¢½
 = 
NULL
;

68 
	`li¡_uÆšk
(&
l¢r
->
Ë
);

69 
	}
}

86 
	$s_®loc
(
s
 **
sp
, 
dnsc
 *dnsc, 
ušt32_t
 
ùsz
,

87 
ušt32_t
 
¡sz
, ušt32_ˆ
tcsz
, cÚ¡ *
soáw¬e
,

88 
s_ex™_h
 *
ex™h
, *
¬g
)

90 
s
 *sip;

91 
”r
;

93 ià(!
sp
)

94  
EINVAL
;

96 
s
 = 
	`mem_z®loc
((*s), 
de¡ruùÜ
);

97 ià(!
s
)

98  
ENOMEM
;

100 
”r
 = 
	`s_Œª¥_š™
(
s
, 
tcsz
);

101 ià(
”r
)

102 
out
;

104 
”r
 = 
	`s_ù¿ns_š™
(
s
, 
ùsz
);

105 ià(
”r
)

106 
out
;

108 
”r
 = 
	`s_¡¿ns_š™
(
s
, 
¡sz
);

109 ià(
”r
)

110 
out
;

112 
”r
 = 
	`hash_®loc
(&
s
->
ht_udpcÚn
, 
tcsz
);

113 ià(
”r
)

114 
out
;

116 
”r
 = 
	`¡un_®loc
(&
s
->
¡un
, 
NULL
, NULL, NULL);

117 ià(
”r
)

118 
out
;

120 ià(
soáw¬e
) {

121 
”r
 = 
	`¡r_dup
(&
s
->
soáw¬e
, software);

122 ià(
”r
)

123 
out
;

126 
s
->
dnsc
 = 
	`mem_»f
(dnsc);

127 
s
->
ex™h
 =ƒxith;

128 
s
->
¬g
 =‡rg;

130 
out
:

131 ià(
”r
)

132 
	`mem_d”ef
(
s
);

134 *
sp
 = 
s
;

136  
”r
;

137 
	}
}

146 
	$s_şo£
(
s
 *s, 
boŞ
 
fÜû
)

148 ià(!
s
)

151 ià(
fÜû
) {

152 
	`s_»que¡_şo£
(
s
);

153 
	`s_»que¡_şo£
(
s
);

155 ià(!
s
->
şosšg
) {

156 
s
->
şosšg
 = 
Œue
;

157 
	`mem_d”ef
(
s
);

159 
	}
}

173 
	$s_£nd
(
s
 *s, *
sock
, 
s_Œª¥
 

,

174 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

176  
	`s_Œª¥_£nd
(
NULL
, 
s
, 
sock
, 

, 
d¡
, 
mb
, NULL, NULL);

177 
	}
}

191 
	$s_li¡’
(
s_l¢r
 **
l¢½
, 
s
 *s, 
boŞ
 
»q
,

192 
s_msg_h
 *
msgh
, *
¬g
)

194 
s_l¢r
 *
l¢r
;

196 ià(!
s
 || !
msgh
)

197  
EINVAL
;

199 
l¢r
 = 
	`mem_z®loc
((*l¢r), 
l¢r_de¡ruùÜ
);

200 ià(!
l¢r
)

201  
ENOMEM
;

203 
	`li¡_­³nd
(&
s
->
l¢¾
, &
l¢r
->
Ë
,†snr);

205 
l¢r
->
msgh
 = msgh;

206 
l¢r
->
¬g
 =‡rg;

207 
l¢r
->
»q
 =„eq;

209 ià(
l¢½
) {

210 
l¢r
->
l¢½
 =†snrp;

211 *
l¢½
 = 
l¢r
;

215 
	}
}

226 
	$s_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip)

228 
”r
;

230 ià(!
s
)

233 
”r
 = 
	`s_Œª¥_debug
(
pf
, 
s
);

234 
”r
 |ğ
	`s_ù¿ns_debug
(
pf
, 
s
);

235 
”r
 |ğ
	`s_¡¿ns_debug
(
pf
, 
s
);

237  
”r
;

238 
	}
}

	@re-0.5.6/src/sip/sip.h

8 
	ss
 {

9 
li¡
 
	mŒª¥l
;

10 
li¡
 
	ml¢¾
;

11 
li¡
 
	m»ql
;

12 
hash
 *
	mht_ù¿ns
;

13 
hash
 *
	mht_¡¿ns
;

14 
hash
 *
	mht_¡¿ns_mrg
;

15 
hash
 *
	mht_cÚn
;

16 
hash
 *
	mht_udpcÚn
;

17 
dnsc
 *
	mdnsc
;

18 
¡un
 *
	m¡un
;

19 *
	msoáw¬e
;

20 
s_ex™_h
 *
	mex™h
;

21 *
	m¬g
;

22 
boŞ
 
	mşosšg
;

26 
	ss_l¢r
 {

27 
Ë
 
	mË
;

28 
s_l¢r
 **
	ml¢½
;

29 
s_msg_h
 *
	mmsgh
;

30 *
	m¬g
;

31 
boŞ
 
	m»q
;

35 
	ss_k“·live
 {

36 
Ë
 
	mË
;

37 
s_k“·live
 **
	mk­
;

38 
s_k“·live_h
 *
	mkah
;

39 *
	m¬g
;

44 
s_»que¡_şo£
(
s
 *sip);

48 
	gs_ù¿ns
;

50 
s_ù¿ns_»que¡
(
s_ù¿ns
 **
ùp
, 
s
 *sip,

51 
s_Œª¥
 

, cÚ¡ 
§
 *
d¡
, *
m‘
,

52 *
b¿nch
, 
mbuf
 *
mb
, 
s_»¥_h
 *
»¥h
,

53 *
¬g
);

54 
s_ù¿ns_ÿnûl
(
s_ù¿ns
 *
ù
);

55 
s_ù¿ns_š™
(
s
 *s, 
ušt32_t
 
sz
);

56 
s_ù¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip);

60 
s_¡¿ns_š™
(
s
 *s, 
ušt32_t
 
sz
);

61 
s_¡¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip);

65 
	gs_cÚnq’t
;

67 (
	ts_Œª¥_h
)(
	t”r
, *
	t¬g
);

69 
	`s_Œª¥_š™
(
s
 *s, 
ušt32_t
 
sz
);

70 
	`s_Œª¥_£nd
(
s_cÚnq’t
 **
q’
, 
s
 *s, *
sock
,

71 
s_Œª¥
 

, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
,

72 
s_Œª¥_h
 *
Œª¥h
, *
¬g
);

73 
boŞ
 
	`s_Œª¥_suµÜ‹d
(
s
 *s, 
s_Œª¥
 

, 
af
);

74 cÚ¡ *
	`s_Œª¥_¤vid
(
s_Œª¥
 

);

75 
boŞ
 
	`s_Œª¥_»lŸbË
(
s_Œª¥
 

);

76 
	`s_Œª¥_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip);

80 
	`s_auth_’code
(
mbuf
 *
mb
, 
s_auth
 *
auth
, cÚ¡ *
m‘
,

81 cÚ¡ *
uri
);

85 
	`s_dŸlog_’code
(
mbuf
 *
mb
, 
s_dŸlog
 *
dlg
, 
ušt32_t
 
c£q
,

86 cÚ¡ *
m‘
);

87 cÚ¡ *
	`s_dŸlog_uri
(cÚ¡ 
s_dŸlog
 *
dlg
);

88 cÚ¡ 
uri
 *
	`s_dŸlog_rou‹
(cÚ¡ 
s_dŸlog
 *
dlg
);

89 
ušt32_t
 
	`s_dŸlog_hash
(cÚ¡ 
s_dŸlog
 *
dlg
);

93 
s_cÚn
;

95 
	`s_k“·live_sigÇl
(
li¡
 *
k®
, 
”r
);

96 
ušt64_t
 
	`s_k“·live_wa™
(
ušt32_t
 
š‹rv®
);

97 
	`s_k“·live_tı
(
s_k“·live
 *
ka
, 
s_cÚn
 *
cÚn
,

98 
ušt32_t
 
š‹rv®
);

99 
	`s_k“·live_udp
(
s_k“·live
 *
ka
, 
s
 *sip,

100 
udp_sock
 *
us
, cÚ¡ 
§
 *
·ddr
,

101 
ušt32_t
 
š‹rv®
);

	@re-0.5.6/src/sip/strans.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_tmr.h
>

16 
	~<»_udp.h
>

17 
	~<»_msg.h
>

18 
	~<»_s.h
>

19 
	~"s.h
"

22 
	e¡©e
 {

23 
	mTRYING
,

24 
	mPROCEEDING
,

25 
	mACCEPTED
,

26 
	mCOMPLETED
,

27 
	mCONFIRMED
,

31 
	ss_¡¿ns
 {

32 
Ë
 
	mhe
;

33 
Ë
 
	mhe_mrg
;

34 
tmr
 
	mtmr
;

35 
tmr
 
	mtmrg
;

36 
§
 
	md¡
;

37 
s
 *
	ms
;

38 
s_msg
 *
	mmsg
;

39 
mbuf
 *
	mmb
;

40 
s_ÿnûl_h
 *
	mÿnûlh
;

41 *
	m¬g
;

42 
¡©e
 
	m¡©e
;

43 
ušt32_t
 
	mtxc
;

44 
boŞ
 
	mšv™e
;

48 
	$de¡ruùÜ
(*
¬g
)

50 
s_¡¿ns
 *
¡
 = 
¬g
;

52 
	`hash_uÆšk
(&
¡
->
he
);

53 
	`hash_uÆšk
(&
¡
->
he_mrg
);

54 
	`tmr_ÿnûl
(&
¡
->
tmr
);

55 
	`tmr_ÿnûl
(&
¡
->
tmrg
);

56 
	`mem_d”ef
(
¡
->
msg
);

57 
	`mem_d”ef
(
¡
->
mb
);

58 
	}
}

61 
boŞ
 
	$¡¿ns_cmp
(cÚ¡ 
s_msg
 *
msg1
, cÚ¡ s_msg *
msg2
)

63 ià(
	`¶_cmp
(&
msg1
->
vŸ
.
b¿nch
, &
msg2
->via.branch))

64  
çl£
;

66 ià(
	`¶_cmp
(&
msg1
->
vŸ
.
£Áby
, &
msg2
->via.sentby))

67  
çl£
;

69  
Œue
;

70 
	}
}

73 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

75 
s_¡¿ns
 *
¡
 = 
Ë
->
d©a
;

76 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

78 ià(!
	`¡¿ns_cmp
(
¡
->
msg
, msg))

79  
çl£
;

81 ià(
	`¶_cmp
(&
¡
->
msg
->
c£q
.
m‘
, &msg->cseq.met))

82  
çl£
;

84  
Œue
;

85 
	}
}

88 
boŞ
 
	$cmp_ack_hªdËr
(
Ë
 *Ë, *
¬g
)

90 
s_¡¿ns
 *
¡
 = 
Ë
->
d©a
;

91 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

93 ià(!
	`¡¿ns_cmp
(
¡
->
msg
, msg))

94  
çl£
;

96 ià(
	`¶_¡rcmp
(&
¡
->
msg
->
c£q
.
m‘
, "INVITE"))

97  
çl£
;

99  
Œue
;

100 
	}
}

103 
boŞ
 
	$cmp_ÿnûl_hªdËr
(
Ë
 *Ë, *
¬g
)

105 
s_¡¿ns
 *
¡
 = 
Ë
->
d©a
;

106 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

108 ià(!
	`¡¿ns_cmp
(
¡
->
msg
, msg))

109  
çl£
;

111 ià(!
	`¶_¡rcmp
(&
¡
->
msg
->
c£q
.
m‘
, "CANCEL"))

112  
çl£
;

114  
Œue
;

115 
	}
}

118 
boŞ
 
	$cmp_m”ge_hªdËr
(
Ë
 *Ë, *
¬g
)

120 
s_¡¿ns
 *
¡
 = 
Ë
->
d©a
;

121 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

123 ià(
	`¶_cmp
(&
¡
->
msg
->
c£q
.
m‘
, &msg->cseq.met))

124  
çl£
;

126 ià(
¡
->
msg
->
c£q
.
num
 != msg->cseq.num)

127  
çl£
;

129 ià(
	`¶_cmp
(&
¡
->
msg
->
ÿÎid
, &msg->callid))

130  
çl£
;

132 ià(
	`¶_cmp
(&
¡
->
msg
->
äom
.
g
, &msg->from.tag))

133  
çl£
;

135 ià(
	`¶_cmp
(&
¡
->
msg
->
ruri
, &msg->ruri))

136  
çl£
;

138  
Œue
;

139 
	}
}

142 
	$dummy_hªdËr
(*
¬g
)

144 ()
¬g
;

145 
	}
}

148 
	$tmr_hªdËr
(*
¬g
)

150 
s_¡¿ns
 *
¡
 = 
¬g
;

152 
	`mem_d”ef
(
¡
);

153 
	}
}

156 
	$»Œªsm™_hªdËr
(*
¬g
)

158 
s_¡¿ns
 *
¡
 = 
¬g
;

160 ()
	`s_£nd
(
¡
->
s
, st->
msg
->
sock
, st->msg->

, &¡->
d¡
,

161 
¡
->
mb
);

163 
¡
->
txc
++;

164 
	`tmr_¡¬t
(&
¡
->
tmrg
, 
	`MIN
(
SIP_T1
<<¡->
txc
, 
SIP_T2
), 
»Œªsm™_hªdËr
,

165 
¡
);

166 
	}
}

169 
boŞ
 
	$ack_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
)

171 
s_¡¿ns
 *
¡
;

173 
¡
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
s
->
ht_¡¿ns
,

174 
	`hash_jß©_¶
(&
msg
->
vŸ
.
b¿nch
),

175 
cmp_ack_hªdËr
, (*)
msg
));

176 ià(!
¡
)

177  
çl£
;

179 
¡
->
¡©e
) {

181 
ACCEPTED
:

183  
çl£
;

185 
COMPLETED
:

186 ià(
	`s_Œª¥_»lŸbË
(
¡
->
msg
->

)) {

187 
	`mem_d”ef
(
¡
);

191 
	`tmr_¡¬t
(&
¡
->
tmr
, 
SIP_T4
, 
tmr_hªdËr
, st);

192 
	`tmr_ÿnûl
(&
¡
->
tmrg
);

193 
¡
->
¡©e
 = 
CONFIRMED
;

200  
Œue
;

201 
	}
}

204 
boŞ
 
	$ÿnûl_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
)

206 
s_¡¿ns
 *
¡
;

208 
¡
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
s
->
ht_¡¿ns
,

209 
	`hash_jß©_¶
(&
msg
->
vŸ
.
b¿nch
),

210 
cmp_ÿnûl_hªdËr
, (*)
msg
));

211 ià(!
¡
)

212  
çl£
;

214 ((
s_msg
 *)
msg
)->
g
 = 
¡
->msg->tag;

216 ()
	`s_»¶y
(
s
, 
msg
, 200, "OK");

218 
¡
->
¡©e
) {

220 
TRYING
:

221 
PROCEEDING
:

222 
¡
->
	`ÿnûlh
(¡->
¬g
);

229  
Œue
;

230 
	}
}

233 
boŞ
 
	$»que¡_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

235 
s_¡¿ns
 *
¡
;

236 
s
 *s = 
¬g
;

238 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "ACK"))

239  
	`ack_hªdËr
(
s
, 
msg
);

241 
¡
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
s
->
ht_¡¿ns
,

242 
	`hash_jß©_¶
(&
msg
->
vŸ
.
b¿nch
),

243 
cmp_hªdËr
, (*)
msg
));

244 ià(
¡
) {

245 
¡
->
¡©e
) {

247 
PROCEEDING
:

248 
COMPLETED
:

249 ()
	`s_£nd
(
¡
->
s
, st->
msg
->
sock
, st->msg->

,

250 &
¡
->
d¡
, st->
mb
);

257  
Œue
;

259 ià(!
	`¶_is£t
(&
msg
->
to
.
g
)) {

261 
¡
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
s
->
ht_¡¿ns_mrg
,

262 
	`hash_jß©_¶
(&
msg
->
ÿÎid
),

263 
cmp_m”ge_hªdËr
, (*)
msg
));

264 ià(
¡
) {

265 ()
	`s_»¶y
(
s
, 
msg
, 482, "Loop Detected");

266  
Œue
;

270 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "CANCEL"))

271  
	`ÿnûl_hªdËr
(
s
, 
msg
);

273  
çl£
;

274 
	}
}

288 
	$s_¡¿ns_®loc
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

289 cÚ¡ 
s_msg
 *
msg
, 
s_ÿnûl_h
 *
ÿnûlh
,

290 *
¬g
)

292 
s_¡¿ns
 *
¡
;

294 ià(!
¡p
 || !
s
 || !
msg
)

295  
EINVAL
;

297 
¡
 = 
	`mem_z®loc
((*¡), 
de¡ruùÜ
);

298 ià(!
¡
)

299  
ENOMEM
;

301 
	`hash_­³nd
(
s
->
ht_¡¿ns
, 
	`hash_jß©_¶
(&
msg
->
vŸ
.
b¿nch
),

302 &
¡
->
he
, st);

304 
	`hash_­³nd
(
s
->
ht_¡¿ns_mrg
, 
	`hash_jß©_¶
(&
msg
->
ÿÎid
),

305 &
¡
->
he_mrg
, st);

307 
¡
->
šv™e
 = !
	`¶_¡rcmp
(&
msg
->
m‘
, "INVITE");

308 
¡
->
msg
 = 
	`mem_»f
((*)msg);

309 
¡
->
¡©e
 = 
TRYING
;

310 
¡
->
ÿnûlh
 = cªûlh ? cªûlh : 
dummy_hªdËr
;

311 
¡
->
¬g
 =‡rg;

312 
¡
->
s
 = sip;

314 *
¡p
 = 
¡
;

317 
	}
}

332 
	$s_¡¿ns_»¶y
(
s_¡¿ns
 **
¡p
, 
s
 *sip,

333 cÚ¡ 
s_msg
 *
msg
, cÚ¡ 
§
 *
d¡
,

334 
ušt16_t
 
scode
, 
mbuf
 *
mb
)

336 
s_¡¿ns
 *
¡
 = 
NULL
;

337 
”r
;

339 ià(!
s
 || !
mb
 || !
d¡
 || (
scode
 < 200 && !
¡p
))

340  
EINVAL
;

342 ià(
¡p
)

343 
¡
 = *
¡p
;

345 ià(!
¡
) {

346 
”r
 = 
	`s_¡¿ns_®loc
(&
¡
, 
s
, 
msg
, 
NULL
, NULL);

347 ià(
”r
)

348  
”r
;

351 
	`mem_d”ef
(
¡
->
mb
);

352 
¡
->
mb
 = 
	`mem_»f
(mb);

353 
¡
->
d¡
 = *dst;

355 
”r
 = 
	`s_£nd
(
s
, 
¡
->
msg
->
sock
, st->msg->

, 
d¡
, 
mb
);

357 ià(
¡p
)

358 *
¡p
 = (
”r
 || 
scode
 >ğ200è? 
NULL
 : 
¡
;

360 ià(
”r
) {

361 
	`mem_d”ef
(
¡
);

362  
”r
;

365 ià(
¡
->
šv™e
) {

366 ià(
scode
 < 200) {

367 
¡
->
¡©e
 = 
PROCEEDING
;

369 ià(
scode
 < 300) {

370 
	`tmr_¡¬t
(&
¡
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
, st);

371 
¡
->
¡©e
 = 
ACCEPTED
;

374 
	`tmr_¡¬t
(&
¡
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
, st);

375 
¡
->
¡©e
 = 
COMPLETED
;

377 ià(!
	`s_Œª¥_»lŸbË
(
¡
->
msg
->

))

378 
	`tmr_¡¬t
(&
¡
->
tmrg
, 
SIP_T1
,

379 
»Œªsm™_hªdËr
, 
¡
);

383 ià(
scode
 < 200) {

384 
¡
->
¡©e
 = 
PROCEEDING
;

387 ià(!
	`s_Œª¥_»lŸbË
(
¡
->
msg
->

)) {

388 
	`tmr_¡¬t
(&
¡
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
,

389 
¡
);

390 
¡
->
¡©e
 = 
COMPLETED
;

393 
	`mem_d”ef
(
¡
);

399 
	}
}

402 
	$s_¡¿ns_š™
(
s
 *s, 
ušt32_t
 
sz
)

404 
”r
;

406 
”r
 = 
	`s_li¡’
(
NULL
, 
s
, 
Œue
, 
»que¡_hªdËr
, sip);

407 ià(
”r
)

408  
”r
;

410 
”r
 = 
	`hash_®loc
(&
s
->
ht_¡¿ns_mrg
, 
sz
);

411 ià(
”r
)

412  
”r
;

414  
	`hash_®loc
(&
s
->
ht_¡¿ns
, 
sz
);

415 
	}
}

418 cÚ¡ *
	$¡©’ame
(
¡©e
 state)

420 
¡©e
) {

422 
TRYING
:  "TRYING";

423 
PROCEEDING
:  "PROCEEDING";

424 
ACCEPTED
:  "ACCEPTED";

425 
COMPLETED
:  "COMPLETED";

426 
CONFIRMED
:  "CONFIRMED";

429 
	}
}

432 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

434 
s_¡¿ns
 *
¡
 = 
Ë
->
d©a
;

435 
»_´štf
 *
pf
 = 
¬g
;

437 ()
	`»_h´štf
(
pf
, " %-10r %-10s %2llus (%r)\n",

438 &
¡
->
msg
->
m‘
,

439 
	`¡©’ame
(
¡
->
¡©e
),

440 
	`tmr_g‘_expœe
(&
¡
->
tmr
)/1000,

441 &
¡
->
msg
->
vŸ
.
b¿nch
);

443  
çl£
;

444 
	}
}

447 
	$s_¡¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip)

449 
”r
;

451 
”r
 = 
	`»_h´štf
(
pf
, "serverransactions:\n");

452 
	`hash_­¶y
(
s
->
ht_¡¿ns
, 
debug_hªdËr
, 
pf
);

454  
”r
;

455 
	}
}

	@re-0.5.6/src/sip/transp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_fmt.h
>

14 
	~<»_uri.h
>

15 
	~<»_sys.h
>

16 
	~<»_tmr.h
>

17 
	~<»_udp.h
>

18 
	~<»_¡un.h
>

19 
	~<»_¤.h
>

20 
	~<»_tı.h
>

21 
	~<»_s.h
>

22 
	~<»_msg.h
>

23 
	~<»_s.h
>

24 
	~"s.h
"

28 
	mTCP_ACCEPT_TIMEOUT
 = 32,

29 
	mTCP_IDLE_TIMEOUT
 = 900,

30 
	mTCP_KEEPALIVE_TIMEOUT
 = 10,

31 
	mTCP_KEEPALIVE_INTVAL
 = 120,

32 
	mTCP_BUFSIZE_MAX
 = 65536,

36 
	ss_Œª¥Üt
 {

37 
Ë
 
	mË
;

38 
§
 
	mÏddr
;

39 
s
 *
	ms
;

40 
s
 *
	ms
;

41 *
	msock
;

42 
s_Œª¥
 
	m
;

46 
	ss_cÚn
 {

47 
Ë
 
	mhe
;

48 
li¡
 
	mql
;

49 
li¡
 
	mk®
;

50 
tmr
 
	mtmr
;

51 
tmr
 
	mtmr_ka
;

52 
§
 
	mÏddr
;

53 
§
 
	m·ddr
;

54 
s_cÚn
 *
	msc
;

55 
tı_cÚn
 *
	mtc
;

56 
mbuf
 *
	mmb
;

57 
s
 *
	ms
;

58 
ušt32_t
 
	mka_š‹rv®
;

59 
boŞ
 
	me¡ablished
;

63 
	ss_cÚnq’t
 {

64 
Ë
 
	mË
;

65 
mbuf
 *
	mmb
;

66 
s_cÚnq’t
 **
	mq’
;

67 
s_Œª¥_h
 *
	mŒª¥h
;

68 *
	m¬g
;

72 
ušt8_t
 
	gülfülf
[4] = {0x0d, 0x0a, 0x0d, 0x0a};

75 
	$š‹º®_Œª¥Üt_hªdËr
(
”r
, *
¬g
)

77 ()
”r
;

78 ()
¬g
;

79 
	}
}

82 
	$Œª¥_de¡ruùÜ
(*
¬g
)

84 
s_Œª¥Üt
 *
Œª¥
 = 
¬g
;

86 ià(
Œª¥
->

 =ğ
SIP_TRANSP_UDP
)

87 
	`udp_hªdËr_£t
(
Œª¥
->
sock
, 
NULL
, NULL);

89 
	`li¡_uÆšk
(&
Œª¥
->
Ë
);

90 
	`mem_d”ef
(
Œª¥
->
sock
);

91 
	`mem_d”ef
(
Œª¥
->
s
);

92 
	}
}

95 
	$cÚn_de¡ruùÜ
(*
¬g
)

97 
s_cÚn
 *
cÚn
 = 
¬g
;

99 
	`tmr_ÿnûl
(&
cÚn
->
tmr_ka
);

100 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

101 
	`li¡_æush
(&
cÚn
->
k®
);

102 
	`li¡_æush
(&
cÚn
->
ql
);

103 
	`hash_uÆšk
(&
cÚn
->
he
);

104 
	`mem_d”ef
(
cÚn
->
sc
);

105 
	`mem_d”ef
(
cÚn
->
tc
);

106 
	`mem_d”ef
(
cÚn
->
mb
);

107 
	}
}

110 
	$q’t_de¡ruùÜ
(*
¬g
)

112 
s_cÚnq’t
 *
q’t
 = 
¬g
;

114 ià(
q’t
->
q’
)

115 *
q’t
->
q’
 = 
NULL
;

117 
	`li¡_uÆšk
(&
q’t
->
Ë
);

118 
	`mem_d”ef
(
q’t
->
mb
);

119 
	}
}

122 cÚ¡ 
s_Œª¥Üt
 *
	$Œª¥_fšd
(
s
 *sip,

123 
s_Œª¥
 

,

124 
af
, cÚ¡ 
§
 *
d¡
)

126 
Ë
 *le;

127 ()
d¡
;

129 
Ë
 = 
s
->
Œª¥l
.
h—d
;†e;†ğË->
Ãxt
) {

131 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
 = 
Ë
->
d©a
;

133 ià(
Œª¥
->

 !=p)

136 ià(
af
 !ğ
AF_UNSPEC
 && 
	`§_af
(&
Œª¥
->
Ïddr
) !=‡f)

139  
Œª¥
;

142  
NULL
;

143 
	}
}

146 
s_cÚn
 *
	$cÚn_fšd
(
s
 *s, cÚ¡ 
§
 *
·ddr
,

147 
boŞ
 
£cu»
)

149 
Ë
 *le;

151 
Ë
 = 
	`li¡_h—d
(
	`hash_li¡
(
s
->
ht_cÚn
, 
	`§_hash
(
·ddr
, 
SA_ALL
)));

153 ; 
Ë
;†ğË->
Ãxt
) {

155 
s_cÚn
 *
cÚn
 = 
Ë
->
d©a
;

157 ià(!
£cu»
 !ğ(
cÚn
->
sc
 =ğ
NULL
))

160 ià(!
	`§_cmp
(&
cÚn
->
·ddr
,…addr, 
SA_ALL
))

163  
cÚn
;

166  
NULL
;

167 
	}
}

170 
	$cÚn_şo£
(
s_cÚn
 *
cÚn
, 
”r
)

172 
Ë
 *le;

174 
cÚn
->
sc
 = 
	`mem_d”ef
(conn->sc);

175 
cÚn
->
tc
 = 
	`mem_d”ef
(conn->tc);

176 
	`tmr_ÿnûl
(&
cÚn
->
tmr_ka
);

177 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

178 
	`hash_uÆšk
(&
cÚn
->
he
);

180 
Ë
 = 
	`li¡_h—d
(&
cÚn
->
ql
);

182 
Ë
) {

184 
s_cÚnq’t
 *
q’t
 = 
Ë
->
d©a
;

185 
Ë
 =†e->
Ãxt
;

187 ià(
q’t
->
q’
) {

188 *
q’t
->
q’
 = 
NULL
;

189 
q’t
->
q’
 = 
NULL
;

192 
q’t
->
	`Œª¥h
(
”r
, q’t->
¬g
);

193 
	`li¡_uÆšk
(&
q’t
->
Ë
);

194 
	`mem_d”ef
(
q’t
);

197 
	`s_k“·live_sigÇl
(&
cÚn
->
k®
, 
”r
);

198 
	}
}

201 
	$cÚn_tmr_hªdËr
(*
¬g
)

203 
s_cÚn
 *
cÚn
 = 
¬g
;

205 
	`cÚn_şo£
(
cÚn
, 
ETIMEDOUT
);

206 
	`mem_d”ef
(
cÚn
);

207 
	}
}

210 
	$cÚn_k“·live_hªdËr
(*
¬g
)

212 
s_cÚn
 *
cÚn
 = 
¬g
;

213 
mbuf
 
mb
;

214 
”r
;

216 
mb
.
buf
 = 
ülfülf
;

217 
mb
.
size
 = (
ülfülf
);

218 
mb
.
pos
 = 0;

219 
mb
.
’d
 = 4;

221 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, &
mb
);

222 ià(
”r
) {

223 
	`cÚn_şo£
(
cÚn
, 
”r
);

224 
	`mem_d”ef
(
cÚn
);

228 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TCP_KEEPALIVE_TIMEOUT
 * 1000,

229 
cÚn_tmr_hªdËr
, 
cÚn
);

230 
	`tmr_¡¬t
(&
cÚn
->
tmr_ka
, 
	`s_k“·live_wa™
(cÚn->
ka_š‹rv®
),

231 
cÚn_k“·live_hªdËr
, 
cÚn
);

232 
	}
}

235 
	$s_»cv
(
s
 *s, cÚ¡ 
s_msg
 *
msg
)

237 
Ë
 *Ë = 
s
->
l¢¾
.
h—d
;

239 
Ë
) {

240 
s_l¢r
 *
l¢r
 = 
Ë
->
d©a
;

242 
Ë
 =†e->
Ãxt
;

244 ià(
msg
->
»q
 !ğ
l¢r
->req)

247 ià(
l¢r
->
	`msgh
(
msg
,†¢r->
¬g
))

251 ià(
msg
->
»q
) {

252 ()
	`»_årštf
(
¡d”r
, "unhandeled„equest from %J: %r %r\n",

253 &
msg
->
¤c
, &msg->
m‘
, &msg->
ruri
);

255 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "CANCEL"))

256 ()
	`s_»¶y
(
s
, 
msg
,

259 ()
	`s_»¶y
(
s
, 
msg
,

263 ()
	`»_årštf
(
¡d”r
, "unhandeled„esponse from %J:"

264 " %u %¸(%r)\n", &
msg
->
¤c
,

265 
msg
->
scode
, &msg->
»asÚ
, &msg->
c£q
.
m‘
);

267 
	}
}

270 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

272 
s_Œª¥Üt
 *
Œª¥
 = 
¬g
;

273 
¡un_unknown_©Œ
 
ua
;

274 
¡un_msg
 *stun_msg;

275 
s_msg
 *
msg
;

276 
”r
;

278 ià(
mb
->
’d
 <= 4)

281 ià(!
	`¡un_msg_decode
(&
¡un_msg
, 
mb
, &
ua
)) {

283 ià(
	`¡un_msg_m‘hod
(
¡un_msg
è=ğ
STUN_METHOD_BINDING
) {

285 
	`¡un_msg_şass
(
¡un_msg
)) {

287 
STUN_CLASS_REQUEST
:

288 ()
	`¡un_»¶y
(
IPPROTO_UDP
, 
Œª¥
->
sock
,

289 
¤c
, 0, 
¡un_msg
,

290 
NULL
, 0, 
çl£
, 2,

291 
STUN_ATTR_XOR_MAPPED_ADDR
,

292 
¤c
,

293 
STUN_ATTR_SOFTWARE
,

294 
Œª¥
->
s
->
soáw¬e
);

298 ()
	`¡un_ù¿ns_»cv
(
Œª¥
->
s
->
¡un
,

299 
¡un_msg
, &
ua
);

304 
	`mem_d”ef
(
¡un_msg
);

309 
”r
 = 
	`s_msg_decode
(&
msg
, 
mb
);

310 ià(
”r
) {

311 ()
	`»_årštf
(
¡d”r
, "s: msg decod”r: %m\n", 
”r
);

315 
msg
->
sock
 = 
	`mem_»f
(
Œª¥
->sock);

316 
msg
->
¤c
 = *src;

317 
msg
->
d¡
 = 
Œª¥
->
Ïddr
;

318 
msg
->

 = 
SIP_TRANSP_UDP
;

320 
	`s_»cv
(
Œª¥
->
s
, 
msg
);

322 
	`mem_d”ef
(
msg
);

323 
	}
}

326 
	$tı_»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

328 
s_cÚn
 *
cÚn
 = 
¬g
;

329 
size_t
 
pos
;

330 
”r
 = 0;

332 ià(
cÚn
->
mb
) {

333 
pos
 = 
cÚn
->
mb
->pos;

335 
cÚn
->
mb
->
pos
 = cÚn->mb->
’d
;

337 
”r
 = 
	`mbuf_wr™e_mem
(
cÚn
->
mb
, 
	`mbuf_buf
(mb),
	`mbuf_g‘_Ëá
(mb));

338 ià(
”r
)

339 
out
;

341 
cÚn
->
mb
->
pos
 =…os;

343 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
è> 
TCP_BUFSIZE_MAX
) {

344 
”r
 = 
EOVERFLOW
;

345 
out
;

349 
cÚn
->
mb
 = 
	`mem_»f
(mb);

353 
s_msg
 *
msg
;

354 
ušt32_t
 
ş’
;

355 
size_t
 
’d
;

357 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
) < 2)

360 ià(!
	`memcmp
(
	`mbuf_buf
(
cÚn
->
mb
), "\r\n", 2)) {

362 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TCP_IDLE_TIMEOUT
 * 1000,

363 
cÚn_tmr_hªdËr
, 
cÚn
);

365 
cÚn
->
mb
->
pos
 += 2;

367 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
) >= 2 &&

368 !
	`memcmp
(
	`mbuf_buf
(
cÚn
->
mb
), "\r\n", 2)) {

370 
mbuf
 
mbr
;

372 
cÚn
->
mb
->
pos
 += 2;

374 
mbr
.
buf
 = 
ülfülf
;

375 
mbr
.
size
 = (
ülfülf
);

376 
mbr
.
pos
 = 0;

377 
mbr
.
’d
 = 2;

379 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, &
mbr
);

380 ià(
”r
)

384 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
))

387 
cÚn
->
mb
 = 
	`mem_d”ef
(conn->mb);

391 
pos
 = 
cÚn
->
mb
->pos;

393 
”r
 = 
	`s_msg_decode
(&
msg
, 
cÚn
->
mb
);

394 ià(
”r
) {

395 ià(
”r
 =ğ
ENODATA
)

396 
”r
 = 0;

400 ià(!
msg
->
ş’
.
p
) {

401 
	`mem_d”ef
(
msg
);

402 
”r
 = 
EBADMSG
;

406 
ş’
 = 
	`¶_u32
(&
msg
->clen);

408 ià(
	`mbuf_g‘_Ëá
(
cÚn
->
mb
è< 
ş’
) {

409 
cÚn
->
mb
->
pos
 =…os;

410 
	`mem_d”ef
(
msg
);

414 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TCP_IDLE_TIMEOUT
 * 1000,

415 
cÚn_tmr_hªdËr
, 
cÚn
);

417 
’d
 = 
cÚn
->
mb
->end;

419 
msg
->
mb
->
’d
 = msg->mb->
pos
 + 
ş’
;

420 
msg
->
sock
 = 
	`mem_»f
(
cÚn
);

421 
msg
->
¤c
 = 
cÚn
->
·ddr
;

422 
msg
->
d¡
 = 
cÚn
->
Ïddr
;

423 
msg
->

 = 
cÚn
->
sc
 ? 
SIP_TRANSP_TLS
 : 
SIP_TRANSP_TCP
;

425 
	`s_»cv
(
cÚn
->
s
, 
msg
);

426 
	`mem_d”ef
(
msg
);

428 ià(
’d
 <ğ
cÚn
->
mb
->end) {

429 
cÚn
->
mb
 = 
	`mem_d”ef
(conn->mb);

433 
mb
 = 
	`mbuf_®loc
(
’d
 - 
cÚn
->mb->end);

434 ià(!
mb
) {

435 
”r
 = 
ENOMEM
;

436 
out
;

439 ()
	`mbuf_wr™e_mem
(
mb
, &
cÚn
->mb->
buf
[cÚn->mb->
’d
],

440 
’d
 - 
cÚn
->
mb
->end);

442 
mb
->
pos
 = 0;

444 
	`mem_d”ef
(
cÚn
->
mb
);

445 
cÚn
->
mb
 = mb;

448 
out
:

449 ià(
”r
) {

450 
	`cÚn_şo£
(
cÚn
, 
”r
);

451 
	`mem_d”ef
(
cÚn
);

453 
	}
}

456 
	$tı_e¡ab_hªdËr
(*
¬g
)

458 
s_cÚn
 *
cÚn
 = 
¬g
;

459 
Ë
 *le;

460 
”r
;

462 
cÚn
->
e¡ablished
 = 
Œue
;

464 
Ë
 = 
	`li¡_h—d
(&
cÚn
->
ql
);

466 
Ë
) {

468 
s_cÚnq’t
 *
q’t
 = 
Ë
->
d©a
;

469 
Ë
 =†e->
Ãxt
;

471 ià(
q’t
->
q’
) {

472 *
q’t
->
q’
 = 
NULL
;

473 
q’t
->
q’
 = 
NULL
;

476 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
q’t
->
mb
);

477 ià(
”r
)

478 
q’t
->
	`Œª¥h
(
”r
, q’t->
¬g
);

480 
	`li¡_uÆšk
(&
q’t
->
Ë
);

481 
	`mem_d”ef
(
q’t
);

483 
	}
}

486 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

488 
s_cÚn
 *
cÚn
 = 
¬g
;

490 
	`cÚn_şo£
(
cÚn
, 
”r
 ?ƒ¼ : 
ECONNRESET
);

491 
	`mem_d”ef
(
cÚn
);

492 
	}
}

495 
	$tı_cÚÃù_hªdËr
(cÚ¡ 
§
 *
·ddr
, *
¬g
)

497 
s_Œª¥Üt
 *
Œª¥
 = 
¬g
;

498 
s_cÚn
 *
cÚn
;

499 
”r
;

501 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

502 ià(!
cÚn
) {

503 
”r
 = 
ENOMEM
;

504 
out
;

507 
	`hash_­³nd
(
Œª¥
->
s
->
ht_cÚn
, 
	`§_hash
(
·ddr
, 
SA_ALL
),

508 &
cÚn
->
he
, conn);

510 
cÚn
->
·ddr
 = *paddr;

511 
cÚn
->
s
 = 
Œª¥
->sip;

513 
”r
 = 
	`tı_acû±
(&
cÚn
->
tc
, 
Œª¥
->
sock
, 
tı_e¡ab_hªdËr
,

514 
tı_»cv_hªdËr
, 
tı_şo£_hªdËr
, 
cÚn
);

515 ià(
”r
)

516 
out
;

518 
”r
 = 
	`tı_cÚn_loÿl_g‘
(
cÚn
->
tc
, &cÚn->
Ïddr
);

519 ià(
”r
)

520 
out
;

522 #ifdeà
USE_TLS


523 ià(
Œª¥
->
s
) {

524 
”r
 = 
	`s_¡¬t_tı
(&
cÚn
->
sc
, 
Œª¥
->
s
, cÚn->
tc
, 0);

525 ià(
”r
)

526 
out
;

530 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TCP_ACCEPT_TIMEOUT
 * 1000,

531 
cÚn_tmr_hªdËr
, 
cÚn
);

533 
out
:

534 ià(
”r
) {

535 
	`tı_»jeù
(
Œª¥
->
sock
);

536 
	`mem_d”ef
(
cÚn
);

538 
	}
}

541 
	$cÚn_£nd
(
s_cÚnq’t
 **
q’
, 
s
 *s, 
boŞ
 
£cu»
,

542 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
,

543 
s_Œª¥_h
 *
Œª¥h
, *
¬g
)

545 
s_cÚn
 *
cÚn
, *
Ãw_cÚn
 = 
NULL
;

546 
s_cÚnq’t
 *
q’t
;

547 
”r
 = 0;

549 
cÚn
 = 
	`cÚn_fšd
(
s
, 
d¡
, 
£cu»
);

550 ià(
cÚn
) {

551 ià(!
cÚn
->
e¡ablished
)

552 
’queue
;

554  
	`tı_£nd
(
cÚn
->
tc
, 
mb
);

557 
Ãw_cÚn
 = 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

558 ià(!
cÚn
)

559  
ENOMEM
;

561 
	`hash_­³nd
(
s
->
ht_cÚn
, 
	`§_hash
(
d¡
, 
SA_ALL
), &
cÚn
->
he
, conn);

562 
cÚn
->
·ddr
 = *
d¡
;

563 
cÚn
->
s
 = sip;

565 
”r
 = 
	`tı_cÚÃù
(&
cÚn
->
tc
, 
d¡
, 
tı_e¡ab_hªdËr
, 
tı_»cv_hªdËr
,

566 
tı_şo£_hªdËr
, 
cÚn
);

567 ià(
”r
)

568 
out
;

570 
”r
 = 
	`tı_cÚn_loÿl_g‘
(
cÚn
->
tc
, &cÚn->
Ïddr
);

571 ià(
”r
)

572 
out
;

574 #ifdeà
USE_TLS


575 ià(
£cu»
) {

576 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
;

578 
Œª¥
 = 
	`Œª¥_fšd
(
s
, 
SIP_TRANSP_TLS
, 
	`§_af
(
d¡
), dst);

579 ià(!
Œª¥
 || !Œª¥->
s
) {

580 
”r
 = 
EPROTONOSUPPORT
;

581 
out
;

584 
”r
 = 
	`s_¡¬t_tı
(&
cÚn
->
sc
, 
Œª¥
->
s
, cÚn->
tc
, 0);

585 ià(
”r
)

586 
out
;

590 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TCP_IDLE_TIMEOUT
 * 1000, 
cÚn_tmr_hªdËr
, conn);

592 
’queue
:

593 
q’t
 = 
	`mem_z®loc
((*q’t), 
q’t_de¡ruùÜ
);

594 ià(!
q’t
) {

595 
”r
 = 
ENOMEM
;

596 
out
;

600 
	`li¡_­³nd
(&
cÚn
->
ql
, &
q’t
->
Ë
, qent);

601 
q’t
->
mb
 = 
	`mem_»f
(mb);

602 
q’t
->
Œª¥h
 =¿n¥h ?¿n¥h : 
š‹º®_Œª¥Üt_hªdËr
;

603 
q’t
->
¬g
 =‡rg;

605 ià(
q’
) {

606 
q’t
->
q’
 = qentp;

607 *
q’
 = 
q’t
;

610 
out
:

611 ià(
”r
)

612 
	`mem_d”ef
(
Ãw_cÚn
);

614  
”r
;

615 
	}
}

618 
	$s_Œª¥_š™
(
s
 *s, 
ušt32_t
 
sz
)

620  
	`hash_®loc
(&
s
->
ht_cÚn
, 
sz
);

621 
	}
}

634 
	$s_Œª¥_add
(
s
 *s, 
s_Œª¥
 

,

635 cÚ¡ 
§
 *
Ïddr
, ...)

637 
s_Œª¥Üt
 *
Œª¥
;

638 
s
 *tls;

639 
va_li¡
 
­
;

640 
”r
;

642 ià(!
s
 || !
Ïddr
 || !
	`§_is£t
Öaddr, 
SA_ADDR
))

643  
EINVAL
;

645 
Œª¥
 = 
	`mem_z®loc
((*Œª¥), 
Œª¥_de¡ruùÜ
);

646 ià(!
Œª¥
)

647  
ENOMEM
;

649 
	`li¡_­³nd
(&
s
->
Œª¥l
, &
Œª¥
->
Ë
,ransp);

650 
Œª¥
->
s
 = sip;

651 
Œª¥
->

 =p;

653 
	`va_¡¬t
(
­
, 
Ïddr
);

655 

) {

657 
SIP_TRANSP_UDP
:

658 
”r
 = 
	`udp_li¡’
((
udp_sock
 **)&
Œª¥
->
sock
, 
Ïddr
,

659 
udp_»cv_hªdËr
, 
Œª¥
);

660 ià(
”r
)

663 
”r
 = 
	`udp_loÿl_g‘
(
Œª¥
->
sock
, &Œª¥->
Ïddr
);

666 
SIP_TRANSP_TLS
:

667 
s
 = 
	`va_¬g
(
­
, tls *);

668 ià(!
s
) {

669 
”r
 = 
EINVAL
;

673 
Œª¥
->
s
 = 
	`mem_»f
(tls);

677 
SIP_TRANSP_TCP
:

678 
”r
 = 
	`tı_li¡’
((
tı_sock
 **)&
Œª¥
->
sock
, 
Ïddr
,

679 
tı_cÚÃù_hªdËr
, 
Œª¥
);

680 ià(
”r
)

683 
”r
 = 
	`tı_sock_loÿl_g‘
(
Œª¥
->
sock
, &Œª¥->
Ïddr
);

687 
”r
 = 
EPROTONOSUPPORT
;

691 
	`va_’d
(
­
);

693 ià(
”r
)

694 
	`mem_d”ef
(
Œª¥
);

696  
”r
;

697 
	}
}

705 
	$s_Œª¥_æush
(
s
 *sip)

707 ià(!
s
)

710 
	`hash_æush
(
s
->
ht_cÚn
);

711 
	`li¡_æush
(&
s
->
Œª¥l
);

712 
	}
}

715 
	$s_Œª¥_£nd
(
s_cÚnq’t
 **
q’
, 
s
 *s, *
sock
,

716 
s_Œª¥
 

, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
,

717 
s_Œª¥_h
 *
Œª¥h
, *
¬g
)

719 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
;

720 
s_cÚn
 *
cÚn
;

721 
boŞ
 
£cu»
 = 
çl£
;

722 
”r
;

724 ià(!
s
 || !
d¡
 || !
mb
)

725  
EINVAL
;

727 

) {

729 
SIP_TRANSP_UDP
:

730 ià(!
sock
) {

731 
Œª¥
 = 
	`Œª¥_fšd
(
s
, 

, 
	`§_af
(
d¡
), dst);

732 ià(!
Œª¥
)

733  
EPROTONOSUPPORT
;

735 
sock
 = 
Œª¥
->sock;

738 
”r
 = 
	`udp_£nd
(
sock
, 
d¡
, 
mb
);

741 
SIP_TRANSP_TLS
:

742 
£cu»
 = 
Œue
;

745 
SIP_TRANSP_TCP
:

746 
cÚn
 = 
sock
;

748 ià(
cÚn
 && cÚn->
tc
)

749 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
mb
);

751 
”r
 = 
	`cÚn_£nd
(
q’
, 
s
, 
£cu»
, 
d¡
, 
mb
,

752 
Œª¥h
, 
¬g
);

756 
”r
 = 
EPROTONOSUPPORT
;

760  
”r
;

761 
	}
}

764 
	$s_Œª¥_Ïddr
(
s
 *s, 
§
 *
Ïddr
, 
s_Œª¥
 

,

765 cÚ¡ 
§
 *
d¡
)

767 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
;

769 ià(!
s
 || !
Ïddr
)

770  
EINVAL
;

772 
Œª¥
 = 
	`Œª¥_fšd
(
s
, 

, 
	`§_af
(
d¡
), dst);

773 ià(!
Œª¥
)

774  
EPROTONOSUPPORT
;

776 *
Ïddr
 = 
Œª¥
->laddr;

779 
	}
}

782 
boŞ
 
	$s_Œª¥_suµÜ‹d
(
s
 *s, 
s_Œª¥
 

, 
af
)

784 ià(!
s
)

785  
çl£
;

787  
	`Œª¥_fšd
(
s
, 

, 
af
, 
NULL
) != NULL;

788 
	}
}

800 
boŞ
 
	$s_Œª¥_i¦addr
(cÚ¡ 
s
 *s, 
s_Œª¥
 

,

801 cÚ¡ 
§
 *
Ïddr
)

803 
Ë
 *le;

805 ià(!
s
 || !
Ïddr
)

806  
çl£
;

808 
Ë
=
s
->
Œª¥l
.
h—d
;†e;†eöe->
Ãxt
) {

810 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
 = 
Ë
->
d©a
;

812 ià(

 !ğ
SIP_TRANSP_NONE
 && 
Œª¥
->tp !=p)

815 ià(!
	`§_cmp
(&
Œª¥
->
Ïddr
,†addr, 
SA_ALL
))

818  
Œue
;

821  
çl£
;

822 
	}
}

832 cÚ¡ *
	$s_Œª¥_Çme
(
s_Œª¥
 

)

834 

) {

836 
SIP_TRANSP_UDP
:  "UDP";

837 
SIP_TRANSP_TCP
:  "TCP";

838 
SIP_TRANSP_TLS
:  "TLS";

841 
	}
}

844 cÚ¡ *
	$s_Œª¥_¤vid
(
s_Œª¥
 

)

846 

) {

848 
SIP_TRANSP_UDP
:  "_sip._udp";

849 
SIP_TRANSP_TCP
:  "_sip._tcp";

850 
SIP_TRANSP_TLS
:  "_sips._tcp";

853 
	}
}

863 cÚ¡ *
	$s_Œª¥_·¿m
(
s_Œª¥
 

)

865 

) {

867 
SIP_TRANSP_UDP
:  "";

868 
SIP_TRANSP_TCP
:  ";transport=tcp";

869 
SIP_TRANSP_TLS
:  ";transport=tls";

872 
	}
}

875 
boŞ
 
	$s_Œª¥_»lŸbË
(
s_Œª¥
 

)

877 

) {

879 
SIP_TRANSP_UDP
:  
çl£
;

880 
SIP_TRANSP_TCP
:  
Œue
;

881 
SIP_TRANSP_TLS
:  
Œue
;

882 :  
çl£
;

884 
	}
}

895 
ušt16_t
 
	$s_Œª¥_pÜt
(
s_Œª¥
 

, 
ušt16_t
 
pÜt
)

897 ià(
pÜt
)

898  
pÜt
;

900 

) {

902 
SIP_TRANSP_UDP
:  
SIP_PORT
;

903 
SIP_TRANSP_TCP
:  
SIP_PORT
;

904 
SIP_TRANSP_TLS
:  
SIP_PORT_TLS
;

907 
	}
}

910 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

912 cÚ¡ 
s_Œª¥Üt
 *
Œª¥
 = 
Ë
->
d©a
;

913 
»_´štf
 *
pf
 = 
¬g
;

915 ()
	`»_h´štf
(
pf
, " %J (%s)\n",

916 &
Œª¥
->
Ïddr
,

917 
	`s_Œª¥_Çme
(
Œª¥
->

));

919  
çl£
;

920 
	}
}

923 
	$s_Œª¥_debug
(
»_´štf
 *
pf
, cÚ¡ 
s
 *sip)

925 
”r
;

927 
”r
 = 
	`»_h´štf
(
pf
, "transports:\n");

928 
	`li¡_­¶y
(&
s
->
Œª¥l
, 
Œue
, 
debug_hªdËr
, 
pf
);

930  
”r
;

931 
	}
}

941 
tı_cÚn
 *
	$s_msg_tıcÚn
(cÚ¡ 
s_msg
 *
msg
)

943 ià(!
msg
 || !msg->
sock
)

944  
NULL
;

946 
msg
->

) {

948 
SIP_TRANSP_TCP
:

949 
SIP_TRANSP_TLS
:

950  ((
s_cÚn
 *)
msg
->
sock
)->
tc
;

953  
NULL
;

955 
	}
}

958 
	$s_k“·live_tı
(
s_k“·live
 *
ka
, 
s_cÚn
 *
cÚn
,

959 
ušt32_t
 
š‹rv®
)

961 ià(!
ka
 || !
cÚn
)

962  
EINVAL
;

964 ià(!
cÚn
->
tc
 || !cÚn->
e¡ablished
)

965  
ENOTCONN
;

967 
	`li¡_­³nd
(&
cÚn
->
k®
, &
ka
->
Ë
, ka);

969 ià(!
	`tmr_i¤uÂšg
(&
cÚn
->
tmr_ka
)) {

971 
š‹rv®
 = 
	`MAX
(š‹rv® ? iÁ”v® : 
TCP_KEEPALIVE_INTVAL
,

972 
TCP_KEEPALIVE_TIMEOUT
 * 2);

974 
cÚn
->
ka_š‹rv®
 = 
š‹rv®
;

976 
	`tmr_¡¬t
(&
cÚn
->
tmr_ka
, 
	`s_k“·live_wa™
(cÚn->
ka_š‹rv®
),

977 
cÚn_k“·live_hªdËr
, 
cÚn
);

981 
	}
}

	@re-0.5.6/src/sip/via.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_uri.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_msg.h
>

13 
	~<»_s.h
>

16 
	$decode_ho¡pÜt
(cÚ¡ 
¶
 *
ho¡pÜt
, ¶ *
ho¡
,

17 
¶
 *
pÜt
)

20 ià(!
	`»_»gex
(
ho¡pÜt
->
p
, ho¡pÜt->
l
, "\\[[0-9a-f:]+\\][:]*[0-9]*",

21 
ho¡
, 
NULL
, 
pÜt
))

25  
	`»_»gex
(
ho¡pÜt
->
p
, ho¡pÜt->
l
, "[^:]+[:]*[0-9]*",

26 
ho¡
, 
NULL
, 
pÜt
);

27 
	}
}

38 
	$s_vŸ_decode
(
s_vŸ
 *
vŸ
, cÚ¡ 
¶
 *pl)

40 
¶
 
Œª¥
, 
ho¡
, 
pÜt
;

41 
”r
;

43 ià(!
vŸ
 || !
¶
)

44  
EINVAL
;

46 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
,

49 
NULL
, NULL, NULL, NULL, &
Œª¥
,

50 
NULL
, &
vŸ
->
£Áby
, NULL, &vŸ->
·¿ms
);

51 ià(
”r
)

52  
”r
;

54 ià(!
	`¶_¡rcmp
(&
Œª¥
, "TCP"))

55 
vŸ
->

 = 
SIP_TRANSP_TCP
;

56 ià(!
	`¶_¡rcmp
(&
Œª¥
, "TLS"))

57 
vŸ
->

 = 
SIP_TRANSP_TLS
;

58 ià(!
	`¶_¡rcmp
(&
Œª¥
, "UDP"))

59 
vŸ
->

 = 
SIP_TRANSP_UDP
;

61 
vŸ
->

 = 
SIP_TRANSP_NONE
;

63 
”r
 = 
	`decode_ho¡pÜt
(&
vŸ
->
£Áby
, &
ho¡
, &
pÜt
);

64 ià(
”r
)

65  
”r
;

67 
	`§_š™
(&
vŸ
->
addr
, 
AF_INET
);

69 ()
	`§_£t
(&
vŸ
->
addr
, &
ho¡
, 0);

71 ià(
	`¶_is£t
(&
pÜt
))

72 
	`§_£t_pÜt
(&
vŸ
->
addr
, 
	`¶_u32
(&
pÜt
));

74 
vŸ
->
v®
 = *
¶
;

76  
	`msg_·¿m_decode
(&
vŸ
->
·¿ms
, "b¿nch", &vŸ->
b¿nch
);

77 
	}
}

	@re-0.5.6/src/sipevent/listen.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_sev’t.h
>

18 
	~"sev’t.h
"

21 
	ssubcmp
 {

22 cÚ¡ 
sev’t_ev’t
 *
	mevt
;

23 cÚ¡ 
s_msg
 *
	mmsg
;

27 
	$de¡ruùÜ
(*
¬g
)

29 
sev’t_sock
 *
sock
 = 
¬g
;

31 
	`mem_d”ef
(
sock
->
l¢r
);

32 
	`hash_æush
(
sock
->
ht_nÙ
);

33 
	`hash_æush
(
sock
->
ht_sub
);

34 
	`mem_d”ef
(
sock
->
ht_nÙ
);

35 
	`mem_d”ef
(
sock
->
ht_sub
);

36 
	}
}

39 
boŞ
 
	$ev’t_cmp
(cÚ¡ 
sev’t_ev’t
 *
evt
,

40 cÚ¡ *
ev’t
, cÚ¡ *
id
,

41 
št32_t
 
»ãr_c£q
)

43 ià(
	`¶_¡rcmp
(&
evt
->
ev’t
,ƒvent))

44  
çl£
;

46 ià(!
	`¶_is£t
(&
evt
->
id
) && !id)

47  
Œue
;

49 ià(!
	`¶_is£t
(&
evt
->
id
))

50  
çl£
;

52 ià(!
id
) {

53 ià(
»ãr_c£q
 >ğ0 && (
št32_t
)
	`¶_u32
(&
evt
->
id
) ==„efer_cseq)

54  
Œue
;

56  
çl£
;

59 ià(
	`¶_¡rcmp
(&
evt
->
id
, id))

60  
çl£
;

62  
Œue
;

63 
	}
}

66 
boŞ
 
	$nÙ_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

68 cÚ¡ 
subcmp
 *
cmp
 = 
¬g
;

69 
snÙ
 *
nÙ
 = 
Ë
->
d©a
;

71  
	`s_dŸlog_cmp
(
nÙ
->
dlg
, 
cmp
->
msg
) &&

72 
	`ev’t_cmp
(
cmp
->
evt
, 
nÙ
->
ev’t
,‚Ù->
id
, -1);

73 
	}
}

76 
boŞ
 
	$sub_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

78 cÚ¡ 
subcmp
 *
cmp
 = 
¬g
;

79 
ssub
 *
sub
 = 
Ë
->
d©a
;

81  
	`s_dŸlog_cmp
(
sub
->
dlg
, 
cmp
->
msg
) &&

82 (!
cmp
->
evt
 || 
	`ev’t_cmp
(cmp->evt, 
sub
->
ev’t
, sub->
id
,

83 
sub
->
»ãr_c£q
));

84 
	}
}

87 
boŞ
 
	$sub_cmp_h®f_hªdËr
(
Ë
 *Ë, *
¬g
)

89 cÚ¡ 
subcmp
 *
cmp
 = 
¬g
;

90 
ssub
 *
sub
 = 
Ë
->
d©a
;

92  
	`s_dŸlog_cmp_h®f
(
sub
->
dlg
, 
cmp
->
msg
) &&

93 !
	`s_dŸlog_e¡ablished
(
sub
->
dlg
) &&

94 (!
cmp
->
evt
 || 
	`ev’t_cmp
(cmp->evt, 
sub
->
ev’t
, sub->
id
,

95 
sub
->
»ãr_c£q
));

96 
	}
}

99 
snÙ
 *
	$snÙ_fšd
(
sev’t_sock
 *
sock
,

100 cÚ¡ 
s_msg
 *
msg
,

101 cÚ¡ 
sev’t_ev’t
 *
evt
)

103 
subcmp
 
cmp
;

105 
cmp
.
msg
 = msg;

106 
cmp
.
evt
 =ƒvt;

108  
	`li¡_Ëd©a
(
	`hash_lookup
(
sock
->
ht_nÙ
,

109 
	`hash_jß©_¶
(&
msg
->
ÿÎid
),

110 
nÙ_cmp_hªdËr
, &
cmp
));

111 
	}
}

114 
ssub
 *
	$ssub_fšd
(
sev’t_sock
 *
sock
,

115 cÚ¡ 
s_msg
 *
msg
,

116 cÚ¡ 
sev’t_ev’t
 *
evt
, 
boŞ
 
fuÎ
)

118 
subcmp
 
cmp
;

120 
cmp
.
msg
 = msg;

121 
cmp
.
evt
 =ƒvt;

123  
	`li¡_Ëd©a
(
	`hash_lookup
(
sock
->
ht_sub
,

124 
	`hash_jß©_¶
(&
msg
->
ÿÎid
), 
fuÎ
 ?

125 
sub_cmp_hªdËr
 : 
sub_cmp_h®f_hªdËr
,

126 &
cmp
));

127 
	}
}

130 
	$nÙify_hªdËr
(
sev’t_sock
 *
sock
,

131 cÚ¡ 
s_msg
 *
msg
)

133 
sev’t_sub¡©e
 
¡©e
;

134 
sev’t_ev’t
 
ev’t
;

135 
s
 *s = 
sock
->sip;

136 cÚ¡ 
s_hdr
 *
hdr
;

137 
ssub
 *
sub
;

138 
ušt32_t
 
Äefs
;

139 
m
[256];

140 
”r
;

142 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_EVENT
);

143 ià(!
hdr
 || 
	`sev’t_ev’t_decode
(&
ev’t
, &hdr->
v®
)) {

144 ()
	`s_»¶y
(
s
, 
msg
, 489, "Bad Event");

148 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_SUBSCRIPTION_STATE
);

149 ià(!
hdr
 || 
	`sev’t_sub¡©e_decode
(&
¡©e
, &hdr->
v®
)) {

150 ()
	`s_»¶y
(
s
, 
msg
, 400,"Bad Subscription-State Header");

154 
sub
 = 
	`ssub_fšd
(
sock
, 
msg
, &
ev’t
, 
Œue
);

155 ià(!
sub
) {

156 
sub
 = 
	`ssub_fšd
(
sock
, 
msg
, &
ev’t
, 
çl£
);

157 ià(!
sub
) {

158 ()
	`s_»¶y
(
s
, 
msg
,

163 ià(
sub
->
fÜkh
) {

165 
ssub
 *
fsub
;

167 
”r
 = 
sub
->
	`fÜkh
(&
fsub
, sub, 
msg
, sub->
¬g
);

168 ià(
”r
) {

169 ()
	`s_»¶y
(
s
, 
msg
, 500,

170 
	`¡r_”rÜ
(
”r
, 
m
, (m)));

174 
sub
 = 
fsub
;

177 
”r
 = 
	`s_dŸlog_ü—‹
(
sub
->
dlg
, 
msg
);

178 ià(
”r
) {

179 ()
	`s_»¶y
(
s
, 
msg
, 500,

180 
	`¡r_”rÜ
(
”r
, 
m
, (m)));

186 ià(!
	`s_dŸlog_r£q_v®id
(
sub
->
dlg
, 
msg
)) {

187 ()
	`s_»¶y
(
s
, 
msg
, 500, "Bad Sequence");

191 ()
	`s_dŸlog_upd©e
(
sub
->
dlg
, 
msg
);

194 ià(
sub
->
»ãr_c£q
 >ğ0 && !sub->
id
 && 
	`¶_is£t
(&
ev’t
.id)) {

196 
”r
 = 
	`¶_¡rdup
(&
sub
->
id
, &
ev’t
.id);

197 ià(
”r
) {

198 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 500,

199 
	`¡r_”rÜ
(
”r
, 
m
, (m)));

204 
¡©e
.state) {

206 
SIPEVENT_ACTIVE
:

207 
SIPEVENT_PENDING
:

208 ià(!
sub
->
‹rmcÚf
)

209 
sub
->
subsüibed
 = 
Œue
;

211 ià(!
sub
->
‹rmš©ed
 && !sub->
‹rmwa™
 &&

212 
	`¶_is£t
(&
¡©e
.
expœes
))

213 
	`ssub_»scheduË
(
sub
, 
	`¶_u32
(&
¡©e
.
expœes
) * 900);

216 
SIPEVENT_TERMINATED
:

217 
sub
->
subsüibed
 = 
çl£
;

218 
sub
->
‹rmcÚf
 = 
Œue
;

222 
	`mem_»f
(
sub
);

223 
sub
->
	`nÙifyh
(
s
, 
msg
, sub->
¬g
);

224 
Äefs
 = 
	`mem_Äefs
(
sub
);

225 
	`mem_d”ef
(
sub
);

228 ià(
Äefs
 == 1)

231 ià(
¡©e
.¡©=ğ
SIPEVENT_TERMINATED
) {

233 ià(!
sub
->
‹rmš©ed
) {

234 
sub
->
‹rmwa™
 = 
çl£
;

235 
	`ssub_‹rmš©e
(
sub
, 0, 
msg
, &
¡©e
);

237 ià(
sub
->
‹rmwa™
) {

238 
sub
->
‹rmwa™
 = 
çl£
;

239 
	`tmr_ÿnûl
(&
sub
->
tmr
);

240 
	`mem_d”ef
(
sub
);

243 
	}
}

246 
	$subsüibe_hªdËr
(
sev’t_sock
 *
sock
,

247 cÚ¡ 
s_msg
 *
msg
)

249 
sev’t_ev’t
 
ev’t
;

250 
s
 *s = 
sock
->sip;

251 cÚ¡ 
s_hdr
 *
hdr
;

252 
snÙ
 *
nÙ
;

253 
ušt32_t
 
expœes
;

255 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_EVENT
);

256 ià(!
hdr
 || 
	`sev’t_ev’t_decode
(&
ev’t
, &hdr->
v®
)) {

257 ()
	`s_»¶y
(
s
, 
msg
, 400, "Bad Event Header");

261 
nÙ
 = 
	`snÙ_fšd
(
sock
, 
msg
, &
ev’t
);

262 ià(!
nÙ
 ||‚Ù->
‹rmš©ed
) {

263 ()
	`s_»¶y
(
s
, 
msg
, 481, "Subscription Does Not Exist");

267 ià(
	`¶_is£t
(&
msg
->
expœes
))

268 
expœes
 = 
	`¶_u32
(&
msg
->expires);

270 
expœes
 = 
nÙ
->
expœes_dæ
;

272 ià(
expœes
 > 0 &&ƒxpœe < 
nÙ
->
expœes_mš
) {

273 ()
	`s_»¶yf
(
s
, 
msg
, 423, "Interval Too Brief",

277 
nÙ
->
expœes_mš
);

281 ià(!
	`s_dŸlog_r£q_v®id
(
nÙ
->
dlg
, 
msg
)) {

282 ()
	`s_»¶y
(
s
, 
msg
, 500, "Bad Sequence");

286 ()
	`s_dŸlog_upd©e
(
nÙ
->
dlg
, 
msg
);

288 
	`snÙ_»äesh
(
nÙ
, 
expœes
);

290 ()
	`snÙ_»¶y
(
nÙ
, 
msg
, 200, "OK");

292 ()
	`snÙ_nÙify
(
nÙ
);

293 
	}
}

296 
boŞ
 
	$»que¡_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

298 
sev’t_sock
 *
sock
 = 
¬g
;

300 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "SUBSCRIBE")) {

302 ià(
	`¶_is£t
(&
msg
->
to
.
g
)) {

303 
	`subsüibe_hªdËr
(
sock
, 
msg
);

304  
Œue
;

307  
sock
->
subh
 ? sock->
	`subh
(
msg
, sock->
¬g
è: 
çl£
;

309 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "NOTIFY")) {

311 
	`nÙify_hªdËr
(
sock
, 
msg
);

312  
Œue
;

315  
çl£
;

317 
	}
}

320 
	$sev’t_li¡’
(
sev’t_sock
 **
sockp
, 
s
 *sip,

321 
ušt32_t
 
htsize_nÙ
, ušt32_ˆ
htsize_sub
,

322 
s_msg_h
 *
subh
, *
¬g
)

324 
sev’t_sock
 *
sock
;

325 
”r
;

327 ià(!
sockp
 || !
s
 || !
htsize_nÙ
 || !
htsize_sub
)

328  
EINVAL
;

330 
sock
 = 
	`mem_z®loc
((*sock), 
de¡ruùÜ
);

331 ià(!
sock
)

332  
ENOMEM
;

334 
”r
 = 
	`s_li¡’
(&
sock
->
l¢r
, 
s
, 
Œue
, 
»que¡_hªdËr
, sock);

335 ià(
”r
)

336 
out
;

338 
”r
 = 
	`hash_®loc
(&
sock
->
ht_nÙ
, 
htsize_nÙ
);

339 ià(
”r
)

340 
out
;

342 
”r
 = 
	`hash_®loc
(&
sock
->
ht_sub
, 
htsize_sub
);

343 ià(
”r
)

344 
out
;

346 
sock
->
s
 = sip;

347 
sock
->
subh
 = subh;

348 
sock
->
¬g
 =‡rg;

350 
out
:

351 ià(
”r
)

352 
	`mem_d”ef
(
sock
);

354 *
sockp
 = 
sock
;

356  
”r
;

357 
	}
}

	@re-0.5.6/src/sipevent/msg.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_uri.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_msg.h
>

13 
	~<»_s.h
>

14 
	~<»_sev’t.h
>

17 
	$sev’t_ev’t_decode
(
sev’t_ev’t
 *
£
, cÚ¡ 
¶
 *pl)

19 
¶
 
·¿m
;

20 
”r
;

22 ià(!
£
 || !
¶
)

23  
EINVAL
;

25 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
, "[^; \t\r\n]+[ \t\r\n]*[^]*",

26 &
£
->
ev’t
, 
NULL
, &£->
·¿ms
);

27 ià(
”r
)

28  
EBADMSG
;

30 ià(!
	`msg_·¿m_decode
(&
£
->
·¿ms
, "id", &
·¿m
))

31 
£
->
id
 = 
·¿m
;

33 
£
->
id
 = 
¶_nuÎ
;

36 
	}
}

39 
	$sev’t_sub¡©e_decode
(
sev’t_sub¡©e
 *
ss
, cÚ¡ 
¶
 *pl)

41 
¶
 
¡©e
, 
·¿m
;

42 
”r
;

44 ià(!
ss
 || !
¶
)

45  
EINVAL
;

47 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
, "[a-z]+[ \t\r\n]*[^]*",

48 &
¡©e
, 
NULL
, &
ss
->
·¿ms
);

49 ià(
”r
)

50  
EBADMSG
;

52 ià(!
	`¶_¡rÿ£cmp
(&
¡©e
, "active"))

53 
ss
->
¡©e
 = 
SIPEVENT_ACTIVE
;

54 ià(!
	`¶_¡rÿ£cmp
(&
¡©e
, "pending"))

55 
ss
->
¡©e
 = 
SIPEVENT_PENDING
;

56 ià(!
	`¶_¡rÿ£cmp
(&
¡©e
, "terminated"))

57 
ss
->
¡©e
 = 
SIPEVENT_TERMINATED
;

59 
ss
->
¡©e
 = -1;

61 ià(!
	`msg_·¿m_decode
(&
ss
->
·¿ms
, "»asÚ", &
·¿m
)) {

63 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "deactivated"))

64 
ss
->
»asÚ
 = 
SIPEVENT_DEACTIVATED
;

65 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "probation"))

66 
ss
->
»asÚ
 = 
SIPEVENT_PROBATION
;

67 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "rejected"))

68 
ss
->
»asÚ
 = 
SIPEVENT_REJECTED
;

69 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "timeout"))

70 
ss
->
»asÚ
 = 
SIPEVENT_TIMEOUT
;

71 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "giveup"))

72 
ss
->
»asÚ
 = 
SIPEVENT_GIVEUP
;

73 ià(!
	`¶_¡rÿ£cmp
(&
·¿m
, "noresource"))

74 
ss
->
»asÚ
 = 
SIPEVENT_NORESOURCE
;

76 
ss
->
»asÚ
 = -1;

79 
ss
->
»asÚ
 = -1;

82 ià(!
	`msg_·¿m_decode
(&
ss
->
·¿ms
, "expœes", &
·¿m
))

83 
ss
->
expœes
 = 
·¿m
;

85 
ss
->
expœes
 = 
¶_nuÎ
;

87 ià(!
	`msg_·¿m_decode
(&
ss
->
·¿ms
, "»Œy-aá”", &
·¿m
))

88 
ss
->
»Œy_aá”
 = 
·¿m
;

90 
ss
->
»Œy_aá”
 = 
¶_nuÎ
;

93 
	}
}

96 cÚ¡ *
	$sev’t_sub¡©e_Çme
(
sev’t_sub¡
 
¡©e
)

98 
¡©e
) {

100 
SIPEVENT_ACTIVE
:  "active";

101 
SIPEVENT_PENDING
:  "pending";

102 
SIPEVENT_TERMINATED
:  "terminated";

105 
	}
}

108 cÚ¡ *
	$sev’t_»asÚ_Çme
(
sev’t_»asÚ
 
»asÚ
)

110 
»asÚ
) {

112 
SIPEVENT_DEACTIVATED
:  "deactivated";

113 
SIPEVENT_PROBATION
:  "probation";

114 
SIPEVENT_REJECTED
:  "rejected";

115 
SIPEVENT_TIMEOUT
:  "timeout";

116 
SIPEVENT_GIVEUP
:  "giveup";

117 
SIPEVENT_NORESOURCE
:  "noresource";

120 
	}
}

	@re-0.5.6/src/sipevent/notify.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_tmr.h
>

16 
	~<»_msg.h
>

17 
	~<»_s.h
>

18 
	~<»_sev’t.h
>

19 
	~"sev’t.h
"

22 
nÙify_»que¡
(
snÙ
 *
nÙ
, 
boŞ
 
»£t_ls
);

25 
	$š‹º®_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

26 *
¬g
)

28 ()
”r
;

29 ()
msg
;

30 ()
¬g
;

31 
	}
}

34 
boŞ
 
	$‹rmš©e
(
snÙ
 *
nÙ
, 
sev’t_»asÚ
 
»asÚ
)

36 
nÙ
->
‹rmš©ed
 = 
Œue
;

37 
nÙ
->
»asÚ
 =„eason;

38 
nÙ
->
şo£h
 = 
š‹º®_şo£_hªdËr
;

40 ià(
nÙ
->
»q
) {

41 
	`mem_»f
(
nÙ
);

42  
Œue
;

45 ià(
nÙ
->
subsüibed
 && !
	`nÙify_»que¡
ÒÙ, 
Œue
)) {

46 
	`mem_»f
(
nÙ
);

47  
Œue
;

50  
çl£
;

51 
	}
}

54 
	$de¡ruùÜ
(*
¬g
)

56 
snÙ
 *
nÙ
 = 
¬g
;

58 
	`tmr_ÿnûl
(&
nÙ
->
tmr
);

60 ià(!
nÙ
->
‹rmš©ed
) {

62 ià(
	`‹rmš©e
(
nÙ
, 
SIPEVENT_DEACTIVATED
))

66 
	`hash_uÆšk
(&
nÙ
->
he
);

67 
	`mem_d”ef
(
nÙ
->
»q
);

68 
	`mem_d”ef
(
nÙ
->
dlg
);

69 
	`mem_d”ef
(
nÙ
->
auth
);

70 
	`mem_d”ef
(
nÙ
->
mb
);

71 
	`mem_d”ef
(
nÙ
->
ev’t
);

72 
	`mem_d”ef
(
nÙ
->
id
);

73 
	`mem_d”ef
(
nÙ
->
cu£r
);

74 
	`mem_d”ef
(
nÙ
->
hdrs
);

75 
	`mem_d”ef
(
nÙ
->
ùy³
);

76 
	`mem_d”ef
(
nÙ
->
sock
);

77 
	`mem_d”ef
(
nÙ
->
s
);

78 
	}
}

81 
	$snÙ_‹rmš©e
(
snÙ
 *
nÙ
, 
”r
,

82 cÚ¡ 
s_msg
 *
msg
,

83 
sev’t_»asÚ
 
»asÚ
)

85 
snÙ_şo£_h
 *
şo£h
;

86 *
¬g
;

88 
şo£h
 = 
nÙ
->closeh;

89 
¬g
 = 
nÙ
->arg;

91 
	`tmr_ÿnûl
(&
nÙ
->
tmr
);

92 ()
	`‹rmš©e
(
nÙ
, 
»asÚ
);

94 
	`şo£h
(
”r
, 
msg
, 
¬g
);

95 
	}
}

98 
	$tmr_hªdËr
(*
¬g
)

100 
snÙ
 *
nÙ
 = 
¬g
;

102 ià(
nÙ
->
‹rmš©ed
)

105 
	`snÙ_‹rmš©e
(
nÙ
, 
ETIMEDOUT
, 
NULL
, 
SIPEVENT_TIMEOUT
);

106 
	}
}

109 
	$snÙ_»äesh
(
snÙ
 *
nÙ
, 
ušt32_t
 
expœes
)

111 
nÙ
->
expœes
 = 
	`mš
Óxpœes,‚Ù->
expœes_max
);

113 
	`tmr_¡¬t
(&
nÙ
->
tmr
,‚Ù->
expœes
 * 1000, 
tmr_hªdËr
,‚ot);

114 
	}
}

117 
	$»¥Ú£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

119 
snÙ
 *
nÙ
 = 
¬g
;

121 ià(
”r
) {

122 ià(
”r
 =ğ
ETIMEDOUT
)

123 
nÙ
->
subsüibed
 = 
çl£
;

124 
out
;

127 ià(
	`s_»que¡_loİs
(&
nÙ
->
ls
, 
msg
->
scode
)) {

128 
nÙ
->
subsüibed
 = 
çl£
;

129 
out
;

132 ià(
msg
->
scode
 < 200) {

135 ià(
msg
->
scode
 < 300) {

137 ()
	`s_dŸlog_upd©e
(
nÙ
->
dlg
, 
msg
);

140 
msg
->
scode
) {

144 
”r
 = 
	`s_auth_auth’tiÿ‹
(
nÙ
->
auth
, 
msg
);

145 ià(
”r
) {

146 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

150 
”r
 = 
	`nÙify_»que¡
(
nÙ
, 
çl£
);

151 ià(
”r
)

157 
nÙ
->
subsüibed
 = 
çl£
;

160 
out
:

161 ià(
nÙ
->
‹rm£Á
) {

162 
	`mem_d”ef
(
nÙ
);

164 ià(
nÙ
->
‹rmš©ed
) {

165 ià(!
nÙ
->
subsüibed
 || 
	`nÙify_»que¡
ÒÙ, 
Œue
))

166 
	`mem_d”ef
(
nÙ
);

168 ià(!
nÙ
->
subsüibed
) {

169 
	`snÙ_‹rmš©e
(
nÙ
, 
”r
, 
msg
, -1);

171 ià(
nÙ
->
nÙify_³ndšg
) {

172 ()
	`nÙify_»que¡
(
nÙ
, 
Œue
);

174 
	}
}

177 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

178 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

180 
s_cÚù
 
cÚù
;

181 
snÙ
 *
nÙ
 = 
¬g
;

182 ()
d¡
;

184 
	`s_cÚù_£t
(&
cÚù
, 
nÙ
->
cu£r
, 
¤c
, 

);

186  
	`mbuf_´štf
(
mb
, "%H", 
s_cÚù_´št
, &
cÚù
);

187 
	}
}

190 
	$´št_ev’t
(
»_´štf
 *
pf
, cÚ¡ 
snÙ
 *
nÙ
)

192 ià(
nÙ
->
id
)

193  
	`»_h´štf
(
pf
, "%s;id=%s", 
nÙ
->
ev’t
,‚Ù->
id
);

195  
	`»_h´štf
(
pf
, "%s", 
nÙ
->
ev’t
);

196 
	}
}

199 
	$´št_sub¡©e
(
»_´štf
 *
pf
, cÚ¡ 
snÙ
 *
nÙ
)

201 
”r
;

203 ià(
nÙ
->
‹rmš©ed
) {

205 
”r
 = 
	`»_h´štf
(
pf
, "terminated;reason=%s",

206 
	`sev’t_»asÚ_Çme
(
nÙ
->
»asÚ
));

208 ià(
nÙ
->
»Œy_aá”
)

209 
”r
 |ğ
	`»_h´štf
(
pf
, ";retry-after=%u",

210 
nÙ
->
»Œy_aá”
);

213 
ušt32_t
 
expœes
;

215 
expœes
 = (
ušt32_t
)(
	`tmr_g‘_expœe
(&
nÙ
->
tmr
) / 1000);

217 
”r
 = 
	`»_h´štf
(
pf
, "%s;expires=%u",

218 
	`sev’t_sub¡©e_Çme
(
nÙ
->
sub¡©e
),

219 
expœes
);

222  
”r
;

223 
	}
}

226 
	$´št_cÚ‹Á
(
»_´štf
 *
pf
, cÚ¡ 
snÙ
 *
nÙ
)

228 ià(!
nÙ
->
mb
)

229  
	`»_h´štf
(
pf
,

233  
	`»_h´štf
(
pf
,

238 
nÙ
->
ùy³
,

239 
	`mbuf_g‘_Ëá
(
nÙ
->
mb
),

240 
	`mbuf_buf
(
nÙ
->
mb
),

241 
	`mbuf_g‘_Ëá
(
nÙ
->
mb
));

242 
	}
}

245 
	$nÙify_»que¡
(
snÙ
 *
nÙ
, 
boŞ
 
»£t_ls
)

247 ià(
»£t_ls
)

248 
	`s_loİ¡©e_»£t
(&
nÙ
->
ls
);

250 ià(
nÙ
->
‹rmš©ed
)

251 
nÙ
->
‹rm£Á
 = 
Œue
;

253 
nÙ
->
nÙify_³ndšg
 = 
çl£
;

255  
	`s_d»que¡f
(&
nÙ
->
»q
,‚Ù->
s
, 
Œue
, "NOTIFY",

256 
nÙ
->
dlg
, 0,‚Ù->
auth
,

257 
£nd_hªdËr
, 
»¥Ú£_hªdËr
, 
nÙ
,

262 
´št_ev’t
, 
nÙ
,

263 
´št_sub¡©e
, 
nÙ
,

264 
nÙ
->
hdrs
,

265 
´št_cÚ‹Á
, 
nÙ
);

266 
	}
}

269 
	$snÙ_nÙify
(
snÙ
 *
nÙ
)

271 ià(
nÙ
->
expœes
 == 0) {

275 ià(
nÙ
->
»q
) {

276 
nÙ
->
nÙify_³ndšg
 = 
Œue
;

280  
	`nÙify_»que¡
(
nÙ
, 
Œue
);

281 
	}
}

284 
	$snÙ_»¶y
(
snÙ
 *
nÙ
, cÚ¡ 
s_msg
 *
msg
,

285 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
)

287 
s_cÚù
 
cÚù
;

288 
ušt32_t
 
expœes
;

290 
expœes
 = (
ušt32_t
)(
	`tmr_g‘_expœe
(&
nÙ
->
tmr
) / 1000);

292 
	`s_cÚù_£t
(&
cÚù
, 
nÙ
->
cu£r
, &
msg
->
d¡
, msg->

);

294  
	`s_Œ•lyf
(
NULL
, NULL, 
nÙ
->
s
, 
msg
, 
Œue
, 
scode
, 
»asÚ
,

299 
s_cÚù_´št
, &
cÚù
,

300 
expœes
);

301 
	}
}

304 
	$sev’t_acû±
(
snÙ
 **
nÙp
, 
sev’t_sock
 *
sock
,

305 cÚ¡ 
s_msg
 *
msg
, 
s_dŸlog
 *
dlg
,

306 cÚ¡ 
sev’t_ev’t
 *
ev’t
,

307 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
, 
ušt32_t
 
expœes_mš
,

308 
ušt32_t
 
expœes_dæ
, ušt32_ˆ
expœes_max
,

309 cÚ¡ *
cu£r
, cÚ¡ *
ùy³
,

310 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

311 
snÙ_şo£_h
 *
şo£h
, *
¬g
, cÚ¡ *
fmt
, ...)

313 
snÙ
 *
nÙ
;

314 
ušt32_t
 
expœes
;

315 
”r
;

317 ià(!
nÙp
 || !
sock
 || !
msg
 || !
scode
 || !
»asÚ
 || !
expœes_dæ
 ||

318 !
expœes_max
 || !
cu£r
 || !
ùy³
 || 
expœes_dæ
 < 
expœes_mš
)

319  
EINVAL
;

321 
nÙ
 = 
	`mem_z®loc
((*nÙ), 
de¡ruùÜ
);

322 ià(!
nÙ
)

323  
ENOMEM
;

325 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "REFER")) {

327 
”r
 = 
	`¡r_dup
(&
nÙ
->
ev’t
, "refer");

328 ià(
”r
)

329 
out
;

331 
”r
 = 
	`»_sd´štf
(&
nÙ
->
id
, "%u", 
msg
->
c£q
.
num
);

332 ià(
”r
)

333 
out
;

336 ià(!
ev’t
) {

337 
”r
 = 
EINVAL
;

338 
out
;

341 
”r
 = 
	`¶_¡rdup
(&
nÙ
->
ev’t
, &event->event);

342 ià(
”r
)

343 
out
;

345 ià(
	`¶_is£t
(&
ev’t
->
id
)) {

347 
”r
 = 
	`¶_¡rdup
(&
nÙ
->
id
, &
ev’t
->id);

348 ià(
”r
)

349 
out
;

353 ià(
dlg
) {

354 
nÙ
->
dlg
 = 
	`mem_»f
(dlg);

357 
”r
 = 
	`s_dŸlog_acû±
(&
nÙ
->
dlg
, 
msg
);

358 ià(
”r
)

359 
out
;

362 
	`hash_­³nd
(
sock
->
ht_nÙ
,

363 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
nÙ
->
dlg
)),

364 &
nÙ
->
he
,‚ot);

366 
”r
 = 
	`s_auth_®loc
(&
nÙ
->
auth
, 
authh
, 
¯rg
, 
¬ef
);

367 ià(
”r
)

368 
out
;

370 
”r
 = 
	`¡r_dup
(&
nÙ
->
cu£r
, cuser);

371 ià(
”r
)

372 
out
;

374 
”r
 = 
	`¡r_dup
(&
nÙ
->
ùy³
, ctype);

375 ià(
”r
)

376 
out
;

378 ià(
fmt
) {

379 
va_li¡
 
­
;

381 
	`va_¡¬t
(
­
, 
fmt
);

382 
”r
 = 
	`»_vsd´štf
(&
nÙ
->
hdrs
, 
fmt
, 
­
);

383 
	`va_’d
(
­
);

384 ià(
”r
)

385 
out
;

388 
nÙ
->
expœes_mš
 =ƒxpires_min;

389 
nÙ
->
expœes_dæ
 =ƒxpires_dfl;

390 
nÙ
->
expœes_max
 =ƒxpires_max;

391 
nÙ
->
sub¡©e
 = 
SIPEVENT_PENDING
;

392 
nÙ
->
sock
 = 
	`mem_»f
(sock);

393 
nÙ
->
s
 = 
	`mem_»f
(
sock
->sip);

394 
nÙ
->
şo£h
 = clo£h ? clo£h : 
š‹º®_şo£_hªdËr
;

395 
nÙ
->
¬g
 =‡rg;

397 ià(
	`¶_is£t
(&
msg
->
expœes
))

398 
expœes
 = 
	`¶_u32
(&
msg
->expires);

400 
expœes
 = 
nÙ
->
expœes_dæ
;

402 
	`snÙ_»äesh
(
nÙ
, 
expœes
);

404 
”r
 = 
	`snÙ_»¶y
(
nÙ
, 
msg
, 
scode
, 
»asÚ
);

405 ià(
”r
)

406 
out
;

408 
nÙ
->
subsüibed
 = 
Œue
;

410 
out
:

411 ià(
”r
)

412 
	`mem_d”ef
(
nÙ
);

414 *
nÙp
 = 
nÙ
;

416  
”r
;

417 
	}
}

420 
	$sev’t_nÙify
(
snÙ
 *
nÙ
, 
mbuf
 *
mb
,

421 
sev’t_sub¡
 
¡©e
, 
sev’t_»asÚ
 
»asÚ
,

422 
ušt32_t
 
»Œy_aá”
)

424 ià(!
nÙ
 ||‚Ù->
‹rmš©ed
)

425  
EINVAL
;

427 ià(
mb
 || 
¡©e
 !ğ
SIPEVENT_TERMINATED
) {

428 
	`mem_d”ef
(
nÙ
->
mb
);

429 
nÙ
->
mb
 = 
	`mem_»f
(mb);

432 
¡©e
) {

434 
SIPEVENT_ACTIVE
:

435 
SIPEVENT_PENDING
:

436 
nÙ
->
sub¡©e
 = 
¡©e
;

437  
	`snÙ_nÙify
(
nÙ
);

439 
SIPEVENT_TERMINATED
:

440 
	`tmr_ÿnûl
(&
nÙ
->
tmr
);

441 
nÙ
->
»Œy_aá”
 =„etry_after;

442 ()
	`‹rmš©e
(
nÙ
, 
»asÚ
);

446  
EINVAL
;

448 
	}
}

451 
	$sev’t_nÙifyf
(
snÙ
 *
nÙ
, 
mbuf
 **
mbp
,

452 
sev’t_sub¡
 
¡©e
, 
sev’t_»asÚ
 
»asÚ
,

453 
ušt32_t
 
»Œy_aá”
, cÚ¡ *
fmt
, ...)

455 
mbuf
 *
mb
;

456 
va_li¡
 
­
;

457 
”r
;

459 ià(!
nÙ
 ||‚Ù->
‹rmš©ed
 || !
fmt
)

460  
EINVAL
;

462 ià(
mbp
 && *mbp)

463  
	`sev’t_nÙify
(
nÙ
, *
mbp
, 
¡©e
, 
»asÚ
, 
»Œy_aá”
);

465 
mb
 = 
	`mbuf_®loc
(1024);

466 ià(!
mb
)

467  
ENOMEM
;

469 
	`va_¡¬t
(
­
, 
fmt
);

470 
”r
 = 
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

471 
	`va_’d
(
­
);

472 ià(
”r
)

473 
out
;

475 
mb
->
pos
 = 0;

477 
”r
 = 
	`sev’t_nÙify
(
nÙ
, 
mb
, 
¡©e
, 
»asÚ
, 
»Œy_aá”
);

478 ià(
”r
)

479 
out
;

481 
out
:

482 ià(
”r
 || !
mbp
)

483 
	`mem_d”ef
(
mb
);

485 *
mbp
 = 
mb
;

487  
”r
;

488 
	}
}

	@re-0.5.6/src/sipevent/sipevent.h

9 
	ssev’t_sock
 {

10 
s_l¢r
 *
	ml¢r
;

11 
hash
 *
	mht_nÙ
;

12 
hash
 *
	mht_sub
;

13 
s
 *
	ms
;

14 
s_msg_h
 *
	msubh
;

15 *
	m¬g
;

21 
	ssnÙ
 {

22 
Ë
 
	mhe
;

23 
s_loİ¡©e
 
	mls
;

24 
tmr
 
	mtmr
;

25 
sev’t_sock
 *
	msock
;

26 
s_»que¡
 *
	m»q
;

27 
s_dŸlog
 *
	mdlg
;

28 
s_auth
 *
	mauth
;

29 
s
 *
	ms
;

30 
mbuf
 *
	mmb
;

31 *
	mev’t
;

32 *
	mid
;

33 *
	mcu£r
;

34 *
	mhdrs
;

35 *
	mùy³
;

36 
snÙ_şo£_h
 *
	mşo£h
;

37 *
	m¬g
;

38 
ušt32_t
 
	mexpœes
;

39 
ušt32_t
 
	mexpœes_mš
;

40 
ušt32_t
 
	mexpœes_dæ
;

41 
ušt32_t
 
	mexpœes_max
;

42 
ušt32_t
 
	m»Œy_aá”
;

43 
sev’t_sub¡
 
	msub¡©e
;

44 
sev’t_»asÚ
 
	m»asÚ
;

45 
boŞ
 
	mnÙify_³ndšg
;

46 
boŞ
 
	msubsüibed
;

47 
boŞ
 
	m‹rmš©ed
;

48 
boŞ
 
	m‹rm£Á
;

51 
snÙ_»äesh
(
snÙ
 *
nÙ
, 
ušt32_t
 
expœes
);

52 
snÙ_nÙify
(
snÙ
 *
nÙ
);

53 
snÙ_»¶y
(
snÙ
 *
nÙ
, cÚ¡ 
s_msg
 *
msg
,

54 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
);

59 
	sssub
 {

60 
Ë
 
	mhe
;

61 
s_loİ¡©e
 
	mls
;

62 
tmr
 
	mtmr
;

63 
sev’t_sock
 *
	msock
;

64 
s_»que¡
 *
	m»q
;

65 
s_dŸlog
 *
	mdlg
;

66 
s_auth
 *
	mauth
;

67 
s
 *
	ms
;

68 *
	mev’t
;

69 *
	mid
;

70 *
	mcu£r
;

71 *
	mhdrs
;

72 *
	m»ãr_hdrs
;

73 
ssub_fÜk_h
 *
	mfÜkh
;

74 
ssub_nÙify_h
 *
	mnÙifyh
;

75 
ssub_şo£_h
 *
	mşo£h
;

76 *
	m¬g
;

77 
št32_t
 
	m»ãr_c£q
;

78 
ušt32_t
 
	mexpœes
;

79 
ušt32_t
 
	mçc
;

80 
boŞ
 
	msubsüibed
;

81 
boŞ
 
	m‹rmš©ed
;

82 
boŞ
 
	m‹rmcÚf
;

83 
boŞ
 
	m‹rmwa™
;

84 
boŞ
 
	m»ãr
;

87 
ssub
 *
ssub_fšd
(
sev’t_sock
 *
sock
,

88 cÚ¡ 
s_msg
 *
msg
,

89 cÚ¡ 
sev’t_ev’t
 *
evt
, 
boŞ
 
fuÎ
);

90 
ssub_»scheduË
(
ssub
 *
sub
, 
ušt64_t
 
wa™
);

91 
ssub_‹rmš©e
(
ssub
 *
sub
, 
”r
, cÚ¡ 
s_msg
 *
msg
,

92 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
);

	@re-0.5.6/src/sipevent/subscribe.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_tmr.h
>

16 
	~<»_msg.h
>

17 
	~<»_s.h
>

18 
	~<»_sev’t.h
>

19 
	~"sev’t.h
"

23 
	mDEFAULT_EXPIRES
 = 3600,

24 
	mRESUB_FAIL_WAIT
 = 60000,

25 
	mRESUB_FAILC_MAX
 = 7,

26 
	mNOTIFY_TIMEOUT
 = 10000,

30 
»que¡
(
ssub
 *
sub
, 
boŞ
 
»£t_ls
);

33 
	$š‹º®_nÙify_hªdËr
(
s
 *s, cÚ¡ 
s_msg
 *
msg
,

34 *
¬g
)

36 ()
¬g
;

38 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 200, "OK");

39 
	}
}

42 
	$š‹º®_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

43 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
,

44 *
¬g
)

46 ()
”r
;

47 ()
msg
;

48 ()
sub¡©e
;

49 ()
¬g
;

50 
	}
}

53 
boŞ
 
	$‹rmš©e
(
ssub
 *
sub
)

55 
sub
->
‹rmš©ed
 = 
Œue
;

56 
sub
->
fÜkh
 = 
NULL
;

57 
sub
->
nÙifyh
 = 
š‹º®_nÙify_hªdËr
;

58 
sub
->
şo£h
 = 
š‹º®_şo£_hªdËr
;

60 ià(
sub
->
‹rmwa™
) {

61 
	`mem_»f
(
sub
);

62  
Œue
;

65 
	`tmr_ÿnûl
(&
sub
->
tmr
);

67 ià(
sub
->
»q
) {

68 
	`mem_»f
(
sub
);

69  
Œue
;

72 ià(
sub
->
expœes
 && sub->
subsüibed
 && !
	`»que¡
(sub, 
Œue
)) {

73 
	`mem_»f
(
sub
);

74  
Œue
;

77  
çl£
;

78 
	}
}

81 
	$de¡ruùÜ
(*
¬g
)

83 
ssub
 *
sub
 = 
¬g
;

85 ià(!
sub
->
‹rmš©ed
) {

87 ià(
	`‹rmš©e
(
sub
))

91 
	`tmr_ÿnûl
(&
sub
->
tmr
);

92 
	`hash_uÆšk
(&
sub
->
he
);

93 
	`mem_d”ef
(
sub
->
»q
);

94 
	`mem_d”ef
(
sub
->
dlg
);

95 
	`mem_d”ef
(
sub
->
auth
);

96 
	`mem_d”ef
(
sub
->
ev’t
);

97 
	`mem_d”ef
(
sub
->
id
);

98 
	`mem_d”ef
(
sub
->
cu£r
);

99 
	`mem_d”ef
(
sub
->
hdrs
);

100 
	`mem_d”ef
(
sub
->
»ãr_hdrs
);

101 
	`mem_d”ef
(
sub
->
sock
);

102 
	`mem_d”ef
(
sub
->
s
);

103 
	}
}

106 
	$nÙify_timeout_hªdËr
(*
¬g
)

108 
ssub
 *
sub
 = 
¬g
;

110 
sub
->
‹rmwa™
 = 
çl£
;

112 ià(
sub
->
‹rmš©ed
)

113 
	`mem_d”ef
(
sub
);

115 
	`ssub_‹rmš©e
(
sub
, 
ETIMEDOUT
, 
NULL
, NULL);

116 
	}
}

119 
	$tmr_hªdËr
(*
¬g
)

121 
ssub
 *
sub
 = 
¬g
;

122 
”r
;

124 ià(
sub
->
»q
 || sub->
‹rmš©ed
)

127 
”r
 = 
	`»que¡
(
sub
, 
Œue
);

128 ià(
”r
) {

129 ià(++
sub
->
çc
 < 
RESUB_FAILC_MAX
) {

130 
	`ssub_»scheduË
(
sub
, 
RESUB_FAIL_WAIT
);

133 
	`ssub_‹rmš©e
(
sub
, 
”r
, 
NULL
, NULL);

136 
	}
}

139 
	$ssub_»scheduË
(
ssub
 *
sub
, 
ušt64_t
 
wa™
)

141 
	`tmr_¡¬t
(&
sub
->
tmr
, 
wa™
, 
tmr_hªdËr
, sub);

142 
	}
}

145 
	$ssub_‹rmš©e
(
ssub
 *
sub
, 
”r
, cÚ¡ 
s_msg
 *
msg
,

146 cÚ¡ 
sev’t_sub¡©e
 *
sub¡©e
)

148 
ssub_şo£_h
 *
şo£h
;

149 *
¬g
;

151 
şo£h
 = 
sub
->closeh;

152 
¬g
 = 
sub
->arg;

154 ()
	`‹rmš©e
(
sub
);

156 
	`şo£h
(
”r
, 
msg
, 
sub¡©e
, 
¬g
);

157 
	}
}

160 
	$»¥Ú£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

162 cÚ¡ 
s_hdr
 *
mšexp
;

163 
ssub
 *
sub
 = 
¬g
;

165 ià(
”r
 || 
	`s_»que¡_loİs
(&
sub
->
ls
, 
msg
->
scode
))

166 
out
;

168 ià(
msg
->
scode
 < 200) {

171 ià(
msg
->
scode
 < 300) {

173 
ušt32_t
 
wa™
;

175 ià(
sub
->
fÜkh
) {

177 
ssub
 *
fsub
;

179 
fsub
 = 
	`ssub_fšd
(
sub
->
sock
, 
msg
, 
NULL
, 
Œue
);

180 ià(!
fsub
) {

182 
”r
 = 
sub
->
	`fÜkh
(&
fsub
, sub, 
msg
, sub->
¬g
);

183 ià(
”r
)

187 ()
	`s_dŸlog_upd©e
(
fsub
->
dlg
, 
msg
);

190 
sub
 = 
fsub
;

192 ià(!
	`s_dŸlog_e¡ablished
(
sub
->
dlg
)) {

194 
”r
 = 
	`s_dŸlog_ü—‹
(
sub
->
dlg
, 
msg
);

195 ià(
”r
) {

196 
sub
->
subsüibed
 = 
çl£
;

197 
out
;

203 ià(!
	`s_dŸlog_cmp
(
sub
->
dlg
, 
msg
))

206 ()
	`s_dŸlog_upd©e
(
sub
->
dlg
, 
msg
);

209 ià(!
sub
->
‹rmcÚf
)

210 
sub
->
subsüibed
 = 
Œue
;

212 
sub
->
çc
 = 0;

214 ià(!
sub
->
expœes
 && !sub->
‹rmcÚf
) {

216 
	`tmr_¡¬t
(&
sub
->
tmr
, 
NOTIFY_TIMEOUT
,

217 
nÙify_timeout_hªdËr
, 
sub
);

218 
sub
->
‹rmwa™
 = 
Œue
;

222 ià(
sub
->
‹rmš©ed
)

223 
out
;

225 ià(
sub
->
»ãr
) {

226 
sub
->
»ãr
 = 
çl£
;

230 ià(
	`¶_is£t
(&
msg
->
expœes
))

231 
wa™
 = 
	`¶_u32
(&
msg
->
expœes
);

233 
wa™
 = 
sub
->
expœes
;

235 
	`ssub_»scheduË
(
sub
, 
wa™
 * 900);

239 ià(
sub
->
‹rmš©ed
 && !sub->
subsüibed
)

240 
out
;

242 
msg
->
scode
) {

246 
”r
 = 
	`s_auth_auth’tiÿ‹
(
sub
->
auth
, 
msg
);

247 ià(
”r
) {

248 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

252 
”r
 = 
	`»que¡
(
sub
, 
çl£
);

253 ià(
”r
)

259 
	`s_auth_»£t
(
sub
->
auth
);

263 
mšexp
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_MIN_EXPIRES
);

264 ià(!
mšexp
 || !
	`¶_u32
(&mšexp->
v®
è|| !
sub
->
expœes
)

267 
sub
->
expœes
 = 
	`¶_u32
(&
mšexp
->
v®
);

269 
”r
 = 
	`»que¡
(
sub
, 
çl£
);

270 ià(
”r
)

276 
sub
->
subsüibed
 = 
çl£
;

281 
out
:

282 
sub
->
»ãr
 = 
çl£
;

284 ià(
sub
->
‹rmš©ed
) {

286 ià(!
sub
->
expœes
 || !sub->
subsüibed
 || 
	`»que¡
(sub, 
Œue
))

287 
	`mem_d”ef
(
sub
);

290 ià(
sub
->
subsüibed
 && ++sub->
çc
 < 
RESUB_FAILC_MAX
)

291 
	`ssub_»scheduË
(
sub
, 
RESUB_FAIL_WAIT
);

293 
	`ssub_‹rmš©e
(
sub
, 
”r
, 
msg
, 
NULL
);

295 
	}
}

298 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

299 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

301 
s_cÚù
 
cÚù
;

302 
ssub
 *
sub
 = 
¬g
;

303 ()
d¡
;

305 
	`s_cÚù_£t
(&
cÚù
, 
sub
->
cu£r
, 
¤c
, 

);

307  
	`mbuf_´štf
(
mb
, "%H", 
s_cÚù_´št
, &
cÚù
);

308 
	}
}

311 
	$´št_ev’t
(
»_´štf
 *
pf
, cÚ¡ 
ssub
 *
sub
)

313 ià(
sub
->
id
)

314  
	`»_h´štf
(
pf
, "%s;id=%s", 
sub
->
ev’t
, sub->
id
);

316  
	`»_h´štf
(
pf
, "%s", 
sub
->
ev’t
);

317 
	}
}

320 
	$»que¡
(
ssub
 *
sub
, 
boŞ
 
»£t_ls
)

322 ià(
»£t_ls
)

323 
	`s_loİ¡©e_»£t
(&
sub
->
ls
);

325 ià(
sub
->
»ãr
) {

327 
sub
->
»ãr_c£q
 = 
	`s_dŸlog_l£q
(sub->
dlg
);

329  
	`s_d»que¡f
(&
sub
->
»q
, sub->
s
, 
Œue
, "REFER",

330 
sub
->
dlg
, 0, sub->
auth
,

331 
£nd_hªdËr
, 
»¥Ú£_hªdËr
, 
sub
,

335 
sub
->
»ãr_hdrs
);

338 ià(
sub
->
‹rmš©ed
)

339 
sub
->
expœes
 = 0;

341  
	`s_d»que¡f
(&
sub
->
»q
, sub->
s
, 
Œue
, "SUBSCRIBE",

342 
sub
->
dlg
, 0, sub->
auth
,

343 
£nd_hªdËr
, 
»¥Ú£_hªdËr
, 
sub
,

349 
´št_ev’t
, 
sub
,

350 
sub
->
expœes
,

351 
sub
->
hdrs
);

353 
	}
}

356 
	$ssub_®loc
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

357 
boŞ
 
»ãr
, 
s_dŸlog
 *
dlg
, cÚ¡ *
uri
,

358 cÚ¡ *
äom_Çme
, cÚ¡ *
äom_uri
,

359 cÚ¡ *
ev’t
, cÚ¡ *
id
, 
ušt32_t
 
expœes
,

360 cÚ¡ *
cu£r
,

361 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

362 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

363 
ssub_fÜk_h
 *
fÜkh
, 
ssub_nÙify_h
 *
nÙifyh
,

364 
ssub_şo£_h
 *
şo£h
, *
¬g
,

365 cÚ¡ *
fmt
, 
va_li¡
 
­
)

367 
ssub
 *
sub
;

368 
”r
;

370 ià(!
subp
 || !
sock
 || !
ev’t
 || !
cu£r
)

371  
EINVAL
;

373 ià(!
dlg
 && (!
uri
 || !
äom_uri
))

374  
EINVAL
;

376 
sub
 = 
	`mem_z®loc
((*sub), 
de¡ruùÜ
);

377 ià(!
sub
)

378  
ENOMEM
;

380 ià(
dlg
) {

381 
sub
->
dlg
 = 
	`mem_»f
(dlg);

384 
”r
 = 
	`s_dŸlog_®loc
(&
sub
->
dlg
, 
uri
, uri, 
äom_Çme
,

385 
äom_uri
, 
rou‹v
, 
rou‹c
);

386 ià(
”r
)

387 
out
;

390 
	`hash_­³nd
(
sock
->
ht_sub
,

391 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
sub
->
dlg
)),

392 &
sub
->
he
, sub);

394 
”r
 = 
	`s_auth_®loc
(&
sub
->
auth
, 
authh
, 
¯rg
, 
¬ef
);

395 ià(
”r
)

396 
out
;

398 
”r
 = 
	`¡r_dup
(&
sub
->
ev’t
,ƒvent);

399 ià(
”r
)

400 
out
;

402 ià(
id
) {

403 
”r
 = 
	`¡r_dup
(&
sub
->
id
, id);

404 ià(
”r
)

405 
out
;

408 
”r
 = 
	`¡r_dup
(&
sub
->
cu£r
, cuser);

409 ià(
”r
)

410 
out
;

412 ià(
fmt
) {

413 
”r
 = 
	`»_vsd´štf
(
»ãr
 ? &
sub
->
»ãr_hdrs
 : &sub->
hdrs
,

414 
fmt
, 
­
);

415 ià(
”r
)

416 
out
;

419 
sub
->
»ãr_c£q
 = -1;

420 
sub
->
»ãr
 =„efer;

421 
sub
->
sock
 = 
	`mem_»f
(sock);

422 
sub
->
s
 = 
	`mem_»f
(
sock
->sip);

423 
sub
->
expœes
 =ƒxpires;

424 
sub
->
fÜkh
 = forkh;

425 
sub
->
nÙifyh
 =‚Ùifyh ?‚Ùifyh : 
š‹º®_nÙify_hªdËr
;

426 
sub
->
şo£h
 = clo£h ? clo£h : 
š‹º®_şo£_hªdËr
;

427 
sub
->
¬g
 =‡rg;

429 
”r
 = 
	`»que¡
(
sub
, 
Œue
);

430 ià(
”r
)

431 
out
;

433 
out
:

434 ià(
”r
)

435 
	`mem_d”ef
(
sub
);

437 *
subp
 = 
sub
;

439  
”r
;

440 
	}
}

468 
	$sev’t_subsüibe
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

469 cÚ¡ *
uri
, cÚ¡ *
äom_Çme
,

470 cÚ¡ *
äom_uri
, cÚ¡ *
ev’t
, cÚ¡ *
id
,

471 
ušt32_t
 
expœes
, cÚ¡ *
cu£r
,

472 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

473 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

474 
ssub_fÜk_h
 *
fÜkh
, 
ssub_nÙify_h
 *
nÙifyh
,

475 
ssub_şo£_h
 *
şo£h
, *
¬g
,

476 cÚ¡ *
fmt
, ...)

478 
va_li¡
 
­
;

479 
”r
;

481 
	`va_¡¬t
(
­
, 
fmt
);

482 
”r
 = 
	`ssub_®loc
(
subp
, 
sock
, 
çl£
, 
NULL
, 
uri
, 
äom_Çme
, 
äom_uri
,

483 
ev’t
, 
id
, 
expœes
, 
cu£r
,

484 
rou‹v
, 
rou‹c
, 
authh
, 
¯rg
, 
¬ef
, 
fÜkh
, 
nÙifyh
,

485 
şo£h
, 
¬g
, 
fmt
, 
­
);

486 
	`va_’d
(
­
);

488  
”r
;

489 
	}
}

512 
	$sev’t_dsubsüibe
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

513 
s_dŸlog
 *
dlg
, cÚ¡ *
ev’t
,

514 cÚ¡ *
id
, 
ušt32_t
 
expœes
, cÚ¡ *
cu£r
,

515 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

516 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

517 *
¬g
, cÚ¡ *
fmt
, ...)

519 
va_li¡
 
­
;

520 
”r
;

522 
	`va_¡¬t
(
­
, 
fmt
);

523 
”r
 = 
	`ssub_®loc
(
subp
, 
sock
, 
çl£
, 
dlg
, 
NULL
, NULL, NULL,

524 
ev’t
, 
id
, 
expœes
, 
cu£r
,

525 
NULL
, 0, 
authh
, 
¯rg
, 
¬ef
, NULL, 
nÙifyh
,

526 
şo£h
, 
¬g
, 
fmt
, 
­
);

527 
	`va_’d
(
­
);

529  
”r
;

530 
	}
}

555 
	$sev’t_»ãr
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

556 cÚ¡ *
uri
, cÚ¡ *
äom_Çme
,

557 cÚ¡ *
äom_uri
, cÚ¡ *
cu£r
,

558 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

559 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

560 
ssub_fÜk_h
 *
fÜkh
, 
ssub_nÙify_h
 *
nÙifyh
,

561 
ssub_şo£_h
 *
şo£h
, *
¬g
,

562 cÚ¡ *
fmt
, ...)

564 
va_li¡
 
­
;

565 
”r
;

567 
	`va_¡¬t
(
­
, 
fmt
);

568 
”r
 = 
	`ssub_®loc
(
subp
, 
sock
, 
Œue
, 
NULL
, 
uri
, 
äom_Çme
, 
äom_uri
,

569 "»ãr", 
NULL
, 
DEFAULT_EXPIRES
, 
cu£r
,

570 
rou‹v
, 
rou‹c
, 
authh
, 
¯rg
, 
¬ef
, 
fÜkh
, 
nÙifyh
,

571 
şo£h
, 
¬g
, 
fmt
, 
­
);

572 
	`va_’d
(
­
);

574  
”r
;

575 
	}
}

595 
	$sev’t_d»ãr
(
ssub
 **
subp
, 
sev’t_sock
 *
sock
,

596 
s_dŸlog
 *
dlg
, cÚ¡ *
cu£r
,

597 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

598 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

599 *
¬g
, cÚ¡ *
fmt
, ...)

601 
va_li¡
 
­
;

602 
”r
;

604 
	`va_¡¬t
(
­
, 
fmt
);

605 
”r
 = 
	`ssub_®loc
(
subp
, 
sock
, 
Œue
, 
dlg
, 
NULL
, NULL, NULL,

606 "»ãr", 
NULL
, 
DEFAULT_EXPIRES
, 
cu£r
,

607 
NULL
, 0, 
authh
, 
¯rg
, 
¬ef
, NULL, 
nÙifyh
,

608 
şo£h
, 
¬g
, 
fmt
, 
­
);

609 
	`va_’d
(
­
);

611  
”r
;

612 
	}
}

615 
	$sev’t_fÜk
(
ssub
 **
subp
, ssub *
osub
,

616 cÚ¡ 
s_msg
 *
msg
,

617 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

618 
ssub_nÙify_h
 *
nÙifyh
, 
ssub_şo£_h
 *
şo£h
,

619 *
¬g
)

621 
ssub
 *
sub
;

622 
”r
;

624 ià(!
subp
 || !
osub
 || !
msg
)

625  
EINVAL
;

627 
sub
 = 
	`mem_z®loc
((*sub), 
de¡ruùÜ
);

628 ià(!
sub
)

629  
ENOMEM
;

631 
”r
 = 
	`s_dŸlog_fÜk
(&
sub
->
dlg
, 
osub
->dlg, 
msg
);

632 ià(
”r
)

633 
out
;

635 
	`hash_­³nd
(
osub
->
sock
->
ht_sub
,

636 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
sub
->
dlg
)),

637 &
sub
->
he
, sub);

639 
”r
 = 
	`s_auth_®loc
(&
sub
->
auth
, 
authh
, 
¯rg
, 
¬ef
);

640 ià(
”r
)

641 
out
;

643 
sub
->
ev’t
 = 
	`mem_»f
(
osub
->event);

644 
sub
->
id
 = 
	`mem_»f
(
osub
->id);

645 
sub
->
cu£r
 = 
	`mem_»f
(
osub
->cuser);

646 
sub
->
hdrs
 = 
	`mem_»f
(
osub
->hdrs);

647 
sub
->
»ãr
 = 
osub
->refer;

648 
sub
->
sock
 = 
	`mem_»f
(
osub
->sock);

649 
sub
->
s
 = 
	`mem_»f
(
osub
->sip);

650 
sub
->
expœes
 = 
osub
->expires;

651 
sub
->
fÜkh
 = 
NULL
;

652 
sub
->
nÙifyh
 =‚Ùifyh ?‚Ùifyh : 
š‹º®_nÙify_hªdËr
;

653 
sub
->
şo£h
 = clo£h ? clo£h : 
š‹º®_şo£_hªdËr
;

654 
sub
->
¬g
 =‡rg;

656 ià(!
sub
->
expœes
) {

657 
	`tmr_¡¬t
(&
sub
->
tmr
, 
NOTIFY_TIMEOUT
,

658 
nÙify_timeout_hªdËr
, 
sub
);

659 
sub
->
‹rmwa™
 = 
Œue
;

662 
out
:

663 ià(
”r
)

664 
	`mem_d”ef
(
sub
);

666 *
subp
 = 
sub
;

668  
”r
;

669 
	}
}

	@re-0.5.6/src/sipreg/reg.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_sys.h
>

15 
	~<»_tmr.h
>

16 
	~<»_msg.h
>

17 
	~<»_s.h
>

18 
	~<»_s»g.h
>

22 
	mDEFAULT_EXPIRES
 = 3600,

27 
	ss»g
 {

28 
s_loİ¡©e
 
	mls
;

29 
§
 
	mÏddr
;

30 
tmr
 
	mtmr
;

31 
s
 *
	ms
;

32 
s_k“·live
 *
	mka
;

33 
s_»que¡
 *
	m»q
;

34 
s_dŸlog
 *
	mdlg
;

35 
s_auth
 *
	mauth
;

36 
mbuf
 *
	mhdrs
;

37 *
	mcu£r
;

38 
s_»¥_h
 *
	m»¥h
;

39 *
	m¬g
;

40 
ušt32_t
 
	mexpœes
;

41 
ušt32_t
 
	mçc
;

42 
ušt32_t
 
	mwa™
;

43 
s_Œª¥
 
	m
;

44 
boŞ
 
	m»gi¡”ed
;

45 
boŞ
 
	m‹rmš©ed
;

46 *
	m·¿ms
;

47 
	m»gid
;

51 
»que¡
(
s»g
 *
»g
, 
boŞ
 
»£t_ls
);

54 
	$dummy_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

56 ()
”r
;

57 ()
msg
;

58 ()
¬g
;

59 
	}
}

62 
	$de¡ruùÜ
(*
¬g
)

64 
s»g
 *
»g
 = 
¬g
;

66 
	`tmr_ÿnûl
(&
»g
->
tmr
);

68 ià(!
»g
->
‹rmš©ed
) {

70 
»g
->
»¥h
 = 
dummy_hªdËr
;

71 
»g
->
‹rmš©ed
 = 
Œue
;

73 ià(
»g
->
»q
) {

74 
	`mem_»f
(
»g
);

78 ià(
»g
->
»gi¡”ed
 && !
	`»que¡
Ôeg, 
Œue
)) {

79 
	`mem_»f
(
»g
);

84 
	`mem_d”ef
(
»g
->
ka
);

85 
	`mem_d”ef
(
»g
->
dlg
);

86 
	`mem_d”ef
(
»g
->
auth
);

87 
	`mem_d”ef
(
»g
->
cu£r
);

88 
	`mem_d”ef
(
»g
->
s
);

89 
	`mem_d”ef
(
»g
->
hdrs
);

90 
	`mem_d”ef
(
»g
->
·¿ms
);

91 
	}
}

94 
ušt32_t
 
	$çwa™
(
ušt32_t
 
çc
)

96  
	`mš
(1800, (30 * (1<<mš(
çc
, 6)))è* (500 + 
	`¿nd_u16
() % 501);

97 
	}
}

100 
	$tmr_hªdËr
(*
¬g
)

102 
s»g
 *
»g
 = 
¬g
;

103 
”r
;

105 
”r
 = 
	`»que¡
(
»g
, 
Œue
);

106 ià(
”r
) {

107 
	`tmr_¡¬t
(&
»g
->
tmr
, 
	`çwa™
(++»g->
çc
), 
tmr_hªdËr
,„eg);

108 
»g
->
	`»¥h
(
”r
, 
NULL
,„eg->
¬g
);

110 
	}
}

113 
	$k“·live_hªdËr
(
”r
, *
¬g
)

115 
s»g
 *
»g
 = 
¬g
;

118 ià(
»g
->
»q
 ||„eg->
‹rmš©ed
)

121 
	`tmr_¡¬t
(&
»g
->
tmr
, 
	`çwa™
(++»g->
çc
), 
tmr_hªdËr
,„eg);

122 
»g
->
	`»¥h
(
”r
, 
NULL
,„eg->
¬g
);

123 
	}
}

126 
	$¡¬t_outbound
(
s»g
 *
»g
, cÚ¡ 
s_msg
 *
msg
)

128 cÚ¡ 
s_hdr
 *
æowtim”
;

130 ià(!
	`s_msg_hdr_has_v®ue
(
msg
, 
SIP_HDR_REQUIRE
, "outbound"))

133 
æowtim”
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_FLOW_TIMER
);

135 ()
	`s_k“·live_¡¬t
(&
»g
->
ka
,„eg->
s
, 
msg
,

136 
æowtim”
 ? 
	`¶_u32
(&æowtim”->
v®
) : 0,

137 
k“·live_hªdËr
, 
»g
);

138 
	}
}

141 
boŞ
 
	$cÚù_hªdËr
(cÚ¡ 
s_hdr
 *
hdr
,

142 cÚ¡ 
s_msg
 *
msg
, *
¬g
)

144 
s»g
 *
»g
 = 
¬g
;

145 
s_addr
 
c
;

146 
¶
 
pv®
;

147 
uri
[256];

149 ià(
	`s_addr_decode
(&
c
, &
hdr
->
v®
))

150  
çl£
;

152 ià(
	`»_¢´štf
(
uri
, (uri), "s:%s@%J%s", 
»g
->
cu£r
,

153 &
»g
->
Ïddr
, 
	`s_Œª¥_·¿m
Ôeg->

)) < 0)

154  
çl£
;

156 ià(
	`¶_¡rcmp
(&
c
.
auri
, 
uri
))

157  
çl£
;

159 ià(!
	`msg_·¿m_decode
(&
c
.
·¿ms
, "expœes", &
pv®
)) {

160 
»g
->
wa™
 = 
	`¶_u32
(&
pv®
);

162 ià(
	`¶_is£t
(&
msg
->
expœes
))

163 
»g
->
wa™
 = 
	`¶_u32
(&
msg
->
expœes
);

165 
»g
->
wa™
 = 
DEFAULT_EXPIRES
;

167  
Œue
;

168 
	}
}

171 
	$»¥Ú£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

173 cÚ¡ 
s_hdr
 *
mšexp
;

174 
s»g
 *
»g
 = 
¬g
;

176 
»g
->
wa™
 = 
	`çwa™
Ôeg->
çc
 + 1);

178 ià(
”r
 || 
	`s_»que¡_loİs
(&
»g
->
ls
, 
msg
->
scode
)) {

179 
»g
->
çc
++;

180 
out
;

183 ià(
msg
->
scode
 < 200) {

186 ià(
msg
->
scode
 < 300) {

187 
»g
->
»gi¡”ed
 = 
Œue
;

188 
»g
->
wa™
 =„eg->
expœes
;

189 
	`s_msg_hdr_­¶y
(
msg
, 
Œue
, 
SIP_HDR_CONTACT
, 
cÚù_hªdËr
,

190 
»g
);

191 
»g
->
wa™
 *= 900;

192 
»g
->
çc
 = 0;

194 ià(
»g
->
»gid
 > 0 && !»g->
‹rmš©ed
 && !»g->
ka
)

195 
	`¡¬t_outbound
(
»g
, 
msg
);

198 ià(
»g
->
‹rmš©ed
 && !»g->
»gi¡”ed
)

199 
out
;

201 
msg
->
scode
) {

205 
”r
 = 
	`s_auth_auth’tiÿ‹
(
»g
->
auth
, 
msg
);

206 ià(
”r
) {

207 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

211 
”r
 = 
	`»que¡
(
»g
, 
çl£
);

212 ià(
”r
)

218 
	`s_auth_»£t
(
»g
->
auth
);

222 
mšexp
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_MIN_EXPIRES
);

223 ià(!
mšexp
 || !
	`¶_u32
(&mšexp->
v®
è|| !
»g
->
expœes
)

226 
»g
->
expœes
 = 
	`¶_u32
(&
mšexp
->
v®
);

228 
”r
 = 
	`»que¡
(
»g
, 
çl£
);

229 ià(
”r
)

235 ++
»g
->
çc
;

238 
out
:

239 ià(!
»g
->
expœes
) {

240 
	`mem_d”ef
(
»g
);

242 ià(
»g
->
‹rmš©ed
) {

243 ià(!
»g
->
»gi¡”ed
 || 
	`»que¡
Ôeg, 
Œue
))

244 
	`mem_d”ef
(
»g
);

247 
	`tmr_¡¬t
(&
»g
->
tmr
,„eg->
wa™
, 
tmr_hªdËr
,„eg);

248 
»g
->
	`»¥h
(
”r
, 
msg
,„eg->
¬g
);

250 
	}
}

253 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

254 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

256 
s»g
 *
»g
 = 
¬g
;

257 
”r
;

259 ()
d¡
;

261 ià(
»g
->
expœes
 > 0) {

262 
»g
->
Ïddr
 = *
¤c
;

263 
»g
->

 =p;

266 
”r
 = 
	`mbuf_´štf
(
mb
, "Contact: <sip:%s@%J%s>;expires=%u%s%s",

267 
»g
->
cu£r
, &»g->
Ïddr
, 
	`s_Œª¥_·¿m
Ôeg->

),

268 
»g
->
expœes
,

269 
»g
->
·¿ms
 ? ";" : "",

270 
»g
->
·¿ms
 ?„eg->params : "");

272 ià(
»g
->
»gid
 > 0)

273 
”r
 |ğ
	`mbuf_´štf
(
mb
, ";»g-id=%d", 
»g
->
»gid
);

275 
”r
 |ğ
	`mbuf_´štf
(
mb
, "\r\n");

277  
”r
;

278 
	}
}

281 
	$»que¡
(
s»g
 *
»g
, 
boŞ
 
»£t_ls
)

283 ià(
»g
->
‹rmš©ed
)

284 
»g
->
expœes
 = 0;

286 ià(
»£t_ls
)

287 
	`s_loİ¡©e_»£t
(&
»g
->
ls
);

289  
	`s_d»que¡f
(&
»g
->
»q
,„eg->
s
, 
Œue
, "REGISTER",„eg->
dlg
,

290 0, 
»g
->
auth
, 
£nd_hªdËr
, 
»¥Ú£_hªdËr
,„eg,

295 
»g
->
»gid
 > 0

297 
»g
->
hdrs
 ? 
	`mbuf_buf
Ôeg->hdrsè: 
NULL
,

298 
»g
->
hdrs
 ? 
	`mbuf_g‘_Ëá
Ôeg->hdrsè: (
size_t
)0);

299 
	}
}

325 
	$s»g_»gi¡”
(
s»g
 **
»gp
, 
s
 *s, cÚ¡ *
»g_uri
,

326 cÚ¡ *
to_uri
, cÚ¡ *
äom_uri
, 
ušt32_t
 
expœes
,

327 cÚ¡ *
cu£r
, cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

328 
»gid
, 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

329 
s_»¥_h
 *
»¥h
, *
¬g
,

330 cÚ¡ *
·¿ms
, cÚ¡ *
fmt
, ...)

332 
s»g
 *
»g
;

333 
”r
;

335 ià(!
»gp
 || !
s
 || !
»g_uri
 || !
to_uri
 || !
äom_uri
 ||

336 !
expœes
 || !
cu£r
)

337  
EINVAL
;

339 
»g
 = 
	`mem_z®loc
((*»g), 
de¡ruùÜ
);

340 ià(!
»g
)

341  
ENOMEM
;

343 
”r
 = 
	`s_dŸlog_®loc
(&
»g
->
dlg
, 
»g_uri
, 
to_uri
, 
NULL
, 
äom_uri
,

344 
rou‹v
, 
rou‹c
);

345 ià(
”r
)

346 
out
;

348 
”r
 = 
	`s_auth_®loc
(&
»g
->
auth
, 
authh
, 
¯rg
, 
¬ef
);

349 ià(
”r
)

350 
out
;

352 
”r
 = 
	`¡r_dup
(&
»g
->
cu£r
, cuser);

353 ià(
·¿ms
)

354 
”r
 |ğ
	`¡r_dup
(&
»g
->
·¿ms
,…arams);

355 ià(
”r
)

356 
out
;

359 ià(
fmt
) {

360 
va_li¡
 
­
;

362 
»g
->
hdrs
 = 
	`mbuf_®loc
(256);

363 ià(!
»g
->
hdrs
) {

364 
”r
 = 
ENOMEM
;

365 
out
;

368 
	`va_¡¬t
(
­
, 
fmt
);

369 
”r
 = 
	`mbuf_v´štf
(
»g
->
hdrs
, 
fmt
, 
­
);

370 
»g
->
hdrs
->
pos
 = 0;

371 
	`va_’d
(
­
);

373 ià(
”r
)

374 
out
;

377 
»g
->
s
 = 
	`mem_»f
(sip);

378 
»g
->
expœes
 =ƒxpires;

379 
»g
->
»¥h
 =„e¥h ?„e¥h : 
dummy_hªdËr
;

380 
»g
->
¬g
 =‡rg;

381 
»g
->
»gid
 =„egid;

383 
”r
 = 
	`»que¡
(
»g
, 
Œue
);

384 ià(
”r
)

385 
out
;

387 
out
:

388 ià(
”r
)

389 
	`mem_d”ef
(
»g
);

391 *
»gp
 = 
»g
;

393  
”r
;

394 
	}
}

404 cÚ¡ 
§
 *
	$s»g_Ïddr
(cÚ¡ 
s»g
 *
»g
)

406  
»g
 ? &»g->
Ïddr
 : 
NULL
;

407 
	}
}

	@re-0.5.6/src/sipsess/accept.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$ÿnûl_hªdËr
(*
¬g
)

23 
s£ss
 *
£ss
 = 
¬g
;

25 ()
	`s_Œ•ly
(&
£ss
->
¡
, sess->
s
, sess->
msg
,

28 
£ss
->
³”‹rm
 = 
Œue
;

30 ià(
£ss
->
‹rmš©ed
)

33 
	`s£ss_‹rmš©e
(
£ss
, 
ECONNRESET
, 
NULL
);

34 
	}
}

62 
	$s£ss_acû±
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

63 cÚ¡ 
s_msg
 *
msg
, 
ušt16_t
 
scode
,

64 cÚ¡ *
»asÚ
, cÚ¡ *
cu£r
, cÚ¡ *
ùy³
,

65 
mbuf
 *
desc
,

66 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

67 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

68 
s£ss_e¡ab_h
 *
e¡abh
, 
s£ss_šfo_h
 *
šfoh
,

69 
s£ss_»ãr_h
 *
»ãrh
, 
s£ss_şo£_h
 *
şo£h
,

70 *
¬g
, cÚ¡ *
fmt
, ...)

72 
s£ss
 *
£ss
;

73 
va_li¡
 
­
;

74 
”r
;

76 ià(!
£s¥
 || !
sock
 || !
msg
 || 
scode
 < 101 || scode > 299 ||

77 !
cu£r
 || !
ùy³
)

78  
EINVAL
;

80 
”r
 = 
	`s£ss_®loc
(&
£ss
, 
sock
, 
cu£r
, 
ùy³
, 
NULL
, 
authh
, 
¯rg
, 
¬ef
,

81 
ofãrh
, 
ªsw”h
, 
NULL
, 
e¡abh
, 
šfoh
, 
»ãrh
,

82 
şo£h
, 
¬g
);

83 ià(
”r
)

84  
”r
;

86 
”r
 = 
	`s_dŸlog_acû±
(&
£ss
->
dlg
, 
msg
);

87 ià(
”r
)

88 
out
;

90 
	`hash_­³nd
(
sock
->
ht_£ss
,

91 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
£ss
->
dlg
)),

92 &
£ss
->
he
, sess);

94 
£ss
->
msg
 = 
	`mem_»f
((*)msg);

96 
”r
 = 
	`s_¡¿ns_®loc
(&
£ss
->
¡
, sess->
s
, 
msg
, 
ÿnûl_hªdËr
,

97 
£ss
);

98 ià(
”r
)

99 
out
;

101 
	`va_¡¬t
(
­
, 
fmt
);

103 ià(
scode
 >= 200)

104 
”r
 = 
	`s£ss_»¶y_2xx
(
£ss
, 
msg
, 
scode
, 
»asÚ
, 
desc
,

105 
fmt
, &
­
);

107 
s_cÚù
 
cÚù
;

109 
	`s_cÚù_£t
(&
cÚù
, 
£ss
->
cu£r
, &
msg
->
d¡
, msg->

);

111 
”r
 = 
	`s_Œ•lyf
(&
£ss
->
¡
, 
NULL
, sess->
s
,

112 
msg
, 
Œue
, 
scode
, 
»asÚ
,

119 
s_cÚù_´št
, &
cÚù
,

120 
fmt
, &
­
,

121 
desc
 ? "Content-Type: " : "",

122 
desc
 ? 
£ss
->
ùy³
 : "",

123 
desc
 ? "\r\n" : "",

124 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0,

125 
desc
 ? 
	`mbuf_buf
(descè: 
NULL
,

126 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0);

129 
	`va_’d
(
­
);

131 ià(
”r
)

132 
out
;

134 
out
:

135 ià(
”r
)

136 
	`mem_d”ef
(
£ss
);

138 *
£s¥
 = 
£ss
;

140  
”r
;

141 
	}
}

155 
	$s£ss_´og»ss
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

156 
mbuf
 *
desc
, cÚ¡ *
fmt
, ...)

158 
s_cÚù
 
cÚù
;

159 
va_li¡
 
­
;

160 
”r
;

162 ià(!
£ss
 || !£ss->
¡
 || !£ss->
msg
 || 
scode
 < 101 || scode > 199)

163  
EINVAL
;

165 
	`va_¡¬t
(
­
, 
fmt
);

167 
	`s_cÚù_£t
(&
cÚù
, 
£ss
->
cu£r
, &£ss->
msg
->
d¡
, sess->msg->

);

169 
”r
 = 
	`s_Œ•lyf
(&
£ss
->
¡
, 
NULL
, sess->
s
, sess->
msg
, 
Œue
,

170 
scode
, 
»asÚ
,

177 
s_cÚù_´št
, &
cÚù
,

178 
fmt
, &
­
,

179 
desc
 ? "Content-Type: " : "",

180 
desc
 ? 
£ss
->
ùy³
 : "",

181 
desc
 ? "\r\n" : "",

182 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0,

183 
desc
 ? 
	`mbuf_buf
(descè: 
NULL
,

184 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0);

186 
	`va_’d
(
­
);

188  
”r
;

189 
	}
}

203 
	$s£ss_ªsw”
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

204 
mbuf
 *
desc
, cÚ¡ *
fmt
, ...)

206 
va_li¡
 
­
;

207 
”r
;

209 ià(!
£ss
 || !£ss->
¡
 || !£ss->
msg
 || 
scode
 < 200 || scode > 299)

210  
EINVAL
;

212 
	`va_¡¬t
(
­
, 
fmt
);

213 
”r
 = 
	`s£ss_»¶y_2xx
(
£ss
, sess->
msg
, 
scode
, 
»asÚ
, 
desc
,

214 
fmt
, &
­
);

215 
	`va_’d
(
­
);

217  
”r
;

218 
	}
}

231 
	$s£ss_»jeù
(
s£ss
 *
£ss
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

232 cÚ¡ *
fmt
, ...)

234 
va_li¡
 
­
;

235 
”r
;

237 ià(!
£ss
 || !£ss->
¡
 || !£ss->
msg
 || 
scode
 < 300)

238  
EINVAL
;

240 
	`va_¡¬t
(
­
, 
fmt
);

241 
”r
 = 
	`s_Œ•lyf
(&
£ss
->
¡
, 
NULL
, sess->
s
, sess->
msg
, 
çl£
,

242 
scode
, 
»asÚ
, 
fmt
 ? "%v" : 
NULL
, fmt, &
­
);

243 
	`va_’d
(
­
);

245  
”r
;

246 
	}
}

	@re-0.5.6/src/sipsess/ack.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	ss£ss_ack
 {

22 
Ë
 
	mhe
;

23 
tmr
 
	mtmr
;

24 
§
 
	md¡
;

25 
s_»que¡
 *
	m»q
;

26 
s_dŸlog
 *
	mdlg
;

27 
mbuf
 *
	mmb
;

28 
s_Œª¥
 
	m
;

29 
ušt32_t
 
	mc£q
;

33 
	$de¡ruùÜ
(*
¬g
)

35 
s£ss_ack
 *
ack
 = 
¬g
;

37 
	`hash_uÆšk
(&
ack
->
he
);

38 
	`tmr_ÿnûl
(&
ack
->
tmr
);

39 
	`mem_d”ef
(
ack
->
»q
);

40 
	`mem_d”ef
(
ack
->
dlg
);

41 
	`mem_d”ef
(
ack
->
mb
);

42 
	}
}

45 
	$tmr_hªdËr
(*
¬g
)

47 
s£ss_ack
 *
ack
 = 
¬g
;

49 
	`mem_d”ef
(
ack
);

50 
	}
}

53 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

54 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

56 
s£ss_ack
 *
ack
 = 
¬g
;

57 ()
¤c
;

59 
	`mem_d”ef
(
ack
->
mb
);

60 
ack
->
mb
 = 
	`mem_»f
(mb);

61 
ack
->
d¡
 = *dst;

62 
ack
->

 =p;

64 
	`tmr_¡¬t
(&
ack
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
,‡ck);

67 
	}
}

70 
	$»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

72 
s£ss_ack
 *
ack
 = 
¬g
;

73 ()
”r
;

74 ()
msg
;

76 
	`mem_d”ef
(
ack
);

77 
	}
}

80 
	$s£ss_ack
(
s£ss_sock
 *
sock
, 
s_dŸlog
 *
dlg
,

81 
ušt32_t
 
c£q
, 
s_auth
 *
auth
,

82 cÚ¡ *
ùy³
, 
mbuf
 *
desc
)

84 
s£ss_ack
 *
ack
;

85 
”r
;

87 
ack
 = 
	`mem_z®loc
((*ack), 
de¡ruùÜ
);

88 ià(!
ack
)

89  
ENOMEM
;

91 
	`hash_­³nd
(
sock
->
ht_ack
,

92 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
dlg
)),

93 &
ack
->
he
,‡ck);

95 
ack
->
dlg
 = 
	`mem_»f
(dlg);

96 
ack
->
c£q
 = cseq;

98 
”r
 = 
	`s_d»que¡f
(&
ack
->
»q
, 
sock
->
s
, 
çl£
, "ACK", 
dlg
, 
c£q
,

99 
auth
, 
£nd_hªdËr
, 
»¥_hªdËr
, 
ack
,

104 
desc
 ? "Content-Type: " : "",

105 
desc
 ? 
ùy³
 : "",

106 
desc
 ? "\r\n" : "",

107 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0,

108 
desc
 ? 
	`mbuf_buf
(descè: 
NULL
,

109 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0);

110 ià(
”r
)

111 
out
;

113 
out
:

114 ià(
”r
)

115 
	`mem_d”ef
(
ack
);

117  
”r
;

118 
	}
}

121 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

123 
s£ss_ack
 *
ack
 = 
Ë
->
d©a
;

124 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

126 ià(!
	`s_dŸlog_cmp
(
ack
->
dlg
, 
msg
))

127  
çl£
;

129 ià(
ack
->
c£q
 !ğ
msg
->c£q.
num
)

130  
çl£
;

132  
Œue
;

133 
	}
}

136 
	$s£ss_ack_agaš
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
)

138 
s£ss_ack
 *
ack
;

140 
ack
 = 
	`li¡_Ëd©a
(
	`hash_lookup
(
sock
->
ht_ack
,

141 
	`hash_jß©_¶
(&
msg
->
ÿÎid
),

142 
cmp_hªdËr
, (*)
msg
));

143 ià(!
ack
)

144  
ENOENT
;

146  
	`s_£nd
(
sock
->
s
, 
NULL
, 
ack
->

, &ack->
d¡
,‡ck->
mb
);

147 
	}
}

	@re-0.5.6/src/sipsess/close.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$bye_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

23 
s£ss
 *
£ss
 = 
¬g
;

25 ià(
”r
 || 
	`s_»que¡_loİs
(&
£ss
->
ls
, 
msg
->
scode
))

26 
out
;

28 ià(
msg
->
scode
 < 200) {

31 ià(
msg
->
scode
 < 300) {

35 ià(
£ss
->
³”‹rm
)

36 
out
;

38 
msg
->
scode
) {

42 
”r
 = 
	`s_auth_auth’tiÿ‹
(
£ss
->
auth
, 
msg
);

43 ià(
”r
)

46 
”r
 = 
	`s£ss_bye
(
£ss
, 
çl£
);

47 ià(
”r
)

54 
out
:

55 
	`mem_d”ef
(
£ss
);

56 
	}
}

59 
	$s£ss_bye
(
s£ss
 *
£ss
, 
boŞ
 
»£t_ls
)

61 ià(
£ss
->
»q
)

62  
EPROTO
;

64 ià(
»£t_ls
)

65 
	`s_loİ¡©e_»£t
(&
£ss
->
ls
);

67  
	`s_d»que¡f
(&
£ss
->
»q
, sess->
s
, 
Œue
, "BYE",

68 
£ss
->
dlg
, 0, sess->
auth
,

69 
NULL
, 
bye_»¥_hªdËr
, 
£ss
,

73 
£ss
->
şo£_hdrs
);

74 
	}
}

	@re-0.5.6/src/sipsess/connect.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_fmt.h
>

14 
	~<»_uri.h
>

15 
	~<»_tmr.h
>

16 
	~<»_msg.h
>

17 
	~<»_s.h
>

18 
	~<»_s£ss.h
>

19 
	~"s£ss.h
"

22 
šv™e
(
s£ss
 *
£ss
);

25 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

26 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

28 
s_cÚù
 
cÚù
;

29 
s£ss
 *
£ss
 = 
¬g
;

30 ()
d¡
;

32 
	`s_cÚù_£t
(&
cÚù
, 
£ss
->
cu£r
, 
¤c
, 

);

34  
	`mbuf_´štf
(
mb
, "%H", 
s_cÚù_´št
, &
cÚù
);

35 
	}
}

38 
	$šv™e_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

40 
s£ss
 *
£ss
 = 
¬g
;

41 
mbuf
 *
desc
 = 
NULL
;

43 ià(
”r
 || 
	`s_»que¡_loİs
(&
£ss
->
ls
, 
msg
->
scode
))

44 
out
;

46 ià(
msg
->
scode
 < 200) {

47 
£ss
->
	`´ogrh
(
msg
, sess->
¬g
);

50 ià(
msg
->
scode
 < 300) {

52 
£ss
->
hdrs
 = 
	`mem_d”ef
(sess->hdrs);

54 
”r
 = 
	`s_dŸlog_ü—‹
(
£ss
->
dlg
, 
msg
);

55 ià(
”r
)

56 
out
;

58 ià(
£ss
->
£Á_ofãr
)

59 
”r
 = 
£ss
->
	`ªsw”h
(
msg
, sess->
¬g
);

61 
£ss
->
modify_³ndšg
 = 
çl£
;

62 
”r
 = 
£ss
->
	`ofãrh
(&
desc
, 
msg
, sess->
¬g
);

65 
”r
 |ğ
	`s£ss_ack
(
£ss
->
sock
, sess->
dlg
, 
msg
->
c£q
.
num
,

66 
£ss
->
auth
, sess->
ùy³
, 
desc
);

68 
£ss
->
e¡ablished
 = 
Œue
;

69 
	`mem_d”ef
(
desc
);

71 ià(
”r
 || 
£ss
->
‹rmš©ed
)

72 
out
;

74 ià(
£ss
->
modify_³ndšg
)

75 ()
	`s£ss_»šv™e
(
£ss
, 
Œue
);

77 
£ss
->
desc
 = 
	`mem_d”ef
(sess->desc);

79 
£ss
->
	`e¡abh
(
msg
, sess->
¬g
);

82 ià(
msg
->
scode
 < 400) {

86 ià(
£ss
->
‹rmš©ed
)

87 
out
;

89 
”r
 = 
	`s_dŸlog_upd©e
(
£ss
->
dlg
, 
msg
);

90 ià(
”r
)

91 
out
;

93 
”r
 = 
	`šv™e
(
£ss
);

94 ià(
”r
)

95 
out
;

100 ià(
£ss
->
‹rmš©ed
)

101 
out
;

103 
msg
->
scode
) {

107 
”r
 = 
	`s_auth_auth’tiÿ‹
(
£ss
->
auth
, 
msg
);

108 ià(
”r
) {

109 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

113 
”r
 = 
	`šv™e
(
£ss
);

114 ià(
”r
)

121 
out
:

122 ià(!
£ss
->
‹rmš©ed
)

123 
	`s£ss_‹rmš©e
(
£ss
, 
”r
, 
msg
);

125 
	`mem_d”ef
(
£ss
);

126 
	}
}

129 
	$šv™e
(
s£ss
 *
£ss
)

131 
£ss
->
£Á_ofãr
 = sess->
desc
 ? 
Œue
 : 
çl£
;

132 
£ss
->
modify_³ndšg
 = 
çl£
;

134  
	`s_d»que¡f
(&
£ss
->
»q
, sess->
s
, 
Œue
, "INVITE",

135 
£ss
->
dlg
, 0, sess->
auth
,

136 
£nd_hªdËr
, 
šv™e_»¥_hªdËr
, 
£ss
,

142 
£ss
->
hdrs
 ? 
	`mbuf_buf
(£ss->hdrsè: 
NULL
,

143 
£ss
->
hdrs
 ? 
	`mbuf_g‘_Ëá
(£ss->hdrsè:(
size_t
)0,

144 
£ss
->
desc
 ? "Content-Type: " : "",

145 
£ss
->
desc
 ? sess->
ùy³
 : "",

146 
£ss
->
desc
 ? "\r\n" : "",

147 
£ss
->
desc
 ? 
	`mbuf_g‘_Ëá
(£ss->descè:(
size_t
)0,

148 
£ss
->
desc
 ? 
	`mbuf_buf
(£ss->descè: 
NULL
,

149 
£ss
->
desc
 ? 
	`mbuf_g‘_Ëá
(£ss->desc):(
size_t
)0);

150 
	}
}

181 
	$s£ss_cÚÃù
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

182 cÚ¡ *
to_uri
, cÚ¡ *
äom_Çme
,

183 cÚ¡ *
äom_uri
, cÚ¡ *
cu£r
,

184 cÚ¡ *
rou‹v
[], 
ušt32_t
 
rou‹c
,

185 cÚ¡ *
ùy³
, 
mbuf
 *
desc
,

186 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

187 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

188 
s£ss_´ogr_h
 *
´ogrh
, 
s£ss_e¡ab_h
 *
e¡abh
,

189 
s£ss_šfo_h
 *
šfoh
, 
s£ss_»ãr_h
 *
»ãrh
,

190 
s£ss_şo£_h
 *
şo£h
, *
¬g
, cÚ¡ *
fmt
, ...)

192 
s£ss
 *
£ss
;

193 
”r
;

195 ià(!
£s¥
 || !
sock
 || !
to_uri
 || !
äom_uri
 || !
cu£r
 || !
ùy³
)

196  
EINVAL
;

198 
”r
 = 
	`s£ss_®loc
(&
£ss
, 
sock
, 
cu£r
, 
ùy³
, 
desc
, 
authh
, 
¯rg
, 
¬ef
,

199 
ofãrh
, 
ªsw”h
, 
´ogrh
, 
e¡abh
, 
šfoh
, 
»ãrh
,

200 
şo£h
, 
¬g
);

201 ià(
”r
)

202  
”r
;

205 ià(
fmt
) {

206 
va_li¡
 
­
;

208 
£ss
->
hdrs
 = 
	`mbuf_®loc
(256);

209 ià(!
£ss
->
hdrs
) {

210 
”r
 = 
ENOMEM
;

211 
out
;

214 
	`va_¡¬t
(
­
, 
fmt
);

215 
”r
 = 
	`mbuf_v´štf
(
£ss
->
hdrs
, 
fmt
, 
­
);

216 
£ss
->
hdrs
->
pos
 = 0;

217 
	`va_’d
(
­
);

219 ià(
”r
)

220 
out
;

223 
£ss
->
owÃr
 = 
Œue
;

225 
”r
 = 
	`s_dŸlog_®loc
(&
£ss
->
dlg
, 
to_uri
,o_uri, 
äom_Çme
,

226 
äom_uri
, 
rou‹v
, 
rou‹c
);

227 ià(
”r
)

228 
out
;

230 
	`hash_­³nd
(
sock
->
ht_£ss
,

231 
	`hash_jß©_¡r
(
	`s_dŸlog_ÿÎid
(
£ss
->
dlg
)),

232 &
£ss
->
he
, sess);

234 
”r
 = 
	`šv™e
(
£ss
);

235 ià(
”r
)

236 
out
;

238 
out
:

239 ià(
”r
)

240 
	`mem_d”ef
(
£ss
);

242 *
£s¥
 = 
£ss
;

244  
”r
;

245 
	}
}

	@re-0.5.6/src/sipsess/info.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
šfo_»que¡
(
s£ss_»que¡
 *
»q
);

24 
	$šfo_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
, *
¬g
)

26 
s£ss_»que¡
 *
»q
 = 
¬g
;

28 ià(
”r
 || 
	`s_»que¡_loİs
(&
»q
->
ls
, 
msg
->
scode
))

29 
out
;

31 ià(
msg
->
scode
 < 200) {

34 ià(
msg
->
scode
 < 300) {

38 ià(
»q
->
£ss
->
‹rmš©ed
)

39 
out
;

41 
msg
->
scode
) {

45 
”r
 = 
	`s_auth_auth’tiÿ‹
(
»q
->
£ss
->
auth
, 
msg
);

46 ià(
”r
) {

47 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

51 
”r
 = 
	`šfo_»que¡
(
»q
);

52 ià(
”r
)

59 
	`s£ss_‹rmš©e
(
»q
->
£ss
, 0, 
msg
);

64 
out
:

65 ià(!
»q
->
£ss
->
‹rmš©ed
) {

66 ià(
”r
 =ğ
ETIMEDOUT
)

67 
	`s£ss_‹rmš©e
(
»q
->
£ss
, 
”r
, 
NULL
);

69 
»q
->
	`»¥h
(
”r
, 
msg
,„eq->
¬g
);

72 
	`mem_d”ef
(
»q
);

73 
	}
}

76 
	$šfo_»que¡
(
s£ss_»que¡
 *
»q
)

78  
	`s_d»que¡f
(&
»q
->»q,„eq->
£ss
->
s
, 
Œue
, "INFO",

79 
»q
->
£ss
->
dlg
, 0,„eq->£ss->
auth
,

80 
NULL
, 
šfo_»¥_hªdËr
, 
»q
,

85 
»q
->
ùy³
,

86 
	`mbuf_g‘_Ëá
(
»q
->
body
),

87 
	`mbuf_buf
(
»q
->
body
), 
	`mbuf_g‘_Ëá
(req->body));

88 
	}
}

102 
	$s£ss_šfo
(
s£ss
 *
£ss
, cÚ¡ *
ùy³
, 
mbuf
 *
body
,

103 
s_»¥_h
 *
»¥h
, *
¬g
)

105 
s£ss_»que¡
 *
»q
;

106 
”r
;

108 ià(!
£ss
 || sess->
‹rmš©ed
 || !
ùy³
 || !
body
)

109  
EINVAL
;

111 ià(!
	`s_dŸlog_e¡ablished
(
£ss
->
dlg
))

112  
ENOTCONN
;

114 
”r
 = 
	`s£ss_»que¡_®loc
(&
»q
, 
£ss
, 
ùy³
, 
body
, 
»¥h
, 
¬g
);

115 ià(
”r
)

116  
”r
;

118 
”r
 = 
	`šfo_»que¡
(
»q
);

119 ià(
”r
)

120 
	`mem_d”ef
(
»q
);

122  
”r
;

123 
	}
}

	@re-0.5.6/src/sipsess/listen.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$de¡ruùÜ
(*
¬g
)

23 
s£ss_sock
 *
sock
 = 
¬g
;

25 
	`mem_d”ef
(
sock
->
l¢r_»¥
);

26 
	`mem_d”ef
(
sock
->
l¢r_»q
);

27 
	`hash_æush
(
sock
->
ht_£ss
);

28 
	`mem_d”ef
(
sock
->
ht_£ss
);

29 
	`hash_æush
(
sock
->
ht_ack
);

30 
	`mem_d”ef
(
sock
->
ht_ack
);

31 
	}
}

34 
	$š‹º®_cÚÃù_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

36 
s£ss_sock
 *
sock
 = 
¬g
;

38 ()
	`s_Œ•ly
(
NULL
, 
sock
->
s
, 
msg
, 486, "Busy Here");

39 
	}
}

42 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

44 
s£ss
 *
£ss
 = 
Ë
->
d©a
;

45 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

47  
	`s_dŸlog_cmp
(
£ss
->
dlg
, 
msg
);

48 
	}
}

51 
s£ss
 *
	$s£ss_fšd
(
s£ss_sock
 *
sock
,

52 cÚ¡ 
s_msg
 *
msg
)

54  
	`li¡_Ëd©a
(
	`hash_lookup
(
sock
->
ht_£ss
,

55 
	`hash_jß©_¶
(&
msg
->
ÿÎid
),

56 
cmp_hªdËr
, (*)
msg
));

57 
	}
}

60 
	$šfo_hªdËr
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
)

62 
s
 *s = 
sock
->sip;

63 
s£ss
 *
£ss
;

65 
£ss
 = 
	`s£ss_fšd
(
sock
, 
msg
);

66 ià(!
£ss
 || sess->
‹rmš©ed
) {

67 ()
	`s_»¶y
(
s
, 
msg
, 481, "Call Does Not Exist");

71 ià(!
	`s_dŸlog_r£q_v®id
(
£ss
->
dlg
, 
msg
)) {

72 ()
	`s_»¶y
(
s
, 
msg
, 500, "Server Internal Error");

76 ià(!
£ss
->
šfoh
) {

77 ()
	`s_»¶y
(
s
, 
msg
, 501, "Not Implemented");

81 
£ss
->
	`šfoh
(
s
, 
msg
, sess->
¬g
);

82 
	}
}

85 
	$»ãr_hªdËr
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
)

87 
s
 *s = 
sock
->sip;

88 
s£ss
 *
£ss
;

90 
£ss
 = 
	`s£ss_fšd
(
sock
, 
msg
);

91 ià(!
£ss
 || sess->
‹rmš©ed
) {

92 ()
	`s_»¶y
(
s
, 
msg
, 481, "Call Does Not Exist");

96 ià(!
	`s_dŸlog_r£q_v®id
(
£ss
->
dlg
, 
msg
)) {

97 ()
	`s_»¶y
(
s
, 
msg
, 500, "Server Internal Error");

101 ià(!
£ss
->
»ãrh
) {

102 ()
	`s_»¶y
(
s
, 
msg
, 501, "Not Implemented");

106 
£ss
->
	`»ãrh
(
s
, 
msg
, sess->
¬g
);

107 
	}
}

110 
	$bye_hªdËr
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
)

112 
s
 *s = 
sock
->sip;

113 
s£ss
 *
£ss
;

115 
£ss
 = 
	`s£ss_fšd
(
sock
, 
msg
);

116 ià(!
£ss
) {

117 ()
	`s_»¶y
(
s
, 
msg
, 481, "Call Does Not Exist");

121 ià(!
	`s_dŸlog_r£q_v®id
(
£ss
->
dlg
, 
msg
)) {

122 ()
	`s_»¶y
(
s
, 
msg
, 500, "Server Internal Error");

126 ()
	`s_Œ•lyf
(
NULL
, NULL, 
s
, 
msg
, 
çl£
, 200, "OK",

130 
£ss
->
şo£_hdrs
);

132 
£ss
->
³”‹rm
 = 
Œue
;

134 ià(
£ss
->
‹rmš©ed
)

137 ià(
£ss
->
¡
) {

138 ()
	`s_Œ•ly
(&
£ss
->
¡
, sess->
s
, sess->
msg
,

142 
	`s£ss_‹rmš©e
(
£ss
, 
ECONNRESET
, 
NULL
);

143 
	}
}

146 
	$ack_hªdËr
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
)

148 
s£ss
 *
£ss
;

149 
boŞ
 
awa™šg_ªsw”
;

150 
”r
 = 0;

152 
£ss
 = 
	`s£ss_fšd
(
sock
, 
msg
);

153 ià(!
£ss
)

156 ià(
	`s£ss_»¶y_ack
(
£ss
, 
msg
, &
awa™šg_ªsw”
))

159 ià(
£ss
->
‹rmš©ed
) {

160 ià(!
£ss
->
»¶yl
.
h—d
) {

161 
£ss
->
e¡ablished
 = 
Œue
;

162 
	`mem_d”ef
(
£ss
);

167 ià(
awa™šg_ªsw”
) {

168 
£ss
->
awa™šg_ªsw”
 = 
çl£
;

169 
”r
 = 
£ss
->
	`ªsw”h
(
msg
, sess->
¬g
);

172 ià(
£ss
->
modify_³ndšg
 && !£ss->
»¶yl
.
h—d
)

173 ()
	`s£ss_»šv™e
(
£ss
, 
Œue
);

175 ià(
£ss
->
e¡ablished
)

178 
£ss
->
msg
 = 
	`mem_d”ef
((*)sess->msg);

179 
£ss
->
e¡ablished
 = 
Œue
;

181 ià(
”r
)

182 
	`s£ss_‹rmš©e
(
£ss
, 
”r
, 
NULL
);

184 
£ss
->
	`e¡abh
(
msg
, sess->
¬g
);

185 
	}
}

188 
	$»šv™e_hªdËr
(
s£ss_sock
 *
sock
,

189 cÚ¡ 
s_msg
 *
msg
)

191 
s
 *s = 
sock
->sip;

192 
s£ss
 *
£ss
;

193 
mbuf
 *
desc
;

194 
m
[256];

195 
”r
;

197 
£ss
 = 
	`s£ss_fšd
(
sock
, 
msg
);

198 ià(!
£ss
 || sess->
‹rmš©ed
) {

199 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 481, "Call Does Not Exist");

203 ià(!
	`s_dŸlog_r£q_v®id
(
£ss
->
dlg
, 
msg
)) {

204 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 500, "Server Internal Error");

208 ià(
£ss
->
¡
 || sess->
awa™šg_ªsw”
) {

209 ()
	`s_Œ•lyf
(
NULL
, NULL, 
s
, 
msg
, 
çl£
,

217 ià(
£ss
->
»q
) {

218 ()
	`s_Œ•ly
(
NULL
, 
s
, 
msg
, 491, "Request Pending");

222 
”r
 = 
£ss
->
	`ofãrh
(&
desc
, 
msg
, sess->
¬g
);

223 ià(
”r
) {

224 ()
	`s_»¶y
(
s
, 
msg
, 488, 
	`¡r_”rÜ
(
”r
, 
m
, (m)));

228 ()
	`s_dŸlog_upd©e
(
£ss
->
dlg
, 
msg
);

229 ()
	`s£ss_»¶y_2xx
(
£ss
, 
msg
, 200, "OK", 
desc
,

230 
NULL
, NULL);

234 
£ss
->
desc
 = 
	`mem_d”ef
(sess->desc);

235 
£ss
->
modify_³ndšg
 = 
çl£
;

236 
	`tmr_ÿnûl
(&
£ss
->
tmr
);

237 
	`mem_d”ef
(
desc
);

238 
	}
}

241 
	$šv™e_hªdËr
(
s£ss_sock
 *
sock
,

242 cÚ¡ 
s_msg
 *
msg
)

244 
sock
->
	`cÚnh
(
msg
, sock->
¬g
);

245 
	}
}

248 
boŞ
 
	$»que¡_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

250 
s£ss_sock
 *
sock
 = 
¬g
;

252 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "INVITE")) {

254 ià(
	`¶_is£t
(&
msg
->
to
.
g
))

255 
	`»šv™e_hªdËr
(
sock
, 
msg
);

257 
	`šv™e_hªdËr
(
sock
, 
msg
);

259  
Œue
;

261 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "ACK")) {

262 
	`ack_hªdËr
(
sock
, 
msg
);

263  
Œue
;

265 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "BYE")) {

266 
	`bye_hªdËr
(
sock
, 
msg
);

267  
Œue
;

269 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "INFO")) {

270 
	`šfo_hªdËr
(
sock
, 
msg
);

271  
Œue
;

273 ià(!
	`¶_¡rcmp
(&
msg
->
m‘
, "REFER")) {

275 ià(!
	`¶_is£t
(&
msg
->
to
.
g
))

276  
çl£
;

278 
	`»ãr_hªdËr
(
sock
, 
msg
);

279  
Œue
;

282  
çl£
;

283 
	}
}

286 
boŞ
 
	$»¥Ú£_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

288 
s£ss_sock
 *
sock
 = 
¬g
;

290 ià(
	`¶_¡rcmp
(&
msg
->
c£q
.
m‘
, "INVITE"))

291  
çl£
;

293 ià(
msg
->
scode
 < 200 || msg->scode > 299)

294  
çl£
;

296 ()
	`s£ss_ack_agaš
(
sock
, 
msg
);

298  
Œue
;

299 
	}
}

313 
	$s£ss_li¡’
(
s£ss_sock
 **
sockp
, 
s
 *sip,

314 
htsize
, 
s£ss_cÚn_h
 *
cÚnh
, *
¬g
)

316 
s£ss_sock
 *
sock
;

317 
”r
;

319 ià(!
sockp
 || !
s
 || !
htsize
)

320  
EINVAL
;

322 
sock
 = 
	`mem_z®loc
((*sock), 
de¡ruùÜ
);

323 ià(!
sock
)

324  
ENOMEM
;

326 
”r
 = 
	`s_li¡’
(&
sock
->
l¢r_»¥
, 
s
, 
çl£
, 
»¥Ú£_hªdËr
, sock);

327 ià(
”r
)

328 
out
;

330 
”r
 = 
	`s_li¡’
(&
sock
->
l¢r_»q
, 
s
, 
Œue
, 
»que¡_hªdËr
, sock);

331 ià(
”r
)

332 
out
;

334 
”r
 = 
	`hash_®loc
(&
sock
->
ht_£ss
, 
htsize
);

335 ià(
”r
)

336 
out
;

338 
”r
 = 
	`hash_®loc
(&
sock
->
ht_ack
, 
htsize
);

339 ià(
”r
)

340 
out
;

342 
sock
->
s
 = sip;

343 
sock
->
cÚnh
 = cÚnh ? cÚnh : 
š‹º®_cÚÃù_hªdËr
;

344 
sock
->
¬g
 = 
cÚnh
 ?‡rg : sock;

346 
out
:

347 ià(
”r
)

348 
	`mem_d”ef
(
sock
);

350 *
sockp
 = 
sock
;

352  
”r
;

353 
	}
}

361 
	$s£ss_şo£_®l
(
s£ss_sock
 *
sock
)

363 ià(!
sock
)

366 
	`hash_æush
(
sock
->
ht_£ss
);

367 
	}
}

	@re-0.5.6/src/sipsess/modify.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$tmr_hªdËr
(*
¬g
)

23 
s£ss
 *
£ss
 = 
¬g
;

25 ()
	`s£ss_»šv™e
(
£ss
, 
Œue
);

26 
	}
}

29 
	$»šv™e_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

30 *
¬g
)

32 
s£ss
 *
£ss
 = 
¬g
;

33 cÚ¡ 
s_hdr
 *
hdr
;

34 
mbuf
 *
desc
 = 
NULL
;

36 ià(
”r
 || 
	`s_»que¡_loİs
(&
£ss
->
ls
, 
msg
->
scode
))

37 
out
;

39 ià(
msg
->
scode
 < 200) {

42 ià(
msg
->
scode
 < 300) {

44 ()
	`s_dŸlog_upd©e
(
£ss
->
dlg
, 
msg
);

46 ià(
£ss
->
£Á_ofãr
)

47 ()
£ss
->
	`ªsw”h
(
msg
, sess->
¬g
);

49 
£ss
->
modify_³ndšg
 = 
çl£
;

50 ()
£ss
->
	`ofãrh
(&
desc
, 
msg
, sess->
¬g
);

53 ()
	`s£ss_ack
(
£ss
->
sock
, sess->
dlg
, 
msg
->
c£q
.
num
,

54 
£ss
->
auth
, sess->
ùy³
, 
desc
);

55 
	`mem_d”ef
(
desc
);

58 ià(
£ss
->
‹rmš©ed
)

59 
out
;

61 
msg
->
scode
) {

65 
”r
 = 
	`s_auth_auth’tiÿ‹
(
£ss
->
auth
, 
msg
);

66 ià(
”r
) {

67 
”r
 = (”¸=ğ
EAUTH
) ? 0 :ƒrr;

71 
”r
 = 
	`s£ss_»šv™e
(
£ss
, 
çl£
);

72 ià(
”r
)

79 
	`s£ss_‹rmš©e
(
£ss
, 0, 
msg
);

83 
	`tmr_¡¬t
(&
£ss
->
tmr
, sess->
owÃr
 ? 3000 : 1000,

84 
tmr_hªdËr
, 
£ss
);

88 
hdr
 = 
	`s_msg_hdr
(
msg
, 
SIP_HDR_RETRY_AFTER
);

89 ià(!
hdr
)

92 
	`tmr_¡¬t
(&
£ss
->
tmr
, 
	`¶_u32
(&
hdr
->
v®
) * 1000,

93 
tmr_hªdËr
, 
£ss
);

97 
out
:

98 ià(
£ss
->
‹rmš©ed
)

99 
	`mem_d”ef
(
£ss
);

100 ià(
”r
 =ğ
ETIMEDOUT
)

101 
	`s£ss_‹rmš©e
(
£ss
, 
”r
, 
NULL
);

102 ià(
£ss
->
modify_³ndšg
)

103 ()
	`s£ss_»šv™e
(
£ss
, 
Œue
);

105 
£ss
->
desc
 = 
	`mem_d”ef
(sess->desc);

106 
	}
}

109 
	$£nd_hªdËr
(
s_Œª¥
 

, cÚ¡ 
§
 *
¤c
,

110 cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
, *
¬g
)

112 
s_cÚù
 
cÚù
;

113 
s£ss
 *
£ss
 = 
¬g
;

114 ()
d¡
;

116 
	`s_cÚù_£t
(&
cÚù
, 
£ss
->
cu£r
, 
¤c
, 

);

118  
	`mbuf_´štf
(
mb
, "%H", 
s_cÚù_´št
, &
cÚù
);

119 
	}
}

122 
	$s£ss_»šv™e
(
s£ss
 *
£ss
, 
boŞ
 
»£t_ls
)

124 ià(
£ss
->
»q
)

125  
EPROTO
;

127 
£ss
->
£Á_ofãr
 = sess->
desc
 ? 
Œue
 : 
çl£
;

128 
£ss
->
modify_³ndšg
 = 
çl£
;

130 ià(
»£t_ls
)

131 
	`s_loİ¡©e_»£t
(&
£ss
->
ls
);

133  
	`s_d»que¡f
(&
£ss
->
»q
, sess->
s
, 
Œue
, "INVITE",

134 
£ss
->
dlg
, 0, sess->
auth
,

135 
£nd_hªdËr
, 
»šv™e_»¥_hªdËr
, 
£ss
,

140 
£ss
->
desc
 ? "Content-Type: " : "",

141 
£ss
->
desc
 ? sess->
ùy³
 : "",

142 
£ss
->
desc
 ? "\r\n" : "",

143 
£ss
->
desc
 ? 
	`mbuf_g‘_Ëá
(£ss->descè:(
size_t
)0,

144 
£ss
->
desc
 ? 
	`mbuf_buf
(£ss->descè: 
NULL
,

145 
£ss
->
desc
 ? 
	`mbuf_g‘_Ëá
(£ss->desc):(
size_t
)0);

146 
	}
}

157 
	$s£ss_modify
(
s£ss
 *
£ss
, 
mbuf
 *
desc
)

159 ià(!
£ss
 || sess->
¡
 || sess->
‹rmš©ed
)

160  
EINVAL
;

162 
	`mem_d”ef
(
£ss
->
desc
);

163 
£ss
->
desc
 = 
	`mem_»f
(desc);

165 ià(
£ss
->
»q
 || sess->
tmr
.
th
 || sess->
»¶yl
.
h—d
) {

166 
£ss
->
modify_³ndšg
 = 
Œue
;

170  
	`s£ss_»šv™e
(
£ss
, 
Œue
);

171 
	}
}

	@re-0.5.6/src/sipsess/reply.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	ss£ss_»¶y
 {

22 
Ë
 
	mË
;

23 
tmr
 
	mtmr
;

24 
tmr
 
	mtmrg
;

25 cÚ¡ 
s_msg
 *
	mmsg
;

26 
mbuf
 *
	mmb
;

27 
s£ss
 *
	m£ss
;

28 
boŞ
 
	mawa™šg_ªsw”
;

29 
ušt32_t
 
	m£q
;

30 
ušt32_t
 
	mtxc
;

34 
	$de¡ruùÜ
(*
¬g
)

36 
s£ss_»¶y
 *
»¶y
 = 
¬g
;

38 
	`li¡_uÆšk
(&
»¶y
->
Ë
);

39 
	`tmr_ÿnûl
(&
»¶y
->
tmr
);

40 
	`tmr_ÿnûl
(&
»¶y
->
tmrg
);

41 
	`mem_d”ef
((*)
»¶y
->
msg
);

42 
	`mem_d”ef
(
»¶y
->
mb
);

43 
	}
}

46 
	$tmr_hªdËr
(*
¬g
)

48 
s£ss_»¶y
 *
»¶y
 = 
¬g
;

49 
s£ss
 *
£ss
 = 
»¶y
->sess;

51 
	`mem_d”ef
(
»¶y
);

54 ià(
£ss
->
»¶yl
.
h—d
)

58 
£ss
->
e¡ablished
 = 
Œue
;

60 ià(!
£ss
->
‹rmš©ed
)

61 
	`s£ss_‹rmš©e
(
£ss
, 
ETIMEDOUT
, 
NULL
);

63 
	`mem_d”ef
(
£ss
);

64 
	}
}

67 
	$»Œªsm™_hªdËr
(*
¬g
)

69 
s£ss_»¶y
 *
»¶y
 = 
¬g
;

71 ()
	`s_£nd
(
»¶y
->
£ss
->
s
,„•ly->
msg
->
sock
,„•ly->msg->

,

72 &
»¶y
->
msg
->
¤c
,„•ly->
mb
);

74 
»¶y
->
txc
++;

75 
	`tmr_¡¬t
(&
»¶y
->
tmrg
, 
	`MIN
(
SIP_T1
<<»¶y->
txc
, 
SIP_T2
),

76 
»Œªsm™_hªdËr
, 
»¶y
);

77 
	}
}

80 
	$s£ss_»¶y_2xx
(
s£ss
 *
£ss
, cÚ¡ 
s_msg
 *
msg
,

81 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
, 
mbuf
 *
desc
,

82 cÚ¡ *
fmt
, 
va_li¡
 *
­
)

84 
s£ss_»¶y
 *
»¶y
;

85 
s_cÚù
 
cÚù
;

86 
”r
 = 
ENOMEM
;

88 
»¶y
 = 
	`mem_z®loc
((*»¶y), 
de¡ruùÜ
);

89 ià(!
»¶y
)

90 
out
;

92 
	`li¡_­³nd
(&
£ss
->
»¶yl
, &
»¶y
->
Ë
,„eply);

93 
»¶y
->
£q
 = 
msg
->
c£q
.
num
;

94 
»¶y
->
msg
 = 
	`mem_»f
((*)msg);

95 
»¶y
->
£ss
 = sess;

97 
	`s_cÚù_£t
(&
cÚù
, 
£ss
->
cu£r
, &
msg
->
d¡
, msg->

);

99 
”r
 = 
	`s_Œ•lyf
(&
£ss
->
¡
, &
»¶y
->
mb
, sess->
s
,

100 
msg
, 
Œue
, 
scode
, 
»asÚ
,

107 
s_cÚù_´št
, &
cÚù
,

108 
fmt
, 
­
,

109 
desc
 ? "Content-Type: " : "",

110 
desc
 ? 
£ss
->
ùy³
 : "",

111 
desc
 ? "\r\n" : "",

112 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0,

113 
desc
 ? 
	`mbuf_buf
(descè: 
NULL
,

114 
desc
 ? 
	`mbuf_g‘_Ëá
(descè: (
size_t
)0);

116 ià(
”r
)

117 
out
;

119 
	`tmr_¡¬t
(&
»¶y
->
tmr
, 64 * 
SIP_T1
, 
tmr_hªdËr
,„eply);

120 
	`tmr_¡¬t
(&
»¶y
->
tmrg
, 
SIP_T1
, 
»Œªsm™_hªdËr
,„eply);

122 ià(!
	`mbuf_g‘_Ëá
(
msg
->
mb
è&& 
desc
) {

123 
»¶y
->
awa™šg_ªsw”
 = 
Œue
;

124 
£ss
->
awa™šg_ªsw”
 = 
Œue
;

127 
out
:

128 ià(
”r
) {

129 
£ss
->
¡
 = 
	`mem_d”ef
(sess->st);

130 
	`mem_d”ef
(
»¶y
);

133  
”r
;

134 
	}
}

137 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

139 
s£ss_»¶y
 *
»¶y
 = 
Ë
->
d©a
;

140 cÚ¡ 
s_msg
 *
msg
 = 
¬g
;

142  
msg
->
c£q
.
num
 =ğ
»¶y
->
£q
;

143 
	}
}

146 
	$s£ss_»¶y_ack
(
s£ss
 *
£ss
, cÚ¡ 
s_msg
 *
msg
,

147 
boŞ
 *
awa™šg_ªsw”
)

149 
s£ss_»¶y
 *
»¶y
;

151 
»¶y
 = 
	`li¡_Ëd©a
(
	`li¡_­¶y
(&
£ss
->
»¶yl
, 
çl£
, 
cmp_hªdËr
,

152 (*)
msg
));

153 ià(!
»¶y
)

154  
ENOENT
;

156 *
awa™šg_ªsw”
 = 
»¶y
->awaiting_answer;

158 
	`mem_d”ef
(
»¶y
);

161 
	}
}

	@re-0.5.6/src/sipsess/request.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$de¡ruùÜ
(*
¬g
)

23 
s£ss_»que¡
 *
»q
 = 
¬g
;

25 
	`li¡_uÆšk
(&
»q
->
Ë
);

26 
	`mem_d”ef
(
»q
->
ùy³
);

27 
	`mem_d”ef
(
»q
->
body
);

28 
	`mem_d”ef
(
»q
->req);

31 ià(
»q
->
£ss
->
‹rmš©ed
 && !»q->£ss->
»que¡l
.
h—d
)

32 
	`mem_d”ef
(
»q
->
£ss
);

33 
	}
}

36 
	$š‹º®_»¥_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

37 *
¬g
)

39 ()
”r
;

40 ()
msg
;

41 ()
¬g
;

42 
	}
}

45 
	$s£ss_»que¡_®loc
(
s£ss_»que¡
 **
»qp
, 
s£ss
 *
£ss
,

46 cÚ¡ *
ùy³
, 
mbuf
 *
body
,

47 
s_»¥_h
 *
»¥h
, *
¬g
)

49 
s£ss_»que¡
 *
»q
;

50 
”r
 = 0;

52 ià(!
»qp
 || !
£ss
 || sess->
‹rmš©ed
)

53  
EINVAL
;

55 
»q
 = 
	`mem_z®loc
((*»q), 
de¡ruùÜ
);

56 ià(!
»q
)

57  
ENOMEM
;

59 
	`li¡_­³nd
(&
£ss
->
»que¡l
, &
»q
->
Ë
,„eq);

61 ià(
ùy³
) {

62 
”r
 = 
	`¡r_dup
(&
»q
->
ùy³
, ctype);

63 ià(
”r
)

64 
out
;

67 
»q
->
£ss
 = sess;

68 
»q
->
body
 = 
	`mem_»f
(body);

69 
»q
->
»¥h
 =„e¥h ?„e¥h : 
š‹º®_»¥_hªdËr
;

70 
»q
->
¬g
 =‡rg;

72 
out
:

73 ià(
”r
)

74 
	`mem_d”ef
(
»q
);

76 *
»qp
 = 
»q
;

79 
	}
}

	@re-0.5.6/src/sipsess/sess.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hash.h
>

12 
	~<»_fmt.h
>

13 
	~<»_uri.h
>

14 
	~<»_tmr.h
>

15 
	~<»_msg.h
>

16 
	~<»_s.h
>

17 
	~<»_s£ss.h
>

18 
	~"s£ss.h
"

21 
	$š‹º®_ofãr_hªdËr
(
mbuf
 **
desı
,

22 cÚ¡ 
s_msg
 *
msg
, *
¬g
)

24 ()
desı
;

25 ()
msg
;

26 ()
¬g
;

28  
ENOSYS
;

29 
	}
}

32 
	$š‹º®_ªsw”_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

34 ()
msg
;

35 ()
¬g
;

37  
ENOSYS
;

38 
	}
}

41 
	$š‹º®_´og»ss_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

43 ()
msg
;

44 ()
¬g
;

45 
	}
}

48 
	$š‹º®_e¡ablish_hªdËr
(cÚ¡ 
s_msg
 *
msg
, *
¬g
)

50 ()
msg
;

51 ()
¬g
;

52 
	}
}

55 
	$š‹º®_şo£_hªdËr
(
”r
, cÚ¡ 
s_msg
 *
msg
,

56 *
¬g
)

58 ()
”r
;

59 ()
msg
;

60 ()
¬g
;

61 
	}
}

64 
boŞ
 
	$‹rmwa™
(
s£ss
 *
£ss
)

66 
boŞ
 
wa™
 = 
çl£
;

68 
£ss
->
‹rmš©ed
 = 1;

69 
£ss
->
ofãrh
 = 
š‹º®_ofãr_hªdËr
;

70 
£ss
->
ªsw”h
 = 
š‹º®_ªsw”_hªdËr
;

71 
£ss
->
´ogrh
 = 
š‹º®_´og»ss_hªdËr
;

72 
£ss
->
e¡abh
 = 
š‹º®_e¡ablish_hªdËr
;

73 
£ss
->
šfoh
 = 
NULL
;

74 
£ss
->
»ãrh
 = 
NULL
;

75 
£ss
->
şo£h
 = 
š‹º®_şo£_hªdËr
;

76 
£ss
->
¬g
 = sess;

78 
	`tmr_ÿnûl
(&
£ss
->
tmr
);

80 ià(
£ss
->
¡
) {

81 ()
	`s_Œ•ly
(&
£ss
->
¡
, sess->
s
, sess->
msg
,

85 ià(
£ss
->
»q
) {

86 
	`s_»que¡_ÿnûl
(
£ss
->
»q
);

87 
	`mem_»f
(
£ss
);

88 
wa™
 = 
Œue
;

91 ià(
£ss
->
»¶yl
.
h—d
) {

92 
	`mem_»f
(
£ss
);

93 
wa™
 = 
Œue
;

96 ià(
£ss
->
»que¡l
.
h—d
) {

97 
	`mem_»f
(
£ss
);

98 
wa™
 = 
Œue
;

101  
wa™
;

102 
	}
}

105 
boŞ
 
	$‹rmš©e
(
s£ss
 *
£ss
)

107 
£ss
->
‹rmš©ed
 = 2;

109 ià(!
£ss
->
e¡ablished
 || sess->
³”‹rm
)

110  
çl£
;

112 ià(
	`s£ss_bye
(
£ss
, 
Œue
))

113  
çl£
;

115 
	`mem_»f
(
£ss
);

116  
Œue
;

117 
	}
}

120 
	$de¡ruùÜ
(*
¬g
)

122 
s£ss
 *
£ss
 = 
¬g
;

124 
£ss
->
‹rmš©ed
) {

127 ià(
	`‹rmwa™
(
£ss
))

133 ià(
	`‹rmš©e
(
£ss
))

138 
	`hash_uÆšk
(&
£ss
->
he
);

139 
	`tmr_ÿnûl
(&
£ss
->
tmr
);

140 
	`li¡_æush
(&
£ss
->
»¶yl
);

141 
	`li¡_æush
(&
£ss
->
»que¡l
);

142 
	`mem_d”ef
((*)
£ss
->
msg
);

143 
	`mem_d”ef
(
£ss
->
»q
);

144 
	`mem_d”ef
(
£ss
->
dlg
);

145 
	`mem_d”ef
(
£ss
->
auth
);

146 
	`mem_d”ef
(
£ss
->
cu£r
);

147 
	`mem_d”ef
(
£ss
->
ùy³
);

148 
	`mem_d”ef
(
£ss
->
şo£_hdrs
);

149 
	`mem_d”ef
(
£ss
->
hdrs
);

150 
	`mem_d”ef
(
£ss
->
desc
);

151 
	`mem_d”ef
(
£ss
->
sock
);

152 
	`mem_d”ef
(
£ss
->
s
);

153 
	`mem_d”ef
(
£ss
->
¡
);

154 
	}
}

157 
	$s£ss_®loc
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

158 cÚ¡ *
cu£r
, cÚ¡ *
ùy³
, 
mbuf
 *
desc
,

159 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

160 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

161 
s£ss_´ogr_h
 *
´ogrh
, 
s£ss_e¡ab_h
 *
e¡abh
,

162 
s£ss_šfo_h
 *
šfoh
, 
s£ss_»ãr_h
 *
»ãrh
,

163 
s£ss_şo£_h
 *
şo£h
, *
¬g
)

165 
s£ss
 *
£ss
;

166 
”r
;

168 
£ss
 = 
	`mem_z®loc
((*£ss), 
de¡ruùÜ
);

169 ià(!
£ss
)

170  
ENOMEM
;

172 
”r
 = 
	`s_auth_®loc
(&
£ss
->
auth
, 
authh
, 
¯rg
, 
¬ef
);

173 ià(
”r
)

174 
out
;

176 
”r
 = 
	`¡r_dup
(&
£ss
->
cu£r
, cuser);

177 ià(
”r
)

178 
out
;

180 
”r
 = 
	`¡r_dup
(&
£ss
->
ùy³
, ctype);

181 ià(
”r
)

182 
out
;

184 
£ss
->
sock
 = 
	`mem_»f
(sock);

185 
£ss
->
desc
 = 
	`mem_»f
(desc);

186 
£ss
->
s
 = 
	`mem_»f
(
sock
->sip);

187 
£ss
->
ofãrh
 = ofãrh ? ofãrh : 
š‹º®_ofãr_hªdËr
;

188 
£ss
->
ªsw”h
 =‡nsw”h ?‡nsw”h : 
š‹º®_ªsw”_hªdËr
;

189 
£ss
->
´ogrh
 =…rogrh ?…rogrh : 
š‹º®_´og»ss_hªdËr
;

190 
£ss
->
e¡abh
 =ƒ¡abh ?ƒ¡abh : 
š‹º®_e¡ablish_hªdËr
;

191 
£ss
->
šfoh
 = infoh;

192 
£ss
->
»ãrh
 =„eferh;

193 
£ss
->
şo£h
 = clo£h ? clo£h : 
š‹º®_şo£_hªdËr
;

194 
£ss
->
¬g
 =‡rg;

196 
out
:

197 ià(
”r
)

198 
	`mem_d”ef
(
£ss
);

200 *
£s¥
 = 
£ss
;

202  
”r
;

203 
	}
}

206 
	$s£ss_‹rmš©e
(
s£ss
 *
£ss
, 
”r
,

207 cÚ¡ 
s_msg
 *
msg
)

209 
s£ss_şo£_h
 *
şo£h
;

210 *
¬g
;

212 ià(
£ss
->
‹rmš©ed
)

215 
şo£h
 = 
£ss
->closeh;

216 
¬g
 = 
£ss
->arg;

218 ià(!
	`‹rmwa™
(
£ss
))

219 ()
	`‹rmš©e
(
£ss
);

221 
	`şo£h
(
”r
, 
msg
, 
¬g
);

222 
	}
}

232 
s_dŸlog
 *
	$s£ss_dŸlog
(cÚ¡ 
s£ss
 *
£ss
)

234  
£ss
 ? sess->
dlg
 : 
NULL
;

235 
	}
}

247 
	$s£ss_£t_şo£_h—d”s
(
s£ss
 *
£ss
, cÚ¡ *
hdrs
, ...)

249 
”r
 = 0;

250 
va_li¡
 
­
;

252 ià(!
£ss
)

253  
EINVAL
;

255 
£ss
->
şo£_hdrs
 = 
	`mem_d”ef
(sess->close_hdrs);

257 ià(
hdrs
) {

258 
	`va_¡¬t
(
­
, 
hdrs
);

259 
”r
 = 
	`»_vsd´štf
(&
£ss
->
şo£_hdrs
, 
hdrs
, 
­
);

260 
	`va_’d
(
­
);

263  
”r
;

264 
	}
}

	@re-0.5.6/src/sipsess/sipsess.h

8 
	ss£ss
 {

9 
Ë
 
	mhe
;

10 
tmr
 
	mtmr
;

11 
li¡
 
	m»¶yl
;

12 
li¡
 
	m»que¡l
;

13 
s_loİ¡©e
 
	mls
;

14 
s£ss_sock
 *
	msock
;

15 cÚ¡ 
s_msg
 *
	mmsg
;

16 
s_»que¡
 *
	m»q
;

17 
s_dŸlog
 *
	mdlg
;

18 
s_¡¿ns
 *
	m¡
;

19 
s_auth
 *
	mauth
;

20 
s
 *
	ms
;

21 *
	mcu£r
;

22 *
	mùy³
;

23 *
	mşo£_hdrs
;

24 
mbuf
 *
	mhdrs
;

25 
mbuf
 *
	mdesc
;

26 
s£ss_ofãr_h
 *
	mofãrh
;

27 
s£ss_ªsw”_h
 *
	mªsw”h
;

28 
s£ss_´ogr_h
 *
	m´ogrh
;

29 
s£ss_e¡ab_h
 *
	me¡abh
;

30 
s£ss_šfo_h
 *
	mšfoh
;

31 
s£ss_»ãr_h
 *
	m»ãrh
;

32 
s£ss_şo£_h
 *
	mşo£h
;

33 *
	m¬g
;

34 
boŞ
 
	mowÃr
;

35 
boŞ
 
	m£Á_ofãr
;

36 
boŞ
 
	mawa™šg_ªsw”
;

37 
boŞ
 
	mmodify_³ndšg
;

38 
boŞ
 
	me¡ablished
;

39 
boŞ
 
	m³”‹rm
;

40 
	m‹rmš©ed
;

44 
	ss£ss_sock
 {

45 
s_l¢r
 *
	ml¢r_»¥
;

46 
s_l¢r
 *
	ml¢r_»q
;

47 
hash
 *
	mht_£ss
;

48 
hash
 *
	mht_ack
;

49 
s
 *
	ms
;

50 
s£ss_cÚn_h
 *
	mcÚnh
;

51 *
	m¬g
;

55 
	ss£ss_»que¡
 {

56 
Ë
 
	mË
;

57 
s_loİ¡©e
 
	mls
;

58 
s£ss
 *
	m£ss
;

59 
s_»que¡
 *
	m»q
;

60 *
	mùy³
;

61 
mbuf
 *
	mbody
;

62 
s_»¥_h
 *
	m»¥h
;

63 *
	m¬g
;

67 
s£ss_®loc
(
s£ss
 **
£s¥
, 
s£ss_sock
 *
sock
,

68 cÚ¡ *
cu£r
, cÚ¡ *
ùy³
, 
mbuf
 *
desc
,

69 
s_auth_h
 *
authh
, *
¯rg
, 
boŞ
 
¬ef
,

70 
s£ss_ofãr_h
 *
ofãrh
, 
s£ss_ªsw”_h
 *
ªsw”h
,

71 
s£ss_´ogr_h
 *
´ogrh
, 
s£ss_e¡ab_h
 *
e¡abh
,

72 
s£ss_šfo_h
 *
šfoh
, 
s£ss_»ãr_h
 *
»ãrh
,

73 
s£ss_şo£_h
 *
şo£h
, *
¬g
);

74 
s£ss_‹rmš©e
(
s£ss
 *
£ss
, 
”r
,

75 cÚ¡ 
s_msg
 *
msg
);

76 
s£ss_ack
(
s£ss_sock
 *
sock
, 
s_dŸlog
 *
dlg
,

77 
ušt32_t
 
c£q
, 
s_auth
 *
auth
,

78 cÚ¡ *
ùy³
, 
mbuf
 *
desc
);

79 
s£ss_ack_agaš
(
s£ss_sock
 *
sock
, cÚ¡ 
s_msg
 *
msg
);

80 
s£ss_»¶y_2xx
(
s£ss
 *
£ss
, cÚ¡ 
s_msg
 *
msg
,

81 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
, 
mbuf
 *
desc
,

82 cÚ¡ *
fmt
, 
va_li¡
 *
­
);

83 
s£ss_»¶y_ack
(
s£ss
 *
£ss
, cÚ¡ 
s_msg
 *
msg
,

84 
boŞ
 *
awa™šg_ªsw”
);

85 
s£ss_»šv™e
(
s£ss
 *
£ss
, 
boŞ
 
»£t_ls
);

86 
s£ss_bye
(
s£ss
 *
£ss
, 
boŞ
 
»£t_ls
);

87 
s£ss_»que¡_®loc
(
s£ss_»que¡
 **
»qp
, 
s£ss
 *
£ss
,

88 cÚ¡ *
ùy³
, 
mbuf
 *
body
,

89 
s_»¥_h
 *
»¥h
, *
¬g
);

	@re-0.5.6/src/srtp/misc.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_«s.h
>

12 
	~<»_§.h
>

13 
	~<»_¤.h
>

14 
	~"¤.h
"

22 
ušt64_t
 
	$¤_g‘_šdex
(
ušt32_t
 
roc
, 
ušt16_t
 
s_l
, ušt16_ˆ
£q
)

24 
v
;

26 ià(
s_l
 < 32768) {

28 ià(()
£q
 - ()
s_l
 > 32768)

29 
v
 = (
roc
-1) & 0xffffffffu;

31 
v
 = 
roc
;

34 ià(()
s_l
 - 32768 > 
£q
)

35 
v
 = (
roc
+1) & 0xffffffffu;

37 
v
 = 
roc
;

40  
£q
 + 
v
*65536;

41 
	}
}

44 
	$¤_d”ive
(
ušt8_t
 *
out
, 
size_t
 
out_Ën
, ušt8_ˆ
Ïb–
,

45 cÚ¡ 
ušt8_t
 *
ma¡”_key
, 
size_t
 
key_by‹s
,

46 cÚ¡ 
ušt8_t
 *
ma¡”_§É
, 
size_t
 
§É_by‹s
)

48 
ušt8_t
 
x
[
AES_BLOCK_SIZE
] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

49 cÚ¡ 
ušt8_t
 
nuÎ
[
AES_BLOCK_SIZE
 * 2];

50 
«s
 *aes;

51 
”r
;

53 ià(!
out
 || !
ma¡”_key
 || !
ma¡”_§É
)

54  
EINVAL
;

56 ià(
out_Ën
 > (
nuÎ
è|| 
§É_by‹s
 > (
x
))

57  
EINVAL
;

59 
	`memıy
(
x
, 
ma¡”_§É
, 
§É_by‹s
);

60 
x
[7] ^ğ
Ïb–
;

62 
”r
 = 
	`«s_®loc
(&
«s
, 
AES_MODE_CTR
, 
ma¡”_key
, 
key_by‹s
*8, 
x
);

63 ià(
”r
)

64  
”r
;

66 
”r
 = 
	`«s_’ü
(
«s
, 
out
, 
nuÎ
, 
out_Ën
);

68 
	`mem_d”ef
(
«s
);

70  
”r
;

72 
	}
}

75 
	$¤_iv_ÿlc
(
veù128
 *
iv
, cÚ¡ veù128 *
k_s
,

76 
ušt32_t
 
s¤c
, 
ušt64_t
 
ix
)

78 ià(!
iv
 || !
k_s
)

81 
iv
->
u32
[0] = 
k_s
->u32[0];

82 
iv
->
u32
[1] = 
k_s
->u32[1] ^ 
	`htÚl
(
s¤c
);

83 
iv
->
u32
[2] = 
k_s
->u32[2] ^ 
	`htÚl
((
ušt32_t
)(
ix
>>16));

84 
iv
->
u16
[6] = 
k_s
->u16[6] ^ 
	`htÚs
((
ušt16_t
)
ix
);

85 
iv
->
u16
[7] = 0;

86 
	}
}

89 cÚ¡ *
	$¤_su™e_Çme
(
¤_su™e
 
su™e
)

91 
su™e
) {

93 
SRTP_AES_CM_128_HMAC_SHA1_32
:  "AES_CM_128_HMAC_SHA1_32";

94 
SRTP_AES_CM_128_HMAC_SHA1_80
:  "AES_CM_128_HMAC_SHA1_80";

95 
SRTP_AES_256_CM_HMAC_SHA1_32
:  "AES_256_CM_HMAC_SHA1_32";

96 
SRTP_AES_256_CM_HMAC_SHA1_80
:  "AES_256_CM_HMAC_SHA1_80";

99 
	}
}

	@re-0.5.6/src/srtp/replay.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_li¡.h
>

9 
	~<»_¤.h
>

10 
	~"¤.h
"

14 
	mSRTP_WINDOW_SIZE
 = 64

18 
	$¤_»¶ay_š™
(
»¶ay
 *replay)

20 ià(!
»¶ay
)

23 
»¶ay
->
b™m­
 = 0;

24 
»¶ay
->
lix
 = 0;

25 
	}
}

31 
boŞ
 
	$¤_»¶ay_check
(
»¶ay
 *»¶ay, 
ušt64_t
 
ix
)

33 
ušt64_t
 
diff
;

35 ià(!
»¶ay
)

36  
çl£
;

38 ià(
ix
 > 
»¶ay
->
lix
) {

39 
diff
 = 
ix
 - 
»¶ay
->
lix
;

41 ià(
diff
 < 
SRTP_WINDOW_SIZE
) {

42 
»¶ay
->
b™m­
 <<ğ
diff
;

43 
»¶ay
->
b™m­
 |= 1;

46 
»¶ay
->
b™m­
 = 1;

48 
»¶ay
->
lix
 = 
ix
;

49  
Œue
;

52 
diff
 = 
»¶ay
->
lix
 - 
ix
;

53 ià(
diff
 >ğ
SRTP_WINDOW_SIZE
)

54  
çl£
;

56 ià(
»¶ay
->
b™m­
 & (1ULL << 
diff
))

57  
çl£
;

60 
»¶ay
->
b™m­
 |ğ(1ULL << 
diff
);

62  
Œue
;

63 
	}
}

	@re-0.5.6/src/srtp/srtcp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_hmac.h
>

12 
	~<»_sha.h
>

13 
	~<»_«s.h
>

14 
	~<»_Ãt.h
>

15 
	~<»_¤.h
>

16 
	~"¤.h
"

19 
	$g‘_¹ı_s¤c
(
ušt32_t
 *
s¤c
, 
mbuf
 *
mb
)

21 ià(
	`mbuf_g‘_Ëá
(
mb
) < 8)

22  
EBADMSG
;

24 
	`mbuf_advªû
(
mb
, 4);

25 *
s¤c
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

28 
	}
}

31 
	$¤tı_’üy±
(
¤
 *¤, 
mbuf
 *
mb
)

33 
¤_¡»am
 *
¡rm
;

34 
comp
 *
¹ı
;

35 
ušt32_t
 
s¤c
;

36 
size_t
 
¡¬t
;

37 
ušt32_t
 
•
 = 0;

38 
”r
;

40 ià(!
¤
 || !
mb
)

41  
EINVAL
;

43 
¹ı
 = &
¤
->rtcp;

44 
¡¬t
 = 
mb
->
pos
;

46 
”r
 = 
	`g‘_¹ı_s¤c
(&
s¤c
, 
mb
);

47 ià(
”r
)

48  
”r
;

50 
”r
 = 
	`¡»am_g‘
(&
¡rm
, 
¤
, 
s¤c
);

51 ià(
”r
)

52  
”r
;

54 
¡rm
->
¹ı_šdex
 = (strm->rtcp_index+1) & 0x7fffffff;

56 ià(
¹ı
->
«s
) {

57 
veù128
 
iv
;

58 
ušt8_t
 *
p
 = 
	`mbuf_buf
(
mb
);

60 
	`¤_iv_ÿlc
(&
iv
, &
¹ı
->
k_s
, 
s¤c
, 
¡rm
->
¹ı_šdex
);

62 
	`«s_£t_iv
(
¹ı
->
«s
, 
iv
.
u8
);

63 
”r
 = 
	`«s_’ü
(
¹ı
->
«s
, 
p
,…, 
	`mbuf_g‘_Ëá
(
mb
));

64 ià(
”r
)

65  
”r
;

67 
•
 = 1;

71 
mb
->
pos
 = mb->
’d
;

72 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
•
<<31 | 
¡rm
->
¹ı_šdex
));

73 ià(
”r
)

74  
”r
;

76 ià(
¹ı
->
hmac
) {

77 
ušt8_t
 
g
[
SHA_DIGEST_LENGTH
];

79 
mb
->
pos
 = 
¡¬t
;

81 
”r
 = 
	`hmac_dige¡
(
¹ı
->
hmac
, 
g
, (tag),

82 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

83 ià(
”r
)

84  
”r
;

86 
mb
->
pos
 = mb->
’d
;

88 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, 
g
, 
¹ı
->
g_Ën
);

89 ià(
”r
)

90  
”r
;

93 
mb
->
pos
 = 
¡¬t
;

96 
	}
}

99 
	$¤tı_deüy±
(
¤
 *¤, 
mbuf
 *
mb
)

101 
size_t
 
¡¬t
, 
eix_¡¬t
, 
¶d_¡¬t
;

102 
¤_¡»am
 *
¡rm
;

103 
comp
 *
¹ı
;

104 
ušt32_t
 
v
, 
ix
;

105 
ušt32_t
 
s¤c
;

106 
boŞ
 
•
;

107 
”r
;

109 ià(!
¤
 || !
mb
)

110  
EINVAL
;

112 
¹ı
 = &
¤
->rtcp;

113 
¡¬t
 = 
mb
->
pos
;

115 
”r
 = 
	`g‘_¹ı_s¤c
(&
s¤c
, 
mb
);

116 ià(
”r
)

117  
”r
;

119 
”r
 = 
	`¡»am_g‘
(&
¡rm
, 
¤
, 
s¤c
);

120 ià(
”r
)

121  
”r
;

123 
¶d_¡¬t
 = 
mb
->
pos
;

125 ià(
	`mbuf_g‘_Ëá
(
mb
è< (4 + 
¹ı
->
g_Ën
))

126  
EBADMSG
;

129 
eix_¡¬t
 = 
mb
->
’d
 - (4 + 
¹ı
->
g_Ën
);

130 
mb
->
pos
 = 
eix_¡¬t
;

131 
v
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

133 
•
 = (
v
 >> 31) & 1;

134 
ix
 = 
v
 & 0x7fffffff;

136 ià(
¹ı
->
hmac
) {

137 
ušt8_t
 
g
[
SHA_DIGEST_LENGTH
], 
g_pkt
[SHA_DIGEST_LENGTH];

138 cÚ¡ 
size_t
 
g_¡¬t
 = 
mb
->
pos
;

140 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
g_pkt
, 
¹ı
->
g_Ën
);

141 ià(
”r
)

142  
”r
;

144 
mb
->
pos
 = 
¡¬t
;

145 
mb
->
’d
 = 
g_¡¬t
;

147 
”r
 = 
	`hmac_dige¡
(
¹ı
->
hmac
, 
g
, (tag),

148 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

149 ià(
”r
)

150  
”r
;

152 ià(0 !ğ
	`memcmp
(
g
, 
g_pkt
, 
¹ı
->
g_Ën
))

153  
EAUTH
;

160 ià(!
	`¤_»¶ay_check
(&
¡rm
->
»¶ay_¹ı
, 
ix
))

161  
EALREADY
;

164 
mb
->
’d
 = 
eix_¡¬t
;

166 ià(
¹ı
->
«s
 && 
•
) {

167 
veù128
 
iv
;

168 
ušt8_t
 *
p
;

170 
mb
->
pos
 = 
¶d_¡¬t
;

171 
p
 = 
	`mbuf_buf
(
mb
);

173 
	`¤_iv_ÿlc
(&
iv
, &
¹ı
->
k_s
, 
s¤c
, 
ix
);

175 
	`«s_£t_iv
(
¹ı
->
«s
, 
iv
.
u8
);

176 
”r
 = 
	`«s_deü
(
¹ı
->
«s
, 
p
,…, 
	`mbuf_g‘_Ëá
(
mb
));

177 ià(
”r
)

178  
”r
;

181 
mb
->
pos
 = 
¡¬t
;

184 
	}
}

	@re-0.5.6/src/srtp/srtp.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hmac.h
>

13 
	~<»_sha.h
>

14 
	~<»_«s.h
>

15 
	~<»_§.h
>

16 
	~<»_¹p.h
>

17 
	~<»_¤.h
>

18 
	~"¤.h
"

23 
	mMAX_KEYLEN
 = 32,

27 
šlše
 
	$£q_diff
(
ušt16_t
 
x
, ušt16_ˆ
y
)

29  ()
y
 - ()
x
;

30 
	}
}

33 
	$comp_š™
(
comp
 *
c
, 
offs
,

34 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_b
,

35 cÚ¡ 
ušt8_t
 *
s
, 
size_t
 
s_b
,

36 
size_t
 
g_Ën
, 
boŞ
 
’üy±ed
)

38 
ušt8_t
 
k_e
[
MAX_KEYLEN
], 
k_a
[
SHA_DIGEST_LENGTH
];

39 
”r
 = 0;

41 ià(
key_b
 > (
k_e
))

42  
EINVAL
;

44 ià(
g_Ën
 > 
SHA_DIGEST_LENGTH
)

45  
EINVAL
;

47 
c
->
g_Ën
 =ag_len;

49 
”r
 |ğ
	`¤_d”ive
(
k_e
, 
key_b
, 0x00+
offs
, 
key
, key_b, 
s
, 
s_b
);

50 
”r
 |ğ
	`¤_d”ive
(
k_a
, (k_a), 0x01+
offs
, 
key
, 
key_b
, 
s
, 
s_b
);

51 
”r
 |ğ
	`¤_d”ive
(
c
->
k_s
.
u8
, 14, 0x02+
offs
, 
key
, 
key_b
, 
s
, 
s_b
);

52 ià(
”r
)

53  
”r
;

55 ià(
’üy±ed
) {

56 
”r
 = 
	`«s_®loc
(&
c
->
«s
, 
AES_MODE_CTR
, 
k_e
, 
key_b
*8, 
NULL
);

57 ià(
”r
)

58  
”r
;

61 
”r
 = 
	`hmac_ü—‹
(&
c
->
hmac
, 
HMAC_HASH_SHA1
, 
k_a
, (k_a));

62 ià(
”r
)

63  
”r
;

65  
”r
;

66 
	}
}

69 
	$de¡ruùÜ
(*
¬g
)

71 
¤
 *¤ = 
¬g
;

73 
	`mem_d”ef
(
¤
->
¹p
.
«s
);

74 
	`mem_d”ef
(
¤
->
¹ı
.
«s
);

75 
	`mem_d”ef
(
¤
->
¹p
.
hmac
);

76 
	`mem_d”ef
(
¤
->
¹ı
.
hmac
);

78 
	`li¡_æush
(&
¤
->
¡»aml
);

79 
	}
}

82 
	$¤_®loc
(
¤
 **
¤p
, 
¤_su™e
 
su™e
,

83 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
key_by‹s
, 
æags
)

85 
¤
 *srtp;

86 cÚ¡ 
ušt8_t
 *
ma¡”_§É
;

87 
size_t
 
ch”_by‹s
, 
auth_by‹s
;

88 
”r
 = 0;

90 ià(!
¤p
 || !
key
)

91  
EINVAL
;

93 
su™e
) {

95 
SRTP_AES_CM_128_HMAC_SHA1_80
:

96 
ch”_by‹s
 = 16;

97 
auth_by‹s
 = 10;

100 
SRTP_AES_CM_128_HMAC_SHA1_32
:

101 
ch”_by‹s
 = 16;

102 
auth_by‹s
 = 4;

105 
SRTP_AES_256_CM_HMAC_SHA1_80
:

106 
ch”_by‹s
 = 32;

107 
auth_by‹s
 = 10;

110 
SRTP_AES_256_CM_HMAC_SHA1_32
:

111 
ch”_by‹s
 = 32;

112 
auth_by‹s
 = 4;

116  
ENOTSUP
;

119 ià((
ch”_by‹s
 + 
SRTP_SALT_SIZE
è!ğ
key_by‹s
)

120  
EINVAL
;

122 
ma¡”_§É
 = &
key
[
ch”_by‹s
];

124 
¤
 = 
	`mem_z®loc
((*¤), 
de¡ruùÜ
);

125 ià(!
¤
)

126  
ENOMEM
;

128 
”r
 |ğ
	`comp_š™
(&
¤
->
¹p
, 0, 
key
, 
ch”_by‹s
,

129 
ma¡”_§É
, 
SRTP_SALT_SIZE
, 
auth_by‹s
, 
Œue
);

130 
”r
 |ğ
	`comp_š™
(&
¤
->
¹ı
, 3, 
key
, 
ch”_by‹s
,

131 
ma¡”_§É
, 
SRTP_SALT_SIZE
, 
auth_by‹s
,

132 !(
æags
 & 
SRTP_UNENCRYPTED_SRTCP
));

133 ià(
”r
)

134 
out
;

136 
out
:

137 ià(
”r
)

138 
	`mem_d”ef
(
¤
);

140 *
¤p
 = 
¤
;

142  
”r
;

143 
	}
}

146 
	$¤_’üy±
(
¤
 *¤, 
mbuf
 *
mb
)

148 
¤_¡»am
 *
¡rm
;

149 
¹p_h—d”
 
hdr
;

150 
comp
 *comp;

151 
size_t
 
¡¬t
;

152 
ušt64_t
 
ix
;

153 
”r
;

155 ià(!
¤
 || !
mb
)

156  
EINVAL
;

158 
comp
 = &
¤
->
¹p
;

160 
¡¬t
 = 
mb
->
pos
;

162 
”r
 = 
	`¹p_hdr_decode
(&
hdr
, 
mb
);

163 ià(
”r
)

164  
”r
;

166 
”r
 = 
	`¡»am_g‘_£q
(&
¡rm
, 
¤
, 
hdr
.
s¤c
, hdr.
£q
);

167 ià(
”r
)

168  
”r
;

171 ià(
	`£q_diff
(
¡rm
->
s_l
, 
hdr
.
£q
) <= -32768) {

172 
¡rm
->
roc
++;

173 
¡rm
->
s_l
 = 0;

176 
ix
 = 65536ULL * 
¡rm
->
roc
 + 
hdr
.
£q
;

178 ià(
comp
->
«s
) {

179 
veù128
 
iv
;

180 
ušt8_t
 *
p
 = 
	`mbuf_buf
(
mb
);

182 
	`¤_iv_ÿlc
(&
iv
, &
comp
->
k_s
, 
¡rm
->
s¤c
, 
ix
);

184 
	`«s_£t_iv
(
comp
->
«s
, 
iv
.
u8
);

185 
”r
 = 
	`«s_’ü
(
comp
->
«s
, 
p
,…, 
	`mbuf_g‘_Ëá
(
mb
));

186 ià(
”r
)

187  
”r
;

190 ià(
comp
->
hmac
) {

191 cÚ¡ 
size_t
 
g_¡¬t
 = 
mb
->
’d
;

192 
ušt8_t
 
g
[
SHA_DIGEST_LENGTH
];

194 
mb
->
pos
 = 
g_¡¬t
;

196 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¡rm
->
roc
));

197 ià(
”r
)

198  
”r
;

200 
mb
->
pos
 = 
¡¬t
;

202 
”r
 = 
	`hmac_dige¡
(
comp
->
hmac
, 
g
, (tag),

203 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

204 ià(
”r
)

205  
”r
;

207 
mb
->
pos
 = mb->
’d
 = 
g_¡¬t
;

209 
”r
 = 
	`mbuf_wr™e_mem
(
mb
, 
g
, 
comp
->
g_Ën
);

210 ià(
”r
)

211  
”r
;

214 ià(
hdr
.
£q
 > 
¡rm
->
s_l
)

215 
¡rm
->
s_l
 = 
hdr
.
£q
;

217 
mb
->
pos
 = 
¡¬t
;

220 
	}
}

223 
	$¤_deüy±
(
¤
 *¤, 
mbuf
 *
mb
)

225 
¤_¡»am
 *
¡rm
;

226 
¹p_h—d”
 
hdr
;

227 
comp
 *comp;

228 
ušt64_t
 
ix
;

229 
size_t
 
¡¬t
;

230 
diff
;

231 
”r
;

233 ià(!
¤
 || !
mb
)

234  
EINVAL
;

236 
comp
 = &
¤
->
¹p
;

238 
¡¬t
 = 
mb
->
pos
;

240 
”r
 = 
	`¹p_hdr_decode
(&
hdr
, 
mb
);

241 ià(
”r
)

242  
”r
;

244 
”r
 = 
	`¡»am_g‘_£q
(&
¡rm
, 
¤
, 
hdr
.
s¤c
, hdr.
£q
);

245 ià(
”r
)

246  
”r
;

248 
diff
 = 
	`£q_diff
(
¡rm
->
s_l
, 
hdr
.
£q
);

249 ià(
diff
 > 32768)

250  
ETIMEDOUT
;

253 ià(
diff
 <= -32768) {

254 
¡rm
->
roc
++;

255 
¡rm
->
s_l
 = 0;

258 
ix
 = 
	`¤_g‘_šdex
(
¡rm
->
roc
, sŒm->
s_l
, 
hdr
.
£q
);

260 ià(
comp
->
hmac
) {

261 
ušt8_t
 
g_ÿlc
[
SHA_DIGEST_LENGTH
];

262 
ušt8_t
 
g_pkt
[
SHA_DIGEST_LENGTH
];

263 
size_t
 
¶d_¡¬t
, 
g_¡¬t
;

265 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
comp
->
g_Ën
)

266  
EBADMSG
;

268 
¶d_¡¬t
 = 
mb
->
pos
;

269 
g_¡¬t
 = 
mb
->
’d
 - 
comp
->
g_Ën
;

271 
mb
->
pos
 = 
g_¡¬t
;

273 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
g_pkt
, 
comp
->
g_Ën
);

274 ià(
”r
)

275  
”r
;

277 
mb
->
pos
 = mb->
’d
 = 
g_¡¬t
;

279 
”r
 = 
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
¡rm
->
roc
));

280 ià(
”r
)

281  
”r
;

283 
mb
->
pos
 = 
¡¬t
;

285 
”r
 = 
	`hmac_dige¡
(
comp
->
hmac
, 
g_ÿlc
, (tag_calc),

286 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

287 ià(
”r
)

288  
”r
;

290 
mb
->
pos
 = 
¶d_¡¬t
;

291 
mb
->
’d
 = 
g_¡¬t
;

293 ià(0 !ğ
	`memcmp
(
g_ÿlc
, 
g_pkt
, 
comp
->
g_Ën
))

294  
EAUTH
;

302 ià(!
	`¤_»¶ay_check
(&
¡rm
->
»¶ay_¹p
, 
ix
))

303  
EALREADY
;

306 ià(
comp
->
«s
) {

308 
veù128
 
iv
;

309 
ušt8_t
 *
p
 = 
	`mbuf_buf
(
mb
);

311 
	`¤_iv_ÿlc
(&
iv
, &
comp
->
k_s
, 
¡rm
->
s¤c
, 
ix
);

313 
	`«s_£t_iv
(
comp
->
«s
, 
iv
.
u8
);

314 
”r
 = 
	`«s_deü
(
comp
->
«s
, 
p
,…, 
	`mbuf_g‘_Ëá
(
mb
));

315 ià(
”r
)

316  
”r
;

319 ià(
hdr
.
£q
 > 
¡rm
->
s_l
)

320 
¡rm
->
s_l
 = 
hdr
.
£q
;

322 
mb
->
pos
 = 
¡¬t
;

325 
	}
}

	@re-0.5.6/src/srtp/srtp.h

9 
	mSRTP_SALT_SIZE
 = 14

14 
	uveù128
 {

15 
ušt64_t
 
	mu64
[ 2];

16 
ušt32_t
 
	mu32
[ 4];

17 
ušt16_t
 
	mu16
[ 8];

18 
ušt8_t
 
	mu8
[16];

22 
	s»¶ay
 {

23 
ušt64_t
 
	mb™m­
;

24 
ušt64_t
 
	mlix
;

28 
	s¤_¡»am
 {

29 
Ë
 
	mË
;

30 
»¶ay
 
	m»¶ay_¹p
;

31 
»¶ay
 
	m»¶ay_¹ı
;

32 
ušt32_t
 
	ms¤c
;

33 
ušt32_t
 
	mroc
;

34 
ušt16_t
 
	ms_l
;

35 
boŞ
 
	ms_l_£t
;

36 
ušt32_t
 
	m¹ı_šdex
;

40 
	s¤
 {

41 
	scomp
 {

42 
«s
 *
	m«s
;

43 
hmac
 *
	mhmac
;

44 
veù128
 
	mk_s
;

45 
size_t
 
	mg_Ën
;

46 } 
	m¹p
, 
	m¹ı
;

48 
li¡
 
	m¡»aml
;

52 
¡»am_g‘
(
¤_¡»am
 **
¡rmp
, 
¤
 *¤, 
ušt32_t
 
s¤c
);

53 
¡»am_g‘_£q
(
¤_¡»am
 **
¡rmp
, 
¤
 *srtp,

54 
ušt32_t
 
s¤c
, 
ušt16_t
 
£q
);

57 
¤_d”ive
(
ušt8_t
 *
out
, 
size_t
 
out_Ën
, ušt8_ˆ
Ïb–
,

58 cÚ¡ 
ušt8_t
 *
ma¡”_key
, 
size_t
 
key_by‹s
,

59 cÚ¡ 
ušt8_t
 *
ma¡”_§É
, 
size_t
 
§É_by‹s
);

60 
¤_iv_ÿlc
(
veù128
 *
iv
, cÚ¡ veù128 *
k_s
,

61 
ušt32_t
 
s¤c
, 
ušt64_t
 
ix
);

62 
ušt64_t
 
¤_g‘_šdex
(
ušt32_t
 
roc
, 
ušt16_t
 
s_l
, ušt16_ˆ
£q
);

67 
¤_»¶ay_š™
(
»¶ay
 *replay);

68 
boŞ
 
¤_»¶ay_check
(
»¶ay
 *»¶ay, 
ušt64_t
 
ix
);

	@re-0.5.6/src/srtp/stream.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_¤.h
>

11 
	~"¤.h
"

15 #iâdeà
SRTP_MAX_STREAMS


16 
	#SRTP_MAX_STREAMS
 (8è

	)

20 
	$¡»am_de¡ruùÜ
(*
¬g
)

22 
¤_¡»am
 *
¡rm
 = 
¬g
;

24 
	`li¡_uÆšk
(&
¡rm
->
Ë
);

25 
	}
}

28 
¤_¡»am
 *
	$¡»am_fšd
(
¤
 *¤, 
ušt32_t
 
s¤c
)

30 
Ë
 *le;

32 
Ë
 = 
¤
->
¡»aml
.
h—d
;†e;†ğË->
Ãxt
) {

34 
¤_¡»am
 *
¡rm
 = 
Ë
->
d©a
;

36 ià(
¡rm
->
s¤c
 == ssrc)

37  
¡rm
;

40  
NULL
;

41 
	}
}

44 
	$¡»am_Ãw
(
¤_¡»am
 **
¡rmp
, 
¤
 *srtp,

45 
ušt32_t
 
s¤c
)

47 
¤_¡»am
 *
¡rm
;

49 ià(
	`li¡_couÁ
(&
¤
->
¡»aml
è>ğ
SRTP_MAX_STREAMS
)

50  
ENOSR
;

52 
¡rm
 = 
	`mem_z®loc
((*¡rm), 
¡»am_de¡ruùÜ
);

53 ià(!
¡rm
)

54  
ENOMEM
;

56 
¡rm
->
s¤c
 = ssrc;

57 
	`¤_»¶ay_š™
(&
¡rm
->
»¶ay_¹p
);

58 
	`¤_»¶ay_š™
(&
¡rm
->
»¶ay_¹ı
);

60 
	`li¡_­³nd
(&
¤
->
¡»aml
, &
¡rm
->
Ë
, strm);

62 ià(
¡rmp
)

63 *
¡rmp
 = 
¡rm
;

66 
	}
}

69 
	$¡»am_g‘
(
¤_¡»am
 **
¡rmp
, 
¤
 *¤, 
ušt32_t
 
s¤c
)

71 
¤_¡»am
 *
¡rm
;

73 ià(!
¡rmp
 || !
¤
)

74  
EINVAL
;

76 
¡rm
 = 
	`¡»am_fšd
(
¤
, 
s¤c
);

77 ià(
¡rm
) {

78 *
¡rmp
 = 
¡rm
;

82  
	`¡»am_Ãw
(
¡rmp
, 
¤
, 
s¤c
);

83 
	}
}

86 
	$¡»am_g‘_£q
(
¤_¡»am
 **
¡rmp
, 
¤
 *srtp,

87 
ušt32_t
 
s¤c
, 
ušt16_t
 
£q
)

89 
¤_¡»am
 *
¡rm
;

90 
”r
;

92 ià(!
¡rmp
 || !
¤
)

93  
EINVAL
;

95 
”r
 = 
	`¡»am_g‘
(&
¡rm
, 
¤
, 
s¤c
);

96 ià(
”r
)

97  
”r
;

100 ià(!
¡rm
->
s_l_£t
) {

101 
¡rm
->
s_l
 = 
£q
;

102 
¡rm
->
s_l_£t
 = 
Œue
;

105 *
¡rmp
 = 
¡rm
;

108 
	}
}

	@re-0.5.6/src/stun/addr.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_§.h
>

9 
	~<»_li¡.h
>

10 
	~<»_¡un.h
>

11 
	~"¡un.h
"

14 
	$š6_xÜ_tid
(
ušt8_t
 *
š6
, cÚ¡ ušt8_ˆ*
tid
)

16 
i
;

19 
š6
[0] ^= 0x21;

20 
š6
[1] ^= 0x12;

21 
š6
[2] ^= 0xa4;

22 
š6
[3] ^= 0x42;

24 
i
=0; i<
STUN_TID_SIZE
; i++)

25 
š6
[4+
i
] ^ğ
tid
[i];

26 
	}
}

29 
	$¡un_addr_’code
(
mbuf
 *
mb
, cÚ¡ 
§
 *
addr
,

30 cÚ¡ 
ušt8_t
 *
tid
)

32 #ifdeà
HAVE_INET6


33 
ušt8_t
 
addr6
[16];

35 
ušt16_t
 
pÜt
;

36 
ušt32_t
 
addr4
;

37 
”r
 = 0;

39 ià(!
mb
 || !
addr
)

40  
EINVAL
;

42 
pÜt
 = 
tid
 ? 
	`§_pÜt
(
addr
)^(
STUN_MAGIC_COOKIE
>>16) : sa_port(addr);

44 
	`§_af
(
addr
)) {

46 
AF_INET
:

47 
addr4
 = 
tid
 ? 
	`§_š
(
addr
)^
STUN_MAGIC_COOKIE
 : sa_in(addr);

49 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0);

50 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
STUN_AF_IPv4
);

51 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
pÜt
));

52 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
addr4
));

55 #ifdeà
HAVE_INET6


56 
AF_INET6
:

57 
	`§_š6
(
addr
, 
addr6
);

58 ià(
tid
)

59 
	`š6_xÜ_tid
(
addr6
, 
tid
);

61 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0);

62 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
STUN_AF_IPv6
);

63 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
pÜt
));

64 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
addr6
, 16);

68 
”r
 = 
EAFNOSUPPORT
;

72  
”r
;

73 
	}
}

76 
	$¡un_addr_decode
(
mbuf
 *
mb
, 
§
 *
addr
, cÚ¡ 
ušt8_t
 *
tid
)

78 
ušt8_t
 
çmy
, 
addr6
[16];

79 
ušt32_t
 
addr4
;

80 
ušt16_t
 
pÜt
;

82 ià(!
mb
 || !
addr
)

83  
EINVAL
;

85 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

86  
EBADMSG
;

88 ()
	`mbuf_»ad_u8
(
mb
);

89 
çmy
 = 
	`mbuf_»ad_u8
(
mb
);

90 
pÜt
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

92 ià(
tid
)

93 
pÜt
 ^ğ
STUN_MAGIC_COOKIE
>>16;

95 
çmy
) {

97 
STUN_AF_IPv4
:

98 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

99  
EBADMSG
;

101 
addr4
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

102 ià(
tid
)

103 
addr4
 ^ğ
STUN_MAGIC_COOKIE
;

105 
	`§_£t_š
(
addr
, 
addr4
, 
pÜt
);

108 
STUN_AF_IPv6
:

109 ià(
	`mbuf_g‘_Ëá
(
mb
) < 16)

110  
EBADMSG
;

112 ()
	`mbuf_»ad_mem
(
mb
, 
addr6
, 16);

113 ià(
tid
)

114 
	`š6_xÜ_tid
(
addr6
, 
tid
);

116 
	`§_£t_š6
(
addr
, 
addr6
, 
pÜt
);

120  
EAFNOSUPPORT
;

124 
	}
}

	@re-0.5.6/src/stun/attr.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_fmt.h
>

12 
	~<»_sys.h
>

13 
	~<»_¡un.h
>

14 
	~"¡un.h
"

17 
	$¡r_decode
(
mbuf
 *
mb
, **
¡r
, 
size_t
 
Ën
)

19 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ën
)

20  
EBADMSG
;

22  
	`mbuf_¡rdup
(
mb
, 
¡r
, 
Ën
);

23 
	}
}

26 
	$de¡ruùÜ
(*
¬g
)

28 
¡un_©Œ
 *
©Œ
 = 
¬g
;

30 
©Œ
->
ty³
) {

32 
STUN_ATTR_USERNAME
:

33 
STUN_ATTR_REALM
:

34 
STUN_ATTR_NONCE
:

35 
STUN_ATTR_SOFTWARE
:

36 
	`mem_d”ef
(
©Œ
->
v
.
¡r
);

39 
STUN_ATTR_ERR_CODE
:

40 
	`mem_d”ef
(
©Œ
->
v
.
”r_code
.
»asÚ
);

43 
STUN_ATTR_DATA
:

44 
STUN_ATTR_PADDING
:

45 
	`mem_d”ef
(
©Œ
->
v
.
mb
.
buf
);

49 
	`li¡_uÆšk
(&
©Œ
->
Ë
);

50 
	}
}

53 
	$¡un_©Œ_’code
(
mbuf
 *
mb
, 
ušt16_t
 
ty³
, cÚ¡ *
v
,

54 cÚ¡ 
ušt8_t
 *
tid
, ušt8_ˆ
·ddšg
)

56 cÚ¡ 
¡un_chªge_»q
 *
ch_»q
 = 
v
;

57 cÚ¡ 
¡un_”rcode
 *
”r_code
 = 
v
;

58 cÚ¡ 
¡un_unknown_©Œ
 *
ua
 = 
v
;

59 cÚ¡ 
ušt32_t
 *
num32
 = 
v
;

60 cÚ¡ 
ušt16_t
 *
num16
 = 
v
;

61 cÚ¡ 
ušt8_t
 *
num8
 = 
v
;

62 cÚ¡ 
mbuf
 *
mbd
 = 
v
;

63 
size_t
 
¡¬t
, 
Ën
;

64 
ušt32_t
 
i
, 
n
;

65 
”r
 = 0;

67 ià(!
mb
 || !
v
)

68  
EINVAL
;

70 
mb
->
pos
 += 4;

71 
¡¬t
 = 
mb
->
pos
;

73 
ty³
) {

75 
STUN_ATTR_MAPPED_ADDR
:

76 
STUN_ATTR_ALT_SERVER
:

77 
STUN_ATTR_RESP_ORIGIN
:

78 
STUN_ATTR_OTHER_ADDR
:

79 
tid
 = 
NULL
;

81 
STUN_ATTR_XOR_PEER_ADDR
:

82 
STUN_ATTR_XOR_RELAY_ADDR
:

83 
STUN_ATTR_XOR_MAPPED_ADDR
:

84 
”r
 |ğ
	`¡un_addr_’code
(
mb
, 
v
, 
tid
);

87 
STUN_ATTR_CHANGE_REQ
:

88 
n
 = (
ušt32_t
)
ch_»q
->

 << 2 | (ušt32_t)ch_»q->
pÜt
 << 1;

89 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
n
));

92 
STUN_ATTR_USERNAME
:

93 
STUN_ATTR_REALM
:

94 
STUN_ATTR_NONCE
:

95 
STUN_ATTR_SOFTWARE
:

96 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, 
v
);

99 
STUN_ATTR_MSG_INTEGRITY
:

100 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
v
, 20);

103 
STUN_ATTR_ERR_CODE
:

104 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 0x00);

105 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
”r_code
->
code
/100);

106 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
”r_code
->
code
%100);

107 
”r
 |ğ
	`mbuf_wr™e_¡r
(
mb
, 
”r_code
->
»asÚ
);

110 
STUN_ATTR_UNKNOWN_ATTR
:

111 
i
=0; i<
ua
->
ty³c
; i++)

112 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
ua
->
ty³v
[
i
]));

115 
STUN_ATTR_CHANNEL_NUMBER
:

116 
STUN_ATTR_RESP_PORT
:

117 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(*
num16
));

118 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 0x0000);

121 
STUN_ATTR_LIFETIME
:

122 
STUN_ATTR_PRIORITY
:

123 
STUN_ATTR_FINGERPRINT
:

124 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(*
num32
));

127 
STUN_ATTR_DATA
:

128 
STUN_ATTR_PADDING
:

129 ià(
mb
 =ğ
mbd
) {

130 
mb
->
pos
 = mb->
’d
;

133 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
	`mbuf_buf
(
mbd
), 
	`mbuf_g‘_Ëá
(mbd));

136 
STUN_ATTR_REQ_ADDR_FAMILY
:

137 
STUN_ATTR_REQ_TRANSPORT
:

138 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, *
num8
);

139 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 0x00);

140 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 0x0000);

143 
STUN_ATTR_EVEN_PORT
:

144 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, ((
¡un_ev’_pÜt
 *)
v
)->
r
 << 7);

147 
STUN_ATTR_DONT_FRAGMENT
:

148 
STUN_ATTR_USE_CAND
:

152 
STUN_ATTR_RSV_TOKEN
:

153 
STUN_ATTR_CONTROLLED
:

154 
STUN_ATTR_CONTROLLING
:

155 
”r
 |ğ
	`mbuf_wr™e_u64
(
mb
, 
	`sys_htÚÎ
(*(
ušt64_t
 *)
v
));

159 
”r
 = 
EINVAL
;

164 
Ën
 = 
mb
->
pos
 - 
¡¬t
;

166 
mb
->
pos
 = 
¡¬t
 - 4;

167 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
ty³
));

168 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
Ën
));

169 
mb
->
pos
 +ğ
Ën
;

172 (
mb
->
pos
 - 
¡¬t
) & 0x03)

173 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, 
·ddšg
);

175  
”r
;

176 
	}
}

179 
	$¡un_©Œ_decode
(
¡un_©Œ
 **
©Œp
, 
mbuf
 *
mb
,

180 cÚ¡ 
ušt8_t
 *
tid
, 
¡un_unknown_©Œ
 *
ua
)

182 
¡un_©Œ
 *
©Œ
;

183 
size_t
 
¡¬t
, 
Ën
;

184 
ušt32_t
 
i
, 
n
;

185 
”r
 = 0;

187 ià(!
mb
 || !
©Œp
)

188  
EINVAL
;

190 ià(
	`mbuf_g‘_Ëá
(
mb
) < 4)

191  
EBADMSG
;

193 
©Œ
 = 
	`mem_z®loc
((*©Œ), 
de¡ruùÜ
);

194 ià(!
©Œ
)

195  
ENOMEM
;

197 
©Œ
->
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

198 
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

200 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
Ën
)

201 
badmsg
;

203 
¡¬t
 = 
mb
->
pos
;

205 
©Œ
->
ty³
) {

207 
STUN_ATTR_MAPPED_ADDR
:

208 
STUN_ATTR_ALT_SERVER
:

209 
STUN_ATTR_RESP_ORIGIN
:

210 
STUN_ATTR_OTHER_ADDR
:

211 
tid
 = 
NULL
;

213 
STUN_ATTR_XOR_PEER_ADDR
:

214 
STUN_ATTR_XOR_RELAY_ADDR
:

215 
STUN_ATTR_XOR_MAPPED_ADDR
:

216 
”r
 = 
	`¡un_addr_decode
(
mb
, &
©Œ
->
v
.
§
, 
tid
);

219 
STUN_ATTR_CHANGE_REQ
:

220 ià(
Ën
 != 4)

221 
badmsg
;

223 
n
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

224 
©Œ
->
v
.
chªge_»q
.

 = (
n
 >> 2) & 0x1;

225 
©Œ
->
v
.
chªge_»q
.
pÜt
 = (
n
 >> 1) & 0x1;

228 
STUN_ATTR_USERNAME
:

229 
STUN_ATTR_REALM
:

230 
STUN_ATTR_NONCE
:

231 
STUN_ATTR_SOFTWARE
:

232 
”r
 = 
	`¡r_decode
(
mb
, &
©Œ
->
v
.
¡r
, 
Ën
);

235 
STUN_ATTR_MSG_INTEGRITY
:

236 ià(
Ën
 != 20)

237 
badmsg
;

239 
”r
 = 
	`mbuf_»ad_mem
(
mb
, 
©Œ
->
v
.
msg_š‹gr™y
, 20);

242 
STUN_ATTR_ERR_CODE
:

243 ià(
Ën
 < 4)

244 
badmsg
;

246 
mb
->
pos
 += 2;

247 
©Œ
->
v
.
”r_code
.
code
 = (
	`mbuf_»ad_u8
(
mb
) & 0x7) * 100;

248 
©Œ
->
v
.
”r_code
.
code
 +ğ
	`mbuf_»ad_u8
(
mb
);

249 
”r
 = 
	`¡r_decode
(
mb
, &
©Œ
->
v
.
”r_code
.
»asÚ
, 
Ën
 - 4);

252 
STUN_ATTR_UNKNOWN_ATTR
:

253 
i
=0; i<
Ën
/2; i++) {

254 
ušt16_t
 
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

256 ià(
i
 >ğ
	`ARRAY_SIZE
(
©Œ
->
v
.
unknown_©Œ
.
ty³v
))

259 
©Œ
->
v
.
unknown_©Œ
.
ty³v
[
i
] = 
ty³
;

260 
©Œ
->
v
.
unknown_©Œ
.
ty³c
++;

264 
STUN_ATTR_CHANNEL_NUMBER
:

265 
STUN_ATTR_RESP_PORT
:

266 ià(
Ën
 < 2)

267 
badmsg
;

269 
©Œ
->
v
.
ušt16
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

272 
STUN_ATTR_LIFETIME
:

273 
STUN_ATTR_PRIORITY
:

274 
STUN_ATTR_FINGERPRINT
:

275 ià(
Ën
 != 4)

276 
badmsg
;

278 
©Œ
->
v
.
ušt32
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

281 
STUN_ATTR_DATA
:

282 
STUN_ATTR_PADDING
:

283 
©Œ
->
v
.
mb
.
buf
 = 
	`mem_»f
(mb->buf);

284 
©Œ
->
v
.
mb
.
size
 = mb->size;

285 
©Œ
->
v
.
mb
.
pos
 = mb->pos;

286 
©Œ
->
v
.
mb
.
’d
 = mb->
pos
 + 
Ën
;

287 
mb
->
pos
 +ğ
Ën
;

290 
STUN_ATTR_REQ_ADDR_FAMILY
:

291 
STUN_ATTR_REQ_TRANSPORT
:

292 ià(
Ën
 < 1)

293 
badmsg
;

295 
©Œ
->
v
.
ušt8
 = 
	`mbuf_»ad_u8
(
mb
);

298 
STUN_ATTR_EVEN_PORT
:

299 ià(
Ën
 < 1)

300 
badmsg
;

302 
©Œ
->
v
.
ev’_pÜt
.
r
 = (
	`mbuf_»ad_u8
(
mb
) >> 7) & 0x1;

305 
STUN_ATTR_DONT_FRAGMENT
:

306 
STUN_ATTR_USE_CAND
:

307 ià(
Ën
 > 0)

308 
badmsg
;

313 
STUN_ATTR_RSV_TOKEN
:

314 
STUN_ATTR_CONTROLLING
:

315 
STUN_ATTR_CONTROLLED
:

316 ià(
Ën
 != 8)

317 
badmsg
;

319 
©Œ
->
v
.
ušt64
 = 
	`sys_ÁohÎ
(
	`mbuf_»ad_u64
(
mb
));

323 
mb
->
pos
 +ğ
Ën
;

325 ià(
©Œ
->
ty³
 >= 0x8000)

328 ià(
ua
 && ua->
ty³c
 < 
	`ARRAY_SIZE
(ua->
ty³v
))

329 
ua
->
ty³v
[ua->
ty³c
++] = 
©Œ
->
ty³
;

333 ià(
”r
)

334 
”rÜ
;

337 ((
mb
->
pos
 - 
¡¬t
è& 0x03è&& 
	`mbuf_g‘_Ëá
(mb))

338 ++
mb
->
pos
;

340 *
©Œp
 = 
©Œ
;

344 
badmsg
:

345 
”r
 = 
EBADMSG
;

346 
”rÜ
:

347 
	`mem_d”ef
(
©Œ
);

349  
”r
;

350 
	}
}

360 cÚ¡ *
	$¡un_©Œ_Çme
(
ušt16_t
 
ty³
)

362 
ty³
) {

364 
STUN_ATTR_MAPPED_ADDR
:  "MAPPED-ADDRESS";

365 
STUN_ATTR_CHANGE_REQ
:  "CHANGE-REQUEST";

366 
STUN_ATTR_USERNAME
:  "USERNAME";

367 
STUN_ATTR_MSG_INTEGRITY
:  "MESSAGE-INTEGRITY";

368 
STUN_ATTR_ERR_CODE
:  "ERROR-CODE";

369 
STUN_ATTR_UNKNOWN_ATTR
:  "UNKNOWN-ATTRIBUTE";

370 
STUN_ATTR_CHANNEL_NUMBER
:  "CHANNEL-NUMBER";

371 
STUN_ATTR_LIFETIME
:  "LIFETIME";

372 
STUN_ATTR_XOR_PEER_ADDR
:  "XOR-PEER-ADDRESS";

373 
STUN_ATTR_DATA
:  "DATA";

374 
STUN_ATTR_REALM
:  "REALM";

375 
STUN_ATTR_NONCE
:  "NONCE";

376 
STUN_ATTR_XOR_RELAY_ADDR
:  "XOR-RELAYED-ADDRESS";

377 
STUN_ATTR_REQ_ADDR_FAMILY
:  "REQUESTED-ADDRESS-FAMILY";

378 
STUN_ATTR_EVEN_PORT
:  "EVEN_PORT";

379 
STUN_ATTR_REQ_TRANSPORT
:  "REQUESTED-TRANSPORT";

380 
STUN_ATTR_DONT_FRAGMENT
:  "DONT-FRAGMENT";

381 
STUN_ATTR_XOR_MAPPED_ADDR
:  "XOR-MAPPED-ADDRESS";

382 
STUN_ATTR_RSV_TOKEN
:  "RESERVATION-TOKEN";

383 
STUN_ATTR_PRIORITY
:  "PRIORITY";

384 
STUN_ATTR_USE_CAND
:  "USE-CANDIDATE";

385 
STUN_ATTR_PADDING
:  "PADDING";

386 
STUN_ATTR_RESP_PORT
:  "RESPONSE-PORT";

387 
STUN_ATTR_SOFTWARE
:  "SOFTWARE";

388 
STUN_ATTR_ALT_SERVER
:  "ALTERNATE-SERVER";

389 
STUN_ATTR_FINGERPRINT
:  "FINGERPRINT";

390 
STUN_ATTR_CONTROLLING
:  "ICE-CONTROLLING";

391 
STUN_ATTR_CONTROLLED
:  "ICE-CONTROLLED";

392 
STUN_ATTR_RESP_ORIGIN
:  "RESPONSE-ORIGIN";

393 
STUN_ATTR_OTHER_ADDR
:  "OTHER-ADDR";

396 
	}
}

399 
	$¡un_©Œ_dump
(cÚ¡ 
¡un_©Œ
 *
a
)

401 
ušt32_t
 
i
;

402 
size_t
 
Ën
;

404 ià(!
a
)

407 ()
	`»_´štf
(" %-25s", 
	`¡un_©Œ_Çme
(
a
->
ty³
));

409 
a
->
ty³
) {

411 
STUN_ATTR_MAPPED_ADDR
:

412 
STUN_ATTR_XOR_PEER_ADDR
:

413 
STUN_ATTR_XOR_RELAY_ADDR
:

414 
STUN_ATTR_XOR_MAPPED_ADDR
:

415 
STUN_ATTR_ALT_SERVER
:

416 
STUN_ATTR_RESP_ORIGIN
:

417 
STUN_ATTR_OTHER_ADDR
:

418 ()
	`»_´štf
("%J", &
a
->
v
.
§
);

421 
STUN_ATTR_CHANGE_REQ
:

422 ()
	`»_´štf
("=%u…Üt=%u", 
a
->
v
.
chªge_»q
.

,

423 
a
->
v
.
chªge_»q
.
pÜt
);

426 
STUN_ATTR_USERNAME
:

427 
STUN_ATTR_REALM
:

428 
STUN_ATTR_NONCE
:

429 
STUN_ATTR_SOFTWARE
:

430 ()
	`»_´štf
("%s", 
a
->
v
.
¡r
);

433 
STUN_ATTR_MSG_INTEGRITY
:

434 ()
	`»_´štf
("%w", 
a
->
v
.
msg_š‹gr™y
,

435 (
a
->
v
.
msg_š‹gr™y
));

438 
STUN_ATTR_ERR_CODE
:

439 ()
	`»_´štf
("%u %s", 
a
->
v
.
”r_code
.
code
,

440 
a
->
v
.
”r_code
.
»asÚ
);

443 
STUN_ATTR_UNKNOWN_ATTR
:

444 
i
=0; i<
a
->
v
.
unknown_©Œ
.
ty³c
; i++)

445 ()
	`»_´štf
("0x%04x ", 
a
->
v
.
unknown_©Œ
.
ty³v
[
i
]);

448 
STUN_ATTR_CHANNEL_NUMBER
:

449 ()
	`»_´štf
("0x%04x", 
a
->
v
.
ušt16
);

452 
STUN_ATTR_LIFETIME
:

453 
STUN_ATTR_PRIORITY
:

454 ()
	`»_´štf
("%u", 
a
->
v
.
ušt32
);

457 
STUN_ATTR_DATA
:

458 
STUN_ATTR_PADDING
:

459 
Ën
 = 
	`mš
(
	`mbuf_g‘_Ëá
(&
a
->
v
.
mb
), 16);

460 ()
	`»_´štf
("%w% (%zu by‹s)", 
	`mbuf_buf
(&
a
->
v
.
mb
), 
Ën
,

461 
	`mbuf_g‘_Ëá
(&
a
->
v
.
mb
) > 16 ? "..." : "",

462 
	`mbuf_g‘_Ëá
(&
a
->
v
.
mb
));

465 
STUN_ATTR_REQ_ADDR_FAMILY
:

466 
STUN_ATTR_REQ_TRANSPORT
:

467 ()
	`»_´štf
("%u", 
a
->
v
.
ušt8
);

470 
STUN_ATTR_EVEN_PORT
:

471 ()
	`»_´štf
("r=%u", 
a
->
v
.
ev’_pÜt
.
r
);

474 
STUN_ATTR_DONT_FRAGMENT
:

475 
STUN_ATTR_USE_CAND
:

479 
STUN_ATTR_RSV_TOKEN
:

480 ()
	`»_´štf
("0x%016Îx", 
a
->
v
.
rsv_tok’
);

483 
STUN_ATTR_RESP_PORT
:

484 ()
	`»_´štf
("%u", 
a
->
v
.
ušt16
);

487 
STUN_ATTR_FINGERPRINT
:

488 ()
	`»_´štf
("0x%08x", 
a
->
v
.
fšg”´št
);

491 
STUN_ATTR_CONTROLLING
:

492 
STUN_ATTR_CONTROLLED
:

493 ()
	`»_´štf
("%Îu", 
a
->
v
.
ušt64
);

497 ()
	`»_´štf
("???");

501 ()
	`»_´štf
("\n");

502 
	}
}

	@re-0.5.6/src/stun/ctrans.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_udp.h
>

13 
	~<»_tı.h
>

14 
	~<»_¤.h
>

15 
	~<»_s.h
>

16 
	~<»_li¡.h
>

17 
	~<»_tmr.h
>

18 
	~<»_md5.h
>

19 
	~<»_¡un.h
>

20 
	~"¡un.h
"

23 
	s¡un_ù¿ns
 {

24 
Ë
 
	mË
;

25 
tmr
 
	mtmr
;

26 
§
 
	md¡
;

27 
ušt8_t
 
	mtid
[
STUN_TID_SIZE
];

28 
¡un_ù¿ns
 **
	mùp
;

29 
ušt8_t
 *
	mkey
;

30 
size_t
 
	mkeyËn
;

31 *
	msock
;

32 
mbuf
 *
	mmb
;

33 
size_t
 
	mpos
;

34 
¡un
 *
	m¡un
;

35 
¡un_»¥_h
 *
	m»¥h
;

36 *
	m¬g
;

37 
	m´Ùo
;

38 
ušt32_t
 
	mtxc
;

39 
ušt32_t
 
	miv®
;

40 
ušt16_t
 
	mm‘
;

44 
	$com¶‘ed
(
¡un_ù¿ns
 *
ù
, 
”r
, 
ušt16_t
 
scode
,

45 cÚ¡ *
»asÚ
, cÚ¡ 
¡un_msg
 *
msg
)

47 
¡un_»¥_h
 *
»¥h
 = 
ù
->resph;

48 *
¬g
 = 
ù
->arg;

50 
	`li¡_uÆšk
(&
ù
->
Ë
);

51 
	`tmr_ÿnûl
(&
ù
->
tmr
);

53 ià(
ù
->
ùp
) {

54 *
ù
->
ùp
 = 
NULL
;

55 
ù
->
ùp
 = 
NULL
;

58 
ù
->
»¥h
 = 
NULL
;

61 
	`mem_d”ef
(
ù
);

63 ià(
»¥h
)

64 
	`»¥h
(
”r
, 
scode
, 
»asÚ
, 
msg
, 
¬g
);

65 
	}
}

68 
	$de¡ruùÜ
(*
¬g
)

70 
¡un_ù¿ns
 *
ù
 = 
¬g
;

72 
	`li¡_uÆšk
(&
ù
->
Ë
);

73 
	`tmr_ÿnûl
(&
ù
->
tmr
);

74 
	`mem_d”ef
(
ù
->
key
);

75 
	`mem_d”ef
(
ù
->
sock
);

76 
	`mem_d”ef
(
ù
->
mb
);

77 
	}
}

80 
	$timeout_hªdËr
(*
¬g
)

82 
¡un_ù¿ns
 *
ù
 = 
¬g
;

83 cÚ¡ 
¡un_cÚf
 *
cfg
 = 
	`¡un_cÚf
(
ù
->
¡un
);

84 
”r
 = 
ETIMEDOUT
;

86 ià(
ù
->
txc
++ >ğ
cfg
->
rc
)

87 
”rÜ
;

89 
ù
->
mb
->
pos
 = ct->pos;

91 
”r
 = 
	`¡un_£nd
(
ù
->
´Ùo
, ct->
sock
, &ù->
d¡
, ct->
mb
);

92 ià(
”r
)

93 
”rÜ
;

95 
ù
->
iv®
 = (ù->
txc
 >ğ
cfg
->
rc
è? cfg->
¹o
 * cfg->
rm
 : ct->ival * 2;

97 
	`tmr_¡¬t
(&
ù
->
tmr
, ct->
iv®
, 
timeout_hªdËr
, ct);

100 
”rÜ
:

101 
	`com¶‘ed
(
ù
, 
”r
, 0, 
NULL
, NULL);

102 
	}
}

105 
boŞ
 
	$m©ch_hªdËr
(
Ë
 *Ë, *
¬g
)

107 
¡un_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

108 
¡un_msg
 *
msg
 = 
¬g
;

110 ià(
ù
->
m‘
 !ğ
	`¡un_msg_m‘hod
(
msg
))

111  
çl£
;

113 ià(
	`memcmp
(
ù
->
tid
, 
	`¡un_msg_tid
(
msg
), 
STUN_TID_SIZE
))

114  
çl£
;

116  
Œue
;

117 
	}
}

120 
	$udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

122 
¡un
 *¡uÀğ
¬g
;

123 ()
¤c
;

125 ()
	`¡un_»cv
(
¡un
, 
mb
);

126 
	}
}

129 
	$tı_»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

131 
¡un_ù¿ns
 *
ù
 = 
¬g
;

133 ()
	`¡un_»cv
(
ù
->
¡un
, 
mb
);

134 
	}
}

137 
	$tı_e¡ab_hªdËr
(*
¬g
)

139 
¡un_ù¿ns
 *
ù
 = 
¬g
;

140 
”r
;

142 
”r
 = 
	`tı_£nd
(
ù
->
sock
, ct->
mb
);

143 ià(!
”r
)

146 
	`com¶‘ed
(
ù
, 
”r
, 0, 
NULL
, NULL);

147 
	}
}

150 
	$tı_şo£_hªdËr
(
”r
, *
¬g
)

152 
¡un_ù¿ns
 *
ù
 = 
¬g
;

154 
	`com¶‘ed
(
ù
, 
”r
, 0, 
NULL
, NULL);

155 
	}
}

167 
	$¡un_ù¿ns_»cv
(
¡un
 *¡un, cÚ¡ 
¡un_msg
 *
msg
,

168 cÚ¡ 
¡un_unknown_©Œ
 *
ua
)

170 
¡un_”rcode
 
ec
 = {0, "OK"};

171 
¡un_©Œ
 *
”rcode
;

172 
¡un_ù¿ns
 *
ù
;

173 
”r
 = 0, 
h”r
 = 0;

175 ià(!
¡un
 || !
msg
 || !
ua
)

176  
EINVAL
;

178 
	`¡un_msg_şass
(
msg
)) {

180 
STUN_CLASS_ERROR_RESP
:

181 
”rcode
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_ERR_CODE
);

182 ià(!
”rcode
)

183 
h”r
 = 
EPROTO
;

185 
ec
 = 
”rcode
->
v
.
”r_code
;

188 
STUN_CLASS_SUCCESS_RESP
:

189 
ù
 = 
	`li¡_Ëd©a
(
	`li¡_­¶y
(&
¡un
->
ùl
, 
Œue
,

190 
m©ch_hªdËr
, (*)
msg
));

191 ià(!
ù
) {

192 
”r
 = 
ENOENT
;

196 
ec
.
code
) {

203 ià(!
ù
->
key
)

206 
”r
 = 
	`¡un_msg_chk_mi
(
msg
, 
ù
->
key
, ct->
keyËn
);

210 ià(
”r
)

213 ià(!
h”r
 && 
ua
->
ty³c
 > 0)

214 
h”r
 = 
EPROTO
;

216 
	`com¶‘ed
(
ù
, 
h”r
, 
ec
.
code
,ƒc.
»asÚ
, 
msg
);

223  
”r
;

224 
	}
}

227 
	$¡un_ù¿ns_»que¡
(
¡un_ù¿ns
 **
ùp
, 
¡un
 *¡un, 
´Ùo
,

228 *
sock
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
,

229 cÚ¡ 
ušt8_t
 
tid
[], 
ušt16_t
 
m‘
, cÚ¡ ušt8_ˆ*
key
,

230 
size_t
 
keyËn
, 
¡un_»¥_h
 *
»¥h
, *
¬g
)

232 
¡un_ù¿ns
 *
ù
;

233 
”r
 = 0;

235 ià(!
¡un
 || !
mb
)

236  
EINVAL
;

238 
ù
 = 
	`mem_z®loc
((*ù), 
de¡ruùÜ
);

239 ià(!
ù
)

240  
ENOMEM
;

242 
	`li¡_­³nd
(&
¡un
->
ùl
, &
ù
->
Ë
, ct);

243 
	`memıy
(
ù
->
tid
,id, 
STUN_TID_SIZE
);

244 
ù
->
´Ùo
 =…roto;

245 
ù
->
sock
 = 
	`mem_»f
(sock);

246 
ù
->
mb
 = 
	`mem_»f
(mb);

247 
ù
->
pos
 = 
mb
->pos;

248 
ù
->
¡un
 = stun;

249 
ù
->
m‘
 = met;

251 ià(
key
) {

252 
ù
->
key
 = 
	`mem_®loc
(
keyËn
, 
NULL
);

253 ià(!
ù
->
key
) {

254 
”r
 = 
ENOMEM
;

255 
out
;

258 
	`memıy
(
ù
->
key
, key, 
keyËn
);

259 
ù
->
keyËn
 = keylen;

262 
´Ùo
) {

264 
IPPROTO_UDP
:

265 ià(!
d¡
) {

266 
”r
 = 
EINVAL
;

270 
ù
->
d¡
 = *dst;

271 
ù
->
iv®
 = 
	`¡un_cÚf
(
¡un
)->
¹o
;

272 
	`tmr_¡¬t
(&
ù
->
tmr
, ct->
iv®
, 
timeout_hªdËr
, ct);

274 ià(!
sock
) {

275 
”r
 = 
	`udp_li¡’
((
udp_sock
 **)&
ù
->
sock
, 
NULL
,

276 
udp_»cv_hªdËr
, 
¡un
);

277 ià(
”r
)

281 
ù
->
txc
 = 1;

282 
”r
 = 
	`udp_£nd
(
ù
->
sock
, 
d¡
, 
mb
);

285 
IPPROTO_TCP
:

286 
ù
->
txc
 = 
	`¡un_cÚf
(
¡un
)->
rc
;

287 
	`tmr_¡¬t
(&
ù
->
tmr
, 
	`¡un_cÚf
(
¡un
)->
ti
, 
timeout_hªdËr
, ct);

288 ià(
sock
) {

289 
”r
 = 
	`tı_£nd
(
sock
, 
mb
);

293 
”r
 = 
	`tı_cÚÃù
((
tı_cÚn
 **)&
ù
->
sock
, 
d¡
,

294 
tı_e¡ab_hªdËr
, 
tı_»cv_hªdËr
,

295 
tı_şo£_hªdËr
, 
ù
);

298 #ifdeà
USE_DTLS


299 
STUN_TRANSP_DTLS
:

300 ià(!
sock
) {

301 
”r
 = 
EINVAL
;

305 
ù
->
iv®
 = 
	`¡un_cÚf
(
¡un
)->
¹o
;

306 
	`tmr_¡¬t
(&
ù
->
tmr
, ct->
iv®
, 
timeout_hªdËr
, ct);

308 
ù
->
txc
 = 1;

309 
”r
 = 
	`ds_£nd
(
ù
->
sock
, 
mb
);

314 
”r
 = 
EPROTONOSUPPORT
;

318 
out
:

319 ià(!
”r
) {

320 ià(
ùp
) {

321 
ù
->
ùp
 = ctp;

322 *
ùp
 = 
ù
;

325 
ù
->
»¥h
 =„esph;

326 
ù
->
¬g
 =‡rg;

329 
	`mem_d”ef
(
ù
);

331  
”r
;

332 
	}
}

335 
boŞ
 
	$şo£_hªdËr
(
Ë
 *Ë, *
¬g
)

337 
¡un_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

338 ()
¬g
;

340 
	`com¶‘ed
(
ù
, 
ECONNABORTED
, 0, 
NULL
, NULL);

342  
çl£
;

343 
	}
}

346 
	$¡un_ù¿ns_şo£
(
¡un
 *stun)

348 ià(!
¡un
)

351 ()
	`li¡_­¶y
(&
¡un
->
ùl
, 
Œue
, 
şo£_hªdËr
, 
NULL
);

352 
	}
}

355 
boŞ
 
	$debug_hªdËr
(
Ë
 *Ë, *
¬g
)

357 
¡un_ù¿ns
 *
ù
 = 
Ë
->
d©a
;

358 
»_´štf
 *
pf
 = 
¬g
;

359 
”r
 = 0;

361 
”r
 |ğ
	`»_h´štf
(
pf
, " m‘hod=%s", 
	`¡un_m‘hod_Çme
(
ù
->
m‘
));

362 
”r
 |ğ
	`»_h´štf
(
pf
, "id=%w", 
ù
->
tid
, (ct->tid));

363 
”r
 |ğ
	`»_h´štf
(
pf
, "„to=%ums", 
	`¡un_cÚf
(
ù
->
¡un
)->
¹o
);

364 
”r
 |ğ
	`»_h´štf
(
pf
, "mr=%Îu", 
	`tmr_g‘_expœe
(&
ù
->
tmr
));

365 
”r
 |ğ
	`»_h´štf
(
pf
, "‚=%u", 
ù
->
txc
);

366 
”r
 |ğ
	`»_h´štf
(
pf
, " iÁ”v®=%u", 
ù
->
iv®
);

367 
”r
 |ğ
	`»_h´štf
(
pf
, "\n");

369  0 !ğ
”r
;

370 
	}
}

373 
	$¡un_ù¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡un
 *stun)

375 
”r
;

377 ià(!
¡un
)

380 
”r
 = 
	`»_h´štf
(
pf
, "STUN clientransactions: (%u)\n",

381 
	`li¡_couÁ
(&
¡un
->
ùl
));

383 ()
	`li¡_­¶y
(&
¡un
->
ùl
, 
Œue
, 
debug_hªdËr
, 
pf
);

385  
”r
;

386 
	}
}

	@re-0.5.6/src/stun/dnsdisc.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_li¡.h
>

12 
	~<»_§.h
>

13 
	~<»_dns.h
>

14 
	~<»_¡un.h
>

17 
	#DEBUG_MODULE
 "dnsdisc"

	)

18 
	#DEBUG_LEVEL
 5

	)

19 
	~<»_dbg.h
>

23 
	s¡un_dns
 {

24 
	mdomaš
[256];

25 
¡un_dns_h
 *
	mdnsh
;

26 *
	m¬g
;

27 
§
 
	m¤v
;

28 
dnsc
 *
	mdnsc
;

29 
dns_qu”y
 *
	mdq
;

30 
	maf
;

31 
ušt16_t
 
	mpÜt
;

34 cÚ¡ *
	g¡un_´Ùo_udp
 = "udp";

35 cÚ¡ *
	g¡un_´Ùo_tı
 = "tcp";

37 cÚ¡ *
	g¡un_u§ge_bšdšg
 = "stun";

38 cÚ¡ *
	g¡uns_u§ge_bšdšg
 = "stuns";

39 cÚ¡ *
	g¡un_u§ge_»Ïy
 = "turn";

40 cÚ¡ *
	g¡uns_u§ge_»Ïy
 = "turns";

41 cÚ¡ *
	g¡un_u§ge_behaviÜ
 = "stun-behavior";

42 cÚ¡ *
	g¡uns_u§ge_behaviÜ
 = "stun-behaviors";

45 
	$»sŞved
(cÚ¡ 
¡un_dns
 *
dns
, 
”r
)

47 
¡un_dns_h
 *
dnsh
 = 
dns
->dnsh;

48 *
dnsh_¬g
 = 
dns
->
¬g
;

50 
	`DEBUG_INFO
("»sŞved: %J (%m)\n", &
dns
->
¤v
, 
”r
);

52 
	`dnsh
(
”r
, &
dns
->
¤v
, 
dnsh_¬g
);

53 
	}
}

56 
	$a_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

57 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

59 
¡un_dns
 *
dns
 = 
¬g
;

60 
dn¤r
 *
¼
;

62 ()
hdr
;

63 ()
authl
;

64 ()
addl
;

67 
¼
 = 
	`dns_¼li¡_fšd
(
ª¦
, 
NULL
, 
DNS_TYPE_A
, 
DNS_CLASS_IN
, 
çl£
);

68 ià(!
¼
) {

69 
”r
 =ƒ¼ ?ƒ¼ : 
EDESTADDRREQ
;

70 
out
;

73 
	`§_£t_š
(&
dns
->
¤v
, 
¼
->
rd©a
.
a
.
addr
, 
	`§_pÜt
(&dns->srv));

75 
	`DEBUG_INFO
("A‡nsw”: %j\n", &
dns
->
¤v
);

77 
out
:

78 
	`»sŞved
(
dns
, 
”r
);

79 
	}
}

82 #ifdeà
HAVE_INET6


83 
	$¯¯_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

84 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

86 
¡un_dns
 *
dns
 = 
¬g
;

87 
dn¤r
 *
¼
;

89 ()
hdr
;

90 ()
authl
;

91 ()
addl
;

94 
¼
 = 
	`dns_¼li¡_fšd
(
ª¦
, 
NULL
, 
DNS_TYPE_AAAA
, 
DNS_CLASS_IN
, 
çl£
);

95 ià(!
¼
) {

96 
”r
 =ƒ¼ ?ƒ¼ : 
EDESTADDRREQ
;

97 
out
;

100 
	`§_£t_š6
(&
dns
->
¤v
, 
¼
->
rd©a
.
¯¯
.
addr
, 
	`§_pÜt
(&dns->srv));

102 
	`DEBUG_INFO
("AAAA‡nsw”: %j\n", &
dns
->
¤v
);

104 
out
:

105 
	`»sŞved
(
dns
, 
”r
);

106 
	}
}

110 
	$a_Ü_¯¯_qu”y
(
¡un_dns
 *
dns
, cÚ¡ *
Çme
)

112 
dns
->
dq
 = 
	`mem_d”ef
(dns->dq);

114 
dns
->
af
) {

116 
AF_INET
:

117  
	`dnsc_qu”y
(&
dns
->
dq
, dns->
dnsc
, 
Çme
, 
DNS_TYPE_A
,

118 
DNS_CLASS_IN
, 
Œue
, 
a_hªdËr
, 
dns
);

120 #ifdeà
HAVE_INET6


121 
AF_INET6
:

122  
	`dnsc_qu”y
(&
dns
->
dq
, dns->
dnsc
, 
Çme
, 
DNS_TYPE_AAAA
,

123 
DNS_CLASS_IN
, 
Œue
, 
¯¯_hªdËr
, 
dns
);

127  
EAFNOSUPPORT
;

129 
	}
}

132 
	$¤v_hªdËr
(
”r
, cÚ¡ 
dnshdr
 *
hdr
, 
li¡
 *
ª¦
,

133 
li¡
 *
authl
, li¡ *
addl
, *
¬g
)

135 
¡un_dns
 *
dns
 = 
¬g
;

136 
dn¤r
 *
¼
, *
¬r
;

138 ()
hdr
;

139 ()
authl
;

141 
	`dns_¼li¡_sÜt
(
ª¦
, 
DNS_TYPE_SRV
, (
size_t
)
dns
->
¬g
);

144 
¼
 = 
	`dns_¼li¡_fšd
(
ª¦
, 
NULL
, 
DNS_TYPE_SRV
, 
DNS_CLASS_IN
, 
çl£
);

145 ià(!
¼
) {

146 
	`DEBUG_INFO
("no SRVƒntry,rying A†ookup on \"%s\"\n",

147 
dns
->
domaš
);

149 
	`§_£t_š
(&
dns
->
¤v
, 0, dns->
pÜt
);

151 
”r
 = 
	`a_Ü_¯¯_qu”y
(
dns
, dns->
domaš
);

152 ià(
”r
)

153 
out
;

158 
	`DEBUG_INFO
("SRV‡nsw”: %s:%u\n", 
¼
->
rd©a
.
¤v
.
rg‘
,

159 
¼
->
rd©a
.
¤v
.
pÜt
);

162 
dns
->
af
) {

164 
AF_INET
:

165 
¬r
 = 
	`dns_¼li¡_fšd
(
addl
, 
¼
->
rd©a
.
¤v
.
rg‘
,

166 
DNS_TYPE_A
, 
DNS_CLASS_IN
, 
Œue
);

167 ià(
¬r
) {

168 
	`§_£t_š
(&
dns
->
¤v
, 
¬r
->
rd©a
.
a
.
addr
,

169 
¼
->
rd©a
.
¤v
.
pÜt
);

170 
	`DEBUG_INFO
("add™iÚ® A: %j\n", &
dns
->
¤v
);

171 
out
;

175 #ifdeà
HAVE_INET6


176 
AF_INET6
:

177 
¬r
 = 
	`dns_¼li¡_fšd
(
addl
, 
¼
->
rd©a
.
¤v
.
rg‘
,

178 
DNS_TYPE_AAAA
, 
DNS_CLASS_IN
, 
Œue
);

179 ià(
¬r
) {

180 
	`§_£t_š6
(&
dns
->
¤v
, 
¬r
->
rd©a
.
¯¯
.
addr
,

181 
¼
->
rd©a
.
¤v
.
pÜt
);

182 
	`DEBUG_INFO
("add™iÚ® AAAA: %j\n", &
dns
->
¤v
);

183 
out
;

189 
	`§_£t_š
(&
dns
->
¤v
, 0, 
¼
->
rd©a
.¤v.
pÜt
);

191 
”r
 = 
	`a_Ü_¯¯_qu”y
(
dns
, 
¼
->
rd©a
.
¤v
.
rg‘
);

192 ià(
”r
) {

193 
	`DEBUG_WARNING
("SRV: A†ooku°çed (%m)\n", 
”r
);

194 
out
;

197 
	`DEBUG_INFO
("SRV handler: doing A/AAAA†ookup..\n");

201 
out
:

202 
	`»sŞved
(
dns
, 
”r
);

203 
	}
}

206 
	$dnsdisc_de¡ruùÜ
(*
d©a
)

208 
¡un_dns
 *
dns
 = 
d©a
;

210 
	`mem_d”ef
(
dns
->
dq
);

211 
	}
}

229 
	$¡un_£rv”_discov”
(
¡un_dns
 **
dn¥
, 
dnsc
 *dnsc,

230 cÚ¡ *
£rviû
, cÚ¡ *
´Ùo
,

231 
af
, cÚ¡ *
domaš
, 
ušt16_t
 
pÜt
,

232 
¡un_dns_h
 *
dnsh
, *
¬g
)

234 
¡un_dns
 *
dns
;

235 
”r
;

237 ià(!
dn¥
 || !
£rviû
 || !
´Ùo
 || !
domaš
 || !domaš[0] || !
dnsh
)

238  
EINVAL
;

240 
dns
 = 
	`mem_z®loc
((*dns), 
dnsdisc_de¡ruùÜ
);

241 ià(!
dns
)

242  
ENOMEM
;

244 
dns
->
pÜt
 = 
£rviû
[
	`¡¾’
(£rviû)-1] =ğ's' ? 
STUNS_PORT
 : 
STUN_PORT
;

245 
dns
->
dnsh
 = dnsh;

246 
dns
->
¬g
 =‡rg;

247 
dns
->
dnsc
 = dnsc;

248 
dns
->
af
 =‡f;

251 ià(0 =ğ
	`§_£t_¡r
(&
dns
->
¤v
, 
domaš
, 
pÜt
 ?…ort : dns->port)) {

253 
	`DEBUG_INFO
("IP (%s)\n", 
domaš
);

255 
	`»sŞved
(
dns
, 0);

256 
”r
 = 0;

257 
out
;

260 ià(
pÜt
) {

261 
	`§_£t_š
(&
dns
->
¤v
, 0, 
pÜt
);

262 
	`DEBUG_INFO
("»sŞvšg A qu”y: (%s)\n", 
domaš
);

264 
”r
 = 
	`a_Ü_¯¯_qu”y
(
dns
, 
domaš
);

265 ià(
”r
) {

266 
	`DEBUG_WARNING
("%s: A/AAAA†ookup failed (%m)\n",

267 
domaš
, 
”r
);

268 
out
;

273 
q
[256];

274 
	`¡r_nıy
(
dns
->
domaš
, domain, (dns->domain));

275 ()
	`»_¢´štf
(
q
, (q), "_%s._%s.%s", 
£rviû
, 
´Ùo
,

276 
domaš
);

277 
	`DEBUG_INFO
("»sŞvšg SRV qu”y: (%s)\n", 
q
);

278 
”r
 = 
	`dnsc_qu”y
(&
dns
->
dq
, 
dnsc
, 
q
, 
DNS_TYPE_SRV
, 
DNS_CLASS_IN
,

279 
Œue
, 
¤v_hªdËr
, 
dns
);

280 ià(
”r
) {

281 
	`DEBUG_WARNING
("%s: SRV†ooku°çed (%m)\n", 
q
, 
”r
);

282 
out
;

286 *
dn¥
 = 
dns
;

290 
out
:

291 
	`mem_d”ef
(
dns
);

292  
”r
;

293 
	}
}

	@re-0.5.6/src/stun/hdr.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_§.h
>

9 
	~<»_li¡.h
>

10 
	~<»_¡un.h
>

11 
	~"¡un.h
"

14 
	$¡un_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
¡un_hdr
 *
hdr
)

16 
”r
 = 0;

18 ià(!
mb
 || !
hdr
)

19  
EINVAL
;

21 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
ty³
 & 0x3fff));

22 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Ën
));

23 
”r
 |ğ
	`mbuf_wr™e_u32
(
mb
, 
	`htÚl
(
hdr
->
cook›
));

24 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
hdr
->
tid
, (hdr->tid));

26  
”r
;

27 
	}
}

30 
	$¡un_hdr_decode
(
mbuf
 *
mb
, 
¡un_hdr
 *
hdr
)

32 ià(!
mb
 || !
hdr
)

33  
EINVAL
;

35 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
STUN_HEADER_SIZE
)

36  
EBADMSG
;

38 
hdr
->
ty³
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

39 ià(
hdr
->
ty³
 & 0xc000)

40  
EBADMSG
;

42 
hdr
->
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

43 ià(
hdr
->
Ën
 & 0x3)

44  
EBADMSG
;

46 
hdr
->
cook›
 = 
	`Áohl
(
	`mbuf_»ad_u32
(
mb
));

47 ()
	`mbuf_»ad_mem
(
mb
, 
hdr
->
tid
, (hdr->tid));

49 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
hdr
->
Ën
)

50  
EBADMSG
;

53 
	}
}

56 cÚ¡ *
	$¡un_şass_Çme
(
ušt16_t
 
şass
)

58 
şass
) {

60 
STUN_CLASS_REQUEST
:  "Request";

61 
STUN_CLASS_INDICATION
:  "Indication";

62 
STUN_CLASS_SUCCESS_RESP
:  "Success Response";

63 
STUN_CLASS_ERROR_RESP
:  "Error Response";

66 
	}
}

69 cÚ¡ *
	$¡un_m‘hod_Çme
(
ušt16_t
 
m‘hod
)

71 
m‘hod
) {

73 
STUN_METHOD_BINDING
:  "Binding";

74 
STUN_METHOD_ALLOCATE
:  "Allocate";

75 
STUN_METHOD_REFRESH
:  "Refresh";

76 
STUN_METHOD_SEND
:  "Send";

77 
STUN_METHOD_DATA
:  "Data";

78 
STUN_METHOD_CREATEPERM
:  "CreatePermission";

79 
STUN_METHOD_CHANBIND
:  "ChannelBind";

82 
	}
}

	@re-0.5.6/src/stun/ind.c

6 
	~<»_ty³s.h
>

7 
	~<»_sys.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_¡un.h
>

13 
	~"¡un.h
"

33 
	$¡un_šdiÿtiÚ
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

34 
ušt16_t
 
m‘hod
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

35 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...)

37 
ušt8_t
 
tid
[
STUN_TID_SIZE
];

38 
mbuf
 *
mb
;

39 
va_li¡
 
­
;

40 
ušt32_t
 
i
;

41 
”r
;

43 ià(!
sock
)

44  
EINVAL
;

46 
mb
 = 
	`mbuf_®loc
(2048);

47 ià(!
mb
)

48  
ENOMEM
;

50 
i
=0; i<
STUN_TID_SIZE
; i++)

51 
tid
[
i
] = 
	`¿nd_u32
();

53 
	`va_¡¬t
(
­
, 
©Œc
);

54 
mb
->
pos
 = 
´esz
;

55 
”r
 = 
	`¡un_msg_v’code
(
mb
, 
m‘hod
, 
STUN_CLASS_INDICATION
, 
tid
, 
NULL
,

56 
key
, 
keyËn
, 
å
, 0x00, 
©Œc
, 
­
);

57 
	`va_’d
(
­
);

58 ià(
”r
)

59 
out
;

61 
mb
->
pos
 = 
´esz
;

62 
”r
 = 
	`¡un_£nd
(
´Ùo
, 
sock
, 
d¡
, 
mb
);

64 
out
:

65 
	`mem_d”ef
(
mb
);

67  
”r
;

68 
	}
}

	@re-0.5.6/src/stun/keepalive.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_tmr.h
>

11 
	~<»_§.h
>

12 
	~<»_udp.h
>

13 
	~<»_¡un.h
>

16 
	#DEBUG_MODULE
 "k“·live"

	)

17 
	#DEBUG_LEVEL
 5

	)

18 
	~<»_dbg.h
>

22 
	s¡un_k“·live
 {

23 
¡un_ù¿ns
 *
	mù
;

24 
¡un
 *
	m¡un
;

25 
udp_h–³r
 *
	muh
;

26 
	m´Ùo
;

27 *
	msock
;

28 
§
 
	md¡
;

29 
tmr
 
	mtmr
;

30 
ušt32_t
 
	mš‹rv®
;

31 
¡un_m­³d_addr_h
 *
	mmah
;

32 *
	m¬g
;

33 
§
 
	mm­
;

34 
§
 
	mxÜm­
;

35 
§
 
	mcurm­
;

38 
timeout
(*
¬g
);

41 
	$k“·live_de¡ruùÜ
(*
d©a
)

43 
¡un_k“·live
 *
ska
 = 
d©a
;

45 
	`tmr_ÿnûl
(&
ska
->
tmr
);

47 
	`mem_d”ef
(
ska
->
ù
);

48 
	`mem_d”ef
(
ska
->
uh
);

49 
	`mem_d”ef
(
ska
->
sock
);

50 
	`mem_d”ef
(
ska
->
¡un
);

51 
	}
}

54 
	$ÿÎ_hªdËr
(
¡un_k“·live
 *
ska
, 
”r
,

55 cÚ¡ 
§
 *
m­
)

57 ià(
ska
->
mah
)

58 
ska
->
	`mah
(
”r
, 
m­
, ska->
¬g
);

59 
	}
}

62 
	$¡un_»¥Ú£_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

63 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

65 
¡un_k“·live
 *
ska
 = 
¬g
;

66 
¡un_©Œ
 *
©Œ
;

67 ()
»asÚ
;

70 ià(
ska
->
š‹rv®
 > 0)

71 
	`tmr_¡¬t
(&
ska
->
tmr
, ska->
š‹rv®
*1000, 
timeout
, ska);

73 ià(
”r
 || 
scode
) {

75 
	`§_£t_š
(&
ska
->
curm­
, 0, 0);

77 
out
;

80 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

81 ià(!
©Œ
)

82 
©Œ
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MAPPED_ADDR
);

84 ià(!
©Œ
) {

85 
”r
 = 
ENOENT
;

86 
out
;

89 ià(!
	`§_cmp
(&
ska
->
curm­
, &
©Œ
->
v
.
§
, 
SA_ALL
)) {

90 
ska
->
curm­
 = 
©Œ
->
v
.
§
;

91 
	`ÿÎ_hªdËr
(
ska
, 0, &ska->
curm­
);

94 
out
:

95 ià(
”r
)

96 
	`ÿÎ_hªdËr
(
ska
, 
”r
, 
NULL
);

97 
	}
}

100 
	$timeout
(*
¬g
)

102 
¡un_k“·live
 *
ska
 = 
¬g
;

103 
”r
;

105 ià(
ska
->
ù
)

106 
ska
->
ù
 = 
	`mem_d”ef
(ska->ct);

108 
”r
 = 
	`¡un_»que¡
(&
ska
->
ù
, ska->
¡un
, ska->
´Ùo
, ska->
sock
,

109 &
ska
->
d¡
, 0, 
STUN_METHOD_BINDING
, 
NULL
, 0, 
çl£
,

110 
¡un_»¥Ú£_hªdËr
, 
ska
, 1,

111 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

112 ià(0 =ğ
”r
)

116 ià(
ska
->
š‹rv®
 > 0)

117 
	`tmr_¡¬t
(&
ska
->
tmr
, ska->
š‹rv®
*1000, 
timeout
, ska);

120 
	`ÿÎ_hªdËr
(
ska
, 
”r
, 
NULL
);

121 
	}
}

124 
boŞ
 
	$udp_»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

126 
¡un_k“·live
 *
ska
 = 
¬g
;

127 
¡un_unknown_©Œ
 
ua
;

128 
¡un_msg
 *
msg
;

129 
size_t
 
pos
 = 
mb
->pos;

130 
boŞ
 
hdld
;

132 ià(!
	`§_cmp
(&
ska
->
d¡
, 
¤c
, 
SA_ALL
))

133  
çl£
;

135 ià(
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
))

136  
çl£
;

138 ià(
	`¡un_msg_m‘hod
(
msg
è!ğ
STUN_METHOD_BINDING
) {

139 
hdld
 = 
çl£
;

140 
mb
->
pos
 =…os;

141 
out
;

144 
	`¡un_msg_şass
(
msg
)) {

146 
STUN_CLASS_ERROR_RESP
:

147 
STUN_CLASS_SUCCESS_RESP
:

148 ()
	`¡un_ù¿ns_»cv
(
ska
->
¡un
, 
msg
, &
ua
);

149 
hdld
 = 
Œue
;

153 
hdld
 = 
çl£
;

154 
mb
->
pos
 =…os;

158 
out
:

159 
	`mem_d”ef
(
msg
);

161  
hdld
;

162 
	}
}

179 
	$¡un_k“·live_®loc
(
¡un_k“·live
 **
sk­
,

180 
´Ùo
, *
sock
, 
Ïy”
,

181 cÚ¡ 
§
 *
d¡
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

182 
¡un_m­³d_addr_h
 *
mah
, *
¬g
)

184 
¡un_k“·live
 *
ska
;

185 
”r
;

187 ià(!
sk­
)

188  
EINVAL
;

190 
ska
 = 
	`mem_z®loc
((*ska), 
k“·live_de¡ruùÜ
);

191 ià(!
ska
)

192  
ENOMEM
;

194 
”r
 = 
	`¡un_®loc
(&
ska
->
¡un
, 
cÚf
, 
NULL
, NULL);

195 ià(
”r
)

196 
out
;

198 
	`tmr_š™
(&
ska
->
tmr
);

200 
ska
->
´Ùo
 =…roto;

201 
ska
->
sock
 = 
	`mem_»f
(sock);

202 
ska
->
mah
 = mah;

203 
ska
->
¬g
 =‡rg;

205 ià(
d¡
)

206 
ska
->
d¡
 = *dst;

208 
´Ùo
) {

210 
IPPROTO_UDP
:

211 
”r
 = 
	`udp_»gi¡”_h–³r
(&
ska
->
uh
, 
sock
, 
Ïy”
,

212 
NULL
, 
udp_»cv_hªdËr
, 
ska
);

216 
”r
 = 0;

220 
out
:

221 ià(
”r
)

222 
	`mem_d”ef
(
ska
);

224 *
sk­
 = 
ska
;

226  
”r
;

227 
	}
}

238 
	$¡un_k“·live_’abË
(
¡un_k“·live
 *
ska
, 
ušt32_t
 
š‹rv®
)

240 ià(!
ska
)

243 
ska
->
š‹rv®
 = interval;

245 
	`tmr_ÿnûl
(&
ska
->
tmr
);

246 ià(
š‹rv®
 > 0)

247 
	`tmr_¡¬t
(&
ska
->
tmr
, 1, 
timeout
, ska);

248 
	}
}

	@re-0.5.6/src/stun/msg.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_fmt.h
>

13 
	~<»_md5.h
>

14 
	~<»_sha.h
>

15 
	~<»_hmac.h
>

16 
	~<»_üc32.h
>

17 
	~<»_¡un.h
>

18 
	~"¡un.h
"

22 
	mMI_SIZE
 = 24,

23 
	mFP_SIZE
 = 8

45 
	s¡un_msg
 {

46 
¡un_hdr
 
	mhdr
;

47 
li¡
 
	m©Œl
;

48 
mbuf
 *
	mmb
;

49 
size_t
 
	m¡¬t
;

53 
ušt32_t
 
	$fšg”´št
(cÚ¡ 
ušt8_t
 *
buf
, 
size_t
 
Ën
)

55  (
ušt32_t
)
	`üc32
(0, 
buf
, ()
Ën
) ^ 0x5354554e;

56 
	}
}

59 
	$de¡ruùÜ
(*
¬g
)

61 
¡un_msg
 *
msg
 = 
¬g
;

63 
	`li¡_æush
(&
msg
->
©Œl
);

64 
	`mem_d”ef
(
msg
->
mb
);

65 
	}
}

79 
	$¡un_msg_decode
(
¡un_msg
 **
msgµ
, 
mbuf
 *
mb
,

80 
¡un_unknown_©Œ
 *
ua
)

82 
¡un_msg
 *
msg
;

83 
¡un_hdr
 
hdr
;

84 
size_t
 
¡¬t
, 
exŒa
;

85 
”r
;

87 ià(!
msgµ
 || !
mb
)

88  
EINVAL
;

90 
¡¬t
 = 
mb
->
pos
;

92 
”r
 = 
	`¡un_hdr_decode
(
mb
, &
hdr
);

93 ià(
”r
) {

94 
mb
->
pos
 = 
¡¬t
;

95  
”r
;

98 
msg
 = 
	`mem_z®loc
((*msg), 
de¡ruùÜ
);

99 ià(!
msg
) {

100 
mb
->
pos
 = 
¡¬t
;

101  
ENOMEM
;

104 
msg
->
hdr
 = hdr;

105 
msg
->
mb
 = 
	`mem_»f
(mb);

106 
msg
->
¡¬t
 = start;

108 ià(
ua
)

109 
ua
->
ty³c
 = 0;

112 
exŒa
 = 
	`mbuf_g‘_Ëá
(
mb
è- 
hdr
.
Ën
;

114 
	`mbuf_g‘_Ëá
(
mb
è- 
exŒa
 >= 4) {

116 
¡un_©Œ
 *
©Œ
;

118 
”r
 = 
	`¡un_©Œ_decode
(&
©Œ
, 
mb
, 
hdr
.
tid
, 
ua
);

119 ià(
”r
)

122 
	`li¡_­³nd
(&
msg
->
©Œl
, &
©Œ
->
Ë
,‡ttr);

125 ià(
”r
)

126 
	`mem_d”ef
(
msg
);

128 *
msgµ
 = 
msg
;

130 
mb
->
pos
 = 
¡¬t
;

132  
”r
;

133 
	}
}

143 
ušt16_t
 
	$¡un_msg_ty³
(cÚ¡ 
¡un_msg
 *
msg
)

145  
msg
 ? msg->
hdr
.
ty³
 : 0;

146 
	}
}

156 
ušt16_t
 
	$¡un_msg_şass
(cÚ¡ 
¡un_msg
 *
msg
)

158  
	`STUN_CLASS
(
	`¡un_msg_ty³
(
msg
));

159 
	}
}

169 
ušt16_t
 
	$¡un_msg_m‘hod
(cÚ¡ 
¡un_msg
 *
msg
)

171  
	`STUN_METHOD
(
	`¡un_msg_ty³
(
msg
));

172 
	}
}

182 cÚ¡ 
ušt8_t
 *
	$¡un_msg_tid
(cÚ¡ 
¡un_msg
 *
msg
)

184  
msg
 ? msg->
hdr
.
tid
 : 
NULL
;

185 
	}
}

195 
boŞ
 
	$¡un_msg_mcook›
(cÚ¡ 
¡un_msg
 *
msg
)

197  
msg
 && (
STUN_MAGIC_COOKIE
 =ğmsg->
hdr
.
cook›
);

198 
	}
}

209 
¡un_©Œ
 *
	$¡un_msg_©Œ
(cÚ¡ 
¡un_msg
 *
msg
, 
ušt16_t
 
ty³
)

211 
Ë
 *Ë = 
msg
 ? 
	`li¡_h—d
(&msg->
©Œl
è: 
NULL
;

213 
Ë
) {

214 
¡un_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

216 
Ë
 =†e->
Ãxt
;

218 ià(
©Œ
->
ty³
 ==ype)

219  
©Œ
;

222  
NULL
;

223 
	}
}

235 
¡un_©Œ
 *
	$¡un_msg_©Œ_­¶y
(cÚ¡ 
¡un_msg
 *
msg
,

236 
¡un_©Œ_h
 *
h
, *
¬g
)

238 
Ë
 *Ë = 
msg
 ? 
	`li¡_h—d
(&msg->
©Œl
è: 
NULL
;

240 
Ë
) {

241 
¡un_©Œ
 *
©Œ
 = 
Ë
->
d©a
;

243 
Ë
 =†e->
Ãxt
;

245 ià(
h
 && 
	`h
(
©Œ
, 
¬g
))

246  (
©Œ
);

249  
NULL
;

250 
	}
}

271 
	$¡un_msg_v’code
(
mbuf
 *
mb
, 
ušt16_t
 
m‘hod
, 
ušt8_t
 
şass
,

272 cÚ¡ 
ušt8_t
 *
tid
, cÚ¡ 
¡un_”rcode
 *
ec
,

273 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

274 
ušt8_t
 
·ddšg
, 
ušt32_t
 
©Œc
, 
va_li¡
 
­
)

276 
¡un_hdr
 
hdr
;

277 
size_t
 
¡¬t
;

278 
”r
 = 0;

279 
ušt32_t
 
i
;

281 ià(!
mb
 || !
tid
)

282  
EINVAL
;

284 
¡¬t
 = 
mb
->
pos
;

285 
mb
->
pos
 +ğ
STUN_HEADER_SIZE
;

287 
hdr
.
ty³
 = 
	`STUN_TYPE
(
m‘hod
, 
şass
);

288 
hdr
.
cook›
 = 
STUN_MAGIC_COOKIE
;

289 
	`memıy
(
hdr
.
tid
,id, 
STUN_TID_SIZE
);

291 ià(
ec
)

292 
”r
 |ğ
	`¡un_©Œ_’code
(
mb
, 
STUN_ATTR_ERR_CODE
, 
ec
,

293 
NULL
, 
·ddšg
);

295 
i
=0; i<
©Œc
; i++) {

297 
ušt16_t
 
ty³
 = 
	`va_¬g
(
­
, );

298 cÚ¡ *
v
 = 
	`va_¬g
(
­
, const *);

300 ià(!
v
)

303 
”r
 |ğ
	`¡un_©Œ_’code
(
mb
, 
ty³
, 
v
, 
hdr
.
tid
, 
·ddšg
);

307 
hdr
.
Ën
 = 
mb
->
pos
 - 
¡¬t
 - 
STUN_HEADER_SIZE
 + (
key
 ? 
MI_SIZE
 : 0);

308 
mb
->
pos
 = 
¡¬t
;

309 
”r
 |ğ
	`¡un_hdr_’code
(
mb
, &
hdr
);

310 
mb
->
pos
 +ğ
hdr
.
Ën
 - (
key
 ? 
MI_SIZE
 : 0);

312 ià(
key
) {

313 
ušt8_t
 
mi
[20];

315 
mb
->
pos
 = 
¡¬t
;

316 
	`hmac_sha1
(
key
, 
keyËn
, 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb),

317 
mi
, (mi));

319 
mb
->
pos
 +ğ
STUN_HEADER_SIZE
 + 
hdr
.
Ën
 - 
MI_SIZE
;

320 
”r
 |ğ
	`¡un_©Œ_’code
(
mb
, 
STUN_ATTR_MSG_INTEGRITY
, 
mi
,

321 
NULL
, 
·ddšg
);

324 ià(
å
) {

325 
ušt32_t
 
åºt
;

328 
hdr
.
Ën
 = 
mb
->
pos
 - 
¡¬t
 - 
STUN_HEADER_SIZE
 + 
FP_SIZE
;

329 
mb
->
pos
 = 
¡¬t
;

330 
”r
 |ğ
	`¡un_hdr_’code
(
mb
, &
hdr
);

332 
mb
->
pos
 = 
¡¬t
;

333 
åºt
 = 
	`fšg”´št
(
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

335 
mb
->
pos
 +ğ
STUN_HEADER_SIZE
 + 
hdr
.
Ën
 - 
FP_SIZE
;

336 
”r
 |ğ
	`¡un_©Œ_’code
(
mb
, 
STUN_ATTR_FINGERPRINT
, &
åºt
,

337 
NULL
, 
·ddšg
);

340  
”r
;

341 
	}
}

362 
	$¡un_msg_’code
(
mbuf
 *
mb
, 
ušt16_t
 
m‘hod
, 
ušt8_t
 
şass
,

363 cÚ¡ 
ušt8_t
 *
tid
, cÚ¡ 
¡un_”rcode
 *
ec
,

364 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

365 
ušt8_t
 
·ddšg
, 
ušt32_t
 
©Œc
, ...)

367 
va_li¡
 
­
;

368 
”r
;

370 
	`va_¡¬t
(
­
, 
©Œc
);

371 
”r
 = 
	`¡un_msg_v’code
(
mb
, 
m‘hod
, 
şass
, 
tid
, 
ec
, 
key
, 
keyËn
, 
å
,

372 
·ddšg
, 
©Œc
, 
­
);

373 
	`va_’d
(
­
);

375  
”r
;

376 
	}
}

388 
	$¡un_msg_chk_mi
(cÚ¡ 
¡un_msg
 *
msg
, cÚ¡ 
ušt8_t
 *
key
,

389 
size_t
 
keyËn
)

391 
ušt8_t
 
hmac
[
SHA_DIGEST_LENGTH
];

392 
¡un_©Œ
 *
mi
, *
å
;

394 ià(!
msg
)

395  
EINVAL
;

397 
mi
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_MSG_INTEGRITY
);

398 ià(!
mi
)

399  
EPROTO
;

401 
msg
->
mb
->
pos
 = msg->
¡¬t
;

403 
å
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_FINGERPRINT
);

404 ià(
å
) {

405 ((
¡un_msg
 *)
msg
)->
hdr
.
Ën
 -ğ
FP_SIZE
;

406 ()
	`¡un_hdr_’code
(
msg
->
mb
, &msg->
hdr
);

407 
msg
->
mb
->
pos
 -ğ
STUN_HEADER_SIZE
;

410 
	`hmac_sha1
(
key
, 
keyËn
, 
	`mbuf_buf
(
msg
->
mb
),

411 
STUN_HEADER_SIZE
 + 
msg
->
hdr
.
Ën
 - 
MI_SIZE
,

412 
hmac
, (hmac));

414 ià(
å
) {

415 ((
¡un_msg
 *)
msg
)->
hdr
.
Ën
 +ğ
FP_SIZE
;

416 ()
	`¡un_hdr_’code
(
msg
->
mb
, &msg->
hdr
);

417 
msg
->
mb
->
pos
 -ğ
STUN_HEADER_SIZE
;

420 ià(
	`memcmp
(
mi
->
v
.
msg_š‹gr™y
, 
hmac
, 
SHA_DIGEST_LENGTH
))

421  
EBADMSG
;

424 
	}
}

434 
	$¡un_msg_chk_fšg”´št
(cÚ¡ 
¡un_msg
 *
msg
)

436 
¡un_©Œ
 *
å
;

437 
ušt32_t
 
åºt
;

439 ià(!
msg
)

440  
EINVAL
;

442 
å
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_FINGERPRINT
);

443 ià(!
å
)

444  
EPROTO
;

446 
msg
->
mb
->
pos
 = msg->
¡¬t
;

448 
åºt
 = 
	`fšg”´št
(
	`mbuf_buf
(
msg
->
mb
),

449 
STUN_HEADER_SIZE
 + 
msg
->
hdr
.
Ën
 - 
FP_SIZE
);

451 ià(
åºt
 !ğ
å
->
v
.
fšg”´št
)

452  
EBADMSG
;

455 
	}
}

458 
boŞ
 
	$©Œ_´št
(cÚ¡ 
¡un_©Œ
 *
©Œ
, *
¬g
)

460 ()
¬g
;

462 
	`¡un_©Œ_dump
(
©Œ
);

464  
çl£
;

465 
	}
}

473 
	$¡un_msg_dump
(cÚ¡ 
¡un_msg
 *
msg
)

475 ià(!
msg
)

478 ()
	`»_´štf
("%s %s (len=%u cookie=%08xid=%w)\n",

479 
	`¡un_m‘hod_Çme
(
	`¡un_msg_m‘hod
(
msg
)),

480 
	`¡un_şass_Çme
(
	`¡un_msg_şass
(
msg
)),

481 
msg
->
hdr
.
Ën
, msg->hdr.
cook›
,

482 
msg
->
hdr
.
tid
, (msg->hdr.tid));

484 
	`¡un_msg_©Œ_­¶y
(
msg
, 
©Œ_´št
, 
NULL
);

485 
	}
}

	@re-0.5.6/src/stun/rep.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_§.h
>

10 
	~<»_li¡.h
>

11 
	~<»_¡un.h
>

12 
	~"¡un.h
"

32 
	$¡un_»¶y
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

33 cÚ¡ 
¡un_msg
 *
»q
, cÚ¡ 
ušt8_t
 *
key
,

34 
size_t
 
keyËn
, 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...)

36 
mbuf
 *
mb
 = 
NULL
;

37 
”r
 = 
ENOMEM
;

38 
va_li¡
 
­
;

40 ià(!
sock
 || !
»q
)

41  
EINVAL
;

43 
mb
 = 
	`mbuf_®loc
(256);

44 ià(!
mb
)

45 
out
;

47 
	`va_¡¬t
(
­
, 
©Œc
);

48 
mb
->
pos
 = 
´esz
;

49 
”r
 = 
	`¡un_msg_v’code
(
mb
, 
	`¡un_msg_m‘hod
(
»q
),

50 
STUN_CLASS_SUCCESS_RESP
, 
	`¡un_msg_tid
(
»q
),

51 
NULL
, 
key
, 
keyËn
, 
å
, 0x00, 
©Œc
, 
­
);

52 
	`va_’d
(
­
);

53 ià(
”r
)

54 
out
;

56 
mb
->
pos
 = 
´esz
;

57 
”r
 = 
	`¡un_£nd
(
´Ùo
, 
sock
, 
d¡
, 
mb
);

59 
out
:

60 
	`mem_d”ef
(
mb
);

62  
”r
;

63 
	}
}

85 
	$¡un_”•ly
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

86 cÚ¡ 
¡un_msg
 *
»q
, 
ušt16_t
 
scode
,

87 cÚ¡ *
»asÚ
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
,

88 
boŞ
 
å
, 
ušt32_t
 
©Œc
, ...)

90 
¡un_”rcode
 
ec
;

91 
mbuf
 *
mb
 = 
NULL
;

92 
”r
 = 
ENOMEM
;

93 
va_li¡
 
­
;

95 ià(!
sock
 || !
»q
 || !
scode
 || !
»asÚ
)

96  
EINVAL
;

98 
mb
 = 
	`mbuf_®loc
(256);

99 ià(!
mb
)

100 
out
;

102 
ec
.
code
 = 
scode
;

103 
ec
.
»asÚ
 = (*)reason;

105 
	`va_¡¬t
(
­
, 
©Œc
);

106 
mb
->
pos
 = 
´esz
;

107 
”r
 = 
	`¡un_msg_v’code
(
mb
, 
	`¡un_msg_m‘hod
(
»q
), 
STUN_CLASS_ERROR_RESP
,

108 
	`¡un_msg_tid
(
»q
), &
ec
, 
key
, 
keyËn
,

109 
å
, 0x00, 
©Œc
, 
­
);

110 
	`va_’d
(
­
);

111 ià(
”r
)

112 
out
;

114 
mb
->
pos
 = 
´esz
;

115 
”r
 = 
	`¡un_£nd
(
´Ùo
, 
sock
, 
d¡
, 
mb
);

117 
out
:

118 
	`mem_d”ef
(
mb
);

120  
”r
;

121 
	}
}

	@re-0.5.6/src/stun/req.c

6 
	~<»_ty³s.h
>

7 
	~<»_sys.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_li¡.h
>

12 
	~<»_¡un.h
>

13 
	~"¡un.h
"

37 
	$¡un_»que¡
(
¡un_ù¿ns
 **
ùp
, 
¡un
 *¡un, 
´Ùo
,

38 *
sock
, cÚ¡ 
§
 *
d¡
, 
size_t
 
´esz
,

39 
ušt16_t
 
m‘hod
, cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
keyËn
, 
boŞ
 
å
,

40 
¡un_»¥_h
 *
»¥h
, *
¬g
, 
ušt32_t
 
©Œc
, ...)

42 
ušt8_t
 
tid
[
STUN_TID_SIZE
];

43 
mbuf
 *
mb
;

44 
ušt32_t
 
i
;

45 
va_li¡
 
­
;

46 
”r
;

48 ià(!
¡un
)

49  
EINVAL
;

51 
mb
 = 
	`mbuf_®loc
(512);

52 ià(!
mb
)

53  
ENOMEM
;

55 
i
=0; i<
STUN_TID_SIZE
; i++)

56 
tid
[
i
] = 
	`¿nd_u32
();

58 
	`va_¡¬t
(
­
, 
©Œc
);

59 
mb
->
pos
 = 
´esz
;

60 
”r
 = 
	`¡un_msg_v’code
(
mb
, 
m‘hod
, 
STUN_CLASS_REQUEST
,

61 
tid
, 
NULL
, 
key
, 
keyËn
, 
å
, 0x00, 
©Œc
, 
­
);

62 
	`va_’d
(
­
);

63 ià(
”r
)

64 
out
;

66 
mb
->
pos
 = 
´esz
;

67 
”r
 = 
	`¡un_ù¿ns_»que¡
(
ùp
, 
¡un
, 
´Ùo
, 
sock
, 
d¡
, 
mb
, 
tid
, 
m‘hod
,

68 
key
, 
keyËn
, 
»¥h
, 
¬g
);

69 ià(
”r
)

70 
out
;

72 
out
:

73 
	`mem_d”ef
(
mb
);

75  
”r
;

76 
	}
}

	@re-0.5.6/src/stun/stun.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_§.h
>

11 
	~<»_udp.h
>

12 
	~<»_tı.h
>

13 
	~<»_¤.h
>

14 
	~<»_s.h
>

15 
	~<»_sys.h
>

16 
	~<»_li¡.h
>

17 
	~<»_¡un.h
>

18 
	~"¡un.h
"

21 cÚ¡ *
	g¡un_soáw¬e
 = "lib» v" 
VERSION
 " (" 
ARCH
 "/" 
OS
 ")";

24 cÚ¡ 
¡un_cÚf
 
	gcÚf_deçuÉ
 = {

25 
STUN_DEFAULT_RTO
,

26 
STUN_DEFAULT_RC
,

27 
STUN_DEFAULT_RM
,

28 
STUN_DEFAULT_TI
,

33 
	$de¡ruùÜ
(*
¬g
)

35 
¡un
 *¡uÀğ
¬g
;

37 
	`¡un_ù¿ns_şo£
(
¡un
);

38 
	}
}

51 
	$¡un_®loc
(
¡un
 **
¡uÅ
, cÚ¡ 
¡un_cÚf
 *
cÚf
,

52 
¡un_šd_h
 *
šdh
, *
¬g
)

54 
¡un
 *stun;

56 ià(!
¡uÅ
)

57  
EINVAL
;

59 
¡un
 = 
	`mem_z®loc
((*¡un), 
de¡ruùÜ
);

60 ià(!
¡un
)

61  
ENOMEM
;

63 
¡un
->
cÚf
 = cÚà? *cÚà: 
cÚf_deçuÉ
;

64 
¡un
->
šdh
 = indh;

65 
¡un
->
¬g
 =‡rg;

67 *
¡uÅ
 = 
¡un
;

70 
	}
}

80 
¡un_cÚf
 *
	$¡un_cÚf
(
¡un
 *stun)

82  
¡un
 ? &¡un->
cÚf
 : 
NULL
;

83 
	}
}

96 
	$¡un_£nd
(
´Ùo
, *
sock
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

98 
”r
;

100 ià(!
sock
 || !
mb
)

101  
EINVAL
;

103 
´Ùo
) {

105 
IPPROTO_UDP
:

106 
”r
 = 
	`udp_£nd
(
sock
, 
d¡
, 
mb
);

109 
IPPROTO_TCP
:

110 
”r
 = 
	`tı_£nd
(
sock
, 
mb
);

113 #ifdeà
USE_DTLS


114 
STUN_TRANSP_DTLS
:

115 
”r
 = 
	`ds_£nd
(
sock
, 
mb
);

120 
”r
 = 
EPROTONOSUPPORT
;

124  
”r
;

125 
	}
}

136 
	$¡un_»cv
(
¡un
 *¡un, 
mbuf
 *
mb
)

138 
¡un_unknown_©Œ
 
ua
;

139 
¡un_msg
 *
msg
;

140 
”r
;

142 ià(!
¡un
 || !
mb
)

143  
EINVAL
;

145 
”r
 = 
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
);

146 ià(
”r
)

147  
”r
;

149 
	`¡un_msg_şass
(
msg
)) {

151 
STUN_CLASS_INDICATION
:

152 ià(
ua
.
ty³c
 > 0)

155 ià(
¡un
->
šdh
)

156 
¡un
->
	`šdh
(
msg
, stun->
¬g
);

159 
STUN_CLASS_ERROR_RESP
:

160 
STUN_CLASS_SUCCESS_RESP
:

161 
”r
 = 
	`¡un_ù¿ns_»cv
(
¡un
, 
msg
, &
ua
);

168 
	`mem_d”ef
(
msg
);

170  
”r
;

171 
	}
}

182 
	$¡un_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡un
 *stun)

184 ià(!
¡un
)

187  
	`»_h´štf
(
pf
, "STUN debug:\n%H", 
¡un_ù¿ns_debug
, 
¡un
);

188 
	}
}

	@re-0.5.6/src/stun/stun.h

10 
	mSTUN_MAGIC_COOKIE
 = 0x2112a442

15 
	#STUN_TYPE
(
m‘hod
, 
şass
) \

16 ((
m‘hod
)&0x0f80) << 2 | \

17 ((
m‘hod
)&0x0070) << 1 | \

18 ((
m‘hod
)&0x000f) << 0 | \

19 ((
şass
)&0x2) << 7 | \

20 ((
şass
)&0x1è<< 4

	)

23 
	#STUN_CLASS
(
ty³
) \

24 ((
ty³
 >> 7 |y³ >> 4è& 0x3)

	)

27 
	#STUN_METHOD
(
ty³
) \

28 ((
ty³
&0x3e00)>>2 | (ty³&0x00e0)>>1 | (ty³&0x000f))

	)

31 
	s¡un_hdr
 {

32 
ušt16_t
 
	mty³
;

33 
ušt16_t
 
	mËn
;

34 
ušt32_t
 
	mcook›
;

35 
ušt8_t
 
	mtid
[
STUN_TID_SIZE
];

39 
	s¡un
 {

40 
li¡
 
	mùl
;

41 
¡un_cÚf
 
	mcÚf
;

42 
¡un_šd_h
 *
	mšdh
;

43 *
	m¬g
;

46 
¡un_hdr_’code
(
mbuf
 *
mb
, cÚ¡ 
¡un_hdr
 *
hdr
);

47 
¡un_hdr_decode
(
mbuf
 *
mb
, 
¡un_hdr
 *
hdr
);

49 
¡un_©Œ_’code
(
mbuf
 *
mb
, 
ušt16_t
 
ty³
, cÚ¡ *
v
,

50 cÚ¡ 
ušt8_t
 *
tid
, ušt8_ˆ
·ddšg
);

51 
¡un_©Œ_decode
(
¡un_©Œ
 **
©Œp
, 
mbuf
 *
mb
,

52 cÚ¡ 
ušt8_t
 *
tid
, 
¡un_unknown_©Œ
 *
ua
);

53 
¡un_©Œ_dump
(cÚ¡ 
¡un_©Œ
 *
a
);

55 
¡un_addr_’code
(
mbuf
 *
mb
, cÚ¡ 
§
 *
addr
,

56 cÚ¡ 
ušt8_t
 *
tid
);

57 
¡un_addr_decode
(
mbuf
 *
mb
, 
§
 *
addr
, cÚ¡ 
ušt8_t
 *
tid
);

59 
¡un_ù¿ns_»que¡
(
¡un_ù¿ns
 **
ùp
, 
¡un
 *¡un, 
´Ùo
,

60 *
sock
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
,

61 cÚ¡ 
ušt8_t
 
tid
[], 
ušt16_t
 
m‘
, cÚ¡ ušt8_ˆ*
key
,

62 
size_t
 
keyËn
, 
¡un_»¥_h
 *
»¥h
, *
¬g
);

63 
¡un_ù¿ns_şo£
(
¡un
 *stun);

64 
¡un_ù¿ns_debug
(
»_´štf
 *
pf
, cÚ¡ 
¡un
 *stun);

	@re-0.5.6/src/stun/stunstr.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_li¡.h
>

9 
	~<»_§.h
>

10 
	~<»_¡un.h
>

14 cÚ¡ *
	g¡un_»asÚ_300
 = "Try Alternate";

15 cÚ¡ *
	g¡un_»asÚ_400
 = "Bad Request";

16 cÚ¡ *
	g¡un_»asÚ_401
 = "Unauthorized";

17 cÚ¡ *
	g¡un_»asÚ_403
 = "Forbidden";

18 cÚ¡ *
	g¡un_»asÚ_420
 = "Unknown Attribute";

19 cÚ¡ *
	g¡un_»asÚ_437
 = "Allocation Mismatch";

20 cÚ¡ *
	g¡un_»asÚ_438
 = "Stale Nonce";

21 cÚ¡ *
	g¡un_»asÚ_440
 = "Address Family‚ot Supported";

22 cÚ¡ *
	g¡un_»asÚ_441
 = "Wrong Credentials";

23 cÚ¡ *
	g¡un_»asÚ_442
 = "Unsupported Transport Protocol";

24 cÚ¡ *
	g¡un_»asÚ_443
 = "Peer Address Family Mismatch";

25 cÚ¡ *
	g¡un_»asÚ_486
 = "Allocation Quota Reached";

26 cÚ¡ *
	g¡un_»asÚ_500
 = "Server Error";

27 cÚ¡ *
	g¡un_»asÚ_508
 = "Insufficient Capacity";

37 cÚ¡ *
	$¡un_Œª¥_Çme
(
¡un_Œª¥
 

)

39 

) {

41 
STUN_TRANSP_UDP
:  "UDP";

42 
STUN_TRANSP_TCP
:  "TCP";

43 
STUN_TRANSP_DTLS
:  "DTLS";

46 
	}
}

	@re-0.5.6/src/sys/daemon.c

6 
	~<sys/ty³s.h
>

7 
	~<sys/¡©.h
>

8 #ifdeà
HAVE_UNISTD_H


9 
	~<uni¡d.h
>

11 
	~<¡dlib.h
>

12 
	~<sigÇl.h
>

13 
	~<¡dio.h
>

14 
	~<»_ty³s.h
>

15 
	~<»_mbuf.h
>

16 
	~<»_sys.h
>

24 
	$sys_d«mÚ
()

26 #ifdeà
HAVE_FORK


27 
pid_t
 
pid
;

29 
pid
 = 
	`fÜk
();

30 ià(-1 =ğ
pid
)

31  
”ºo
;

32 ià(
pid
 > 0)

33 
	`ex™
(0);

35 ià(-1 =ğ
	`£tsid
())

36  
”ºo
;

38 ()
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

40 
pid
 = 
	`fÜk
();

41 ià(-1 =ğ
pid
)

42  
”ºo
;

43 ià(
pid
 > 0)

44 
	`ex™
(0);

46 ià(-1 =ğ
	`chdœ
("/"))

47  
”ºo
;

48 ()
	`umask
(0);

51 ià(
	`äeİ’
("/dev/nuÎ", "r", 
¡dš
è=ğ
NULL
)

52  
”ºo
;

53 ià(
	`äeİ’
("/dev/nuÎ", "w", 
¡dout
è=ğ
NULL
)

54  
”ºo
;

55 ià(
	`äeİ’
("/dev/nuÎ", "w", 
¡d”r
è=ğ
NULL
)

56  
”ºo
;

60  
ENOSYS
;

62 
	}
}

	@re-0.5.6/src/sys/endian.c

6 
	~<»_ty³s.h
>

7 
	~<»_mbuf.h
>

8 
	~<»_sys.h
>

23 
ušt16_t
 
	$sys_htŞs
(
ušt16_t
 
v
)

25 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
v
;

26 
ušt16_t
 
l
 = 0;

28 
l
 |ğ(
ušt16_t
)*
p
++ << 0;

29 
l
 |ğ(
ušt16_t
)*
p
 << 8;

31  
l
;

32 
	}
}

42 
ušt32_t
 
	$sys_htŞl
(
ušt32_t
 
v
)

44 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
v
;

45 
ušt32_t
 
l
 = 0;

47 
l
 |ğ(
ušt32_t
)*
p
++ << 0;

48 
l
 |ğ(
ušt32_t
)*
p
++ << 8;

49 
l
 |ğ(
ušt32_t
)*
p
++ << 16;

50 
l
 |ğ(
ušt32_t
)*
p
 << 24;

52  
l
;

53 
	}
}

63 
ušt16_t
 
	$sys_Éohs
(
ušt16_t
 
v
)

65 
ušt16_t
 
s
;

66 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
s
;

68 *
p
++ = 
v
>>0 & 0xff;

69 *
p
 = 
v
>>8 & 0xff;

71  
s
;

72 
	}
}

82 
ušt32_t
 
	$sys_Éohl
(
ušt32_t
 
v
)

84 
ušt32_t
 
h
;

85 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
h
;

87 *
p
++ = 
v
>>0 & 0xff;

88 *
p
++ = 
v
>>8 & 0xff;

89 *
p
++ = 
v
>>16 & 0xff;

90 *
p
 = 
v
>>24 & 0xff;

92  
h
;

93 
	}
}

103 
ušt64_t
 
	$sys_htÚÎ
(
ušt64_t
 
v
)

105 
ušt64_t
 
h
 = 0;

106 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
v
;

108 
h
 |ğ(
ušt64_t
)*
p
++ << 56;

109 
h
 |ğ(
ušt64_t
)*
p
++ << 48;

110 
h
 |ğ(
ušt64_t
)*
p
++ << 40;

111 
h
 |ğ(
ušt64_t
)*
p
++ << 32;

112 
h
 |ğ(
ušt64_t
)*
p
++ << 24;

113 
h
 |ğ(
ušt64_t
)*
p
++ << 16;

114 
h
 |ğ(
ušt64_t
)*
p
++ << 8;

115 
h
 |ğ(
ušt64_t
)*
p
 << 0;

117  
h
;

118 
	}
}

128 
ušt64_t
 
	$sys_ÁohÎ
(
ušt64_t
 
v
)

130 
ušt64_t
 
h
;

131 
ušt8_t
 *
p
 = (ušt8_ˆ*)&
h
;

133 *
p
++ = (
ušt8_t
è(
v
>>56 & 0xff);

134 *
p
++ = (
ušt8_t
è(
v
>>48 & 0xff);

135 *
p
++ = (
ušt8_t
è(
v
>>40 & 0xff);

136 *
p
++ = (
ušt8_t
è(
v
>>32 & 0xff);

137 *
p
++ = (
ušt8_t
è(
v
>>24 & 0xff);

138 *
p
++ = (
ušt8_t
è(
v
>>16 & 0xff);

139 *
p
++ = (
ušt8_t
è(
v
>>8 & 0xff);

140 *
p
 = (
ušt8_t
è(
v
>>0 & 0xff);

142  
h
;

143 
	}
}

	@re-0.5.6/src/sys/fs.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<sys/¡©.h
>

9 
	~<sys/ty³s.h
>

10 
	~<fú.h
>

11 #ifdeà
HAVE_UNISTD_H


12 
	~<uni¡d.h
>

14 #ifdeà
HAVE_PWD_H


15 
	~<pwd.h
>

17 #ifdeà
WIN32


18 
	~<wšdows.h
>

19 
	~<shlobj.h
>

20 
	~<dœeù.h
>

21 
	~<lmacûss.h
>

23 
	~<»_ty³s.h
>

24 
	~<»_fmt.h
>

25 
	~<»_sys.h
>

36 
	$fs_mkdœ
(cÚ¡ *
·th
, 
ušt16_t
 
mode
)

38 
»t
;

40 ià(!
·th
)

41  
EINVAL
;

43 #ià
	`defšed
 (
WIN32
)

44 ()
mode
;

45 
»t
 = 
	`_mkdœ
(
·th
);

47 
»t
 = 
	`mkdœ
(
·th
, 
mode
);

49 ià(
»t
 < 0)

50  
”ºo
;

53 
	}
}

64 
	$fs_g‘home
(*
·th
, 
size_t
 
sz
)

66 #ifdeà
WIN32


67 
wš32_·th
[
MAX_PATH
];

69 ià(!
·th
 || !
sz
)

70  
EINVAL
;

72 ià(
S_OK
 !ğ
	`SHG‘FŞd”P©h
(
NULL
,

73 
CSIDL_APPDATA
 | 
CSIDL_FLAG_CREATE
,

74 
NULL
,

76 
wš32_·th
)) {

77  
ENOENT
;

80 
	`¡r_nıy
(
·th
, 
wš32_·th
, 
sz
);

84 #–ià
	`defšed
(
HAVE_PWD_H
)

85 cÚ¡ *
logšÇme
;

86 
·sswd
 *
pw
;

88 ià(!
·th
 || !
sz
)

89  
EINVAL
;

91 
logšÇme
 = 
	`sys_u£ºame
();

92 ià(!
logšÇme
)

93  
ENOENT
;

95 
pw
 = 
	`g‘pwÇm
(
logšÇme
);

96 ià(!
pw
)

97  
”ºo
;

99 
	`¡r_nıy
(
·th
, 
pw
->
pw_dœ
, 
sz
);

103 ()
·th
;

104 ()
sz
;

105  
ENOSYS
;

107 
	}
}

	@re-0.5.6/src/sys/rand.c

6 
	~<¡dlib.h
>

7 #ifdeà
USE_OPENSSL


8 
	~<İ’s¦/¿nd.h
>

9 
	~<İ’s¦/”r.h
>

11 
	~<»_ty³s.h
>

12 
	~<»_mbuf.h
>

13 
	~<»_li¡.h
>

14 
	~<»_tmr.h
>

15 
	~<»_sys.h
>

18 
	#DEBUG_MODULE
 "¿nd"

	)

19 
	#DEBUG_LEVEL
 5

	)

20 
	~<»_dbg.h
>

23 #iâdeà
RELEASE


24 
	#RAND_DEBUG
 1

	)

27 cÚ¡ 
	g®phªum
[] =

32 #ià
RAND_DEBUG


33 
boŞ
 
	gš™ed
 = 
çl£
;

35 
	#RAND_CHECK
 \

36 ià(!
š™ed
) { \

37 
	`DEBUG_WARNING
("%s:„ªdom‚Ù in™ed\n", 
__REFUNC__
); \

38 }

	)

40 
	#RAND_CHECK
 ià(0è{}

	)

47 
	$¿nd_š™
()

49 #iâdeà
USE_OPENSSL


50 
	`¤ªd
((
ušt32_t
è
	`tmr_jiff›s
());

53 #ià
RAND_DEBUG


54 
š™ed
 = 
Œue
;

56 
	}
}

64 
ušt16_t
 
	$¿nd_u16
()

66 
RAND_CHECK
;

69  
	`¿nd_u32
() >> 16;

70 
	}
}

78 
ušt32_t
 
	$¿nd_u32
()

80 
ušt32_t
 
v
;

82 
RAND_CHECK
;

84 #ifdeà
USE_OPENSSL


85 
v
 = 0;

86 ià(
	`RAND_by‹s
((*)&
v
, (v)) <= 0) {

87 
	`DEBUG_WARNING
("RAND_bytes()ƒrror: %i\n",

88 
	`ERR_GET_REASON
(
	`ERR_g‘_”rÜ
()));

89 
	`ERR_ş—r_”rÜ
();

91 #–ià
	`defšed
(
HAVE_ARC4RANDOM
)

92 
v
 = 
	`¬c4¿ndom
();

93 #–ià
	`defšed
(
WIN32
)

94 
v
 = (
	`¿nd
() << 16) +„and();

96 
v
 = 
	`¿nd
();

99  
v
;

100 
	}
}

108 
ušt64_t
 
	$¿nd_u64
()

110 
RAND_CHECK
;

112  (
ušt64_t
)
	`¿nd_u32
()<<32 |„and_u32();

113 
	}
}

121 
	$¿nd_ch¬
()

123 
s
[2];

125 
RAND_CHECK
;

127 
	`¿nd_¡r
(
s
, (s));

129  
s
[0];

130 
	}
}

139 
	$¿nd_¡r
(*
¡r
, 
size_t
 
size
)

141 
size_t
 
i
;

143 ià(!
¡r
 || !
size
)

146 
RAND_CHECK
;

148 --
size
;

150 
	`¿nd_by‹s
((
ušt8_t
 *)
¡r
, 
size
);

152 
i
=0; i<
size
; i++)

153 
¡r
[
i
] = 
®phªum
[((
ušt8_t
)str[i]) % ((alphanum)-1)];

155 
¡r
[
size
] = '\0';

156 
	}
}

165 
	$¿nd_by‹s
(
ušt8_t
 *
p
, 
size_t
 
size
)

167 #ifdeà
USE_OPENSSL


168 ià(
	`RAND_by‹s
(
p
, ()
size
) <= 0) {

169 
	`DEBUG_WARNING
("RAND_bytes()ƒrror: %i\n",

170 
	`ERR_GET_REASON
(
	`ERR_g‘_”rÜ
()));

171 
	`ERR_ş—r_”rÜ
();

173 #–ià
	`defšed
 (
HAVE_ARC4RANDOM
)

174 
	`¬c4¿ndom_buf
(
p
, 
size
);

176 
size
--) {

177 
p
[
size
] = 
	`¿nd_u32
();

180 
	}
}

	@re-0.5.6/src/sys/sleep.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_sys.h
>

9 #ifdeà
WIN32


10 
	~<wšdows.h
>

12 #ifdeà
HAVE_UNISTD_H


13 
	#_BSD_SOURCE
 1

	)

14 
	~<uni¡d.h
>

16 #ifdeà
HAVE_SELECT_H


17 
	~<sys/£Ëù.h
>

26 
	$sys_u¦“p
(
us
)

28 ià(!
us
)

31 #ifdeà
WIN32


32 
	`SË•
(
us
 / 1000);

33 #–ià
	`defšed
(
HAVE_SELECT
)

35 
timev®
 
tv
;

37 
tv
.
tv_£c
 = 
us
 / 1000000;

38 
tv
.
tv_u£c
 = 
us
 % 1000000;

40 ()
	`£Ëù
(0, 
NULL
, NULL, NULL, &
tv
);

43 ()
	`u¦“p
(
us
);

45 
	}
}

	@re-0.5.6/src/sys/sys.c

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<»_ty³s.h
>

9 
	~<»_fmt.h
>

10 
	~<»_sys.h
>

11 #ifdeà
HAVE_UNISTD_H


12 
	~<uni¡d.h
>

14 #ifdeà
HAVE_UNAME


15 
	~<sys/ut¢ame.h
>

17 #ifdeà
HAVE_SYS_TIME_H


18 
	~<sys/time.h
>

20 #ifdeà
HAVE_SETRLIMIT


21 
	~<sys/»sourû.h
>

35 
	$sys_»l_g‘
(
ušt32_t
 *
»l
, ušt32_ˆ*
maj
, ušt32_ˆ*
mš
, ušt32_ˆ*
·tch
)

37 #ifdeà
HAVE_UNAME


38 
ut¢ame
 
u
;

39 
¶
 
¶_mj
, 
¶_mn
, 
¶_p
;

40 
ušt32_t
 
mj
, 
mn
, 
p
;

41 
”r
;

43 ià(0 !ğ
	`uÇme
(&
u
))

44  
”ºo
;

46 
”r
 = 
	`»_»gex
(
u
.
»Ëa£
, 
	`¡¾’
(u.release),

48 &
¶_mj
, &
¶_mn
, 
NULL
, &
¶_p
);

49 ià(
”r
)

50  
”r
;

52 
mj
 = 
	`¶_u32
(&
¶_mj
);

53 
mn
 = 
	`¶_u32
(&
¶_mn
);

54 
p
 = 
	`¶_u32
(&
¶_p
);

56 ià(
»l
)

57 *
»l
 = 
mj
<<16 | 
mn
<<8 | 
p
;

58 ià(
maj
)

59 *
maj
 = 
mj
;

60 ià(
mš
)

61 *
mš
 = 
mn
;

62 ià(
·tch
)

63 *
·tch
 = 
p
;

67 ()
»l
;

68 ()
maj
;

69 ()
mš
;

70 ()
·tch
;

71  
EINVAL
;

73 
	}
}

84 
	$sys_k”Ãl_g‘
(
»_´štf
 *
pf
, *
unu£d
)

86 #ifdeà
HAVE_UNAME


87 
ut¢ame
 
u
;

89 ()
unu£d
;

91 ià(0 !ğ
	`uÇme
(&
u
))

92  
”ºo
;

94  
	`»_h´štf
(
pf
, "% % % % %s", 
u
.
sy¢ame
, u.
nod’ame
,

95 
u
.
»Ëa£
, u.
v”siÚ
, u.
machše
);

97 cÚ¡ *
¡r
;

99 ()
unu£d
;

101 #ià
	`defšed
(
WIN32
)

102 
¡r
 = "Win32";

104 
¡r
 = "?";

107  
	`»_h´štf
(
pf
, "%s", 
¡r
);

109 
	}
}

120 
	$sys_bud_g‘
(
»_´štf
 *
pf
, *
unu£d
)

122 cÚ¡ 
bus_width
 = 8*(*);

123 cÚ¡ *
’dŸn
 = "unknown";

125 cÚ¡ 
ušt32_t
 
a
 = 0x12345678;

126 cÚ¡ 
ušt8_t
 
b0
 = ((ušt8_ˆ*)&
a
)[0];

127 cÚ¡ 
ušt8_t
 
b1
 = ((ušt8_ˆ*)&
a
)[1];

128 cÚ¡ 
ušt8_t
 
b2
 = ((ušt8_ˆ*)&
a
)[2];

129 cÚ¡ 
ušt8_t
 
b3
 = ((ušt8_ˆ*)&
a
)[3];

131 ()
unu£d
;

133 ià(0x12==
b0
 && 0x34==
b1
 && 0x56==
b2
 && 0x78==
b3
)

134 
’dŸn
 = "big";

135 ià(0x12==
b3
 && 0x34==
b2
 && 0x56==
b1
 && 0x78==
b0
)

136 
’dŸn
 = "little";

138  
	`»_h´štf
(
pf
, "%u-b™ % ’dŸn", 
bus_width
, 
’dŸn
);

139 
	}
}

147 cÚ¡ *
	$sys_¬ch_g‘
()

149 #ifdeà
ARCH


150  
ARCH
;

154 
	}
}

162 cÚ¡ *
	$sys_os_g‘
()

164 #ifdeà
OS


165  
OS
;

169 
	}
}

177 cÚ¡ *
	$sys_lib»_v”siÚ_g‘
()

179 #ifdeà
VERSION


180  
VERSION
;

184 
	}
}

192 cÚ¡ *
	$sys_u£ºame
()

194 #ifdeà
HAVE_PWD_H


195 *
logš
;

197 
logš
 = 
	`g‘’v
("LOGNAME");

198 ià(!
logš
)

199 
logš
 = 
	`g‘’v
("USER");

200 #ifdeà
HAVE_UNISTD_H


201 ià(!
logš
) {

202 
logš
 = 
	`g‘logš
();

206  
	`¡r_is£t
(
logš
è?†ogš : 
NULL
;

208  
NULL
;

210 
	}
}

220 
	$sys_cÜedump_£t
(
boŞ
 
’abË
)

222 #ifdeà
HAVE_SETRLIMIT


223 cÚ¡ 
¾im™
 
¾im
 = {

224 
’abË
 ? 
RLIM_INFINITY
 : 0,

225 
’abË
 ? 
RLIM_INFINITY
 : 0

228  0 =ğ
	`£Œlim™
(
RLIMIT_CORE
, &
¾im
è? 0 : 
”ºo
;

230 ()
’abË
;

231  
ENOSYS
;

233 
	}
}

	@re-0.5.6/src/tcp/tcp.c

6 
	~<¡dlib.h
>

7 #ifdeà
HAVE_UNISTD_H


8 
	~<uni¡d.h
>

10 #ifdeà
HAVE_IO_H


11 
	~<io.h
>

13 #ià!
defšed
(
WIN32
è&& !defšed (
CYGWIN
)

14 
	#__USE_POSIX
 1

	)

15 
	#__USE_XOPEN2K
 1

	)

16 
	#__USE_MISC
 1

	)

17 
	~<Ãtdb.h
>

19 #ifdeà
__APPLE__


20 
	~"T¬g‘CÚd™iÚ®s.h
"

22 
	~<¡ršg.h
>

23 
	~<»_ty³s.h
>

24 
	~<»_fmt.h
>

25 
	~<»_mem.h
>

26 
	~<»_mbuf.h
>

27 
	~<»_li¡.h
>

28 
	~<»_maš.h
>

29 
	~<»_§.h
>

30 
	~<»_Ãt.h
>

31 
	~<»_tı.h
>

34 
	#DEBUG_MODULE
 "tı"

	)

35 
	#DEBUG_LEVEL
 5

	)

36 
	~<»_dbg.h
>

40 #ifdeà
WIN32


41 
	#BUF_CAST
 (*)

	)

42 
	#SOK_CAST
 ()

	)

43 
	#SIZ_CAST
 ()

	)

44 
	#şo£
 
şo£sock‘


	)

46 
	#BUF_CAST


	)

47 
	#SOK_CAST


	)

48 
	#SIZ_CAST


	)

53 
	mTCP_TXQSZ_DEFAULT
 = 524288,

54 
	mTCP_RXSZ_DEFAULT
 = 8192

59 
	stı_sock
 {

60 
	mfd
;

61 
	mfdc
;

62 
tı_cÚn_h
 *
	mcÚnh
;

63 *
	m¬g
;

68 
	stı_cÚn
 {

69 
li¡
 
	mh–³rs
;

70 
li¡
 
	m£ndq
;

71 
	mfdc
;

72 
tı_e¡ab_h
 *
	me¡abh
;

73 
tı_£nd_h
 *
	m£ndh
;

74 
tı_»cv_h
 *
	m»cvh
;

75 
tı_şo£_h
 *
	mşo£h
;

76 *
	m¬g
;

77 
size_t
 
	mrxsz
;

78 
size_t
 
	mtxqsz
;

79 
size_t
 
	mtxqsz_max
;

80 
boŞ
 
	maùive
;

81 
boŞ
 
	mcÚÃùed
;

86 
	stı_h–³r
 {

87 
Ë
 
	mË
;

88 
	mÏy”
;

89 
tı_h–³r_e¡ab_h
 *
	me¡abh
;

90 
tı_h–³r_£nd_h
 *
	m£ndh
;

91 
tı_h–³r_»cv_h
 *
	m»cvh
;

92 *
	m¬g
;

96 
	stı_q’t
 {

97 
Ë
 
	mË
;

98 
mbuf
 
	mmb
;

102 
tı_»cv_hªdËr
(
æags
, *
¬g
);

105 
boŞ
 
	$h–³r_e¡ab_hªdËr
(*
”r
, 
boŞ
 
aùive
, *
¬g
)

107 ()
”r
;

108 ()
aùive
;

109 ()
¬g
;

110  
çl£
;

111 
	}
}

114 
boŞ
 
	$h–³r_£nd_hªdËr
(*
”r
, 
mbuf
 *
mb
, *
¬g
)

116 ()
”r
;

117 ()
mb
;

118 ()
¬g
;

119  
çl£
;

120 
	}
}

123 
boŞ
 
	$h–³r_»cv_hªdËr
(*
”r
, 
mbuf
 *
mb
, 
boŞ
 *
e¡ab
,

124 *
¬g
)

126 ()
”r
;

127 ()
mb
;

128 ()
e¡ab
;

129 ()
¬g
;

130  
çl£
;

131 
	}
}

134 
	$sock_de¡ruùÜ
(*
d©a
)

136 
tı_sock
 *
ts
 = 
d©a
;

138 ià(
ts
->
fd
 >= 0) {

139 
	`fd_şo£
(
ts
->
fd
);

140 ()
	`şo£
(
ts
->
fd
);

142 ià(
ts
->
fdc
 >= 0)

143 ()
	`şo£
(
ts
->
fdc
);

144 
	}
}

147 
	$cÚn_de¡ruùÜ
(*
d©a
)

149 
tı_cÚn
 *
tc
 = 
d©a
;

151 
	`li¡_æush
(&
tc
->
h–³rs
);

152 
	`li¡_æush
(&
tc
->
£ndq
);

154 ià(
tc
->
fdc
 >= 0) {

155 
	`fd_şo£
(
tc
->
fdc
);

156 ()
	`şo£
(
tc
->
fdc
);

158 
	}
}

161 
	$h–³r_de¡ruùÜ
(*
d©a
)

163 
tı_h–³r
 *
th
 = 
d©a
;

165 
	`li¡_uÆšk
(&
th
->
Ë
);

166 
	}
}

169 
	$q’t_de¡ruùÜ
(*
¬g
)

171 
tı_q’t
 *
qe
 = 
¬g
;

173 
	`li¡_uÆšk
(&
qe
->
Ë
);

174 
	`mem_d”ef
(
qe
->
mb
.
buf
);

175 
	}
}

178 
	$’queue
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
)

180 cÚ¡ 
size_t
 
n
 = 
	`mbuf_g‘_Ëá
(
mb
);

181 
tı_q’t
 *
qe
;

182 
”r
;

184 ià(
tc
->
txqsz
 + 
n
 >c->
txqsz_max
)

185  
ENOSPC
;

187 ià(!
tc
->
£ndq
.
h—d
 && !tc->
£ndh
) {

189 
”r
 = 
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
 | 
FD_WRITE
,

190 
tı_»cv_hªdËr
, 
tc
);

191 ià(
”r
)

192  
”r
;

195 
qe
 = 
	`mem_z®loc
((*qe), 
q’t_de¡ruùÜ
);

196 ià(!
qe
)

197  
ENOMEM
;

199 
	`li¡_­³nd
(&
tc
->
£ndq
, &
qe
->
Ë
, qe);

201 
	`mbuf_š™
(&
qe
->
mb
);

203 
”r
 = 
	`mbuf_wr™e_mem
(&
qe
->
mb
, 
	`mbuf_buf
(mb), 
n
);

204 
qe
->
mb
.
pos
 = 0;

206 ià(
”r
)

207 
	`mem_d”ef
(
qe
);

209 
tc
->
txqsz
 +ğ
qe
->
mb
.
’d
;

211  
”r
;

212 
	}
}

215 
	$dequeue
(
tı_cÚn
 *
tc
)

217 
tı_q’t
 *
qe
 = 
	`li¡_Ëd©a
(
tc
->
£ndq
.
h—d
);

218 
ssize_t
 
n
;

219 #ifdeà
MSG_NOSIGNAL


220 cÚ¡ 
æags
 = 
MSG_NOSIGNAL
;

222 cÚ¡ 
æags
 = 0;

224 ià(!
qe
) {

225 ià(
tc
->
£ndh
)

226 
tc
->
	`£ndh
Ñc->
¬g
);

231 
n
 = 
	`£nd
(
tc
->
fdc
, 
BUF_CAST
 
	`mbuf_buf
(&
qe
->
mb
),

232 
qe
->
mb
.
’d
 - qe->mb.
pos
, 
æags
);

233 ià(
n
 < 0) {

234 ià(
EAGAIN
 =ğ
”ºo
)

236 #ifdeà
WIN32


237 ià(
WSAEWOULDBLOCK
 =ğ
	`WSAG‘La¡E¼Ü
())

240  
”ºo
;

243 
tc
->
txqsz
 -ğ
n
;

244 
qe
->
mb
.
pos
 +ğ
n
;

246 ià(
qe
->
mb
.
pos
 >ğqe->mb.
’d
)

247 
	`mem_d”ef
(
qe
);

250 
	}
}

253 
	$cÚn_şo£
(
tı_cÚn
 *
tc
, 
”r
)

255 
	`li¡_æush
(&
tc
->
£ndq
);

256 
tc
->
txqsz
 = 0;

259 ià(
tc
->
fdc
 >= 0) {

260 
	`fd_şo£
(
tc
->
fdc
);

261 ()
	`şo£
(
tc
->
fdc
);

262 
tc
->
fdc
 = -1;

265 ià(
tc
->
şo£h
)

266 
tc
->
	`şo£h
(
”r
,c->
¬g
);

267 
	}
}

270 
	$tı_»cv_hªdËr
(
æags
, *
¬g
)

272 
tı_cÚn
 *
tc
 = 
¬g
;

273 
mbuf
 *
mb
 = 
NULL
;

274 
boŞ
 
hÍ_e¡ab
 = 
çl£
;

275 
Ë
 *le;

276 
ssize_t
 
n
;

277 
”r
;

278 
sockËn_t
 
”r_Ën
 = (
”r
);

280 ià(
æags
 & 
FD_EXCEPT
) {

281 
	`DEBUG_INFO
("»cv hªdËr: gÙ FD_EXCEPT oÀfd=%d\n", 
tc
->
fdc
);

285 ià(-1 =ğ
	`g‘sockİt
(
tc
->
fdc
, 
SOL_SOCKET
, 
SO_ERROR
,

286 
BUF_CAST
 &
”r
, &
”r_Ën
)) {

287 
	`DEBUG_WARNING
("»cv hªdËr: g‘sockİt: (%m)\n", 
”ºo
);

291 ià(
”r
) {

292 
	`cÚn_şo£
(
tc
, 
”r
);

296 ià(
EINPROGRESS
 !ğ
”r
 && 
EALREADY
 !=ƒrr) {

297 
	`DEBUG_WARNING
("»cv hªdËr: Sock‘ƒ¼Ü (%m)\n", 
”r
);

302 ià(
æags
 & 
FD_WRITE
) {

304 ià(
tc
->
cÚÃùed
) {

306 
ušt32_t
 
Äefs
;

308 
	`mem_»f
(
tc
);

310 
”r
 = 
	`dequeue
(
tc
);

312 
Äefs
 = 
	`mem_Äefs
(
tc
);

313 
	`mem_d”ef
(
tc
);

316 ià(
Äefs
 == 1)

319 ià(
”r
) {

320 
	`cÚn_şo£
(
tc
, 
”r
);

324 ià(!
tc
->
£ndq
.
h—d
 && !tc->
£ndh
) {

326 
”r
 = 
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
,

327 
tı_»cv_hªdËr
, 
tc
);

328 ià(
”r
) {

329 
	`cÚn_şo£
(
tc
, 
”r
);

334 ià(
æags
 & 
FD_READ
)

335 
»ad
;

340 
tc
->
cÚÃùed
 = 
Œue
;

342 
”r
 = 
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
, 
tı_»cv_hªdËr
,c);

343 ià(
”r
) {

344 
	`DEBUG_WARNING
("»cv hªdËr: fd_li¡’(): %m\n", 
”r
);

345 
	`cÚn_şo£
(
tc
, 
”r
);

349 
Ë
 = 
tc
->
h–³rs
.
h—d
;

350 
Ë
) {

351 
tı_h–³r
 *
th
 = 
Ë
->
d©a
;

353 
Ë
 =†e->
Ãxt
;

355 ià(
th
->
	`e¡abh
(&
”r
, 
tc
->
aùive
,h->
¬g
) ||ƒrr) {

356 ià(
”r
)

357 
	`cÚn_şo£
(
tc
, 
”r
);

362 ià(
tc
->
e¡abh
)

363 
tc
->
	`e¡abh
Ñc->
¬g
);

368 
»ad
:

369 
mb
 = 
	`mbuf_®loc
(
tc
->
rxsz
);

370 ià(!
mb
)

373 
n
 = 
	`»cv
(
tc
->
fdc
, 
BUF_CAST
 
mb
->
buf
, mb->
size
, 0);

374 ià(0 =ğ
n
) {

375 
	`mem_d”ef
(
mb
);

376 
	`cÚn_şo£
(
tc
, 0);

379 ià(
n
 < 0) {

380 
	`DEBUG_WARNING
("»cv hªdËr:„ecv(): %m\n", 
”ºo
);

381 
out
;

384 
mb
->
’d
 = 
n
;

386 
Ë
 = 
tc
->
h–³rs
.
h—d
;

387 
Ë
) {

388 
tı_h–³r
 *
th
 = 
Ë
->
d©a
;

389 
boŞ
 
hdld
 = 
çl£
;

391 
Ë
 =†e->
Ãxt
;

393 ià(
hÍ_e¡ab
) {

395 
hdld
 |ğ
th
->
	`e¡abh
(&
”r
, 
tc
->
aùive
,h->
¬g
);

396 ià(
”r
) {

397 
	`cÚn_şo£
(
tc
, 
”r
);

398 
out
;

402 ià(
mb
->
pos
 < mb->
’d
) {

404 
hdld
 |ğ
th
->
	`»cvh
(&
”r
, 
mb
, &
hÍ_e¡ab
,h->
¬g
);

405 ià(
”r
) {

406 
	`cÚn_şo£
(
tc
, 
”r
);

407 
out
;

411 ià(
hdld
)

412 
out
;

415 
	`mbuf_Œim
(
mb
);

417 ià(
hÍ_e¡ab
 && 
tc
->
e¡abh
) {

419 
ušt32_t
 
Äefs
;

421 
	`mem_»f
(
tc
);

423 
tc
->
	`e¡abh
Ñc->
¬g
);

425 
Äefs
 = 
	`mem_Äefs
(
tc
);

426 
	`mem_d”ef
(
tc
);

429 ià(
Äefs
 == 1)

430 
out
;

433 ià(
mb
->
pos
 < mb->
’d
 && 
tc
->
»cvh
) {

434 
tc
->
	`»cvh
(
mb
,c->
¬g
);

437 
out
:

438 
	`mem_d”ef
(
mb
);

439 
	}
}

442 
tı_cÚn
 *
	$cÚn_®loc
(
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
,

443 
tı_şo£_h
 *
ch
, *
¬g
)

445 
tı_cÚn
 *
tc
;

447 
tc
 = 
	`mem_z®loc
((*tc), 
cÚn_de¡ruùÜ
);

448 ià(!
tc
)

449  
NULL
;

451 
	`li¡_š™
(&
tc
->
h–³rs
);

453 
tc
->
fdc
 = -1;

454 
tc
->
rxsz
 = 
TCP_RXSZ_DEFAULT
;

455 
tc
->
txqsz_max
 = 
TCP_TXQSZ_DEFAULT
;

456 
tc
->
e¡abh
 = 
eh
;

457 
tc
->
»cvh
 = 
rh
;

458 
tc
->
şo£h
 = 
ch
;

459 
tc
->
¬g
 =‡rg;

461  
tc
;

462 
	}
}

465 
	$tı_sockİt_£t
(
fd
)

467 #ifdeà
SO_LINGER


468 cÚ¡ 
lšg”
 
dl
 = {0, 0};

469 
”r
;

471 
”r
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_LINGER
, 
BUF_CAST
 &
dl
, (dl));

472 ià(
”r
) {

473 
	`DEBUG_WARNING
("sockİt: SO_LINGER (%m)\n", 
”r
);

476 ()
fd
;

478 
	}
}

487 
	$tı_cÚn_hªdËr
(
æags
, *
¬g
)

489 
§
 
³”
;

490 
tı_sock
 *
ts
 = 
¬g
;

491 
”r
;

493 ()
æags
;

495 
	`§_š™
(&
³”
, 
AF_UNSPEC
);

497 ià(
ts
->
fdc
 >= 0)

498 ()
	`şo£
(
ts
->
fdc
);

500 
ts
->
fdc
 = 
SOK_CAST
 
	`acû±
Ñs->
fd
, &
³”
.
u
.
§
, &³”.
Ën
);

501 ià(-1 =ğ
ts
->
fdc
) {

503 #ià
TARGET_OS_IPHONE


504 ià(
EAGAIN
 =ğ
”ºo
) {

506 
tı_sock
 *
ts_Ãw
;

507 
§
 
Ïddr
;

509 
”r
 = 
	`tı_sock_loÿl_g‘
(
ts
, &
Ïddr
);

510 ià(
”r
)

513 ià(
ts
->
fd
 >= 0) {

514 
	`fd_şo£
(
ts
->
fd
);

515 ()
	`şo£
(
ts
->
fd
);

516 
ts
->
fd
 = -1;

519 
”r
 = 
	`tı_li¡’
(&
ts_Ãw
, &
Ïddr
, 
NULL
, NULL);

520 ià(
”r
)

523 
ts
->
fd
 = 
ts_Ãw
->fd;

524 
ts_Ãw
->
fd
 = -1;

526 
	`mem_d”ef
(
ts_Ãw
);

528 
	`fd_li¡’
(
ts
->
fd
, 
FD_READ
, 
tı_cÚn_hªdËr
,s);

535 
”r
 = 
	`Ãt_sockİt_blockšg_£t
(
ts
->
fdc
, 
çl£
);

536 ià(
”r
) {

537 
	`DEBUG_WARNING
("cÚÀhªdËr:‚Úblock s‘: %m\n", 
”r
);

538 ()
	`şo£
(
ts
->
fdc
);

539 
ts
->
fdc
 = -1;

543 
	`tı_sockİt_£t
(
ts
->
fdc
);

545 ià(
ts
->
cÚnh
)

546 
ts
->
	`cÚnh
(&
³”
,s->
¬g
);

547 
	}
}

560 
	$tı_sock_®loc
(
tı_sock
 **
t¥
, cÚ¡ 
§
 *
loÿl
,

561 
tı_cÚn_h
 *
ch
, *
¬g
)

563 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

564 
addr
[64] = "";

565 
£rv
[6] = "0";

566 
tı_sock
 *
ts
 = 
NULL
;

567 
”rÜ
, 
”r
;

569 ià(!
t¥
)

570  
EINVAL
;

572 
ts
 = 
	`mem_z®loc
((*ts), 
sock_de¡ruùÜ
);

573 ià(!
ts
)

574  
ENOMEM
;

576 
ts
->
fd
 = -1;

577 
ts
->
fdc
 = -1;

579 ià(
loÿl
) {

580 ()
	`»_¢´štf
(
addr
, (addr), "%H",

581 
§_´št_addr
, 
loÿl
);

582 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
loÿl
));

585 
	`mem£t
(&
hšts
, 0, (hints));

587 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

588 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

589 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

590 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

592 
”rÜ
 = 
	`g‘addršfo
(
addr
[0] ?‡dd¸: 
NULL
, 
£rv
, &
hšts
, &
»s
);

593 ià(
”rÜ
) {

594 #ifdeà
WIN32


595 
	`DEBUG_WARNING
("listen: getaddrinfo: wsaerr=%d\n",

596 
	`WSAG‘La¡E¼Ü
());

598 
	`DEBUG_WARNING
("listen: getaddrinfo: %s:%sƒrror=%d (%s)\n",

599 
addr
, 
£rv
, 
”rÜ
, 
	`gai_¡»¼Ü
(error));

600 
”r
 = 
EADDRNOTAVAIL
;

601 
out
;

604 
”r
 = 
EINVAL
;

605 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

606 
fd
 = -1;

608 ià(
ts
->
fd
 >= 0)

611 
fd
 = 
SOK_CAST
 
	`sock‘
(
r
->
ai_çmy
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

612 ià(
fd
 < 0) {

613 
”r
 = 
”ºo
;

617 ()
	`Ãt_sockİt_»u£_£t
(
fd
, 
Œue
);

619 
”r
 = 
	`Ãt_sockİt_blockšg_£t
(
fd
, 
çl£
);

620 ià(
”r
) {

621 
	`DEBUG_WARNING
("li¡’:‚Úblock s‘: %m\n", 
”r
);

622 ()
	`şo£
(
fd
);

626 
	`tı_sockİt_£t
(
fd
);

629 
ts
->
fd
 = fd;

630 
”r
 = 0;

634 
	`ä“addršfo
(
»s
);

636 ià(-1 =ğ
ts
->
fd
)

637 
out
;

639 
ts
->
cÚnh
 = 
ch
;

640 
ts
->
¬g
 =‡rg;

642 
out
:

643 ià(
”r
)

644 
	`mem_d”ef
(
ts
);

646 *
t¥
 = 
ts
;

648  
”r
;

649 
	}
}

660 
	$tı_sock_bšd
(
tı_sock
 *
ts
, cÚ¡ 
§
 *
loÿl
)

662 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

663 
addr
[64] = "";

664 
£rv
[
NI_MAXSERV
] = "0";

665 
”rÜ
, 
”r
;

667 ià(!
ts
 ||s->
fd
<0)

668  
EINVAL
;

670 ià(
loÿl
) {

671 ()
	`»_¢´štf
(
addr
, (addr), "%H",

672 
§_´št_addr
, 
loÿl
);

673 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
loÿl
));

676 
	`mem£t
(&
hšts
, 0, (hints));

678 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

679 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

680 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

681 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

683 
”rÜ
 = 
	`g‘addršfo
(
addr
[0] ?‡dd¸: 
NULL
, 
£rv
, &
hšts
, &
»s
);

684 ià(
”rÜ
) {

685 #ifdeà
WIN32


686 
	`DEBUG_WARNING
("sock_bind: getaddrinfo: wsaerr=%d\n",

687 
	`WSAG‘La¡E¼Ü
());

689 
	`DEBUG_WARNING
("sock_bind: getaddrinfo: %s:%sƒrror=%d (%s)\n",

690 
addr
, 
£rv
, 
”rÜ
, 
	`gai_¡»¼Ü
(error));

691  
EADDRNOTAVAIL
;

694 
”r
 = 
EINVAL
;

695 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

697 ià(
	`bšd
(
ts
->
fd
, 
r
->
ai_addr
, 
SIZ_CAST
„->
ai_add¾’
) < 0) {

698 
”r
 = 
”ºo
;

699 
	`DEBUG_WARNING
("sock_bind: bind: %m (af=%d, %J)\n",

700 
”r
, 
r
->
ai_çmy
, 
loÿl
);

705 
”r
 = 0;

709 
	`ä“addršfo
(
»s
);

711  
”r
;

712 
	}
}

723 
	$tı_sock_li¡’
(
tı_sock
 *
ts
, 
backlog
)

725 
”r
;

727 ià(!
ts
)

728  
EINVAL
;

730 ià(
ts
->
fd
 < 0) {

731 
	`DEBUG_WARNING
("sock_listen: invalid fd\n");

732  
EBADF
;

735 ià(
	`li¡’
(
ts
->
fd
, 
backlog
) < 0) {

736 
”r
 = 
”ºo
;

737 
	`DEBUG_WARNING
("sock_li¡’:†i¡’(): %m\n", 
”r
);

738  
”r
;

741  
	`fd_li¡’
(
ts
->
fd
, 
FD_READ
, 
tı_cÚn_hªdËr
,s);

742 
	}
}

757 
	$tı_acû±
(
tı_cÚn
 **
tı
, 
tı_sock
 *
ts
, 
tı_e¡ab_h
 *
eh
,

758 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
, *
¬g
)

760 
tı_cÚn
 *
tc
;

761 
”r
;

763 ià(!
tı
 || !
ts
 ||s->
fdc
 < 0)

764  
EINVAL
;

766 
tc
 = 
	`cÚn_®loc
(
eh
, 
rh
, 
ch
, 
¬g
);

767 ià(!
tc
)

768  
ENOMEM
;

771 
tc
->
fdc
 = 
ts
->fdc;

772 
ts
->
fdc
 = -1;

774 
”r
 = 
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
 | 
FD_WRITE
 | 
FD_EXCEPT
,

775 
tı_»cv_hªdËr
, 
tc
);

776 ià(
”r
) {

777 
	`DEBUG_WARNING
("acû±: fd_li¡’(): %m\n", 
”r
);

780 ià(
”r
)

781 
	`mem_d”ef
(
tc
);

783 *
tı
 = 
tc
;

785  
”r
;

786 
	}
}

794 
	$tı_»jeù
(
tı_sock
 *
ts
)

796 ià(!
ts
)

799 ià(
ts
->
fdc
 >= 0) {

800 ()
	`şo£
(
ts
->
fdc
);

801 
ts
->
fdc
 = -1;

803 
	}
}

818 
	$tı_cÚn_®loc
(
tı_cÚn
 **
tı
,

819 cÚ¡ 
§
 *
³”
, 
tı_e¡ab_h
 *
eh
,

820 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
, *
¬g
)

822 
tı_cÚn
 *
tc
;

823 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

824 
addr
[64];

825 
£rv
[
NI_MAXSERV
] = "0";

826 
”rÜ
, 
”r
;

828 ià(!
tı
 || !
	`§_is£t
(
³”
, 
SA_ALL
))

829  
EINVAL
;

831 
tc
 = 
	`cÚn_®loc
(
eh
, 
rh
, 
ch
, 
¬g
);

832 ià(!
tc
)

833  
ENOMEM
;

835 
	`mem£t
(&
hšts
, 0, (hints));

837 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

838 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

839 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

840 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

842 ()
	`»_¢´štf
(
addr
, (addr), "%H",

843 
§_´št_addr
, 
³”
);

844 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
³”
));

846 
”rÜ
 = 
	`g‘addršfo
(
addr
, 
£rv
, &
hšts
, &
»s
);

847 ià(
”rÜ
) {

848 
	`DEBUG_WARNING
("connect: getaddrinfo(): (%s)\n",

849 
	`gai_¡»¼Ü
(
”rÜ
));

850 
”r
 = 
EADDRNOTAVAIL
;

851 
out
;

854 
”r
 = 
EINVAL
;

855 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

857 
tc
->
fdc
 = 
SOK_CAST
 
	`sock‘
(
r
->
ai_çmy
, 
SOCK_STREAM
,

858 
IPPROTO_TCP
);

859 ià(
tc
->
fdc
 < 0) {

860 
”r
 = 
”ºo
;

864 
”r
 = 
	`Ãt_sockİt_blockšg_£t
(
tc
->
fdc
, 
çl£
);

865 ià(
”r
) {

866 
	`DEBUG_WARNING
("cÚÃù:‚Úblock s‘: %m\n", 
”r
);

867 ()
	`şo£
(
tc
->
fdc
);

868 
tc
->
fdc
 = -1;

872 
	`tı_sockİt_£t
(
tc
->
fdc
);

874 
”r
 = 0;

878 
	`ä“addršfo
(
»s
);

880 
out
:

881 ià(
”r
)

882 
	`mem_d”ef
(
tc
);

884 *
tı
 = 
tc
;

886  
”r
;

887 
	}
}

898 
	$tı_cÚn_bšd
(
tı_cÚn
 *
tc
, cÚ¡ 
§
 *
loÿl
)

900 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

901 
addr
[64] = "";

902 
£rv
[
NI_MAXSERV
] = "0";

903 
”rÜ
, 
”r
;

905 ià(!
tc
)

906  
EINVAL
;

908 ià(
loÿl
) {

909 ()
	`»_¢´štf
(
addr
, (addr), "%H",

910 
§_´št_addr
, 
loÿl
);

911 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
loÿl
));

914 
	`mem£t
(&
hšts
, 0, (hints));

916 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

917 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

918 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

919 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

921 
”rÜ
 = 
	`g‘addršfo
(
addr
[0] ?‡dd¸: 
NULL
, 
£rv
, &
hšts
, &
»s
);

922 ià(
”rÜ
) {

923 
	`DEBUG_WARNING
("conn_bind: getaddrinfo(): (%s)\n",

924 
	`gai_¡»¼Ü
(
”rÜ
));

925  
EADDRNOTAVAIL
;

928 
”r
 = 
EINVAL
;

929 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

931 ()
	`Ãt_sockİt_»u£_£t
(
tc
->
fdc
, 
Œue
);

934 ià(
	`bšd
(
tc
->
fdc
, 
r
->
ai_addr
, 
SIZ_CAST
„->
ai_add¾’
) < 0) {

937 ià(0 =ğ
”ºo
) {

938 
ok
;

941 
”r
 = 
”ºo
;

942 
	`DEBUG_WARNING
("conn_bind: bind(): %J: %m\n",

943 
loÿl
, 
”r
);

947 
ok
:

949 
”r
 = 0;

953 
	`ä“addršfo
(
»s
);

955 ià(
”r
) {

956 
	`DEBUG_WARNING
("cÚn_bšd faed: %J (%m)\n", 
loÿl
, 
”r
);

959  
”r
;

960 
	}
}

971 
	$tı_cÚn_cÚÃù
(
tı_cÚn
 *
tc
, cÚ¡ 
§
 *
³”
)

973 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

974 
addr
[64];

975 
£rv
[
NI_MAXSERV
];

976 
”rÜ
, 
”r
 = 0;

978 ià(!
tc
 || !
	`§_is£t
(
³”
, 
SA_ALL
))

979  
EINVAL
;

981 
tc
->
aùive
 = 
Œue
;

983 ià(
tc
->
fdc
 < 0) {

984 
	`DEBUG_WARNING
("invalid fd\n");

985  
EBADF
;

988 
	`mem£t
(&
hšts
, 0, (hints));

990 
hšts
.
ai_çmy
 = 
PF_UNSPEC
;

991 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

992 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

993 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

995 ()
	`»_¢´štf
(
addr
, (addr), "%H",

996 
§_´št_addr
, 
³”
);

997 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
³”
));

999 
”rÜ
 = 
	`g‘addršfo
(
addr
, 
£rv
, &
hšts
, &
»s
);

1000 ià(
”rÜ
) {

1001 
	`DEBUG_WARNING
("connect: getaddrinfo(): (%s)\n",

1002 
	`gai_¡»¼Ü
(
”rÜ
));

1003  
EADDRNOTAVAIL
;

1006 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

1007 
sockaddr
 *
§
 = 
r
->
ai_addr
;

1009 
agaš
:

1010 ià(0 =ğ
	`cÚÃù
(
tc
->
fdc
, 
§
, 
SIZ_CAST
 
r
->
ai_add¾’
)) {

1011 
”r
 = 0;

1012 
out
;

1015 #ifdeà
WIN32


1017 ià(
WSAEWOULDBLOCK
 =ğ
	`WSAG‘La¡E¼Ü
()) {

1018 
”r
 = 0;

1019 
out
;

1024 ià(0 =ğ
”ºo
) {

1025 
”r
 = 0;

1026 
out
;

1029 ià(
EINTR
 =ğ
”ºo
)

1030 
agaš
;

1032 ià(
EINPROGRESS
 !ğ
”ºo
 && 
EALREADY
 !=ƒrrno) {

1033 
”r
 = 
”ºo
;

1034 
	`DEBUG_INFO
("connect: connect() %J: %m\n",

1035 
³”
, 
”r
);

1040 
out
:

1041 
	`ä“addršfo
(
»s
);

1043 ià(
”r
)

1044  
”r
;

1046  
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
 | 
FD_WRITE
 | 
FD_EXCEPT
,

1047 
tı_»cv_hªdËr
, 
tc
);

1048 
	}
}

1051 
	$tı_£nd_š‹º®
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
,

1052 
Ë
 *le)

1054 
”r
 = 0;

1055 
ssize_t
 
n
;

1056 #ifdeà
MSG_NOSIGNAL


1057 cÚ¡ 
æags
 = 
MSG_NOSIGNAL
;

1059 cÚ¡ 
æags
 = 0;

1062 ià(
tc
->
fdc
 < 0)

1063  
ENOTCONN
;

1065 ià(!
	`mbuf_g‘_Ëá
(
mb
)) {

1066 
	`DEBUG_WARNING
("send:ƒmpty mbuf (pos=%uƒnd=%u)\n",

1067 
mb
->
pos
, mb->
’d
);

1068  
EINVAL
;

1072 
Ë
) {

1073 
tı_h–³r
 *
th
 = 
Ë
->
d©a
;

1075 
Ë
 =†e->
´ev
;

1077 ià(
th
->
	`£ndh
(&
”r
, 
mb
,h->
¬g
) ||ƒrr)

1078  
”r
;

1081 ià(
tc
->
£ndq
.
h—d
)

1082  
	`’queue
(
tc
, 
mb
);

1084 
n
 = 
	`£nd
(
tc
->
fdc
, 
BUF_CAST
 
	`mbuf_buf
(
mb
), mb->
’d
 - mb->
pos
, 
æags
);

1085 ià(
n
 < 0) {

1087 ià(
EAGAIN
 =ğ
”ºo
)

1088  
	`’queue
(
tc
, 
mb
);

1090 #ifdeà
WIN32


1091 ià(
WSAEWOULDBLOCK
 =ğ
	`WSAG‘La¡E¼Ü
())

1092  
	`’queue
(
tc
, 
mb
);

1094 
”r
 = 
”ºo
;

1096 
	`DEBUG_WARNING
("£nd: wr™e(): %m (fdc=%d)\n", 
”r
, 
tc
->
fdc
);

1098 #ifdeà
WIN32


1099 
	`DEBUG_WARNING
("WIN32ƒ¼Ü: %d\n", 
	`WSAG‘La¡E¼Ü
());

1102  
”r
;

1105 ià((
size_t
)
n
 < 
mb
->
’d
 - mb->
pos
) {

1107 
mb
->
pos
 +ğ
n
;

1108 
”r
 = 
	`’queue
(
tc
, 
mb
);

1109 
mb
->
pos
 -ğ
n
;

1111  
”r
;

1115 
	}
}

1126 
	$tı_£nd
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
)

1128 ià(!
tc
 || !
mb
)

1129  
EINVAL
;

1131  
	`tı_£nd_š‹º®
(
tc
, 
mb
,c->
h–³rs
.

);

1132 
	}
}

1145 
	$tı_£nd_h–³r
(
tı_cÚn
 *
tc
, 
mbuf
 *
mb
,

1146 
tı_h–³r
 *
th
)

1148 ià(!
tc
 || !
mb
 || !
th
)

1149  
EINVAL
;

1151  
	`tı_£nd_š‹º®
(
tc
, 
mb
, 
th
->
Ë
.
´ev
);

1152 
	}
}

1164 
	$tı_£t_£nd
(
tı_cÚn
 *
tc
, 
tı_£nd_h
 *
£ndh
)

1166 ià(!
tc
)

1167  
EINVAL
;

1169 
tc
->
£ndh
 = sendh;

1171 ià(
tc
->
£ndq
.
h—d
 || !
£ndh
)

1174  
	`fd_li¡’
(
tc
->
fdc
, 
FD_READ
 | 
FD_WRITE
, 
tı_»cv_hªdËr
,c);

1175 
	}
}

1187 
	$tı_£t_hªdËrs
(
tı_cÚn
 *
tc
, 
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
,

1188 
tı_şo£_h
 *
ch
, *
¬g
)

1190 ià(!
tc
)

1193 
tc
->
e¡abh
 = 
eh
;

1194 
tc
->
»cvh
 = 
rh
;

1195 
tc
->
şo£h
 = 
ch
;

1196 
tc
->
¬g
 =‡rg;

1197 
	}
}

1208 
	$tı_sock_loÿl_g‘
(cÚ¡ 
tı_sock
 *
ts
, 
§
 *
loÿl
)

1210 ià(!
ts
 || !
loÿl
)

1211  
EINVAL
;

1213 
	`§_š™
(
loÿl
, 
AF_UNSPEC
);

1215 ià(
	`g‘sockÇme
(
ts
->
fd
, &
loÿl
->
u
.
§
, &loÿl->
Ën
) < 0) {

1216 
	`DEBUG_WARNING
("loÿÈg‘: g‘sockÇme(): %m\n", 
”ºo
);

1217  
”ºo
;

1221 
	}
}

1232 
	$tı_cÚn_loÿl_g‘
(cÚ¡ 
tı_cÚn
 *
tc
, 
§
 *
loÿl
)

1234 ià(!
tc
 || !
loÿl
)

1235  
EINVAL
;

1237 
	`§_š™
(
loÿl
, 
AF_UNSPEC
);

1239 ià(
	`g‘sockÇme
(
tc
->
fdc
, &
loÿl
->
u
.
§
, &loÿl->
Ën
) < 0) {

1240 
	`DEBUG_WARNING
("cÚÀloÿÈg‘: g‘sockÇme(): %m\n", 
”ºo
);

1241  
”ºo
;

1245 
	}
}

1256 
	$tı_cÚn_³”_g‘
(cÚ¡ 
tı_cÚn
 *
tc
, 
§
 *
³”
)

1258 ià(!
tc
 || !
³”
)

1259  
EINVAL
;

1261 
	`§_š™
(
³”
, 
AF_UNSPEC
);

1263 ià(
	`g‘³”Çme
(
tc
->
fdc
, &
³”
->
u
.
§
, &³”->
Ën
) < 0) {

1264 
	`DEBUG_WARNING
("cÚÀ³” g‘: g‘³”Çme(): %m\n", 
”ºo
);

1265  
”ºo
;

1269 
	}
}

1278 
	$tı_cÚn_rxsz_£t
(
tı_cÚn
 *
tc
, 
size_t
 
rxsz
)

1280 ià(!
tc
)

1283 
tc
->
rxsz
 =„xsz;

1284 
	}
}

1293 
	$tı_cÚn_txqsz_£t
(
tı_cÚn
 *
tc
, 
size_t
 
txqsz
)

1295 ià(!
tc
)

1298 
tc
->
txqsz_max
 = 
txqsz
;

1299 
	}
}

1309 
	$tı_cÚn_fd
(cÚ¡ 
tı_cÚn
 *
tc
)

1311  
tc
 ?c->
fdc
 : -1;

1312 
	}
}

1322 
size_t
 
	$tı_cÚn_txqsz
(cÚ¡ 
tı_cÚn
 *
tc
)

1324  
tc
 ?c->
txqsz
 : 0;

1325 
	}
}

1328 
boŞ
 
	$sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

1330 
tı_h–³r
 *
th1
 = 
Ë1
->
d©a
, *
th2
 = 
Ë2
->data;

1331 ()
¬g
;

1333  
th1
->
Ïy”
 <ğ
th2
->layer;

1334 
	}
}

1350 
	$tı_»gi¡”_h–³r
(
tı_h–³r
 **
thp
, 
tı_cÚn
 *
tc
,

1351 
Ïy”
,

1352 
tı_h–³r_e¡ab_h
 *
eh
, 
tı_h–³r_£nd_h
 *
sh
,

1353 
tı_h–³r_»cv_h
 *
rh
, *
¬g
)

1355 
tı_h–³r
 *
th
;

1357 ià(!
tc
)

1358  
EINVAL
;

1360 
th
 = 
	`mem_z®loc
((*th), 
h–³r_de¡ruùÜ
);

1361 ià(!
th
)

1362  
ENOMEM
;

1364 
	`li¡_­³nd
(&
tc
->
h–³rs
, &
th
->
Ë
,h);

1366 
th
->
Ïy”
 =†ayer;

1367 
th
->
e¡abh
 = 
eh
 ?ƒh : 
h–³r_e¡ab_hªdËr
;

1368 
th
->
£ndh
 = 
sh
 ? sh : 
h–³r_£nd_hªdËr
;

1369 
th
->
»cvh
 = 
rh
 ?„h : 
h–³r_»cv_hªdËr
;

1370 
th
->
¬g
 =‡rg;

1372 
	`li¡_sÜt
(&
tc
->
h–³rs
, 
sÜt_hªdËr
, 
NULL
);

1374 ià(
thp
)

1375 *
thp
 = 
th
;

1378 
	}
}

	@re-0.5.6/src/tcp/tcp_high.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_tı.h
>

22 
	$tı_li¡’
(
tı_sock
 **
t¥
, cÚ¡ 
§
 *
loÿl
,

23 
tı_cÚn_h
 *
ch
, *
¬g
)

25 
tı_sock
 *
ts
 = 
NULL
;

26 
”r
;

28 ià(!
t¥
)

29  
EINVAL
;

31 
”r
 = 
	`tı_sock_®loc
(&
ts
, 
loÿl
, 
ch
, 
¬g
);

32 ià(
”r
)

33 
out
;

35 
”r
 = 
	`tı_sock_bšd
(
ts
, 
loÿl
);

36 ià(
”r
)

37 
out
;

39 
”r
 = 
	`tı_sock_li¡’
(
ts
, 5);

40 ià(
”r
)

41 
out
;

43 
out
:

44 ià(
”r
)

45 
ts
 = 
	`mem_d”ef
(ts);

47 *
t¥
 = 
ts
;

49  
”r
;

50 
	}
}

65 
	$tı_cÚÃù
(
tı_cÚn
 **
tı
, cÚ¡ 
§
 *
³”
,

66 
tı_e¡ab_h
 *
eh
, 
tı_»cv_h
 *
rh
, 
tı_şo£_h
 *
ch
, *
¬g
)

68 
tı_cÚn
 *
tc
 = 
NULL
;

69 
”r
;

71 ià(!
tı
 || !
³”
)

72  
EINVAL
;

74 
”r
 = 
	`tı_cÚn_®loc
(&
tc
, 
³”
, 
eh
,
rh
, 
ch
, 
¬g
);

75 ià(
”r
)

76 
out
;

78 
”r
 = 
	`tı_cÚn_cÚÃù
(
tc
, 
³”
);

79 ià(
”r
)

80 
out
;

82 
out
:

83 ià(
”r
)

84 
tc
 = 
	`mem_d”ef
(tc);

86 *
tı
 = 
tc
;

88  
”r
;

89 
	}
}

100 
	$tı_loÿl_g‘
(cÚ¡ 
tı_sock
 *
ts
, 
§
 *
loÿl
)

102  
	`tı_sock_loÿl_g‘
(
ts
, 
loÿl
);

103 
	}
}

	@re-0.5.6/src/telev/telev.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_li¡.h
>

11 
	~<»_tmr.h
>

12 
	~<»_Ãt.h
>

13 
	~<»_‹Ëv.h
>

47 
	mTXC_DIGIT_MIN
 = 9,

48 
	mTXC_END
 = 3,

49 
	mEVENT_END
 = 0xff,

50 
	mPAYLOAD_SIZE
 = 4,

51 
	mVOLUME
 = 10,

52 
	mQUEUE_SIZE
 = 8192,

56 
	e¡©e
 {

57 
	mIDLE
,

58 
	mSENDING
,

59 
	mENDING
,

63 
	s‹Ëv_fmt
 {

64 
ušt8_t
 
	mev’t
;

65 
boŞ
 
	m’d
;

66 
ušt8_t
 
	mvŞ
;

67 
ušt16_t
 
	mdur
;

72 
	s‹Ëv
 {

74 
mbuf
 *
	mmb
;

75 
ušt32_t
 
	m±ime
;

76 
ušt16_t
 
	mpdur
;

77 
¡©e
 
	m¡©e
;

78 
	mev’t
;

79 
ušt16_t
 
	mdur
;

80 
ušt32_t
 
	mtxc
;

83 
	mrx_ev’t
;

84 
boŞ
 
	mrx_’d
;

88 cÚ¡ 
	g‹Ëv_¹pfmt
[] = "telephone-event";

91 
	$·ylßd_’code
(
mbuf
 *
mb
, 
ev’t
, 
boŞ
 
’d
, 
ušt16_t
 
dur
)

93 
size_t
 
pos
;

94 
”r
;

96 ià(!
mb
)

97  
EINVAL
;

99 
pos
 = 
mb
->pos;

101 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 
ev’t
);

102 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, (
’d
 ? 0x80 : 0x00è| (
VOLUME
 & 0x3f));

103 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
dur
));

105 ià(
”r
)

106 
mb
->
pos
 =…os;

108  
”r
;

109 
	}
}

112 
	$·ylßd_decode
(
mbuf
 *
mb
, 
‹Ëv_fmt
 *
fmt
)

114 
ušt8_t
 
b
;

116 ià(!
mb
 || !
fmt
)

117  
EINVAL
;

119 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
PAYLOAD_SIZE
)

120  
ENOENT
;

122 
fmt
->
ev’t
 = 
	`mbuf_»ad_u8
(
mb
);

123 
b
 = 
	`mbuf_»ad_u8
(
mb
);

124 
fmt
->
’d
 = (
b
 & 0x80) == 0x80;

125 
fmt
->
vŞ
 = (
b
 & 0x3f);

126 
fmt
->
dur
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

129 
	}
}

132 
	$de¡ruùÜ
(*
¬g
)

134 
‹Ëv
 *
t
 = 
¬g
;

136 
	`mem_d”ef
(
t
->
mb
);

137 
	}
}

148 
	$‹Ëv_®loc
(
‹Ëv
 **

, 
ušt32_t
 
±ime
)

150 
‹Ëv
 *
t
;

151 
”r
 = 0;

153 ià(!

 || !
±ime
)

154  
EINVAL
;

156 
t
 = 
	`mem_z®loc
((*t), 
de¡ruùÜ
);

157 ià(!
t
)

158  
ENOMEM
;

160 
t
->
mb
 = 
	`mbuf_®loc
(16);

161 ià(!
t
->
mb
) {

162 
”r
 = 
ENOMEM
;

163 
out
;

166 
t
->
¡©e
 = 
IDLE
;

167 
t
->
±ime
 =…time;

168 
t
->
pdur
 = 
±ime
 * 8;

169 
t
->
rx_ev’t
 = -1;

171 
out
:

172 ià(
”r
)

173 
	`mem_d”ef
(
t
);

175 *

 = 
t
;

177  
”r
;

178 
	}
}

189 
	$‹Ëv_£t_¤©e
(
‹Ëv
 *
‹l
, 
ušt32_t
 
¤©e
)

191 ià(!
‹l
 || !
¤©e
)

192  
EINVAL
;

194 
‹l
->
pdur
 =–->
±ime
 * 
¤©e
 / 1000;

197 
	}
}

209 
	$‹Ëv_£nd
(
‹Ëv
 *
‹l
, 
ev’t
, 
boŞ
 
’d
)

211 
size_t
 
pos
;

212 
”r
;

214 ià(!
‹l
)

215  
EINVAL
;

217 ià(
‹l
->
mb
->
’d
 >ğ
QUEUE_SIZE
)

218  
EOVERFLOW
;

220 
pos
 = 
‹l
->
mb
->pos;

222 
‹l
->
mb
->
pos
 =–->mb->
’d
;

223 
”r
 = 
	`mbuf_wr™e_u8
(
‹l
->
mb
, 
’d
 ? 
EVENT_END
 : 
ev’t
);

224 
‹l
->
mb
->
pos
 =…os;

226  
”r
;

227 
	}
}

240 
	$‹Ëv_»cv
(
‹Ëv
 *
‹l
, 
mbuf
 *
mb
, *
ev’t
, 
boŞ
 *
’d
)

242 
‹Ëv_fmt
 
fmt
;

243 
”r
;

245 ià(!
‹l
 || !
mb
 || !
ev’t
 || !
’d
)

246  
EINVAL
;

248 
”r
 = 
	`·ylßd_decode
(
mb
, &
fmt
);

249 ià(
”r
)

250  
”r
;

252 ià(
fmt
.
’d
) {

253 ià(
‹l
->
rx_’d
)

254  
EALREADY
;

256 *
ev’t
 = 
fmt
.event;

257 *
’d
 = 
Œue
;

258 
‹l
->
rx_ev’t
 = -1;

259 
‹l
->
rx_’d
 = 
Œue
;

263 ià(
fmt
.
ev’t
 =ğ
‹l
->
rx_ev’t
)

264  
EALREADY
;

266 *
ev’t
 = 
‹l
->
rx_ev’t
 = 
fmt
.event;

267 *
’d
 = 
‹l
->
rx_’d
 = 
çl£
;

270 
	}
}

282 
	$‹Ëv_pŞl
(
‹Ëv
 *
‹l
, 
boŞ
 *
m¬k”
, 
mbuf
 *
mb
)

284 
boŞ
 
mrk
 = 
çl£
;

285 
”r
 = 
ENOENT
;

287 ià(!
‹l
 || !
m¬k”
 || !
mb
)

288  
EINVAL
;

290 
‹l
->
¡©e
) {

292 
IDLE
:

293 ià(!
	`mbuf_g‘_Ëá
(
‹l
->
mb
))

296 
mrk
 = 
Œue
;

298 
‹l
->
ev’t
 = 
	`mbuf_»ad_u8
Ñ–->
mb
);

299 
‹l
->
dur
 =–->
pdur
;

300 
‹l
->
¡©e
 = 
SENDING
;

301 
‹l
->
txc
 = 1;

303 
”r
 = 
	`·ylßd_’code
(
mb
, 
‹l
->
ev’t
, 
çl£
,–->
dur
);

306 
SENDING
:

307 
‹l
->
dur
 +ğ‹l->
pdur
;

309 
”r
 = 
	`·ylßd_’code
(
mb
, 
‹l
->
ev’t
, 
çl£
,–->
dur
);

311 ià(++
‹l
->
txc
 < 
TXC_DIGIT_MIN
)

314 ià(!
	`mbuf_g‘_Ëá
(
‹l
->
mb
))

317 ià(
	`mbuf_»ad_u8
(
‹l
->
mb
è!ğ
EVENT_END
)

318 
‹l
->
mb
->
pos
--;

320 
‹l
->
¡©e
 = 
ENDING
;

321 
‹l
->
txc
 = 0;

324 
ENDING
:

325 
”r
 = 
	`·ylßd_’code
(
mb
, 
‹l
->
ev’t
, 
Œue
,–->
dur
);

327 ià(++
‹l
->
txc
 < 
TXC_END
)

330 ià(!
	`mbuf_g‘_Ëá
(
‹l
->
mb
))

331 
‹l
->
mb
->
pos
 =–->mb->
’d
 = 0;

333 
‹l
->
¡©e
 = 
IDLE
;

337 ià(!
”r
)

338 *
m¬k”
 = 
mrk
;

340  
”r
;

341 
	}
}

351 
	$‹Ëv_dig™2code
(
dig™
)

353 ià(
	`isdig™
(
dig™
))

354  
dig™
 - '0';

355 ià(
dig™
 == '*')

357 ià(
dig™
 == '#')

359 ià('a' <ğ
dig™
 && digit <= 'd')

360  
dig™
 - 'a' + 12;

361 ià('A' <ğ
dig™
 && digit <= 'D')

362  
dig™
 - 'A' + 12;

365 
	}
}

375 
	$‹Ëv_code2dig™
(
code
)

377 cÚ¡ 
m­
[] = "0123456789*#ABCD";

379 ià(
code
 < 0 || code >= 16)

382  
m­
[
code
];

383 
	}
}

	@re-0.5.6/src/tls/openssl/tls.c

6 
	~<¡ršg.h
>

7 
	~<İ’s¦/s¦.h
>

8 
	~<İ’s¦/”r.h
>

9 
	~<İ’s¦/r§.h
>

10 
	~<İ’s¦/bn.h
>

11 
	~<İ’s¦/evp.h
>

12 
	~<İ’s¦/x509.h
>

13 
	~<»_ty³s.h
>

14 
	~<»_fmt.h
>

15 
	~<»_mem.h
>

16 
	~<»_mbuf.h
>

17 
	~<»_maš.h
>

18 
	~<»_§.h
>

19 
	~<»_Ãt.h
>

20 
	~<»_¤.h
>

21 
	~<»_sys.h
>

22 
	~<»_tı.h
>

23 
	~<»_s.h
>

24 
	~"s.h
"

28 #ifdeà
WIN32


29 #undeà
X509_NAME


33 
	#DEBUG_MODULE
 "s"

	)

34 
	#DEBUG_LEVEL
 5

	)

35 
	~<»_dbg.h
>

39 
	ss_cÚn
 {

40 
SSL
 *
	ms¦
;

44 
	$de¡ruùÜ
(*
d©a
)

46 
s
 * ğ
d©a
;

48 ià(
s
->
ùx
)

49 
	`SSL_CTX_ä“
(
s
->
ùx
);

51 ià(
s
->
û¹
)

52 
	`X509_ä“
(
s
->
û¹
);

54 
	`mem_d”ef
(
s
->
·ss
);

56 #ifdeà
TLS_BIO_OPAQUE


57 ià(
s
->
m‘hod_tı
)

58 
	`BIO_m‘h_ä“
(
s
->
m‘hod_tı
);

59 ià(
s
->
m‘hod_udp
)

60 
	`BIO_m‘h_ä“
(
s
->
m‘hod_udp
);

62 
	}
}

66 
	$·sswÜd_cb
(*
buf
, 
size
, 
rwæag
, *
u£rd©a
)

68 
s
 * ğ
u£rd©a
;

70 ()
rwæag
;

72 
	`DEBUG_NOTICE
("password callback\n");

74 ià(
size
 < ()
	`¡¾’
(
s
->
·ss
)+1)

77 
	`¡ºıy
(
buf
, 
s
->
·ss
, 
size
);

79  ()
	`¡¾’
(
s
->
·ss
);

80 
	}
}

83 
	$keyty³2št
(
s_keyty³
 
ty³
)

85 
ty³
) {

86 
TLS_KEYTYPE_EC
:

87  
EVP_PKEY_EC
;

88 
TLS_KEYTYPE_RSA
:

89  
EVP_PKEY_RSA
;

91  
EVP_PKEY_NONE
;

93 
	}
}

106 
	$s_®loc
(
s
 **
¥
, 
s_m‘hod
 
m‘hod
, cÚ¡ *
keyfe
,

107 cÚ¡ *
pwd
)

109 
s
 *tls;

110 
r
, 
”r
;

112 ià(!
¥
)

113  
EINVAL
;

115 
s
 = 
	`mem_z®loc
((*s), 
de¡ruùÜ
);

116 ià(!
s
)

117  
ENOMEM
;

119 
m‘hod
) {

121 
TLS_METHOD_SSLV23
:

122 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_m‘hod
());

125 #ifdeà
USE_OPENSSL_DTLS


126 
TLS_METHOD_DTLSV1
:

127 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L && \

128 !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

130 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`DTLS_m‘hod
());

132 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`DTLSv1_m‘hod
());

136 #ifdeà
SSL_OP_NO_DTLSv1_2


139 
TLS_METHOD_DTLS
:

140 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`DTLS_m‘hod
());

143 
TLS_METHOD_DTLSV1_2
:

144 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L && \

145 !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

147 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`DTLS_m‘hod
());

149 
s
->
ùx
 = 
	`SSL_CTX_Ãw
(
	`DTLSv1_2_m‘hod
());

157 
	`DEBUG_WARNING
(" m‘hod %d‚Ù suµÜ‹d\n", 
m‘hod
);

158 
”r
 = 
ENOSYS
;

159 
out
;

162 ià(!
s
->
ùx
) {

163 
	`ERR_ş—r_”rÜ
();

164 
”r
 = 
ENOMEM
;

165 
out
;

168 #ià(
OPENSSL_VERSION_NUMBER
 < 0x00905100L)

169 
	`SSL_CTX_£t_v”ify_d•th
(
s
->
ùx
, 1);

173 ià(
keyfe
) {

174 ià(
pwd
) {

175 
”r
 = 
	`¡r_dup
(&
s
->
·ss
, 
pwd
);

176 ià(
”r
)

177 
out
;

179 
	`SSL_CTX_£t_deçuÉ_·sswd_cb
(
s
->
ùx
, 
·sswÜd_cb
);

180 
	`SSL_CTX_£t_deçuÉ_·sswd_cb_u£rd©a
(
s
->
ùx
,ls);

183 
r
 = 
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
s
->
ùx
, 
keyfe
);

184 ià(
r
 <= 0) {

185 
	`DEBUG_WARNING
("Can't„ead certificate file: %s (%d)\n",

186 
keyfe
, 
r
);

187 
	`ERR_ş—r_”rÜ
();

188 
”r
 = 
EINVAL
;

189 
out
;

192 
r
 = 
	`SSL_CTX_u£_Priv©eKey_fe
(
s
->
ùx
, 
keyfe
,

193 
SSL_FILETYPE_PEM
);

194 ià(
r
 <= 0) {

195 
	`DEBUG_WARNING
("Can't„ead key file: %s (%d)\n",

196 
keyfe
, 
r
);

197 
	`ERR_ş—r_”rÜ
();

198 
”r
 = 
EINVAL
;

199 
out
;

203 #ifdeà
TLS_BIO_OPAQUE


204 
s
->
m‘hod_tı
 = 
	`s_m‘hod_tı
();

205 
s
->
m‘hod_udp
 = 
	`s_m‘hod_udp
();

206 ià(!
s
->
m‘hod_tı
 || !s->
m‘hod_udp
) {

207 
”r
 = 
ENOMEM
;

208 
out
;

212 
”r
 = 0;

213 
out
:

214 ià(
”r
)

215 
	`mem_d”ef
(
s
);

217 *
¥
 = 
s
;

219  
”r
;

220 
	}
}

231 
	$s_add_ÿ
(
s
 *s, cÚ¡ *
ÿ·th
)

233 ià(!
s
 || !
ÿ·th
)

234  
EINVAL
;

237 ià(!(
	`SSL_CTX_lßd_v”ify_loÿtiÚs
(
s
->
ùx
, 
ÿ·th
, 0))) {

238 
	`DEBUG_WARNING
("Cª'ˆ»ad CA†i¡: %s\n", 
ÿ·th
);

239 
	`ERR_ş—r_”rÜ
();

240  
EINVAL
;

244 
	}
}

255 
	$s_£t_£lfsigÃd
(
s
 *s, cÚ¡ *
ú
)

257 
X509_NAME
 *
subj
 = 
NULL
;

258 
EVP_PKEY
 *
key
 = 
NULL
;

259 
X509
 *
û¹
 = 
NULL
;

260 
BIGNUM
 *
bn
 = 
NULL
;

261 
RSA
 *
r§
 = 
NULL
;

262 
r
, 
”r
 = 
ENOMEM
;

264 ià(!
s
 || !
ú
)

265  
EINVAL
;

267 
r§
 = 
	`RSA_Ãw
();

268 ià(!
r§
)

269 
out
;

271 
bn
 = 
	`BN_Ãw
();

272 ià(!
bn
)

273 
out
;

275 
	`BN_£t_wÜd
(
bn
, 
RSA_F4
);

276 ià(!
	`RSA_g’”©e_key_ex
(
r§
, 1024, 
bn
, 
NULL
))

277 
out
;

279 
key
 = 
	`EVP_PKEY_Ãw
();

280 ià(!
key
)

281 
out
;

283 ià(!
	`EVP_PKEY_£t1_RSA
(
key
, 
r§
))

284 
out
;

286 
û¹
 = 
	`X509_Ãw
();

287 ià(!
û¹
)

288 
out
;

290 ià(!
	`X509_£t_v”siÚ
(
û¹
, 2))

291 
out
;

293 ià(!
	`ASN1_INTEGER_£t
(
	`X509_g‘_£rŸlNumb”
(
û¹
), 
	`¿nd_u32
()))

294 
out
;

296 
subj
 = 
	`X509_NAME_Ãw
();

297 ià(!
subj
)

298 
out
;

300 ià(!
	`X509_NAME_add_’Œy_by_txt
(
subj
, "CN", 
MBSTRING_ASC
,

301 (*)
ú
,

302 ()
	`¡¾’
(
ú
), -1, 0))

303 
out
;

305 ià(!
	`X509_£t_issu”_Çme
(
û¹
, 
subj
) ||

306 !
	`X509_£t_subjeù_Çme
(
û¹
, 
subj
))

307 
out
;

309 ià(!
	`X509_gmtime_adj
(
	`X509_g‘_nÙBefÜe
(
û¹
), -3600*24*365) ||

310 !
	`X509_gmtime_adj
(
	`X509_g‘_nÙAá”
(
û¹
), 3600*24*365*10))

311 
out
;

313 ià(!
	`X509_£t_pubkey
(
û¹
, 
key
))

314 
out
;

316 ià(!
	`X509_sign
(
û¹
, 
key
, 
	`EVP_sha1
()))

317 
out
;

319 
r
 = 
	`SSL_CTX_u£_û¹ifiÿ‹
(
s
->
ùx
, 
û¹
);

320 ià(
r
 != 1)

321 
out
;

323 
r
 = 
	`SSL_CTX_u£_Priv©eKey
(
s
->
ùx
, 
key
);

324 ià(
r
 != 1)

325 
out
;

327 ià(
s
->
û¹
)

328 
	`X509_ä“
(
s
->
û¹
);

330 
s
->
û¹
 = cert;

331 
û¹
 = 
NULL
;

333 
”r
 = 0;

335 
out
:

336 ià(
subj
)

337 
	`X509_NAME_ä“
(
subj
);

339 ià(
û¹
)

340 
	`X509_ä“
(
û¹
);

342 ià(
key
)

343 
	`EVP_PKEY_ä“
(
key
);

345 ià(
r§
)

346 
	`RSA_ä“
(
r§
);

348 ià(
bn
)

349 
	`BN_ä“
(
bn
);

351 ià(
”r
)

352 
	`ERR_ş—r_”rÜ
();

354  
”r
;

355 
	}
}

369 
	$s_£t_û¹ifiÿ‹_³m
(
s
 *s, cÚ¡ *
û¹
, 
size_t
 
Ën_û¹
,

370 cÚ¡ *
key
, 
size_t
 
Ën_key
)

372 
BIO
 *
bio
 = 
NULL
, *
kbio
 = NULL;

373 
X509
 *
x509
 = 
NULL
;

374 
EVP_PKEY
 *
pkey
 = 
NULL
;

375 
r
, 
”r
 = 
ENOMEM
;

377 ià(!
s
 || !
û¹
 || !
Ën_û¹
 || (
key
 && !
Ën_key
))

378  
EINVAL
;

380 ià(!
key
) {

381 
key
 = 
û¹
;

382 
Ën_key
 = 
Ën_û¹
;

385 
bio
 = 
	`BIO_Ãw_mem_buf
((*)
û¹
, ()
Ën_û¹
);

386 
kbio
 = 
	`BIO_Ãw_mem_buf
((*)
key
, ()
Ën_key
);

387 ià(!
bio
 || !
kbio
)

388 
out
;

390 
x509
 = 
	`PEM_»ad_bio_X509
(
bio
, 
NULL
, 0, NULL);

391 
pkey
 = 
	`PEM_»ad_bio_Priv©eKey
(
kbio
, 
NULL
, 0, NULL);

392 ià(!
x509
 || !
pkey
)

393 
out
;

395 
r
 = 
	`SSL_CTX_u£_û¹ifiÿ‹
(
s
->
ùx
, 
x509
);

396 ià(
r
 != 1)

397 
out
;

399 
r
 = 
	`SSL_CTX_u£_Priv©eKey
(
s
->
ùx
, 
pkey
);

400 ià(
r
 != 1) {

401 
	`DEBUG_WARNING
("set_certificate_pem: use_PrivateKey failed\n");

402 
out
;

405 ià(
s
->
û¹
)

406 
	`X509_ä“
(
s
->
û¹
);

408 
s
->
û¹
 = 
x509
;

409 
x509
 = 
NULL
;

411 
”r
 = 0;

413 
out
:

414 ià(
x509
)

415 
	`X509_ä“
(
x509
);

416 ià(
pkey
)

417 
	`EVP_PKEY_ä“
(
pkey
);

418 ià(
bio
)

419 
	`BIO_ä“
(
bio
);

420 ià(
kbio
)

421 
	`BIO_ä“
(
kbio
);

422 ià(
”r
)

423 
	`ERR_ş—r_”rÜ
();

425  
”r
;

426 
	}
}

441 
	$s_£t_û¹ifiÿ‹_d”
(
s
 *s, 
s_keyty³
 
keyty³
,

442 cÚ¡ 
ušt8_t
 *
û¹
, 
size_t
 
Ën_û¹
,

443 cÚ¡ 
ušt8_t
 *
key
, 
size_t
 
Ën_key
)

445 cÚ¡ 
ušt8_t
 *
buf_û¹
;

446 
X509
 *
x509
 = 
NULL
;

447 
EVP_PKEY
 *
pkey
 = 
NULL
;

448 
r
, 
ty³
, 
”r
 = 
ENOMEM
;

450 ià(!
s
 || !
û¹
 || !
Ën_û¹
 || (
key
 && !
Ën_key
))

451  
EINVAL
;

453 
ty³
 = 
	`keyty³2št
(
keyty³
);

454 ià(
ty³
 =ğ
EVP_PKEY_NONE
)

455  
EINVAL
;

457 
buf_û¹
 = 
û¹
;

459 
x509
 = 
	`d2i_X509
(
NULL
, &
buf_û¹
, 
Ën_û¹
);

460 ià(!
x509
)

461 
out
;

463 ià(!
key
) {

464 
key
 = 
buf_û¹
;

465 
Ën_key
 = 
Ën_û¹
 - (
buf_û¹
 - 
û¹
);

468 
pkey
 = 
	`d2i_Priv©eKey
(
ty³
, 
NULL
, &
key
, 
Ën_key
);

469 ià(!
pkey
)

470 
out
;

472 
r
 = 
	`SSL_CTX_u£_û¹ifiÿ‹
(
s
->
ùx
, 
x509
);

473 ià(
r
 != 1)

474 
out
;

476 
r
 = 
	`SSL_CTX_u£_Priv©eKey
(
s
->
ùx
, 
pkey
);

477 ià(
r
 != 1) {

478 
	`DEBUG_WARNING
("set_certificate_der: use_PrivateKey failed\n");

479 
out
;

482 ià(
s
->
û¹
)

483 
	`X509_ä“
(
s
->
û¹
);

485 
s
->
û¹
 = 
x509
;

486 
x509
 = 
NULL
;

488 
”r
 = 0;

490 
out
:

491 ià(
x509
)

492 
	`X509_ä“
(
x509
);

493 ià(
pkey
)

494 
	`EVP_PKEY_ä“
(
pkey
);

495 ià(
”r
)

496 
	`ERR_ş—r_”rÜ
();

498  
”r
;

499 
	}
}

511 
	$s_£t_û¹ifiÿ‹
(
s
 *s, cÚ¡ *
³m
, 
size_t
 
Ën
)

513  
	`s_£t_û¹ifiÿ‹_³m
(
s
, 
³m
, 
Ën
, 
NULL
, 0);

514 
	}
}

517 
	$v”ify_hªdËr
(
ok
, 
X509_STORE_CTX
 *
ùx
)

519 ()
ok
;

520 ()
ùx
;

523 
	}
}

531 
	$s_£t_v”ify_ş›Á
(
s
 *tls)

533 ià(!
s
)

536 
	`SSL_CTX_£t_v”ify_d•th
(
s
->
ùx
, 0);

537 
	`SSL_CTX_£t_v”ify
(
s
->
ùx
, 
SSL_VERIFY_PEER
 | 
SSL_VERIFY_CLIENT_ONCE
,

538 
v”ify_hªdËr
);

539 
	}
}

550 
	$s_£t_¤
(
s
 *s, cÚ¡ *
su™es
)

552 #ifdeà
USE_OPENSSL_SRTP


553 ià(!
s
 || !
su™es
)

554  
EINVAL
;

556 ià(0 !ğ
	`SSL_CTX_£t_£xt_u£_¤
(
s
->
ùx
, 
su™es
)) {

557 
	`ERR_ş—r_”rÜ
();

558  
ENOSYS
;

563 ()
s
;

564 ()
su™es
;

566  
ENOSYS
;

568 
	}
}

571 
	$û¹_fšg”´št
(
X509
 *
û¹
, 
s_fšg”´št
 
ty³
,

572 
ušt8_t
 *
md
, 
size_t
 
size
)

574 
Ën
 = ()
size
;

575 
n
;

577 
ty³
) {

579 
TLS_FINGERPRINT_SHA1
:

580 ià(
size
 < 20)

581  
EOVERFLOW
;

583 
n
 = 
	`X509_dige¡
(
û¹
, 
	`EVP_sha1
(), 
md
, &
Ën
);

586 
TLS_FINGERPRINT_SHA256
:

587 ià(
size
 < 32)

588  
EOVERFLOW
;

590 
n
 = 
	`X509_dige¡
(
û¹
, 
	`EVP_sha256
(), 
md
, &
Ën
);

594  
ENOSYS
;

597 ià(
n
 != 1) {

598 
	`ERR_ş—r_”rÜ
();

599  
ENOENT
;

603 
	}
}

616 
	$s_fšg”´št
(cÚ¡ 
s
 *s, 
s_fšg”´št
 
ty³
,

617 
ušt8_t
 *
md
, 
size_t
 
size
)

619 ià(!
s
 || !s->
û¹
 || !
md
)

620  
EINVAL
;

622  
	`û¹_fšg”´št
(
s
->
û¹
, 
ty³
, 
md
, 
size
);

623 
	}
}

636 
	$s_³”_fšg”´št
(cÚ¡ 
s_cÚn
 *
tc
, 
s_fšg”´št
 
ty³
,

637 
ušt8_t
 *
md
, 
size_t
 
size
)

639 
X509
 *
û¹
;

640 
”r
;

642 ià(!
tc
 || !
md
)

643  
EINVAL
;

645 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
tc
->
s¦
);

646 ià(!
û¹
)

647  
ENOENT
;

649 
”r
 = 
	`û¹_fšg”´št
(
û¹
, 
ty³
, 
md
, 
size
);

651 
	`X509_ä“
(
û¹
);

653  
”r
;

654 
	}
}

666 
	$s_³”_commÚ_Çme
(cÚ¡ 
s_cÚn
 *
tc
, *
ú
, 
size_t
 
size
)

668 
X509
 *
û¹
;

669 
n
;

671 ià(!
tc
 || !
ú
 || !
size
)

672  
EINVAL
;

674 
û¹
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
tc
->
s¦
);

675 ià(!
û¹
)

676  
ENOENT
;

678 
n
 = 
	`X509_NAME_g‘_‹xt_by_NID
(
	`X509_g‘_subjeù_Çme
(
û¹
),

679 
NID_commÚName
, 
ú
, ()
size
);

681 
	`X509_ä“
(
û¹
);

683 ià(
n
 < 0) {

684 
	`ERR_ş—r_”rÜ
();

685  
ENOENT
;

689 
	}
}

699 
	$s_³”_v”ify
(cÚ¡ 
s_cÚn
 *
tc
)

701 ià(!
tc
)

702  
EINVAL
;

704 ià(
	`SSL_g‘_v”ify_»suÉ
(
tc
->
s¦
è!ğ
X509_V_OK
)

705  
EAUTH
;

708 
	}
}

723 
	$s_¤_keyšfo
(cÚ¡ 
s_cÚn
 *
tc
, 
¤_su™e
 *
su™e
,

724 
ušt8_t
 *
şi_key
, 
size_t
 
şi_key_size
,

725 
ušt8_t
 *
¤v_key
, 
size_t
 
¤v_key_size
)

727 #ifdeà
USE_OPENSSL_SRTP


728 cÚ¡ *
Ïb–
 = "EXTRACTOR-dtls_srtp";

729 
size_t
 
key_size
, 
§É_size
, 
size
;

730 
SRTP_PROTECTION_PROFILE
 *
£l
;

731 
ušt8_t
 
keym©
[256], *
p
;

733 ià(!
tc
 || !
su™e
 || !
şi_key
 || !
¤v_key
)

734  
EINVAL
;

736 
£l
 = 
	`SSL_g‘_£Ëùed_¤_´ofe
(
tc
->
s¦
);

737 ià(!
£l
)

738  
ENOENT
;

740 
£l
->
id
) {

742 
SRTP_AES128_CM_SHA1_80
:

743 *
su™e
 = 
SRTP_AES_CM_128_HMAC_SHA1_80
;

744 
key_size
 = 16;

745 
§É_size
 = 14;

748 
SRTP_AES128_CM_SHA1_32
:

749 *
su™e
 = 
SRTP_AES_CM_128_HMAC_SHA1_32
;

750 
key_size
 = 16;

751 
§É_size
 = 14;

755  
ENOSYS
;

758 
size
 = 
key_size
 + 
§É_size
;

760 ià(
şi_key_size
 < 
size
 || 
¤v_key_size
 < size)

761  
EOVERFLOW
;

763 ià((
keym©
è< 2*
size
)

764  
EOVERFLOW
;

766 ià(1 !ğ
	`SSL_expÜt_keyšg_m©”Ÿl
(
tc
->
s¦
, 
keym©
, 2*
size
, 
Ïb–
,

767 
	`¡¾’
(
Ïb–
), 
NULL
, 0, 0)) {

768 
	`ERR_ş—r_”rÜ
();

769  
ENOENT
;

772 
p
 = 
keym©
;

774 
	`memıy
(
şi_key
, 
p
, 
key_size
);… += key_size;

775 
	`memıy
(
¤v_key
, 
p
, 
key_size
);… += key_size;

776 
	`memıy
(
şi_key
 + 
key_size
, 
p
, 
§É_size
);… += salt_size;

777 
	`memıy
(
¤v_key
 + 
key_size
, 
p
, 
§É_size
);

781 ()
tc
;

782 ()
su™e
;

783 ()
şi_key
;

784 ()
şi_key_size
;

785 ()
¤v_key
;

786 ()
¤v_key_size
;

788  
ENOSYS
;

790 
	}
}

800 cÚ¡ *
	$s_ch”_Çme
(cÚ¡ 
s_cÚn
 *
tc
)

802 ià(!
tc
)

803  
NULL
;

805  
	`SSL_g‘_ch”_Çme
(
tc
->
s¦
);

806 
	}
}

818 
	$s_£t_ch”s
(
s
 *s, cÚ¡ *
ch”v
[], 
size_t
 
couÁ
)

820 
mbuf
 *
mb
;

821 
r
, 
”r
;

822 
size_t
 
i
;

824 ià(!
s
 || !
ch”v
 || !
couÁ
)

825  
EINVAL
;

827 
mb
 = 
	`mbuf_®loc
(32 * 
couÁ
);

828 ià(!
mb
)

829  
ENOMEM
;

831 
i
=0; i<
couÁ
; i++) {

833 
”r
 = 
	`mbuf_´štf
(
mb
, "%s%s", 
i
>0 ? ":" : "", 
ch”v
[i]);

834 ià(
”r
)

835 
out
;

838 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, '\0');

839 ià(
”r
)

840 
out
;

842 
r
 = 
	`SSL_CTX_£t_ch”_li¡
(
s
->
ùx
, (*)
mb
->
buf
);

843 ià(
r
 <= 0) {

844 
	`ERR_ş—r_”rÜ
();

845 
”r
 = 
EPROTO
;

846 
out
;

849 
out
:

850 
	`mem_d”ef
(
mb
);

852  
”r
;

853 
	}
}

864 
	$s_£t_£rv”Çme
(
s_cÚn
 *
tc
, cÚ¡ *
£rv”Çme
)

866 ià(!
tc
 || !
£rv”Çme
)

867  
EINVAL
;

869 ià(1 !ğ
	`SSL_£t_£xt_ho¡_Çme
(
tc
->
s¦
, 
£rv”Çme
)) {

870 
	`DEBUG_WARNING
("tls: SSL_set_tlsext_host_nameƒrror\n");

871 
	`ERR_ş—r_”rÜ
();

872  
EPROTO
;

876 
	}
}

879 
	$´št_”rÜ
(cÚ¡ *
¡r
, 
size_t
 
Ën
, *
unu£d
)

881 ()
unu£d
;

882 
	`DEBUG_WARNING
("%b", 
¡r
, 
Ën
);

885 
	}
}

888 
	$s_æush_”rÜ
()

890 
	`ERR_´št_”rÜs_cb
(
´št_”rÜ
, 
NULL
);

891 
	}
}

901 
s¦_ùx_¡
 *
	$s_İ’s¦_cÚ‹xt
(cÚ¡ 
s
 *tls)

903  
s
 ?ls->
ùx
 : 
NULL
;

904 
	}
}

	@re-0.5.6/src/tls/openssl/tls.h

12 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L

13 
	#TLS_BIO_OPAQUE
 1

	)

16 #ià
defšed
 (
LIBRESSL_VERSION_NUMBER
)

17 #undeà
TLS_BIO_OPAQUE


21 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L && \

22 !
	$defšed
(
LIBRESSL_VERSION_NUMBER
)

23 
	#SSL_¡©e
 
SSL_g‘_¡©e


	)

24 
	#SSL_ST_OK
 
TLS_ST_OK


	)

28 
	ss
 {

29 
SSL_CTX
 *
ùx
;

30 
X509
 *
û¹
;

31 *
·ss
;

32 #ifdeà
TLS_BIO_OPAQUE


33 
BIO_METHOD
 *
m‘hod_tı
;

34 
BIO_METHOD
 *
m‘hod_udp
;

39 #ifdeà
TLS_BIO_OPAQUE


40 
BIO_METHOD
 *
	`s_m‘hod_tı
();

41 
BIO_METHOD
 *
	`s_m‘hod_udp
();

45 
	`s_æush_”rÜ
();

	@re-0.5.6/src/tls/openssl/tls_tcp.c

7 
	~<İ’s¦/s¦.h
>

8 
	~<İ’s¦/”r.h
>

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

11 
	~<»_mem.h
>

12 
	~<»_mbuf.h
>

13 
	~<»_maš.h
>

14 
	~<»_§.h
>

15 
	~<»_Ãt.h
>

16 
	~<»_¤.h
>

17 
	~<»_tı.h
>

18 
	~<»_s.h
>

19 
	~"s.h
"

22 
	#DEBUG_MODULE
 "s"

	)

23 
	#DEBUG_LEVEL
 5

	)

24 
	~<»_dbg.h
>

28 
	ss_cÚn
 {

29 
SSL
 *
	ms¦
;

30 
BIO
 *
	msbio_out
;

31 
BIO
 *
	msbio_š
;

32 
tı_h–³r
 *
	mth
;

33 
tı_cÚn
 *
	mtı
;

34 
boŞ
 
	maùive
;

35 
boŞ
 
	mup
;

39 
	$de¡ruùÜ
(*
¬g
)

41 
s_cÚn
 *
tc
 = 
¬g
;

43 ià(
tc
->
s¦
) {

44 
r
 = 
	`SSL_shutdown
(
tc
->
s¦
);

45 ià(
r
 <= 0)

46 
	`ERR_ş—r_”rÜ
();

48 
	`SSL_ä“
(
tc
->
s¦
);

50 
	`mem_d”ef
(
tc
->
th
);

51 
	`mem_d”ef
(
tc
->
tı
);

52 
	}
}

55 
	$bio_ü—‹
(
BIO
 *
b
)

57 #ifdeà
TLS_BIO_OPAQUE


58 
	`BIO_£t_š™
(
b
, 1);

59 
	`BIO_£t_d©a
(
b
, 
NULL
);

60 
	`BIO_£t_æags
(
b
, 0);

62 
b
->
š™
 = 1;

63 
b
->
num
 = 0;

64 
b
->
±r
 = 
NULL
;

65 
b
->
æags
 = 0;

69 
	}
}

72 
	$bio_de¡roy
(
BIO
 *
b
)

74 ià(!
b
)

77 #ifdeà
TLS_BIO_OPAQUE


78 
	`BIO_£t_š™
(
b
, 0);

79 
	`BIO_£t_d©a
(
b
, 
NULL
);

80 
	`BIO_£t_æags
(
b
, 0);

82 
b
->
±r
 = 
NULL
;

83 
b
->
š™
 = 0;

84 
b
->
æags
 = 0;

88 
	}
}

91 
	$bio_wr™e
(
BIO
 *
b
, cÚ¡ *
buf
, 
Ën
)

93 #ifdeà
TLS_BIO_OPAQUE


94 
s_cÚn
 *
tc
 = 
	`BIO_g‘_d©a
(
b
);

96 
s_cÚn
 *
tc
 = 
b
->
±r
;

98 
mbuf
 
mb
;

99 
”r
;

101 
mb
.
buf
 = (*)buf;

102 
mb
.
pos
 = 0;

103 
mb
.
’d
 = mb.
size
 = 
Ën
;

105 
”r
 = 
	`tı_£nd_h–³r
(
tc
->
tı
, &
mb
,c->
th
);

106 ià(
”r
)

109  
Ën
;

110 
	}
}

113 
	$bio_ù¾
(
BIO
 *
b
, 
cmd
, 
num
, *
±r
)

115 ()
b
;

116 ()
num
;

117 ()
±r
;

119 ià(
cmd
 =ğ
BIO_CTRL_FLUSH
) {

125 
	}
}

128 #iâdeà
TLS_BIO_OPAQUE


129 
bio_m‘hod_¡
 
	gbio_tı_£nd
 = {

130 
BIO_TYPE_SOURCE_SINK
,

132 
bio_wr™e
,

136 
bio_ù¾
,

137 
bio_ü—‹
,

138 
bio_de¡roy
,

144 
	$s_cÚÃù
(
s_cÚn
 *
tc
)

146 
”r
 = 0, 
r
;

148 
	`ERR_ş—r_”rÜ
();

150 
r
 = 
	`SSL_cÚÃù
(
tc
->
s¦
);

151 ià(
r
 <= 0) {

152 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
);

154 
	`ERR_ş—r_”rÜ
();

156 
s¦_”r
) {

158 
SSL_ERROR_WANT_READ
:

162 
	`DEBUG_WARNING
("connect:ƒrror (r=%d, ssl_err=%d)\n",

163 
r
, 
s¦_”r
);

164 
”r
 = 
EPROTO
;

169  
”r
;

170 
	}
}

173 
	$s_acû±
(
s_cÚn
 *
tc
)

175 
”r
 = 0, 
r
;

177 
	`ERR_ş—r_”rÜ
();

179 
r
 = 
	`SSL_acû±
(
tc
->
s¦
);

180 ià(
r
 <= 0) {

181 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
);

183 
	`ERR_ş—r_”rÜ
();

185 
s¦_”r
) {

187 
SSL_ERROR_WANT_READ
:

191 
	`DEBUG_WARNING
("acceptƒrror: (r=%d, ssl_err=%d)\n",

192 
r
, 
s¦_”r
);

193 
”r
 = 
EPROTO
;

198  
”r
;

199 
	}
}

202 
boŞ
 
	$e¡ab_hªdËr
(*
”r
, 
boŞ
 
aùive
, *
¬g
)

204 
s_cÚn
 *
tc
 = 
¬g
;

206 
	`DEBUG_INFO
("tıƒ¡ablished (aùive=%u)\n", 
aùive
);

208 ià(!
aùive
)

209  
Œue
;

211 
tc
->
aùive
 = 
Œue
;

212 *
”r
 = 
	`s_cÚÃù
(
tc
);

214  
Œue
;

215 
	}
}

218 
boŞ
 
	$»cv_hªdËr
(*
”r
, 
mbuf
 *
mb
, 
boŞ
 *
e¡ab
, *
¬g
)

220 
s_cÚn
 *
tc
 = 
¬g
;

221 
r
;

224 
r
 = 
	`BIO_wr™e
(
tc
->
sbio_š
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_Ëá
(mb));

225 ià(
r
 <= 0) {

226 
	`DEBUG_WARNING
("»cv: BIO_wr™%d\n", 
r
);

227 
	`ERR_ş—r_”rÜ
();

228 *
”r
 = 
ENOMEM
;

229  
Œue
;

232 ià(
	`SSL_¡©e
(
tc
->
s¦
è!ğ
SSL_ST_OK
) {

234 ià(
tc
->
up
) {

235 *
”r
 = 
EPROTO
;

236  
Œue
;

239 ià(
tc
->
aùive
) {

240 *
”r
 = 
	`s_cÚÃù
(
tc
);

243 *
”r
 = 
	`s_acû±
(
tc
);

246 
	`DEBUG_INFO
("¡©e=0x%04x\n", 
	`SSL_¡©e
(
tc
->
s¦
));

249 ià(
	`SSL_¡©e
(
tc
->
s¦
è!ğ
SSL_ST_OK
)

250  
Œue
;

252 *
e¡ab
 = 
Œue
;

253 
tc
->
up
 = 
Œue
;

256 
	`mbuf_£t_pos
(
mb
, 0);

259 
n
;

261 ià(
	`mbuf_g‘_¥aû
(
mb
) < 4096) {

262 *
”r
 = 
	`mbuf_»size
(
mb
, mb->
size
 + 8192);

263 ià(*
”r
)

264  
Œue
;

267 
	`ERR_ş—r_”rÜ
();

269 
n
 = 
	`SSL_»ad
(
tc
->
s¦
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_¥aû
(mb));

270 ià(
n
 <= 0) {

271 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
n
);

273 
	`ERR_ş—r_”rÜ
();

275 
s¦_”r
) {

277 
SSL_ERROR_WANT_READ
:

280 
SSL_ERROR_ZERO_RETURN
:

281 *
”r
 = 
ECONNRESET
;

282  
Œue
;

285 *
”r
 = 
EPROTO
;

286  
Œue
;

292 
mb
->
pos
 +ğ
n
;

295 
	`mbuf_£t_’d
(
mb
, mb->
pos
);

296 
	`mbuf_£t_pos
(
mb
, 0);

298  
çl£
;

299 
	}
}

302 
boŞ
 
	$£nd_hªdËr
(*
”r
, 
mbuf
 *
mb
, *
¬g
)

304 
s_cÚn
 *
tc
 = 
¬g
;

305 
r
;

307 
	`ERR_ş—r_”rÜ
();

309 
r
 = 
	`SSL_wr™e
(
tc
->
s¦
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_Ëá
(mb));

310 ià(
r
 <= 0) {

311 
	`DEBUG_WARNING
("SSL_wr™e: %d\n", 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
));

312 
	`ERR_ş—r_”rÜ
();

313 *
”r
 = 
EPROTO
;

316  
Œue
;

317 
	}
}

330 
	$s_¡¬t_tı
(
s_cÚn
 **
±c
, 
s
 *s, 
tı_cÚn
 *
tı
,

331 
Ïy”
)

333 
s_cÚn
 *
tc
;

334 
”r
;

336 ià(!
±c
 || !
s
 || !
tı
)

337  
EINVAL
;

339 
tc
 = 
	`mem_z®loc
((*tc), 
de¡ruùÜ
);

340 ià(!
tc
)

341  
ENOMEM
;

343 
”r
 = 
	`tı_»gi¡”_h–³r
(&
tc
->
th
, 
tı
, 
Ïy”
, 
e¡ab_hªdËr
,

344 
£nd_hªdËr
, 
»cv_hªdËr
, 
tc
);

345 ià(
”r
)

346 
out
;

348 
tc
->
tı
 = 
	`mem_»f
(tcp);

350 
”r
 = 
ENOMEM
;

353 
tc
->
s¦
 = 
	`SSL_Ãw
(
s
->
ùx
);

354 ià(!
tc
->
s¦
) {

355 
	`DEBUG_WARNING
("®loc: SSL_Ãw(èçed (ùx=%p)\n", 
s
->
ùx
);

356 
	`ERR_ş—r_”rÜ
();

357 
out
;

360 
tc
->
sbio_š
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

361 ià(!
tc
->
sbio_š
) {

362 
	`DEBUG_WARNING
("alloc: BIO_new() failed\n");

363 
	`ERR_ş—r_”rÜ
();

364 
out
;

368 #ifdeà
TLS_BIO_OPAQUE


369 
tc
->
sbio_out
 = 
	`BIO_Ãw
(
s
->
m‘hod_tı
);

371 
tc
->
sbio_out
 = 
	`BIO_Ãw
(&
bio_tı_£nd
);

373 ià(!
tc
->
sbio_out
) {

374 
	`DEBUG_WARNING
("alloc: BIO_new_socket() failed\n");

375 
	`ERR_ş—r_”rÜ
();

376 
	`BIO_ä“
(
tc
->
sbio_š
);

377 
out
;

380 #ifdeà
TLS_BIO_OPAQUE


381 
	`BIO_£t_d©a
(
tc
->
sbio_out
,c);

383 
tc
->
sbio_out
->
±r
 =c;

386 
	`SSL_£t_bio
(
tc
->
s¦
,c->
sbio_š
,c->
sbio_out
);

388 
”r
 = 0;

390 
out
:

391 ià(
”r
)

392 
	`mem_d”ef
(
tc
);

394 *
±c
 = 
tc
;

396  
”r
;

397 
	}
}

400 #ifdeà
TLS_BIO_OPAQUE


402 
BIO_METHOD
 *
	$s_m‘hod_tı
()

404 
BIO_METHOD
 *
m‘hod
;

406 
m‘hod
 = 
	`BIO_m‘h_Ãw
(
BIO_TYPE_SOURCE_SINK
, "tcp_send");

407 ià(!
m‘hod
) {

408 
	`DEBUG_WARNING
("alloc: BIO_meth_new() failed\n");

409 
	`ERR_ş—r_”rÜ
();

410  
NULL
;

413 
	`BIO_m‘h_£t_wr™e
(
m‘hod
, 
bio_wr™e
);

414 
	`BIO_m‘h_£t_ù¾
(
m‘hod
, 
bio_ù¾
);

415 
	`BIO_m‘h_£t_ü—‹
(
m‘hod
, 
bio_ü—‹
);

416 
	`BIO_m‘h_£t_de¡roy
(
m‘hod
, 
bio_de¡roy
);

418  
m‘hod
;

419 
	}
}

	@re-0.5.6/src/tls/openssl/tls_udp.c

7 
	~<sys/time.h
>

8 
	~<İ’s¦/s¦.h
>

9 
	~<İ’s¦/”r.h
>

10 
	~<»_ty³s.h
>

11 
	~<»_fmt.h
>

12 
	~<»_mem.h
>

13 
	~<»_mbuf.h
>

14 
	~<»_li¡.h
>

15 
	~<»_hash.h
>

16 
	~<»_§.h
>

17 
	~<»_¤.h
>

18 
	~<»_udp.h
>

19 
	~<»_tmr.h
>

20 
	~<»_s.h
>

21 
	~"s.h
"

24 
	#DEBUG_MODULE
 "ds"

	)

25 
	#DEBUG_LEVEL
 5

	)

26 
	~<»_dbg.h
>

30 
	mMTU_DEFAULT
 = 1400,

31 
	mMTU_FALLBACK
 = 548,

35 
	sds_sock
 {

36 
§
 
	m³”
;

37 
udp_h–³r
 *
	muh
;

38 
udp_sock
 *
	mus
;

39 
hash
 *
	mht
;

40 
mbuf
 *
	mmb
;

41 
ds_cÚn_h
 *
	mcÚnh
;

42 *
	m¬g
;

43 
size_t
 
	mmtu
;

48 
	ss_cÚn
 {

49 
SSL
 *
	ms¦
;

50 
BIO
 *
	msbio_out
;

51 
BIO
 *
	msbio_š
;

52 
tmr
 
	mtmr
;

53 
§
 
	m³”
;

54 
Ë
 
	mhe
;

55 
ds_sock
 *
	msock
;

56 
ds_e¡ab_h
 *
	me¡abh
;

57 
ds_»cv_h
 *
	m»cvh
;

58 
ds_şo£_h
 *
	mşo£h
;

59 *
	m¬g
;

60 
boŞ
 
	maùive
;

61 
boŞ
 
	mup
;

65 
	$bio_ü—‹
(
BIO
 *
b
)

67 #ifdeà
TLS_BIO_OPAQUE


68 
	`BIO_£t_š™
(
b
, 1);

69 
	`BIO_£t_d©a
(
b
, 
NULL
);

70 
	`BIO_£t_æags
(
b
, 0);

72 
b
->
š™
 = 1;

73 
b
->
num
 = 0;

74 
b
->
±r
 = 
NULL
;

75 
b
->
æags
 = 0;

79 
	}
}

82 
	$bio_de¡roy
(
BIO
 *
b
)

84 ià(!
b
)

87 #ifdeà
TLS_BIO_OPAQUE


88 
	`BIO_£t_š™
(
b
, 0);

89 
	`BIO_£t_d©a
(
b
, 
NULL
);

90 
	`BIO_£t_æags
(
b
, 0);

92 
b
->
±r
 = 
NULL
;

93 
b
->
š™
 = 0;

94 
b
->
æags
 = 0;

98 
	}
}

101 
	$bio_wr™e
(
BIO
 *
b
, cÚ¡ *
buf
, 
Ën
)

103 #ifdeà
TLS_BIO_OPAQUE


104 
s_cÚn
 *
tc
 = 
	`BIO_g‘_d©a
(
b
);

106 
s_cÚn
 *
tc
 = 
b
->
±r
;

108 
mbuf
 *
mb
;

109 ’um {
SPACE
 = 4};

110 
”r
;

112 
mb
 = 
	`mbuf_®loc
(
SPACE
 + 
Ën
);

113 ià(!
mb
)

116 
mb
->
pos
 = 
SPACE
;

117 ()
	`mbuf_wr™e_mem
(
mb
, (*)
buf
, 
Ën
);

118 
mb
->
pos
 = 
SPACE
;

120 
”r
 = 
	`udp_£nd_h–³r
(
tc
->
sock
->
us
, &tc->
³”
, 
mb
,c->sock->
uh
);

122 
	`mem_d”ef
(
mb
);

124  
”r
 ? -1 : 
Ën
;

125 
	}
}

128 
	$bio_ù¾
(
BIO
 *
b
, 
cmd
, 
num
, *
±r
)

130 #ifdeà
TLS_BIO_OPAQUE


131 
s_cÚn
 *
tc
 = 
	`BIO_g‘_d©a
(
b
);

133 
s_cÚn
 *
tc
 = 
b
->
±r
;

135 ()
num
;

136 ()
±r
;

138 
cmd
) {

140 
BIO_CTRL_FLUSH
:

144 #ià
	`defšed
 (
BIO_CTRL_DGRAM_QUERY_MTU
)

145 
BIO_CTRL_DGRAM_QUERY_MTU
:

146  
tc
 ?c->
sock
->
mtu
 : 
MTU_DEFAULT
;

149 #ià
	`defšed
 (
BIO_CTRL_DGRAM_GET_FALLBACK_MTU
)

150 
BIO_CTRL_DGRAM_GET_FALLBACK_MTU
:

151  
MTU_FALLBACK
;

156 
	}
}

159 #iâdeà
TLS_BIO_OPAQUE


160 
bio_m‘hod_¡
 
	gbio_udp_£nd
 = {

161 
BIO_TYPE_SOURCE_SINK
,

163 
bio_wr™e
,

167 
bio_ù¾
,

168 
bio_ü—‹
,

169 
bio_de¡roy
,

175 
	$s_şo£
(
s_cÚn
 *
tc
)

177 
r
;

179 ià(!
tc
->
s¦
)

182 
r
 = 
	`SSL_shutdown
(
tc
->
s¦
);

183 ià(
r
 <= 0)

184 
	`ERR_ş—r_”rÜ
();

186 
	`SSL_ä“
(
tc
->
s¦
);

187 
tc
->
s¦
 = 
NULL
;

188 
	}
}

191 
	$cÚn_de¡ruùÜ
(*
¬g
)

193 
s_cÚn
 *
tc
 = 
¬g
;

195 
	`hash_uÆšk
(&
tc
->
he
);

196 
	`tmr_ÿnûl
(&
tc
->
tmr
);

197 
	`s_şo£
(
tc
);

198 
	`mem_d”ef
(
tc
->
sock
);

199 
	}
}

202 
	$cÚn_şo£
(
s_cÚn
 *
tc
, 
”r
)

204 
	`tmr_ÿnûl
(&
tc
->
tmr
);

205 
	`s_şo£
(
tc
);

206 
tc
->
up
 = 
çl£
;

208 ià(
tc
->
şo£h
)

209 
tc
->
	`şo£h
(
”r
,c->
¬g
);

210 
	}
}

213 #ià
defšed
 (
DTLS_CTRL_HANDLE_TIMEOUT
è&& defšed(
DTLS_CTRL_GET_TIMEOUT
)

215 
check_tim”
(
s_cÚn
 *
tc
);

218 
	$timeout
(*
¬g
)

220 
s_cÚn
 *
tc
 = 
¬g
;

222 
	`DEBUG_INFO
("timeout\n");

224 ià(0 <ğ
	`DTLSv1_hªdË_timeout
(
tc
->
s¦
)) {

226 
	`check_tim”
(
tc
);

229 
	`ERR_ş—r_”rÜ
();

230 
	`cÚn_şo£
(
tc
, 
ETIMEDOUT
);

232 
	}
}

235 
	$check_tim”
(
s_cÚn
 *
tc
)

237 
timev®
 
tv
 = {0, 0};

239 ià(1 =ğ
	`DTLSv1_g‘_timeout
(
tc
->
s¦
, &
tv
)) {

241 
	`tmr_¡¬t
(&
tc
->
tmr
, 
tv
.
tv_£c
 * 1000 +v.
tv_u£c
 / 1000,

242 
timeout
, 
tc
);

245 
	`tmr_ÿnûl
(&
tc
->
tmr
);

247 
	}
}

251 
	$check_tim”
(
s_cÚn
 *
tc
)

253 ()
tc
;

254 
	}
}

259 
	$s_cÚÃù
(
s_cÚn
 *
tc
)

261 
r
;

263 
	`ERR_ş—r_”rÜ
();

265 
r
 = 
	`SSL_cÚÃù
(
tc
->
s¦
);

266 ià(
r
 <= 0) {

267 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
);

269 
	`s_æush_”rÜ
();

271 
s¦_”r
) {

273 
SSL_ERROR_WANT_READ
:

277 
	`DEBUG_WARNING
("cÚÃùƒ¼Ü: %i\n", 
s¦_”r
);

278  
EPROTO
;

282 
	`check_tim”
(
tc
);

285 
	}
}

288 
	$s_acû±
(
s_cÚn
 *
tc
)

290 
r
;

292 
	`ERR_ş—r_”rÜ
();

294 
r
 = 
	`SSL_acû±
(
tc
->
s¦
);

295 ià(
r
 <= 0) {

296 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
);

298 
	`s_æush_”rÜ
();

300 
s¦_”r
) {

302 
SSL_ERROR_WANT_READ
:

306 
	`DEBUG_WARNING
("acû±ƒ¼Ü: %i\n", 
s¦_”r
);

307  
EPROTO
;

311 
	`check_tim”
(
tc
);

314 
	}
}

317 
	$cÚn_»cv
(
s_cÚn
 *
tc
, 
mbuf
 *
mb
)

319 
”r
, 
r
;

321 ià(!
tc
->
s¦
)

325 
r
 = 
	`BIO_wr™e
(
tc
->
sbio_š
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_Ëá
(mb));

326 ià(
r
 <= 0) {

327 
	`DEBUG_WARNING
("»ûivbiØwr™”rÜ: %i\n", 
r
);

328 
	`ERR_ş—r_”rÜ
();

329 
	`cÚn_şo£
(
tc
, 
ENOMEM
);

333 ià(
	`SSL_¡©e
(
tc
->
s¦
è!ğ
SSL_ST_OK
) {

335 ià(
tc
->
up
) {

336 
	`cÚn_şo£
(
tc
, 
EPROTO
);

340 ià(
tc
->
aùive
) {

341 
”r
 = 
	`s_cÚÃù
(
tc
);

344 
”r
 = 
	`s_acû±
(
tc
);

347 ià(
”r
) {

348 
	`cÚn_şo£
(
tc
, 
”r
);

352 
	`DEBUG_INFO
("%s: state=0x%04x\n",

353 
tc
->
aùive
 ? "client" : "server",

354 
	`SSL_¡©e
(
tc
->
s¦
));

357 ià(
	`SSL_¡©e
(
tc
->
s¦
è!ğ
SSL_ST_OK
)

360 
tc
->
up
 = 
Œue
;

362 ià(
tc
->
e¡abh
) {

363 
ušt32_t
 
Äefs
;

365 
	`mem_»f
(
tc
);

367 
tc
->
	`e¡abh
Ñc->
¬g
);

369 
Äefs
 = 
	`mem_Äefs
(
tc
);

370 
	`mem_d”ef
(
tc
);

373 ià(
Äefs
 == 1)

378 
	`mbuf_£t_pos
(
mb
, 0);

381 
n
;

383 ià(
	`mbuf_g‘_¥aû
(
mb
) < 4096) {

384 
”r
 = 
	`mbuf_»size
(
mb
, mb->
size
 + 8192);

385 ià(
”r
) {

386 
	`cÚn_şo£
(
tc
, 
”r
);

391 
	`ERR_ş—r_”rÜ
();

393 
n
 = 
	`SSL_»ad
(
tc
->
s¦
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_¥aû
(mb));

394 ià(
n
 <= 0) {

395 cÚ¡ 
s¦_”r
 = 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
n
);

397 
	`ERR_ş—r_”rÜ
();

399 
s¦_”r
) {

401 
SSL_ERROR_WANT_READ
:

404 
SSL_ERROR_ZERO_RETURN
:

405 
	`cÚn_şo£
(
tc
, 
ECONNRESET
);

409 
	`DEBUG_WARNING
("»adƒ¼Ü: %i\n", 
s¦_”r
);

410 
	`cÚn_şo£
(
tc
, 
EPROTO
);

417 
mb
->
pos
 +ğ
n
;

420 
	`mbuf_£t_’d
(
mb
, mb->
pos
);

421 
	`mbuf_£t_pos
(
mb
, 0);

423 ià(
tc
->
»cvh
 && 
	`mbuf_g‘_Ëá
(
mb
) > 0)

424 
tc
->
	`»cvh
(
mb
,c->
¬g
);

427 
	}
}

430 
	$cÚn_®loc
(
s_cÚn
 **
±c
, 
s
 *tls,

431 
ds_sock
 *
sock
, cÚ¡ 
§
 *
³”
,

432 
ds_e¡ab_h
 *
e¡abh
, 
ds_»cv_h
 *
»cvh
,

433 
ds_şo£_h
 *
şo£h
, *
¬g
)

435 
s_cÚn
 *
tc
;

436 
”r
 = 0;

438 
tc
 = 
	`mem_z®loc
((*tc), 
cÚn_de¡ruùÜ
);

439 ià(!
tc
)

440  
ENOMEM
;

442 
	`hash_­³nd
(
sock
->
ht
, 
	`§_hash
(
³”
, 
SA_ALL
), &
tc
->
he
,c);

444 
tc
->
sock
 = 
	`mem_»f
(sock);

445 
tc
->
³”
 = *peer;

446 
tc
->
e¡abh
 =ƒstabh;

447 
tc
->
»cvh
 =„ecvh;

448 
tc
->
şo£h
 = closeh;

449 
tc
->
¬g
 =‡rg;

452 
tc
->
s¦
 = 
	`SSL_Ãw
(
s
->
ùx
);

453 ià(!
tc
->
s¦
) {

454 
	`DEBUG_WARNING
("ssl‚ew failed: %i\n",

455 
	`ERR_GET_REASON
(
	`ERR_g‘_”rÜ
()));

456 
	`ERR_ş—r_”rÜ
();

457 
”r
 = 
ENOMEM
;

458 
out
;

461 
tc
->
sbio_š
 = 
	`BIO_Ãw
(
	`BIO_s_mem
());

462 ià(!
tc
->
sbio_š
) {

463 
	`ERR_ş—r_”rÜ
();

464 
”r
 = 
ENOMEM
;

465 
out
;

468 #ifdeà
TLS_BIO_OPAQUE


469 
tc
->
sbio_out
 = 
	`BIO_Ãw
(
s
->
m‘hod_udp
);

471 
tc
->
sbio_out
 = 
	`BIO_Ãw
(&
bio_udp_£nd
);

473 ià(!
tc
->
sbio_out
) {

474 
	`ERR_ş—r_”rÜ
();

475 
	`BIO_ä“
(
tc
->
sbio_š
);

476 
”r
 = 
ENOMEM
;

477 
out
;

480 #ifdeà
TLS_BIO_OPAQUE


481 
	`BIO_£t_d©a
(
tc
->
sbio_out
,c);

483 
tc
->
sbio_out
->
±r
 =c;

486 
	`SSL_£t_bio
(
tc
->
s¦
,c->
sbio_š
,c->
sbio_out
);

488 
	`SSL_£t_»ad_ah—d
(
tc
->
s¦
, 1);

490 
out
:

491 ià(
”r
)

492 
	`mem_d”ef
(
tc
);

494 *
±c
 = 
tc
;

496  
”r
;

497 
	}
}

514 
	$ds_cÚÃù
(
s_cÚn
 **
±c
, 
s
 *tls,

515 
ds_sock
 *
sock
, cÚ¡ 
§
 *
³”
,

516 
ds_e¡ab_h
 *
e¡abh
, 
ds_»cv_h
 *
»cvh
,

517 
ds_şo£_h
 *
şo£h
, *
¬g
)

519 
s_cÚn
 *
tc
;

520 
”r
;

522 ià(!
±c
 || !
s
 || !
sock
 || !
³”
)

523  
EINVAL
;

525 
”r
 = 
	`cÚn_®loc
(&
tc
, 
s
, 
sock
, 
³”
, 
e¡abh
, 
»cvh
, 
şo£h
, 
¬g
);

526 ià(
”r
)

527  
”r
;

529 
tc
->
aùive
 = 
Œue
;

531 
”r
 = 
	`s_cÚÃù
(
tc
);

532 ià(
”r
)

533 
out
;

535 
out
:

536 ià(
”r
)

537 
	`mem_d”ef
(
tc
);

539 *
±c
 = 
tc
;

541  
”r
;

542 
	}
}

558 
	$ds_acû±
(
s_cÚn
 **
±c
, 
s
 *tls,

559 
ds_sock
 *
sock
,

560 
ds_e¡ab_h
 *
e¡abh
, 
ds_»cv_h
 *
»cvh
,

561 
ds_şo£_h
 *
şo£h
, *
¬g
)

563 
s_cÚn
 *
tc
;

564 
”r
, 
r
;

566 ià(!
±c
 || !
s
 || !
sock
 || !sock->
mb
)

567  
EINVAL
;

569 
”r
 = 
	`cÚn_®loc
(&
tc
, 
s
, 
sock
, &sock->
³”
, 
e¡abh
, 
»cvh
, 
şo£h
,

570 
¬g
);

571 ià(
”r
)

572  
”r
;

574 
tc
->
aùive
 = 
çl£
;

576 
r
 = 
	`BIO_wr™e
(
tc
->
sbio_š
, 
	`mbuf_buf
(
sock
->
mb
),

577 ()
	`mbuf_g‘_Ëá
(
sock
->
mb
));

578 ià(
r
 <= 0) {

579 
	`DEBUG_WARNING
("acû± biØwr™”rÜ: %i\n", 
r
);

580 
	`ERR_ş—r_”rÜ
();

581 
”r
 = 
ENOMEM
;

582 
out
;

585 
”r
 = 
	`s_acû±
(
tc
);

586 ià(
”r
)

587 
out
;

589 
sock
->
mb
 = 
	`mem_d”ef
(sock->mb);

591 
out
:

592 ià(
”r
)

593 
	`mem_d”ef
(
tc
);

595 *
±c
 = 
tc
;

597  
”r
;

598 
	}
}

609 
	$ds_£nd
(
s_cÚn
 *
tc
, 
mbuf
 *
mb
)

611 
r
;

613 ià(!
tc
 || !
mb
)

614  
EINVAL
;

616 ià(!
tc
->
up
 || !tc->
s¦
)

617  
ENOTCONN
;

619 
	`ERR_ş—r_”rÜ
();

621 
r
 = 
	`SSL_wr™e
(
tc
->
s¦
, 
	`mbuf_buf
(
mb
), ()
	`mbuf_g‘_Ëá
(mb));

622 ià(
r
 <= 0) {

623 
	`DEBUG_WARNING
("wr™”rÜ: %i\n", 
	`SSL_g‘_”rÜ
(
tc
->
s¦
, 
r
));

624 
	`ERR_ş—r_”rÜ
();

625  
EPROTO
;

629 
	}
}

641 
	$ds_£t_hªdËrs
(
s_cÚn
 *
tc
, 
ds_e¡ab_h
 *
e¡abh
,

642 
ds_»cv_h
 *
»cvh
, 
ds_şo£_h
 *
şo£h
, *
¬g
)

644 ià(!
tc
)

647 
tc
->
e¡abh
 =ƒstabh;

648 
tc
->
»cvh
 =„ecvh;

649 
tc
->
şo£h
 = closeh;

650 
tc
->
¬g
 =‡rg;

651 
	}
}

661 cÚ¡ 
§
 *
	$ds_³”
(cÚ¡ 
s_cÚn
 *
tc
)

663  
tc
 ? &tc->
³”
 : 
NULL
;

664 
	}
}

673 
	$ds_£t_³”
(
s_cÚn
 *
tc
, cÚ¡ 
§
 *
³”
)

675 ià(!
tc
 || !
³”
)

678 
	`hash_uÆšk
(&
tc
->
he
);

679 
	`hash_­³nd
(
tc
->
sock
->
ht
, 
	`§_hash
(
³”
, 
SA_ALL
), &tc->
he
,c);

681 
tc
->
³”
 = *peer;

682 
	}
}

685 
	$sock_de¡ruùÜ
(*
¬g
)

687 
ds_sock
 *
sock
 = 
¬g
;

689 
	`hash_ş—r
(
sock
->
ht
);

690 
	`mem_d”ef
(
sock
->
uh
);

691 
	`mem_d”ef
(
sock
->
us
);

692 
	`mem_d”ef
(
sock
->
ht
);

693 
	`mem_d”ef
(
sock
->
mb
);

694 
	}
}

697 
boŞ
 
	$cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

699 
s_cÚn
 *
tc
 = 
Ë
->
d©a
;

701  
	`§_cmp
(&
tc
->
³”
, 
¬g
, 
SA_ALL
);

702 
	}
}

705 
s_cÚn
 *
	$cÚn_lookup
(
ds_sock
 *
sock
,

706 cÚ¡ 
§
 *
³”
)

708  
	`li¡_Ëd©a
(
	`hash_lookup
(
sock
->
ht
, 
	`§_hash
(
³”
, 
SA_ALL
),

709 
cmp_hªdËr
, (*)
³”
));

710 
	}
}

713 
boŞ
 
	$»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

715 
ds_sock
 *
sock
 = 
¬g
;

716 
s_cÚn
 *
tc
;

717 
ušt8_t
 
b
;

719 ià(
	`mbuf_g‘_Ëá
(
mb
) < 1)

720  
çl£
;

722 
b
 = 
mb
->
buf
[mb->
pos
];

723 ià(
b
 < 20 || b > 63)

724  
çl£
;

726 
tc
 = 
	`cÚn_lookup
(
sock
, 
¤c
);

727 ià(
tc
) {

728 
	`cÚn_»cv
(
tc
, 
mb
);

729  
Œue
;

732 ià(
sock
->
cÚnh
) {

734 
	`mem_d”ef
(
sock
->
mb
);

735 
sock
->
mb
 = 
	`mem_»f
(mb);

736 
sock
->
³”
 = *
¤c
;

738 
sock
->
	`cÚnh
(
¤c
, sock->
¬g
);

741  
Œue
;

742 
	}
}

758 
	$ds_li¡’
(
ds_sock
 **
sockp
, cÚ¡ 
§
 *
Ïddr
,

759 
udp_sock
 *
us
, 
ušt32_t
 
htsize
, 
Ïy”
,

760 
ds_cÚn_h
 *
cÚnh
, *
¬g
)

762 
ds_sock
 *
sock
;

763 
”r
;

765 ià(!
sockp
)

766  
EINVAL
;

768 
sock
 = 
	`mem_z®loc
((*sock), 
sock_de¡ruùÜ
);

769 ià(!
sock
)

770  
ENOMEM
;

772 ià(
us
) {

773 
sock
->
us
 = 
	`mem_»f
(us);

776 
”r
 = 
	`udp_li¡’
(&
sock
->
us
, 
Ïddr
, 
NULL
, NULL);

777 ià(
”r
)

778 
out
;

781 
”r
 = 
	`udp_»gi¡”_h–³r
(&
sock
->
uh
, sock->
us
, 
Ïy”
,

782 
NULL
, 
»cv_hªdËr
, 
sock
);

783 ià(
”r
)

784 
out
;

786 
”r
 = 
	`hash_®loc
(&
sock
->
ht
, 
	`hash_v®id_size
(
htsize
));

787 ià(
”r
)

788 
out
;

790 
sock
->
mtu
 = 
MTU_DEFAULT
;

791 
sock
->
cÚnh
 = connh;

792 
sock
->
¬g
 =‡rg;

794 
out
:

795 ià(
”r
)

796 
	`mem_d”ef
(
sock
);

798 *
sockp
 = 
sock
;

800  
”r
;

801 
	}
}

811 
udp_sock
 *
	$ds_udp_sock
(
ds_sock
 *
sock
)

813  
sock
 ? sock->
us
 : 
NULL
;

814 
	}
}

823 
	$ds_£t_mtu
(
ds_sock
 *
sock
, 
size_t
 
mtu
)

825 ià(!
sock
)

828 
sock
->
mtu
 = mtu;

829 
	}
}

832 
	$ds_»cv_·ck‘
(
ds_sock
 *
sock
, cÚ¡ 
§
 *
¤c
,

833 
mbuf
 *
mb
)

835 
§
 
addr
;

837 ià(!
sock
 || !
¤c
 || !
mb
)

840 
addr
 = *
¤c
;

842 
	`»cv_hªdËr
(&
addr
, 
mb
, 
sock
);

843 
	}
}

846 #ifdeà
TLS_BIO_OPAQUE


847 
BIO_METHOD
 *
	$s_m‘hod_udp
()

849 
BIO_METHOD
 *
m‘hod
;

851 
m‘hod
 = 
	`BIO_m‘h_Ãw
(
BIO_TYPE_SOURCE_SINK
, "udp_send");

852 ià(!
m‘hod
) {

853 
	`DEBUG_WARNING
("alloc: BIO_meth_new() failed\n");

854 
	`ERR_ş—r_”rÜ
();

855  
NULL
;

858 
	`BIO_m‘h_£t_wr™e
(
m‘hod
, 
bio_wr™e
);

859 
	`BIO_m‘h_£t_ù¾
(
m‘hod
, 
bio_ù¾
);

860 
	`BIO_m‘h_£t_ü—‹
(
m‘hod
, 
bio_ü—‹
);

861 
	`BIO_m‘h_£t_de¡roy
(
m‘hod
, 
bio_de¡roy
);

863  
m‘hod
;

864 
	}
}

	@re-0.5.6/src/tmr/tmr.c

6 
	~<¡ršg.h
>

7 #ifdeà
HAVE_SYS_TIME_H


8 
	~<sys/time.h
>

10 #ifdeà
WIN32


11 
	~<wšdows.h
>

13 
	~<time.h
>

15 #ifdeà
HAVE_PTHREAD


16 
	~<¡dlib.h
>

17 
	~<±h»ad.h
>

19 
	~<»_ty³s.h
>

20 
	~<»_li¡.h
>

21 
	~<»_fmt.h
>

22 
	~<»_mem.h
>

23 
	~<»_tmr.h
>

26 
	#DEBUG_MODULE
 "tmr"

	)

27 
	#DEBUG_LEVEL
 5

	)

28 
	~<»_dbg.h
>

31 #ià!
defšed
 (
RELEASE
è&& !defšed (
TMR_DEBUG
)

32 
	#TMR_DEBUG
 1

	)

37 
	mMAX_BLOCKING
 = 100

40 
li¡
 *
tm¾_g‘
();

43 
boŞ
 
	$š¥os_hªdËr
(
Ë
 *Ë, *
¬g
)

45 
tmr
 *tm¸ğ
Ë
->
d©a
;

46 cÚ¡ 
ušt64_t
 
now
 = *(ušt64_ˆ*)
¬g
;

48  
tmr
->
jfs
 <ğ
now
;

49 
	}
}

52 
boŞ
 
	$š¥os_hªdËr_0
(
Ë
 *Ë, *
¬g
)

54 
tmr
 *tm¸ğ
Ë
->
d©a
;

55 cÚ¡ 
ušt64_t
 
now
 = *(ušt64_ˆ*)
¬g
;

57  
tmr
->
jfs
 > 
now
;

58 
	}
}

61 #ià
TMR_DEBUG


62 
	$ÿÎ_hªdËr
(
tmr_h
 *
th
, *
¬g
)

64 cÚ¡ 
ušt64_t
 
tick
 = 
	`tmr_jiff›s
();

65 
ušt32_t
 
diff
;

68 
	`th
(
¬g
);

70 
diff
 = (
ušt32_t
)(
	`tmr_jiff›s
(è- 
tick
);

72 ià(
diff
 > 
MAX_BLOCKING
) {

73 
	`DEBUG_WARNING
("long‡sync blocking: %u>%u ms (h=%p‡rg=%p)\n",

74 
diff
, 
MAX_BLOCKING
, 
th
, 
¬g
);

76 
	}
}

85 
	$tmr_pŞl
(
li¡
 *
tm¾
)

87 cÚ¡ 
ušt64_t
 
jfs
 = 
	`tmr_jiff›s
();

90 
tmr
 *tmr;

91 
tmr_h
 *
th
;

92 *
th_¬g
;

94 
tmr
 = 
	`li¡_Ëd©a
(
tm¾
->
h—d
);

96 ià(!
tmr
 || (tmr->
jfs
 > jfs)) {

100 
th
 = 
tmr
->th;

101 
th_¬g
 = 
tmr
->
¬g
;

103 
tmr
->
th
 = 
NULL
;

105 
	`li¡_uÆšk
(&
tmr
->
Ë
);

107 ià(!
th
)

110 #ià
TMR_DEBUG


111 
	`ÿÎ_hªdËr
(
th
, 
th_¬g
);

113 
	`th
(
th_¬g
);

116 
	}
}

124 
ušt64_t
 
	$tmr_jiff›s
()

126 
ušt64_t
 
jfs
;

128 #ià
	`defšed
(
WIN32
)

129 
FILETIME
 
á
;

130 
ULARGE_INTEGER
 
li
;

131 
	`G‘Sy¡emTimeAsFeTime
(&
á
);

132 
li
.
LowP¬t
 = 
á
.
dwLowD©eTime
;

133 
li
.
HighP¬t
 = 
á
.
dwHighD©eTime
;

134 
jfs
 = 
li
.
QuadP¬t
/10/1000;

136 
timev®
 
now
;

138 ià(0 !ğ
	`g‘timeofday
(&
now
, 
NULL
)) {

139 
	`DEBUG_WARNING
("jiff›s: g‘timeofday(èçed (%m)\n", 
”ºo
);

143 
jfs
 = ()
now
.
tv_£c
 * (
ušt64_t
)1000;

144 
jfs
 +ğ
now
.
tv_u£c
 / 1000;

147  
jfs
;

148 
	}
}

158 
ušt64_t
 
	$tmr_Ãxt_timeout
(
li¡
 *
tm¾
)

160 cÚ¡ 
ušt64_t
 
jif
 = 
	`tmr_jiff›s
();

161 cÚ¡ 
tmr
 *tmr;

163 
tmr
 = 
	`li¡_Ëd©a
(
tm¾
->
h—d
);

164 ià(!
tmr
)

167 ià(
tmr
->
jfs
 <ğ
jif
)

170  
tmr
->
jfs
 - 
jif
;

171 
	}
}

174 
	$tmr_¡©us
(
»_´štf
 *
pf
, *
unu£d
)

176 
li¡
 *
tm¾
 = 
	`tm¾_g‘
();

177 
Ë
 *le;

178 
ušt32_t
 
n
;

179 
”r
;

181 ()
unu£d
;

183 
n
 = 
	`li¡_couÁ
(
tm¾
);

184 ià(!
n
)

187 
”r
 = 
	`»_h´štf
(
pf
, "Tim” (%u):\n", 
n
);

189 
Ë
 = 
tm¾
->
h—d
;†e;†ğË->
Ãxt
) {

190 cÚ¡ 
tmr
 *tm¸ğ
Ë
->
d©a
;

192 
”r
 |ğ
	`»_h´štf
(
pf
, " %p:h=%pƒxpire=%llums\n",

193 
tmr
,mr->
th
,

194 ()
	`tmr_g‘_expœe
(
tmr
));

197 ià(
n
 > 100)

198 
”r
 |ğ
	`»_h´štf
(
pf
, " (Dum³d Tim”s: %u)\n", 
n
);

200  
”r
;

201 
	}
}

207 
	$tmr_debug
()

209 ià(!
	`li¡_i£m±y
(
	`tm¾_g‘
()))

210 ()
	`»_årštf
(
¡d”r
, "%H", 
tmr_¡©us
, 
NULL
);

211 
	}
}

219 
	$tmr_š™
(
tmr
 *tmr)

221 ià(!
tmr
)

224 
	`mem£t
(
tmr
, 0, (*tmr));

225 
	}
}

236 
	$tmr_¡¬t
(
tmr
 *tmr, 
ušt64_t
 
d–ay
, 
tmr_h
 *
th
, *
¬g
)

238 
li¡
 *
tm¾
 = 
	`tm¾_g‘
();

239 
Ë
 *le;

241 ià(!
tmr
)

244 ià(
tmr
->
th
) {

245 
	`li¡_uÆšk
(&
tmr
->
Ë
);

248 
tmr
->
th
 =h;

249 
tmr
->
¬g
 =‡rg;

251 ià(!
th
)

254 
tmr
->
jfs
 = 
d–ay
 + 
	`tmr_jiff›s
();

256 ià(
d–ay
 == 0) {

257 
Ë
 = 
	`li¡_­¶y
(
tm¾
, 
Œue
, 
š¥os_hªdËr_0
, &
tmr
->
jfs
);

258 ià(
Ë
) {

259 
	`li¡_š£¹_befÜe
(
tm¾
, 
Ë
, &
tmr
->le,mr);

262 
	`li¡_­³nd
(
tm¾
, &
tmr
->
Ë
,mr);

266 
Ë
 = 
	`li¡_­¶y
(
tm¾
, 
çl£
, 
š¥os_hªdËr
, &
tmr
->
jfs
);

267 ià(
Ë
) {

268 
	`li¡_š£¹_aá”
(
tm¾
, 
Ë
, &
tmr
->le,mr);

271 
	`li¡_´•’d
(
tm¾
, &
tmr
->
Ë
,mr);

274 
	}
}

282 
	$tmr_ÿnûl
(
tmr
 *tmr)

284 
	`tmr_¡¬t
(
tmr
, 0, 
NULL
, NULL);

285 
	}
}

295 
ušt64_t
 
	$tmr_g‘_expœe
(cÚ¡ 
tmr
 *tmr)

297 
ušt64_t
 
jfs
;

299 ià(!
tmr
 || !tmr->
th
)

302 
jfs
 = 
	`tmr_jiff›s
();

304  (
tmr
->
jfs
 > jfs) ? (tmr->jfs - jfs) : 0;

305 
	}
}

	@re-0.5.6/src/turn/chan.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_hash.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_md5.h
>

14 
	~<»_udp.h
>

15 
	~<»_¡un.h
>

16 
	~<»_tuº.h
>

17 
	~"tuºc.h
"

21 
	mCHAN_LIFETIME
 = 600,

22 
	mCHAN_REFRESH
 = 250,

23 
	mCHAN_NUMB_MIN
 = 0x4000,

24 
	mCHAN_NUMB_MAX
 = 0x7fff

28 
	schªÃls
 {

29 
hash
 *
	mht_numb
;

30 
hash
 *
	mht_³”
;

31 
ušt16_t
 
	mÄ
;

35 
	schª
 {

36 
Ë
 
	mhe_numb
;

37 
Ë
 
	mhe_³”
;

38 
loİ_¡©e
 
	mls
;

39 
ušt16_t
 
	mÄ
;

40 
§
 
	m³”
;

41 
tmr
 
	mtmr
;

42 
tuºc
 *
	mtuºc
;

43 
¡un_ù¿ns
 *
	mù
;

44 
tuºc_chª_h
 *
	mch
;

45 *
	m¬g
;

49 
chªbšd_»que¡
(
chª
 *chª, 
boŞ
 
»£t_ls
);

52 
	$chªÃls_de¡ruùÜ
(*
d©a
)

54 
chªÃls
 *
c
 = 
d©a
;

57 
	`hash_æush
(
c
->
ht_numb
);

59 
	`mem_d”ef
(
c
->
ht_numb
);

60 
	`mem_d”ef
(
c
->
ht_³”
);

61 
	}
}

64 
	$chª_de¡ruùÜ
(*
d©a
)

66 
chª
 *chª = 
d©a
;

68 
	`tmr_ÿnûl
(&
chª
->
tmr
);

69 
	`mem_d”ef
(
chª
->
ù
);

70 
	`hash_uÆšk
(&
chª
->
he_numb
);

71 
	`hash_uÆšk
(&
chª
->
he_³”
);

72 
	}
}

75 
boŞ
 
	$numb_hash_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

77 cÚ¡ 
chª
 *chª = 
Ë
->
d©a
;

78 cÚ¡ 
ušt16_t
 *
Ä
 = 
¬g
;

80  
chª
->
Ä
 == *nr;

81 
	}
}

84 
boŞ
 
	$³”_hash_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

86 cÚ¡ 
chª
 *chª = 
Ë
->
d©a
;

88  
	`§_cmp
(&
chª
->
³”
, 
¬g
, 
SA_ALL
);

89 
	}
}

92 
	$timeout
(*
¬g
)

94 
chª
 *chª = 
¬g
;

95 
”r
;

97 
”r
 = 
	`chªbšd_»que¡
(
chª
, 
Œue
);

98 ià(
”r
)

99 
chª
->
tuºc
->
	`th
(
”r
, 0, 
NULL
, NULL, NULL, NULL,

100 
chª
->
tuºc
->
¬g
);

101 
	}
}

104 
	$chªbšd_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

105 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

107 
chª
 *chª = 
¬g
;

109 ià(
”r
 || 
	`tuºc_»que¡_loİs
(&
chª
->
ls
, 
scode
))

110 
out
;

112 
scode
) {

115 
	`tmr_¡¬t
(&
chª
->
tmr
, 
CHAN_REFRESH
 * 1000, 
timeout
, chan);

116 ià(
chª
->
ch
) {

117 
chª
->
	`ch
(chª->
¬g
);

118 
chª
->
ch
 = 
NULL
;

119 
chª
->
¬g
 = 
NULL
;

125 
”r
 = 
	`tuºc_keyg’
(
chª
->
tuºc
, 
msg
);

126 ià(
”r
)

129 
”r
 = 
	`chªbšd_»que¡
(
chª
, 
çl£
);

130 ià(
”r
)

139 
out
:

140 
chª
->
tuºc
->
	`th
(
”r
, 
scode
, 
»asÚ
, 
NULL
, NULL, 
msg
, chª->tuºc->
¬g
);

141 
	}
}

144 
	$chªbšd_»que¡
(
chª
 *chª, 
boŞ
 
»£t_ls
)

146 
tuºc
 *
t
 = 
chª
->turnc;

148 ià(
»£t_ls
)

149 
	`tuºc_loİ¡©e_»£t
(&
chª
->
ls
);

151  
	`¡un_»que¡
(&
chª
->
ù
, 
t
->
¡un
,->
´Ùo
,->
sock
, &t->
¤v
, 0,

152 
STUN_METHOD_CHANBIND
,

153 
t
->
»®m
 ?->
md5_hash
 : 
NULL
, (t->md5_hash),

154 
çl£
, 
chªbšd_»¥_hªdËr
, 
chª
, 6,

155 
STUN_ATTR_CHANNEL_NUMBER
, &
chª
->
Ä
,

156 
STUN_ATTR_XOR_PEER_ADDR
, &
chª
->
³”
,

157 
STUN_ATTR_USERNAME
, 
t
->
»®m
 ?->
u£ºame
 : 
NULL
,

158 
STUN_ATTR_REALM
, 
t
->
»®m
,

159 
STUN_ATTR_NONCE
, 
t
->
nÚû
,

160 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

161 
	}
}

174 
	$tuºc_add_chª
(
tuºc
 *tuºc, cÚ¡ 
§
 *
³”
,

175 
tuºc_chª_h
 *
ch
, *
¬g
)

177 
chª
 *chan;

178 
”r
;

180 ià(!
tuºc
 || !
³”
)

181  
EINVAL
;

183 ià(
tuºc
->
chªs
->
Ä
 >ğ
CHAN_NUMB_MAX
)

184  
ERANGE
;

186 ià(
	`tuºc_chª_fšd_³”
(
tuºc
, 
³”
))

189 
chª
 = 
	`mem_z®loc
((*chª), 
chª_de¡ruùÜ
);

190 ià(!
chª
)

191  
ENOMEM
;

193 
chª
->
Ä
 = 
tuºc
->
chªs
->nr++;

194 
chª
->
³”
 = *peer;

196 
	`hash_­³nd
(
tuºc
->
chªs
->
ht_numb
, 
chª
->
Ä
, &chª->
he_numb
, chan);

197 
	`hash_­³nd
(
tuºc
->
chªs
->
ht_³”
, 
	`§_hash
(
³”
, 
SA_ALL
),

198 &
chª
->
he_³”
, chan);

200 
	`tmr_š™
(&
chª
->
tmr
);

201 
chª
->
tuºc
 =urnc;

202 
chª
->
ch
 = ch;

203 
chª
->
¬g
 =‡rg;

205 
”r
 = 
	`chªbšd_»que¡
(
chª
, 
Œue
);

206 ià(
”r
)

207 
	`mem_d”ef
(
chª
);

209  
”r
;

210 
	}
}

213 
	$tuºc_chª_hash_®loc
(
chªÃls
 **
ı
, 
ušt32_t
 
bsize
)

215 
chªÃls
 *
c
;

216 
”r
;

218 ià(!
ı
)

219  
EINVAL
;

221 
c
 = 
	`mem_z®loc
((*c), 
chªÃls_de¡ruùÜ
);

222 ià(!
c
)

223  
ENOMEM
;

225 
”r
 = 
	`hash_®loc
(&
c
->
ht_numb
, 
bsize
);

226 ià(
”r
)

227 
out
;

229 
”r
 = 
	`hash_®loc
(&
c
->
ht_³”
, 
bsize
);

230 ià(
”r
)

231 
out
;

233 
c
->
Ä
 = 
CHAN_NUMB_MIN
;

235 
out
:

236 ià(
”r
)

237 
	`mem_d”ef
(
c
);

239 *
ı
 = 
c
;

241  
”r
;

242 
	}
}

245 
chª
 *
	$tuºc_chª_fšd_numb
(cÚ¡ 
tuºc
 *tuºc, 
ušt16_t
 
Ä
)

247 ià(!
tuºc
)

248  
NULL
;

250  
	`li¡_Ëd©a
(
	`hash_lookup
(
tuºc
->
chªs
->
ht_numb
, 
Ä
,

251 
numb_hash_cmp_hªdËr
, &
Ä
));

252 
	}
}

255 
chª
 *
	$tuºc_chª_fšd_³”
(cÚ¡ 
tuºc
 *turnc,

256 cÚ¡ 
§
 *
³”
)

258 ià(!
tuºc
)

259  
NULL
;

261  
	`li¡_Ëd©a
(
	`hash_lookup
(
tuºc
->
chªs
->
ht_³”
,

262 
	`§_hash
(
³”
, 
SA_ALL
),

263 
³”_hash_cmp_hªdËr
, (*)
³”
));

264 
	}
}

267 
ušt16_t
 
	$tuºc_chª_numb
(cÚ¡ 
chª
 *chan)

269  
chª
 ? chª->
Ä
 : 0;

270 
	}
}

273 cÚ¡ 
§
 *
	$tuºc_chª_³”
(cÚ¡ 
chª
 *chan)

275  
chª
 ? &chª->
³”
 : 
NULL
;

276 
	}
}

279 
	$tuºc_chª_hdr_’code
(cÚ¡ 
chª_hdr
 *
hdr
, 
mbuf
 *
mb
)

281 
”r
;

283 ià(!
hdr
 || !
mb
)

284  
EINVAL
;

286 
”r
 = 
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Ä
));

287 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
hdr
->
Ën
));

289  
”r
;

290 
	}
}

293 
	$tuºc_chª_hdr_decode
(
chª_hdr
 *
hdr
, 
mbuf
 *
mb
)

295 ià(!
hdr
 || !
mb
)

296  
EINVAL
;

298 ià(
	`mbuf_g‘_Ëá
(
mb
è< (*
hdr
))

299  
ENOENT
;

301 
hdr
->
Ä
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

302 
hdr
->
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

305 
	}
}

	@re-0.5.6/src/turn/perm.c

6 
	~<»_ty³s.h
>

7 
	~<»_mem.h
>

8 
	~<»_mbuf.h
>

9 
	~<»_li¡.h
>

10 
	~<»_hash.h
>

11 
	~<»_tmr.h
>

12 
	~<»_§.h
>

13 
	~<»_md5.h
>

14 
	~<»_udp.h
>

15 
	~<»_¡un.h
>

16 
	~<»_tuº.h
>

17 
	~"tuºc.h
"

21 
	mPERM_LIFETIME
 = 300,

22 
	mPERM_REFRESH
 = 250,

26 
	s³rm
 {

27 
Ë
 
	mhe
;

28 
loİ_¡©e
 
	mls
;

29 
§
 
	m³”
;

30 
tmr
 
	mtmr
;

31 
tuºc
 *
	mtuºc
;

32 
¡un_ù¿ns
 *
	mù
;

33 
tuºc_³rm_h
 *
	mph
;

34 *
	m¬g
;

38 
ü—‹³rm_»que¡
(
³rm
 *³rm, 
boŞ
 
»£t_ls
);

41 
	$de¡ruùÜ
(*
¬g
)

43 
³rm
 *³rm = 
¬g
;

45 
	`tmr_ÿnûl
(&
³rm
->
tmr
);

46 
	`mem_d”ef
(
³rm
->
ù
);

47 
	`hash_uÆšk
(&
³rm
->
he
);

48 
	}
}

51 
boŞ
 
	$hash_cmp_hªdËr
(
Ë
 *Ë, *
¬g
)

53 cÚ¡ 
³rm
 *³rm = 
Ë
->
d©a
;

55  
	`§_cmp
(&
³rm
->
³”
, 
¬g
, 
SA_ADDR
);

56 
	}
}

59 
³rm
 *
	$³rm_fšd
(cÚ¡ 
tuºc
 *tuºc, cÚ¡ 
§
 *
³”
)

61  
	`li¡_Ëd©a
(
	`hash_lookup
(
tuºc
->
³rms
, 
	`§_hash
(
³”
, 
SA_ADDR
),

62 
hash_cmp_hªdËr
, (*)
³”
));

63 
	}
}

66 
	$timeout
(*
¬g
)

68 
³rm
 *³rm = 
¬g
;

69 
”r
;

71 
”r
 = 
	`ü—‹³rm_»que¡
(
³rm
, 
Œue
);

72 ià(
”r
)

73 
³rm
->
tuºc
->
	`th
(
”r
, 0, 
NULL
, NULL, NULL, NULL,

74 
³rm
->
tuºc
->
¬g
);

75 
	}
}

78 
	$ü—‹³rm_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
,

79 cÚ¡ *
»asÚ
,

80 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

82 
³rm
 *³rm = 
¬g
;

84 ià(
”r
 || 
	`tuºc_»que¡_loİs
(&
³rm
->
ls
, 
scode
))

85 
out
;

87 
scode
) {

90 
	`tmr_¡¬t
(&
³rm
->
tmr
, 
PERM_REFRESH
 * 1000, 
timeout
,…erm);

91 ià(
³rm
->
ph
) {

92 
³rm
->
	`ph
Õ”m->
¬g
);

93 
³rm
->
ph
 = 
NULL
;

94 
³rm
->
¬g
 = 
NULL
;

100 
”r
 = 
	`tuºc_keyg’
(
³rm
->
tuºc
, 
msg
);

101 ià(
”r
)

104 
”r
 = 
	`ü—‹³rm_»que¡
(
³rm
, 
çl£
);

105 ià(
”r
)

114 
out
:

115 
³rm
->
tuºc
->
	`th
(
”r
, 
scode
, 
»asÚ
, 
NULL
, NULL, 
msg
,…”m->tuºc->
¬g
);

116 
	}
}

119 
	$ü—‹³rm_»que¡
(
³rm
 *³rm, 
boŞ
 
»£t_ls
)

121 
tuºc
 *
t
 = 
³rm
->turnc;

123 ià(
»£t_ls
)

124 
	`tuºc_loİ¡©e_»£t
(&
³rm
->
ls
);

126  
	`¡un_»que¡
(&
³rm
->
ù
, 
t
->
¡un
,->
´Ùo
,->
sock
, &t->
¤v
, 0,

127 
STUN_METHOD_CREATEPERM
,

128 
t
->
»®m
 ?->
md5_hash
 : 
NULL
, (t->md5_hash),

129 
çl£
, 
ü—‹³rm_»¥_hªdËr
, 
³rm
, 5,

130 
STUN_ATTR_XOR_PEER_ADDR
, &
³rm
->
³”
,

131 
STUN_ATTR_USERNAME
, 
t
->
»®m
 ?->
u£ºame
 : 
NULL
,

132 
STUN_ATTR_REALM
, 
t
->
»®m
,

133 
STUN_ATTR_NONCE
, 
t
->
nÚû
,

134 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

135 
	}
}

148 
	$tuºc_add_³rm
(
tuºc
 *tuºc, cÚ¡ 
§
 *
³”
,

149 
tuºc_³rm_h
 *
ph
, *
¬g
)

151 
³rm
 *perm;

152 
”r
;

154 ià(!
tuºc
 || !
³”
)

155  
EINVAL
;

157 ià(
	`³rm_fšd
(
tuºc
, 
³”
))

160 
³rm
 = 
	`mem_z®loc
((*³rm), 
de¡ruùÜ
);

161 ià(!
³rm
)

162  
ENOMEM
;

164 
	`hash_­³nd
(
tuºc
->
³rms
, 
	`§_hash
(
³”
, 
SA_ADDR
), &
³rm
->
he
,…erm);

165 
	`tmr_š™
(&
³rm
->
tmr
);

166 
³rm
->
³”
 = *peer;

167 
³rm
->
tuºc
 =urnc;

168 
³rm
->
ph
 =…h;

169 
³rm
->
¬g
 =‡rg;

171 
”r
 = 
	`ü—‹³rm_»que¡
(
³rm
, 
Œue
);

172 ià(
”r
)

173 
	`mem_d”ef
(
³rm
);

175  
”r
;

176 
	}
}

179 
	$tuºc_³rm_hash_®loc
(
hash
 **
ht
, 
ušt32_t
 
bsize
)

181  
	`hash_®loc
(
ht
, 
bsize
);

182 
	}
}

	@re-0.5.6/src/turn/turnc.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_mem.h
>

9 
	~<»_mbuf.h
>

10 
	~<»_md5.h
>

11 
	~<»_li¡.h
>

12 
	~<»_hash.h
>

13 
	~<»_tmr.h
>

14 
	~<»_§.h
>

15 
	~<»_udp.h
>

16 
	~<»_tı.h
>

17 
	~<»_¤.h
>

18 
	~<»_s.h
>

19 
	~<»_¡un.h
>

20 
	~<»_tuº.h
>

21 
	~"tuºc.h
"

24 
	#DEBUG_MODULE
 "tuºc"

	)

25 
	#DEBUG_LEVEL
 5

	)

26 
	~<»_dbg.h
>

31 
	mPERM_HASH_SIZE
 = 16,

32 
	mCHAN_HASH_SIZE
 = 16,

33 
	mFAILC_MAX
 = 16,

34 
	mSTUN_ATTR_ADDR4_SIZE
 = 8,

35 
	mSTUN_ATTR_ADDR6_SIZE
 = 20,

39 cÚ¡ 
ušt8_t
 
	g£ndšd_tid
[
STUN_TID_SIZE
];

41 
®loÿ‹_»que¡
(
tuºc
 *
t
);

42 
»äesh_»que¡
(
tuºc
 *
t
, 
ušt32_t
 
liãtime
, 
boŞ
 
»£t_ls
,

43 
¡un_»¥_h
 *
»¥h
, *
¬g
);

44 
»äesh_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

45 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
);

48 
	$de¡ruùÜ
(*
¬g
)

50 
tuºc
 *tuºøğ
¬g
;

52 ià(
tuºc
->
®loÿ‹d
)

53 ()
	`»äesh_»que¡
(
tuºc
, 0, 
Œue
, 
NULL
, NULL);

55 
	`tmr_ÿnûl
(&
tuºc
->
tmr
);

56 
	`mem_d”ef
(
tuºc
->
ù
);

58 
	`hash_æush
(
tuºc
->
³rms
);

59 
	`mem_d”ef
(
tuºc
->
³rms
);

60 
	`mem_d”ef
(
tuºc
->
chªs
);

61 
	`mem_d”ef
(
tuºc
->
u£ºame
);

62 
	`mem_d”ef
(
tuºc
->
·sswÜd
);

63 
	`mem_d”ef
(
tuºc
->
nÚû
);

64 
	`mem_d”ef
(
tuºc
->
»®m
);

65 
	`mem_d”ef
(
tuºc
->
¡un
);

66 
	`mem_d”ef
(
tuºc
->
uh
);

67 
	`mem_d”ef
(
tuºc
->
sock
);

68 
	}
}

71 
	$timeout
(*
¬g
)

73 
tuºc
 *tuºøğ
¬g
;

74 
”r
;

76 
”r
 = 
	`»äesh_»que¡
(
tuºc
,uºc->
liãtime
, 
Œue
,

77 
»äesh_»¥_hªdËr
, 
tuºc
);

78 ià(
”r
)

79 
tuºc
->
	`th
(
”r
, 0, 
NULL
, NULL, NULL, NULL,uºc->
¬g
);

80 
	}
}

83 
	$»äesh_tim”
(
tuºc
 *turnc)

85 cÚ¡ 
ušt32_t
 
t
 = 
tuºc
->
liãtime
*1000*3/4;

87 
	`DEBUG_INFO
("S¹„eäeshim”.. %u secÚds\n", 
t
/1000);

89 
	`tmr_¡¬t
(&
tuºc
->
tmr
, 
t
, 
timeout
,urnc);

90 
	}
}

93 
	$®loÿ‹_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

94 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

96 
¡un_©Œ
 *
m­
 = 
NULL
, *
»l
 = NULL, *
Ém
, *
®t
;

97 
tuºc
 *tuºøğ
¬g
;

99 ià(
”r
 || 
	`tuºc_»que¡_loİs
(&
tuºc
->
ls
, 
scode
))

100 
out
;

102 
scode
) {

105 
m­
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_MAPPED_ADDR
);

106 
»l
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_RELAY_ADDR
);

107 
Ém
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_LIFETIME
);

108 ià(!
»l
 || !
m­
) {

109 
	`DEBUG_WARNING
("xor_mapped/relay‡ddr‡ttr missing\n");

110 
”r
 = 
EPROTO
;

114 ià(
Ém
)

115 
tuºc
->
liãtime
 = 
Ém
->
v
.lifetime;

117 
tuºc
->
®loÿ‹d
 = 
Œue
;

118 
	`»äesh_tim”
(
tuºc
);

122 ià(
tuºc
->
´Ùo
 =ğ
IPPROTO_TCP
 ||

123 
tuºc
->
´Ùo
 =ğ
STUN_TRANSP_DTLS
)

126 
®t
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_ALT_SERVER
);

127 ià(!
®t
)

130 
tuºc
->
p¤v
 =uºc->
¤v
;

131 
tuºc
->
¤v
 = 
®t
->
v
.
®t_£rv”
;

133 
”r
 = 
	`®loÿ‹_»que¡
(
tuºc
);

134 ià(
”r
)

141 
”r
 = 
	`tuºc_keyg’
(
tuºc
, 
msg
);

142 ià(
”r
)

145 
”r
 = 
	`®loÿ‹_»que¡
(
tuºc
);

146 ià(
”r
)

155 
out
:

156 
tuºc
->
	`th
(
”r
, 
scode
, 
»asÚ
,

157 
»l
 ? &»l->
v
.
xÜ_»Ïy_addr
 : 
NULL
,

158 
m­
 ? &m­->
v
.
xÜ_m­³d_addr
 : 
NULL
,

159 
msg
,

160 
tuºc
->
¬g
);

161 
	}
}

164 
	$®loÿ‹_»que¡
(
tuºc
 *
t
)

166 cÚ¡ 
ušt8_t
 
´Ùo
 = 
IPPROTO_UDP
;

168  
	`¡un_»que¡
(&
t
->
ù
,->
¡un
,->
´Ùo
,->
sock
, &t->
¤v
, 0,

169 
STUN_METHOD_ALLOCATE
,

170 
t
->
»®m
 ?->
md5_hash
 : 
NULL
, (t->md5_hash),

171 
çl£
, 
®loÿ‹_»¥_hªdËr
, 
t
, 6,

172 
STUN_ATTR_LIFETIME
, &
t
->
liãtime
,

173 
STUN_ATTR_REQ_TRANSPORT
, &
´Ùo
,

174 
STUN_ATTR_USERNAME
, 
t
->
»®m
 ?->
u£ºame
 : 
NULL
,

175 
STUN_ATTR_REALM
, 
t
->
»®m
,

176 
STUN_ATTR_NONCE
, 
t
->
nÚû
,

177 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

178 
	}
}

181 
	$»äesh_»¥_hªdËr
(
”r
, 
ušt16_t
 
scode
, cÚ¡ *
»asÚ
,

182 cÚ¡ 
¡un_msg
 *
msg
, *
¬g
)

184 
tuºc
 *tuºøğ
¬g
;

185 
¡un_©Œ
 *
Ém
;

187 ià(
”r
 || 
	`tuºc_»que¡_loİs
(&
tuºc
->
ls
, 
scode
))

188 
out
;

190 
scode
) {

193 
Ém
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_LIFETIME
);

194 ià(
Ém
)

195 
tuºc
->
liãtime
 = 
Ém
->
v
.lifetime;

196 
	`»äesh_tim”
(
tuºc
);

201 
”r
 = 
	`tuºc_keyg’
(
tuºc
, 
msg
);

202 ià(
”r
)

205 
”r
 = 
	`»äesh_»que¡
(
tuºc
,uºc->
liãtime
, 
çl£
,

206 
»äesh_»¥_hªdËr
, 
tuºc
);

207 ià(
”r
)

216 
out
:

217 
tuºc
->
	`th
(
”r
, 
scode
, 
»asÚ
, 
NULL
, NULL, 
msg
,uºc->
¬g
);

218 
	}
}

221 
	$»äesh_»que¡
(
tuºc
 *
t
, 
ušt32_t
 
liãtime
, 
boŞ
 
»£t_ls
,

222 
¡un_»¥_h
 *
»¥h
, *
¬g
)

224 ià(!
t
)

225  
EINVAL
;

227 ià(
»£t_ls
)

228 
	`tuºc_loİ¡©e_»£t
(&
t
->
ls
);

230 ià(
t
->
ù
)

231 
t
->
ù
 = 
	`mem_d”ef
(t->ct);

233  
	`¡un_»que¡
(&
t
->
ù
,->
¡un
,->
´Ùo
,->
sock
, &t->
¤v
, 0,

234 
STUN_METHOD_REFRESH
,

235 
t
->
»®m
 ?->
md5_hash
 : 
NULL
, (t->md5_hash),

236 
çl£
, 
»¥h
, 
¬g
, 5,

237 
STUN_ATTR_LIFETIME
, &
liãtime
,

238 
STUN_ATTR_USERNAME
, 
t
->
»®m
 ?->
u£ºame
 : 
NULL
,

239 
STUN_ATTR_REALM
, 
t
->
»®m
,

240 
STUN_ATTR_NONCE
, 
t
->
nÚû
,

241 
STUN_ATTR_SOFTWARE
, 
¡un_soáw¬e
);

242 
	}
}

245 
šlše
 
size_t
 
	$¡un_šdËn
(cÚ¡ 
§
 *sa)

247 
size_t
 
Ën
 = 
STUN_HEADER_SIZE
 + 
STUN_ATTR_HEADER_SIZE
 * 2;

249 
	`§_af
(
§
)) {

251 
AF_INET
:

252 
Ën
 +ğ
STUN_ATTR_ADDR4_SIZE
;

255 #ifdeà
HAVE_INET6


256 
AF_INET6
:

257 
Ën
 +ğ
STUN_ATTR_ADDR6_SIZE
;

262  
Ën
;

263 
	}
}

266 
boŞ
 
	$udp_£nd_hªdËr
(*
”r
, 
§
 *
d¡
, 
mbuf
 *
mb
,

267 *
¬g
)

269 
tuºc
 *tuºøğ
¬g
;

270 
size_t
 
pos
, 
šdËn
;

271 
chª
 *chan;

273 ià(
mb
->
pos
 < 
CHAN_HDR_SIZE
)

274  
çl£
;

276 
chª
 = 
	`tuºc_chª_fšd_³”
(
tuºc
, 
d¡
);

277 ià(
chª
) {

278 
chª_hdr
 
hdr
;

280 
hdr
.
Ä
 = 
	`tuºc_chª_numb
(
chª
);

281 
hdr
.
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

283 
mb
->
pos
 -ğ
CHAN_HDR_SIZE
;

284 *
”r
 = 
	`tuºc_chª_hdr_’code
(&
hdr
, 
mb
);

285 
mb
->
pos
 -ğ
CHAN_HDR_SIZE
;

287 *
d¡
 = 
tuºc
->
¤v
;

289  
çl£
;

292 
šdËn
 = 
	`¡un_šdËn
(
d¡
);

294 ià(
mb
->
pos
 < 
šdËn
)

295  
çl£
;

297 
mb
->
pos
 -ğ
šdËn
;

298 
pos
 = 
mb
->pos;

299 *
”r
 = 
	`¡un_msg_’code
(
mb
, 
STUN_METHOD_SEND
, 
STUN_CLASS_INDICATION
,

300 
£ndšd_tid
, 
NULL
, NULL, 0, 
çl£
, 0x00, 2,

301 
STUN_ATTR_XOR_PEER_ADDR
, 
d¡
,

302 
STUN_ATTR_DATA
, 
mb
);

303 
mb
->
pos
 =…os;

305 *
d¡
 = 
tuºc
->
¤v
;

307  
çl£
;

308 
	}
}

311 
boŞ
 
	$udp_»cv_hªdËr
(
§
 *
¤c
, 
mbuf
 *
mb
, *
¬g
)

313 
¡un_©Œ
 *
³”
, *
d©a
;

314 
¡un_unknown_©Œ
 
ua
;

315 
tuºc
 *tuºøğ
¬g
;

316 
¡un_msg
 *
msg
;

317 
boŞ
 
hdld
 = 
Œue
;

319 ià(!
	`§_cmp
(&
tuºc
->
¤v
, 
¤c
, 
SA_ALL
) &&

320 !
	`§_cmp
(&
tuºc
->
p¤v
, 
¤c
, 
SA_ALL
))

321  
çl£
;

323 ià(
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
)) {

325 
chª_hdr
 
hdr
;

326 
chª
 *chan;

328 ià(
	`tuºc_chª_hdr_decode
(&
hdr
, 
mb
))

329  
Œue
;

331 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
hdr
.
Ën
)

332  
Œue
;

334 
chª
 = 
	`tuºc_chª_fšd_numb
(
tuºc
, 
hdr
.
Ä
);

335 ià(!
chª
)

336  
Œue
;

338 *
¤c
 = *
	`tuºc_chª_³”
(
chª
);

340  
çl£
;

343 
	`¡un_msg_şass
(
msg
)) {

345 
STUN_CLASS_INDICATION
:

346 ià(
ua
.
ty³c
 > 0)

349 ià(
	`¡un_msg_m‘hod
(
msg
è!ğ
STUN_METHOD_DATA
)

352 
³”
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_PEER_ADDR
);

353 
d©a
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_DATA
);

354 ià(!
³”
 || !
d©a
)

357 *
¤c
 = 
³”
->
v
.
xÜ_³”_addr
;

359 
mb
->
pos
 = 
d©a
->
v
.data.pos;

360 
mb
->
’d
 = 
d©a
->
v
.data.end;

362 
hdld
 = 
çl£
;

365 
STUN_CLASS_ERROR_RESP
:

366 
STUN_CLASS_SUCCESS_RESP
:

367 ()
	`¡un_ù¿ns_»cv
(
tuºc
->
¡un
, 
msg
, &
ua
);

374 
	`mem_d”ef
(
msg
);

376  
hdld
;

377 
	}
}

397 
	$tuºc_®loc
(
tuºc
 **
tuºı
, cÚ¡ 
¡un_cÚf
 *
cÚf
, 
´Ùo
,

398 *
sock
, 
Ïy”
, cÚ¡ 
§
 *
¤v
,

399 cÚ¡ *
u£ºame
, cÚ¡ *
·sswÜd
,

400 
ušt32_t
 
liãtime
, 
tuºc_h
 *
th
, *
¬g
)

402 
tuºc
 *turnc;

403 
”r
;

405 ià(!
tuºı
 || !
sock
 || !
¤v
 || !
u£ºame
 || !
·sswÜd
 || !
th
)

406  
EINVAL
;

408 
tuºc
 = 
	`mem_z®loc
((*tuºc), 
de¡ruùÜ
);

409 ià(!
tuºc
)

410  
ENOMEM
;

412 
”r
 = 
	`¡un_®loc
(&
tuºc
->
¡un
, 
cÚf
, 
NULL
, NULL);

413 ià(
”r
)

414 
out
;

416 
”r
 = 
	`¡r_dup
(&
tuºc
->
u£ºame
, username);

417 ià(
”r
)

418 
out
;

420 
”r
 = 
	`¡r_dup
(&
tuºc
->
·sswÜd
,…assword);

421 ià(
”r
)

422 
out
;

424 
”r
 = 
	`tuºc_³rm_hash_®loc
(&
tuºc
->
³rms
, 
PERM_HASH_SIZE
);

425 ià(
”r
)

426 
out
;

428 
”r
 = 
	`tuºc_chª_hash_®loc
(&
tuºc
->
chªs
, 
CHAN_HASH_SIZE
);

429 ià(
”r
)

430 
out
;

432 
	`tmr_š™
(&
tuºc
->
tmr
);

433 
tuºc
->
´Ùo
 =…roto;

434 
tuºc
->
sock
 = 
	`mem_»f
(sock);

435 
tuºc
->
p¤v
 = *
¤v
;

436 
tuºc
->
¤v
 = *srv;

437 
tuºc
->
liãtime
 =†ifetime;

438 
tuºc
->
th
 =h;

439 
tuºc
->
¬g
 =‡rg;

441 
´Ùo
) {

443 
IPPROTO_UDP
:

444 
”r
 = 
	`udp_»gi¡”_h–³r
(&
tuºc
->
uh
, 
sock
, 
Ïy”
,

445 
udp_£nd_hªdËr
, 
udp_»cv_hªdËr
,

446 
tuºc
);

450 
”r
 = 0;

454 ià(
”r
)

455 
out
;

457 
”r
 = 
	`®loÿ‹_»que¡
(
tuºc
);

458 ià(
”r
)

459 
out
;

461 
out
:

462 ià(
”r
)

463 
	`mem_d”ef
(
tuºc
);

465 *
tuºı
 = 
tuºc
;

467  
”r
;

468 
	}
}

471 
	$tuºc_£nd
(
tuºc
 *tuºc, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

473 
size_t
 
pos
, 
šdËn
;

474 
chª
 *chan;

475 
”r
;

477 ià(!
tuºc
 || !
d¡
 || !
mb
)

478  
EINVAL
;

480 
chª
 = 
	`tuºc_chª_fšd_³”
(
tuºc
, 
d¡
);

481 ià(
chª
) {

482 
chª_hdr
 
hdr
;

484 ià(
mb
->
pos
 < 
CHAN_HDR_SIZE
)

485  
EINVAL
;

487 
hdr
.
Ä
 = 
	`tuºc_chª_numb
(
chª
);

488 
hdr
.
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
);

490 
mb
->
pos
 -ğ
CHAN_HDR_SIZE
;

491 
pos
 = 
mb
->pos;

493 
”r
 = 
	`tuºc_chª_hdr_’code
(&
hdr
, 
mb
);

494 ià(
”r
)

495  
”r
;

497 ià(
tuºc
->
´Ùo
 =ğ
IPPROTO_TCP
) {

499 
mb
->
pos
 = mb->
’d
;

502 
hdr
.
Ën
++ & 0x03) {

503 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, 0x00);

504 ià(
”r
)

505  
”r
;

509 
mb
->
pos
 =…os;

512 
šdËn
 = 
	`¡un_šdËn
(
d¡
);

514 ià(
mb
->
pos
 < 
šdËn
)

515  
EINVAL
;

517 
mb
->
pos
 -ğ
šdËn
;

518 
pos
 = 
mb
->pos;

520 
”r
 = 
	`¡un_msg_’code
(
mb
, 
STUN_METHOD_SEND
,

521 
STUN_CLASS_INDICATION
, 
£ndšd_tid
,

522 
NULL
, NULL, 0, 
çl£
, 0x00, 2,

523 
STUN_ATTR_XOR_PEER_ADDR
, 
d¡
,

524 
STUN_ATTR_DATA
, 
mb
);

525 ià(
”r
)

526  
”r
;

528 
mb
->
pos
 =…os;

531 
tuºc
->
´Ùo
) {

533 
IPPROTO_UDP
:

534 
”r
 = 
	`udp_£nd
(
tuºc
->
sock
, &tuºc->
¤v
, 
mb
);

537 
IPPROTO_TCP
:

538 
”r
 = 
	`tı_£nd
(
tuºc
->
sock
, 
mb
);

541 #ifdeà
USE_DTLS


542 
STUN_TRANSP_DTLS
:

543 
”r
 = 
	`ds_£nd
(
tuºc
->
sock
, 
mb
);

548 
”r
 = 
EPROTONOSUPPORT
;

552  
”r
;

553 
	}
}

556 
	$tuºc_»cv
(
tuºc
 *tuºc, 
§
 *
¤c
, 
mbuf
 *
mb
)

558 
¡un_©Œ
 *
³”
, *
d©a
;

559 
¡un_unknown_©Œ
 
ua
;

560 
¡un_msg
 *
msg
;

561 
”r
 = 0;

563 ià(!
tuºc
 || !
¤c
 || !
mb
)

564  
EINVAL
;

566 ià(
	`¡un_msg_decode
(&
msg
, 
mb
, &
ua
)) {

568 
chª_hdr
 
hdr
;

569 
chª
 *chan;

571 ià(
	`tuºc_chª_hdr_decode
(&
hdr
, 
mb
))

572  
EBADMSG
;

574 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
hdr
.
Ën
)

575  
EBADMSG
;

577 
chª
 = 
	`tuºc_chª_fšd_numb
(
tuºc
, 
hdr
.
Ä
);

578 ià(!
chª
)

579  
EBADMSG
;

581 *
¤c
 = *
	`tuºc_chª_³”
(
chª
);

586 
	`¡un_msg_şass
(
msg
)) {

588 
STUN_CLASS_INDICATION
:

589 ià(
ua
.
ty³c
 > 0) {

590 
”r
 = 
ENOSYS
;

594 ià(
	`¡un_msg_m‘hod
(
msg
è!ğ
STUN_METHOD_DATA
) {

595 
”r
 = 
ENOSYS
;

599 
³”
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_XOR_PEER_ADDR
);

600 
d©a
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_DATA
);

601 ià(!
³”
 || !
d©a
) {

602 
”r
 = 
EPROTO
;

606 *
¤c
 = 
³”
->
v
.
xÜ_³”_addr
;

608 
mb
->
pos
 = 
d©a
->
v
.data.pos;

609 
mb
->
’d
 = 
d©a
->
v
.data.end;

612 
STUN_CLASS_ERROR_RESP
:

613 
STUN_CLASS_SUCCESS_RESP
:

614 ()
	`¡un_ù¿ns_»cv
(
tuºc
->
¡un
, 
msg
, &
ua
);

615 
mb
->
pos
 = mb->
’d
;

619 
”r
 = 
ENOSYS
;

623 
	`mem_d”ef
(
msg
);

625  
”r
;

626 
	}
}

629 
boŞ
 
	$tuºc_»que¡_loİs
(
loİ_¡©e
 *
ls
, 
ušt16_t
 
scode
)

631 
boŞ
 
loİ
 = 
çl£
;

633 
scode
) {

636 
ls
->
çc
 = 0;

640 ià(
ls
->
Ï¡_scode
 =ğ
scode
)

641 
loİ
 = 
Œue
;

644 ià(++
ls
->
çc
 >ğ
FAILC_MAX
)

645 
loİ
 = 
Œue
;

650 
ls
->
Ï¡_scode
 = 
scode
;

652  
loİ
;

653 
	}
}

656 
	$tuºc_loİ¡©e_»£t
(
loİ_¡©e
 *
ls
)

658 ià(!
ls
)

661 
ls
->
Ï¡_scode
 = 0;

662 
ls
->
çc
 = 0;

663 
	}
}

666 
	$tuºc_keyg’
(
tuºc
 *tuºc, cÚ¡ 
¡un_msg
 *
msg
)

668 
¡un_©Œ
 *
»®m
, *
nÚû
;

670 
»®m
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_REALM
);

671 
nÚû
 = 
	`¡un_msg_©Œ
(
msg
, 
STUN_ATTR_NONCE
);

672 ià(!
»®m
 || !
nÚû
)

673  
EPROTO
;

675 
	`mem_d”ef
(
tuºc
->
»®m
);

676 
	`mem_d”ef
(
tuºc
->
nÚû
);

677 
tuºc
->
»®m
 = 
	`mem_»f
Ô—lm->
v
.realm);

678 
tuºc
->
nÚû
 = 
	`mem_»f
ÒÚû->
v
.nonce);

680  
	`md5_´štf
(
tuºc
->
md5_hash
, "%s:%s:%s",

681 
tuºc
->
u£ºame
,uºc->
»®m
,uºc->
·sswÜd
);

682 
	}
}

	@re-0.5.6/src/turn/turnc.h

6 
	~<time.h
>

9 
	sloİ_¡©e
 {

10 
ušt32_t
 
	mçc
;

11 
ušt16_t
 
	mÏ¡_scode
;

14 
	gchªÃls
;

17 
	stuºc
 {

18 
loİ_¡©e
 
	mls
;

19 
udp_h–³r
 *
	muh
;

20 
¡un_ù¿ns
 *
	mù
;

21 *
	mu£ºame
;

22 *
	m·sswÜd
;

23 
§
 
	mp¤v
;

24 
§
 
	m¤v
;

25 *
	msock
;

26 
	m´Ùo
;

27 
¡un
 *
	m¡un
;

28 
ušt32_t
 
	mliãtime
;

29 
tmr
 
	mtmr
;

30 
tuºc_h
 *
	mth
;

31 *
	m¬g
;

32 
ušt8_t
 
	mmd5_hash
[
MD5_SIZE
];

33 *
	mnÚû
;

34 *
	m»®m
;

35 
hash
 *
	m³rms
;

36 
chªÃls
 *
	mchªs
;

37 
boŞ
 
	m®loÿ‹d
;

42 
boŞ
 
tuºc_»que¡_loİs
(
loİ_¡©e
 *
ls
, 
ušt16_t
 
scode
);

43 
tuºc_loİ¡©e_»£t
(
loİ_¡©e
 *
ls
);

44 
tuºc_keyg’
(
tuºc
 *tuºc, cÚ¡ 
¡un_msg
 *
msg
);

48 
tuºc_³rm_hash_®loc
(
hash
 **
ht
, 
ušt32_t
 
bsize
);

53 
	mCHAN_HDR_SIZE
 = 4,

56 
	schª_hdr
 {

57 
ušt16_t
 
	mÄ
;

58 
ušt16_t
 
	mËn
;

61 
	gchª
;

63 
tuºc_chª_hash_®loc
(
chªÃls
 **
ı
, 
ušt32_t
 
bsize
);

64 
chª
 *
tuºc_chª_fšd_numb
(cÚ¡ 
tuºc
 *tuºc, 
ušt16_t
 
Ä
);

65 
chª
 *
tuºc_chª_fšd_³”
(cÚ¡ 
tuºc
 *turnc,

66 cÚ¡ 
§
 *
³”
);

67 
ušt16_t
 
tuºc_chª_numb
(cÚ¡ 
chª
 *chan);

68 cÚ¡ 
§
 *
tuºc_chª_³”
(cÚ¡ 
chª
 *chan);

69 
tuºc_chª_hdr_’code
(cÚ¡ 
chª_hdr
 *
hdr
, 
mbuf
 *
mb
);

70 
tuºc_chª_hdr_decode
(
chª_hdr
 *
hdr
, 
mbuf
 *
mb
);

	@re-0.5.6/src/udp/mcast.c

7 
	#_BSD_SOURCE
 1

	)

8 
	#_DEFAULT_SOURCE
 1

	)

9 
	~<»_ty³s.h
>

10 
	~<»_fmt.h
>

11 
	~<»_§.h
>

12 
	~<»_udp.h
>

15 
	$muÉiÿ¡_upd©e
(
udp_sock
 *
us
, cÚ¡ 
§
 *
group
,

16 
boŞ
 
još
)

18 
_m»q
 
m»q
;

19 #ifdeà
HAVE_INET6


20 
v6_m»q
 
m»q6
;

22 
”r
;

24 ià(!
us
 || !
group
)

25  
EINVAL
;

27 
	`§_af
(
group
)) {

29 
AF_INET
:

30 
m»q
.
imr_muÉŸddr
 = 
group
->
u
.
š
.
sš_addr
;

31 
m»q
.
imr_š‹rçû
.
s_addr
 = 0;

33 
”r
 = 
	`udp_£tsockİt
(
us
, 
IPPROTO_IP
,

34 
još


35 ? 
IP_ADD_MEMBERSHIP


36 : 
IP_DROP_MEMBERSHIP
,

37 &
m»q
, (mreq));

40 #ifdeà
HAVE_INET6


41 
AF_INET6
:

42 
m»q6
.
v6mr_muÉŸddr
 = 
group
->
u
.
š6
.
sš6_addr
;

43 
m»q6
.
v6mr_š‹rçû
 = 0;

45 
”r
 = 
	`udp_£tsockİt
(
us
, 
IPPROTO_IPV6
,

46 
još


47 ? 
IPV6_JOIN_GROUP


48 : 
IPV6_LEAVE_GROUP
,

49 &
m»q6
, (mreq6));

54  
EAFNOSUPPORT
;

57  
”r
;

58 
	}
}

61 
	$udp_muÉiÿ¡_još
(
udp_sock
 *
us
, cÚ¡ 
§
 *
group
)

63  
	`muÉiÿ¡_upd©e
(
us
, 
group
, 
Œue
);

64 
	}
}

67 
	$udp_muÉiÿ¡_Ëave
(
udp_sock
 *
us
, cÚ¡ 
§
 *
group
)

69  
	`muÉiÿ¡_upd©e
(
us
, 
group
, 
çl£
);

70 
	}
}

	@re-0.5.6/src/udp/udp.c

6 
	~<¡dlib.h
>

7 #ifdeà
HAVE_UNISTD_H


8 
	~<uni¡d.h
>

10 #ifdeà
HAVE_IO_H


11 
	~<io.h
>

13 #ià!
defšed
(
WIN32
è&& !defšed (
CYGWIN
)

14 
	#__USE_POSIX
 1

	)

15 
	#__USE_XOPEN2K
 1

	)

16 
	~<Ãtdb.h
>

18 
	~<¡ršg.h
>

19 #ifdeà
HAVE_STRINGS_H


20 
	~<¡ršgs.h
>

22 #ifdeà
__APPLE__


23 
	~"T¬g‘CÚd™iÚ®s.h
"

25 
	~<»_ty³s.h
>

26 
	~<»_fmt.h
>

27 
	~<»_mem.h
>

28 
	~<»_mbuf.h
>

29 
	~<»_li¡.h
>

30 
	~<»_maš.h
>

31 
	~<»_§.h
>

32 
	~<»_Ãt.h
>

33 
	~<»_udp.h
>

36 
	#DEBUG_MODULE
 "udp"

	)

37 
	#DEBUG_LEVEL
 5

	)

38 
	~<»_dbg.h
>

42 #ifdeà
WIN32


43 
	#BUF_CAST
 (*)

	)

44 
	#SOK_CAST
 ()

	)

45 
	#SIZ_CAST
 ()

	)

46 
	#şo£
 
şo£sock‘


	)

48 
	#BUF_CAST


	)

49 
	#SOK_CAST


	)

50 
	#SIZ_CAST


	)

55 
	mUDP_RXSZ_DEFAULT
 = 8192

60 
	sudp_sock
 {

61 
li¡
 
	mh–³rs
;

62 
udp_»cv_h
 *
	mrh
;

63 
udp_”rÜ_h
 *
	meh
;

64 *
	m¬g
;

65 
	mfd
;

66 
	mfd6
;

67 
boŞ
 
	mcÚn
;

68 
size_t
 
	mrxsz
;

69 
size_t
 
	mrx_´esz
;

73 
	sudp_h–³r
 {

74 
Ë
 
	mË
;

75 
	mÏy”
;

76 
udp_h–³r_£nd_h
 *
	m£ndh
;

77 
udp_h–³r_»cv_h
 *
	m»cvh
;

78 *
	m¬g
;

82 
	$dummy_udp_»cv_hªdËr
(cÚ¡ 
§
 *
¤c
,

83 
mbuf
 *
mb
, *
¬g
)

85 ()
¤c
;

86 ()
mb
;

87 ()
¬g
;

88 
	}
}

91 
boŞ
 
	$h–³r_£nd_hªdËr
(*
”r
, 
§
 *
d¡
,

92 
mbuf
 *
mb
, *
¬g
)

94 ()
”r
;

95 ()
d¡
;

96 ()
mb
;

97 ()
¬g
;

98  
çl£
;

99 
	}
}

102 
boŞ
 
	$h–³r_»cv_hªdËr
(
§
 *
¤c
,

103 
mbuf
 *
mb
, *
¬g
)

105 ()
¤c
;

106 ()
mb
;

107 ()
¬g
;

108  
çl£
;

109 
	}
}

112 
	$udp_de¡ruùÜ
(*
d©a
)

114 
udp_sock
 *
us
 = 
d©a
;

116 
	`li¡_æush
(&
us
->
h–³rs
);

118 ià(-1 !ğ
us
->
fd
) {

119 
	`fd_şo£
(
us
->
fd
);

120 ()
	`şo£
(
us
->
fd
);

123 ià(-1 !ğ
us
->
fd6
) {

124 
	`fd_şo£
(
us
->
fd6
);

125 ()
	`şo£
(
us
->
fd6
);

127 
	}
}

130 
	$udp_»ad
(
udp_sock
 *
us
, 
fd
)

132 
mbuf
 *
mb
 = 
	`mbuf_®loc
(
us
->
rxsz
);

133 
§
 
¤c
;

134 
Ë
 *le;

135 
”r
 = 0;

136 
ssize_t
 
n
;

138 ià(!
mb
)

141 
¤c
.
Ën
 = (¤c.
u
);

142 
n
 = 
	`»cväom
(
fd
, 
BUF_CAST
 
mb
->
buf
 + 
us
->
rx_´esz
,

143 
mb
->
size
 - 
us
->
rx_´esz
, 0,

144 &
¤c
.
u
.
§
, &¤c.
Ën
);

145 ià(
n
 < 0) {

146 
”r
 = 
”ºo
;

148 ià(
EAGAIN
 =ğ
”r
)

149 
out
;

151 #ifdeà
EWOULDBLOCK


152 ià(
EWOULDBLOCK
 =ğ
”r
)

153 
out
;

156 #ià
TARGET_OS_IPHONE


157 ià(
ENOTCONN
 =ğ
”r
) {

159 
udp_sock
 *
us_Ãw
;

160 
§
 
Ïddr
;

162 
”r
 = 
	`udp_loÿl_g‘
(
us
, &
Ïddr
);

163 ià(
”r
)

164 
out
;

166 ià(-1 !ğ
us
->
fd
) {

167 
	`fd_şo£
(
us
->
fd
);

168 ()
	`şo£
(
us
->
fd
);

169 
us
->
fd
 = -1;

172 ià(-1 !ğ
us
->
fd6
) {

173 
	`fd_şo£
(
us
->
fd6
);

174 ()
	`şo£
(
us
->
fd6
);

175 
us
->
fd6
 = -1;

178 
”r
 = 
	`udp_li¡’
(&
us_Ãw
, &
Ïddr
, 
NULL
, NULL);

179 ià(
”r
)

180 
out
;

182 
us
->
fd
 = 
us_Ãw
->fd;

183 
us
->
fd6
 = 
us_Ãw
->fd6;

185 
us_Ãw
->
fd
 = -1;

186 
us_Ãw
->
fd6
 = -1;

188 
	`mem_d”ef
(
us_Ãw
);

190 
	`udp_th»ad_©ch
(
us
);

192 
out
;

195 ià(
us
->
eh
)

196 
us
->
	`eh
(
”r
, us->
¬g
);

198 
out
;

201 
mb
->
pos
 = 
us
->
rx_´esz
;

202 
mb
->
’d
 = 
n
 + 
us
->
rx_´esz
;

204 ()
	`mbuf_»size
(
mb
, mb->
’d
);

207 
Ë
 = 
us
->
h–³rs
.
h—d
;

208 
Ë
) {

209 
udp_h–³r
 *
uh
 = 
Ë
->
d©a
;

210 
boŞ
 
hdld
;

212 
Ë
 =†e->
Ãxt
;

214 
hdld
 = 
uh
->
	`»cvh
(&
¤c
, 
mb
, uh->
¬g
);

215 ià(
hdld
)

216 
out
;

219 
us
->
	`rh
(&
¤c
, 
mb
, us->
¬g
);

221 
out
:

222 
	`mem_d”ef
(
mb
);

223 
	}
}

226 
	$udp_»ad_hªdËr
(
æags
, *
¬g
)

228 
udp_sock
 *
us
 = 
¬g
;

230 ()
æags
;

232 
	`udp_»ad
(
us
, us->
fd
);

233 
	}
}

236 
	$udp_»ad_hªdËr6
(
æags
, *
¬g
)

238 
udp_sock
 *
us
 = 
¬g
;

240 ()
æags
;

242 
	`udp_»ad
(
us
, us->
fd6
);

243 
	}
}

256 
	$udp_li¡’
(
udp_sock
 **
u¥
, cÚ¡ 
§
 *
loÿl
,

257 
udp_»cv_h
 *
rh
, *
¬g
)

259 
addršfo
 
hšts
, *
»s
 = 
NULL
, *
r
;

260 
udp_sock
 *
us
 = 
NULL
;

261 
addr
[64];

262 
£rv
[6] = "0";

263 
af
, 
”rÜ
, 
”r
 = 0;

265 ià(!
u¥
)

266  
EINVAL
;

268 
us
 = 
	`mem_z®loc
((*us), 
udp_de¡ruùÜ
);

269 ià(!
us
)

270  
ENOMEM
;

272 
	`li¡_š™
(&
us
->
h–³rs
);

274 
us
->
fd
 = -1;

275 
us
->
fd6
 = -1;

277 ià(
loÿl
) {

278 
af
 = 
	`§_af
(
loÿl
);

279 ()
	`»_¢´štf
(
addr
, (addr), "%H",

280 
§_´št_addr
, 
loÿl
);

281 ()
	`»_¢´štf
(
£rv
, (£rv), "%u", 
	`§_pÜt
(
loÿl
));

284 #ifdeà
HAVE_INET6


285 
af
 = 
AF_UNSPEC
;

287 
af
 = 
AF_INET
;

291 
	`mem£t
(&
hšts
, 0, (hints));

293 
hšts
.
ai_çmy
 = 
af
;

294 
hšts
.
ai_æags
 = 
AI_PASSIVE
 | 
AI_NUMERICHOST
;

295 
hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

296 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_UDP
;

298 
”rÜ
 = 
	`g‘addršfo
(
loÿl
 ? 
addr
 : 
NULL
, 
£rv
, &
hšts
, &
»s
);

299 ià(
”rÜ
) {

300 #ifdeà
WIN32


301 
	`DEBUG_WARNING
("listen: getaddrinfo: wsaerr=%d\n",

302 
	`WSAG‘La¡E¼Ü
());

304 
	`DEBUG_WARNING
("listen: getaddrinfo: %s:%s (%s)\n",

305 
addr
, 
£rv
, 
	`gai_¡»¼Ü
(
”rÜ
));

306 
”r
 = 
EADDRNOTAVAIL
;

307 
out
;

310 
r
 = 
»s
;„;„ =„->
ai_Ãxt
) {

311 
fd
 = -1;

313 ià(
us
->
fd
 > 0)

316 
	`DEBUG_INFO
("listen: for:‡f=%d‡ddr=%j\n",

317 
r
->
ai_çmy
,„->
ai_addr
);

319 
fd
 = 
SOK_CAST
 
	`sock‘
(
r
->
ai_çmy
, 
SOCK_DGRAM
, 
IPPROTO_UDP
);

320 ià(
fd
 < 0) {

321 
”r
 = 
”ºo
;

325 
”r
 = 
	`Ãt_sockİt_blockšg_£t
(
fd
, 
çl£
);

326 ià(
”r
) {

327 
	`DEBUG_WARNING
("ud°li¡’:‚Úblock s‘: %m\n", 
”r
);

328 ()
	`şo£
(
fd
);

332 ià(
	`bšd
(
fd
, 
r
->
ai_addr
, 
SIZ_CAST
„->
ai_add¾’
) < 0) {

333 
”r
 = 
”ºo
;

334 
	`DEBUG_INFO
("li¡’: bšd(): %m (%J)\n", 
”r
, 
loÿl
);

335 ()
	`şo£
(
fd
);

340 ià(
AF_INET6
 =ğ
r
->
ai_çmy
) {

341 
§
 sa;

342 
Ú
 = 1;

344 #ià
	`defšed
 (
IPPROTO_IPV6
è&& defšed (
IPV6_V6ONLY
)

345 
sockËn_t
 
Ú_Ën
 = (
Ú
);

346 ià(0 !ğ
	`g‘sockİt
(
fd
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
,

347 (*)&
Ú
, &
Ú_Ën
)) {

348 
Ú
 = 1;

352 ià(0==
	`§_£t_§
(&
§
, 
r
->
ai_addr
è&& 
	`§_is_ªy
(&sa)) {

353 
Ú
 = 1;

355 
	`DEBUG_INFO
("sock‘ %d: IPV6_V6ONLY i %d\n", 
fd
, 
Ú
);

356 ià(
Ú
) {

357 
us
->
fd6
 = 
fd
;

363 
us
->
fd
 = fd;

367 
	`ä“addršfo
(
»s
);

370 ià(-1 =ğ
us
->
fd
 && -1 =ğus->
fd6
) {

371 ià(0 =ğ
”r
)

372 
”r
 = 
EADDRNOTAVAIL
;

373 
out
;

376 
”r
 = 
	`udp_th»ad_©ch
(
us
);

377 ià(
”r
)

378 
out
;

380 
us
->
rh
 =„h ?„h : 
dummy_udp_»cv_hªdËr
;

381 
us
->
¬g
 =‡rg;

382 
us
->
rxsz
 = 
UDP_RXSZ_DEFAULT
;

384 
out
:

385 ià(
”r
)

386 
	`mem_d”ef
(
us
);

388 *
u¥
 = 
us
;

390  
”r
;

391 
	}
}

403 
	$udp_cÚÃù
(
udp_sock
 *
us
, cÚ¡ 
§
 *
³”
)

405 
fd
;

407 ià(!
us
 || !
³”
)

408  
EINVAL
;

411 ià(
AF_INET6
 =ğ
	`§_af
(
³”
è&& -1 !ğ
us
->
fd6
)

412 
fd
 = 
us
->
fd6
;

414 
fd
 = 
us
->fd;

416 ià(0 !ğ
	`cÚÃù
(
fd
, &
³”
->
u
.
§
,…“r->
Ën
))

417  
”ºo
;

419 
us
->
cÚn
 = 
Œue
;

422 
	}
}

425 
	$udp_£nd_š‹º®
(
udp_sock
 *
us
, cÚ¡ 
§
 *
d¡
,

426 
mbuf
 *
mb
, 
Ë
 *le)

428 
§
 
hd¡
;

429 
”r
 = 0, 
fd
;

432 ià(
AF_INET6
 =ğ
	`§_af
(
d¡
è&& -1 !ğ
us
->
fd6
)

433 
fd
 = 
us
->
fd6
;

435 
fd
 = 
us
->fd;

438 
Ë
) {

439 
udp_h–³r
 *
uh
 = 
Ë
->
d©a
;

441 
Ë
 =†e->
´ev
;

443 ià(
d¡
 !ğ&
hd¡
) {

444 
	`§_ıy
(&
hd¡
, 
d¡
);

445 
d¡
 = &
hd¡
;

448 ià(
uh
->
	`£ndh
(&
”r
, &
hd¡
, 
mb
, uh->
¬g
) ||ƒrr)

449  
”r
;

453 ià(
us
->
cÚn
) {

454 ià(
	`£nd
(
fd
, 
BUF_CAST
 
mb
->
buf
 + mb->
pos
, mb->
’d
 - mb->pos,

456  
”ºo
;

459 ià(
	`£ndto
(
fd
, 
BUF_CAST
 
mb
->
buf
 + mb->
pos
, mb->
’d
 - mb->pos,

460 0, &
d¡
->
u
.
§
, d¡->
Ën
) < 0)

461  
”ºo
;

465 
	}
}

477 
	$udp_£nd
(
udp_sock
 *
us
, cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

479 ià(!
us
 || !
d¡
 || !
mb
)

480  
EINVAL
;

482  
	`udp_£nd_š‹º®
(
us
, 
d¡
, 
mb
, us->
h–³rs
.

);

483 
	}
}

494 
	$udp_£nd_ªÚ
(cÚ¡ 
§
 *
d¡
, 
mbuf
 *
mb
)

496 
udp_sock
 *
us
;

497 
”r
;

499 ià(!
d¡
 || !
mb
)

500  
EINVAL
;

502 
”r
 = 
	`udp_li¡’
(&
us
, 
NULL
, NULL, NULL);

503 ià(
”r
)

504  
”r
;

506 
”r
 = 
	`udp_£nd_š‹º®
(
us
, 
d¡
, 
mb
, 
NULL
);

507 
	`mem_d”ef
(
us
);

509  
”r
;

510 
	}
}

523 
	$udp_loÿl_g‘
(cÚ¡ 
udp_sock
 *
us
, 
§
 *
loÿl
)

525 ià(!
us
 || !
loÿl
)

526  
EINVAL
;

528 
loÿl
->
Ën
 = Öoÿl->
u
);

530 ià(0 =ğ
	`g‘sockÇme
(
us
->
fd
, &
loÿl
->
u
.
§
, &loÿl->
Ën
))

533 ià(0 =ğ
	`g‘sockÇme
(
us
->
fd6
, &
loÿl
->
u
.
§
, &loÿl->
Ën
))

536  
”ºo
;

537 
	}
}

551 
	$udp_£tsockİt
(
udp_sock
 *
us
, 
Ëv–
, 
İŠame
,

552 cÚ¡ *
İtv®
, 
ušt32_t
 
İ’
)

554 
”r
 = 0;

556 ià(!
us
)

557  
EINVAL
;

559 ià(-1 !ğ
us
->
fd
) {

560 ià(0 !ğ
	`£tsockİt
(
us
->
fd
, 
Ëv–
, 
İŠame
,

561 
BUF_CAST
 
İtv®
, 
İ’
))

562 
”r
 |ğ
”ºo
;

565 ià(-1 !ğ
us
->
fd6
) {

566 ià(0 !ğ
	`£tsockİt
(
us
->
fd6
, 
Ëv–
, 
İŠame
,

567 
BUF_CAST
 
İtv®
, 
İ’
))

568 
”r
 |ğ
”ºo
;

571  
”r
;

572 
	}
}

583 
	$udp_sockbuf_£t
(
udp_sock
 *
us
, 
size
)

585 
”r
 = 0;

587 ià(!
us
)

588  
EINVAL
;

590 
”r
 |ğ
	`udp_£tsockİt
(
us
, 
SOL_SOCKET
, 
SO_RCVBUF
, &
size
, (size));

591 
”r
 |ğ
	`udp_£tsockİt
(
us
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
size
, (size));

593  
”r
;

594 
	}
}

603 
	$udp_rxsz_£t
(
udp_sock
 *
us
, 
size_t
 
rxsz
)

605 ià(!
us
)

608 
us
->
rxsz
 =„xsz;

609 
	}
}

618 
	$udp_rxbuf_´esz_£t
(
udp_sock
 *
us
, 
size_t
 
rx_´esz
)

620 ià(!
us
)

623 
us
->
rx_´esz
 =„x_presz;

624 
	}
}

634 
	$udp_hªdËr_£t
(
udp_sock
 *
us
, 
udp_»cv_h
 *
rh
, *
¬g
)

636 ià(!
us
)

639 
us
->
rh
 =„h ?„h : 
dummy_udp_»cv_hªdËr
;

640 
us
->
¬g
 =‡rg;

641 
	}
}

650 
	$udp_”rÜ_hªdËr_£t
(
udp_sock
 *
us
, 
udp_”rÜ_h
 *
eh
)

652 ià(!
us
)

655 
us
->
eh
 =ƒh;

656 
	}
}

667 
	$udp_sock_fd
(cÚ¡ 
udp_sock
 *
us
, 
af
)

669 ià(!
us
)

672 
af
) {

675 
AF_INET
:  
us
->
fd
;

676 
AF_INET6
:  (
us
->
fd6
 !ğ-1è? us->fd6 : us->
fd
;

678 
	}
}

688 
	$udp_th»ad_©ch
(
udp_sock
 *
us
)

690 
”r
 = 0;

692 ià(!
us
)

693  
EINVAL
;

695 ià(-1 !ğ
us
->
fd
) {

696 
”r
 = 
	`fd_li¡’
(
us
->
fd
, 
FD_READ
, 
udp_»ad_hªdËr
, us);

697 ià(
”r
)

698 
out
;

701 ià(-1 !ğ
us
->
fd6
) {

702 
”r
 = 
	`fd_li¡’
(
us
->
fd6
, 
FD_READ
, 
udp_»ad_hªdËr6
, us);

703 ià(
”r
)

704 
out
;

707 
out
:

708 ià(
”r
)

709 
	`udp_th»ad_d‘ach
(
us
);

711  
”r
;

712 
	}
}

720 
	$udp_th»ad_d‘ach
(
udp_sock
 *
us
)

722 ià(!
us
)

725 ià(-1 !ğ
us
->
fd
)

726 
	`fd_şo£
(
us
->
fd
);

728 ià(-1 !ğ
us
->
fd6
)

729 
	`fd_şo£
(
us
->
fd6
);

730 
	}
}

733 
	$h–³r_de¡ruùÜ
(*
d©a
)

735 
udp_h–³r
 *
uh
 = 
d©a
;

737 
	`li¡_uÆšk
(&
uh
->
Ë
);

738 
	}
}

741 
boŞ
 
	$sÜt_hªdËr
(
Ë
 *
Ë1
, Ë *
Ë2
, *
¬g
)

743 
udp_h–³r
 *
uh1
 = 
Ë1
->
d©a
, *
uh2
 = 
Ë2
->data;

744 ()
¬g
;

746  
uh1
->
Ïy”
 <ğ
uh2
->layer;

747 
	}
}

762 
	$udp_»gi¡”_h–³r
(
udp_h–³r
 **
uhp
, 
udp_sock
 *
us
,

763 
Ïy”
,

764 
udp_h–³r_£nd_h
 *
sh
, 
udp_h–³r_»cv_h
 *
rh
,

765 *
¬g
)

767 
udp_h–³r
 *
uh
;

769 ià(!
us
)

770  
EINVAL
;

772 
uh
 = 
	`mem_z®loc
((*uh), 
h–³r_de¡ruùÜ
);

773 ià(!
uh
)

774  
ENOMEM
;

776 
	`li¡_­³nd
(&
us
->
h–³rs
, &
uh
->
Ë
, uh);

778 
uh
->
Ïy”
 =†ayer;

779 
uh
->
£ndh
 = 
sh
 ? sh : 
h–³r_£nd_hªdËr
;

780 
uh
->
»cvh
 = 
rh
 ?„h : 
h–³r_»cv_hªdËr
;

781 
uh
->
¬g
 =‡rg;

783 
	`li¡_sÜt
(&
us
->
h–³rs
, 
sÜt_hªdËr
, 
NULL
);

785 ià(
uhp
)

786 *
uhp
 = 
uh
;

789 
	}
}

803 
	$udp_£nd_h–³r
(
udp_sock
 *
us
, cÚ¡ 
§
 *
d¡
,

804 
mbuf
 *
mb
, 
udp_h–³r
 *
uh
)

806 ià(!
us
 || !
d¡
 || !
mb
 || !
uh
)

807  
EINVAL
;

809  
	`udp_£nd_š‹º®
(
us
, 
d¡
, 
mb
, 
uh
->
Ë
.
´ev
);

810 
	}
}

821 
udp_h–³r
 *
	$udp_h–³r_fšd
(cÚ¡ 
udp_sock
 *
us
, 
Ïy”
)

823 
Ë
 *le;

825 ià(!
us
)

826  
NULL
;

828 
Ë
 = 
us
->
h–³rs
.
h—d
;†e;†ğË->
Ãxt
) {

830 
udp_h–³r
 *
uh
 = 
Ë
->
d©a
;

832 ià(
Ïy”
 =ğ
uh
->layer)

833  
uh
;

836  
NULL
;

837 
	}
}

	@re-0.5.6/src/uri/ucmp.c

6 
	~<»_ty³s.h
>

7 
	~<»_fmt.h
>

8 
	~<»_uri.h
>

11 
	$·¿m_hªdËr
(cÚ¡ 
¶
 *
²ame
, cÚ¡ ¶ *
pv®ue
,

12 *
¬g
)

14 
¶
 *
Ùh”_·¿ms
 = 
¬g
;

15 
¶
 
Ùh”_pv®ue
 = 
PL_INIT
;

16 
boŞ
 
bÙh
;

18 ià(0 =ğ
	`¶_¡rcmp
(
²ame
, "user"))

19 
bÙh
 = 
Œue
;

20 ià(0 =ğ
	`¶_¡rcmp
(
²ame
, "ttl"))

21 
bÙh
 = 
Œue
;

22 ià(0 =ğ
	`¶_¡rcmp
(
²ame
, "method"))

23 
bÙh
 = 
Œue
;

24 ià(0 =ğ
	`¶_¡rcmp
(
²ame
, "maddr"))

25 
bÙh
 = 
Œue
;

26 ià(0 =ğ
	`¶_¡rcmp
(
²ame
, "transport"))

27 
bÙh
 = 
Œue
;

29 
bÙh
 = 
çl£
;

31 ià(
	`uri_·¿m_g‘
(
Ùh”_·¿ms
, 
²ame
, &
Ùh”_pv®ue
))

32  
bÙh
 ? 
ENOENT
 : 0;

34  
	`¶_ÿ£cmp
(
pv®ue
, &
Ùh”_pv®ue
);

35 
	}
}

38 
	$h—d”_hªdËr
(cÚ¡ 
¶
 *
hÇme
, cÚ¡ ¶ *
hv®ue
,

39 *
¬g
)

41 
¶
 *
Ùh”_h—d”s
 = 
¬g
;

42 
¶
 
Ùh”_hv®ue
;

43 
”r
;

45 
”r
 = 
	`uri_h—d”_g‘
(
Ùh”_h—d”s
, 
hÇme
, &
Ùh”_hv®ue
);

46 ià(
”r
)

47  
”r
;

49  
	`¶_ÿ£cmp
(
hv®ue
, &
Ùh”_hv®ue
);

50 
	}
}

61 
boŞ
 
	$uri_cmp
(cÚ¡ 
uri
 *
l
, cÚ¡ ur˜*
r
)

63 
”r
;

65 ià(!
l
 || !
r
)

66  
çl£
;

68 ià(
l
 =ğ
r
)

69  
Œue
;

72 ià(
	`¶_ÿ£cmp
(&
l
->
scheme
, &
r
->scheme))

73  
çl£
;

76 ià(
	`¶_cmp
(&
l
->
u£r
, &
r
->user))

77  
çl£
;

79 ià(
	`¶_cmp
(&
l
->
·sswÜd
, &
r
->password))

80  
çl£
;

82 ià(
	`¶_ÿ£cmp
(&
l
->
ho¡
, &
r
->host))

83  
çl£
;

84 ià(
l
->
af
 !ğ
r
->af)

85  
çl£
;

87 ià(
l
->
pÜt
 !ğ
r
->port)

88  
çl£
;

91 
”r
 = 
	`uri_·¿ms_­¶y
(&
l
->
·¿ms
, 
·¿m_hªdËr
, (*)&
r
->params);

92 ià(
”r
)

93  
çl£
;

94 
”r
 = 
	`uri_·¿ms_­¶y
(&
r
->
·¿ms
, 
·¿m_hªdËr
, (*)&
l
->params);

95 ià(
”r
)

96  
çl£
;

99 
”r
 = 
	`uri_h—d”s_­¶y
(&
l
->
h—d”s
, 
h—d”_hªdËr
,

100 (*)&
r
->
h—d”s
);

101 ià(
”r
)

102  
çl£
;

103 
”r
 = 
	`uri_h—d”s_­¶y
(&
r
->
h—d”s
, 
h—d”_hªdËr
,

104 (*)&
l
->
h—d”s
);

105 ià(
”r
)

106  
çl£
;

109  
Œue
;

110 
	}
}

	@re-0.5.6/src/uri/uri.c

6 
	~<¡ršg.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_li¡.h
>

11 
	~<»_§.h
>

12 
	~<»_uri.h
>

23 
	$uri_’code
(
»_´štf
 *
pf
, cÚ¡ 
uri
 *uri)

25 
”r
;

27 ià(!
uri
)

30 ià(!
	`¶_is£t
(&
uri
->
scheme
è|| !¶_is£t(&uri->
ho¡
))

31  
EINVAL
;

33 
”r
 = 
	`»_h´štf
(
pf
, "%r:", &
uri
->
scheme
);

34 ià(
”r
)

35  
”r
;

37 ià(
	`¶_is£t
(&
uri
->
u£r
)) {

38 
”r
 = 
	`»_h´štf
(
pf
, "%r", &
uri
->
u£r
);

40 ià(
	`¶_is£t
(&
uri
->
·sswÜd
))

41 
”r
 |ğ
	`»_h´štf
(
pf
, ":%r", &
uri
->
·sswÜd
);

43 
”r
 |ğ
pf
->
	`vph
("@", 1,…f->
¬g
);

45 ià(
”r
)

46  
”r
;

50 
uri
->
af
) {

52 #ifdeà
HAVE_INET6


53 
AF_INET6
:

54 
”r
 = 
	`»_h´štf
(
pf
, "[%r]", &
uri
->
ho¡
);

59 
”r
 = 
	`»_h´štf
(
pf
, "%r", &
uri
->
ho¡
);

62 ià(
”r
)

63  
”r
;

65 ià(
uri
->
pÜt
)

66 
”r
 = 
	`»_h´štf
(
pf
, ":%u", 
uri
->
pÜt
);

68 
”r
 |ğ
	`»_h´štf
(
pf
, "%r%r", &
uri
->
·¿ms
, &uri->
h—d”s
);

70  
”r
;

71 
	}
}

79 
	$decode_ho¡pÜt
(cÚ¡ 
¶
 *
ho¡pÜt
, ¶ *
ho¡
,

80 
¶
 *
pÜt
)

83 ià(!
	`»_»gex
(
ho¡pÜt
->
p
, ho¡pÜt->
l
, "\\[[0-9a-f:]+\\][:]*[0-9]*",

84 
ho¡
, 
NULL
, 
pÜt
))

88  
	`»_»gex
(
ho¡pÜt
->
p
, ho¡pÜt->
l
, "[^:]+[:]*[0-9]*",

89 
ho¡
, 
NULL
, 
pÜt
);

90 
	}
}

101 
	$uri_decode
(
uri
 *uri, cÚ¡ 
¶
 *pl)

103 
§
 
addr
;

104 
¶
 
pÜt
 = 
PL_INIT
;

105 
¶
 
ho¡pÜt
;

106 
”r
;

108 ià(!
uri
 || !
¶
)

109  
EINVAL
;

111 
	`mem£t
(
uri
, 0, (*uri));

112 ià(0 =ğ
	`»_»gex
(
¶
->
p
,…l->
l
,

114 &
uri
->
scheme
, &uri->
u£r
, 
NULL
, &uri->
·sswÜd
,

115 &
ho¡pÜt
, &
uri
->
·¿ms
, &uri->
h—d”s
)) {

117 ià(0 =ğ
	`decode_ho¡pÜt
(&
ho¡pÜt
, &
uri
->
ho¡
, &
pÜt
))

118 
out
;

121 
	`mem£t
(
uri
, 0, (*uri));

122 
”r
 = 
	`»_»gex
(
¶
->
p
,…l->
l
, "[^:]+:[^;? ]+[^?]*[^]*",

123 &
uri
->
scheme
, &
ho¡pÜt
, &uri->
·¿ms
, &uri->
h—d”s
);

124 ià(0 =ğ
”r
) {

125 
”r
 = 
	`decode_ho¡pÜt
(&
ho¡pÜt
, &
uri
->
ho¡
, &
pÜt
);

126 ià(0 =ğ
”r
)

127 
out
;

130  
”r
;

132 
out
:

134 ià(0 =ğ
	`§_£t
(&
addr
, &
uri
->
ho¡
, 0))

135 
uri
->
af
 = 
	`§_af
(&
addr
);

137 
uri
->
af
 = 
AF_UNSPEC
;

139 ià(
	`¶_is£t
(&
pÜt
))

140 
uri
->
pÜt
 = (
ušt16_t
)
	`¶_u32
(&port);

143 
	}
}

155 
	$uri_·¿m_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ ¶ *
²ame
,

156 
¶
 *
pv®ue
)

158 
ex´
[128];

160 ià(!
¶
 || !
²ame
 || !
pv®ue
)

161  
EINVAL
;

163 ()
	`»_¢´štf
(
ex´
, Óx´), ";%r[=]*[^;]*", 
²ame
);

165  
	`»_»gex
(
¶
->
p
,…l->
l
, 
ex´
, 
NULL
, 
pv®ue
);

166 
	}
}

178 
	$uri_·¿ms_­¶y
(cÚ¡ 
¶
 *¶, 
uri_­¶y_h
 *
ah
, *
¬g
)

180 
¶
 
¶r
, 
²ame
, 
eq
, 
pv®ue
;

181 
”r
 = 0;

183 ià(!
¶
 || !
ah
)

184  
EINVAL
;

186 
¶r
 = *
¶
;

188 
¶r
.
l
 > 0) {

190 
”r
 = 
	`»_»gex
(
¶r
.
p
,…Ì.
l
, ";[^;=]+[=]*[^;]*",

191 &
²ame
, &
eq
, &
pv®ue
);

192 ià(
”r
)

195 
	`¶_advªû
(&
¶r
, 1 + 
²ame
.
l
 + 
eq
.È+ 
pv®ue
.l);

197 
”r
 = 
	`ah
(&
²ame
, &
pv®ue
, 
¬g
);

198 ià(
”r
)

202  
”r
;

203 
	}
}

215 
	$uri_h—d”_g‘
(cÚ¡ 
¶
 *¶, cÚ¡ ¶ *
hÇme
,

216 
¶
 *
hv®ue
)

218 
ex´
[128];

220 ià(!
¶
 || !
hÇme
 || !
hv®ue
)

221  
EINVAL
;

223 ()
	`»_¢´štf
(
ex´
, Óx´), "[?&]1%r=[^&]+", 
hÇme
);

225  
	`»_»gex
(
¶
->
p
,…l->
l
, 
ex´
, 
NULL
, 
hv®ue
);

226 
	}
}

238 
	$uri_h—d”s_­¶y
(cÚ¡ 
¶
 *¶, 
uri_­¶y_h
 *
ah
, *
¬g
)

240 
¶
 
¶r
, 
£p
, 
hÇme
, 
hv®ue
;

241 
”r
 = 0;

243 ià(!
¶
 || !
ah
)

244  
EINVAL
;

246 
¶r
 = *
¶
;

248 
¶r
.
l
 > 0) {

250 
”r
 = 
	`»_»gex
(
¶r
.
p
,…Ì.
l
, "[?&]1[^=]+=[^&]+",

251 &
£p
, &
hÇme
, &
hv®ue
);

252 ià(
”r
)

255 
	`¶_advªû
(&
¶r
, 
£p
.
l
 + 
hÇme
.È+ 1 + 
hv®ue
.l);

257 
”r
 = 
	`ah
(&
hÇme
, &
hv®ue
, 
¬g
);

258 ià(
”r
)

262  
”r
;

263 
	}
}

	@re-0.5.6/src/uri/uric.c

6 
	~<ùy³.h
>

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_uri.h
>

12 
	#DEBUG_MODULE
 "uric"

	)

13 
	#DEBUG_LEVEL
 5

	)

14 
	~<»_dbg.h
>

18 
	$boŞ
 (
	tesc_h
)(
	tc
);

21 
boŞ
 
	$is_m¬k
(
c
)

23 
c
) {

34  
Œue
;

36  
çl£
;

38 
	}
}

41 
boŞ
 
	$is_uÄe£rved
(
c
)

43  
	`i§Êum
(
c
è|| 
	`is_m¬k
(c);

44 
	}
}

47 
boŞ
 
	$is_u£r_uÄe£rved
(
c
)

49 
c
) {

59  
Œue
;

61  
çl£
;

63 
	}
}

65 
boŞ
 
	$is_hnv_uÄe£rved
(
c
)

67 
c
) {

76  
Œue
;

78  
çl£
;

80 
	}
}

83 
boŞ
 
	$is_u£r
(
c
)

85  
	`is_uÄe£rved
(
c
è|| 
	`is_u£r_uÄe£rved
(c);

86 
	}
}

89 
boŞ
 
	$is_·sswÜd
(
c
)

91 
c
) {

98  
Œue
;

100  
	`is_uÄe£rved
(
c
);

102 
	}
}

105 
boŞ
 
	$is_·¿m_uÄe£rved
(
c
)

107 
c
) {

116  
Œue
;

118  
çl£
;

120 
	}
}

123 
boŞ
 
	$is_·¿mch¬
(
c
)

125  
	`is_·¿m_uÄe£rved
(
c
è|| 
	`is_uÄe£rved
(c);

126 
	}
}

129 
boŞ
 
	$is_hv®ue
(
c
)

131  
	`is_hnv_uÄe£rved
(
c
è|| 
	`is_uÄe£rved
(c);

132 
	}
}

135 
	$comp_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *¶, 
esc_h
 *
eh
)

137 
size_t
 
i
;

138 
”r
 = 0;

140 ià(!
pf
 || !
¶
 || !
eh
)

141  
EINVAL
;

143 
i
=0; i<
¶
->
l
 && !
”r
; i++) {

144 cÚ¡ 
c
 = 
¶
->
p
[
i
];

146 ià(
	`eh
(
c
)) {

147 
”r
 = 
pf
->
	`vph
(&
c
, 1,…f->
¬g
);

150 
”r
 = 
	`»_h´štf
(
pf
, "%%%02X", 
c
);

154  
”r
;

155 
	}
}

158 
	$comp_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *¶, 
esc_h
 *
eh
)

160 
size_t
 
i
;

161 
”r
 = 0;

163 ià(!
pf
 || !
¶
 || !
eh
)

164  
EINVAL
;

166 
i
=0; i<
¶
->
l
 && !
”r
; i++) {

167 cÚ¡ 
c
 = 
¶
->
p
[
i
];

169 ià(
	`eh
(
c
)) {

170 
”r
 = 
pf
->
	`vph
(&
c
, 1,…f->
¬g
);

174 ià('%' =ğ
c
) {

175 ià(
i
+2 < 
¶
->
l
) {

176 cÚ¡ 
ušt8_t
 
hi
 = 
	`ch_hex
(
¶
->
p
[++
i
]);

177 cÚ¡ 
ušt8_t
 
lo
 = 
	`ch_hex
(
¶
->
p
[++
i
]);

178 cÚ¡ 
b
 = 
hi
<<4 | 
lo
;

179 
”r
 = 
pf
->
	`vph
(&
b
, 1,…f->
¬g
);

182 
	`DEBUG_WARNING
("uÃsÿ³: shÜˆur˜(%u)\n", 
i
);

183  
EBADMSG
;

187 
	`DEBUG_WARNING
("unescape: illegal '%c' in %r\n",

188 
c
, 
¶
);

189  
EINVAL
;

193  
”r
;

194 
	}
}

205 
	$uri_u£r_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

207  
	`comp_esÿ³
(
pf
, 
¶
, 
is_u£r
);

208 
	}
}

219 
	$uri_u£r_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

221  
	`comp_uÃsÿ³
(
pf
, 
¶
, 
is_u£r
);

222 
	}
}

233 
	$uri_·sswÜd_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

235  
	`comp_esÿ³
(
pf
, 
¶
, 
is_·sswÜd
);

236 
	}
}

247 
	$uri_·sswÜd_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

249  
	`comp_uÃsÿ³
(
pf
, 
¶
, 
is_·sswÜd
);

250 
	}
}

261 
	$uri_·¿m_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

263  
	`comp_esÿ³
(
pf
, 
¶
, 
is_·¿mch¬
);

264 
	}
}

275 
	$uri_·¿m_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

277  
	`comp_uÃsÿ³
(
pf
, 
¶
, 
is_·¿mch¬
);

278 
	}
}

289 
	$uri_h—d”_esÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

291  
	`comp_esÿ³
(
pf
, 
¶
, 
is_hv®ue
);

292 
	}
}

303 
	$uri_h—d”_uÃsÿ³
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *pl)

305  
	`comp_uÃsÿ³
(
pf
, 
¶
, 
is_hv®ue
);

306 
	}
}

	@re-0.5.6/src/websock/websock.c

7 
	~<»_ty³s.h
>

8 
	~<»_fmt.h
>

9 
	~<»_mem.h
>

10 
	~<»_mbuf.h
>

11 
	~<»_§.h
>

12 
	~<»_li¡.h
>

13 
	~<»_tmr.h
>

14 
	~<»_¤.h
>

15 
	~<»_tı.h
>

16 
	~<»_s.h
>

17 
	~<»_msg.h
>

18 
	~<»_h‰p.h
>

19 
	~<»_ba£64.h
>

20 
	~<»_sha.h
>

21 
	~<»_sys.h
>

22 
	~<»_websock.h
>

26 
	mTIMEOUT_CLOSE
 = 10000,

27 
	mBUFSIZE_MAX
 = 131072,

30 
	ewebsock_¡©e
 {

31 
	mACCEPTING
 = 0,

32 
	mCONNECTING
,

33 
	mOPEN
,

34 
	mCLOSING
,

35 
	mCLOSED
,

38 
	swebsock
 {

39 
websock_shutdown_h
 *
	mshuth
;

40 *
	m¬g
;

41 
boŞ
 
	mshutdown
;

44 
	swebsock_cÚn
 {

45 
tmr
 
	mtmr
;

46 
§
 
	m³”
;

47 
	mnÚû
[24];

48 
websock
 *
	msock
;

49 
tı_cÚn
 *
	mtc
;

50 
s_cÚn
 *
	msc
;

51 
mbuf
 *
	mmb
;

52 
h‰p_»q
 *
	m»q
;

53 
websock_e¡ab_h
 *
	me¡abh
;

54 
websock_»cv_h
 *
	m»cvh
;

55 
websock_şo£_h
 *
	mşo£h
;

56 *
	m¬g
;

57 
websock_¡©e
 
	m¡©e
;

58 
	mkašt
;

59 
boŞ
 
	maùive
;

63 cÚ¡ 
	gmagic
[] = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11";

66 
timeout_hªdËr
(*
¬g
);

69 
	$dummy_»cv_hªdËr
(cÚ¡ 
websock_hdr
 *
hdr
, 
mbuf
 *
mb
,

70 *
¬g
)

72 ()
hdr
;

73 ()
mb
;

74 ()
¬g
;

75 
	}
}

78 
	$š‹º®_şo£_hªdËr
(
”r
, *
¬g
)

80 
websock_cÚn
 *
cÚn
 = 
¬g
;

81 ()
”r
;

83 
	`mem_d”ef
(
cÚn
);

84 
	}
}

87 
	$sock_de¡ruùÜ
(*
¬g
)

89 
websock
 *
sock
 = 
¬g
;

91 ià(
sock
->
shutdown
) {

92 
sock
->
shutdown
 = 
çl£
;

93 
	`mem_»f
(
sock
);

94 ià(
sock
->
shuth
)

95 
sock
->
	`shuth
(sock->
¬g
);

98 
	}
}

101 
	$cÚn_de¡ruùÜ
(*
¬g
)

103 
websock_cÚn
 *
cÚn
 = 
¬g
;

105 ià(
cÚn
->
¡©e
 =ğ
OPEN
)

106 ()
	`websock_şo£
(
cÚn
, 
WEBSOCK_GOING_AWAY
, "Going Away");

108 ià(
cÚn
->
¡©e
 =ğ
CLOSING
) {

110 
cÚn
->
»cvh
 = 
dummy_»cv_hªdËr
;

111 
cÚn
->
şo£h
 = 
š‹º®_şo£_hªdËr
;

112 
cÚn
->
¬g
 = conn;

114 
	`tmr_¡¬t
(&
cÚn
->
tmr
, 
TIMEOUT_CLOSE
, 
timeout_hªdËr
, conn);

117 
	`mem_»f
(
cÚn
);

121 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

122 
	`mem_d”ef
(
cÚn
->
sc
);

123 
	`mem_d”ef
(
cÚn
->
tc
);

124 
	`mem_d”ef
(
cÚn
->
mb
);

125 
	`mem_d”ef
(
cÚn
->
»q
);

126 
	`mem_d”ef
(
cÚn
->
sock
);

127 
	}
}

130 
	$cÚn_şo£
(
websock_cÚn
 *
cÚn
, 
”r
)

132 
	`tmr_ÿnûl
(&
cÚn
->
tmr
);

133 
cÚn
->
sc
 = 
	`mem_d”ef
(conn->sc);

134 
cÚn
->
tc
 = 
	`mem_d”ef
(conn->tc);

135 
cÚn
->
¡©e
 = 
CLOSED
;

137 
cÚn
->
	`şo£h
(
”r
, cÚn->
¬g
);

138 
	}
}

141 
	$timeout_hªdËr
(*
¬g
)

143 
websock_cÚn
 *
cÚn
 = 
¬g
;

145 
	`cÚn_şo£
(
cÚn
, 
ETIMEDOUT
);

146 
	}
}

149 
	$k“·live_hªdËr
(*
¬g
)

151 
websock_cÚn
 *
cÚn
 = 
¬g
;

153 
	`tmr_¡¬t
(&
cÚn
->
tmr
, cÚn->
kašt
, 
k“·live_hªdËr
, conn);

155 ()
	`websock_£nd
(
cÚn
, 
WEBSOCK_PING
, 
NULL
);

156 
	}
}

159 
websock_scode
 
	$websock_”r2scode
(
”r
)

161 
”r
) {

163 
EOVERFLOW
:  
WEBSOCK_MESSAGE_TOO_BIG
;

164 
EPROTO
:  
WEBSOCK_PROTOCOL_ERROR
;

165 
EBADMSG
:  
WEBSOCK_PROTOCOL_ERROR
;

166 :  
WEBSOCK_INTERNAL_ERROR
;

168 
	}
}

171 
	$websock_decode
(
websock_hdr
 *
hdr
, 
mbuf
 *
mb
)

173 
ušt8_t
 
v
, *
p
;

174 
size_t
 
i
;

176 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

177  
ENODATA
;

179 
v
 = 
	`mbuf_»ad_u8
(
mb
);

180 
hdr
->
fš
 = 
v
>>7 & 0x1;

181 
hdr
->
rsv1
 = 
v
>>6 & 0x1;

182 
hdr
->
rsv2
 = 
v
>>5 & 0x1;

183 
hdr
->
rsv3
 = 
v
>>4 & 0x1;

184 
hdr
->
İcode
 = 
v
 & 0x0f;

186 
v
 = 
	`mbuf_»ad_u8
(
mb
);

187 
hdr
->
mask
 = 
v
>>7 & 0x1;

188 
hdr
->
Ën
 = 
v
 & 0x7f;

190 ià(
hdr
->
Ën
 == 126) {

192 ià(
	`mbuf_g‘_Ëá
(
mb
) < 2)

193  
ENODATA
;

195 
hdr
->
Ën
 = 
	`Áohs
(
	`mbuf_»ad_u16
(
mb
));

197 ià(
hdr
->
Ën
 == 127) {

199 ià(
	`mbuf_g‘_Ëá
(
mb
) < 8)

200  
ENODATA
;

202 
hdr
->
Ën
 = 
	`sys_ÁohÎ
(
	`mbuf_»ad_u64
(
mb
));

205 ià(
hdr
->
mask
) {

207 ià(
	`mbuf_g‘_Ëá
(
mb
è< (4 + 
hdr
->
Ën
))

208  
ENODATA
;

210 
hdr
->
mkey
[0] = 
	`mbuf_»ad_u8
(
mb
);

211 
hdr
->
mkey
[1] = 
	`mbuf_»ad_u8
(
mb
);

212 
hdr
->
mkey
[2] = 
	`mbuf_»ad_u8
(
mb
);

213 
hdr
->
mkey
[3] = 
	`mbuf_»ad_u8
(
mb
);

215 
i
=0, 
p
=
	`mbuf_buf
(
mb
); i<
hdr
->
Ën
; i++)

216 
p
[
i
] =…[i] ^ 
hdr
->
mkey
[i%4];

219 ià(
	`mbuf_g‘_Ëá
(
mb
è< 
hdr
->
Ën
)

220  
ENODATA
;

224 
	}
}

227 
	$»cv_hªdËr
(
mbuf
 *
mb
, *
¬g
)

229 
websock_cÚn
 *
cÚn
 = 
¬g
;

230 
”r
 = 0;

232 ià(
cÚn
->
mb
) {

234 cÚ¡ 
size_t
 
Ën
 = 
	`mbuf_g‘_Ëá
(
mb
), 
pos
 = 
cÚn
->mb->pos;

236 ià((
	`mbuf_g‘_Ëá
(
cÚn
->
mb
è+ 
Ën
è> 
BUFSIZE_MAX
) {

237 
”r
 = 
EOVERFLOW
;

238 
out
;

241 
cÚn
->
mb
->
pos
 = cÚn->mb->
’d
;

243 
”r
 = 
	`mbuf_wr™e_mem
(
cÚn
->
mb
, 
	`mbuf_buf
(mb), 
Ën
);

244 ià(
”r
)

245 
out
;

247 
cÚn
->
mb
->
pos
 =…os;

250 
cÚn
->
mb
 = 
	`mem_»f
(mb);

253 
cÚn
->
mb
) {

255 
websock_hdr
 
hdr
;

256 
size_t
 
pos
, 
’d
;

258 
pos
 = 
cÚn
->
mb
->pos;

260 
”r
 = 
	`websock_decode
(&
hdr
, 
cÚn
->
mb
);

261 ià(
”r
) {

262 ià(
”r
 =ğ
ENODATA
) {

263 
cÚn
->
mb
->
pos
 =…os;

264 
”r
 = 0;

268 
out
;

271 ià(
cÚn
->
aùive
 =ğ
hdr
.
mask
) {

272 
”r
 = 
EPROTO
;

273 
out
;

276 ià(
hdr
.
rsv1
 || hdr.
rsv2
 || hdr.
rsv3
) {

277 
”r
 = 
EPROTO
;

278 
out
;

281 
mb
 = 
cÚn
->mb;

283 
’d
 = 
mb
->end;

284 
mb
->
’d
 = mb->
pos
 + (
size_t
)
hdr
.
Ën
;

286 ià(
’d
 > 
mb
->end) {

287 
mbuf
 *
mbn
 = 
	`mbuf_®loc
(
’d
 - 
mb
->end);

288 ià(!
mbn
) {

289 
”r
 = 
ENOMEM
;

290 
out
;

293 ()
	`mbuf_wr™e_mem
(
mbn
, 
mb
->
buf
 + mb->
’d
,

294 
’d
 - 
mb
->end);

295 
mbn
->
pos
 = 0;

297 
cÚn
->
mb
 = 
mbn
;

300 
cÚn
->
mb
 = 
NULL
;

303 
hdr
.
İcode
) {

305 
WEBSOCK_CONT
:

306 
WEBSOCK_TEXT
:

307 
WEBSOCK_BIN
:

308 
	`mem_»f
(
cÚn
);

309 
cÚn
->
	`»cvh
(&
hdr
, 
mb
, cÚn->
¬g
);

311 ià(
	`mem_Äefs
(
cÚn
) == 1) {

313 ià(
cÚn
->
¡©e
 =ğ
OPEN
)

314 ()
	`websock_şo£
(
cÚn
,

315 
WEBSOCK_GOING_AWAY
,

323 
cÚn
->
¡©e
 = 
CLOSING
;

325 
	`mem_d”ef
(
cÚn
);

328 
WEBSOCK_CLOSE
:

329 ià(
cÚn
->
¡©e
 =ğ
OPEN
)

330 ()
	`websock_£nd
(
cÚn
, 
WEBSOCK_CLOSE
, "%b",

331 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

332 
	`cÚn_şo£
(
cÚn
, 0);

333 
	`mem_d”ef
(
mb
);

336 
WEBSOCK_PING
:

337 ()
	`websock_£nd
(
cÚn
, 
WEBSOCK_PONG
, "%b",

338 
	`mbuf_buf
(
mb
), 
	`mbuf_g‘_Ëá
(mb));

341 
WEBSOCK_PONG
:

345 
	`mem_d”ef
(
mb
);

346 
”r
 = 
EPROTO
;

347 
out
;

350 
	`mem_d”ef
(
mb
);

353 
out
:

354 ià(
”r
) {

355 ()
	`websock_şo£
(
cÚn
, 
	`websock_”r2scode
(
”r
), 
NULL
);

356 
	`cÚn_şo£
(
cÚn
, 
”r
);

358 
	}
}

361 
	$şo£_hªdËr
(
”r
, *
¬g
)

363 
websock_cÚn
 *
cÚn
 = 
¬g
;

365 
	`cÚn_şo£
(
cÚn
, 
”r
);

366 
	}
}

369 
	$acû±_´št
(
»_´štf
 *
pf
, cÚ¡ 
¶
 *
key
)

371 
ušt8_t
 
dige¡
[
SHA_DIGEST_LENGTH
];

372 
SHA_CTX
 
ùx
;

374 
	`SHA1_In™
(&
ùx
);

375 
	`SHA1_Upd©e
(&
ùx
, 
key
->
p
, key->
l
);

376 
	`SHA1_Upd©e
(&
ùx
, 
magic
, (magic)-1);

377 
	`SHA1_Fš®
(
dige¡
, &
ùx
);

379  
	`ba£64_´št
(
pf
, 
dige¡
, (digest));

380 
	}
}

383 
	$h‰p_»¥_hªdËr
(
”r
, cÚ¡ 
h‰p_msg
 *
msg
, *
¬g
)

385 
websock_cÚn
 *
cÚn
 = 
¬g
;

386 cÚ¡ 
h‰p_hdr
 *
hdr
;

387 
¶
 
key
;

388 
buf
[32];

390 ià(
”r
 || 
msg
->
scode
 != 101)

391 
ç
;

393 ià(!
	`h‰p_msg_hdr_has_v®ue
(
msg
, 
HTTP_HDR_UPGRADE
, "websocket"))

394 
ç
;

396 ià(!
	`h‰p_msg_hdr_has_v®ue
(
msg
, 
HTTP_HDR_CONNECTION
, "Upgrade"))

397 
ç
;

399 
hdr
 = 
	`h‰p_msg_hdr
(
msg
, 
HTTP_HDR_SEC_WEBSOCKET_ACCEPT
);

400 ià(!
hdr
)

401 
ç
;

403 
key
.
p
 = 
cÚn
->
nÚû
;

404 
key
.
l
 = (
cÚn
->
nÚû
);

406 ià(
	`»_¢´štf
(
buf
, (buf), "%H", 
acû±_´št
, &
key
) < 0)

407 
ç
;

409 ià(
	`¶_¡rcmp
(&
hdr
->
v®
, 
buf
))

410 
ç
;

414 
cÚn
->
¡©e
 = 
OPEN
;

415 ()
	`tı_cÚn_³”_g‘
(
cÚn
->
tc
, &cÚn->
³”
);

417 ià(
cÚn
->
kašt
)

418 
	`tmr_¡¬t
(&
cÚn
->
tmr
, cÚn->
kašt
, 
k“·live_hªdËr
, conn);

420 
cÚn
->
	`e¡abh
(cÚn->
¬g
);

423 
ç
:

424 
	`cÚn_şo£
(
cÚn
, 
”r
 ?ƒ¼ : 
EPROTO
);

425 
	}
}

428 
	$h‰p_cÚn_hªdËr
(
tı_cÚn
 *
tc
, 
s_cÚn
 *
sc
,

429 *
¬g
)

431 
websock_cÚn
 *
cÚn
 = 
¬g
;

433 
cÚn
->
tc
 = 
	`mem_»f
(tc);

434 
cÚn
->
sc
 = 
	`mem_»f
(sc);

436 
	`tı_£t_hªdËrs
(
cÚn
->
tc
, 
NULL
, 
»cv_hªdËr
, 
şo£_hªdËr
, conn);

437 
	}
}

440 
	$websock_cÚÃù
(
websock_cÚn
 **
cÚÅ
, 
websock
 *
sock
,

441 
h‰p_şi
 *
şi
, cÚ¡ *
uri
, 
kašt
,

442 
websock_e¡ab_h
 *
e¡abh
, 
websock_»cv_h
 *
»cvh
,

443 
websock_şo£_h
 *
şo£h
, *
¬g
,

444 cÚ¡ *
fmt
, ...)

446 
websock_cÚn
 *
cÚn
;

447 
ušt8_t
 
nÚû
[16];

448 
va_li¡
 
­
;

449 
size_t
 
Ën
;

450 
”r
;

452 ià(!
cÚÅ
 || !
sock
 || !
şi
 || !
uri
 || !
e¡abh
 || !
»cvh
 || !
şo£h
)

453  
EINVAL
;

455 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

456 ià(!
cÚn
)

457  
ENOMEM
;

460 
	`¿nd_by‹s
(
nÚû
, (nonce));

462 
Ën
 = (
cÚn
->
nÚû
);

464 
”r
 = 
	`ba£64_’code
(
nÚû
, ÒÚû), 
cÚn
->nÚû, &
Ën
);

465 ià(
”r
)

466 
out
;

468 
cÚn
->
sock
 = 
	`mem_»f
(sock);

469 
cÚn
->
kašt
 = kaint;

470 
cÚn
->
e¡abh
 =ƒstabh;

471 
cÚn
->
»cvh
 =„ecvh;

472 
cÚn
->
şo£h
 = closeh;

473 
cÚn
->
¬g
 =‡rg;

474 
cÚn
->
¡©e
 = 
CONNECTING
;

475 
cÚn
->
aùive
 = 
Œue
;

478 
	`va_¡¬t
(
­
, 
fmt
);

479 
”r
 = 
	`h‰p_»que¡
(&
cÚn
->
»q
, 
şi
, "GET", 
uri
,

480 
h‰p_»¥_hªdËr
, 
NULL
, 
cÚn
,

487 
cÚn
->
nÚû
, (conn->nonce),

488 
fmt
, &
­
);

489 
	`va_’d
(
­
);

490 ià(
”r
)

491 
out
;

493 
	`h‰p_»q_£t_cÚn_hªdËr
(
cÚn
->
»q
, 
h‰p_cÚn_hªdËr
);

495 
out
:

496 ià(
”r
)

497 
	`mem_d”ef
(
cÚn
);

499 *
cÚÅ
 = 
cÚn
;

501  
”r
;

502 
	}
}

505 
	$websock_acû±
(
websock_cÚn
 **
cÚÅ
, 
websock
 *
sock
,

506 
h‰p_cÚn
 *
htcÚn
, cÚ¡ 
h‰p_msg
 *
msg
,

507 
kašt
, 
websock_»cv_h
 *
»cvh
,

508 
websock_şo£_h
 *
şo£h
, *
¬g
)

510 cÚ¡ 
h‰p_hdr
 *
key
;

511 
websock_cÚn
 *
cÚn
;

512 
”r
;

514 ià(!
cÚÅ
 || !
sock
 || !
htcÚn
 || !
msg
 || !
»cvh
 || !
şo£h
)

515  
EINVAL
;

517 ià(!
	`h‰p_msg_hdr_has_v®ue
(
msg
, 
HTTP_HDR_UPGRADE
, "websocket"))

518  
EBADMSG
;

520 ià(!
	`h‰p_msg_hdr_has_v®ue
(
msg
, 
HTTP_HDR_CONNECTION
, "Upgrade"))

521  
EBADMSG
;

523 ià(!
	`h‰p_msg_hdr_has_v®ue
(
msg
, 
HTTP_HDR_SEC_WEBSOCKET_VERSION
, "13"))

524  
EBADMSG
;

526 
key
 = 
	`h‰p_msg_hdr
(
msg
, 
HTTP_HDR_SEC_WEBSOCKET_KEY
);

527 ià(!
key
)

528  
EBADMSG
;

530 
cÚn
 = 
	`mem_z®loc
((*cÚn), 
cÚn_de¡ruùÜ
);

531 ià(!
cÚn
)

532  
ENOMEM
;

534 
”r
 = 
	`h‰p_»¶y
(
htcÚn
, 101, "Switching Protocols",

539 
acû±_´št
, &
key
->
v®
);

540 ià(
”r
)

541 
out
;

543 
	`§_ıy
(&
cÚn
->
³”
, 
	`h‰p_cÚn_³”
(
htcÚn
));

544 
cÚn
->
sock
 = 
	`mem_»f
(sock);

545 
cÚn
->
tc
 = 
	`mem_»f
(
	`h‰p_cÚn_tı
(
htcÚn
));

546 
cÚn
->
sc
 = 
	`mem_»f
(
	`h‰p_cÚn_s
(
htcÚn
));

547 
cÚn
->
kašt
 = kaint;

548 
cÚn
->
»cvh
 =„ecvh;

549 
cÚn
->
şo£h
 = closeh;

550 
cÚn
->
¬g
 =‡rg;

551 
cÚn
->
¡©e
 = 
OPEN
;

552 
cÚn
->
aùive
 = 
çl£
;

554 
	`tı_£t_hªdËrs
(
cÚn
->
tc
, 
NULL
, 
»cv_hªdËr
, 
şo£_hªdËr
, conn);

555 
	`h‰p_cÚn_şo£
(
htcÚn
);

557 ià(
cÚn
->
kašt
)

558 
	`tmr_¡¬t
(&
cÚn
->
tmr
, cÚn->
kašt
, 
k“·live_hªdËr
, conn);

560 
out
:

561 ià(
”r
)

562 
	`mem_d”ef
(
cÚn
);

564 *
cÚÅ
 = 
cÚn
;

566  
”r
;

567 
	}
}

570 
	$websock_’code
(
mbuf
 *
mb
, 
boŞ
 
fš
,

571 
websock_İcode
 
İcode
, 
boŞ
 
mask
, 
size_t
 
Ën
)

573 
”r
;

575 
”r
 = 
	`mbuf_wr™e_u8
(
mb
, (
fš
<<7è| (
İcode
 & 0x0f));

577 ià(
Ën
 > 0xffff) {

578 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, (
mask
<<7) | 127);

579 
”r
 |ğ
	`mbuf_wr™e_u64
(
mb
, 
	`sys_htÚÎ
(
Ën
));

581 ià(
Ën
 > 125) {

582 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, (
mask
<<7) | 126);

583 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
Ën
));

586 
”r
 |ğ
	`mbuf_wr™e_u8
(
mb
, (
mask
<<7è| 
Ën
);

589 ià(
mask
) {

590 
ušt8_t
 
mkey
[4];

591 
ušt8_t
 *
p
;

592 
size_t
 
i
;

594 
	`¿nd_by‹s
(
mkey
, (mkey));

596 
”r
 |ğ
	`mbuf_wr™e_mem
(
mb
, 
mkey
, (mkey));

598 
i
=0, 
p
=
	`mbuf_buf
(
mb
); i<
Ën
; i++)

599 
p
[
i
] =…[i] ^ 
mkey
[i%4];

602  
”r
;

603 
	}
}

606 
	$websock_v£nd
(
websock_cÚn
 *
cÚn
, 
websock_İcode
 
İcode
,

607 
websock_scode
 
scode
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

609 cÚ¡ 
size_t
 
hsz
 = 
cÚn
->
aùive
 ? 14 : 10;

610 
size_t
 
Ën
, 
¡¬t
;

611 
mbuf
 *
mb
;

612 
”r
 = 0;

614 ià(
cÚn
->
¡©e
 !ğ
OPEN
)

615  
ENOTCONN
;

617 
mb
 = 
	`mbuf_®loc
(2048);

618 ià(!
mb
)

619  
ENOMEM
;

621 
mb
->
pos
 = 
hsz
;

623 ià(
scode
)

624 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`htÚs
(
scode
));

625 ià(
fmt
)

626 
”r
 |ğ
	`mbuf_v´štf
(
mb
, 
fmt
, 
­
);

627 ià(
”r
)

628 
out
;

630 
Ën
 = 
mb
->
pos
 - 
hsz
;

632 ià(
Ën
 > 0xffff)

633 
¡¬t
 = 
mb
->
pos
 = 0;

634 ià(
Ën
 > 125)

635 
¡¬t
 = 
mb
->
pos
 = 6;

637 
¡¬t
 = 
mb
->
pos
 = 8;

639 
”r
 = 
	`websock_’code
(
mb
, 
Œue
, 
İcode
, 
cÚn
->
aùive
, 
Ën
);

640 ià(
”r
)

641 
out
;

643 
mb
->
pos
 = 
¡¬t
;

645 
”r
 = 
	`tı_£nd
(
cÚn
->
tc
, 
mb
);

646 ià(
”r
)

647 
out
;

649 
out
:

650 
	`mem_d”ef
(
mb
);

652  
”r
;

653 
	}
}

656 
	$websock_£nd
(
websock_cÚn
 *
cÚn
, 
websock_İcode
 
İcode
,

657 cÚ¡ *
fmt
, ...)

659 
va_li¡
 
­
;

660 
”r
;

662 ià(!
cÚn
)

663  
EINVAL
;

665 
	`va_¡¬t
(
­
, 
fmt
);

666 
”r
 = 
	`websock_v£nd
(
cÚn
, 
İcode
, 0, 
fmt
, 
­
);

667 
	`va_’d
(
­
);

669  
”r
;

670 
	}
}

673 
	$websock_şo£
(
websock_cÚn
 *
cÚn
, 
websock_scode
 
scode
,

674 cÚ¡ *
fmt
, ...)

676 
va_li¡
 
­
;

677 
”r
;

679 ià(!
cÚn
)

680  
EINVAL
;

682 ià(!
scode
)

683 
fmt
 = 
NULL
;

685 
	`va_¡¬t
(
­
, 
fmt
);

686 
”r
 = 
	`websock_v£nd
(
cÚn
, 
WEBSOCK_CLOSE
, 
scode
, 
fmt
, 
­
);

687 
	`va_’d
(
­
);

689 ià(!
”r
)

690 
cÚn
->
¡©e
 = 
CLOSING
;

692  
”r
;

693 
	}
}

696 cÚ¡ 
§
 *
	$websock_³”
(cÚ¡ 
websock_cÚn
 *
cÚn
)

698  
cÚn
 ? &cÚn->
³”
 : 
NULL
;

699 
	}
}

702 
	$websock_®loc
(
websock
 **
sockp
, 
websock_shutdown_h
 *
shuth
, *
¬g
)

704 
websock
 *
sock
;

706 ià(!
sockp
)

707  
EINVAL
;

709 
sock
 = 
	`mem_z®loc
((*sock), 
sock_de¡ruùÜ
);

710 ià(!
sock
)

711  
ENOMEM
;

713 
sock
->
shuth
 = shuth;

714 
sock
->
¬g
 =‡rg;

716 *
sockp
 = 
sock
;

719 
	}
}

722 
	$websock_shutdown
(
websock
 *
sock
)

724 ià(!
sock
 || sock->
shutdown
)

727 
sock
->
shutdown
 = 
Œue
;

728 
	`mem_d”ef
(
sock
);

729 
	}
}

	@rem-0.5.2/include/rem.h

7 #iâdeà
REM_H__


8 
	#REM_H__


	)

10 #ifdeà
__ılu¥lus


15 
	~"»m_audio.h
"

16 
	~"»m_video.h
"

17 
	~"»m_d¥.h
"

20 #ifdeà
__ılu¥lus


	@rem-0.5.2/include/rem_au.h

9 
	eaufmt
 {

10 
	mAUFMT_S16LE
,

11 
	mAUFMT_PCMA
,

12 
	mAUFMT_PCMU
,

13 
	mAUFMT_FLOAT
,

14 
	mAUFMT_S24_3LE
,

17 
size_t
 
aufmt_§m¶e_size
(
aufmt
 
fmt
);

18 cÚ¡ *
aufmt_Çme
(
aufmt
 
fmt
);

	@rem-0.5.2/include/rem_aubuf.h

7 
	gaubuf
;

9 
aubuf_®loc
(
aubuf
 **
abp
, 
size_t
 
mš_sz
, size_ˆ
max_sz
);

10 
aubuf_­³nd
(
aubuf
 *
ab
, 
mbuf
 *
mb
);

11 
aubuf_wr™e
(
aubuf
 *
ab
, cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
sz
);

12 
aubuf_»ad
(
aubuf
 *
ab
, 
ušt8_t
 *
p
, 
size_t
 
sz
);

13 
aubuf_g‘
(
aubuf
 *
ab
, 
ušt32_t
 
±ime
, 
ušt8_t
 *
p
, 
size_t
 
sz
);

14 
aubuf_æush
(
aubuf
 *
ab
);

15 
aubuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
aubuf
 *
ab
);

16 
size_t
 
aubuf_cur_size
(cÚ¡ 
aubuf
 *
ab
);

19 
šlše
 
	$aubuf_wr™e_§mp
(
aubuf
 *
ab
, cÚ¡ 
št16_t
 *
§mpv
,

20 
size_t
 
§mpc
)

22  
	`aubuf_wr™e
(
ab
, (cÚ¡ 
ušt8_t
 *)
§mpv
, 
§mpc
 * 2);

23 
	}
}

26 
šlše
 
	$aubuf_»ad_§mp
(
aubuf
 *
ab
, 
št16_t
 *
§mpv
,

27 
size_t
 
§mpc
)

29 
	`aubuf_»ad
(
ab
, (
ušt8_t
 *)
§mpv
, 
§mpc
 * 2);

30 
	}
}

33 
šlše
 
	$aubuf_g‘_§mp
(
aubuf
 *
ab
, 
ušt32_t
 
±ime
,

34 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

36  
	`aubuf_g‘
(
ab
, 
±ime
, (
ušt8_t
 *)
§mpv
, 
§mpc
 * 2);

37 
	}
}

	@rem-0.5.2/include/rem_auconv.h

8 
aucÚv_äom_s16
(
aufmt
 
d¡_fmt
, *
d¡_§mpv
,

9 cÚ¡ 
št16_t
 *
¤c_§mpv
, 
size_t
 
§mpc
);

10 
aucÚv_to_s16
(
št16_t
 *
d¡_§mpv
, 
aufmt
 
¤c_fmt
,

11 *
¤c_§mpv
, 
size_t
 
§mpc
);

	@rem-0.5.2/include/rem_audio.h

8 
	~"»m_au.h
"

9 
	~"»m_aubuf.h
"

10 
	~"»m_aucÚv.h
"

11 
	~"»m_aufe.h
"

12 
	~"»m_autÚe.h
"

13 
	~"»m_aumix.h
"

14 
	~"»m_dtmf.h
"

15 
	~"»m_fœ.h
"

16 
	~"»m_gÛ¹z–.h
"

17 
	~"»m_au»§mp.h
"

18 
	~"»m_g711.h
"

	@rem-0.5.2/include/rem_aufile.h

9 
	eaufe_mode
 {

10 
	mAUFILE_READ
,

11 
	mAUFILE_WRITE
,

15 
	saufe_´m
 {

16 
ušt32_t
 
	m¤©e
;

17 
ušt8_t
 
	mchªÃls
;

18 
aufmt
 
	mfmt
;

21 
	gaufe
;

23 
aufe_İ’
(
aufe
 **
aå
, 
aufe_´m
 *
´m
,

24 cÚ¡ *
f’ame
, 
aufe_mode
 
mode
);

25 
aufe_»ad
(
aufe
 *
af
, 
ušt8_t
 *
p
, 
size_t
 *
sz
);

26 
aufe_wr™e
(
aufe
 *
af
, cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
sz
);

	@rem-0.5.2/include/rem_aumix.h

7 
	gaumix
;

8 
	gaumix_sourû
;

17 (
	taumix_äame_h
)(cÚ¡ 
	tšt16_t
 *
	t§mpv
, 
	tsize_t
 
	t§mpc
, *
	t¬g
);

19 
	`aumix_®loc
(
aumix
 **
mixp
, 
ušt32_t
 
¤©e
,

20 
ušt8_t
 
ch
, 
ušt32_t
 
±ime
);

21 
	`aumix_¶ayfe
(
aumix
 *
mix
, cÚ¡ *
f•©h
);

22 
ušt32_t
 
	`aumix_sourû_couÁ
(cÚ¡ 
aumix
 *
mix
);

23 
	`aumix_sourû_®loc
(
aumix_sourû
 **
¤ı
, 
aumix
 *
mix
,

24 
aumix_äame_h
 *
fh
, *
¬g
);

25 
	`aumix_sourû_’abË
(
aumix_sourû
 *
¤c
, 
boŞ
 
’abË
);

26 
	`aumix_sourû_put
(
aumix_sourû
 *
¤c
, cÚ¡ 
št16_t
 *
§mpv
,

27 
size_t
 
§mpc
);

28 
	`aumix_sourû_æush
(
aumix_sourû
 *
¤c
);

	@rem-0.5.2/include/rem_auresamp.h

15 (
	tau»§mp_h
)(
	tšt16_t
 *
	toutv
, cÚ¡ iÁ16_ˆ*
	tšv
,

16 
	tsize_t
 
	tšc
, 
	t¿tio
);

19 
	sau»§mp
 {

20 
fœ
 fir;

21 
au»§mp_h
 *
»§m¶e
;

22 cÚ¡ 
št16_t
 *
pv
;

23 
size_t
 
pc
;

24 
ušt32_t
 
Ü©e
, 
œ©e
;

25 
och
, 
ich
;

26 
¿tio
;

27 
boŞ
 
up
;

30 
	`au»§mp_š™
(
au»§mp
 *
rs
);

31 
	`au»§mp_£tup
(
au»§mp
 *
rs
, 
ušt32_t
 
œ©e
, 
ich
,

32 
ušt32_t
 
Ü©e
, 
och
);

33 
	`au»§mp
(
au»§mp
 *
rs
, 
št16_t
 *
outv
, 
size_t
 *
outc
,

34 cÚ¡ 
št16_t
 *
šv
, 
size_t
 
šc
);

	@rem-0.5.2/include/rem_autone.h

8 
autÚe_sše
(
mbuf
 *
mb
, 
ušt32_t
 
¤©e
,

9 
ušt32_t
 
f1
, 
l1
, ušt32_ˆ
f2
, 
l2
);

10 
autÚe_dtmf
(
mbuf
 *
mb
, 
ušt32_t
 
¤©e
, 
dig™
);

	@rem-0.5.2/include/rem_dsp.h

8 #iâdeà
UINT8_MAX


9 
	#UINT8_MAX
 (255U)

	)

12 
	#INT15_MAX
 0x3fff

	)

13 
	#INT15_MIN
 (-
INT15_MAX
 - 1)

	)

15 #iâdeà
INT16_MAX


16 
	#INT16_MAX
 0x7fff

	)

19 #iâdeà
INT16_MIN


20 
	#INT16_MIN
 (-
INT16_MAX
 - 1)

	)

27 #ià
defšed
 (
HAVE_ARMV6
è|| defšed (
HAVE_NEON
)

29 
šlše
 
ušt8_t
 
	$§tu¿‹_u8
(
št32_t
 
a
)

31 
ušt8_t
 
r
;

32 
__asm__
 
	`__vŞ©e__
 ("u§ˆ%0, #8, %1" : "ô"(
r
è: "r"(
a
));

33  
r
;

34 
	}
}

36 
šlše
 
št16_t
 
	$§tu¿‹_s15
(
št32_t
 
a
)

38 
__asm__
 
	`__vŞ©e__
 ("ssat %0, #15, %1 \n\t"

39 : "+r"(
a
)

40 : "r"(
a
)

43  
a
;

44 
	}
}

46 
šlše
 
št16_t
 
	$§tu¿‹_s16
(
št32_t
 
a
)

48 
__asm__
 
	`__vŞ©e__
 ("ssat %0, #16, %1 \n\t"

49 : "+r"(
a
)

50 : "r"(
a
)

53  
a
;

54 
	}
}

56 
šlše
 
št16_t
 
	$§tu¿‹_add16
(
št32_t
 
a
, iÁ32_ˆ
b
)

58 
__asm__
 
	`__vŞ©e__
 ("add %0, %1, %2 \n\t"

60 :"+r"(
a
)

61 :"r"(
a
), "r"(
b
)

63  
a
;

64 
	}
}

66 
šlše
 
št16_t
 
	$§tu¿‹_sub16
(
št32_t
 
a
, iÁ32_ˆ
b
)

68 
__asm__
 
	`__vŞ©e__
 ("sub %0, %1, %2 \n\t"

70 :"+r"(
a
)

71 :"r"(
a
), "r"(
b
)

73  
a
;

74 
	}
}

80 
šlše
 
ušt8_t
 
	$§tu¿‹_u8
(
št32_t
 
a
)

82  (
a
 > (
št32_t
)
UINT8_MAX
) ? UINT8_MAX : ((a < 0) ? 0 :‡);

83 
	}
}

85 
šlše
 
št16_t
 
	$§tu¿‹_s15
(
št32_t
 
a
)

87 ià(
a
 > 
INT15_MAX
)

88  
INT15_MAX
;

89 ià(
a
 < 
INT15_MIN
)

90  
INT15_MIN
;

92  
a
;

93 
	}
}

95 
šlše
 
št16_t
 
	$§tu¿‹_s16
(
št32_t
 
a
)

97 ià(
a
 > 
INT16_MAX
)

98  
INT16_MAX
;

99 ià(
a
 < 
INT16_MIN
)

100  
INT16_MIN
;

102  
a
;

103 
	}
}

105 
šlše
 
št16_t
 
	$§tu¿‹_add16
(
št32_t
 
a
, iÁ32_ˆ
b
)

107  
	`§tu¿‹_s16
(
a
 + 
b
);

108 
	}
}

111 
šlše
 
št16_t
 
	$§tu¿‹_sub16
(
št32_t
 
a
, iÁ32_ˆ
b
)

113  
	`§tu¿‹_s16
(
a
 - 
b
);

114 
	}
}

120 #ifdeà
HAVE_NEON


121 
šlše
 
	$ABS32
(
a
)

123 
r
;

124 
__asm__
 
	`__vŞ©e__
 ("vmov.s32 d0[0], %1 \t\n"

127 : "ô"(
r
)

128 : "r"(
a
)

130  
a
;

131 
	}
}

133 
šlše
 
	$ABS32
(
a
)

135  
a
 > 0 ?‡ : -a;

136 
	}
}

	@rem-0.5.2/include/rem_dtmf.h

7 
	gdtmf_dec
;

15 (
	tdtmf_dec_h
)(
	tdig™
, *
	t¬g
);

18 
	`dtmf_dec_®loc
(
dtmf_dec
 **
deı
, 
¤©e
, 
ch
,

19 
dtmf_dec_h
 *
dech
, *
¬g
);

20 
	`dtmf_dec_»£t
(
dtmf_dec
 *
dec
, 
¤©e
, 
ch
);

21 
	`dtmf_dec_´obe
(
dtmf_dec
 *
dec
, cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
);

	@rem-0.5.2/include/rem_fir.h

8 
	sfœ
 {

9 
št16_t
 
	mhi¡Üy
[256];

10 
	mšdex
;

13 
fœ_»£t
(
fœ
 *fir);

14 
fœ_f‹r
(
fœ
 *fœ, 
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
, 
size_t
 
šc
,

15 
ch
, cÚ¡ 
št16_t
 *
pv
, 
size_t
 
pc
);

	@rem-0.5.2/include/rem_g711.h

8 cÚ¡ 
ušt8_t
 
g711_l2u
[4096];

9 cÚ¡ 
ušt8_t
 
g711_l2A
[2048];

10 cÚ¡ 
št16_t
 
g711_u2l
[256];

11 cÚ¡ 
št16_t
 
g711_A2l
[256];

21 
šlše
 
ušt8_t
 
	$g711_pcm2uÏw
(
št16_t
 
l
)

23 cÚ¡ 
ušt8_t
 
mask
 = (
l
 < 0) ? 0x7f : 0xff;

24 ià(
l
 < 0)

25 
l
 = -l;

26 ià(
l
 < 4)

27  0xfà& 
mask
;

28 
l
 -= 4;

29 
l
 >>= 3;

31  
g711_l2u
[
l
] & 
mask
;

32 
	}
}

42 
šlše
 
ušt8_t
 
	$g711_pcm2®aw
(
št16_t
 
l
)

44 cÚ¡ 
ušt8_t
 
mask
 = (
l
 < 0) ? 0x7f : 0xff;

45 ià(
l
 < 0)

46 
l
 = -l;

47 
l
 >>= 4;

49  
g711_l2A
[
l
] & 
mask
;

50 
	}
}

60 
šlše
 
št16_t
 
	$g711_uÏw2pcm
(
ušt8_t
 
u
)

62  
g711_u2l
[
u
];

63 
	}
}

73 
šlše
 
št16_t
 
	$g711_®aw2pcm
(
ušt8_t
 
a
)

75  
g711_A2l
[
a
];

76 
	}
}

	@rem-0.5.2/include/rem_goertzel.h

8 
	sgÛ¹z–
 {

9 
	mq1
;

10 
	mq2
;

11 
	mcÛf
;

15 
gÛ¹z–_š™
(
gÛ¹z–
 *
g
, 
äeq
, 
¤©e
);

16 
gÛ¹z–_»£t
(
gÛ¹z–
 *
g
);

17 
gÛ¹z–_»suÉ
(
gÛ¹z–
 *
g
);

26 
šlše
 
	$gÛ¹z–_upd©e
(
gÛ¹z–
 *
g
, 
št16_t
 
§mp
)

28 
q0
 = 
g
->
cÛf
*g->
q1
 - g->
q2
 + ()
§mp
;

30 
g
->
q2
 = g->
q1
;

31 
g
->
q1
 = 
q0
;

32 
	}
}

	@rem-0.5.2/include/rem_vid.h

9 
	evidfmt
 {

10 
	mVID_FMT_YUV420P
 = 0,

11 
	mVID_FMT_YUYV422
,

12 
	mVID_FMT_UYVY422
,

13 
	mVID_FMT_RGB32
,

14 
	mVID_FMT_ARGB
,

15 
	mVID_FMT_RGB565
,

16 
	mVID_FMT_RGB555
,

17 
	mVID_FMT_NV12
,

18 
	mVID_FMT_NV21
,

19 
	mVID_FMT_YUV444P
,

21 
	mVID_FMT_N


25 
	svidfmt_compdesc
 {

26 
	m¶ªe_šdex
:2;

27 
	m¡•
:3;

31 
	svidfmt_desc
 {

32 cÚ¡ *
	mÇme
;

33 
ušt8_t
 
	m¶ªes
;

34 
ušt8_t
 
	mcom²
;

35 
vidfmt_compdesc
 
	mcompv
[4];

39 
	evidÜ›Á
 {

40 
	mVIDORIENT_PORTRAIT
,

41 
	mVIDORIENT_PORTRAIT_UPSIDEDOWN
,

42 
	mVIDORIENT_LANDSCAPE_LEFT
,

43 
	mVIDORIENT_LANDSCAPE_RIGHT
,

47 
	svidsz
 {

48 
	mw
;

49 
	mh
;

53 
	svidäame
 {

54 
ušt8_t
 *
	md©a
[4];

55 
ušt16_t
 
	mlšesize
[4];

56 
vidsz
 
	msize
;

57 
vidfmt
 
	mfmt
;

61 
	svid±
 {

62 
	mx
;

63 
	my
;

67 
	svid»ù
 {

68 
	mx
;

69 
	my
;

70 
	mw
;

71 
	mh
;

74 
šlše
 
boŞ
 
	$vidsz_cmp
(cÚ¡ 
vidsz
 *
a
, cÚ¡ vidsz *
b
)

76 ià(!
a
 || !
b
)

77  
çl£
;

79 ià(
a
 =ğ
b
)

80  
Œue
;

82  
a
->
w
 =ğ
b
->w &&‡->
h
 == b->h;

83 
	}
}

86 
šlše
 
boŞ
 
	$vid»ù_cmp
(cÚ¡ 
vid»ù
 *
a
,

87 cÚ¡ 
vid»ù
 *
b
)

89 ià(!
a
 || !
b
)

90  
çl£
;

92 ià(
a
 =ğ
b
)

93  
Œue
;

95  
a
->
x
 =ğ
b
->x &&‡->
y
 =ğb->y &&‡->
w
 =ğb->w &&‡->
h
 == b->h;

96 
	}
}

99 
šlše
 
	$rgb2y
(
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

101  ((66 * 
r
 + 129 * 
g
 + 25 * 
b
 + 128) >> 8) + 16;

102 
	}
}

105 
šlše
 
	$rgb2u
(
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

107  ((-38 * 
r
 - 74 * 
g
 + 112 * 
b
 + 128) >> 8) + 128;

108 
	}
}

111 
šlše
 
	$rgb2v
(
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

113  ((112 * 
r
 - 94 * 
g
 - 18 * 
b
 + 128) >> 8) + 128;

114 
	}
}

117 
size_t
 
vidäame_size
(
vidfmt
 
fmt
, cÚ¡ 
vidsz
 *
sz
);

118 
vidäame_š™
(
vidäame
 *
vf
, 
vidfmt
 
fmt
,

119 cÚ¡ 
vidsz
 *
sz
, *
d©a
[4],

120 
lšesize
[4]);

121 
vidäame_š™_buf
(
vidäame
 *
vf
, 
vidfmt
 
fmt
,

122 cÚ¡ 
vidsz
 *
sz
, 
ušt8_t
 *
buf
);

123 
vidäame_®loc
(
vidäame
 **
vå
, 
vidfmt
 
fmt
,

124 cÚ¡ 
vidsz
 *
sz
);

125 
vidäame_fl
(
vidäame
 *
vf
, 
ušt32_t
 
r
, ušt32_ˆ
g
, ušt32_ˆ
b
);

126 
vidäame_cİy
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
);

129 cÚ¡ *
vidfmt_Çme
(
vidfmt
 
fmt
);

132 
šlše
 
boŞ
 
	$vidäame_isv®id
(cÚ¡ 
vidäame
 *
f
)

134  
f
 ? f->
d©a
[0] !ğ
NULL
 : 
çl£
;

135 
	}
}

138 cÚ¡ 
vidfmt_desc
 
vidfmt_descv
[
VID_FMT_N
];

142 
vidäame_d¿w_pošt
(
vidäame
 *
f
, 
x
, 
y
,

143 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
);

144 
vidäame_d¿w_hlše
(
vidäame
 *
f
,

145 
x0
, 
y0
, 
w
,

146 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
);

147 
vidäame_d¿w_vlše
(
vidäame
 *
f
,

148 
x0
, 
y0
, 
h
,

149 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
);

150 
vidäame_d¿w_»ù
(
vidäame
 *
f
,

151 
x0
, 
y0
, 
w
, 
h
,

152 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
);

	@rem-0.5.2/include/rem_vidconv.h

8 
vidcÚv
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
,

9 
vid»ù
 *
r
);

10 
vidcÚv_a¥eù
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
,

11 
vid»ù
 *
r
);

	@rem-0.5.2/include/rem_video.h

8 
	~"»m_vid.h
"

9 
	~"»m_vidmix.h
"

10 
	~"»m_vidcÚv.h
"

	@rem-0.5.2/include/rem_vidmix.h

8 
	gvidmix
;

9 
	gvidmix_sourû
;

18 (
	tvidmix_äame_h
)(
	tušt32_t
 
	tts
, cÚ¡ 
	tvidäame
 *
	täame
,

19 *
	t¬g
);

21 
	`vidmix_®loc
(
vidmix
 **
mixp
);

22 
	`vidmix_sourû_®loc
(
vidmix_sourû
 **
¤ı
, 
vidmix
 *
mix
,

23 cÚ¡ 
vidsz
 *
sz
, 
ås
, 
boŞ
 
cÚ‹Á
,

24 
vidmix_äame_h
 *
fh
, *
¬g
);

25 
boŞ
 
	`vidmix_sourû_i£ÇbËd
(cÚ¡ 
vidmix_sourû
 *
¤c
);

26 
boŞ
 
	`vidmix_sourû_i¤uÂšg
(cÚ¡ 
vidmix_sourû
 *
¤c
);

27 *
	`vidmix_sourû_g‘_focus
(cÚ¡ 
vidmix_sourû
 *
¤c
);

28 
	`vidmix_sourû_’abË
(
vidmix_sourû
 *
¤c
, 
boŞ
 
’abË
);

29 
	`vidmix_sourû_¡¬t
(
vidmix_sourû
 *
¤c
);

30 
	`vidmix_sourû_¡İ
(
vidmix_sourû
 *
¤c
);

31 
	`vidmix_sourû_£t_size
(
vidmix_sourû
 *
¤c
, cÚ¡ 
vidsz
 *
sz
);

32 
	`vidmix_sourû_£t_¿‹
(
vidmix_sourû
 *
¤c
, 
ås
);

33 
	`vidmix_sourû_£t_cÚ‹Á_hide
(
vidmix_sourû
 *
¤c
, 
boŞ
 
hide
);

34 
	`vidmix_sourû_toggË_£lfv›w
(
vidmix_sourû
 *
¤c
);

35 
	`vidmix_sourû_£t_focus
(
vidmix_sourû
 *
¤c
,

36 cÚ¡ 
vidmix_sourû
 *
focus_¤c
,

37 
boŞ
 
focus_fuÎ
);

38 
	`vidmix_sourû_£t_focus_idx
(
vidmix_sourû
 *
¤c
, 
pidx
);

39 
	`vidmix_sourû_put
(
vidmix_sourû
 *
¤c
,

40 cÚ¡ 
vidäame
 *
äame
);

	@rem-0.5.2/src/au/fmt.c

6 
	~<».h
>

7 
	~<»m_au.h
>

11 
size_t
 
	$aufmt_§m¶e_size
(
aufmt
 
fmt
)

13 
fmt
) {

15 
AUFMT_S16LE
:  (
št16_t
);

16 
AUFMT_PCMA
:  1;

17 
AUFMT_PCMU
:  1;

18 
AUFMT_FLOAT
:  ();

19 
AUFMT_S24_3LE
:  3;

22 
	}
}

25 cÚ¡ *
	$aufmt_Çme
(
aufmt
 
fmt
)

27 
fmt
) {

29 
AUFMT_S16LE
:  "S16LE";

30 
AUFMT_PCMA
:  "PCMA";

31 
AUFMT_PCMU
:  "PCMU";

32 
AUFMT_FLOAT
:  "FLOAT";

33 
AUFMT_S24_3LE
:  "S24_3LE";

36 
	}
}

	@rem-0.5.2/src/aubuf/aubuf.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m_aubuf.h
>

11 
	#AUBUF_DEBUG
 0

	)

15 
	saubuf
 {

16 
li¡
 
	maæ
;

17 
lock
 *
	mlock
;

18 
size_t
 
	mwish_sz
;

19 
size_t
 
	mcur_sz
;

20 
size_t
 
	mmax_sz
;

21 
boŞ
 
	mflšg
;

22 
ušt64_t
 
	mts
;

24 #ià
AUBUF_DEBUG


26 
size_t
 
	mÜ
;

27 
size_t
 
	mur
;

28 } 
	m¡©s
;

33 
	sauäame
 {

34 
Ë
 
	mË
;

35 
mbuf
 *
	mmb
;

39 
	$auäame_de¡ruùÜ
(*
¬g
)

41 
auäame
 *
af
 = 
¬g
;

43 
	`li¡_uÆšk
(&
af
->
Ë
);

44 
	`mem_d”ef
(
af
->
mb
);

45 
	}
}

48 
	$aubuf_de¡ruùÜ
(*
¬g
)

50 
aubuf
 *
ab
 = 
¬g
;

52 
	`li¡_æush
(&
ab
->
aæ
);

53 
	`mem_d”ef
(
ab
->
lock
);

54 
	}
}

66 
	$aubuf_®loc
(
aubuf
 **
abp
, 
size_t
 
mš_sz
, size_ˆ
max_sz
)

68 
aubuf
 *
ab
;

69 
”r
;

71 ià(!
abp
 || !
mš_sz
)

72  
EINVAL
;

74 
ab
 = 
	`mem_z®loc
((*ab), 
aubuf_de¡ruùÜ
);

75 ià(!
ab
)

76  
ENOMEM
;

78 
”r
 = 
	`lock_®loc
(&
ab
->
lock
);

79 ià(
”r
)

80 
out
;

82 
ab
->
wish_sz
 = 
mš_sz
;

83 
ab
->
max_sz
 = max_sz;

84 
ab
->
flšg
 = 
Œue
;

86 
out
:

87 ià(
”r
)

88 
	`mem_d”ef
(
ab
);

90 *
abp
 = 
ab
;

92  
”r
;

93 
	}
}

104 
	$aubuf_­³nd
(
aubuf
 *
ab
, 
mbuf
 *
mb
)

106 
auäame
 *
af
;

108 ià(!
ab
 || !
mb
)

109  
EINVAL
;

111 
af
 = 
	`mem_z®loc
((*af), 
auäame_de¡ruùÜ
);

112 ià(!
af
)

113  
ENOMEM
;

115 
af
->
mb
 = 
	`mem_»f
(mb);

117 
	`lock_wr™e_g‘
(
ab
->
lock
);

119 
	`li¡_­³nd
(&
ab
->
aæ
, &
af
->
Ë
,‡f);

120 
ab
->
cur_sz
 +ğ
	`mbuf_g‘_Ëá
(
mb
);

122 ià(
ab
->
max_sz
 &&‡b->
cur_sz
 >‡b->max_sz) {

123 #ià
AUBUF_DEBUG


124 ++
ab
->
¡©s
.
Ü
;

125 ()
	`»_´štf
("aubuf: %p overrun (cur=%zu)\n",

126 
ab
,‡b->
cur_sz
);

128 
af
 = 
	`li¡_Ëd©a
(
ab
->
aæ
.
h—d
);

129 ià(
af
) {

130 
ab
->
cur_sz
 -ğ
	`mbuf_g‘_Ëá
(
af
->
mb
);

131 
	`mem_d”ef
(
af
);

135 
	`lock_»l
(
ab
->
lock
);

138 
	}
}

150 
	$aubuf_wr™e
(
aubuf
 *
ab
, cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
sz
)

152 
mbuf
 *
mb
 = 
	`mbuf_®loc
(
sz
);

153 
”r
;

155 ià(!
mb
)

156  
ENOMEM
;

158 ()
	`mbuf_wr™e_mem
(
mb
, 
p
, 
sz
);

159 
mb
->
pos
 = 0;

161 
”r
 = 
	`aubuf_­³nd
(
ab
, 
mb
);

163 
	`mem_d”ef
(
mb
);

165  
”r
;

166 
	}
}

177 
	$aubuf_»ad
(
aubuf
 *
ab
, 
ušt8_t
 *
p
, 
size_t
 
sz
)

179 
Ë
 *le;

181 ià(!
ab
 || !
p
 || !
sz
)

184 
	`lock_wr™e_g‘
(
ab
->
lock
);

186 ià(
ab
->
cur_sz
 < (ab->
flšg
 ?‡b->
wish_sz
 : 
sz
)) {

187 #ià
AUBUF_DEBUG


188 ià(!
ab
->
flšg
) {

189 ++
ab
->
¡©s
.
ur
;

190 ()
	`»_´štf
("aubuf: %p underrun (cur=%zu)\n",

191 
ab
,‡b->
cur_sz
);

194 
ab
->
flšg
 = 
Œue
;

195 
	`mem£t
(
p
, 0, 
sz
);

196 
out
;

199 
ab
->
flšg
 = 
çl£
;

201 
Ë
 = 
ab
->
aæ
.
h—d
;

203 
Ë
) {

204 
auäame
 *
af
 = 
Ë
->
d©a
;

205 
size_t
 
n
;

207 
Ë
 =†e->
Ãxt
;

209 
n
 = 
	`mš
(
	`mbuf_g‘_Ëá
(
af
->
mb
), 
sz
);

211 ()
	`mbuf_»ad_mem
(
af
->
mb
, 
p
, 
n
);

212 
ab
->
cur_sz
 -ğ
n
;

214 ià(!
	`mbuf_g‘_Ëá
(
af
->
mb
))

215 
	`mem_d”ef
(
af
);

217 ià(
n
 =ğ
sz
)

220 
p
 +ğ
n
;

221 
sz
 -ğ
n
;

224 
out
:

225 
	`lock_»l
(
ab
->
lock
);

226 
	}
}

243 
	$aubuf_g‘
(
aubuf
 *
ab
, 
ušt32_t
 
±ime
, 
ušt8_t
 *
p
, 
size_t
 
sz
)

245 
ušt64_t
 
now
;

246 
”r
 = 0;

248 ià(!
ab
 || !
±ime
)

249  
EINVAL
;

251 
	`lock_wr™e_g‘
(
ab
->
lock
);

253 
now
 = 
	`tmr_jiff›s
();

254 ià(!
ab
->
ts
)

255 
ab
->
ts
 = 
now
;

257 ià(
now
 < 
ab
->
ts
) {

258 
”r
 = 
ETIMEDOUT
;

259 
out
;

262 
ab
->
ts
 +ğ
±ime
;

264 
out
:

265 
	`lock_»l
(
ab
->
lock
);

267 ià(!
”r
)

268 
	`aubuf_»ad
(
ab
, 
p
, 
sz
);

270  
”r
;

271 
	}
}

279 
	$aubuf_æush
(
aubuf
 *
ab
)

281 ià(!
ab
)

284 
	`lock_wr™e_g‘
(
ab
->
lock
);

286 
	`li¡_æush
(&
ab
->
aæ
);

287 
ab
->
flšg
 = 
Œue
;

288 
ab
->
cur_sz
 = 0;

289 
ab
->
ts
 = 0;

291 
	`lock_»l
(
ab
->
lock
);

292 
	}
}

303 
	$aubuf_debug
(
»_´štf
 *
pf
, cÚ¡ 
aubuf
 *
ab
)

305 
”r
;

307 ià(!
ab
)

310 
	`lock_»ad_g‘
(
ab
->
lock
);

311 
”r
 = 
	`»_h´štf
(
pf
, "wish_sz=%zu cur_sz=%zu filling=%d",

312 
ab
->
wish_sz
,‡b->
cur_sz
,‡b->
flšg
);

314 #ià
AUBUF_DEBUG


315 
”r
 |ğ
	`»_h´štf
(
pf
, " [overrun=%zu underrun=%zu]",

316 
ab
->
¡©s
.
Ü
,‡b->¡©s.
ur
);

319 
	`lock_»l
(
ab
->
lock
);

321  
”r
;

322 
	}
}

332 
size_t
 
	$aubuf_cur_size
(cÚ¡ 
aubuf
 *
ab
)

334 
size_t
 
sz
;

336 ià(!
ab
)

339 
	`lock_»ad_g‘
(
ab
->
lock
);

340 
sz
 = 
ab
->
cur_sz
;

341 
	`lock_»l
(
ab
->
lock
);

343  
sz
;

344 
	}
}

	@rem-0.5.2/src/auconv/auconv.c

6 
	~<m©h.h
>

7 
	~<».h
>

8 
	~<»m_au.h
>

9 
	~<»m_aucÚv.h
>

12 
šlše
 
	$au§mp_shÜt2æßt
(
št16_t
 
š
)

14 
out
;

16 
out
 = (è(
š
 / (1.0 * 0x8000));

18  
out
;

19 
	}
}

22 
šlše
 
št16_t
 
	$au§mp_æßt2shÜt
(
š
)

24 
v®ue
;

25 
št16_t
 
out
;

27 
v®ue
 = 
š
 * (8.0 * 0x10000000);

29 ià(
v®ue
 >= (1.0 * 0x7fffffff)) {

30 
out
 = 32767;

32 ià(
v®ue
 <= (-8.0 * 0x10000000)) {

33 
out
 = -32768;

36 
out
 = (è(
	`Ìšt
 (
v®ue
) >> 16);

38  
out
;

39 
	}
}

42 
	$aucÚv_äom_s16
(
aufmt
 
d¡_fmt
, *
d¡_§mpv
,

43 cÚ¡ 
št16_t
 *
¤c_§mpv
, 
size_t
 
§mpc
)

45 *
f
;

46 
ušt8_t
 *
b
;

47 
size_t
 
i
;

49 ià(!
d¡_§mpv
 || !
¤c_§mpv
 || !
§mpc
)

52 
d¡_fmt
) {

54 
AUFMT_FLOAT
:

55 
f
 = 
d¡_§mpv
;

56 
i
=0; i<
§mpc
; i++) {

57 
f
[
i
] = 
	`au§mp_shÜt2æßt
(
¤c_§mpv
[i]);

61 
AUFMT_S24_3LE
:

62 
b
 = 
d¡_§mpv
;

63 
i
=0; i<
§mpc
; i++) {

64 
št16_t
 
s
 = 
¤c_§mpv
[
i
];

65 
b
[3*
i
+2] = 
s
 >> 8;

66 
b
[3*
i
+1] = 
s
 & 0xff;

67 
b
[3*
i
+0] = 0;

72 ()
	`»_årštf
(
¡d”r
, "auconv: sample format %d (%s)"

74 
d¡_fmt
, 
	`aufmt_Çme
(dst_fmt));

77 
	}
}

80 
	$aucÚv_to_s16
(
št16_t
 *
d¡_§mpv
, 
aufmt
 
¤c_fmt
,

81 *
¤c_§mpv
, 
size_t
 
§mpc
)

83 *
f
;

84 
ušt8_t
 *
b
;

85 
size_t
 
i
;

87 ià(!
d¡_§mpv
 || !
¤c_§mpv
 || !
§mpc
)

90 
¤c_fmt
) {

92 
AUFMT_FLOAT
:

93 
f
 = 
¤c_§mpv
;

94 
i
=0; i<
§mpc
; i++) {

95 
d¡_§mpv
[
i
] = 
	`au§mp_æßt2shÜt
(
f
[i]);

99 
AUFMT_S24_3LE
:

100 
b
 = 
¤c_§mpv
;

101 
i
=0; i<
§mpc
; i++) {

102 
št16_t
 
s
;

103 
s
 = 
b
[3*
i
+1] | b[3*i+2] << 8;

104 
d¡_§mpv
[
i
] = 
s
;

109 ()
	`»_årštf
(
¡d”r
, "auconv: sample format %d (%s)"

111 
¤c_fmt
, 
	`aufmt_Çme
(src_fmt));

114 
	}
}

	@rem-0.5.2/src/aufile/aufile.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m_au.h
>

9 
	~<»m_aufe.h
>

10 
	~"aufe.h
"

14 
	saufe
 {

15 
aufe_´m
 
	m´m
;

16 
aufe_mode
 
	mmode
;

17 
size_t
 
	md©asize
;

18 
size_t
 
	mÄ—d
;

19 
size_t
 
	mnwr™‹n
;

20 
FILE
 *
	mf
;

24 
	$wavfmt_to_aufmt
(
wavfmt
 
fmt
, 
ušt16_t
 
bps
)

26 
fmt
) {

28 
WAVE_FMT_PCM
:

29 ià(
bps
 != 16)

32  
AUFMT_S16LE
;

34 
WAVE_FMT_ALAW
:

35 ià(
bps
 != 8)

38  
AUFMT_PCMA
;

40 
WAVE_FMT_ULAW
:

41 ià(
bps
 != 8)

44  
AUFMT_PCMU
;

49 
	}
}

52 
wavfmt
 
	$aufmt_to_wavfmt
(
aufmt
 
fmt
)

54 
fmt
) {

56 
AUFMT_S16LE
:  
WAVE_FMT_PCM
;

57 
AUFMT_PCMA
:  
WAVE_FMT_ALAW
;

58 
AUFMT_PCMU
:  
WAVE_FMT_ULAW
;

61 
	}
}

64 
ušt16_t
 
	$aufmt_to_bps
(
aufmt
 
fmt
)

66 
fmt
) {

68 
AUFMT_S16LE
:  16;

69 
AUFMT_PCMA
:  8;

70 
AUFMT_PCMU
:  8;

73 
	}
}

76 
	$de¡ruùÜ
(*
¬g
)

78 
aufe
 *
af
 = 
¬g
;

80 ià(!
af
->
f
)

84 ià(
af
->
mode
 =ğ
AUFILE_WRITE
 &&‡f->
nwr™‹n
 > 0) {

86 
	`»wšd
(
af
->
f
);

88 ()
	`wav_h—d”_’code
(
af
->
f
, 
	`aufmt_to_wavfmt
×f->
´m
.
fmt
),

89 
af
->
´m
.
chªÃls
,‡f->´m.
¤©e
,

90 
	`aufmt_to_bps
(
af
->
´m
.
fmt
),

91 
af
->
nwr™‹n
);

94 ()
	`fşo£
(
af
->
f
);

95 
	}
}

110 
	$aufe_İ’
(
aufe
 **
aå
, 
aufe_´m
 *
´m
,

111 cÚ¡ *
f’ame
, 
aufe_mode
 
mode
)

113 
wav_fmt
 
fmt
;

114 
aufe
 *
af
;

115 
aufmt
;

116 
”r
;

118 ià(!
aå
 || !
f’ame
 || (
mode
 =ğ
AUFILE_WRITE
 && !
´m
))

119  
EINVAL
;

121 
af
 = 
	`mem_z®loc
((*af), 
de¡ruùÜ
);

122 ià(!
af
)

123  
ENOMEM
;

125 
af
->
mode
 = mode;

127 
af
->
f
 = 
	`fİ’
(
f’ame
, 
mode
 =ğ
AUFILE_READ
 ? "rb" : "wb");

128 ià(!
af
->
f
) {

129 
”r
 = 
”ºo
;

130 
out
;

133 
mode
) {

135 
AUFILE_READ
:

136 
”r
 = 
	`wav_h—d”_decode
(&
fmt
, &
af
->
d©asize
,‡f->
f
);

137 ià(
”r
)

138 
out
;

140 
aufmt
 = 
	`wavfmt_to_aufmt
(
fmt
.
fÜm©
, fmt.
bps
);

141 ià(
aufmt
 < 0) {

142 
”r
 = 
ENOSYS
;

143 
out
;

146 ià(
´m
) {

147 
´m
->
¤©e
 = 
fmt
.srate;

148 
´m
->
chªÃls
 = (
ušt8_t
)
fmt
.channels;

149 
´m
->
fmt
 = 
aufmt
;

153 
AUFILE_WRITE
:

154 
af
->
´m
 = *prm;

156 
”r
 = 
	`wav_h—d”_’code
(
af
->
f
, 
	`aufmt_to_wavfmt
(
´m
->
fmt
),

157 
´m
->
chªÃls
,…rm->
¤©e
,

158 
	`aufmt_to_bps
(
´m
->
fmt
), 0);

162 
”r
 = 
ENOSYS
;

166 
out
:

167 ià(
”r
)

168 
	`mem_d”ef
(
af
);

170 *
aå
 = 
af
;

172  
”r
;

173 
	}
}

185 
	$aufe_»ad
(
aufe
 *
af
, 
ušt8_t
 *
p
, 
size_t
 *
sz
)

187 
size_t
 
n
;

189 ià(!
af
 || !
p
 || !
sz
 ||‡f->
mode
 !ğ
AUFILE_READ
)

190  
EINVAL
;

192 ià(
af
->
Ä—d
 >ğaf->
d©asize
) {

193 *
sz
 = 0;

197 
n
 = 
	`mš
(*
sz
, 
af
->
d©asize
 -‡f->
Ä—d
);

199 
n
 = 
	`ä—d
(
p
, 1,‚, 
af
->
f
);

200 ià(
	`ã¼Ü
(
af
->
f
))

201  
”ºo
;

203 *
sz
 = 
n
;

204 
af
->
Ä—d
 +ğ
n
;

207 
	}
}

219 
	$aufe_wr™e
(
aufe
 *
af
, cÚ¡ 
ušt8_t
 *
p
, 
size_t
 
sz
)

221 ià(!
af
 || !
p
 || !
sz
 ||‡f->
mode
 !ğ
AUFILE_WRITE
)

222  
EINVAL
;

224 ià(1 !ğ
	`fwr™e
(
p
, 
sz
, 1, 
af
->
f
))

225  
	`ã¼Ü
(
af
->
f
);

227 
af
->
nwr™‹n
 +ğ
sz
;

230 
	}
}

	@rem-0.5.2/src/aufile/aufile.h

8 
	ewavfmt
 {

9 
	mWAVE_FMT_PCM
 = 0x0001,

10 
	mWAVE_FMT_ALAW
 = 0x0006,

11 
	mWAVE_FMT_ULAW
 = 0x0007,

15 
	swav_fmt
 {

16 
ušt16_t
 
	mfÜm©
;

17 
ušt16_t
 
	mchªÃls
;

18 
ušt32_t
 
	m¤©e
;

19 
ušt32_t
 
	mby‹¿‹
;

20 
ušt16_t
 
	mblock_®ign
;

21 
ušt16_t
 
	mbps
;

22 
ušt16_t
 
	mexŒa
;

25 
wav_h—d”_’code
(
FILE
 *
f
, 
ušt16_t
 
fÜm©
, ušt16_ˆ
chªÃls
,

26 
ušt32_t
 
¤©e
, 
ušt16_t
 
bps
, 
size_t
 
by‹s
);

27 
wav_h—d”_decode
(
wav_fmt
 *
fmt
, 
size_t
 *
d©asize
, 
FILE
 *
f
);

	@rem-0.5.2/src/aufile/wave.c

6 
	~<¡ršg.h
>

7 
	~<».h
>

8 
	~<»m_au.h
>

9 
	~<»m_aufe.h
>

10 
	~"aufe.h
"

14 
	mWAVE_FMT_SIZE
 = 16

19 
	swav_chunk
 {

20 
ušt8_t
 
	mid
[4];

21 
ušt32_t
 
	msize
;

25 
	$wr™e_u16
(
FILE
 *
f
, 
ušt16_t
 
v
)

27 
v
 = 
	`sys_htŞs
(v);

29 ià(1 !ğ
	`fwr™e
(&
v
, (v), 1, 
f
))

30  
	`ã¼Ü
(
f
);

33 
	}
}

36 
	$wr™e_u32
(
FILE
 *
f
, 
ušt32_t
 
v
)

38 
v
 = 
	`sys_htŞl
(v);

40 ià(1 !ğ
	`fwr™e
(&
v
, (v), 1, 
f
))

41  
	`ã¼Ü
(
f
);

44 
	}
}

47 
	$»ad_u16
(
FILE
 *
f
, 
ušt16_t
 *
v
)

49 
ušt16_t
 
vË
;

51 ià(1 !ğ
	`ä—d
(&
vË
, (vË), 1, 
f
))

52  
	`ã¼Ü
(
f
);

54 *
v
 = 
	`sys_Éohs
(
vË
);

57 
	}
}

60 
	$»ad_u32
(
FILE
 *
f
, 
ušt32_t
 *
v
)

62 
ušt32_t
 
vË
;

64 ià(1 !ğ
	`ä—d
(&
vË
, (vË), 1, 
f
))

65  
	`ã¼Ü
(
f
);

67 *
v
 = 
	`sys_Éohl
(
vË
);

71 
	}
}

74 
	$chunk_’code
(
FILE
 *
f
, cÚ¡ *
id
, 
size_t
 
sz
)

76 ià(1 !ğ
	`fwr™e
(
id
, 4, 1, 
f
))

77  
	`ã¼Ü
(
f
);

79  
	`wr™e_u32
(
f
, (
ušt32_t
)
sz
);

80 
	}
}

83 
	$chunk_decode
(
wav_chunk
 *
chunk
, 
FILE
 *
f
)

85 ià(1 !ğ
	`ä—d
(
chunk
->
id
, (chunk->id), 1, 
f
))

86  
	`ã¼Ü
(
f
);

88  
	`»ad_u32
(
f
, &
chunk
->
size
);

89 
	}
}

92 
	$wav_h—d”_’code
(
FILE
 *
f
, 
ušt16_t
 
fÜm©
, ušt16_ˆ
chªÃls
,

93 
ušt32_t
 
¤©e
, 
ušt16_t
 
bps
, 
size_t
 
by‹s
)

95 
”r
;

97 
”r
 = 
	`chunk_’code
(
f
, "RIFF", 36 + 
by‹s
);

98 ià(
”r
)

99  
”r
;

101 ià(1 !ğ
	`fwr™e
("WAVE", 4, 1, 
f
))

102  
	`ã¼Ü
(
f
);

104 
”r
 = 
	`chunk_’code
(
f
, "fmˆ", 
WAVE_FMT_SIZE
);

105 ià(
”r
)

106  
”r
;

108 
”r
 = 
	`wr™e_u16
(
f
, 
fÜm©
);

109 
”r
 |ğ
	`wr™e_u16
(
f
, 
chªÃls
);

110 
”r
 |ğ
	`wr™e_u32
(
f
, 
¤©e
);

111 
”r
 |ğ
	`wr™e_u32
(
f
, 
¤©e
 * 
chªÃls
 * 
bps
 / 8);

112 
”r
 |ğ
	`wr™e_u16
(
f
, 
chªÃls
 * 
bps
 / 8);

113 
”r
 |ğ
	`wr™e_u16
(
f
, 
bps
);

114 ià(
”r
)

115  
”r
;

117  
	`chunk_’code
(
f
, "d©a", 
by‹s
);

118 
	}
}

121 
	$wav_h—d”_decode
(
wav_fmt
 *
fmt
, 
size_t
 *
d©asize
, 
FILE
 *
f
)

123 
wav_chunk
 
h—d”
, 
fÜm©
, 
chunk
;

124 
ušt8_t
 
rifáy³
[4];

125 
”r
 = 0;

127 
”r
 = 
	`chunk_decode
(&
h—d”
, 
f
);

128 ià(
”r
)

129  
”r
;

131 ià(
	`memcmp
(
h—d”
.
id
, "RIFF", 4)) {

132 ()
	`»_årštf
(
¡d”r
, "aufile:ƒxpected RIFF (%b)\n",

133 
h—d”
.
id
, (header.id));

134  
EBADMSG
;

137 ià(1 !ğ
	`ä—d
(
rifáy³
, Ôifáy³), 1, 
f
))

138  
	`ã¼Ü
(
f
);

140 ià(
	`memcmp
(
rifáy³
, "WAVE", 4)) {

141 ()
	`»_årštf
(
¡d”r
, "aufile:ƒxpected WAVE (%b)\n",

142 
rifáy³
, (rifftype));

143  
EBADMSG
;

146 
”r
 = 
	`chunk_decode
(&
fÜm©
, 
f
);

147 ià(
”r
)

148  
”r
;

150 ià(
	`memcmp
(
fÜm©
.
id
, "fmt ", 4)) {

151 ()
	`»_årštf
(
¡d”r
, "aufile:ƒxpected fmt (%b)\n",

152 
fÜm©
.
id
, (format.id));

153  
EBADMSG
;

156 ià(
fÜm©
.
size
 < 
WAVE_FMT_SIZE
)

157  
EBADMSG
;

159 
”r
 = 
	`»ad_u16
(
f
, &
fmt
->
fÜm©
);

160 
”r
 |ğ
	`»ad_u16
(
f
, &
fmt
->
chªÃls
);

161 
”r
 |ğ
	`»ad_u32
(
f
, &
fmt
->
¤©e
);

162 
”r
 |ğ
	`»ad_u32
(
f
, &
fmt
->
by‹¿‹
);

163 
”r
 |ğ
	`»ad_u16
(
f
, &
fmt
->
block_®ign
);

164 
”r
 |ğ
	`»ad_u16
(
f
, &
fmt
->
bps
);

165 ià(
”r
)

166  
”r
;

169 ià(
fÜm©
.
size
 >ğ(
WAVE_FMT_SIZE
 + 2)) {

171 
”r
 = 
	`»ad_u16
(
f
, &
fmt
->
exŒa
);

172 ià(
”r
)

173  
”r
;

175 ià(
fmt
->
exŒa
 > 0) {

176 ià(
	`f£ek
(
f
, 
fmt
->
exŒa
, 
SEEK_CUR
))

177  
”ºo
;

184 
”r
 = 
	`chunk_decode
(&
chunk
, 
f
);

185 ià(
”r
)

186  
”r
;

188 ià(
chunk
.
size
 > 
h—d”
.size) {

189 ()
	`»_årštf
(
¡d”r
, "chunk sizeoo†arge"

191 
chunk
.
size
, 
h—d”
.size);

192  
EBADMSG
;

195 ià(0 =ğ
	`memcmp
(
chunk
.
id
, "data", 4)) {

196 *
d©asize
 = 
chunk
.
size
;

200 ià(
	`f£ek
(
f
, 
chunk
.
size
, 
SEEK_CUR
) < 0)

201  
”ºo
;

205 
	}
}

	@rem-0.5.2/src/aumix/aumix.c

7 
	#_BSD_SOURCE
 1

	)

8 
	#_DEFAULT_SOURCE
 1

	)

9 
	~<uni¡d.h
>

10 
	~<±h»ad.h
>

11 
	~<¡ršg.h
>

12 
	~<».h
>

13 
	~<»m_au.h
>

14 
	~<»m_aubuf.h
>

15 
	~<»m_aufe.h
>

16 
	~<»m_aumix.h
>

20 
	saumix
 {

21 
±h»ad_mu‹x_t
 
	mmu‹x
;

22 
±h»ad_cÚd_t
 
	mcÚd
;

23 
li¡
 
	m¤ş
;

24 
±h»ad_t
 
	mth»ad
;

25 
aufe
 *
	maf
;

26 
ušt32_t
 
	m±ime
;

27 
ušt32_t
 
	mäame_size
;

28 
ušt32_t
 
	m¤©e
;

29 
ušt8_t
 
	mch
;

30 
boŞ
 
	mrun
;

34 
	saumix_sourû
 {

35 
Ë
 
	mË
;

36 
št16_t
 *
	mäame
;

37 
aubuf
 *
	maubuf
;

38 
aumix
 *
	mmix
;

39 
aumix_äame_h
 *
	mfh
;

40 *
	m¬g
;

44 
	$dummy_äame_hªdËr
(cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
, *
¬g
)

46 ()
§mpv
;

47 ()
§mpc
;

48 ()
¬g
;

49 
	}
}

52 
	$de¡ruùÜ
(*
¬g
)

54 
aumix
 *
mix
 = 
¬g
;

56 ià(
mix
->
run
) {

58 
	`±h»ad_mu‹x_lock
(&
mix
->
mu‹x
);

59 
mix
->
run
 = 
çl£
;

60 
	`±h»ad_cÚd_sigÇl
(&
mix
->
cÚd
);

61 
	`±h»ad_mu‹x_uÆock
(&
mix
->
mu‹x
);

63 
	`±h»ad_još
(
mix
->
th»ad
, 
NULL
);

66 
	`mem_d”ef
(
mix
->
af
);

67 
	}
}

70 
	$sourû_de¡ruùÜ
(*
¬g
)

72 
aumix_sourû
 *
¤c
 = 
¬g
;

74 ià(
¤c
->
Ë
.
li¡
) {

75 
	`±h»ad_mu‹x_lock
(&
¤c
->
mix
->
mu‹x
);

76 
	`li¡_uÆšk
(&
¤c
->
Ë
);

77 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mix
->
mu‹x
);

80 
	`mem_d”ef
(
¤c
->
aubuf
);

81 
	`mem_d”ef
(
¤c
->
äame
);

82 
	`mem_d”ef
(
¤c
->
mix
);

83 
	}
}

86 *
	$aumix_th»ad
(*
¬g
)

88 
ušt8_t
 *
s’û
, *
äame
, *
ba£_äame
;

89 
aumix
 *
mix
 = 
¬g
;

90 
št16_t
 *
mix_äame
;

91 
ušt64_t
 
ts
 = 0;

93 
s’û
 = 
	`mem_z®loc
(
mix
->
äame_size
*2, 
NULL
);

94 
äame
 = 
	`mem_®loc
(
mix
->
äame_size
*2, 
NULL
);

95 
mix_äame
 = 
	`mem_®loc
(
mix
->
äame_size
*2, 
NULL
);

97 ià(!
s’û
 || !
äame
 || !
mix_äame
)

98 
out
;

100 
	`±h»ad_mu‹x_lock
(&
mix
->
mu‹x
);

102 
mix
->
run
) {

104 
Ë
 *le;

105 
ušt64_t
 
now
;

107 ià(!
mix
->
¤ş
.
h—d
) {

108 
mix
->
af
 = 
	`mem_d”ef
(mix->af);

109 
	`±h»ad_cÚd_wa™
(&
mix
->
cÚd
, &mix->
mu‹x
);

110 
ts
 = 0;

113 
	`±h»ad_mu‹x_uÆock
(&
mix
->
mu‹x
);

114 ()
	`u¦“p
(4000);

115 
	`±h»ad_mu‹x_lock
(&
mix
->
mu‹x
);

118 
now
 = 
	`tmr_jiff›s
();

119 ià(!
ts
)

120 
ts
 = 
now
;

122 ià(
ts
 > 
now
)

125 ià(
mix
->
af
) {

127 
size_t
 
n
 = 
mix
->
äame_size
*2;

129 ià(
	`aufe_»ad
(
mix
->
af
, 
äame
, &
n
) ||‚ == 0) {

130 
mix
->
af
 = 
	`mem_d”ef
(mix->af);

131 
ba£_äame
 = 
s’û
;

133 ià(
n
 < 
mix
->
äame_size
*2) {

134 
	`mem£t
(
äame
 + 
n
, 0, 
mix
->
äame_size
*2 -‚);

135 
mix
->
af
 = 
	`mem_d”ef
(mix->af);

136 
ba£_äame
 = 
äame
;

139 
ba£_äame
 = 
äame
;

143 
ba£_äame
 = 
s’û
;

146 
Ë
=
mix
->
¤ş
.
h—d
;†e;†eöe->
Ãxt
) {

148 
aumix_sourû
 *
¤c
 = 
Ë
->
d©a
;

150 
	`aubuf_»ad_§mp
(
¤c
->
aubuf
, src->
äame
,

151 
mix
->
äame_size
);

154 
Ë
=
mix
->
¤ş
.
h—d
;†e;†eöe->
Ãxt
) {

156 
aumix_sourû
 *
¤c
 = 
Ë
->
d©a
;

157 
Ë
 *
şe
;

159 
	`memıy
(
mix_äame
, 
ba£_äame
, 
mix
->
äame_size
*2);

161 
şe
=
mix
->
¤ş
.
h—d
; cË; cË=şe->
Ãxt
) {

163 
aumix_sourû
 *
c¤c
 = 
şe
->
d©a
;

164 
size_t
 
i
;

167 ià(
c¤c
 =ğ
¤c
)

170 
i
=0; i<
mix
->
äame_size
; i++)

171 
mix_äame
[
i
] +ğ
c¤c
->
äame
[i];

174 
¤c
->
	`fh
(
mix_äame
, 
mix
->
äame_size
, src->
¬g
);

177 
ts
 +ğ
mix
->
±ime
;

180 
	`±h»ad_mu‹x_uÆock
(&
mix
->
mu‹x
);

182 
out
:

183 
	`mem_d”ef
(
mix_äame
);

184 
	`mem_d”ef
(
s’û
);

185 
	`mem_d”ef
(
äame
);

187  
NULL
;

188 
	}
}

201 
	$aumix_®loc
(
aumix
 **
mixp
, 
ušt32_t
 
¤©e
,

202 
ušt8_t
 
ch
, 
ušt32_t
 
±ime
)

204 
aumix
 *
mix
;

205 
”r
;

207 ià(!
mixp
 || !
¤©e
 || !
ch
 || !
±ime
)

208  
EINVAL
;

210 
mix
 = 
	`mem_z®loc
((*mix), 
de¡ruùÜ
);

211 ià(!
mix
)

212  
ENOMEM
;

214 
mix
->
±ime
 =…time;

215 
mix
->
äame_size
 = 
¤©e
 * 
ch
 * 
±ime
 / 1000;

216 
mix
->
¤©e
 = srate;

217 
mix
->
ch
 = ch;

219 
”r
 = 
	`±h»ad_mu‹x_š™
(&
mix
->
mu‹x
, 
NULL
);

220 ià(
”r
)

221 
out
;

223 
”r
 = 
	`±h»ad_cÚd_š™
(&
mix
->
cÚd
, 
NULL
);

224 ià(
”r
)

225 
out
;

227 
mix
->
run
 = 
Œue
;

229 
”r
 = 
	`±h»ad_ü—‹
(&
mix
->
th»ad
, 
NULL
, 
aumix_th»ad
, mix);

230 ià(
”r
) {

231 
mix
->
run
 = 
çl£
;

232 
out
;

235 
out
:

236 ià(
”r
)

237 
	`mem_d”ef
(
mix
);

239 *
mixp
 = 
mix
;

241  
”r
;

242 
	}
}

253 
	$aumix_¶ayfe
(
aumix
 *
mix
, cÚ¡ *
f•©h
)

255 
aufe_´m
 
´m
;

256 
aufe
 *
af
;

257 
”r
;

259 ià(!
mix
 || !
f•©h
)

260  
EINVAL
;

262 
”r
 = 
	`aufe_İ’
(&
af
, &
´m
, 
f•©h
, 
AUFILE_READ
);

263 ià(
”r
)

264  
”r
;

266 ià(
´m
.
fmt
 !ğ
AUFMT_S16LE
 ||…rm.
¤©e
 !ğ
mix
->srate ||

267 
´m
.
chªÃls
 !ğ
mix
->
ch
) {

268 
	`mem_d”ef
(
af
);

269  
EINVAL
;

272 
	`±h»ad_mu‹x_lock
(&
mix
->
mu‹x
);

273 
	`mem_d”ef
(
mix
->
af
);

274 
mix
->
af
 =‡f;

275 
	`±h»ad_mu‹x_uÆock
(&
mix
->
mu‹x
);

278 
	}
}

288 
ušt32_t
 
	$aumix_sourû_couÁ
(cÚ¡ 
aumix
 *
mix
)

290 ià(!
mix
)

293  
	`li¡_couÁ
(&
mix
->
¤ş
);

294 
	}
}

307 
	$aumix_sourû_®loc
(
aumix_sourû
 **
¤ı
, 
aumix
 *
mix
,

308 
aumix_äame_h
 *
fh
, *
¬g
)

310 
aumix_sourû
 *
¤c
;

311 
size_t
 
sz
;

312 
”r
;

314 ià(!
¤ı
 || !
mix
)

315  
EINVAL
;

317 
¤c
 = 
	`mem_z®loc
((*¤c), 
sourû_de¡ruùÜ
);

318 ià(!
¤c
)

319  
ENOMEM
;

321 
¤c
->
mix
 = 
	`mem_»f
(mix);

322 
¤c
->
fh
 = fh ? fh : 
dummy_äame_hªdËr
;

323 
¤c
->
¬g
 =‡rg;

325 
sz
 = 
mix
->
äame_size
*2;

327 
¤c
->
äame
 = 
	`mem_®loc
(
sz
, 
NULL
);

328 ià(!
¤c
->
äame
) {

329 
”r
 = 
ENOMEM
;

330 
out
;

333 
”r
 = 
	`aubuf_®loc
(&
¤c
->
aubuf
, 
sz
 * 6, sz * 12);

334 ià(
”r
)

335 
out
;

337 
out
:

338 ià(
”r
)

339 
	`mem_d”ef
(
¤c
);

341 *
¤ı
 = 
¤c
;

343  
”r
;

344 
	}
}

353 
	$aumix_sourû_’abË
(
aumix_sourû
 *
¤c
, 
boŞ
 
’abË
)

355 
aumix
 *
mix
;

357 ià(!
¤c
)

360 ià(
¤c
->
Ë
.
li¡
 && 
’abË
)

363 ià(!
¤c
->
Ë
.
li¡
 && !
’abË
)

366 
mix
 = 
¤c
->mix;

368 
	`±h»ad_mu‹x_lock
(&
mix
->
mu‹x
);

370 ià(
’abË
) {

371 
	`li¡_­³nd
(&
mix
->
¤ş
, &
¤c
->
Ë
, src);

372 
	`±h»ad_cÚd_sigÇl
(&
mix
->
cÚd
);

375 
	`li¡_uÆšk
(&
¤c
->
Ë
);

378 
	`±h»ad_mu‹x_uÆock
(&
mix
->
mu‹x
);

379 
	}
}

391 
	$aumix_sourû_put
(
aumix_sourû
 *
¤c
, cÚ¡ 
št16_t
 *
§mpv
,

392 
size_t
 
§mpc
)

394 ià(!
¤c
 || !
§mpv
)

395  
EINVAL
;

397  
	`aubuf_wr™e_§mp
(
¤c
->
aubuf
, 
§mpv
, 
§mpc
);

398 
	}
}

406 
	$aumix_sourû_æush
(
aumix_sourû
 *
¤c
)

408 ià(!
¤c
)

411 
	`aubuf_æush
(
¤c
->
aubuf
);

412 
	}
}

	@rem-0.5.2/src/auresamp/resamp.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m_fœ.h
>

10 
	~<»m_au»§mp.h
>

14 cÚ¡ 
št16_t
 
	gfœ_48_4
[] = {

22 cÚ¡ 
št16_t
 
	gfœ_48_8
[] = {

30 
	$up§m¶e_mÚo2mÚo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

31 
size_t
 
šc
, 
¿tio
)

33 
i
;

35 
šc
 >= 1) {

37 
i
=0; i<
¿tio
; i++)

38 *
outv
++ = *
šv
;

40 ++
šv
;

41 --
šc
;

43 
	}
}

46 
	$up§m¶e_mÚo2¡”eo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

47 
size_t
 
šc
, 
¿tio
)

49 
i
;

51 
¿tio
 *= 2;

53 
šc
 >= 1) {

55 
i
=0; i<
¿tio
; i++)

56 *
outv
++ = *
šv
;

58 ++
šv
;

59 --
šc
;

61 
	}
}

64 
	$up§m¶e_¡”eo2mÚo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

65 
size_t
 
šc
, 
¿tio
)

67 
i
;

69 
šc
 >= 2) {

71 cÚ¡ 
št16_t
 
s
 = 
šv
[0]/2 + inv[1]/2;

73 
i
=0; i<
¿tio
; i++)

74 *
outv
++ = 
s
;

76 
šv
 += 2;

77 
šc
 -= 2;

79 
	}
}

82 
	$up§m¶e_¡”eo2¡”eo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

83 
size_t
 
šc
, 
¿tio
)

85 
i
;

87 
šc
 >= 2) {

89 
i
=0; i<
¿tio
; i++) {

90 *
outv
++ = 
šv
[0];

91 *
outv
++ = 
šv
[1];

94 
šv
 += 2;

95 
šc
 -= 2;

97 
	}
}

100 
	$down§m¶e_mÚo2mÚo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

101 
size_t
 
šc
, 
¿tio
)

103 
šc
 >ğ
¿tio
) {

105 *
outv
++ = *
šv
;

107 
šv
 +ğ
¿tio
;

108 
šc
 -ğ
¿tio
;

110 
	}
}

113 
	$down§m¶e_mÚo2¡”eo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

114 
size_t
 
šc
, 
¿tio
)

116 
šc
 >ğ
¿tio
) {

118 *
outv
++ = *
šv
;

119 *
outv
++ = *
šv
;

121 
šv
 +ğ
¿tio
;

122 
šc
 -ğ
¿tio
;

124 
	}
}

127 
	$down§m¶e_¡”eo2mÚo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

128 
size_t
 
šc
, 
¿tio
)

130 
¿tio
 *= 2;

132 
šc
 >ğ
¿tio
) {

134 *
outv
++ = 
šv
[0]/2 + inv[1]/2;

136 
šv
 +ğ
¿tio
;

137 
šc
 -ğ
¿tio
;

139 
	}
}

142 
	$down§m¶e_¡”eo2¡”eo
(
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
,

143 
size_t
 
šc
, 
¿tio
)

145 
¿tio
 *= 2;

147 
šc
 >ğ
¿tio
) {

149 *
outv
++ = 
šv
[0];

150 *
outv
++ = 
šv
[1];

152 
šv
 +ğ
¿tio
;

153 
šc
 -ğ
¿tio
;

155 
	}
}

163 
	$au»§mp_š™
(
au»§mp
 *
rs
)

165 ià(!
rs
)

168 
	`mem£t
(
rs
, 0, (*rs));

169 
	`fœ_»£t
(&
rs
->
fœ
);

170 
	}
}

186 
	$au»§mp_£tup
(
au»§mp
 *
rs
, 
ušt32_t
 
œ©e
, 
ich
,

187 
ušt32_t
 
Ü©e
, 
och
)

189 ià(!
rs
 || !
œ©e
 || !
ich
 || !
Ü©e
 || !
och
)

190  
EINVAL
;

192 ià(
Ü©e
 =ğ
œ©e
 && 
och
 =ğ
ich
) {

193 
	`au»§mp_š™
(
rs
);

197 ià(
Ü©e
 >ğ
œ©e
) {

199 ià(
Ü©e
 % 
œ©e
)

200  
ENOTSUP
;

202 ià(
ich
 =ğ1 && 
och
 == 1)

203 
rs
->
»§m¶e
 = 
up§m¶e_mÚo2mÚo
;

204 ià(
ich
 =ğ1 && 
och
 == 2)

205 
rs
->
»§m¶e
 = 
up§m¶e_mÚo2¡”eo
;

206 ià(
ich
 =ğ2 && 
och
 == 1)

207 
rs
->
»§m¶e
 = 
up§m¶e_¡”eo2mÚo
;

208 ià(
ich
 =ğ2 && 
och
 == 2)

209 
rs
->
»§m¶e
 = 
up§m¶e_¡”eo2¡”eo
;

211  
ENOTSUP
;

213 ià(!
rs
->
up
 || 
Ü©e
 !ğrs->Ü©|| 
och
 !=„s->och)

214 
	`fœ_»£t
(&
rs
->
fœ
);

216 
rs
->
¿tio
 = 
Ü©e
 / 
œ©e
;

217 
rs
->
up
 = 
Œue
;

219 ià(
Ü©e
 =ğ48000 && 
œ©e
 == 16000) {

220 
rs
->
pv
 = 
fœ_48_8
;

221 
rs
->
pc
 = 
	`ARRAY_SIZE
(
fœ_48_8
);

224 
rs
->
pv
 = 
fœ_48_4
;

225 
rs
->
pc
 = 
	`ARRAY_SIZE
(
fœ_48_4
);

229 ià(
œ©e
 % 
Ü©e
)

230  
ENOTSUP
;

232 ià(
ich
 =ğ1 && 
och
 == 1)

233 
rs
->
»§m¶e
 = 
down§m¶e_mÚo2mÚo
;

234 ià(
ich
 =ğ1 && 
och
 == 2)

235 
rs
->
»§m¶e
 = 
down§m¶e_mÚo2¡”eo
;

236 ià(
ich
 =ğ2 && 
och
 == 1)

237 
rs
->
»§m¶e
 = 
down§m¶e_¡”eo2mÚo
;

238 ià(
ich
 =ğ2 && 
och
 == 2)

239 
rs
->
»§m¶e
 = 
down§m¶e_¡”eo2¡”eo
;

241  
ENOTSUP
;

243 ià(
rs
->
up
 || 
œ©e
 !ğrs->œ©|| 
ich
 !=„s->ich)

244 
	`fœ_»£t
(&
rs
->
fœ
);

246 
rs
->
¿tio
 = 
œ©e
 / 
Ü©e
;

247 
rs
->
up
 = 
çl£
;

249 ià(
œ©e
 =ğ48000 && 
Ü©e
 == 16000) {

250 
rs
->
pv
 = 
fœ_48_8
;

251 
rs
->
pc
 = 
	`ARRAY_SIZE
(
fœ_48_8
);

254 
rs
->
pv
 = 
fœ_48_4
;

255 
rs
->
pc
 = 
	`ARRAY_SIZE
(
fœ_48_4
);

259 
rs
->
Ü©e
 = orate;

260 
rs
->
och
 = och;

261 
rs
->
œ©e
 = irate;

262 
rs
->
ich
 = ich;

265 
	}
}

281 
	$au»§mp
(
au»§mp
 *
rs
, 
št16_t
 *
outv
, 
size_t
 *
outc
,

282 cÚ¡ 
št16_t
 *
šv
, 
size_t
 
šc
)

284 
size_t
 
šcc
, 
outcc
;

286 ià(!
rs
 || !rs->
»§m¶e
 || !
outv
 || !
outc
 || !
šv
)

287  
EINVAL
;

289 
šcc
 = 
šc
 / 
rs
->
ich
;

291 ià(
rs
->
up
) {

292 
outcc
 = 
šcc
 * 
rs
->
¿tio
;

294 ià(*
outc
 < 
outcc
 * 
rs
->
och
)

295  
ENOMEM
;

297 
rs
->
	`»§m¶e
(
outv
, 
šv
, 
šc
,„s->
¿tio
);

299 *
outc
 = 
outcc
 * 
rs
->
och
;

301 
	`fœ_f‹r
(&
rs
->
fœ
, 
outv
, outv, *
outc
,„s->
och
,

302 
rs
->
pv
,„s->
pc
);

305 
outcc
 = 
šcc
 / 
rs
->
¿tio
;

307 ià(*
outc
 < 
outcc
 * 
rs
->
och
 || *outø< 
šc
)

308  
ENOMEM
;

310 
	`fœ_f‹r
(&
rs
->
fœ
, 
outv
, 
šv
, 
šc
,„s->
ich
,

311 
rs
->
pv
,„s->
pc
);

313 
rs
->
	`»§m¶e
(
outv
, outv, 
šc
,„s->
¿tio
);

315 *
outc
 = 
outcc
 * 
rs
->
och
;

319 
	}
}

	@rem-0.5.2/src/autone/tone.c

6 
	~<m©h.h
>

7 
	~<».h
>

8 
	~<»m_autÚe.h
>

9 
	~<»m_d¥.h
>

12 
	#SCALE
 (32767)

	)

13 
	#DTMF_AMP
 (5)

	)

15 #ià!
defšed
 (
M_PI
)

16 
	#M_PI
 3.14159265358979323846264338327

	)

20 
šlše
 
ušt32_t
 
	$dig™2lo
(
dig™
)

22 
dig™
) {

30 
	}
}

33 
šlše
 
ušt32_t
 
	$dig™2hi
(
dig™
)

35 
dig™
) {

43 
	}
}

58 
	$autÚe_sše
(
mbuf
 *
mb
, 
ušt32_t
 
¤©e
,

59 
ušt32_t
 
f1
, 
l1
, ušt32_ˆ
f2
, 
l2
)

61 
d1
, 
d2
;

62 
ušt32_t
 
i
;

63 
”r
 = 0;

65 ià(!
mb
 || !
¤©e
)

66  
EINVAL
;

68 
d1
 = 1.0à* 
f1
 / 
¤©e
;

69 
d2
 = 1.0à* 
f2
 / 
¤©e
;

71 
i
=0; i<
¤©e
; i++) {

72 
št16_t
 
s1
, 
s2
;

74 
s1
 = (
št16_t
)(
SCALE
 * 
l1
 / 100.0à* 
	`sš
(2 * 
M_PI
 * 
d1
 * 
i
));

75 
s2
 = (
št16_t
)(
SCALE
 * 
l2
 / 100.0à* 
	`sš
(2 * 
M_PI
 * 
d2
 * 
i
));

77 
”r
 |ğ
	`mbuf_wr™e_u16
(
mb
, 
	`§tu¿‹_add16
(
s1
, 
s2
));

80  
”r
;

81 
	}
}

93 
	$autÚe_dtmf
(
mbuf
 *
mb
, 
ušt32_t
 
¤©e
, 
dig™
)

95  
	`autÚe_sše
(
mb
, 
¤©e
,

96 
	`dig™2lo
(
dig™
), 
DTMF_AMP
,

97 
	`dig™2hi
(
dig™
), 
DTMF_AMP
);

98 
	}
}

	@rem-0.5.2/src/dtmf/dec.c

7 
	~<».h
>

8 
	~<»m_gÛ¹z–.h
>

9 
	~<»m_dtmf.h
>

12 
	#BLOCK_SIZE
 102

	)

13 
	#THRESHOLD
 16439.10631

	)

14 
	#NORMAL_TWIST
 6.309573

	)

15 
	#REVERSE_TWIST
 2.511886

	)

16 
	#RELATIVE_KEY
 6.309573

	)

17 
	#RELATIVE_SUM
 0.822243

	)

20 cÚ¡ 
	gfx
[4] = { 1209.0, 1336.0, 1477.0, 1633.0 };

21 cÚ¡ 
	gfy
[4] = { 697.0, 770.0, 852.0, 941.0 };

23 cÚ¡ 
	gkeyv
[4][4] = {{'1', '2', '3', 'A'},

29 
	sdtmf_dec
 {

30 
gÛ¹z–
 
	mgx
[4], 
	mgy
[4];

31 
dtmf_dec_h
 *
	mdech
;

32 *
	m¬g
;

33 
	mth»shŞd
;

34 
	m’”gy
;

35 
	meçc
;

36 
	mbsize
;

37 
	mbidx
;

38 
	mdig™
, 
	mdig™1
;

42 
	$decode_dig™
(
dtmf_dec
 *
dec
)

44 
i
, 
x
 = 0, 
y
 = 0;

45 
ex
[4], 
ey
[4];

47 
i
=0; i<4; i++) {

49 
ex
[
i
] = 
	`gÛ¹z–_»suÉ
(&
dec
->
gx
[i]);

50 
ey
[
i
] = 
	`gÛ¹z–_»suÉ
(&
dec
->
gy
[i]);

52 ià(
ex
[
i
] >ƒx[
x
])

53 
x
 = 
i
;

55 ià(
ey
[
i
] >ƒy[
y
])

56 
y
 = 
i
;

59 ià(
ex
[
x
] < 
dec
->
th»shŞd
 ||

60 
ey
[
y
] < 
dec
->
th»shŞd
)

63 ià(
ex
[
x
] > 
ey
[
y
] * 
NORMAL_TWIST
 ||

64 
ey
[
y
] > 
ex
[
x
] * 
REVERSE_TWIST
)

67 
i
=0; i<4; i++) {

69 ià((
i
 !ğ
x
 && 
ex
[i] * 
RELATIVE_KEY
 >ƒx[x]) ||

70 (
i
 !ğ
y
 && 
ey
[i] * 
RELATIVE_KEY
 >ƒy[y]))

74 ià((
ex
[
x
] + 
ey
[
y
]è< 
dec
->
eçc
 * dec->
’”gy
)

77  
keyv
[
y
][
x
];

78 
	}
}

92 
	$dtmf_dec_®loc
(
dtmf_dec
 **
deı
, 
¤©e
, 
ch
,

93 
dtmf_dec_h
 *
dech
, *
¬g
)

95 
dtmf_dec
 *
dec
;

97 ià(!
deı
 || !
dech
 || !
¤©e
 || !
ch
)

98  
EINVAL
;

100 
dec
 = 
	`mem_z®loc
((*dec), 
NULL
);

101 ià(!
dec
)

102  
ENOMEM
;

104 
	`dtmf_dec_»£t
(
dec
, 
¤©e
, 
ch
);

106 
dec
->
dech
 = dech;

107 
dec
->
¬g
 =‡rg;

109 *
deı
 = 
dec
;

112 
	}
}

122 
	$dtmf_dec_»£t
(
dtmf_dec
 *
dec
, 
¤©e
, 
ch
)

124 
i
;

126 ià(!
dec
 || !
¤©e
 || !
ch
)

129 
¤©e
 *ğ
ch
;

131 
i
=0; i<4; i++) {

132 
	`gÛ¹z–_š™
(&
dec
->
gx
[
i
], 
fx
[i], 
¤©e
);

133 
	`gÛ¹z–_š™
(&
dec
->
gy
[
i
], 
fy
[i], 
¤©e
);

136 
dec
->
bsize
 = (
BLOCK_SIZE
 * 
¤©e
) / 8000;

137 
dec
->
th»shŞd
 = 
THRESHOLD
 * dec->
bsize
 * dec->bsize;

138 
dec
->
eçc
 = 
RELATIVE_SUM
 * dec->
bsize
;

140 
dec
->
’”gy
 = 0.0;

141 
dec
->
bidx
 = 0;

142 
dec
->
dig™
 = 0;

143 
dec
->
dig™1
 = 0;

144 
	}
}

154 
	$dtmf_dec_´obe
(
dtmf_dec
 *
dec
, cÚ¡ 
št16_t
 *
§mpv
, 
size_t
 
§mpc
)

156 
size_t
 
i
;

158 ià(!
dec
 || !
§mpv
)

161 
i
=0; i<
§mpc
; i++) {

163 
dig™0
;

164 
j
;

166 
j
=0; j<4; j++) {

167 
	`gÛ¹z–_upd©e
(&
dec
->
gx
[
j
], 
§mpv
[
i
]);

168 
	`gÛ¹z–_upd©e
(&
dec
->
gy
[
j
], 
§mpv
[
i
]);

171 
dec
->
’”gy
 +ğ
§mpv
[
i
] * sampv[i];

173 ià(++
dec
->
bidx
 < dec->
bsize
)

176 
dig™0
 = 
	`decode_dig™
(
dec
);

178 ià(
dig™0
 !ğ
dec
->
dig™
 && dec->
dig™1
 != dec->digit) {

180 
dec
->
dig™
 = 
dig™0
;

182 ià(
dig™0
 !ğ
dec
->
dig™1
)

183 
dec
->
dig™
 = 0;

185 ià(
dec
->
dig™
)

186 
dec
->
	`dech
(dec->
dig™
, dec->
¬g
);

189 
dec
->
dig™1
 = 
dig™0
;

190 
dec
->
’”gy
 = 0.0;

191 
dec
->
bidx
 = 0;

193 
	}
}

	@rem-0.5.2/src/fir/fir.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m_fœ.h
>

17 
	$fœ_»£t
(
fœ
 *fir)

19 ià(!
fœ
)

22 
	`mem£t
(
fœ
, 0, (*fir));

23 
	}
}

39 
	$fœ_f‹r
(
fœ
 *fœ, 
št16_t
 *
outv
, cÚ¡ iÁ16_ˆ*
šv
, 
size_t
 
šc
,

40 
ch
, cÚ¡ 
št16_t
 *
pv
, 
size_t
 
pc
)

42 cÚ¡ 
hmask
 = (
ch
 * ()
pc
) - 1;

44 ià(!
fœ
 || !
outv
 || !
šv
 || !
ch
 || !
pv
 || !
pc
)

47 ià(
hmask
 >ğ
	`ARRAY_SIZE
(
fœ
->
hi¡Üy
) || hmask & (hmask+1))

50 
šc
--) {

52 
št64_t
 
acc
 = 0;

53 
i
, 
j
;

55 
fœ
->
hi¡Üy
[fœ->
šdex
 & 
hmask
] = *
šv
++;

57 
i
=0, 
j
=
fœ
->
šdex
++; i<
pc
; ++i, j-=
ch
)

58 
acc
 +ğ(
št64_t
)
fœ
->
hi¡Üy
[
j
 & 
hmask
] * 
pv
[
i
];

60 ià(
acc
 > 0x3fffffff)

61 
acc
 = 0x3fffffff;

62 ià(
acc
 < -0x40000000)

63 
acc
 = -0x40000000;

65 *
outv
++ = (
št16_t
)(
acc
>>15);

67 
	}
}

	@rem-0.5.2/src/g711/g711.c

7 
	~<»_ty³s.h
>

8 
	~<»m_g711.h
>

11 cÚ¡ 
ušt8_t
 
	gg711_l2u
[4096] = {

526 cÚ¡ 
ušt8_t
 
	gg711_l2A
[2048] = {

785 cÚ¡ 
št16_t
 
	gg711_u2l
[256] = {

820 cÚ¡ 
št16_t
 
	gg711_A2l
[256] = {

	@rem-0.5.2/src/goertzel/goertzel.c

7 
	~<m©h.h
>

8 
	~<».h
>

9 
	~<»m_gÛ¹z–.h
>

12 
	#PI
 3.14159265358979323846264338327

	)

22 
	$gÛ¹z–_š™
(
gÛ¹z–
 *
g
, 
äeq
, 
¤©e
)

24 
g
->
q1
 = 0.0;

25 
g
->
q2
 = 0.0;

26 
g
->
cÛf
 = 2.0 * 
	`cos
(2.0 * 
PI
 * (
äeq
/()
¤©e
));

27 
	}
}

35 
	$gÛ¹z–_»£t
(
gÛ¹z–
 *
g
)

37 
g
->
q1
 = 0.0;

38 
g
->
q2
 = 0.0;

39 
	}
}

49 
	$gÛ¹z–_»suÉ
(
gÛ¹z–
 *
g
)

51 
»s
;

53 
	`gÛ¹z–_upd©e
(
g
, 0);

55 
»s
 = 
g
->
q1
*g->q1 + g->
q2
*g->q2 - g->q1*g->q2*g->
cÛf
;

57 
	`gÛ¹z–_»£t
(
g
);

59  
»s
 * 2.0;

60 
	}
}

	@rem-0.5.2/src/vid/draw.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m_vid.h
>

22 
	$vidäame_d¿w_pošt
(
vidäame
 *
f
, 
x
, 
y
,

23 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

25 
ušt8_t
 *
yp
, *
up
, *
vp
, *
p
;

27 ià(!
f
)

30 ià(
x
 >ğ
f
->
size
.
w
 || 
y
 >ğf->size.
h
)

33 
f
->
fmt
) {

35 
VID_FMT_YUV420P
:

36 
yp
 = 
f
->
d©a
[0] + f->
lšesize
[0] * 
y
 + 
x
;

37 
up
 = 
f
->
d©a
[1] + f->
lšesize
[1] * (
y
/2è+ 
x
/2;

38 
vp
 = 
f
->
d©a
[2] + f->
lšesize
[2] * (
y
/2è+ 
x
/2;

40 
yp
[0] = 
	`rgb2y
(
r
, 
g
, 
b
);

41 
up
[0] = 
	`rgb2u
(
r
, 
g
, 
b
);

42 
vp
[0] = 
	`rgb2v
(
r
, 
g
, 
b
);

45 
VID_FMT_YUV444P
:

46 
yp
 = 
f
->
d©a
[0] + f->
lšesize
[0] * 
y
 + 
x
;

47 
up
 = 
f
->
d©a
[1] + f->
lšesize
[1] * 
y
 + 
x
;

48 
vp
 = 
f
->
d©a
[2] + f->
lšesize
[2] * 
y
 + 
x
;

50 
yp
[0] = 
	`rgb2y
(
r
, 
g
, 
b
);

51 
up
[0] = 
	`rgb2u
(
r
, 
g
, 
b
);

52 
vp
[0] = 
	`rgb2v
(
r
, 
g
, 
b
);

55 
VID_FMT_RGB32
:

56 
p
 = 
f
->
d©a
[0] + f->
lšesize
[0] * 
y
 + 
x
*4;

58 
p
[0] = 
b
;

59 
p
[1] = 
g
;

60 
p
[2] = 
r
;

64 ()
	`»_årštf
(
¡d”r
, "vidframe_draw_point:"

66 
	`vidfmt_Çme
(
f
->
fmt
));

69 
	}
}

83 
	$vidäame_d¿w_hlše
(
vidäame
 *
f
,

84 
x0
, 
y0
, 
w
,

85 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

87 
ušt8_t
 
y
, 
u
, 
v
;

89 ià(!
f
)

92 ià(
x0
 >ğ
f
->
size
.
w
 || 
y0
 >ğf->size.
h
)

95 
w
 = 
	`mš
(w, 
f
->
size
.w-
x0
);

97 
y
 = 
	`rgb2y
(
r
, 
g
, 
b
);

98 
u
 = 
	`rgb2u
(
r
, 
g
, 
b
);

99 
v
 = 
	`rgb2v
(
r
, 
g
, 
b
);

101 
f
->
fmt
) {

103 
VID_FMT_YUV420P
:

104 
	`mem£t
(
f
->
d©a
[0] + 
y0
 *f->
lšesize
[0] + 
x0
, 
y
, 
w
);

105 
	`mem£t
(
f
->
d©a
[1] + (
y0
/2)*f->
lšesize
[1] + 
x0
/2, 
u
, 
w
/2);

106 
	`mem£t
(
f
->
d©a
[2] + (
y0
/2)*f->
lšesize
[2] + 
x0
/2, 
v
, 
w
/2);

109 
VID_FMT_YUV444P
:

110 
	`mem£t
(
f
->
d©a
[0] + 
y0
*f->
lšesize
[0] + 
x0
, 
y
, 
w
);

111 
	`mem£t
(
f
->
d©a
[1] + 
y0
*f->
lšesize
[1] + 
x0
, 
u
, 
w
);

112 
	`mem£t
(
f
->
d©a
[2] + 
y0
*f->
lšesize
[2] + 
x0
, 
v
, 
w
);

116 ()
	`»_årštf
(
¡d”r
, "vidframe_draw_hline:"

118 
	`vidfmt_Çme
(
f
->
fmt
));

121 
	}
}

135 
	$vidäame_d¿w_vlše
(
vidäame
 *
f
,

136 
x0
, 
y0
, 
h
,

137 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

139 ià(!
f
)

142 
h
--) {

143 
	`vidäame_d¿w_pošt
(
f
, 
x0
, 
y0
++, 
r
, 
g
, 
b
);

145 
	}
}

160 
	$vidäame_d¿w_»ù
(
vidäame
 *
f
, 
x0
, 
y0
,

161 
w
, 
h
,

162 
ušt8_t
 
r
, ušt8_ˆ
g
, ušt8_ˆ
b
)

164 ià(!
f
)

167 
	`vidäame_d¿w_hlše
(
f
, 
x0
, 
y0
, 
w
, 
r
, 
g
, 
b
);

168 
	`vidäame_d¿w_hlše
(
f
, 
x0
, 
y0
+
h
-1, 
w
, 
r
, 
g
, 
b
);

169 
	`vidäame_d¿w_vlše
(
f
, 
x0
, 
y0
, 
h
, 
r
, 
g
, 
b
);

170 
	`vidäame_d¿w_vlše
(
f
, 
x0
+
w
-1, 
y0
, 
h
, 
r
, 
g
, 
b
);

171 
	}
}

	@rem-0.5.2/src/vid/fmt.c

7 
	~<».h
>

8 
	~<»m_vid.h
>

12 cÚ¡ 
vidfmt_desc
 
	gvidfmt_descv
[
VID_FMT_N
] = {

34 cÚ¡ *
	$vidfmt_Çme
(
vidfmt
 
fmt
)

36 ià(
fmt
 >ğ
VID_FMT_N
)

39  
vidfmt_descv
[
fmt
].
Çme
;

40 
	}
}

	@rem-0.5.2/src/vid/frame.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m_vid.h
>

20 
size_t
 
	$vidäame_size
(
vidfmt
 
fmt
, cÚ¡ 
vidsz
 *
sz
)

22 ià(!
sz
)

25 
fmt
) {

27 
VID_FMT_YUV420P
:  
sz
->
w
 * sz->
h
 * 3 / 2;

28 
VID_FMT_YUYV422
:  
sz
->
w
 * sz->
h
 * 2;

29 
VID_FMT_UYVY422
:  
sz
->
w
 * sz->
h
 * 2;

30 
VID_FMT_RGB32
:  
sz
->
w
 * sz->
h
 * 4;

31 
VID_FMT_ARGB
:  
sz
->
w
 * sz->
h
 * 4;

32 
VID_FMT_RGB565
:  
sz
->
w
 * sz->
h
 * 2;

33 
VID_FMT_RGB555
:  
sz
->
w
 * sz->
h
 * 2;

34 
VID_FMT_NV12
:  
sz
->
w
 * sz->
h
 * 3 / 2;

35 
VID_FMT_NV21
:  
sz
->
w
 * sz->
h
 * 3 / 2;

36 
VID_FMT_YUV444P
:  
sz
->
w
 * sz->
h
 * 3;

40 
	}
}

52 
	$vidäame_š™
(
vidäame
 *
vf
, 
vidfmt
 
fmt
,

53 cÚ¡ 
vidsz
 *
sz
, *
d©a
[4], 
lšesize
[4])

55 
i
;

57 ià(!
vf
 || !
sz
 || !
d©a
 || !
lšesize
)

60 
i
=0; i<4; i++) {

61 
vf
->
d©a
[
i
] = data[i];

62 
vf
->
lšesize
[
i
] =†inesize[i];

65 
vf
->
size
 = *
sz
;

66 
vf
->
fmt
 = fmt;

67 
	}
}

78 
	$vidäame_š™_buf
(
vidäame
 *
vf
, 
vidfmt
 
fmt
,

79 cÚ¡ 
vidsz
 *
sz
, 
ušt8_t
 *
buf
)

81 
w
, 
h
;

83 ià(!
vf
 || !
sz
 || !
buf
)

86 
w
 = (
sz
->w + 1) >> 1;

87 
h
 = (
sz
->h + 1) >> 1;

89 
	`mem£t
(
vf
->
lšesize
, 0, (vf->linesize));

90 
	`mem£t
(
vf
->
d©a
, 0, (vf->data));

92 
fmt
) {

94 
VID_FMT_YUV420P
:

95 
vf
->
lšesize
[0] = 
sz
->
w
;

96 
vf
->
lšesize
[1] = 
w
;

97 
vf
->
lšesize
[2] = 
w
;

99 
vf
->
d©a
[0] = 
buf
;

100 
vf
->
d©a
[1] = vf->d©a[0] + vf->
lšesize
[0] * 
sz
->
h
;

101 
vf
->
d©a
[2] = vf->d©a[1] + vf->
lšesize
[1] * 
h
;

104 
VID_FMT_YUYV422
:

105 
VID_FMT_UYVY422
:

106 
vf
->
lšesize
[0] = 
sz
->
w
 * 2;

107 
vf
->
d©a
[0] = 
buf
;

110 
VID_FMT_RGB32
:

111 
VID_FMT_ARGB
:

112 
vf
->
lšesize
[0] = 
sz
->
w
 * 4;

113 
vf
->
d©a
[0] = 
buf
;

116 
VID_FMT_RGB565
:

117 
VID_FMT_RGB555
:

118 
vf
->
lšesize
[0] = 
sz
->
w
 * 2;

119 
vf
->
d©a
[0] = 
buf
;

122 
VID_FMT_NV12
:

123 
VID_FMT_NV21
:

124 
vf
->
lšesize
[0] = 
sz
->
w
;

125 
vf
->
lšesize
[1] = 
w
*2;

127 
vf
->
d©a
[0] = 
buf
;

128 
vf
->
d©a
[1] = vf->d©a[0] + vf->
lšesize
[0] * 
sz
->
h
;

131 
VID_FMT_YUV444P
:

132 
vf
->
lšesize
[0] = 
sz
->
w
;

133 
vf
->
lšesize
[1] = 
sz
->
w
;

134 
vf
->
lšesize
[2] = 
sz
->
w
;

136 
vf
->
d©a
[0] = 
buf
;

137 
vf
->
d©a
[1] = vf->d©a[0] + vf->
lšesize
[0] * 
sz
->
h
;

138 
vf
->
d©a
[2] = vf->d©a[1] + vf->
lšesize
[1] * 
sz
->
h
;

142 ()
	`»_´štf
("vidäame:‚Øfmˆ%s\n", 
	`vidfmt_Çme
(
fmt
));

146 
vf
->
size
 = *
sz
;

147 
vf
->
fmt
 = fmt;

148 
	}
}

160 
	$vidäame_®loc
(
vidäame
 **
vå
, 
vidfmt
 
fmt
,

161 cÚ¡ 
vidsz
 *
sz
)

163 
vidäame
 *
vf
;

165 ià(!
sz
 || !sz->
w
 || !sz->
h
)

166  
EINVAL
;

168 
vf
 = 
	`mem_z®loc
((*vfè+ 
	`vidäame_size
(
fmt
, 
sz
), 
NULL
);

169 ià(!
vf
)

170  
ENOMEM
;

172 
	`vidäame_š™_buf
(
vf
, 
fmt
, 
sz
, (
ušt8_t
 *)(vf + 1));

174 *
vå
 = 
vf
;

177 
	}
}

188 
	$vidäame_fl
(
vidäame
 *
vf
, 
ušt32_t
 
r
, ušt32_ˆ
g
, ušt32_ˆ
b
)

190 
ušt8_t
 *
p
;

191 
h
, 
i
;

193 ià(!
vf
)

196 
vf
->
fmt
) {

198 
VID_FMT_YUV420P
:

199 
h
 = 
vf
->
size
.h;

201 
	`mem£t
(
vf
->
d©a
[0], 
	`rgb2y
(
r
, 
g
, 
b
), 
h
 * vf->
lšesize
[0]);

202 
	`mem£t
(
vf
->
d©a
[1], 
	`rgb2u
(
r
, 
g
, 
b
), 
h
/2 * vf->
lšesize
[1]);

203 
	`mem£t
(
vf
->
d©a
[2], 
	`rgb2v
(
r
, 
g
, 
b
), 
h
/2 * vf->
lšesize
[2]);

206 
VID_FMT_YUV444P
:

207 
h
 = 
vf
->
size
.h;

209 
	`mem£t
(
vf
->
d©a
[0], 
	`rgb2y
(
r
, 
g
, 
b
), 
h
 * vf->
lšesize
[0]);

210 
	`mem£t
(
vf
->
d©a
[1], 
	`rgb2u
(
r
, 
g
, 
b
), 
h
 * vf->
lšesize
[1]);

211 
	`mem£t
(
vf
->
d©a
[2], 
	`rgb2v
(
r
, 
g
, 
b
), 
h
 * vf->
lšesize
[2]);

214 
VID_FMT_RGB32
:

215 
p
 = 
vf
->
d©a
[0];

216 
i
=0; i<
vf
->
lšesize
[0] * vf->
size
.
h
; i+=4) {

217 *
p
++ = 
b
;

218 *
p
++ = 
g
;

219 *
p
++ = 
r
;

220 *
p
++ = 0;

225 ()
	`»_´štf
("vidfl:‚Øfmˆ%s\n", 
	`vidfmt_Çme
(
vf
->
fmt
));

228 
	}
}

237 
	$vidäame_cİy
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
)

239 cÚ¡ 
ušt8_t
 *
ds0
, *
ds1
, *
ds2
;

240 
lsd
, 
lss
, 
w
, 
h
, 
y
;

241 
ušt8_t
 *
dd0
, *
dd1
, *
dd2
;

243 ià(!
d¡
 || !
¤c
)

246 ià(!
	`vidsz_cmp
(&
d¡
->
size
, &
¤c
->size))

249 ià(
d¡
->
fmt
 !ğ
¤c
->fmt)

252 
d¡
->
fmt
) {

254 
VID_FMT_YUV420P
:

255 
lsd
 = 
d¡
->
lšesize
[0];

256 
lss
 = 
¤c
->
lšesize
[0];

258 
dd0
 = 
d¡
->
d©a
[0];

259 
dd1
 = 
d¡
->
d©a
[1];

260 
dd2
 = 
d¡
->
d©a
[2];

262 
ds0
 = 
¤c
->
d©a
[0];

263 
ds1
 = 
¤c
->
d©a
[1];

264 
ds2
 = 
¤c
->
d©a
[2];

266 
w
 = 
d¡
->
size
.w & ~1;

267 
h
 = 
d¡
->
size
.h & ~1;

269 
y
=0; y<
h
; y+=2) {

271 
	`memıy
(
dd0
, 
ds0
, 
w
);

272 
dd0
 +ğ
lsd
;

273 
ds0
 +ğ
lss
;

275 
	`memıy
(
dd0
, 
ds0
, 
w
);

276 
dd0
 +ğ
lsd
;

277 
ds0
 +ğ
lss
;

279 
	`memıy
(
dd1
, 
ds1
, 
w
/2);

280 
dd1
 +ğ
lsd
/2;

281 
ds1
 +ğ
lss
/2;

283 
	`memıy
(
dd2
, 
ds2
, 
w
/2);

284 
dd2
 +ğ
lsd
/2;

285 
ds2
 +ğ
lss
/2;

289 
VID_FMT_YUV444P
:

290 
lsd
 = 
d¡
->
lšesize
[0];

291 
lss
 = 
¤c
->
lšesize
[0];

293 
dd0
 = 
d¡
->
d©a
[0];

294 
dd1
 = 
d¡
->
d©a
[1];

295 
dd2
 = 
d¡
->
d©a
[2];

297 
ds0
 = 
¤c
->
d©a
[0];

298 
ds1
 = 
¤c
->
d©a
[1];

299 
ds2
 = 
¤c
->
d©a
[2];

301 
w
 = 
d¡
->
size
.w;

302 
h
 = 
d¡
->
size
.h;

304 
y
=0; y<
h
; y++) {

307 
	`memıy
(
dd0
, 
ds0
, 
w
);

308 
dd0
 +ğ
lsd
;

309 
ds0
 +ğ
lss
;

312 
	`memıy
(
dd1
, 
ds1
, 
w
);

313 
dd1
 +ğ
lsd
;

314 
ds1
 +ğ
lss
;

317 
	`memıy
(
dd2
, 
ds2
, 
w
);

318 
dd2
 +ğ
lsd
;

319 
ds2
 +ğ
lss
;

323 
VID_FMT_NV12
:

324 
VID_FMT_NV21
:

325 
lsd
 = 
d¡
->
lšesize
[0];

326 
lss
 = 
¤c
->
lšesize
[0];

328 
dd0
 = 
d¡
->
d©a
[0];

329 
dd1
 = 
d¡
->
d©a
[1];

331 
ds0
 = 
¤c
->
d©a
[0];

332 
ds1
 = 
¤c
->
d©a
[1];

334 
w
 = 
d¡
->
size
.w & ~1;

335 
h
 = 
d¡
->
size
.h & ~1;

337 
y
=0; y<
h
; y+=2) {

339 
	`memıy
(
dd0
, 
ds0
, 
w
);

340 
dd0
 +ğ
lsd
;

341 
ds0
 +ğ
lss
;

343 
	`memıy
(
dd0
, 
ds0
, 
w
);

344 
dd0
 +ğ
lsd
;

345 
ds0
 +ğ
lss
;

347 
	`memıy
(
dd1
, 
ds1
, 
w
);

348 
dd1
 +ğ
lsd
;

349 
ds1
 +ğ
lss
;

354 ()
	`»_´štf
("vidframe_copy(): unsupported format\n");

357 
	}
}

	@rem-0.5.2/src/vidconv/vconv.c

7 
	~<¡ršg.h
>

8 
	~<».h
>

9 
	~<»m_vid.h
>

10 
	~<»m_d¥.h
>

11 
	~<»m_vidcÚv.h
>

20 
	#P
 14

	)

22 
	#COEF_RV
 ((
št32_t
è(1.370705à* ()(1 << 
P
)))

	)

23 
	#COEF_GU
 ((
št32_t
è(-0.337633à* ()(1 << 
P
)))

	)

24 
	#COEF_GV
 ((
št32_t
è(-0.698001à* ()(1 << 
P
)))

	)

25 
	#COEF_BU
 ((
št32_t
è(1.732446à* ()(1 << 
P
)))

	)

27 
	#ERV
(
a
è(
COEF_RV
 * (×è- 128))

	)

28 
	#EGU
(
a
è(
COEF_GU
 * (×è- 128))

	)

29 
	#EGV
(
a
è(
COEF_GV
 * (×è- 128))

	)

30 
	#EBU
(
a
è(
COEF_BU
 * (×è- 128))

	)

33 
št16_t
 
	gCRV
[256];

34 
št16_t
 
	gCGU
[256];

35 
št16_t
 
	gCGV
[256];

36 
št16_t
 
	gCBU
[256];

39 
	$š™_bË
()

41 
i
;

43 
i
 = 0; i < 256; ++i) {

44 
CRV
[
i
] = 
	`ERV
(iè>> 
P
;

45 
CGU
[
i
] = 
	`EGU
(iè>> 
P
;

46 
CGV
[
i
] = 
	`EGV
(iè>> 
P
;

47 
CBU
[
i
] = 
	`EBU
(iè>> 
P
;

49 
	}
}

53 cÚ¡ 
št16_t
 
	gCRV
[256] = {

77 cÚ¡ 
št16_t
 
	gCGU
[256] = {

101 cÚ¡ 
št16_t
 
	gCGV
[256] = {

125 cÚ¡ 
št16_t
 
	gCBU
[256] = {

150 
šlše
 
	$yuv2rgb
(
ušt8_t
 *
rgb
, ušt8_ˆ
y
, 
ruv
, 
guv
, 
buv
)

152 *
rgb
++ = 
	`§tu¿‹_u8
(
y
 + 
buv
);

153 *
rgb
++ = 
	`§tu¿‹_u8
(
y
 + 
guv
);

154 *
rgb
++ = 
	`§tu¿‹_u8
(
y
 + 
ruv
);

155 *
rgb
 = 0;

156 
	}
}

159 
šlše
 
	$yuv2rgb565
(
ušt8_t
 *
rgb
, ušt8_ˆ
y
,

160 
ruv
, 
guv
, 
buv
)

162 
r
 = 
	`§tu¿‹_u8
(
y
 + 
ruv
) >> 3;

163 
g
 = 
	`§tu¿‹_u8
(
y
 + 
guv
) >> 2;

164 
b
 = 
	`§tu¿‹_u8
(
y
 + 
buv
) >> 3;

166 
rgb
[1] = 
r
 << 3 | 
g
 >> 3;

167 
rgb
[0] = 
g
 << 5 | 
b
;

168 
	}
}

171 
šlše
 
	$yuv2rgb555
(
ušt8_t
 *
rgb
, ušt8_ˆ
y
,

172 
ruv
, 
guv
, 
buv
)

174 
ušt8_t
 
r
 = 
	`§tu¿‹_u8
(
y
 + 
ruv
) >> 3;

175 
ušt8_t
 
g
 = 
	`§tu¿‹_u8
(
y
 + 
guv
) >> 3;

176 
ušt8_t
 
b
 = 
	`§tu¿‹_u8
(
y
 + 
buv
) >> 3;

178 
rgb
[1] = 
r
 << 2 | 
g
 >> 3;

179 
rgb
[0] = 
g
 << 5 | 
b
;

180 
	}
}

183 
šlše
 
	$_yuv2rgb
(
ušt8_t
 *
rgb
, ušt8_ˆ
y
, ušt8_ˆ
u
, ušt8_ˆ
v
)

185 
ruv
, 
guv
, 
buv
;

187 
ruv
 = 
CRV
[
v
];

188 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

189 
buv
 = 
CBU
[
u
];

191 
	`yuv2rgb
(
rgb
, 
y
, 
ruv
, 
guv
, 
buv
);

192 
	}
}

195 (
	tlše_h
)(
	txoffs
, 
	twidth
, 
	trw
,

196 
	tyd
, 
	tys
, 
	tys2
,

197 
	tušt8_t
 *
	tdd0
, ušt8_ˆ*
	tdd1
, ušt8_ˆ*
	tdd2
,

198 
	tlsd
,

199 cÚ¡ 
	tušt8_t
 *
	tsd0
, cÚ¡ ušt8_ˆ*
	tsd1
,

200 cÚ¡ 
	tušt8_t
 *
	tsd2
, 
	tlss
);

203 
	$yuv420p_to_yuv420p
(
xoffs
, 
width
, 
rw
,

204 
yd
, 
ys
, 
ys2
,

205 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

206 
lsd
,

207 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

208 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


211 
x
, 
xd
, 
xs
, 
xs2
;

212 
id
, 
is
;

214 
x
=0; x<
width
; x+=2) {

216 
xd
 = 
x
 + 
xoffs
;

218 
xs
 = ()(
x
 * 
rw
);

219 
xs2
 = ()((
x
+1è* 
rw
);

221 
id
 = 
xd
 + 
yd
*
lsd
;

223 
dd0
[
id
] = 
ds0
[
xs
 + 
ys
*
lss
];

224 
dd0
[
id
+1] = 
ds0
[
xs2
 + 
ys
*
lss
];

225 
dd0
[
id
 + 
lsd
] = 
ds0
[
xs
 + 
ys2
*
lss
];

226 
dd0
[
id
+1 + 
lsd
] = 
ds0
[
xs2
 + 
ys2
*
lss
];

228 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

229 
is
 = (
xs
>>1è+ (
ys
>>1)*
lss
/2;

231 
dd1
[
id
] = 
ds1
[
is
];

232 
dd2
[
id
] = 
ds2
[
is
];

234 
	}
}

237 
	$yuyv422_to_yuv420p
(
xoffs
, 
width
, 
rw
,

238 
yd
, 
ys
, 
ys2
,

239 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

240 
lsd
,

241 cÚ¡ 
ušt8_t
 *
sd0
, cÚ¡ ušt8_ˆ*
sd1
,

242 cÚ¡ 
ušt8_t
 *
sd2
, 
lss


245 
x
, 
xd
, 
xs
;

246 
id
, 
is
, 
is2
;

248 ()
sd1
;

249 ()
sd2
;

251 
x
=0; x<
width
; x+=2) {

253 
xd
 = 
x
 + 
xoffs
;

255 
xs
 = (()(
x
 * 
rw
 * 2)) & ~3;

257 
id
 = 
xd
 + 
yd
*
lsd
;

258 
is
 = 
xs
 + 
ys
*
lss
;

259 
is2
 = 
xs
 + 
ys2
*
lss
;

261 
dd0
[
id
] = 
sd0
[
is
];

262 
dd0
[
id
+1] = 
sd0
[
is
 + 2];

263 
dd0
[
id
 + 
lsd
] = 
sd0
[
is2
];

264 
dd0
[
id
+1 + 
lsd
] = 
sd0
[
is2
 + 2];

266 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

268 
dd1
[
id
] = 
sd0
[
is
 + 1];

269 
dd2
[
id
] = 
sd0
[
is
 + 3];

271 
	}
}

274 
	$uyvy422_to_yuv420p
(
xoffs
, 
width
, 
rw
,

275 
yd
, 
ys
, 
ys2
,

276 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

277 
lsd
,

278 cÚ¡ 
ušt8_t
 *
sd0
, cÚ¡ ušt8_ˆ*
sd1
,

279 cÚ¡ 
ušt8_t
 *
sd2
, 
lss


282 
x
, 
xd
, 
xs
;

283 
id
, 
is
, 
is2
;

285 ()
sd1
;

286 ()
sd2
;

288 
x
=0; x<
width
; x+=2) {

290 
xd
 = 
x
 + 
xoffs
;

292 
xs
 = (()(
x
 * 
rw
 * 2)) & ~3;

294 
id
 = 
xd
 + 
yd
*
lsd
;

295 
is
 = 
xs
 + 
ys
*
lss
;

296 
is2
 = 
xs
 + 
ys2
*
lss
;

298 
dd0
[
id
] = 
sd0
[
is
 + 1];

299 
dd0
[
id
+1] = 
sd0
[
is
 + 3];

300 
dd0
[
id
 + 
lsd
] = 
sd0
[
is2
 + 1];

301 
dd0
[
id
+1 + 
lsd
] = 
sd0
[
is2
 + 3];

303 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

305 
dd1
[
id
] = 
sd0
[
is
 + 0];

306 
dd2
[
id
] = 
sd0
[
is
 + 2];

308 
	}
}

311 
	$rgb32_to_yuv420p
(
xoffs
, 
width
, 
rw
,

312 
yd
, 
ys
, 
ys2
,

313 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

314 
lsd
,

315 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

316 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


319 
x
, 
xd
, 
xs
, 
xs2
;

320 
id
;

322 ()
ds1
;

323 ()
ds2
;

325 
x
=0; x<
width
; x+=2) {

327 
ušt32_t
 
x0
;

328 
ušt32_t
 
x1
;

329 
ušt32_t
 
x2
;

330 
ušt32_t
 
x3
;

332 
xd
 = 
x
 + 
xoffs
;

334 
xs
 = 4 * (()Ğ
x
 * 
rw
));

335 
xs2
 = 4 * (()((
x
+1è* 
rw
));

337 
id
 = 
xd
 + 
yd
*
lsd
;

339 
x0
 = *(
ušt32_t
 *)(*)&
ds0
[
xs
 + 
ys
*
lss
];

340 
x1
 = *(
ušt32_t
 *)(*)&
ds0
[
xs2
 + 
ys
*
lss
];

341 
x2
 = *(
ušt32_t
 *)(*)&
ds0
[
xs
 + 
ys2
*
lss
];

342 
x3
 = *(
ušt32_t
 *)(*)&
ds0
[
xs2
 + 
ys2
*
lss
];

344 
dd0
[
id
] = 
	`rgb2y
(
x0
 >> 16, x0 >> 8, x0);

345 
dd0
[
id
+1] = 
	`rgb2y
(
x1
 >> 16, x1 >> 8, x1);

346 
dd0
[
id
 + 
lsd
] = 
	`rgb2y
(
x2
 >> 16, x2 >> 8, x2);

347 
dd0
[
id
+1 + 
lsd
] = 
	`rgb2y
(
x3
 >> 16, x3 >> 8, x3);

349 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

351 
dd1
[
id
] = 
	`rgb2u
(
x0
 >> 16, x0 >> 8, x0);

352 
dd2
[
id
] = 
	`rgb2v
(
x0
 >> 16, x0 >> 8, x0);

354 
	}
}

357 
	$rgb32_to_yuv444p
(
xoffs
, 
width
, 
rw
,

358 
yd
, 
ys
, 
ys2
,

359 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

360 
lsd
,

361 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

362 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


365 
x
, 
xd
, 
xs
;

366 
id
;

368 ()
ds1
;

369 ()
ds2
;

371 
x
=0; x<
width
; x++) {

373 
ušt32_t
 
x0
;

374 
ušt32_t
 
x1
;

376 
xd
 = 
x
 + 
xoffs
;

378 
xs
 = 4 * (()(
x
 * 
rw
));

380 
id
 = 
xd
 + 
yd
*
lsd
;

382 
x0
 = *(
ušt32_t
 *)(*)&
ds0
[
xs
 + 
ys
 *
lss
];

383 
x1
 = *(
ušt32_t
 *)(*)&
ds0
[
xs
 + 
ys2
*
lss
];

385 
dd0
[
id
] = 
	`rgb2y
(
x0
 >> 16, x0 >> 8, x0);

386 
dd0
[
id
 + 
lsd
] = 
	`rgb2y
(
x1
 >> 16, x1 >> 8, x1);

388 
dd1
[
id
] = 
	`rgb2u
(
x0
 >> 16, x0 >> 8, x0);

389 
dd1
[
id
 + 
lsd
] = 
	`rgb2u
(
x1
 >> 16, x1 >> 8, x1);

391 
dd2
[
id
] = 
	`rgb2v
(
x0
 >> 16, x0 >> 8, x0);

392 
dd2
[
id
 + 
lsd
] = 
	`rgb2v
(
x1
 >> 16, x1 >> 8, x1);

394 
	}
}

397 
	$yuv420p_to_rgb32
(
xoffs
, 
width
, 
rw
,

398 
yd
, 
ys
, 
ys2
,

399 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

400 
lsd
,

401 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

402 cÚ¡ 
ušt8_t
 *
ds2
, 
lss
)

404 
x
, 
xd
, 
xs
, 
xs2
;

405 
id
, 
is
;

407 ()
dd1
;

408 ()
dd2
;

410 
x
=0; x<
width
; x+=2) {

412 
ruv
, 
guv
, 
buv
;

413 
ušt8_t
 
u
, 
v
;

415 
xd
 = (
x
 + 
xoffs
) * 4;

417 
xs
 = ()(
x
 * 
rw
);

418 
xs2
 = ()((
x
+1è* 
rw
);

420 
id
 = (
xd
 + 
yd
*
lsd
);

421 
is
 = (
xs
>>1è+ (
ys
>>1)*
lss
/2;

423 
u
 = 
ds1
[
is
];

424 
v
 = 
ds2
[
is
];

426 
ruv
 = 
CRV
[
v
];

427 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

428 
buv
 = 
CBU
[
u
];

430 
	`yuv2rgb
(&
dd0
[
id
], 
ds0
[
xs
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

431 
	`yuv2rgb
(&
dd0
[
id
+4], 
ds0
[
xs2
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

432 
	`yuv2rgb
(&
dd0
[
id
 + 
lsd
], 
ds0
[
xs
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

433 
	`yuv2rgb
(&
dd0
[
id
+4 + 
lsd
], 
ds0
[
xs2
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

435 
	}
}

438 
	$yuv420p_to_rgb565
(
xoffs
, 
width
, 
rw
,

439 
yd
, 
ys
, 
ys2
,

440 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

441 
lsd
,

442 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

443 cÚ¡ 
ušt8_t
 *
ds2
, 
lss
)

445 
x
, 
xd
, 
xs
, 
xs2
;

446 
id
, 
is
;

448 ()
dd1
;

449 ()
dd2
;

451 
x
=0; x<
width
; x+=2) {

453 
ruv
, 
guv
, 
buv
;

454 
ušt8_t
 
u
, 
v
;

456 
xd
 = (
x
 + 
xoffs
) * 2;

458 
xs
 = ()(
x
 * 
rw
);

459 
xs2
 = ()((
x
+1è* 
rw
);

461 
id
 = (
xd
 + 
yd
*
lsd
);

462 
is
 = (
xs
>>1è+ (
ys
>>1)*
lss
/2;

464 
u
 = 
ds1
[
is
];

465 
v
 = 
ds2
[
is
];

467 
ruv
 = 
CRV
[
v
];

468 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

469 
buv
 = 
CBU
[
u
];

471 
	`yuv2rgb565
(&
dd0
[
id
], 
ds0
[
xs
 + 
ys
*
lss
], 
ruv
, 
guv
,
buv
);

472 
	`yuv2rgb565
(&
dd0
[
id
+2], 
ds0
[
xs2
 + 
ys
*
lss
], 
ruv
, 
guv
,
buv
);

473 
	`yuv2rgb565
(&
dd0
[
id
 + 
lsd
], 
ds0
[
xs
 + 
ys2
*
lss
], 
ruv
, 
guv
,
buv
);

474 
	`yuv2rgb565
(&
dd0
[
id
+2 + 
lsd
], 
ds0
[
xs2
 + 
ys2
*
lss
], 
ruv
, 
guv
,
buv
);

476 
	}
}

479 
	$yuv420p_to_rgb555
(
xoffs
, 
width
, 
rw
,

480 
yd
, 
ys
, 
ys2
,

481 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

482 
lsd
,

483 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

484 cÚ¡ 
ušt8_t
 *
ds2
, 
lss
)

486 
x
, 
xd
, 
xs
, 
xs2
;

487 
id
, 
is
;

489 ()
dd1
;

490 ()
dd2
;

492 
x
=0; x<
width
; x+=2) {

494 
ruv
, 
guv
, 
buv
;

495 
ušt8_t
 
u
, 
v
;

497 
xd
 = (
x
 + 
xoffs
) * 2;

499 
xs
 = ()(
x
 * 
rw
);

500 
xs2
 = ()((
x
+1è* 
rw
);

502 
id
 = (
xd
 + 
yd
*
lsd
);

503 
is
 = (
xs
>>1è+ (
ys
>>1)*
lss
/2;

505 
u
 = 
ds1
[
is
];

506 
v
 = 
ds2
[
is
];

508 
ruv
 = 
CRV
[
v
];

509 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

510 
buv
 = 
CBU
[
u
];

512 
	`yuv2rgb555
(&
dd0
[
id
], 
ds0
[
xs
 + 
ys
*
lss
], 
ruv
, 
guv
,
buv
);

513 
	`yuv2rgb555
(&
dd0
[
id
+2], 
ds0
[
xs2
 + 
ys
*
lss
], 
ruv
, 
guv
,
buv
);

514 
	`yuv2rgb555
(&
dd0
[
id
 + 
lsd
], 
ds0
[
xs
 + 
ys2
*
lss
], 
ruv
, 
guv
,
buv
);

515 
	`yuv2rgb555
(&
dd0
[
id
+2 + 
lsd
], 
ds0
[
xs2
 + 
ys2
*
lss
], 
ruv
, 
guv
,
buv
);

517 
	}
}

520 
	$nv12_to_yuv420p
(
xoffs
, 
width
, 
rw
,

521 
yd
, 
ys
, 
ys2
,

522 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

523 
lsd
,

524 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

525 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


528 
x
, 
xd
, 
xs
, 
xs2
;

529 
id
, 
is
;

531 ()
ds2
;

533 
x
=0; x<
width
; x+=2) {

535 
xd
 = 
x
 + 
xoffs
;

537 
xs
 = ()(
x
 * 
rw
);

538 
xs2
 = ()((
x
+1è* 
rw
);

540 
id
 = 
xd
 + 
yd
*
lsd
;

542 
dd0
[
id
] = 
ds0
[
xs
 + 
ys
*
lss
];

543 
dd0
[
id
+1] = 
ds0
[
xs2
 + 
ys
*
lss
];

544 
dd0
[
id
 + 
lsd
] = 
ds0
[
xs
 + 
ys2
*
lss
];

545 
dd0
[
id
+1 + 
lsd
] = 
ds0
[
xs2
 + 
ys2
*
lss
];

547 
id
 = (
xd
>>1è+ (
yd
>>1)*
lsd
/2;

548 
is
 = 
xs
/2 + 
ys
*
lss
/4;

550 
dd1
[
id
] = 
ds1
[2*
is
];

551 
dd2
[
id
] = 
ds1
[2*
is
+1];

553 
	}
}

556 
	$yuv420p_to_nv12
(
xoffs
, 
width
, 
rw
,

557 
yd
, 
ys
, 
ys2
,

558 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

559 
lsd
,

560 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

561 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


564 
x
, 
xd
, 
xs
, 
xs2
;

565 
id
, 
is
;

567 ()
dd2
;

569 
x
=0; x<
width
; x+=2) {

571 
xd
 = 
x
 + 
xoffs
;

573 
xs
 = ()(
x
 * 
rw
);

574 
xs2
 = ()((
x
+1è* 
rw
);

576 
id
 = 
xd
 + 
yd
*
lsd
;

578 
dd0
[
id
] = 
ds0
[
xs
 + 
ys
*
lss
];

579 
dd0
[
id
+1] = 
ds0
[
xs2
 + 
ys
*
lss
];

580 
dd0
[
id
 + 
lsd
] = 
ds0
[
xs
 + 
ys2
*
lss
];

581 
dd0
[
id
+1 + 
lsd
] = 
ds0
[
xs2
 + 
ys2
*
lss
];

583 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

584 
is
 = (
xs
>>1è+ (
ys
>>1)*
lss
/2;

586 
dd1
[2*
id
] = 
ds1
[
is
];

587 
dd1
[2*
id
+1] = 
ds2
[
is
];

589 
	}
}

592 
	$nv21_to_yuv420p
(
xoffs
, 
width
, 
rw
,

593 
yd
, 
ys
, 
ys2
,

594 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

595 
lsd
,

596 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

597 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


600 
x
, 
xd
, 
xs
, 
xs2
;

601 
id
, 
is
;

603 ()
ds2
;

605 
x
=0; x<
width
; x+=2) {

607 
xd
 = 
x
 + 
xoffs
;

609 
xs
 = ()(
x
 * 
rw
);

610 
xs2
 = ()((
x
+1è* 
rw
);

612 
id
 = 
xd
 + 
yd
*
lsd
;

614 
dd0
[
id
] = 
ds0
[
xs
 + 
ys
*
lss
];

615 
dd0
[
id
+1] = 
ds0
[
xs2
 + 
ys
*
lss
];

616 
dd0
[
id
 + 
lsd
] = 
ds0
[
xs
 + 
ys2
*
lss
];

617 
dd0
[
id
+1 + 
lsd
] = 
ds0
[
xs2
 + 
ys2
*
lss
];

619 
id
 = 
xd
/2 + 
yd
*
lsd
/4;

620 
is
 = ((
xs
>>1è+ (
ys
>>1)*
lss
/2) & ~1;

622 
dd2
[
id
] = 
ds1
[2*
is
];

623 
dd1
[
id
] = 
ds1
[2*
is
+1];

625 
	}
}

628 
	$yuv444p_to_rgb32
(
xoffs
, 
width
, 
rw
,

629 
yd
, 
ys
, 
ys2
,

630 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

631 
lsd
,

632 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

633 cÚ¡ 
ušt8_t
 *
ds2
, 
lss
)

635 
x
, 
xd
, 
xs
;

636 
id
;

637 
is1
, 
is2
;

639 ()
dd1
;

640 ()
dd2
;

642 
x
=0; x<
width
; x++) {

644 
xd
 = (
x
 + 
xoffs
) * 4;

646 
xs
 = ()(
x
 * 
rw
);

648 
id
 = 
xd
 + 
yd
*
lsd
;

650 
is1
 = 
xs
 + 
ys
 *
lss
;

651 
is2
 = 
xs
 + 
ys2
*
lss
;

653 
	`_yuv2rgb
(&
dd0
[
id
], 
ds0
[
is1
], 
ds1
[is1], 
ds2
[is1]);

654 
	`_yuv2rgb
(&
dd0
[
id
 + 
lsd
], 
ds0
[
is2
], 
ds1
[is2], 
ds2
[is2]);

656 
	}
}

659 
	$nv12_to_rgb32
(
xoffs
, 
width
, 
rw
,

660 
yd
, 
ys
, 
ys2
,

661 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

662 
lsd
,

663 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

664 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


667 
x
, 
xd
, 
xs
, 
xs2
;

668 
id
, 
is
;

670 ()
ds2
;

671 ()
dd1
;

672 ()
dd2
;

674 
x
=0; x<
width
; x+=2) {

675 
ruv
, 
guv
, 
buv
;

676 
ušt8_t
 
u
, 
v
;

678 
xd
 = (
x
 + 
xoffs
) * 4;

680 
xs
 = ()(
x
 * 
rw
);

681 
xs2
 = ()((
x
+1è* 
rw
);

683 
id
 = (
xd
 + 
yd
*
lsd
);

684 
is
 = 
xs
/2 + 
ys
*
lss
/4;

686 
u
 = 
ds1
[2*
is
];

687 
v
 = 
ds1
[2*
is
+1];

688 
ruv
 = 
CRV
[
v
];

689 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

690 
buv
 = 
CBU
[
u
];

692 
	`yuv2rgb
(&
dd0
[
id
], 
ds0
[
xs
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

693 
	`yuv2rgb
(&
dd0
[
id
+4], 
ds0
[
xs2
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

694 
	`yuv2rgb
(&
dd0
[
id
 + 
lsd
], 
ds0
[
xs
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

695 
	`yuv2rgb
(&
dd0
[
id
+4 + 
lsd
], 
ds0
[
xs2
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

697 
	}
}

700 
	$nv21_to_rgb32
(
xoffs
, 
width
, 
rw
,

701 
yd
, 
ys
, 
ys2
,

702 
ušt8_t
 *
dd0
, ušt8_ˆ*
dd1
, ušt8_ˆ*
dd2
,

703 
lsd
,

704 cÚ¡ 
ušt8_t
 *
ds0
, cÚ¡ ušt8_ˆ*
ds1
,

705 cÚ¡ 
ušt8_t
 *
ds2
, 
lss


708 
x
, 
xd
, 
xs
, 
xs2
;

709 
id
, 
is
;

711 ()
ds2
;

712 ()
dd1
;

713 ()
dd2
;

715 
x
=0; x<
width
; x+=2) {

716 
ruv
, 
guv
, 
buv
;

717 
ušt8_t
 
u
, 
v
;

719 
xd
 = (
x
 + 
xoffs
) * 4;

721 
xs
 = ()(
x
 * 
rw
);

722 
xs2
 = ()((
x
+1è* 
rw
);

724 
id
 = (
xd
 + 
yd
*
lsd
);

725 
is
 = 
xs
/2 + 
ys
*
lss
/4;

727 
v
 = 
ds1
[2*
is
];

728 
u
 = 
ds1
[2*
is
+1];

729 
ruv
 = 
CRV
[
v
];

730 
guv
 = 
CGV
[
v
] + 
CGU
[
u
];

731 
buv
 = 
CBU
[
u
];

733 
	`yuv2rgb
(&
dd0
[
id
], 
ds0
[
xs
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

734 
	`yuv2rgb
(&
dd0
[
id
+4], 
ds0
[
xs2
 + 
ys
*
lss
], 
ruv
, 
guv
, 
buv
);

735 
	`yuv2rgb
(&
dd0
[
id
 + 
lsd
], 
ds0
[
xs
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

736 
	`yuv2rgb
(&
dd0
[
id
+4 + 
lsd
], 
ds0
[
xs2
 + 
ys2
*
lss
], 
ruv
, 
guv
, 
buv
);

738 
	}
}

741 
	#MAX_SRC
 10

	)

742 
	#MAX_DST
 10

	)

750 
lše_h
 *
	gcÚv_bË
[
MAX_SRC
][
MAX_DST
] = {

755 {
yuv420p_to_yuv420p
, 
NULL
, NULL, 
yuv420p_to_rgb32
, NULL,

756 
yuv420p_to_rgb565
, 
yuv420p_to_rgb555
, 
yuv420p_to_nv12
},

757 {
yuyv422_to_yuv420p
, 
NULL
, NULL, NULL, NULL, NULL, NULL},

758 {
uyvy422_to_yuv420p
, 
NULL
, NULL, NULL, NULL, NULL, NULL},

759 {
rgb32_to_yuv420p
, 
NULL
, NULL, NULL, NULL, NULL, NULL,

760 
NULL
, NULL, 
rgb32_to_yuv444p
},

761 {
rgb32_to_yuv420p
, 
NULL
, NULL, NULL, NULL, NULL, NULL},

762 {
NULL
, NULL, NULL, NULL, NULL, NULL, NULL},

763 {
NULL
, NULL, NULL, NULL, NULL, NULL, NULL},

764 {
nv12_to_yuv420p
, 
NULL
, NULL, 
nv12_to_rgb32
,

765 
NULL
, NULL, NULL},

766 {
nv21_to_yuv420p
, 
NULL
, NULL, 
nv21_to_rgb32
,

767 
NULL
, NULL, NULL},

768 {
NULL
, NULL, NULL, 
yuv444p_to_rgb32
}

783 
	$vidcÚv
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
,

784 
vid»ù
 *
r
)

786 
vid»ù
 
rd¡
;

787 
yd
, 
ys
, 
ys2
, 
lsd
, 
lss
, 
y
;

788 cÚ¡ 
ušt8_t
 *
ds0
, *
ds1
, *
ds2
;

789 
ušt8_t
 *
dd0
, *
dd1
, *
dd2
;

790 
rw
, 
rh
;

791 
lše_h
 *
lšeh
 = 
NULL
;

793 ià(!
	`vidäame_isv®id
(
d¡
è|| !vidäame_isv®id(
¤c
))

796 ià(
¤c
->
fmt
 < 
MAX_SRC
 && 
d¡
->fmˆ< 
MAX_DST
) {

799 
lšeh
 = 
cÚv_bË
[
¤c
->
fmt
][
d¡
->fmt];

801 ià(!
lšeh
) {

802 ()
	`»_´štf
("vidconv:‚o…ixel converter found for"

803 " % -> %s\n", 
	`vidfmt_Çme
(
¤c
->
fmt
),

804 
	`vidfmt_Çme
(
d¡
->
fmt
));

808 ià(
r
) {

809 
r
->
x
 &= ~1;

810 
r
->
y
 &= ~1;

811 
r
->
w
 &= ~1;

812 
r
->
h
 &= ~1;

814 ià((
r
->
x
 +„->
w
è> 
d¡
->
size
.w ||

815 (
r
->
y
 +„->
h
è> 
d¡
->
size
.h) {

816 ()
	`»_´štf
("vidconv: out of bounds (%u x %u)\n",

817 
d¡
->
size
.
w
, d¡->size.
h
);

822 
rd¡
.
x
 =„d¡.
y
 = 0;

823 
rd¡
.
w
 = 
d¡
->
size
.w & ~1;

824 
rd¡
.
h
 = 
d¡
->
size
.h & ~1;

825 
r
 = &
rd¡
;

828 
rw
 = ()
¤c
->
size
.
w
 / ()
r
->w;

829 
rh
 = ()
¤c
->
size
.
h
 / ()
r
->h;

831 
lsd
 = 
d¡
->
lšesize
[0];

832 
lss
 = 
¤c
->
lšesize
[0];

834 
dd0
 = 
d¡
->
d©a
[0];

835 
dd1
 = 
d¡
->
d©a
[1];

836 
dd2
 = 
d¡
->
d©a
[2];

838 
ds0
 = 
¤c
->
d©a
[0];

839 
ds1
 = 
¤c
->
d©a
[1];

840 
ds2
 = 
¤c
->
d©a
[2];

842 
y
=0; y<
r
->
h
; y+=2) {

844 
yd
 = 
y
 + 
r
->y;

846 
ys
 = ()(
y
 * 
rh
);

847 
ys2
 = ()((
y
+1è* 
rh
);

849 
	`lšeh
(
r
->
x
,„->
w
, 
rw
, 
yd
, 
ys
, 
ys2
,

850 
dd0
, 
dd1
, 
dd2
, 
lsd
,

851 
ds0
, 
ds1
, 
ds2
, 
lss
);

853 
	}
}

863 
	$vidcÚv_a¥eù
(
vidäame
 *
d¡
, cÚ¡ vidäam*
¤c
,

864 
vid»ù
 *
r
)

866 
vidsz
 
asz
;

867 
¬
;

869 
¬
 = ()
¤c
->
size
.
w
 / ()¤c->size.
h
;

871 
asz
.
w
 = 
r
->w;

872 
asz
.
h
 = 
r
->h;

874 
r
->
w
 = ()
	`mš
(()
asz
.w, (ïsz.
h
 * 
¬
);

875 
r
->
h
 = ()
	`mš
(()
asz
.h, (ïsz.
w
 / 
¬
);

876 
r
->
x
 =„->x + (
asz
.
w
 -„->w) / 2;

877 
r
->
y
 =„->y + (
asz
.
h
 -„->h) / 2;

879 
	`vidcÚv
(
d¡
, 
¤c
, 
r
);

880 
	}
}

	@rem-0.5.2/src/vidmix/vidmix.c

7 
	#_BSD_SOURCE
 1

	)

8 
	#_DEFAULT_SOURCE
 1

	)

9 
	~<uni¡d.h
>

10 
	#__USE_UNIX98
 1

	)

11 
	~<±h»ad.h
>

12 
	~<¡ršg.h
>

13 
	~<».h
>

14 
	~<»m_vid.h
>

15 
	~<»m_vidcÚv.h
>

16 
	~<»m_vidmix.h
>

19 
	svidmix
 {

20 
±h»ad_rwlock_t
 
	mrwlock
;

21 
li¡
 
	m¤ş
;

22 
boŞ
 
	mš™Ÿlized
;

25 
	svidmix_sourû
 {

26 
Ë
 
	mË
;

27 
±h»ad_t
 
	mth»ad
;

28 
±h»ad_mu‹x_t
 
	mmu‹x
;

29 
vidäame
 *
	mäame_tx
;

30 
vidäame
 *
	mäame_rx
;

31 
vidmix
 *
	mmix
;

32 
vidmix_äame_h
 *
	mfh
;

33 *
	m¬g
;

34 *
	mfocus
;

35 
boŞ
 
	mcÚ‹Á_hide
;

36 
boŞ
 
	mfocus_fuÎ
;

37 
	mfšt
;

38 
boŞ
 
	m£lfv›w
;

39 
boŞ
 
	mcÚ‹Á
;

40 
boŞ
 
	mş—r
;

41 
boŞ
 
	mrun
;

45 
šlše
 
sourû_mix_fuÎ
(
vidäame
 *
mäame
,

46 cÚ¡ 
vidäame
 *
äame_¤c
);

49 
šlše
 
	$ş—r_äame
(
vidäame
 *
vf
)

51 
	`vidäame_fl
(
vf
, 0, 0, 0);

52 
	}
}

55 
	$ş—r_®l
(
vidmix
 *
mix
)

57 
Ë
 *le;

59 
Ë
=
mix
->
¤ş
.
h—d
;†e;†eöe->
Ãxt
) {

61 
vidmix_sourû
 *
¤c
 = 
Ë
->
d©a
;

63 
¤c
->
ş—r
 = 
Œue
;

65 
	}
}

68 
	$de¡ruùÜ
(*
¬g
)

70 
vidmix
 *
mix
 = 
¬g
;

72 ià(
mix
->
š™Ÿlized
)

73 ()
	`±h»ad_rwlock_de¡roy
(&
mix
->
rwlock
);

74 
	}
}

77 
	$sourû_de¡ruùÜ
(*
¬g
)

79 
vidmix_sourû
 *
¤c
 = 
¬g
;

81 ià(
¤c
->
run
) {

82 
¤c
->
run
 = 
çl£
;

83 
	`±h»ad_još
(
¤c
->
th»ad
, 
NULL
);

86 ià(
¤c
->
Ë
.
li¡
) {

87 
	`±h»ad_rwlock_w¾ock
(&
¤c
->
mix
->
rwlock
);

88 
	`li¡_uÆšk
(&
¤c
->
Ë
);

89 
	`ş—r_®l
(
¤c
->
mix
);

90 
	`±h»ad_rwlock_uÆock
(&
¤c
->
mix
->
rwlock
);

93 
	`mem_d”ef
(
¤c
->
äame_tx
);

94 
	`mem_d”ef
(
¤c
->
äame_rx
);

95 
	`mem_d”ef
(
¤c
->
mix
);

96 
	}
}

99 
šlše
 
	$sourû_mix
(
vidäame
 *
mäame
,

100 cÚ¡ 
vidäame
 *
äame_¤c
,

101 
n
, 
rows
, 
idx
,

102 
boŞ
 
focus
, boŞ 
focus_this
, boŞ 
focus_fuÎ
)

104 
vid»ù
 
»ù
;

106 ià(!
äame_¤c
)

109 ià(
focus
) {

111 cÚ¡ 
nmš
 = 
focus_fuÎ
 ? 12 : 6;

113 
n
 = 
	`max
(Ò+1), 
nmš
)/2;

115 ià(
focus_this
) {

116 
»ù
.
w
 = 
mäame
->
size
.w * (
n
-1) /‚;

117 
»ù
.
h
 = 
mäame
->
size
.h * (
n
-1) /‚;

118 
»ù
.
x
 = 0;

119 
»ù
.
y
 = 0;

122 
»ù
.
w
 = 
mäame
->
size
.w / 
n
;

123 
»ù
.
h
 = 
mäame
->
size
.h / 
n
;

125 ià(
idx
 < 
n
) {

126 
»ù
.
x
 = 
mäame
->
size
.
w
 -„ect.w;

127 
»ù
.
y
 =„eù.
h
 * 
idx
;

129 ià(
idx
 < (
n
*2 - 1)) {

130 
»ù
.
x
 =„eù.
w
 * (
n
*2 - 2 - 
idx
);

131 
»ù
.
y
 = 
mäame
->
size
.
h
 -„ect.h;

138 ià(
rows
 == 1) {

140 
	`sourû_mix_fuÎ
(
mäame
, 
äame_¤c
);

144 
»ù
.
w
 = 
mäame
->
size
.w / 
rows
;

145 
»ù
.
h
 = 
mäame
->
size
.h / 
rows
;

146 
»ù
.
x
 =„eù.
w
 * (
idx
 % 
rows
);

147 
»ù
.
y
 =„eù.
h
 * (
idx
 / 
rows
);

150 
	`vidcÚv_a¥eù
(
mäame
, 
äame_¤c
, &
»ù
);

151 
	}
}

154 
šlše
 
	$sourû_mix_fuÎ
(
vidäame
 *
mäame
,

155 cÚ¡ 
vidäame
 *
äame_¤c
)

157 ià(!
äame_¤c
)

160 ià(
	`vidsz_cmp
(&
mäame
->
size
, &
äame_¤c
->size)) {

162 
	`vidäame_cİy
(
mäame
, 
äame_¤c
);

165 
vid»ù
 
»ù
;

167 
»ù
.
w
 = 
mäame
->
size
.w;

168 
»ù
.
h
 = 
mäame
->
size
.h;

169 
»ù
.
x
 = 0;

170 
»ù
.
y
 = 0;

172 
	`vidcÚv_a¥eù
(
mäame
, 
äame_¤c
, &
»ù
);

174 
	}
}

177 
šlše
 
	$ÿlc_rows
(
n
)

179 
rows
;

181 
rows
=1;;„ows++)

182 ià(
n
 <ğ(
rows
 *„ows))

183  
rows
;

184 
	}
}

187 *
	$vidmix_th»ad
(*
¬g
)

189 
vidmix_sourû
 *
¤c
 = 
¬g
;

190 
vidmix
 *
mix
 = 
¤c
->mix;

191 
ušt64_t
 
ts
 = 
	`tmr_jiff›s
();

193 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

195 
¤c
->
run
) {

197 
n
, 
rows
, 
idx
;

198 
Ë
 *le;

199 
ušt64_t
 
now
;

201 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

202 ()
	`u¦“p
(4000);

203 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

205 
now
 = 
	`tmr_jiff›s
();

207 ià(
ts
 > 
now
)

210 ià(!
¤c
->
äame_tx
) {

211 
ts
 +ğ
¤c
->
fšt
;

215 
	`±h»ad_rwlock_rdlock
(&
mix
->
rwlock
);

217 ià(
¤c
->
ş—r
) {

218 
	`ş—r_äame
(
¤c
->
äame_tx
);

219 
¤c
->
ş—r
 = 
çl£
;

222 
Ë
=
mix
->
¤ş
.
h—d
, 
n
=0;†e;†eöe->
Ãxt
) {

224 cÚ¡ 
vidmix_sourû
 *
l¤c
 = 
Ë
->
d©a
;

226 ià(
l¤c
 =ğ
¤c
 && !¤c->
£lfv›w
)

229 ià(
l¤c
->
cÚ‹Á
 && 
¤c
->
cÚ‹Á_hide
)

232 ià(
l¤c
 =ğ
¤c
->
focus
 && src->
focus_fuÎ
)

233 
	`sourû_mix_fuÎ
(
¤c
->
äame_tx
, 
l¤c
->
äame_rx
);

235 ++
n
;

238 
rows
 = 
	`ÿlc_rows
(
n
);

240 
Ë
=
mix
->
¤ş
.
h—d
, 
idx
=0;†e;†eöe->
Ãxt
) {

242 cÚ¡ 
vidmix_sourû
 *
l¤c
 = 
Ë
->
d©a
;

244 ià(
l¤c
 =ğ
¤c
 && !¤c->
£lfv›w
)

247 ià(
l¤c
->
cÚ‹Á
 && 
¤c
->
cÚ‹Á_hide
)

250 ià(
l¤c
 =ğ
¤c
->
focus
 && src->
focus_fuÎ
)

253 
	`sourû_mix
(
¤c
->
äame_tx
, 
l¤c
->
äame_rx
, 
n
, 
rows
, 
idx
,

254 
¤c
->
focus
 !ğ
NULL
, src->focu =ğ
l¤c
,

255 
¤c
->
focus_fuÎ
);

257 ià(
¤c
->
focus
 !ğ
l¤c
)

258 ++
idx
;

261 
	`±h»ad_rwlock_uÆock
(&
mix
->
rwlock
);

263 
¤c
->
	`fh
((
ušt32_t
)
ts
 * 90, src->
äame_tx
, src->
¬g
);

265 
ts
 +ğ
¤c
->
fšt
;

268 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

270  
NULL
;

271 
	}
}

274 *
	$cÚ‹Á_th»ad
(*
¬g
)

276 
vidmix_sourû
 *
¤c
 = 
¬g
;

277 
vidmix
 *
mix
 = 
¤c
->mix;

278 
ušt64_t
 
ts
 = 
	`tmr_jiff›s
();

280 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

282 
¤c
->
run
) {

284 
Ë
 *le;

285 
ušt64_t
 
now
;

287 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

288 ()
	`u¦“p
(4000);

289 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

291 
now
 = 
	`tmr_jiff›s
();

293 ià(
ts
 > 
now
)

296 
	`±h»ad_rwlock_rdlock
(&
mix
->
rwlock
);

298 
Ë
=
mix
->
¤ş
.
h—d
;†e;†eöe->
Ãxt
) {

300 cÚ¡ 
vidmix_sourû
 *
l¤c
 = 
Ë
->
d©a
;

302 ià(!
l¤c
->
cÚ‹Á
 || !l¤c->
äame_rx
 ||†¤ø=ğ
¤c
)

305 
¤c
->
	`fh
((
ušt32_t
)
ts
 * 90, 
l¤c
->
äame_rx
, src->
¬g
);

309 
	`±h»ad_rwlock_uÆock
(&
mix
->
rwlock
);

311 
ts
 +ğ
¤c
->
fšt
;

314 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

316  
NULL
;

317 
	}
}

327 
	$vidmix_®loc
(
vidmix
 **
mixp
)

329 
±h»ad_rwlock©Œ_t
 
©Œ
;

330 
vidmix
 *
mix
;

331 
”r
;

333 ià(!
mixp
)

334  
EINVAL
;

336 
mix
 = 
	`mem_z®loc
((*mix), 
de¡ruùÜ
);

337 ià(!
mix
)

338  
ENOMEM
;

340 
”r
 = 
	`±h»ad_rwlock©Œ_š™
(&
©Œ
);

341 ià(
”r
) {

342 
	`mem_d”ef
(
mix
);

343  
”r
;

346 #ià
	`defšed
(
LINUX
è&& defšed(
__GLIBC__
)

347 
”r
 = 
	`±h»ad_rwlock©Œ_£tkšd_Å
(&
©Œ
,

348 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
);

349 ià(
”r
)

350 
out
;

353 
”r
 = 
	`±h»ad_rwlock_š™
(&
mix
->
rwlock
, &
©Œ
);

354 ià(
”r
)

355 
out
;

357 
mix
->
š™Ÿlized
 = 
Œue
;

359 
out
:

360 ()
	`±h»ad_rwlock©Œ_de¡roy
(&
©Œ
);

362 ià(
”r
)

363 
	`mem_d”ef
(
mix
);

365 *
mixp
 = 
mix
;

367  
”r
;

368 
	}
}

384 
	$vidmix_sourû_®loc
(
vidmix_sourû
 **
¤ı
, 
vidmix
 *
mix
,

385 cÚ¡ 
vidsz
 *
sz
, 
ås
, 
boŞ
 
cÚ‹Á
,

386 
vidmix_äame_h
 *
fh
, *
¬g
)

388 
vidmix_sourû
 *
¤c
;

389 
”r
;

391 ià(!
¤ı
 || !
mix
 || !
ås
 || !
fh
)

392  
EINVAL
;

394 
¤c
 = 
	`mem_z®loc
((*¤c), 
sourû_de¡ruùÜ
);

395 ià(!
¤c
)

396  
ENOMEM
;

398 
¤c
->
mix
 = 
	`mem_»f
(mix);

399 
¤c
->
fšt
 = 1000/
ås
;

400 
¤c
->
cÚ‹Á
 = content;

401 
¤c
->
fh
 = fh;

402 
¤c
->
¬g
 =‡rg;

404 
”r
 = 
	`±h»ad_mu‹x_š™
(&
¤c
->
mu‹x
, 
NULL
);

405 ià(
”r
)

406 
out
;

408 ià(
sz
) {

409 
”r
 = 
	`vidäame_®loc
(&
¤c
->
äame_tx
, 
VID_FMT_YUV420P
, 
sz
);

410 ià(
”r
)

411 
out
;

413 
	`ş—r_äame
(
¤c
->
äame_tx
);

416 
out
:

417 ià(
”r
)

418 
	`mem_d”ef
(
¤c
);

420 *
¤ı
 = 
¤c
;

422  
”r
;

423 
	}
}

433 
boŞ
 
	$vidmix_sourû_i£ÇbËd
(cÚ¡ 
vidmix_sourû
 *
¤c
)

435  
¤c
 ? (¤c->
Ë
.
li¡
 !ğ
NULL
è: 
çl£
;

436 
	}
}

446 
boŞ
 
	$vidmix_sourû_i¤uÂšg
(cÚ¡ 
vidmix_sourû
 *
¤c
)

448  
¤c
 ? src->
run
 : 
çl£
;

449 
	}
}

459 *
	$vidmix_sourû_g‘_focus
(cÚ¡ 
vidmix_sourû
 *
¤c
)

461  
¤c
 ? src->
focus
 : 
NULL
;

462 
	}
}

471 
	$vidmix_sourû_’abË
(
vidmix_sourû
 *
¤c
, 
boŞ
 
’abË
)

473 ià(!
¤c
)

476 ià(
¤c
->
Ë
.
li¡
 && 
’abË
)

479 ià(!
¤c
->
Ë
.
li¡
 && !
’abË
)

482 
	`±h»ad_rwlock_w¾ock
(&
¤c
->
mix
->
rwlock
);

484 ià(
’abË
) {

485 ià(
¤c
->
äame_rx
)

486 
	`ş—r_äame
(
¤c
->
äame_rx
);

488 
	`li¡_­³nd
(&
¤c
->
mix
->
¤ş
, &¤c->
Ë
, src);

491 
	`li¡_uÆšk
(&
¤c
->
Ë
);

494 
	`ş—r_®l
(
¤c
->
mix
);

496 
	`±h»ad_rwlock_uÆock
(&
¤c
->
mix
->
rwlock
);

497 
	}
}

507 
	$vidmix_sourû_¡¬t
(
vidmix_sourû
 *
¤c
)

509 
”r
;

511 ià(!
¤c
)

512  
EINVAL
;

514 ià(
¤c
->
run
)

515  
EALREADY
;

517 
¤c
->
run
 = 
Œue
;

519 
”r
 = 
	`±h»ad_ü—‹
(&
¤c
->
th»ad
, 
NULL
,

520 
¤c
->
cÚ‹Á
 ? 
cÚ‹Á_th»ad
 : 
vidmix_th»ad
,

521 
¤c
);

522 ià(
”r
) {

523 
¤c
->
run
 = 
çl£
;

526  
”r
;

527 
	}
}

535 
	$vidmix_sourû_¡İ
(
vidmix_sourû
 *
¤c
)

537 ià(!
¤c
)

540 ià(
¤c
->
run
) {

541 
¤c
->
run
 = 
çl£
;

542 
	`±h»ad_još
(
¤c
->
th»ad
, 
NULL
);

544 
	}
}

555 
	$vidmix_sourû_£t_size
(
vidmix_sourû
 *
¤c
, cÚ¡ 
vidsz
 *
sz
)

557 
vidäame
 *
äame
;

558 
”r
;

560 ià(!
¤c
 || !
sz
)

561  
EINVAL
;

563 ià(
¤c
->
äame_tx
 && 
	`vidsz_cmp
(&¤c->äame_tx->
size
, 
sz
))

566 
”r
 = 
	`vidäame_®loc
(&
äame
, 
VID_FMT_YUV420P
, 
sz
);

567 ià(
”r
)

568  
”r
;

570 
	`ş—r_äame
(
äame
);

572 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

573 
	`mem_d”ef
(
¤c
->
äame_tx
);

574 
¤c
->
äame_tx
 = 
äame
;

575 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

578 
	}
}

587 
	$vidmix_sourû_£t_¿‹
(
vidmix_sourû
 *
¤c
, 
ås
)

589 ià(!
¤c
 || !
ås
)

592 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

593 
¤c
->
fšt
 = 1000/
ås
;

594 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

595 
	}
}

604 
	$vidmix_sourû_£t_cÚ‹Á_hide
(
vidmix_sourû
 *
¤c
, 
boŞ
 
hide
)

606 ià(!
¤c
)

609 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

610 
¤c
->
cÚ‹Á_hide
 = 
hide
;

611 
¤c
->
ş—r
 = 
Œue
;

612 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

613 
	}
}

621 
	$vidmix_sourû_toggË_£lfv›w
(
vidmix_sourû
 *
¤c
)

623 ià(!
¤c
)

626 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

627 
¤c
->
£lfv›w
 = !src->selfview;

628 
¤c
->
ş—r
 = 
Œue
;

629 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

630 
	}
}

640 
	$vidmix_sourû_£t_focus
(
vidmix_sourû
 *
¤c
,

641 cÚ¡ 
vidmix_sourû
 *
focus_¤c
,

642 
boŞ
 
focus_fuÎ
)

644 ià(!
¤c
)

647 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

648 
¤c
->
focus_fuÎ
 = focus_full;

649 
¤c
->
focus
 = (*)
focus_¤c
;

650 
¤c
->
ş—r
 = 
Œue
;

651 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

652 
	}
}

661 
	$vidmix_sourû_£t_focus_idx
(
vidmix_sourû
 *
¤c
, 
pidx
)

663 
boŞ
 
focus_fuÎ
 = 
çl£
;

664 *
focus
 = 
NULL
;

666 ià(!
¤c
)

669 ià(
pidx
 > 0) {

671 
Ë
 *le;

672 
i
;

674 
	`±h»ad_rwlock_rdlock
(&
¤c
->
mix
->
rwlock
);

676 
Ë
=
¤c
->
mix
->
¤ş
.
h—d
, 
i
=1;†e;†eöe->
Ãxt
) {

678 cÚ¡ 
vidmix_sourû
 *
l¤c
 = 
Ë
->
d©a
;

680 ià(
l¤c
 =ğ
¤c
 && !¤c->
£lfv›w
)

683 ià(
l¤c
->
cÚ‹Á
 && 
¤c
->
cÚ‹Á_hide
)

686 ià(
i
++ =ğ
pidx
) {

687 
focus
 = (*)
l¤c
;

692 
	`±h»ad_rwlock_uÆock
(&
¤c
->
mix
->
rwlock
);

695 ià(
focus
 && focu =ğ
¤c
->focus)

696 
focus_fuÎ
 = !
¤c
->focus_full;

698 
	`±h»ad_mu‹x_lock
(&
¤c
->
mu‹x
);

699 
¤c
->
focus_fuÎ
 = focus_full;

700 
¤c
->
focus
 = focus;

701 
¤c
->
ş—r
 = 
Œue
;

702 
	`±h»ad_mu‹x_uÆock
(&
¤c
->
mu‹x
);

703 
	}
}

712 
	$vidmix_sourû_put
(
vidmix_sourû
 *
¤c
, cÚ¡ 
vidäame
 *
äame
)

714 ià(!
¤c
 || !
äame
 || f¿me->
fmt
 !ğ
VID_FMT_YUV420P
)

717 ià(!
¤c
->
äame_rx
 || !
	`vidsz_cmp
(&¤c->äame_rx->
size
, &
äame
->size)) {

719 
vidäame
 *
äm
;

720 
”r
;

722 
”r
 = 
	`vidäame_®loc
(&
äm
, 
VID_FMT_YUV420P
, &
äame
->
size
);

723 ià(
”r
)

726 
	`±h»ad_rwlock_w¾ock
(&
¤c
->
mix
->
rwlock
);

728 
	`mem_d”ef
(
¤c
->
äame_rx
);

729 
¤c
->
äame_rx
 = 
äm
;

731 
	`ş—r_®l
(
¤c
->
mix
);

733 
	`±h»ad_rwlock_uÆock
(&
¤c
->
mix
->
rwlock
);

736 
	`vidäame_cİy
(
¤c
->
äame_rx
, 
äame
);

737 
	}
}

	@
1
.
0
582
16111
baresip/include/baresip.h
baresip/mk/win32/static.c
baresip/modules/account/account.c
baresip/modules/alsa/alsa.c
baresip/modules/alsa/alsa.h
baresip/modules/alsa/alsa_play.c
baresip/modules/alsa/alsa_src.c
baresip/modules/amr/amr.c
baresip/modules/amr/amr.h
baresip/modules/amr/sdp.c
baresip/modules/aubridge/aubridge.c
baresip/modules/aubridge/aubridge.h
baresip/modules/aubridge/device.c
baresip/modules/aubridge/play.c
baresip/modules/aubridge/src.c
baresip/modules/audiounit/audiounit.c
baresip/modules/audiounit/audiounit.h
baresip/modules/audiounit/player.c
baresip/modules/audiounit/recorder.c
baresip/modules/audiounit/sess.c
baresip/modules/aufile/aufile.c
baresip/modules/auloop/auloop.c
baresip/modules/av1/av1.c
baresip/modules/av1/av1.h
baresip/modules/av1/decode.c
baresip/modules/av1/encode.c
baresip/modules/avahi/avahi.c
baresip/modules/avcodec/avcodec.c
baresip/modules/avcodec/avcodec.h
baresip/modules/avcodec/decode.c
baresip/modules/avcodec/encode.c
baresip/modules/avcodec/h263.c
baresip/modules/avcodec/h26x.h
baresip/modules/avformat/avformat.c
baresip/modules/b2bua/b2bua.c
baresip/modules/bv32/bv32.c
baresip/modules/cairo/cairo.c
baresip/modules/codec2/codec2.c
baresip/modules/cons/cons.c
baresip/modules/contact/contact.c
baresip/modules/coreaudio/coreaudio.c
baresip/modules/coreaudio/coreaudio.h
baresip/modules/coreaudio/player.c
baresip/modules/coreaudio/recorder.c
baresip/modules/daala/daala.c
baresip/modules/daala/daala.h
baresip/modules/daala/decode.c
baresip/modules/daala/encode.c
baresip/modules/debug_cmd/debug_cmd.c
baresip/modules/directfb/directfb.c
baresip/modules/dshow/dshow.cpp
baresip/modules/dtls_srtp/dtls.c
baresip/modules/dtls_srtp/dtls_srtp.c
baresip/modules/dtls_srtp/dtls_srtp.h
baresip/modules/dtls_srtp/srtp.c
baresip/modules/dtmfio/dtmfio.c
baresip/modules/echo/echo.c
baresip/modules/evdev/evdev.c
baresip/modules/evdev/print.c
baresip/modules/evdev/print.h
baresip/modules/fakevideo/fakevideo.c
baresip/modules/g711/g711.c
baresip/modules/g722/g722.c
baresip/modules/g7221/decode.c
baresip/modules/g7221/encode.c
baresip/modules/g7221/g7221.c
baresip/modules/g7221/g7221.h
baresip/modules/g7221/sdp.c
baresip/modules/g726/g726.c
baresip/modules/gsm/gsm.c
baresip/modules/gst/dump.c
baresip/modules/gst/gst.c
baresip/modules/gst/gst.h
baresip/modules/gst1/gst.c
baresip/modules/gst_video/encode.c
baresip/modules/gst_video/gst_video.c
baresip/modules/gst_video/gst_video.h
baresip/modules/gst_video/sdp.c
baresip/modules/gst_video1/encode.c
baresip/modules/gst_video1/gst_video.c
baresip/modules/gst_video1/gst_video.h
baresip/modules/gst_video1/sdp.c
baresip/modules/gtk/call_window.c
baresip/modules/gtk/dial_dialog.c
baresip/modules/gtk/gtk_mod.c
baresip/modules/gtk/gtk_mod.h
baresip/modules/gtk/transfer_dialog.c
baresip/modules/gtk/uri_entry.c
baresip/modules/gzrtp/gzrtp.cpp
baresip/modules/gzrtp/messages.cpp
baresip/modules/gzrtp/session.cpp
baresip/modules/gzrtp/session.h
baresip/modules/gzrtp/srtp.cpp
baresip/modules/gzrtp/srtp.h
baresip/modules/gzrtp/stream.cpp
baresip/modules/gzrtp/stream.h
baresip/modules/h265/decode.c
baresip/modules/h265/encode.c
baresip/modules/h265/fmt.c
baresip/modules/h265/h265.c
baresip/modules/h265/h265.h
baresip/modules/httpd/httpd.c
baresip/modules/ice/ice.c
baresip/modules/ilbc/ilbc.c
baresip/modules/isac/isac.c
baresip/modules/jack/jack.c
baresip/modules/jack/jack_play.c
baresip/modules/jack/jack_src.c
baresip/modules/jack/mod_jack.h
baresip/modules/l16/l16.c
baresip/modules/libsrtp/sdes.c
baresip/modules/libsrtp/sdes.h
baresip/modules/libsrtp/srtp.c
baresip/modules/menu/menu.c
baresip/modules/mpa/decode.c
baresip/modules/mpa/encode.c
baresip/modules/mpa/mpa.c
baresip/modules/mpa/mpa.h
baresip/modules/mpa/sdp.c
baresip/modules/mqtt/mqtt.c
baresip/modules/mqtt/mqtt.h
baresip/modules/mqtt/publish.c
baresip/modules/mqtt/subscribe.c
baresip/modules/mwi/mwi.c
baresip/modules/natbd/natbd.c
baresip/modules/natpmp/libnatpmp.c
baresip/modules/natpmp/libnatpmp.h
baresip/modules/natpmp/natpmp.c
baresip/modules/omx/module.c
baresip/modules/omx/omx.c
baresip/modules/omx/omx.h
baresip/modules/opengles/opengles.c
baresip/modules/opengles/opengles.h
baresip/modules/opensles/opensles.c
baresip/modules/opensles/opensles.h
baresip/modules/opensles/player.c
baresip/modules/opensles/recorder.c
baresip/modules/opus/decode.c
baresip/modules/opus/encode.c
baresip/modules/opus/opus.c
baresip/modules/opus/opus.h
baresip/modules/opus/sdp.c
baresip/modules/oss/oss.c
baresip/modules/pcp/listener.c
baresip/modules/pcp/pcp.c
baresip/modules/pcp/pcp.h
baresip/modules/plc/plc.c
baresip/modules/portaudio/portaudio.c
baresip/modules/presence/notifier.c
baresip/modules/presence/presence.c
baresip/modules/presence/presence.h
baresip/modules/presence/publisher.c
baresip/modules/presence/subscriber.c
baresip/modules/pulse/player.c
baresip/modules/pulse/pulse.c
baresip/modules/pulse/pulse.h
baresip/modules/pulse/recorder.c
baresip/modules/rst/audio.c
baresip/modules/rst/rst.c
baresip/modules/rst/rst.h
baresip/modules/rst/video.c
baresip/modules/sdl/sdl.c
baresip/modules/sdl/sdl.h
baresip/modules/sdl/util.c
baresip/modules/sdl2/sdl.c
baresip/modules/selfview/selfview.c
baresip/modules/silk/silk.c
baresip/modules/snapshot/png_vf.c
baresip/modules/snapshot/png_vf.h
baresip/modules/snapshot/snapshot.c
baresip/modules/sndfile/sndfile.c
baresip/modules/sndio/sndio.c
baresip/modules/speex/speex.c
baresip/modules/speex_aec/speex_aec.c
baresip/modules/speex_pp/speex_pp.c
baresip/modules/srtp/sdes.c
baresip/modules/srtp/sdes.h
baresip/modules/srtp/srtp.c
baresip/modules/stdio/stdio.c
baresip/modules/stun/stun.c
baresip/modules/swscale/swscale.c
baresip/modules/syslog/syslog.c
baresip/modules/turn/turn.c
baresip/modules/uuid/uuid.c
baresip/modules/v4l/v4l.c
baresip/modules/v4l2/v4l2.c
baresip/modules/v4l2_codec/v4l2_codec.c
baresip/modules/vidbridge/disp.c
baresip/modules/vidbridge/src.c
baresip/modules/vidbridge/vidbridge.c
baresip/modules/vidbridge/vidbridge.h
baresip/modules/vidinfo/panel.c
baresip/modules/vidinfo/vidinfo.c
baresip/modules/vidinfo/vidinfo.h
baresip/modules/vidloop/vidloop.c
baresip/modules/vp8/decode.c
baresip/modules/vp8/encode.c
baresip/modules/vp8/sdp.c
baresip/modules/vp8/vp8.c
baresip/modules/vp8/vp8.h
baresip/modules/vp9/decode.c
baresip/modules/vp9/encode.c
baresip/modules/vp9/sdp.c
baresip/modules/vp9/vp9.c
baresip/modules/vp9/vp9.h
baresip/modules/vumeter/vumeter.c
baresip/modules/wincons/wincons.c
baresip/modules/winwave/play.c
baresip/modules/winwave/src.c
baresip/modules/winwave/winwave.c
baresip/modules/winwave/winwave.h
baresip/modules/x11/x11.c
baresip/modules/x11grab/x11grab.c
baresip/modules/zrtp/zrtp.c
baresip/src/account.c
baresip/src/aucodec.c
baresip/src/audio.c
baresip/src/aufilt.c
baresip/src/aulevel.c
baresip/src/auplay.c
baresip/src/ausrc.c
baresip/src/baresip.c
baresip/src/bfcp.c
baresip/src/call.c
baresip/src/cmd.c
baresip/src/conf.c
baresip/src/config.c
baresip/src/contact.c
baresip/src/core.h
baresip/src/event.c
baresip/src/h264.c
baresip/src/log.c
baresip/src/magic.h
baresip/src/main.c
baresip/src/mctrl.c
baresip/src/menc.c
baresip/src/message.c
baresip/src/metric.c
baresip/src/mnat.c
baresip/src/module.c
baresip/src/mos.c
baresip/src/net.c
baresip/src/play.c
baresip/src/realtime.c
baresip/src/reg.c
baresip/src/rtpext.c
baresip/src/rtpkeep.c
baresip/src/sdp.c
baresip/src/sipreq.c
baresip/src/stream.c
baresip/src/ua.c
baresip/src/ui.c
baresip/src/vidcodec.c
baresip/src/video.c
baresip/src/vidfilt.c
baresip/src/vidisp.c
baresip/src/vidsrc.c
baresip/src/vidutil.c
baresip/test/account.c
baresip/test/aulevel.c
baresip/test/call.c
baresip/test/cmd.c
baresip/test/contact.c
baresip/test/cplusplus.cpp
baresip/test/main.c
baresip/test/message.c
baresip/test/mock/cert.c
baresip/test/mock/dnssrv.c
baresip/test/mock/mock_aucodec.c
baresip/test/mock/mock_auplay.c
baresip/test/mock/mock_ausrc.c
baresip/test/mock/mock_vidcodec.c
baresip/test/mock/mock_vidisp.c
baresip/test/mock/mock_vidsrc.c
baresip/test/mos.c
baresip/test/net.c
baresip/test/play.c
baresip/test/sip/aor.c
baresip/test/sip/auth.c
baresip/test/sip/domain.c
baresip/test/sip/location.c
baresip/test/sip/sipsrv.c
baresip/test/sip/sipsrv.h
baresip/test/sip/user.c
baresip/test/test.c
baresip/test/test.h
baresip/test/ua.c
baresip/test/video.c
re-0.5.6/include/re.h
re-0.5.6/include/re_aes.h
re-0.5.6/include/re_base64.h
re-0.5.6/include/re_bfcp.h
re-0.5.6/include/re_bitv.h
re-0.5.6/include/re_conf.h
re-0.5.6/include/re_crc32.h
re-0.5.6/include/re_dbg.h
re-0.5.6/include/re_dns.h
re-0.5.6/include/re_fmt.h
re-0.5.6/include/re_hash.h
re-0.5.6/include/re_hmac.h
re-0.5.6/include/re_http.h
re-0.5.6/include/re_httpauth.h
re-0.5.6/include/re_ice.h
re-0.5.6/include/re_jbuf.h
re-0.5.6/include/re_json.h
re-0.5.6/include/re_list.h
re-0.5.6/include/re_lock.h
re-0.5.6/include/re_main.h
re-0.5.6/include/re_mbuf.h
re-0.5.6/include/re_md5.h
re-0.5.6/include/re_mem.h
re-0.5.6/include/re_mod.h
re-0.5.6/include/re_mqueue.h
re-0.5.6/include/re_msg.h
re-0.5.6/include/re_natbd.h
re-0.5.6/include/re_net.h
re-0.5.6/include/re_odict.h
re-0.5.6/include/re_rtp.h
re-0.5.6/include/re_sa.h
re-0.5.6/include/re_sdp.h
re-0.5.6/include/re_sha.h
re-0.5.6/include/re_sip.h
re-0.5.6/include/re_sipevent.h
re-0.5.6/include/re_sipreg.h
re-0.5.6/include/re_sipsess.h
re-0.5.6/include/re_srtp.h
re-0.5.6/include/re_stun.h
re-0.5.6/include/re_sys.h
re-0.5.6/include/re_tcp.h
re-0.5.6/include/re_telev.h
re-0.5.6/include/re_tls.h
re-0.5.6/include/re_tmr.h
re-0.5.6/include/re_turn.h
re-0.5.6/include/re_types.h
re-0.5.6/include/re_udp.h
re-0.5.6/include/re_uri.h
re-0.5.6/include/re_websock.h
re-0.5.6/src/aes/apple/aes.c
re-0.5.6/src/aes/openssl/aes.c
re-0.5.6/src/aes/stub.c
re-0.5.6/src/base64/b64.c
re-0.5.6/src/bfcp/attr.c
re-0.5.6/src/bfcp/bfcp.h
re-0.5.6/src/bfcp/conn.c
re-0.5.6/src/bfcp/msg.c
re-0.5.6/src/bfcp/reply.c
re-0.5.6/src/bfcp/request.c
re-0.5.6/src/conf/conf.c
re-0.5.6/src/crc32/crc32.c
re-0.5.6/src/dbg/dbg.c
re-0.5.6/src/dns/client.c
re-0.5.6/src/dns/cstr.c
re-0.5.6/src/dns/darwin/srv.c
re-0.5.6/src/dns/dname.c
re-0.5.6/src/dns/dns.h
re-0.5.6/src/dns/hdr.c
re-0.5.6/src/dns/ns.c
re-0.5.6/src/dns/res.c
re-0.5.6/src/dns/rr.c
re-0.5.6/src/dns/rrlist.c
re-0.5.6/src/dns/win32/srv.c
re-0.5.6/src/fmt/ch.c
re-0.5.6/src/fmt/hexdump.c
re-0.5.6/src/fmt/pl.c
re-0.5.6/src/fmt/print.c
re-0.5.6/src/fmt/prm.c
re-0.5.6/src/fmt/regex.c
re-0.5.6/src/fmt/str.c
re-0.5.6/src/fmt/str_error.c
re-0.5.6/src/fmt/time.c
re-0.5.6/src/fmt/unicode.c
re-0.5.6/src/hash/func.c
re-0.5.6/src/hash/hash.c
re-0.5.6/src/hmac/apple/hmac.c
re-0.5.6/src/hmac/hmac.c
re-0.5.6/src/hmac/hmac_sha1.c
re-0.5.6/src/hmac/openssl/hmac.c
re-0.5.6/src/http/auth.c
re-0.5.6/src/http/chunk.c
re-0.5.6/src/http/client.c
re-0.5.6/src/http/http.h
re-0.5.6/src/http/msg.c
re-0.5.6/src/http/server.c
re-0.5.6/src/httpauth/basic.c
re-0.5.6/src/httpauth/digest.c
re-0.5.6/src/ice/cand.c
re-0.5.6/src/ice/candpair.c
re-0.5.6/src/ice/chklist.c
re-0.5.6/src/ice/comp.c
re-0.5.6/src/ice/connchk.c
re-0.5.6/src/ice/ice.c
re-0.5.6/src/ice/ice.h
re-0.5.6/src/ice/icem.c
re-0.5.6/src/ice/icesdp.c
re-0.5.6/src/ice/icestr.c
re-0.5.6/src/ice/stunsrv.c
re-0.5.6/src/ice/util.c
re-0.5.6/src/jbuf/jbuf.c
re-0.5.6/src/json/decode.c
re-0.5.6/src/json/decode_odict.c
re-0.5.6/src/json/encode.c
re-0.5.6/src/list/list.c
re-0.5.6/src/lock/lock.c
re-0.5.6/src/lock/rwlock.c
re-0.5.6/src/lock/win32/lock.c
re-0.5.6/src/main/epoll.c
re-0.5.6/src/main/init.c
re-0.5.6/src/main/main.c
re-0.5.6/src/main/main.h
re-0.5.6/src/main/method.c
re-0.5.6/src/main/openssl.c
re-0.5.6/src/mbuf/mbuf.c
re-0.5.6/src/md5/md5.c
re-0.5.6/src/md5/md5.h
re-0.5.6/src/md5/wrap.c
re-0.5.6/src/mem/mem.c
re-0.5.6/src/mod/dl.c
re-0.5.6/src/mod/mod.c
re-0.5.6/src/mod/mod_internal.h
re-0.5.6/src/mod/win32/dll.c
re-0.5.6/src/mqueue/mqueue.c
re-0.5.6/src/mqueue/mqueue.h
re-0.5.6/src/mqueue/win32/pipe.c
re-0.5.6/src/msg/ctype.c
re-0.5.6/src/msg/param.c
re-0.5.6/src/natbd/filtering.c
re-0.5.6/src/natbd/genalg.c
re-0.5.6/src/natbd/hairpinning.c
re-0.5.6/src/natbd/lifetime.c
re-0.5.6/src/natbd/mapping.c
re-0.5.6/src/natbd/natstr.c
re-0.5.6/src/net/bsd/brt.c
re-0.5.6/src/net/if.c
re-0.5.6/src/net/ifaddrs.c
re-0.5.6/src/net/linux/rt.c
re-0.5.6/src/net/net.c
re-0.5.6/src/net/netstr.c
re-0.5.6/src/net/posix/pif.c
re-0.5.6/src/net/rt.c
re-0.5.6/src/net/sock.c
re-0.5.6/src/net/sockopt.c
re-0.5.6/src/net/win32/wif.c
re-0.5.6/src/odict/entry.c
re-0.5.6/src/odict/odict.c
re-0.5.6/src/odict/type.c
re-0.5.6/src/rtp/fb.c
re-0.5.6/src/rtp/member.c
re-0.5.6/src/rtp/ntp.c
re-0.5.6/src/rtp/pkt.c
re-0.5.6/src/rtp/rr.c
re-0.5.6/src/rtp/rtcp.c
re-0.5.6/src/rtp/rtcp.h
re-0.5.6/src/rtp/rtp.c
re-0.5.6/src/rtp/sdes.c
re-0.5.6/src/rtp/sess.c
re-0.5.6/src/rtp/source.c
re-0.5.6/src/sa/ntop.c
re-0.5.6/src/sa/printaddr.c
re-0.5.6/src/sa/pton.c
re-0.5.6/src/sa/sa.c
re-0.5.6/src/sa/sa.h
re-0.5.6/src/sdp/attr.c
re-0.5.6/src/sdp/format.c
re-0.5.6/src/sdp/media.c
re-0.5.6/src/sdp/msg.c
re-0.5.6/src/sdp/sdp.h
re-0.5.6/src/sdp/session.c
re-0.5.6/src/sdp/str.c
re-0.5.6/src/sdp/util.c
re-0.5.6/src/sha/sha1.c
re-0.5.6/src/sip/addr.c
re-0.5.6/src/sip/auth.c
re-0.5.6/src/sip/contact.c
re-0.5.6/src/sip/cseq.c
re-0.5.6/src/sip/ctrans.c
re-0.5.6/src/sip/dialog.c
re-0.5.6/src/sip/keepalive.c
re-0.5.6/src/sip/keepalive_udp.c
re-0.5.6/src/sip/msg.c
re-0.5.6/src/sip/reply.c
re-0.5.6/src/sip/request.c
re-0.5.6/src/sip/sip.c
re-0.5.6/src/sip/sip.h
re-0.5.6/src/sip/strans.c
re-0.5.6/src/sip/transp.c
re-0.5.6/src/sip/via.c
re-0.5.6/src/sipevent/listen.c
re-0.5.6/src/sipevent/msg.c
re-0.5.6/src/sipevent/notify.c
re-0.5.6/src/sipevent/sipevent.h
re-0.5.6/src/sipevent/subscribe.c
re-0.5.6/src/sipreg/reg.c
re-0.5.6/src/sipsess/accept.c
re-0.5.6/src/sipsess/ack.c
re-0.5.6/src/sipsess/close.c
re-0.5.6/src/sipsess/connect.c
re-0.5.6/src/sipsess/info.c
re-0.5.6/src/sipsess/listen.c
re-0.5.6/src/sipsess/modify.c
re-0.5.6/src/sipsess/reply.c
re-0.5.6/src/sipsess/request.c
re-0.5.6/src/sipsess/sess.c
re-0.5.6/src/sipsess/sipsess.h
re-0.5.6/src/srtp/misc.c
re-0.5.6/src/srtp/replay.c
re-0.5.6/src/srtp/srtcp.c
re-0.5.6/src/srtp/srtp.c
re-0.5.6/src/srtp/srtp.h
re-0.5.6/src/srtp/stream.c
re-0.5.6/src/stun/addr.c
re-0.5.6/src/stun/attr.c
re-0.5.6/src/stun/ctrans.c
re-0.5.6/src/stun/dnsdisc.c
re-0.5.6/src/stun/hdr.c
re-0.5.6/src/stun/ind.c
re-0.5.6/src/stun/keepalive.c
re-0.5.6/src/stun/msg.c
re-0.5.6/src/stun/rep.c
re-0.5.6/src/stun/req.c
re-0.5.6/src/stun/stun.c
re-0.5.6/src/stun/stun.h
re-0.5.6/src/stun/stunstr.c
re-0.5.6/src/sys/daemon.c
re-0.5.6/src/sys/endian.c
re-0.5.6/src/sys/fs.c
re-0.5.6/src/sys/rand.c
re-0.5.6/src/sys/sleep.c
re-0.5.6/src/sys/sys.c
re-0.5.6/src/tcp/tcp.c
re-0.5.6/src/tcp/tcp_high.c
re-0.5.6/src/telev/telev.c
re-0.5.6/src/tls/openssl/tls.c
re-0.5.6/src/tls/openssl/tls.h
re-0.5.6/src/tls/openssl/tls_tcp.c
re-0.5.6/src/tls/openssl/tls_udp.c
re-0.5.6/src/tmr/tmr.c
re-0.5.6/src/turn/chan.c
re-0.5.6/src/turn/perm.c
re-0.5.6/src/turn/turnc.c
re-0.5.6/src/turn/turnc.h
re-0.5.6/src/udp/mcast.c
re-0.5.6/src/udp/udp.c
re-0.5.6/src/uri/ucmp.c
re-0.5.6/src/uri/uri.c
re-0.5.6/src/uri/uric.c
re-0.5.6/src/websock/websock.c
rem-0.5.2/include/rem.h
rem-0.5.2/include/rem_au.h
rem-0.5.2/include/rem_aubuf.h
rem-0.5.2/include/rem_auconv.h
rem-0.5.2/include/rem_audio.h
rem-0.5.2/include/rem_aufile.h
rem-0.5.2/include/rem_aumix.h
rem-0.5.2/include/rem_auresamp.h
rem-0.5.2/include/rem_autone.h
rem-0.5.2/include/rem_dsp.h
rem-0.5.2/include/rem_dtmf.h
rem-0.5.2/include/rem_fir.h
rem-0.5.2/include/rem_g711.h
rem-0.5.2/include/rem_goertzel.h
rem-0.5.2/include/rem_vid.h
rem-0.5.2/include/rem_vidconv.h
rem-0.5.2/include/rem_video.h
rem-0.5.2/include/rem_vidmix.h
rem-0.5.2/src/au/fmt.c
rem-0.5.2/src/aubuf/aubuf.c
rem-0.5.2/src/auconv/auconv.c
rem-0.5.2/src/aufile/aufile.c
rem-0.5.2/src/aufile/aufile.h
rem-0.5.2/src/aufile/wave.c
rem-0.5.2/src/aumix/aumix.c
rem-0.5.2/src/auresamp/resamp.c
rem-0.5.2/src/autone/tone.c
rem-0.5.2/src/dtmf/dec.c
rem-0.5.2/src/fir/fir.c
rem-0.5.2/src/g711/g711.c
rem-0.5.2/src/goertzel/goertzel.c
rem-0.5.2/src/vid/draw.c
rem-0.5.2/src/vid/fmt.c
rem-0.5.2/src/vid/frame.c
rem-0.5.2/src/vidconv/vconv.c
rem-0.5.2/src/vidmix/vidmix.c
